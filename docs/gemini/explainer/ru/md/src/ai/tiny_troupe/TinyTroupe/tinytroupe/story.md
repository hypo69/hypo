# Объяснение кода из файла `story.py`

Этот модуль `story.py` из проекта `TinyTroupe` отвечает за генерацию историй на основе симуляции. Он использует внешнюю библиотеку `openai` для взаимодействия с моделью обработки естественного языка.

**Класс `TinyStory`**

Класс `TinyStory` представляет собой объект, который хранит и генерирует историю симуляции.

* **`__init__`:** Конструктор класса.
    * Принимает на вход:
        * `environment` (объект `TinyWorld`) - окружение симуляции.
        * `agent` (объект `TinyPerson`) - агент симуляции.
        * `purpose` (строка) - цель симуляции (и, следовательно, истории).
        * `context` (строка) - текущий контекст истории.
        * `first_n`, `last_n` (целые числа) - количество первых и последних взаимодействий для включения в историю.
        * `include_omission_info` (булево значение) - включить ли информацию об опущенных взаимодействиях.
    * **Важное ограничение:** Должен быть передан либо `environment`, либо `agent`, но не оба сразу.
    * Инициализирует атрибуты: `environment`, `agent`, `purpose`, `current_story`, `first_n`, `last_n`, `include_omission_info`.

* **`start_story`:** Запускает генерацию истории.
    * Принимает на вход:
        * `requirements` (строка) - дополнительные требования к истории.
        * `number_of_words` (целое число) - желаемое количество слов в истории.
        * `include_plot_twist` (булево значение) - включить ли поворот сюжета.
    * Формирует данные для запроса к модели `openai`: цель, требования, текущий трассировочный отчет симуляции, желаемое количество слов и включение поворота сюжета.
    * Отправляет запрос к `openai_utils`.
    * Добавляет сгенерированный текст к `current_story`.
    * Возвращает сгенерированный текст начала истории.

* **`continue_story`:** Продолжает генерировать историю.
    * Аналогично `start_story`, но использует другую шаблонную подсказку для продолжения истории.

* **`_current_story`:** Формирует текущий трассировочный отчет симуляции на основе `environment` или `agent`.
    * Вызывает метод `pretty_current_interactions` у `environment` или `agent`, чтобы получить отформатированную историю.
    * Добавляет полученный отчет к `current_story`.
    * Возвращает `current_story`.

**Взаимодействие с другими частями проекта**

Класс `TinyStory` использует классы `TinyWorld` и `TinyPerson` (из других модулей) для получения информации о симуляции. `openai_utils` обеспечивает взаимодействие с моделью `OpenAI`. Функции из модуля `utils` используются для подготовки данных для `openai` и обработки текста.

**Общая идея**

Модуль предназначен для создания текстовой истории на основе данных симуляции, используя возможности моделей обработки естественного языка. Он учитывает контекст симуляции, цель, количество взаимодействий и прочие требования.

**Важные замечания:**

* Необходимость `openai_utils` для работы.
* Использование `utils.dedent` для удаления отступов.
* Обязательность предоставления либо `environment`, либо `agent`.
* Функции `start_story` и `continue_story` работают с настройками, полученными из mustache-шаблонов.