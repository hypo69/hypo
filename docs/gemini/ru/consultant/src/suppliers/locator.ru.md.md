# Анализ кода модуля `locator.ru.md`

**Качество кода**
9
-  Плюсы
        - Код хорошо структурирован и предоставляет подробное описание локаторов и их параметров.
        - Присутствуют примеры использования локаторов для разных ситуаций.
        - Дано описание стратегий поиска элементов (`by`).
        - Есть пояснения по работе с списками элементов.
        - Описаны действия (`event`) с веб-элементами.
        - Присутствует пример использования переменных в `event`.
        - Приведено описание обязательности локаторов (`mandatory`).
        - Предоставлены примеры сложных локаторов (со списками и словарями).
        - Имеется описание ключей локатора.
        - Есть рекомендации по использованию нескольких файлов локаторов.
-  Минусы
    - Не хватает документации в формате RST для каждой функции, метода и класса (но в данном случае это md файл).
    - Отсутствуют импорты, так как это файл с описанием, а не python код.
    - Используется стандартный стиль комментариев `#` вместо RST.
    - Нет информации о логировании ошибок, так как это файл с описанием, а не python код.
    -  Много повторений в описании ключей локатора.

**Рекомендации по улучшению**

1. **Документация RST**:
   - Переписать весь текст документа в формат reStructuredText для обеспечения совместимости с инструментами документации Python (Sphinx).
   - Включить подробное описание каждого параметра локатора в формате RST.

2. **Логирование**:
   - Добавить информацию о том, как логировать ошибки, возникающие при работе с локаторами (хотя это не python код).
3. **Структура документа**:
    - Разделить документ на логические разделы, используя заголовки и подзаголовки.
    - Добавить больше примеров, особенно для сложных локаторов.
4. **Избегать повторений**:
    -  Убрать дублирующуюся информацию из описания ключей локатора, сделав отсылку к предыдущему разделу.

**Оптимизированный код**
```markdown
# Локаторы полей на `HTML`-странице
==================================

Этот документ описывает структуру и использование локаторов для веб-элементов на страницах поставщиков.
Локаторы используются для автоматизированного поиска элементов на веб-страницах и взаимодействия с ними.

## Пример локатора

Пример локатора в формате JSON:

```json
{
  "close_banner": {
    "attribute": null,
    "by": "XPATH",
    "selector": "//button[@id = 'closeXButton']",
    "if_list": "first",
    "use_mouse": false,
    "mandatory": false,
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": "click()",
    "locator_description": "Закрываю pop-up окно. Если оно не появилось — не страшно (`mandatory`: `false`)."
  },
  "additional_images_urls": {
    "attribute": "src",
    "by": "XPATH",
    "selector": "//ol[contains(@class, 'flex-control-thumbs')]//img",
    "if_list": "all",
    "use_mouse": false,
    "mandatory": false,
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": null,
    "locator_description": "Получает список `url` дополнительных изображений."
  },
  "id_supplier": {
    "attribute": "innerText",
    "by": "XPATH",
    "selector": "//span[@class = 'ltr sku-copy']",
    "if_list": "first",
    "use_mouse": false,
    "mandatory": true,
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": null,
    "locator_description": "SKU Morlevi."
  },
  "default_image_url": {
    "attribute": null,
    "by": "XPATH",
    "selector": "//a[@id = 'mainpic']//img",
    "if_list": "first",
    "use_mouse": false,
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": "screenshot()",
    "mandatory": true,
    "locator_description": "Внимание! В Morlevi картинка получается через screenshot и возвращается как PNG (`bytes`)."
  }
}
```

## Детали
-----------------
Имя словаря соответствует имени поля класса `ProductFields` ([подробнее о `ProductFields`](../product/product_fields)).

### Ключи локатора:

1.  **`attribute`**:
    - Атрибут, который нужно получить от веб-элемента. Например: `innerText`, `src`, `id`, `href` и т.д.
    - Если установить значение `attribute` в `none/false`, то WebDriver вернёт весь веб-элемент (`WebElement`).

2.  **`by`**:
    - Стратегия для поиска элемента:
        -   `ID` соответствует `By.ID`
        -   `NAME` соответствует `By.NAME`
        -   `CLASS_NAME` соответствует `By.CLASS_NAME`
        -   `TAG_NAME` соответствует `By.TAG_NAME`
        -   `LINK_TEXT` соответствует `By.LINK_TEXT`
        -   `PARTIAL_LINK_TEXT` соответствует `By.PARTIAL_LINK_TEXT`
        -   `CSS_SELECTOR` соответствует `By.CSS_SELECTOR`
        -   `XPATH` соответствует `By.XPATH`

3.  **`selector`**:
    - Селектор, определяющий способ нахождения веб-элемента. Примеры:
    -  `(//li[@class = 'slide selected previous'])[1]//img`
    -  `//a[@id = 'mainpic']//img`
    -  `//span[@class = 'ltr sku-copy']`

4.  **`if_list`**:
    - Определяет, что делать со списком найденных веб-элементов (`web_element`). Возможные значения:
        - `first`: выбрать первый элемент из списка.
        - `all`: выбрать все элементы.
        - `last`: выбрать последний элемент.
        - `even`, `odd`: выбрать чётные/нечётные элементы.
        - Указание конкретных номеров, например, `1,2,...` или `[1,3,5]`: выбрать элементы с указанными номерами.

    - Альтернативный способ — указать номер элемента прямо в селекторе, например:
        -   `(//div[contains(@class, 'description')])[2]//p`

5.  **`use_mouse`**: `true` | `false`
    - Используется для выполнения действий с помощью мыши.

6.  **`event`**:
    - WebDriver может выполнить действие с веб-элементом, например, `click()`, `screenshot()`, `scroll()` и т.д.
    - **Важно**: Если указан `event`, он будет выполнен **до** получения значения из `attribute`.
    - Например:

    ```json
    {
        "attribute": "href",
        "timeout": 0,
        "timeout_for_event": "presence_of_element_located",
        "event": "click()",
    }
    ```

    В этом случае сначала драйвер выполнит `click()` на веб-элементе, а затем получит его атрибут `href`.
    Принцип работы: **действие -> атрибут**.
    Еще примеры эвентов:
     - `screenshot()` возвращает вебэлемент как снимок экрана. Удобно, когда `CDN` сервер не возвращает изображение через `URL`.
     - `send_message()` - отправляет сообщение вебэлементу.
       Рекомендуется отправлять сообщение через переменную `%EXTERNAL_MESSAGE%`, как показано ниже:
        - `{"timeout": 0, "timeout_for_event": "presence_of_element_located", "event": "click();backspace(10);%EXTERNAL_MESSAGE%"}`
           исполняет последовательность:
           1.  `click()` - нажимает на вебэлемент (переводит фокус в поле ввода) `<textbox>`.
           2.  `backspace(10)` - сдвигает каретку на 10 символов влево (очищает текст в поле ввода).
           3.  `%EXTERNAL_MESSAGE%` - отправляет сообщение в поле ввода.

7.  **`mandatory`**:
    - Является ли локатор обязательным.
    - Если `{mandatory: true}` и взаимодействие с веб-элементом невозможно, код выбросит ошибку. Если `mandatory: false`, элемент будет пропущен.

8.  **`locator_description`**:
    - Описание локатора.

---

## Сложные локаторы
---------------------
В ключи локатора можно передавать списки, кортежи или словари.

### Пример локатора со списками:

```json
"sample_locator": {
    "attribute": [
      null,
      "href"
    ],
    "by": [
      "XPATH",
      "XPATH"
    ],
    "selector": [
      "//a[contains(@href, '#tab-description')]",
      "//div[@id = 'tab-description']//p"
    ],
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": [
      "click()",
      null
    ],
    "if_list": "first",
    "use_mouse": [
      false,
      false
    ],
    "mandatory": [
      true,
      true
    ],
    "locator_description": [
      "Нажимаю на вкладку для открытия поля description.",
      "Читаю данные из div."
    ]
  }
```

В этом примере сначала будет найден элемент `//a[contains(@href, '#tab-description')]`.
Драйвер выполнит команду `click()`, затем получит значение атрибута `href` элемента `//a[contains(@href, '#tab-description')]`.

### Пример локатора со словарём:

```json
"sample_locator": {
  "attribute": {"href": "name"},
  ...
}
```

---

## Описание ключей локатора
-----------------------------

1. **`attribute`**:
    -  Указывает на атрибут, который будет использован для поиска элемента. Значение `null` означает, что атрибут не используется для поиска.

2. **`by`**:
    -  Указывает на метод поиска элемента на странице. `XPATH` означает использование XPath для нахождения элемента.

3.  **`selector`**:
    -   Строка, представляющая локатор, который будет использоваться для нахождения элемента.
       Например, `"//a[@id = 'mainpic']//img"` - поиск изображения внутри тега `a` с `id='mainpic'`.

4. **`if_list`**:
     -   Указывает правило обработки списка элементов. `first` означает, что будет возвращен первый элемент из найденного списка.

5.  **`use_mouse`**:
    -   Булевое значение, указывающее, нужно ли использовать мышь для взаимодействия с элементом. `false` значит мышь не используется.

6.  **`timeout`**:
    -   Время ожидания (в секундах) для нахождения элемента. `0` означает, что поиск элемента будет выполнен немедленно.

7. **`timeout_for_event`**:
     - Время ожидания для события. `"presence_of_element_located"` означает, что WebDriver будет ожидать появления элемента перед выполнением события.

8.  **`event`**:
    -  Указывает, какое событие должно быть выполнено с найденным элементом. Например, `click()` или `screenshot()`.

9.  **`mandatory`**:
    -  Указывает, является ли локатор обязательным. Если `true`, то при ошибке будет выброшено исключение.

10. **`locator_description`**:
     - Описание того, что делает локатор.

---

## Дополнительная информация
-----------------------------
- Разметка страницы может меняться (десктопная/мобильная версии). Рекомендуется хранить локаторы в разных файлах для каждой версии.
  Например: `product.json`, `product_mobile_site.json`.

- По умолчанию локаторы читаются из файла `product.json`. Пример изменения:
   В файле грабера страницы поставщика делается проверка на `url`.

```python
    async def grab_page(self) -> ProductFields:
        ...
         = driver
        if 'ksp.co.il/mob' in d.current_url: # <- бывет, что подключается к мобильной версии сайта
            self.locator = j_loads_ns(gs.path.src / 'suppliers' / 'ksp' / 'locators' / 'product_mobile_site.json')
        ...
```
```