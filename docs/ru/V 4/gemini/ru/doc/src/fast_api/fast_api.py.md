# Модуль `fast_api.py`

## Обзор

Модуль `fast_api.py` представляет собой FastAPI сервер с XML-RPC интерфейсом для удалённого управления. Он предоставляет API для запуска, остановки и управления серверами FastAPI, а также для добавления новых маршрутов во время работы приложения.

## Подробней

Этот модуль является центральным компонентом для управления FastAPI серверами. Он использует библиотеку `uvicorn` для асинхронного запуска серверов и предоставляет интерфейс для управления ими через командную строку или XML-RPC. Модуль также поддерживает динамическое добавление новых маршрутов, что позволяет расширять функциональность сервера без его перезапуска.

## Классы

### `FastApiServer`

**Описание**: Класс `FastApiServer` реализует Singleton для управления экземпляром FastAPI-приложения. Он предоставляет методы для добавления маршрутов, запуска и остановки серверов, а также для получения информации о состоянии серверов и доступных маршрутах.

**Методы**:
- `__init__`: Инициализирует экземпляр сервера, добавляет стандартные маршруты (`/hello`, `/post`) и настраивает FastAPI приложение.
- `add_route`: Добавляет новый маршрут к FastAPI приложению с указанным путем, функцией и HTTP методами.
- `_start_server`: Асинхронно запускает uvicorn сервер на указанном порту.
- `start`: Запускает FastAPI сервер в отдельном потоке на указанном порту.
- `stop`: Останавливает FastAPI сервер на указанном порту.
- `stop_all`: Останавливает все запущенные FastAPI сервера.
- `get_servers_status`: Возвращает статус всех запущенных серверов (Running или Stopped).
- `get_routes`: Возвращает список всех зарегистрированных маршрутов в приложении.
- `get_app`: Возвращает FastAPI приложение.
- `add_new_route`: Добавляет новый маршрут к работающему приложению, динамически импортируя модуль и функцию.

**Параметры**:
- `host` (str): Хост, на котором запускается сервер. По умолчанию `"127.0.0.1"`.
- `title` (str): Заголовок FastAPI приложения. По умолчанию `"FastAPI RPC Server"`.
- `path` (str): Путь для нового маршрута.
- `func` (Callable): Функция, которая будет обрабатывать запросы к этому маршруту.
- `methods` (List[str]): Список HTTP методов, которые поддерживает маршрут (например, `["GET", "POST"]`).
- `module_name` (str): Имя модуля, из которого нужно импортировать функцию для нового маршрута.
- `func_name` (str): Имя функции, которая будет обрабатывать запросы к новому маршруту.

**Примеры**

```python
from src.fast_api.fast_api import FastApiServer

# Создание экземпляра сервера
server = FastApiServer(host="0.0.0.0")

# Запуск сервера на порту 8000
server.start(port=8000)

# Получение списка маршрутов
routes = server.get_routes()
print(routes)

# Остановка сервера
server.stop(port=8000)
```

### `CommandHandler`

**Описание**: Класс `CommandHandler` предоставляет интерфейс для управления FastAPI сервером через XML-RPC. Он позволяет запускать, останавливать и получать информацию о серверах удаленно.

**Методы**:
- `__init__`: Инициализирует XML-RPC сервер на указанном порту и регистрирует экземпляр `CommandHandler` для обработки RPC-вызовов.
- `start_server`: Запускает FastAPI сервер на указанном порту и хосте.
- `stop_server`: Останавливает FastAPI сервер на указанном порту.
- `stop_all_servers`: Останавливает все запущенные FastAPI сервера.
- `status_servers`: Возвращает статус всех запущенных серверов.
- `get_routes`: Возвращает список всех зарегистрированных маршрутов.
- `add_new_route`: Добавляет новый маршрут к работающему приложению, динамически импортируя модуль и функцию.
- `shutdown`: Останавливает все серверы и завершает работу XML-RPC сервера.

**Параметры**:
- `rpc_port` (int): Порт, на котором запускается XML-RPC сервер. По умолчанию `9000`.
- `port` (int): Порт для управления FastAPI сервером.
- `host` (str): Хост для управления FastAPI сервером.
- `path` (str): Путь для нового маршрута.
- `module_name` (str): Имя модуля, из которого нужно импортировать функцию для нового маршрута.
- `func_name` (str): Имя функции, которая будет обрабатывать запросы к новому маршруту.
- `methods` (List[str]): Список HTTP методов, которые поддерживает маршрут (например, `["GET", "POST"]`).

**Примеры**

```python
from src.fast_api.fast_api import CommandHandler

# Создание экземпляра обработчика команд
command_handler = CommandHandler(rpc_port=9000)

# Запуск сервера на порту 8000 через RPC
command_handler.start_server(port=8000, host="127.0.0.1")

# Получение статуса серверов через RPC
command_handler.status_servers()

# Остановка сервера на порту 8000 через RPC
command_handler.stop_server(port=8000)

# Остановка всех серверов и завершение работы RPC
# command_handler.shutdown()
```

## Функции

### `telegram_webhook`

```python
def telegram_webhook():
    """"""
    return 'Hello, World!'
```

**Описание**:
Функция `telegram_webhook` - это обработчик webhook для Telegram.

**Возвращает**:
- `str`: Строка `'Hello, World!'`.

### `test_function`

```python
def test_function():
    return "It is working!!!"
```

**Описание**:
Функция `test_function` - это тестовая функция, которая возвращает строку "It is working!!!".

**Возвращает**:
- `str`: Строка `"It is working!!!"`.

### `test_post`

```python
def test_post(data: Dict[str, str]):
    return {"result": "post ok", "data": data}
```

**Описание**:
Функция `test_post` - это тестовая функция для обработки POST-запросов.

**Параметры**:
- `data` (Dict[str, str]): Словарь с данными, переданными в POST-запросе.

**Возвращает**:
- `dict`: Словарь с результатом обработки POST-запроса и переданными данными.

### `start_server`

```python
def start_server(port: int, host: str):
    """Запускает FastAPI сервер на указанном порту."""
```

**Описание**: Запускает FastAPI сервер на указанном порту.

**Параметры**:
- `port` (int): Порт, на котором нужно запустить сервер.
- `host` (str): Хост, на котором нужно запустить сервер.

**Примеры**:

```python
from src.fast_api.fast_api import start_server
start_server(port=8000, host='127.0.0.1')
```

### `stop_server`

```python
def stop_server(port: int):
    """Останавливает FastAPI сервер на указанном порту."""
```

**Описание**: Останавливает FastAPI сервер на указанном порту.

**Параметры**:
- `port` (int): Порт, на котором нужно остановить сервер.

**Примеры**:

```python
from src.fast_api.fast_api import stop_server
stop_server(port=8000)
```

### `stop_all_servers`

```python
def stop_all_servers():
    """Останавливает все запущенные FastAPI сервера."""
```

**Описание**: Останавливает все запущенные FastAPI сервера.

**Примеры**:

```python
from src.fast_api.fast_api import stop_all_servers
stop_all_servers()
```

### `status_servers`

```python
def status_servers():
    """Показывает статус серверов."""
```

**Описание**: Показывает статус всех запущенных FastAPI серверов.

**Примеры**:

```python
from src.fast_api.fast_api import status_servers
status_servers()
```

### `get_routes`

```python
def get_routes():
    """Показывает все роуты."""
```

**Описание**: Показывает все зарегистрированные маршруты FastAPI сервера.

**Примеры**:

```python
from src.fast_api.fast_api import get_routes
get_routes()
```

### `add_new_route`

```python
def add_new_route(path: str, module_name: str, func_name: str, methods: List[str] = ["GET"]):
    """Добавляет новый роут к серверу."""
```

**Описание**: Добавляет новый маршрут к FastAPI серверу, динамически импортируя функцию из указанного модуля.

**Параметры**:
- `path` (str): Путь для нового маршрута.
- `module_name` (str): Имя модуля, из которого нужно импортировать функцию.
- `func_name` (str): Имя функции, которая будет обрабатывать запросы к этому маршруту.
- `methods` (List[str], optional): Список HTTP методов, которые поддерживает маршрут. По умолчанию `["GET"]`.

**Примеры**:

```python
from src.fast_api.fast_api import add_new_route
add_new_route(path='/new_route', module_name='my_module', func_name='my_function', methods=['GET', 'POST'])
```

### `parse_port_range`

```python
def parse_port_range(range_str):
    """Разбирает строку с диапазоном портов."""
```

**Описание**: Разбирает строку с диапазоном портов и возвращает список портов. Поддерживает как отдельные порты, так и диапазоны (например, "8000-8005").

**Параметры**:
- `range_str` (str): Строка с диапазоном портов.

**Возвращает**:
- `list[int]`: Список портов.

**Примеры**:

```python
from src.fast_api.fast_api import parse_port_range
ports = parse_port_range('8000-8005')
print(ports)  # Вывод: [8000, 8001, 8002, 8003, 8004, 8005]

port = parse_port_range('8000')
print(port) # Вывод: [8000]
```

### `display_menu`

```python
def display_menu():
    """Выводит меню с доступными командами."""
```

**Описание**: Выводит в консоль меню с доступными командами для управления сервером.

**Примеры**:
```python
from src.fast_api.fast_api import display_menu
display_menu()
```

### `main`

```python
def main():
    """Основная функция управления сервером."""
```

**Описание**: Основная функция, которая запускает обработчик команд и обрабатывает ввод пользователя для управления сервером.

**Примеры**:
```python
from src.fast_api.fast_api import main
# main() #  В реальном коде не стоит вызывать main здесь, так как она предназначена для запуска из командной строки.