# Модуль миграции Alembic: Добавление столбца `payment_id` в таблицу `purchases`

## Обзор

Этот модуль содержит скрипт миграции Alembic, который добавляет столбец `payment_id` в таблицу `purchases`, если он еще не существует, и удаляет его, если он существует, при выполнении операций обновления и отката соответственно.

## Подробней

Этот скрипт миграции используется для автоматического изменения схемы базы данных. Он добавляет столбец `payment_id` в таблицу `purchases` для хранения идентификаторов платежей. Скрипт также создает уникальный индекс для этого столбца, чтобы обеспечить уникальность идентификаторов платежей. Если столбец уже существует, скрипт пропускает добавление. При откате миграции скрипт удаляет столбец `payment_id` и уникальный индекс, если они существуют.

## Функции

### `upgrade`

```python
def upgrade() -> None:
    """
    Обновляет схему базы данных, добавляя столбец 'payment_id' в таблицу 'purchases', если он еще не существует.

    Как работает функция:
    1. Получает соединение с базой данных, используя `op.get_bind()`.
    2. Выполняет запрос `PRAGMA table_info('purchases')` для получения информации о столбцах в таблице `purchases`.
    3. Извлекает имена столбцов из результатов запроса.
    4. Проверяет, существует ли столбец `'payment_id'` в списке столбцов.
    5. Если столбец `'payment_id'` не существует, добавляет столбец с типом `sa.String()` и атрибутом `nullable=False`.
    6. Создает уникальное ограничение `'uq_purchases_payment_id'` для столбца `'payment_id'`.
    7. Если столбец `'payment_id'` уже существует, выводит сообщение в консоль, что добавление пропущено.
    """
```

**Как работает функция**:

Функция `upgrade` выполняет следующие шаги:

1.  Получает соединение с базой данных, используя `op.get_bind()`.
2.  Выполняет запрос `PRAGMA table_info('purchases')` для получения информации о столбцах в таблице `purchases`.
3.  Извлекает имена столбцов из результатов запроса.
4.  Проверяет, существует ли столбец `'payment_id'` в списке столбцов.
5.  Если столбец `'payment_id'` не существует, добавляет столбец с типом `sa.String()` и атрибутом `nullable=False`.
6.  Создает уникальное ограничение `'uq_purchases_payment_id'` для столбца `'payment_id'`.
7.  Если столбец `'payment_id'` уже существует, выводит сообщение в консоль, что добавление пропущено.

### `downgrade`

```python
def downgrade() -> None:
    """
    Откатывает схему базы данных, удаляя столбец 'payment_id' из таблицы 'purchases', если он существует.

    Как работает функция:
    1. Получает соединение с базой данных, используя `op.get_bind()`.
    2. Выполняет запрос `PRAGMA table_info('purchases')` для получения информации о столбцах в таблице `purchases`.
    3. Извлекает имена столбцов из результатов запроса.
    4. Проверяет, существует ли столбец `'payment_id'` в списке столбцов.
    5. Если столбец `'payment_id'` существует, удаляет уникальное ограничение `'uq_purchases_payment_id'`.
    6. Удаляет столбец `'payment_id'` из таблицы `'purchases'`.
    7. Если столбец `'payment_id'` не существует, выводит сообщение в консоль, что удаление пропущено.
    """
```

**Как работает функция**:

Функция `downgrade` выполняет следующие шаги:

1.  Получает соединение с базой данных, используя `op.get_bind()`.
2.  Выполняет запрос `PRAGMA table_info('purchases')` для получения информации о столбцах в таблице `purchases`.
3.  Извлекает имена столбцов из результатов запроса.
4.  Проверяет, существует ли столбец `'payment_id'` в списке столбцов.
5.  Если столбец `'payment_id'` существует, удаляет уникальное ограничение `'uq_purchases_payment_id'`.
6.  Удаляет столбец `'payment_id'` из таблицы `'purchases'`.
7.  Если столбец `'payment_id'` не существует, выводит сообщение в консоль, что удаление пропущено.