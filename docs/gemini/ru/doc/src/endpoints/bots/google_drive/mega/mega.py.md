# Модуль для работы с Mega.nz

## Обзор

Модуль `mega.py` предоставляет класс `Mega` для взаимодействия с сервисом Mega.nz. Он позволяет выполнять такие операции, как вход в систему, получение списка файлов, скачивание и загрузка файлов.

## Подробней

Этот модуль предоставляет интерфейс для взаимодействия с API Mega.nz. Он включает в себя функции для аутентификации пользователя, получения списка файлов и каталогов, скачивания файлов с использованием публичных и приватных ссылок, а также загрузки файлов на сервер. Модуль использует различные криптографические методы для обеспечения безопасности данных, такие как шифрование AES и RSA.

## Классы

### `Mega`

**Описание**:
Класс `Mega` предоставляет методы для взаимодействия с сервисом Mega.nz.

**Как работает класс**:
1. **Инициализация**:
   - При инициализации класса генерируется случайный номер последовательности (`seqno`) и устанавливается идентификатор сессии (`sid`) в `None`.

2. **Методы класса**:
   - `from_credentials`: Создает экземпляр класса `Mega` и выполняет вход в систему с использованием электронной почты и пароля.
   - `from_ephemeral`: Создает экземпляр класса `Mega` и выполняет анонимный вход в систему.
   - `api_req`: Отправляет API-запрос к серверу Mega.nz и возвращает результат.
   - `login_user`: Выполняет вход в систему с использованием электронной почты и пароля.
   - `login_ephemeral`: Выполняет анонимный вход в систему.
   - `_login_common`: Общая логика для завершения процесса входа в систему.
   - `get_files`: Получает список файлов и каталогов из облачного хранилища.
   - `download_from_url`: Инициирует скачивание файла по публичной ссылке.
   - `download_file`: Скачивает файл из Mega.nz.
   - `get_public_url`: Генерирует публичную ссылку на файл.
   - `uploadfile`: Загружает файл на сервер Mega.nz.

**Методы**:

- `__init__`: Инициализирует экземпляр класса `Mega`.
- `from_credentials(cls, email, password)`: Создает экземпляр класса `Mega` и выполняет вход в систему с использованием электронной почты и пароля.
- `from_ephemeral(cls)`: Создает экземпляр класса `Mega` и выполняет анонимный вход в систему.
- `api_req(self, data)`: Отправляет API-запрос к серверу Mega.nz.
- `login_user(self, email, password)`: Выполняет вход в систему с использованием электронной почты и пароля.
- `login_ephemeral(self)`: Выполняет анонимный вход в систему.
- `_login_common(self, res, password)`: Общая логика для завершения процесса входа в систему.
- `get_files(self)`: Получает список файлов и каталогов из облачного хранилища.
- `download_from_url(self, url)`: Инициирует скачивание файла по публичной ссылке.
- `download_file(self, file_id, file_key, public=False, store_path=None)`: Скачивает файл из Mega.nz.
- `get_public_url(self, file_id, file_key)`: Генерирует публичную ссылку на файл.
- `uploadfile(self, filename, dst=None)`: Загружает файл на сервер Mega.nz.

## Функции

### `Mega.__init__`

```python
    def __init__(self):
        """
        Инициализирует экземпляр класса Mega.

        Args:
            Нет.

        Returns:
            Нет.

        Raises:
            Нет.

        Example:
            >>> mega = Mega()
        """
```

**Как работает функция**:

1. **Инициализация номера последовательности**:
   - Генерирует случайное целое число в диапазоне от 0 до 0xFFFFFFFF и присваивает его атрибуту `self.seqno`. Это число используется для идентификации API-запросов.

2. **Инициализация идентификатора сессии**:
   - Устанавливает атрибут `self.sid` в `None`. Этот атрибут будет содержать идентификатор сессии после успешной аутентификации.

### `Mega.from_credentials`

```python
    @classmethod
    def from_credentials(cls, email, password):
        """
        Создает экземпляр класса Mega и выполняет вход в систему с использованием электронной почты и пароля.

        Args:
            email (str): Электронная почта пользователя.
            password (str): Пароль пользователя.

        Returns:
            Mega: Экземпляр класса Mega, аутентифицированный с использованием предоставленных учетных данных.

        Raises:
            Нет.

        Example:
            >>> mega = Mega.from_credentials('test@example.com', 'password')
        """
```

**Как работает функция**:

1. **Создание экземпляра класса**:
   - Создает новый экземпляр класса `Mega` с помощью `cls()`.

2. **Вход в систему**:
   - Вызывает метод `login_user` для аутентификации пользователя с использованием предоставленных электронной почты и пароля.

3. **Возврат экземпляра класса**:
   - Возвращает созданный и аутентифицированный экземпляр класса `Mega`.

### `Mega.from_ephemeral`

```python
    @classmethod
    def from_ephemeral(cls):
        """
        Создает экземпляр класса Mega и выполняет анонимный вход в систему.

        Args:
            Нет.

        Returns:
            Mega: Экземпляр класса Mega, аутентифицированный анонимно.

        Raises:
            Нет.

        Example:
            >>> mega = Mega.from_ephemeral()
        """
```

**Как работает функция**:

1. **Создание экземпляра класса**:
   - Создает новый экземпляр класса `Mega` с помощью `cls()`.

2. **Анонимный вход в систему**:
   - Вызывает метод `login_ephemeral` для выполнения анонимной аутентификации.

3. **Возврат экземпляра класса**:
   - Возвращает созданный и аутентифицированный (анонимно) экземпляр класса `Mega`.

### `Mega.api_req`

```python
    def api_req(self, data):
        """
        Отправляет API-запрос к серверу Mega.nz и возвращает результат.

        Args:
            data (dict): Словарь с данными запроса.

        Returns:
            dict: Ответ от сервера Mega.nz в формате JSON.

        Raises:
            MegaRequestException: Если сервер возвращает код ошибки.

        Example:
            >>> mega = Mega()
            >>> data = {'a': 'f', 'c': 1}
            >>> files_data = mega.api_req(data)
        """
```

**Как работает функция**:

1. **Подготовка параметров запроса**:
   - Инициализирует словарь `params` с идентификатором запроса (`id`), используя текущее значение `self.seqno`.
   - Увеличивает `self.seqno` на 1 для следующего запроса.
   - Если `self.sid` установлен (идентификатор сессии существует), добавляет его в параметры запроса.

2. **Преобразование данных в JSON**:
   - Преобразует словарь `data` в JSON-строку и оборачивает его в список.

3. **Отправка POST-запроса**:
   - Отправляет POST-запрос к API Mega.nz (`https://g.api.mega.co.nz/cs`) с параметрами `params` и данными `data`.

4. **Обработка ответа**:
   - Преобразует JSON-ответ от сервера в Python-словарь.
   - Если ответ является целым числом, вызывает исключение `MegaRequestException` с кодом ошибки.

5. **Возврат результата**:
   - Возвращает первый элемент из списка JSON-данных.

### `Mega.login_user`

```python
    def login_user(self, email, password):
        """
        Выполняет вход в систему с использованием электронной почты и пароля.

        Args:
            email (str): Электронная почта пользователя.
            password (str): Пароль пользователя.

        Returns:
            Нет.

        Raises:
            MegaRequestException: Если сервер возвращает код ошибки.

        Example:
            >>> mega = Mega()
            >>> mega.login_user('test@example.com', 'password')
        """
```

**Как работает функция**:

1. **Подготовка ключа пароля**:
   - Преобразует пароль в список 32-битных целых чисел и подготавливает AES-ключ с помощью функции `prepare_key`.

2. **Вычисление хеша пользователя**:
   - Вычисляет хеш пользователя с использованием электронной почты и подготовленного AES-ключа пароля с помощью функции `stringhash`.

3. **Отправка API-запроса**:
   - Отправляет API-запрос с параметрами `a` (действие = 'us'), `user` (электронная почта) и `uh` (хеш пользователя).

4. **Общая логика входа**:
   - Вызывает метод `_login_common` для завершения процесса входа в систему, передавая результат API-запроса и подготовленный AES-ключ пароля.

### `Mega.login_ephemeral`

```python
    def login_ephemeral(self):
        """
        Выполняет анонимный вход в систему.

        Args:
            Нет.

        Returns:
            Нет.

        Raises:
            MegaRequestException: Если сервер возвращает код ошибки.

        Example:
            >>> mega = Mega()
            >>> mega.login_ephemeral()
        """
```

**Как работает функция**:

1. **Генерация случайных ключей**:
   - Генерирует случайные 32-битные целые числа для мастер-ключа, ключа пароля и challenge сессии.

2. **Отправка API-запроса**:
   - Отправляет API-запрос с параметрами `a` (действие = 'up'), `k` (зашифрованный случайный мастер-ключ) и `ts` (challenge сессии).

3. **Получение идентификатора пользователя**:
   - Получает идентификатор пользователя из ответа API.

4. **Отправка API-запроса для получения данных пользователя**:
   - Отправляет API-запрос с параметрами `a` (действие = 'us') и `user` (идентификатор пользователя).

5. **Общая логика входа**:
   - Вызывает метод `_login_common` для завершения процесса входа в систему, передавая результат API-запроса и случайный ключ пароля.

### `Mega._login_common`

```python
    def _login_common(self, res, password):
        """
        Общая логика для завершения процесса входа в систему.

        Args:
            res (dict): Ответ от сервера Mega.nz.
            password (list): Ключ пароля.

        Returns:
            Нет.

        Raises:
            MegaIncorrectPasswordExcetion: Если введен неверный e-mail или пароль.

        Example:
            # Внутренний метод, прямое использование не рекомендуется
            >>> mega = Mega()
            >>> res = {'k': 'encrypted_master_key', 'tsid': 'session_id'}
            >>> password = [1, 2, 3, 4]
            >>> mega._login_common(res, password)
        """
```

**Как работает функция**:

1. **Обработка ошибок**:
   - Проверяет, является ли ответ кодом ошибки (-2 или -9). Если да, вызывает исключение `MegaIncorrectPasswordExcetion`.

2. **Дешифрование мастер-ключа**:
   - Извлекает зашифрованный мастер-ключ из ответа и дешифрует его с использованием предоставленного ключа пароля.

3. **Обработка идентификатора сессии**:
   - Проверяет наличие идентификатора сессии (`tsid` или `csid`) в ответе.
   - Если `tsid` присутствует, дешифрует его и проверяет соответствие с зашифрованным ключом.
   - Если `csid` присутствует, дешифрует его с использованием RSA-ключей и устанавливает идентификатор сессии.

4. **Сохранение мастер-ключа и идентификатора сессии**:
   - Сохраняет дешифрованный мастер-ключ в атрибуте `self.master_key`.
   - Сохраняет идентификатор сессии в атрибуте `self.sid`.

### `Mega.get_files`

```python
    def get_files(self):
        """
        Получает список файлов и каталогов из облачного хранилища.

        Args:
            Нет.

        Returns:
            dict: Словарь с информацией о файлах и каталогах.

        Raises:
            MegaRequestException: Если сервер возвращает код ошибки.

        Example:
            >>> mega = Mega()
            >>> mega.login_user('test@example.com', 'password')
            >>> files_data = mega.get_files()
        """
```

**Как работает функция**:

1. **Отправка API-запроса**:
   - Отправляет API-запрос с параметрами `a` (действие = 'f') и `c` (возвращать полные атрибуты = 1).

2. **Обработка списка файлов**:
   - Перебирает список файлов и каталогов в ответе API.
   - Для каждого файла или каталога выполняет следующие действия:
     - Если тип файла (t) равен 0 (файл) или 1 (каталог):
       - Извлекает ключ шифрования из атрибута `k`.
       - Дешифрует ключ шифрования с использованием мастер-ключа.
       - Вычисляет ключ для дешифрования атрибутов.
       - Декодирует и дешифрует атрибуты файла или каталога.
       - Сохраняет дешифрованные атрибуты и ключ в файле.
     - Если тип файла равен 2 (Root), 3 (Inbox) или 4 (Trash Bin):
       - Сохраняет идентификатор соответствующего каталога.

3. **Возврат данных**:
   - Возвращает словарь с информацией о файлах и каталогах.

### `Mega.download_from_url`

```python
    def download_from_url(self, url):
        """
        Инициирует скачивание файла по публичной ссылке.

        Args:
            url (str): Публичная ссылка на файл.

        Returns:
            str: Имя скачанного файла.

        Raises:
            MegaRequestException: Если сервер возвращает код ошибки.

        Example:
            >>> mega = Mega()
            >>> file_name = mega.download_from_url('https://mega.nz/#!file_id!file_key')
        """
```

**Как работает функция**:

1. **Разбор URL**:
   - Создает объект `URLObject` из предоставленной ссылки.
   - Извлекает идентификатор файла и ключ файла из фрагмента URL.

2. **Скачивание файла**:
   - Вызывает метод `download_file` для скачивания файла с использованием извлеченных идентификатора и ключа.

3. **Возврат имени файла**:
   - Возвращает имя скачанного файла.

### `Mega.download_file`

```python
    def download_file(self, file_id, file_key, public=False, store_path=None):
        """
        Скачивает файл из Mega.nz.

        Args:
            file_id (str): Идентификатор файла.
            file_key (str | list): Ключ файла.
            public (bool): Указывает, является ли файл публичным. По умолчанию False.
            store_path (str, optional): Путь для сохранения скачанного файла. По умолчанию None.

        Returns:
            str: Имя скачанного файла.

        Raises:
            MegaRequestException: Если сервер возвращает код ошибки.
            ValueError: Если MAC mismatch.

        Example:
            >>> mega = Mega()
            >>> mega.login_user('test@example.com', 'password')
            >>> file_name = mega.download_file('file_id', 'file_key')
        """
```

**Как работает функция**:

1. **Отправка API-запроса**:
   - Отправляет API-запрос для получения информации о файле. Если `public` равен `True`, используется параметр `p` (публичный файл), иначе используется параметр `n` (приватный файл).

2. **Подготовка ключей**:
   - Преобразует ключ файла из base64 в список целых чисел, если файл является публичным.
   - Вычисляет ключ `k`, `iv` и `meta_mac` из ключа файла.

3. **Получение URL файла**:
   - Извлекает URL файла и его размер из ответа API.

4. **Декодирование атрибутов**:
   - Декодирует и дешифрует атрибуты файла для получения имени файла.

5. **Скачивание файла**:
   - Открывает соединение для скачивания файла по URL.
   - Открывает файл для записи скачанных данных.
   - Инициализирует счетчик и дешифратор AES.
   - Скачивает файл по частям (chunks), дешифрует каждую часть и записывает её в файл.
   - Вычисляет MAC (Message Authentication Code) для каждой части и для всего файла.

6. **Проверка целостности**:
   - Сравнивает вычисленный MAC файла с MAC, полученным из метаданных. Если MAC не совпадают, вызывает исключение `ValueError`.

7. **Закрытие файла**:
   - Закрывает файл.

8. **Возврат имени файла**:
   - Возвращает имя скачанного файла.

### `Mega.get_public_url`

```python
    def get_public_url(self, file_id, file_key):
        """
        Генерирует публичную ссылку на файл.

        Args:
            file_id (str): Идентификатор файла.
            file_key (list): Ключ файла.

        Returns:
            str: Публичная ссылка на файл.

        Raises:
            MegaRequestException: Если сервер возвращает код ошибки.

        Example:
            >>> mega = Mega()
            >>> mega.login_user('test@example.com', 'password')
            >>> public_url = mega.get_public_url('file_id', 'file_key')
        """
```

**Как работает функция**:

1. **Получение public handle**:
   - Отправляет API-запрос для получения public handle файла.

2. **Декодирование ключа**:
   - Декодирует ключ файла из списка целых чисел в base64.

3. **Формирование URL**:
   - Формирует публичную ссылку на файл, используя public handle и декодированный ключ.

4. **Возврат URL**:
   - Возвращает публичную ссылку на файл.

### `Mega.uploadfile`

```python
    def uploadfile(self, filename, dst=None):
        """
        Загружает файл на сервер Mega.nz.

        Args:
            filename (str): Путь к файлу для загрузки.
            dst (str, optional): Идентификатор каталога назначения. По умолчанию None (корневой каталог).

        Returns:
            dict: Данные об загруженном файле.

        Raises:
            MegaRequestException: Если сервер возвращает код ошибки.

        Example:
            >>> mega = Mega()
            >>> mega.login_user('test@example.com', 'password')
            >>> data = mega.uploadfile('example.txt')
        """
```

**Как работает функция**:

1. **Определение каталога назначения**:
   - Если `dst` не указан, пытается использовать `root_id`. Если `root_id` не установлен, получает список файлов для его определения.

2. **Получение URL для загрузки**:
   - Отправляет API-запрос для получения URL для загрузки файла.

3. **Подготовка ключей**:
   - Генерирует случайные ключи для шифрования файла.

4. **Шифрование и загрузка файла по частям**:
   - Открывает файл для чтения.
   - Шифрует файл по частям (chunks) с использованием AES в режиме CTR.
   - Вычисляет MAC для каждой части и для всего файла.
   - Отправляет каждую зашифрованную часть файла на URL для загрузки.

5. **Завершение загрузки**:
   - Вычисляет `meta_mac` для файла.
   - Кодирует атрибуты файла (имя файла) и шифрует их с использованием ключей.
   - Шифрует ключ файла с использованием мастер-ключа.
   - Отправляет API-запрос для завершения загрузки файла и добавления его в каталог назначения.

6. **Возврат данных**:
   - Возвращает данные об загруженном файле.