# Модуль BlackForestLabs_Flux1Schnell

## Обзор

Модуль `BlackForestLabs_Flux1Schnell` предоставляет асинхронный генератор изображений, использующий API Black Forest Labs Flux-1-Schnell. Он позволяет генерировать изображения на основе текстового описания, используя различные параметры, такие как ширина, высота, количество шагов логического вывода и начальное зерно.

## Подробней

Модуль интегрируется с сервисом Black Forest Labs Flux-1-Schnell для генерации изображений. Он включает в себя функции для форматирования запросов, обработки ответов и возврата результатов в виде асинхронного генератора. Модуль также обрабатывает ошибки, возникающие в процессе генерации изображений.

## Классы

### `BlackForestLabs_Flux1Schnell`

**Описание**: Класс `BlackForestLabs_Flux1Schnell` реализует функциональность асинхронного генератора изображений, используя API Black Forest Labs Flux-1-Schnell.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность асинхронного провайдера генерации.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями провайдера.

**Атрибуты**:
- `label (str)`: Метка провайдера, отображаемая пользователю ("BlackForestLabs Flux-1-Schnell").
- `url (str)`: URL главной страницы провайдера ("https://black-forest-labs-flux-1-schnell.hf.space").
- `api_endpoint (str)`: URL API для генерации изображений ("https://black-forest-labs-flux-1-schnell.hf.space/call/infer").
- `working (bool)`: Указывает, что провайдер в настоящее время работает (True).
- `default_model (str)`: Модель, используемая по умолчанию ("black-forest-labs-flux-1-schnell").
- `default_image_model (str)`: Модель изображения, используемая по умолчанию, совпадает с `default_model`.
- `model_aliases (dict)`: Псевдонимы моделей изображений для удобства использования.
- `image_models (list)`: Список поддерживаемых моделей изображений.
- `models (list)`: Список поддерживаемых моделей (совпадает с `image_models`).

**Методы**:
- `create_async_generator()`: Создает асинхронный генератор для генерации изображений.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    prompt: str = None,
    width: int = 768,
    height: int = 768,
    num_inference_steps: int = 2,
    seed: int = 0,
    randomize_seed: bool = True,
    **kwargs
) -> AsyncResult:
    """Создает асинхронный генератор для генерации изображений на основе предоставленных параметров.

    Args:
        cls (BlackForestLabs_Flux1Schnell): Ссылка на класс.
        model (str): Модель для генерации изображений.
        messages (Messages): Список сообщений, используемых для формирования запроса.
        proxy (str, optional): Прокси-сервер для использования при подключении к API. По умолчанию `None`.
        prompt (str, optional): Текстовое описание для генерации изображения. По умолчанию `None`.
        width (int, optional): Ширина генерируемого изображения. По умолчанию 768.
        height (int, optional): Высота генерируемого изображения. По умолчанию 768.
        num_inference_steps (int, optional): Количество шагов логического вывода для генерации изображения. По умолчанию 2.
        seed (int, optional): Начальное зерно для генерации изображения. По умолчанию 0.
        randomize_seed (bool, optional): Флаг, указывающий, следует ли рандомизировать начальное зерно. По умолчанию `True`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий объекты `ImageResponse` с сгенерированными изображениями.

    Raises:
        ResponseError: Если произошла ошибка при генерации изображения.

    """
```

**Назначение**: Создает асинхронный генератор для генерации изображений на основе текстового описания с использованием API Black Forest Labs Flux-1-Schnell.

**Параметры**:
- `cls`: Ссылка на класс `BlackForestLabs_Flux1Schnell`.
- `model (str)`: Модель для генерации изображений.
- `messages (Messages)`: Список сообщений, используемых для формирования запроса.
- `proxy (str, optional)`: Прокси-сервер для использования при подключении к API. По умолчанию `None`.
- `prompt (str, optional)`: Текстовое описание для генерации изображения. По умолчанию `None`.
- `width (int, optional)`: Ширина генерируемого изображения. По умолчанию 768.
- `height (int, optional)`: Высота генерируемого изображения. По умолчанию 768.
- `num_inference_steps (int, optional)`: Количество шагов логического вывода для генерации изображения. По умолчанию 2.
- `seed (int, optional)`: Начальное зерно для генерации изображения. По умолчанию 0.
- `randomize_seed (bool, optional)`: Флаг, указывающий, следует ли рандомизировать начальное зерно. По умолчанию `True`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий объекты `ImageResponse` с сгенерированными изображениями.

**Вызывает исключения**:
- `ResponseError`: Если произошла ошибка при генерации изображения.

**Внутренние функции**:

- Нет внутренних функций

**Как работает функция**:

1. **Подготовка параметров**: Функция принимает различные параметры, включая модель, сообщения, прокси, текстовое описание, ширину, высоту, количество шагов логического вывода, начальное зерно и флаг рандомизации зерна.
2. **Преобразование размеров**: Выполняется корректировка ширины и высоты изображения, чтобы они были кратны 8 (минимальный размер 32).
3. **Форматирование запроса**: Текстовое описание формируется на основе предоставленных сообщений и текстового описания.
4. **Формирование полезной нагрузки (payload)**: Создается словарь `payload` с данными, необходимыми для запроса к API, включая текстовое описание, начальное зерно, флаг рандомизации зерна, ширину, высоту и количество шагов логического вывода.
5. **Отправка запроса и обработка ответа**:
    - Создается асинхронная сессия с использованием `ClientSession`.
    - Отправляется POST-запрос к API `cls.api_endpoint` с сформированной полезной нагрузкой и прокси (если указан).
    - Вызывается функция `raise_for_status` для проверки статуса ответа и возбуждения исключения в случае ошибки.
    - Полученные данные ответа преобразуются в JSON.
    - Извлекается идентификатор события (`event_id`) из данных ответа.
6. **Ожидание завершения и получение результата**:
    - В цикле отправляются GET-запросы к API `f"{cls.api_endpoint}/{event_id}"` для получения статуса обработки изображения.
    - Читаются данные из ответа по частям (`event`) до тех пор, пока не будет получен полный ответ (разделитель `b'\n\n'`).
    - Анализируется тип события (`event_type`):
        - Если `event_type == b'error'`, возбуждается исключение `ResponseError` с сообщением об ошибке.
        - Если `event_type == b'complete'`, данные JSON извлекаются из ответа, извлекается URL изображения, и функция возвращает объект `ImageResponse` с URL изображения и текстовым описанием.
7. **Завершение**: Генератор завершает свою работу после получения результата или возникновения ошибки.

```
Подготовка параметров
     │
     ▼
Преобразование размеров
     │
     ▼
Форматирование запроса
     │
     ▼
Формирование payload
     │
     ▼
Отправка POST-запроса
     │
     ▼
   ┌───────────────────┐
   │    Цикл ожидания   │
   │    завершения      │
   │    обработки       │
   └───────────────────┘
     │
     ▼
Анализ типа события
     │
     ├── Ошибка (error) ──> ResponseError
     │
     └── Завершено (complete) ──> ImageResponse
     │
     ▼
Завершение
```

**Примеры**:

```python
# Пример вызова функции create_async_generator
# (Предполагается, что у вас есть необходимые импорты и настроенные параметры)
# from src.providers.typing import Messages
# from hypotez.src.endpoints.gpt4free.g4f.Provider.hf_space.BlackForestLabs_Flux1Schnell import BlackForestLabs_Flux1Schnell
#
# model = "black-forest-labs-flux-1-schnell"
# messages: Messages = [{"role": "user", "content": "A futuristic cityscape"}]
#
# async def generate_image():
#     async for image_response in BlackForestLabs_Flux1Schnell.create_async_generator(model=model, messages=messages):
#         print(f"Image URL: {image_response.images[0]}")
#
# # Запустите асинхронную функцию (например, с помощью asyncio.run(generate_image()))