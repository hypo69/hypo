# –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –º–æ–¥—É–ª—è `utils.py`

**–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞**
8
- –ü–ª—é—Å—ã
    - –ö–æ–¥ –ª–æ–≥–∏—á–µ—Å–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞—á—É –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã.
    - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, —á—Ç–æ —Ö–æ—Ä–æ—à–æ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
    - –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫.
    - –ö–æ–¥ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —á–∏—Ç–∞–µ–º—ã–π.
- –ú–∏–Ω—É—Å—ã
    -  –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ —Ñ—É–Ω–∫—Ü–∏–π –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤.
    -  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `logger` –∏–∑ `loguru`, –∫–æ–≥–¥–∞ –≤ –ø—Ä–æ–µ–∫—Ç–µ –ø—Ä–∏–Ω—è—Ç `src.logger.logger`.
    -  –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π `try-except` –º–æ–∂–µ—Ç –±—ã—Ç—å —É–ø—Ä–æ—â–µ–Ω–∞ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `logger.error`.
    -   –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤ f-—Å—Ç—Ä–æ–∫–∞—Ö (–Ω–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π).
    -   –ù–µ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø—Ä–∏–Ω—è—Ç—ã–º–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é**

1.  –î–æ–±–∞–≤–∏—Ç—å docstring –∫ —Ñ—É–Ω–∫—Ü–∏–∏ `successful_payment_logic` —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è.
2.  –ó–∞–º–µ–Ω–∏—Ç—å –∏–º–ø–æ—Ä—Ç `from loguru import logger` –Ω–∞ `from src.logger.logger import logger`.
3.  –ò–∑–º–µ–Ω–∏—Ç—å —Å–ø–æ—Å–æ–± –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫, –∏—Å–ø–æ–ª—å–∑—É—è `logger.error` –Ω–∞–ø—Ä—è–º—É—é –≤ –±–ª–æ–∫–µ `except`.
4.  –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤ f-—Å—Ç—Ä–æ–∫–∞—Ö, –≥–¥–µ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ, –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–µ–π.
5.  –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å `user_tg_id` –≤ `user_id_tg` –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ø—Ä–∏–Ω—è—Ç–æ–º—É —Å—Ç–∏–ª—é –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–µ.
6.  –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è –ø–æ—è—Å–Ω–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã—Ö —É—á–∞—Å—Ç–∫–æ–≤ –∫–æ–¥–∞.

**–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥**

```python
"""
–ú–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ø–µ—à–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π –≤ Telegram –±–æ—Ç–µ.
========================================================================
"""
from aiogram import Bot
# from loguru import logger # –ó–∞–º–µ–Ω–µ–Ω –Ω–∞ src.logger
from sqlalchemy.ext.asyncio import AsyncSession
from src.bot.config import settings
from src.bot.dao.dao import PurchaseDao, ProductDao
from src.bot.user.kbs import main_user_kb
from src.bot.user.schemas import PaymentData
from src.logger.logger import logger


async def successful_payment_logic(session: AsyncSession, payment_data: dict, currency: str, user_id_tg: int, bot: Bot) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ª–æ–≥–∏–∫—É —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã, –≤–∫–ª—é—á–∞—è –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –ø–æ–∫—É–ø–∫–µ, –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

    Args:
        session (AsyncSession): –°–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SQLAlchemy.
        payment_data (dict): –°–ª–æ–≤–∞—Ä—å —Å –¥–∞–Ω–Ω—ã–º–∏ –æ –ø–ª–∞—Ç–µ–∂–µ.
        currency (str): –í–∞–ª—é—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞.
        user_id_tg (int): ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram.
        bot (Bot): –û–±—ä–µ–∫—Ç –±–æ—Ç–∞ aiogram.

    Returns:
        None
    """
    product_id = int(payment_data.get('product_id'))
    price = payment_data.get('price')
    payment_type = payment_data.get('payment_type')
    payment_id = payment_data.get('payment_id')
    user_id = payment_data.get('user_id')

    # –ö–æ–¥ –¥–æ–±–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –ø–ª–∞—Ç–µ–∂–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    await PurchaseDao.add(session=session, values=PaymentData(**payment_data))

    # –ö–æ–¥ –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥—É–∫—Ç–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    product_data = await ProductDao.find_one_or_none_by_id(session=session,
                                                           data_id=product_id)

    # –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –æ –ø–æ–∫—É–ø–∫–µ
    for admin_id in settings.ADMIN_IDS:
        try:
            await bot.send_message(
                chat_id=admin_id,
                text=(
                    f'üí≤ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å c ID {user_id} –∫—É–ø–∏–ª —Ç–æ–≤–∞—Ä <b>{product_data.name}</b> (ID: {product_id}) '
                    f'–∑–∞ <b>{price} {currency}</b>.'
                )
            )
        except Exception as e:
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
            logger.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º: {e}')

    # –ö–æ–¥ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    file_text = 'üì¶ <b>–¢–æ–≤–∞—Ä –≤–∫–ª—é—á–∞–µ—Ç —Ñ–∞–π–ª:</b>' if product_data.file_id else 'üìÑ <b>–¢–æ–≤–∞—Ä –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç —Ñ–∞–π–ª—ã:</b>'
    product_text = (
        f'üéâ <b>–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!</b>\\n\\n'
        f'üõí <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–º —Ç–æ–≤–∞—Ä–µ:</b>\\n'
        f'‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n'
        f'üîπ <b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> <b>{product_data.name}</b>\\n'
        f'üîπ <b>–û–ø–∏—Å–∞–Ω–∏–µ:</b>\\n<i>{product_data.description}</i>\\n'
        f'üîπ <b>–¶–µ–Ω–∞:</b> <b>{price} {currency}</b>\\n'
        f'üîπ <b>–ó–∞–∫—Ä—ã—Ç–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</b>\\n<i>{product_data.hidden_content}</i>\\n'
        f'‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n'
        f'{file_text}\\n\\n'
        f'‚ÑπÔ∏è <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Å–µ—Ö –≤–∞—à–∏—Ö –ø–æ–∫—É–ø–∫–∞—Ö –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –≤ –ª–∏—á–Ω–æ–º –ø—Ä–æ—Ñ–∏–ª–µ.</b>'
    )

    # –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞
    if product_data.file_id:
        await bot.send_document(document=product_data.file_id,
                                chat_id=user_id_tg,
                                caption=product_text, reply_markup=main_user_kb(user_id_tg))
    else:
        await bot.send_message(chat_id=user_id_tg, text=product_text, reply_markup=main_user_kb(user_id_tg))

    # –ö–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–≤–µ–∑–¥—ã –∑–∞ –ø–æ–∫—É–ø–∫—É, –µ—Å–ª–∏ —Ç–∏–ø –æ–ø–ª–∞—Ç—ã "stars"
    if payment_type == 'stars':
        await bot.refund_star_payment(user_id=user_id_tg, telegram_payment_charge_id=payment_id)
```