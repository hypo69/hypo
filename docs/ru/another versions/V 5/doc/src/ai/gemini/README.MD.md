# Модуль интеграции с Google Generative AI

## Обзор

Класс `GoogleGenerativeAI` предназначен для облегчения взаимодействия с моделями Generative AI от Google. Этот класс предоставляет методы для отправки запросов, обработки ответов, управления диалогами и интеграции с различными функциями AI. Он включает надежную обработку ошибок, ведение журнала и параметры конфигурации для обеспечения бесперебойной работы.

## Подробней

Этот модуль позволяет взаимодействовать с моделями Google Generative AI. Он предоставляет функциональность для отправки запросов, ведения диалогов, описания изображений и загрузки файлов. Модуль обрабатывает различные ошибки и ведет логи для отслеживания операций.

## Классы

### `GoogleGenerativeAI`

**Описание**: Класс для взаимодействия с моделями Google Generative AI.

**Как работает класс**:
Класс инициализируется с использованием API-ключа, имени модели, конфигурации генерации и системной инструкции. Он предоставляет методы для отправки запросов, ведения диалогов, описания изображений и загрузки файлов. Класс также включает обработку ошибок и ведение журнала.

**Методы**:
- `__init__`: Инициализирует класс `GoogleGenerativeAI`.
- `config`: Извлекает конфигурацию из файла настроек.
- `_start_chat`: Начинает чат-сессию с AI-моделью.
- `_save_dialogue`: Сохраняет диалог в текстовый и JSON-файлы.
- `ask`: Отправляет текстовый запрос AI-модели и получает ответ.
- `chat`: Отправляет сообщение в чат AI-модели и получает ответ.
- `describe_image`: Генерирует текстовое описание изображения.
- `upload_file`: Загружает файл в AI-модель.

**Параметры**:
- `api_key` (str): API-ключ для доступа к Google Generative AI.
- `model_name` (Optional[str], optional): Имя используемой модели. По умолчанию `None`.
- `generation_config` (Optional[Dict], optional): Конфигурация генерации. По умолчанию `None`.
- `system_instruction` (Optional[str], optional): Системная инструкция для AI-модели. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы ключевого слова.

## Функции

### `__init__(self, api_key: str, model_name: Optional[str] = None, generation_config: Optional[Dict] = None, system_instruction: Optional[str] = None, **kwargs)`

**Описание**: Инициализирует класс `GoogleGenerativeAI` с необходимой конфигурацией.

**Как работает функция**:
Устанавливает API-ключ, имя модели, конфигурацию генерации и системную инструкцию. Определяет пути для ведения журналов диалогов и хранения истории. Инициализирует модель Google Generative AI.

**Параметры**:
- `api_key` (str): API-ключ для доступа к Google Generative AI.
- `model_name` (Optional[str], optional): Имя используемой модели. По умолчанию `None`.
- `generation_config` (Optional[Dict], optional): Конфигурация генерации. По умолчанию `None`.
- `system_instruction` (Optional[str], optional): Системная инструкция для AI-модели. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы ключевого слова.

### `config(self)`

**Описание**: Извлекает конфигурацию из файла настроек.

**Как работает функция**:
Читает и анализирует файл конфигурации, расположенный в `gs.path.src / 'ai' / 'gemini' / 'gemini.json'`.

### `_start_chat(self)`

**Описание**: Начинает чат-сессию с AI-моделью.

**Как работает функция**:
Инициализирует чат-сессию с пустой историей.

### `_save_dialogue(self, dialogue: list)`

**Описание**: Сохраняет диалог в текстовый и JSON-файлы.

**Как работает функция**:
Добавляет каждое сообщение в диалоге в текстовый файл. Добавляет каждое сообщение в формате JSON в JSON-файл.

**Параметры**:
- `dialogue` (list): Список сообщений в диалоге.

### `ask(self, q: str, attempts: int = 15) -> Optional[str]`

**Описание**: Отправляет текстовый запрос AI-модели и получает ответ.

**Как работает функция**:
Обрабатывает несколько попыток в случае сетевых ошибок или недоступности сервиса. Регистрирует ошибки и повторяет попытки с экспоненциальной задержкой. Сохраняет диалог в файлы истории.

**Параметры**:
- `q` (str): Текстовый запрос.
- `attempts` (int, optional): Количество попыток. По умолчанию 15.

**Возвращает**:
- `Optional[str]`: Сгенерированный ответ или `None` в случае ошибки.

### `chat(self, q: str) -> str`

**Описание**: Отправляет сообщение в чат AI-модели и получает ответ.

**Как работает функция**:
Использует чат-сессию, инициализированную `_start_chat`. Регистрирует ошибки и возвращает текст ответа.

**Параметры**:
- `q` (str): Текстовый запрос.

**Возвращает**:
- `str`: Сгенерированный ответ.

### `describe_image(self, image_path: Path) -> Optional[str]`

**Описание**: Генерирует текстовое описание изображения.

**Как работает функция**:
Кодирует изображение в base64 и отправляет его в AI-модель. Возвращает сгенерированное описание или регистрирует ошибку, если операция не удалась.

**Параметры**:
- `image_path` (Path): Путь к файлу изображения.

**Возвращает**:
- `Optional[str]`: Сгенерированное описание или `None` в случае ошибки.

### `upload_file(self, file: str | Path | IOBase, file_name: Optional[str] = None) -> bool`

**Описание**: Загружает файл в AI-модель.

**Как работает функция**:
Обрабатывает загрузку файла и регистрирует успех или неудачу. Предоставляет логику повторных попыток в случае ошибок.

**Параметры**:
- `file` (str | Path | IOBase): Файл для загрузки.
- `file_name` (Optional[str], optional): Имя файла. По умолчанию `None`.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, иначе `False`.

## Обработка ошибок

Класс включает комплексную обработку ошибок для различных сценариев:

- **Сетевые ошибки**: Повторяет попытки с экспоненциальной задержкой.
- **Недоступность сервиса**: Регистрирует ошибки и повторяет попытки.
- **Ограничения квоты**: Регистрирует и ждет перед повторной попыткой.
- **Ошибки аутентификации**: Регистрирует и прекращает дальнейшие попытки.
- **Неверный ввод**: Регистрирует и повторяет попытки с тайм-аутом.
- **Ошибки API**: Регистрирует и прекращает дальнейшие попытки.

## Ведение журнала и история

Все взаимодействия с AI-моделями регистрируются, а диалоги сохраняются в текстовом и JSON-форматах для будущего анализа. Это гарантирует, что все операции отслеживаются и могут быть просмотрены для отладки или аудита.

## Зависимости

- `google.generativeai`
- `requests`
- `grpc`
- `google.api_core.exceptions`
- `google.auth.exceptions`
- `src.logger`
- `src.utils.printer`
- `src.utils.file`
- `src.utils.date_time`
- `src.utils.convertors.unicode`
- `src.utils.jjson`

## Пример использования

```python
ai = GoogleGenerativeAI(api_key="your_api_key", system_instruction="Instruction")
response = ai.ask("Как дела?")
print(response)
```

Этот пример инициализирует класс `GoogleGenerativeAI` и отправляет запрос AI-модели, выводя ответ.

---

Для получения более подробной информации обратитесь к исходному коду и комментариям в классе `GoogleGenerativeAI`.