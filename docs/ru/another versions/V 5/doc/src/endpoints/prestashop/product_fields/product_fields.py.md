# Модуль product_fields

## Обзор

Модуль `product_fields.py` предназначен для описания полей товара в формате API PrestaShop. Он содержит класс `ProductFields`, который позволяет управлять полями товара, такими как ID, название, описание, цена и другие параметры, необходимые для работы с PrestaShop. Модуль также включает методы для установки и получения значений этих полей, а также для форматирования данных для отправки в API PrestaShop.

## Подробней

Этот модуль играет ключевую роль в процессе интеграции данных о товарах с платформой PrestaShop. Он определяет структуру данных и предоставляет инструменты для преобразования данных в формат, совместимый с API PrestaShop. Класс `ProductFields` инкапсулирует все необходимые поля товара и обеспечивает удобный интерфейс для работы с ними. Модуль также обрабатывает мультиязычные значения, что важно для мультиязычных магазинов.

## Классы

### `ProductFields`

**Описание**: Класс, описывающий поля товара в формате API PrestaShop.

**Как работает класс**:
- Инициализируется с указанием индексов языков, используемых в базе данных PrestaShop (английский, иврит, русский).
- Загружает дефолтные значения полей из файла `product_fields_default_values.json` и списка полей из `fields_list.txt`.
- Предоставляет методы для установки и получения значений полей товара, а также для работы с мультиязычными значениями.
- Имеет методы для добавления связей с категориями, изображениями, комбинациями, опциями продукта, характеристиками продукта, тегами, доступностью на складе, вложениями, аксессуарами и бандлами продуктов.
- Содержит метод `to_dict`, который преобразует объект `ProductFields` в словарь, готовый для отправки в API PrestaShop.

**Методы**:
- `__post_init__`: Вызывается после инициализации экземпляра класса. Запускает метод `_payload` для загрузки дефолтных значений полей.
- `_payload`: Загружает дефолтные значения полей из файлов `fields_list.txt` и `product_fields_default_values.json`.
- `_set_multilang_value`: Устанавливает мультиязычное значение для заданного поля.
- `to_dict`: Преобразует объект `ProductFields` в словарь для PrestaShop API.
- `additional_category_append`: Добавляет связь с категорией, если ее еще нет.
- `additional_categories_clear`: Очищает все связи с категориями.
- `product_image_append`: Добавляет связь с изображением.
- `product_images_clear`: Очищает все связи с изображениями.
- `images_urls_append`: Устанавливает список URL, откуда скачать дополнительные изображения.
- `product_combination_append`: Добавляет связь с комбинацией.
- `product_combinations_clear`: Очищает все связи с комбинациями.
- `product_options_append`: Добавляет связь со значением опции продукта.
- `product_options_clear`: Очищает все связи со значениями опций продукта.
- `product_features_append`: Добавляет связь с характеристикой продукта.
- `product_features_clear`: Очищает все связи с характеристиками продукта.
- `product_tag_append`: Добавляет связь с тегом.
- `product_tags_clear`: Очищает все связи с тегами.
- `product_stock_available_append`: Добавляет связь с доступностью на складе.
- `product_stock_availables_clear`: Очищает все связи с доступностью на складе.
- `product_attachment_append`: Добавляет связь с вложением.
- `product_attachments_clear`: Очищает все связи с вложениями.
- `product_accessory_append`: Добавляет связь с аксессуаром.
- `product_accessories_clear`: Очищает все связи с аксессуарами.
- `product_bundle_append`: Добавляет связь с бандлом продукта.
- `product_bundle_clear`: Очищает все связи с бандлами продуктов.

**Параметры**:
- `presta_fields` (SimpleNamespace): Объект, хранящий поля товара. Инициализируется в методе `__post_init__`.
- `id_lang` (int): ID языка, используемый по умолчанию.

**Примеры**:

```python
from src.endpoints.prestashop.product_fields.product_fields import ProductFields

product_fields = ProductFields(id_lang=1)
product_fields.name = 'Новый товар'
product_fields.price = 100.0
product_data = product_fields.to_dict()
print(product_data)
```

## Функции

### `_payload`

```python
def _payload(self) -> bool:
    """
    Загрузка дефолтных значений полей.
    Returns:
        bool: True, если загрузка прошла успешно, иначе False.
    """
    ...
```

**Описание**: Загружает дефолтные значения полей товара из файлов `fields_list.txt` и `product_fields_default_values.json`.

**Как работает функция**:
1. Определяет базовый путь к файлам конфигурации.
2. Считывает список полей из файла `fields_list.txt`.
3. Если список полей не загружен, логирует ошибку и возвращает `False`.
4. Создает объект `SimpleNamespace` с полями из списка.
5. Загружает словарь с дефолтными значениями из файла `product_fields_default_values.json`.
6. Если словарь не загружен, логирует ошибку и возвращает `False`.
7. Устанавливает значения полей объекта `presta_fields` из словаря.
8. В случае успеха возвращает `True`, в случае ошибки логирует исключение и возвращает `False`.

**Параметры**:
- Нет параметров.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в случае ошибки.

**Вызывает исключения**:
- `Exception`: В случае ошибки при чтении файлов или установке значений полей.

**Примеры**:

```python
from src.endpoints.prestashop.product_fields.product_fields import ProductFields

product_fields = ProductFields()
success = product_fields._payload()
if success:
    print('Default fields loaded successfully')
else:
    print('Failed to load default fields')
```

### `_set_multilang_value`

```python
def _set_multilang_value(self, field_name: str, value: str, id_lang: Optional[int | str] = None) -> bool:
    """
    Устанавливает мультиязычное значение для заданного поля.

    Args:
        field_name (str): Имя поля (например, 'name', 'description').
        value (str): Значение для установки.
        id_lang (Optional[Union[int, str]]): ID языка. Если не указан, используется self.id_lan.

    Описание:
        Функция устанавливает мультиязычное значение для указанного поля объекта.  
        Поле может хранить значения для разных языков.  Значения хранятся в виде списка словарей,
        где каждый словарь представляет собой значение для определенного языка и имеет структуру:

        {'attrs': {'id': 'language_id'}, 'value': 'language_value'}
         {'id': 'language_id'}, 'value': 'language_value'}

        - 'attrs': Словарь, содержащий атрибуты значения.  В данном случае, обязательным атрибутом является 'id',
                   который представляет собой идентификатор языка.
        - 'value': Значение поля для указанного языка.

        Если поле с указанным именем не существует, оно создается. Если поле существует, но не имеет
        ожидаемой структуры (словарь с ключом 'language', содержащим список), поле перезаписывается.
        Если поле существует и имеет правильную структуру, функция пытается обновить значение для
        указанного языка. Если язык уже существует в списке, его значение обновляется. Если язык
        не существует, добавляется новая запись в список.

    Returns:
        bool: True, если значение успешно установлено, False в случае ошибки.
    """
    ...
```

**Описание**: Устанавливает мультиязычное значение для заданного поля товара.

**Как работает функция**:
1. Преобразует `id_lang` в целое число, если оно указано, иначе использует значение `self.id_lang`.
2. Формирует словарь `lang_data` с данными о языке и значении.
3. Пытается получить текущее значение поля `field_name` из объекта `self.presta_fields`.
4. Если поле не существует, создает его как словарь с ключом `language` и значением `lang_data`.
5. Если поле существует, проверяет, является ли оно словарем с ключом `language`, содержащим список.
6. Если поле не соответствует ожидаемой структуре, перезаписывает его как словарь с ключом `language` и значением `lang_data`.
7. Если поле соответствует ожидаемой структуре, пытается обновить значение для указанного языка.
8. Если язык уже существует в списке, обновляет его значение.
9. Если язык не существует, добавляет новую запись в список.
10. В случае успеха возвращает `True`, в случае ошибки логирует исключение и возвращает `False`.

**Параметры**:
- `field_name` (str): Имя поля (например, 'name', 'description').
- `value` (str): Значение для установки.
- `id_lang` (Optional[int | str]): ID языка. Если не указан, используется `self.id_lang`.

**Возвращает**:
- `bool`: `True`, если значение успешно установлено, `False` в случае ошибки.

**Вызывает исключения**:
- `Exception`: В случае ошибки при установке значения в мультиязычное поле.

**Примеры**:

```python
from src.endpoints.prestashop.product_fields.product_fields import ProductFields

product_fields = ProductFields(id_lang=1)
product_fields._set_multilang_value('name', 'Новый товар', id_lang=2)
print(product_fields.presta_fields.name)
```

### `to_dict`

```python
def to_dict(self) -> Dict[str, Any]:
    """
    Преобразует объект ProductFields в словарь для PrestaShop API,
    исключая ключи, значения которых равны None или пустой строке,
    и формирует мультиязычные поля в нужном формате. Все поля должны быть представлены как строки.

    Returns:
        Dict[str, Any]: Словарь с полями, готовый для PrestaShop API.
    """
    ...
```

**Описание**: Преобразует объект `ProductFields` в словарь, готовый для отправки в API PrestaShop.

**Как работает функция**:
1. Создает пустой словарь `product_dict`.
2. Для каждого поля товара проверяет, установлено ли значение.
3. Если значение установлено, преобразует его в строку и добавляет в словарь `product_dict`.
4. Для мультиязычных полей вызывает метод `_format_multilang_value` для форматирования данных.
5. Добавляет информацию об associations, если они есть
6. Возвращает словарь `product_dict`.

**Параметры**:
- Нет параметров.

**Возвращает**:
- `Dict[str, Any]`: Словарь с полями, готовый для PrestaShop API.

**Вызывает исключения**:
- Нет.

**Примеры**:

```python
from src.endpoints.prestashop.product_fields.product_fields import ProductFields

product_fields = ProductFields(id_lang=1)
product_fields.name = 'Новый товар'
product_fields.price = 100.0
product_data = product_fields.to_dict()
print(product_data)
```