# Модуль `tinytroupe.control`

## Обзор

Этот модуль предоставляет механизмы управления симуляцией. Он реализует класс `Simulation` для управления жизненным циклом симуляции, включая начало, завершение, сохранение состояния (через контрольные точки) и добавление агентов, сред и фабрик.  Модуль также реализует декорирование функций (`transactional`) для выполнения операций в контексте транзакции, обрабатывая кэширование и вызовы к сторонним объектам (агентам, средам и фабрикам).

## Классы

### `Simulation`

**Описание**: Класс `Simulation` управляет всей симуляцией.  Он хранит информацию об агентах, средах, фабриках, статусе симуляции (запущена/остановлена) и пути к кэшу.  Поддерживает механизмы кэширования состояния симуляции для оптимизации и возможности повторения.

**Атрибуты**:

- `id`: Уникальный идентификатор симуляции. По умолчанию `default`.
- `agents`: Список агентов в симуляции.
- `name_to_agent`: Словарь, связывающий имя агента с его экземпляром.
- `environments`: Список сред в симуляции.
- `name_to_environment`: Словарь, связывающий имя среды с её экземпляром.
- `factories`: Список фабрик в симуляции.
- `name_to_factory`: Словарь, связывающий имя фабрики с её экземпляром.
- `status`: Текущий статус симуляции (`stopped` или `started`).
- `cache_path`: Путь к файлу кэша.
- `auto_checkpoint`: Автоматически создавать контрольные точки после каждой транзакции.
- `has_unsaved_cache_changes`: Флаг, указывающий, есть ли несохраненные изменения в кэше.
- `_under_transaction`: Флаг, указывающий, находится ли симуляция в транзакции.
- `cached_trace`: Список состояний симуляции, полученных из кэша.
- `execution_trace`: Список текущих состояний симуляции в процессе выполнения.

**Методы**:

- `__init__(self, id="default", cached_trace:list=None)`: Инициализирует объект симуляции. Принимает необязательный id и список кэшированных следов.
- `begin(self, cache_path:str=None, auto_checkpoint:bool=False)`: Инициализирует симуляцию, устанавливая её состояние в `started`.
- `end(self)`: Останавливает симуляцию, сохраняет состояние в кэш.
- `checkpoint(self)`: Сохраняет текущее состояние симуляции в файл кэша.
- `add_agent(self, agent)`: Добавляет агента в симуляцию.
- `add_environment(self, environment)`: Добавляет среду в симуляцию.
- `add_factory(self, factory)`: Добавляет фабрику в симуляцию.
- `_execution_trace_position(self) -> int`: Возвращает текущую позицию в следе выполнения.
- `_function_call_hash(self, function_name, *args, **kwargs) -> int`: Вычисляет хеш для вызова функции.
- `_skip_execution_with_cache(self)`: Пропускает выполнение, если состояние уже кэшировано.
- `_is_transaction_event_cached(self, event_hash) -> bool`: Проверяет, есть ли кэшированный эквивалент для данного хэша события.
- `_drop_cached_trace_suffix(self)`: Обрезает суффикс кэшированного следа.
- `_add_to_execution_trace(self, state: dict, event_hash: int, event_output)`: Добавляет состояние в след выполнения.
- `_add_to_cache_trace(self, state: dict, event_hash: int, event_output)`: Добавляет состояние в кэшированный след.
- `_load_cache_file(self, cache_path:str)`: Загружает состояние из файла кэша.
- `_save_cache_file(self, cache_path:str)`: Сохраняет состояние в файл кэша.
- `begin_transaction(self)`: Начинает транзакцию.
- `end_transaction(self)`: Завершает транзакцию.
- `is_under_transaction(self)`: Проверяет, находится ли симуляция в транзакции.
- `_clear_communications_buffers(self)`: Очищает буферы коммуникаций агентов и сред.
- `_encode_simulation_state(self) -> dict`: Кодирует текущее состояние симуляции в словарь.
- `_decode_simulation_state(self, state: dict)`: Декодирует состояние симуляции из словаря.


### `Transaction`

**Описание**: Класс `Transaction` управляет выполнением функции в контексте транзакции симуляции, обеспечивая кэширование и возможность откатов.

**Атрибуты**:

- `obj_under_transaction`: Объект, над которым выполняется транзакция.
- `simulation`: Экземпляр `Simulation`.
- `function_name`: Имя функции.
- `function`: Функция.
- `args`: Аргументы функции.
- `kwargs`: Ключевые аргументы функции.


**Методы**:

- `execute(self)`: Выполняет функцию в транзакции, используя кэширование.


### `SkipTransaction`

### `CacheOutOfSync`

### `ExecutionCached`

## Функции

### `reset()`

**Описание**: Сбрасывает все текущие симуляции. Устанавливает глобальный словарь `_current_simulations` в начальное состояние.

### `_simulation(id="default")`

**Описание**: Возвращает экземпляр `Simulation` с заданным `id` или создает новый, если его нет.

### `begin(cache_path=None, id="default", auto_checkpoint=False)`

**Описание**: Начинает симуляцию с заданным `id` и опциональным кэшем и опцией авто-сохранения.

### `end(id="default")`

**Описание**: Завершает симуляцию с заданным `id`.

### `checkpoint(id="default")`

**Описание**: Сохраняет текущее состояние симуляции.

### `current_simulation()`

**Описание**: Возвращает текущую симуляцию или `None`, если нет текущей симуляции.

### `transactional(func)`

**Описание**: Декоратор, делающий функцию транзакционной.