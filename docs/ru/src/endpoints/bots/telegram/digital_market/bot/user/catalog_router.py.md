# Модуль маршрутизации каталога товаров Telegram-бота

## Обзор

Модуль `catalog_router.py` предназначен для обработки запросов, связанных с каталогом товаров в Telegram-боте. Он включает в себя обработку выбора категорий, отображение товаров в категориях, а также организацию процесса покупки товаров через различные платежные системы.

## Подробнее

Этот модуль является ключевым компонентом Telegram-бота, обеспечивающим навигацию пользователей по каталогу товаров и предоставление информации о продуктах. Он обрабатывает callback-запросы от inline-клавиатур, отображает список категорий, продукты в выбранной категории и предлагает различные способы оплаты. Модуль интегрирован с платежными системами, такими как ЮKassa, Robocassa и Stars, для обеспечения удобства совершения покупок.

## Классы

В данном модуле классы отсутствуют.

## Функции

### `page_catalog`

```python
async def page_catalog(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обрабатывает callback-запрос для отображения каталога категорий товаров.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных (без коммита).

    Returns:
        None

    Raises:
        Exception: Обрабатывает исключение при попытке удалить предыдущее сообщение (если оно есть).

    Как работает функция:
    1. Отвечает на callback-запрос сообщением "Загрузка каталога...".
    2. Пытается удалить предыдущее сообщение пользователя (например, предыдущий каталог).
    3. Получает список всех категорий товаров из базы данных.
    4. Отправляет пользователю сообщение со списком категорий, используя inline-клавиатуру.

    Схема работы функции:
    A: Получение callback-запроса
    ↓
    B: Удаление предыдущего сообщения (если есть)
    ↓
    C: Получение данных каталога из БД
    ↓
    D: Отправка сообщения с категориями

    Примеры:
        # Пример вызова (не выполняется напрямую, а вызывается при нажатии на кнопку "Каталог")
        await page_catalog(call, session_without_commit)
    """
    ...
```

### `page_catalog_products`

```python
async def page_catalog_products(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обрабатывает callback-запрос для отображения товаров выбранной категории.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных (без коммита).

    Returns:
        None

    Как работает функция:
    1. Извлекает ID категории из callback-данных.
    2. Получает список товаров, относящихся к данной категории, из базы данных.
    3. Если товары найдены, отправляет пользователю сообщение о количестве товаров в категории и информацию о каждом товаре (название, цена, описание) с кнопкой "Купить".
    4. Если товаров в категории нет, отправляет пользователю сообщение об отсутствии товаров.

    Схема работы функции:
    A: Получение callback-запроса с ID категории
    ↓
    B: Получение товаров из БД по ID категории
    ↓
    C: Проверка наличия товаров
    ├── Да → D: Отправка информации о товарах
    └── Нет → E: Отправка сообщения об отсутствии товаров

    Примеры:
        # Пример вызова (не выполняется напрямую, а вызывается при нажатии на кнопку категории)
        await page_catalog_products(call, session_without_commit)
    """
    ...
```

### `process_about`

```python
async def process_about(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обрабатывает callback-запрос для начала процесса покупки товара.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных (без коммита).

    Returns:
        None

    Как работает функция:
    1. Получает информацию о пользователе из базы данных.
    2. Извлекает тип платежной системы, ID товара и цену из callback-данных.
    3. В зависимости от типа платежной системы вызывает соответствующую функцию для отправки счета на оплату (ЮKassa, Stars или Robocassa).
    4. Удаляет предыдущее сообщение пользователя.

    Схема работы функции:
    A: Получение callback-запроса с информацией о покупке
    ↓
    B: Получение информации о пользователе из БД
    ↓
    C: Определение типа платежной системы
    ├── ЮKassa → D1: Отправка счета ЮKassa
    ├── Stars → D2: Отправка счета Stars
    └── Robocassa → D3: Отправка счета Robocassa
    ↓
    E: Удаление предыдущего сообщения

    Примеры:
        # Пример вызова (не выполняется напрямую, а вызывается при нажатии на кнопку "Купить")
        await process_about(call, session_without_commit)
    """
    ...
```

### `send_yukassa_invoice`

```python
async def send_yukassa_invoice(call, user_info, product_id, price):
    """
    Отправляет счет на оплату через ЮKassa.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        user_info: Информация о пользователе.
        product_id: ID товара.
        price: Цена товара.

    Returns:
        None

    Как работает функция:
    1. Формирует счет на оплату с указанием ID пользователя, ID товара, цены и валюты.
    2. Отправляет счет пользователю через Telegram Bot API.
    3. Добавляет inline-клавиатуру с кнопкой для оплаты через ЮKassa.

    Схема работы функции:
    A: Формирование счета
    ↓
    B: Отправка счета пользователю
    ↓
    C: Добавление кнопки оплаты

    Примеры:
        # Пример вызова
        await send_yukassa_invoice(call, user_info, product_id, price)
    """
    ...
```

### `send_robocassa_invoice`

```python
async def send_robocassa_invoice(call, user_info, product_id, price, session: AsyncSession):
    """
    Отправляет счет на оплату через Robocassa.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        user_info: Информация о пользователе.
        product_id: ID товара.
        price: Цена товара.
        session (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных.

    Returns:
        None

    Как работает функция:
    1. Получает следующий доступный ID для покупки из базы данных.
    2. Формирует ссылку на оплату через Robocassa с указанием ID пользователя, ID товара, цены и описания.
    3. Отправляет пользователю сообщение со ссылкой на оплату и кнопкой для оплаты через Robocassa.

    Схема работы функции:
    A: Получение ID для покупки
    ↓
    B: Формирование ссылки на оплату
    ↓
    C: Отправка сообщения со ссылкой и кнопкой оплаты

    Примеры:
        # Пример вызова
        await send_robocassa_invoice(call, user_info, product_id, price, session)
    """
    ...
```

### `send_stars_invoice`

```python
async def send_stars_invoice(call, user_info, product_id, stars_price):
    """
    Отправляет счет на оплату в "звездах".

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        user_info: Информация о пользователе.
        product_id: ID товара.
        stars_price: Цена товара в "звездах".

    Returns:
        None

    Как работает функция:
    1. Формирует счет на оплату с указанием ID пользователя, ID товара, цены в "звездах" и валюты "XTR".
    2. Отправляет счет пользователю через Telegram Bot API.
    3. Добавляет inline-клавиатуру с кнопкой для оплаты "звездами".

    Схема работы функции:
    A: Формирование счета
    ↓
    B: Отправка счета пользователю
    ↓
    C: Добавление кнопки оплаты

    Примеры:
        # Пример вызова
        await send_stars_invoice(call, user_info, product_id, stars_price)
    """
    ...
```

### `pre_checkout_query`

```python
async def pre_checkout_query(pre_checkout_q: PreCheckoutQuery):
    """
    Обрабатывает предварительный запрос перед оплатой.

    Args:
        pre_checkout_q (PreCheckoutQuery): Объект предварительного запроса перед оплатой.

    Returns:
        None

    Как работает функция:
    1. Отвечает на предварительный запрос, подтверждая возможность проведения оплаты.

    Схема работы функции:
    A: Получение предварительного запроса
    ↓
    B: Подтверждение возможности оплаты

    Примеры:
        # Пример вызова
        await pre_checkout_query(pre_checkout_q)
    """
    ...
```

### `successful_payment`

```python
async def successful_payment(message: Message, session_with_commit: AsyncSession):
    """
    Обрабатывает успешное завершение оплаты.

    Args:
        message (Message): Объект сообщения от Telegram.
        session_with_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных (с коммитом).

    Returns:
        None

    Как работает функция:
    1. Извлекает информацию об оплате из сообщения.
    2. Определяет тип платежной системы (Stars или другая).
    3. Формирует словарь с данными об оплате.
    4. Вызывает функцию `successful_payment_logic` для обработки логики успешной оплаты (например, предоставление доступа к товару).

    Схема работы функции:
    A: Получение сообщения об успешной оплате
    ↓
    B: Извлечение информации об оплате
    ↓
    C: Определение типа платежной системы
    ↓
    D: Формирование данных об оплате
    ↓
    E: Вызов функции обработки успешной оплаты

    Примеры:
        # Пример вызова
        await successful_payment(message, session_with_commit)
    """
    ...