## АНАЛИЗ КОДА: `test_jupyter_examples.py`

### 1. <алгоритм>

**Общий процесс:** Этот скрипт предназначен для автоматического тестирования Jupyter Notebook-ов (файлов с расширением `.ipynb`). Он проходит по всем ноутбукам в указанной директории, выполняет их и проверяет, не возникает ли ошибок при исполнении. Если ошибки возникают, тест считается проваленным. По завершении выполнения каждого ноутбука, создается его копия с расширением `.executed.local.ipynb` с результатами выполнения.

**Пошаговый алгоритм:**

1. **Настройка окружения:**
   - Добавляются пути к директориям `../../tinytroupe/`, `../../` и `../` в `sys.path` для правильного импорта пакетов проекта.
   - Определяются константы:
     - `NOTEBOOK_FOLDER`: путь к папке с ноутбуками (`../examples/`).
     - `TIMEOUT`: максимальное время выполнения ноутбука (600 секунд).
     - `KERNEL_NAME`: имя ядра Jupyter (`python3`).
   
2. **Поиск ноутбуков:**
   - Функция `get_notebooks(folder)` находит все файлы с расширением `.ipynb` в указанной папке, исключая файлы, содержащие в имени `.executed.` или `.local.`.
    
   - Пример:
        - Входные данные: `folder = "../examples/"`
        - Выходные данные: список путей к ноутбукам, например `["../examples/example1.ipynb", "../examples/example2.ipynb"]`
  
3. **Тестирование ноутбуков:**
   - Функция `test_notebook_execution(notebook_path)` параметризована списком путей к ноутбукам.
   - Для каждого ноутбука выполняется:
       - Открытие ноутбука и чтение его содержимого.
         - Пример:
            - Входные данные: `notebook_path = "../examples/example1.ipynb"`
            - Функция `nbformat.read` читает содержимое файла в объект `notebook`.
       - Инициализация `ExecutePreprocessor` с заданным тайм-аутом и ядром.
       - Выполнение ноутбука с помощью `ep.preprocess`. 
         - Функция `ep.preprocess` обрабатывает объект `notebook` и запускает его ядро.
         - Пример:
           - Входные данные: `notebook` и `{'metadata': {'path': NOTEBOOK_FOLDER}}`
           - Изменяется состояние объекта `notebook`, сохраняя результаты выполнения ячеек.
       - Если во время выполнения возникают исключения, то тест считается проваленным с помощью `pytest.fail` и выводится сообщение об ошибке.
         - Пример: Если выполнение кода в ячейке вызывает ошибку `ZeroDivisionError`, `pytest.fail` выводит сообщение об ошибке.
       - В `finally` блоке сохраняется копия выполненного ноутбука (с добавлением `.executed.local`) с результатами выполнения.

4. **Завершение:**
   - После выполнения каждого теста выводится сообщение об успешном выполнении, либо сообщение об ошибке. Также, после каждого теста сохраняется выполненная копия.

### 2. <mermaid>

```mermaid
flowchart TD
    Start --> Setup[Setup: Define Notebook Folder, Timeout, Kernel Name]
    Setup --> FindNotebooks[Find Notebooks: `get_notebooks(folder)`]
    FindNotebooks --> LoopStart{For Each Notebook}
    LoopStart -- Yes --> OpenNotebook[Open Notebook: `nbformat.read(notebook_path)`]
    OpenNotebook --> ExecutePrep[Create Execute Preprocessor: `ExecutePreprocessor(timeout, kernel_name)`]
    ExecutePrep --> ExecuteNotebook[Execute Notebook: `ep.preprocess(notebook)`]
    ExecuteNotebook --> ExceptionCheck{Exception?}
    ExceptionCheck -- Yes --> TestFail[Test Fail: `pytest.fail(error)`]
    ExceptionCheck -- No --> SaveExecutedNotebook[Save Executed Notebook: `nbformat.write(notebook)`]
    SaveExecutedNotebook --> LoopEnd[Loop End]
    LoopEnd --> LoopStart
    LoopStart -- No --> End
    TestFail --> SaveExecutedNotebook
    
    subgraph "Helper Function get_notebooks"
        FindNotebooks -->|Folder Path| FindFiles[List Files in Folder]
        FindFiles -->|File Names| FilterFiles{Filter Notebook Files}
        FilterFiles -->|Notebook Paths| ReturnNotebooks[Return List of Notebook Paths]
    end
    
    
    style Setup fill:#f9f,stroke:#333,stroke-width:2px
    style FindNotebooks fill:#ccf,stroke:#333,stroke-width:2px
    style LoopStart fill:#cfc,stroke:#333,stroke-width:2px
    style OpenNotebook fill:#fcc,stroke:#333,stroke-width:2px
    style ExecutePrep fill:#fcc,stroke:#333,stroke-width:2px
    style ExecuteNotebook fill:#fcc,stroke:#333,stroke-width:2px
    style ExceptionCheck fill:#fcc,stroke:#333,stroke-width:2px
    style TestFail fill:#fcc,stroke:#333,stroke-width:2px
    style SaveExecutedNotebook fill:#fcc,stroke:#333,stroke-width:2px
    style LoopEnd fill:#cfc,stroke:#333,stroke-width:2px
    style End fill:#f9f,stroke:#333,stroke-width:2px
    style FindFiles fill:#ddf,stroke:#333,stroke-width:1px
    style FilterFiles fill:#ddf,stroke:#333,stroke-width:1px
    style ReturnNotebooks fill:#ddf,stroke:#333,stroke-width:1px
```
**Объяснение зависимостей:**

- **Начало:**  Блок `Start` представляет начало выполнения скрипта.
- **Настройка:** Блок `Setup` отвечает за инициализацию переменных окружения, таких как путь к папке с ноутбуками, таймаут выполнения и имя ядра Jupyter.
- **Поиск ноутбуков:**  Блок `FindNotebooks`  использует функцию `get_notebooks()` для поиска всех файлов с расширением `.ipynb` в указанной папке. Она получает на вход `Folder Path`, перечисляет файлы в папке `FindFiles`, фильтрует файлы, оставляя только нужные (`FilterFiles`) и возвращает список путей `ReturnNotebooks`.
- **Цикл по ноутбукам:** `LoopStart` представляет начало цикла, который итерируется по каждому найденному файлу ноутбука.
- **Открытие ноутбука:** `OpenNotebook` открывает файл ноутбука и загружает его в объект `notebook` с помощью функции `nbformat.read`.
- **Подготовка к выполнению:** `ExecutePrep` создает экземпляр препроцессора `ExecutePreprocessor`, который отвечает за выполнение кода в ячейках ноутбука.
- **Выполнение ноутбука:** `ExecuteNotebook` выполняет все ячейки кода в ноутбуке с помощью метода `preprocess`.
- **Проверка на ошибки:** `ExceptionCheck` проверяет, возникла ли ошибка во время выполнения кода.
- **Ошибка:** Если возникла ошибка, `TestFail` помечает тест как проваленный и выводит сообщение об ошибке с помощью `pytest.fail()`.
- **Сохранение выполненного ноутбука:** `SaveExecutedNotebook` сохраняет копию выполненного ноутбука с добавлением `.executed.local` к имени файла.
- **Конец цикла:**  `LoopEnd` завершает текущую итерацию цикла. Если ещё остались ноутбуки, то он возвращается на начало цикла `LoopStart`, если нет, то выполнение переходит в `End`.
- **Конец:** Блок `End` представляет завершение работы скрипта.

### 3. <объяснение>

**Импорты:**

-   `import os`: Этот модуль предоставляет функции для взаимодействия с операционной системой, включая работу с файлами и директориями (например, `os.path.join`, `os.listdir`).
-   `import nbformat`: Этот модуль из библиотеки `nbformat` используется для работы с форматом Jupyter Notebook. Он предоставляет функции для чтения и записи файлов ноутбуков (`nbformat.read`, `nbformat.write`).
-   `from nbconvert.preprocessors import ExecutePreprocessor`: Импортирует класс `ExecutePreprocessor` из библиотеки `nbconvert`, который отвечает за выполнение ячеек кода в Jupyter Notebook.
-   `import pytest`: Библиотека `pytest` используется для создания и запуска тестов. `pytest.mark.parametrize` позволяет запускать тест несколько раз с разными параметрами, а `pytest.fail` используется для обозначения теста как проваленного.
- `import sys`: Этот модуль предоставляет доступ к некоторым переменным и функциям, которые взаимодействуют с интерпретатором Python. Используется для модификации `sys.path` для правильного импорта пакетов из проекта.

**Переменные:**

-   `NOTEBOOK_FOLDER` (str): Путь к папке с ноутбуками, которые нужно протестировать.
-   `TIMEOUT` (int): Максимальное время в секундах, которое отводится на выполнение каждого ноутбука.
-   `KERNEL_NAME` (str): Имя ядра Jupyter, используемое для выполнения ноутбуков (в данном случае `python3`).

**Функции:**

-   `get_notebooks(folder)`:
    -   **Аргумент:**
        -   `folder` (str): Путь к папке, в которой нужно искать ноутбуки.
    -   **Возвращает:**
        -   `list` из `str`: Список полных путей ко всем файлам ноутбуков в указанной папке, исключая файлы с `.executed.` или `.local.` в имени.
    -   **Назначение:** Находит все файлы с расширением `.ipynb` в указанной папке, которые необходимо протестировать.
-   `test_notebook_execution(notebook_path)`:
    -   **Аргумент:**
        -   `notebook_path` (str): Полный путь к файлу ноутбука, который нужно протестировать.
    -   **Возвращает:** None. Функция использует `pytest.fail` для указания на ошибку.
    -   **Назначение:** Открывает ноутбук, выполняет его с помощью `ExecutePreprocessor`, проверяет на наличие ошибок и сохраняет копию выполненного ноутбука. Если при выполнении ноутбука возникли ошибки, тест считается проваленным.
        - `with open(notebook_path, "r", encoding="utf-8") as nb_file:`: Открывает файл ноутбука для чтения с указанием кодировки `utf-8`.
        - `notebook = nbformat.read(nb_file, as_version=4)`: Читает содержимое файла и преобразует его в объект `notebook`.
        - `ep = ExecutePreprocessor(timeout=TIMEOUT, kernel_name=KERNEL_NAME)`: Создает экземпляр `ExecutePreprocessor` с указанными параметрами.
        - `ep.preprocess(notebook, {'metadata': {'path': NOTEBOOK_FOLDER}})`: Выполняет ноутбук. `{'metadata': {'path': NOTEBOOK_FOLDER}}` передается для установки пути, от которого будут искаться файлы при выполнении кода в ноутбуке.
        - `pytest.fail(f"Notebook {notebook_path} raised an exception: {e}")`: Вызывает ошибку в `pytest` если возникла ошибка при выполнении ноутбука.
        - `output_path = notebook_path.replace(".ipynb", ".executed.local.ipynb")`: Формирует имя для сохраненного файла, добавляя `.executed.local` перед расширением `.ipynb`.
        - `with open(output_path, "w", encoding="utf-8") as out_file:`: Открывает файл для записи и сохраняет в него результаты выполнения ноутбука.
        - `nbformat.write(notebook, out_file)`: Записывает измененный объект `notebook` в файл.

**Взаимосвязь с другими частями проекта:**

-   Этот скрипт является частью тестового набора проекта и предназначен для проверки работоспособности Jupyter Notebook-ов, которые могут использоваться в качестве примеров или документации.
-   `sys.path.insert(0, ...)`: Обеспечивает правильный импорт модулей проекта, расположенных в каталогах на уровень выше, чем текущий скрипт.
-   `NOTEBOOK_FOLDER` указывает на каталог с примерами, что подразумевает, что этот скрипт напрямую связан с материалами, демонстрирующими использование проекта.

**Потенциальные ошибки и области для улучшения:**

-   **Обработка ошибок:** При возникновении ошибки при выполнении ноутбука выводится только сообщение, но не проводится никаких дополнительных действий, например, сбор статистики о том, какие ячейки вызвали ошибки. Можно добавить сбор такой информации для облегчения отладки.
-   **Таймаут:** Тесты могут быть пропущены если `TIMEOUT` слишком маленький.
-   **Имена файлов:** Запись файлов с `.executed.local.ipynb` может привести к большому количеству файлов, если регулярно проводить тесты. Можно рассмотреть опции для очистки или перемещения этих файлов.
-   **Зависимости от операционной системы:** Пути к файлам (`../examples/`) могут быть не переносимыми, особенно если запускать тесты в разных операционных системах. Нужно использовать `os.path.join` и аналогичные функции для кроссплатформенности.
-   **Логирование:**  Для улучшения отладки можно добавить более подробное логирование, например, какие ноутбуки выполняются, сколько времени занимает выполнение, и т.д.
-   **Параметризация**: Можно параметризовать не только путь к ноутбуку, но и другие настройки, например, ядро.
-   **Проверка содержимого ноутбука**: Можно добавить дополнительную проверку не только на ошибку, но и на корректность вывода ячеек.
-   **Окружение выполнения**: При выполнении ноутбуков могут быть разные зависимости. Нужно либо добавить требования к установленным зависимостям, либо запускать в отдельном окружении.

**Цепочка взаимосвязей:**

1.  **Разработчик** создаёт или изменяет Jupyter Notebook-и в `../examples/`.
2.  **Разработчик** запускает `test_jupyter_examples.py` для автоматической проверки корректности работы этих ноутбуков.
3.  **Скрипт** использует `get_notebooks` для получения списка ноутбуков.
4.  **Скрипт** последовательно выполняет каждый ноутбук с помощью `ExecutePreprocessor`.
5.  **Скрипт** в случае возникновения ошибок отмечает тесты как проваленные с помощью `pytest.fail`.
6.  **Скрипт** сохраняет выполненные ноутбуки в виде `*.executed.local.ipynb`.
7.  **Разработчик** анализирует результаты тестов и исправляет ошибки.