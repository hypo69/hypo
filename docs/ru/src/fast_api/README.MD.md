# FastAPI Server Manager

## Обзор

Этот проект предоставляет инструменты для управления серверами FastAPI, включая:

- Интерактивный CLI инструмент на Python для управления серверами.
- Интерактивный скрипт PowerShell для управления серверами.

## Оглавление

- [Возможности](#возможности)
- [Требования](#требования)
- [Установка](#установка)
- [Использование](#использование)
  - [Python CLI](#python-cli)
    - [Команды](#команды)
    - [Пример использования Python CLI](#пример-использования-python-cli)
  - [PowerShell Script](#powershell-script)
    - [Меню](#меню)
    - [Команды меню](#команды-меню)
    - [Пример использования PowerShell Script](#пример-использования-powershell-script)
    - [Защита скрипта PowerShell от одновременного запуска](#защита-скрипта-powershell-от-одновременного-запуска)
- [Архитектура](#архитектура)
- [Зависимости](#зависимости)
- [Лицензия](#лицензия)

## Возможности

- **Singleton Pattern:** Гарантирует, что только один экземпляр сервера FastAPI управляется через CLI.
- **Интерактивное управление:** Запускает сервер один раз, затем управляет его состоянием (запуск, остановка, просмотр статуса) с помощью команд.
- **Настраиваемые параметры:** Возможность указать порт и хост для запуска серверов.
- **Асинхронное управление:** Использует `asyncio` для асинхронного запуска и остановки сервера (в Python CLI).
- **Отслеживание состояния:** Возможность просматривать состояние сервера и все его работающие порты.
- **Предотвращение конфликтов:** Использует мьютекс (в скрипте PowerShell), чтобы гарантировать, что только один экземпляр скрипта может быть запущен одновременно.
- **Интерактивное меню:** Предоставляет удобный интерфейс командной строки через PowerShell.
- **Проверка портов:** Проверяет доступность портов перед запуском серверов (в скрипте PowerShell).
- **Обработка ошибок:** Регистрирует ошибки во время выполнения скрипта.

## Требования

- Python 3.7+
- Windows (для скрипта PowerShell)
- PowerShell 5.1 или выше (для скрипта PowerShell)
- Установленные зависимости (для Python CLI):
  - `typer`
  - `uvicorn`
  - `fastapi`
  - `pydantic`
  - `loguru` (или аналогичный модуль логирования)

## Установка

1. Клонируйте репозиторий (если применимо) или скопируйте файлы.
2. **Для Python CLI (main.py):**
   * Рекомендуется создать виртуальное окружение.
   * Установите необходимые зависимости, например, через: `pip install -r requirements.txt`, или вручную (если `requirements.txt` отсутствует) `pip install typer uvicorn fastapi pydantic loguru`.
3. **Для скрипта PowerShell (server_manager.ps1):**
   * Убедитесь, что `python.exe` установлен и доступен через переменную окружения `PATH`.

## Использование

### Python CLI

1. Убедитесь, что файл `main.py` (Python CLI) находится в вашем рабочем каталоге.
2. Запустите CLI, используя Python:

   ```bash
   python main.py <command> [options]
   ```

#### Команды

- **`start`:** Инициализирует и запускает сервер FastAPI.
  - `--port`: (Опционально) Порт для запуска сервера (по умолчанию: 8000).
  - `--host`: (Опционально) Адрес хоста для сервера (по умолчанию: 0.0.0.0).

  Пример:

  ```bash
  python main.py start --port 8080
  python main.py start --port 8081 --host 127.0.0.1
  ```

  *Примечание:* Если сервер уже инициализирован, будет отображено сообщение, и сервер не может быть повторно инициализирован.
- **`stop`:** Останавливает сервер FastAPI на указанном порту.
  - `--port`: (Обязательно) Порт сервера для остановки.

  Пример:

  ```bash
  python main.py stop --port 8080
  ```

  *Примечание:* Вы не можете остановить сервер, если он не был запущен.
- **`stop-all`:** Останавливает все работающие серверы FastAPI.

  Пример:

  ```bash
  python main.py stop-all
  ```

  *Примечание:* Вы не можете остановить сервер, если он не был запущен.
- **`status`:** Отображает состояние сервера и все его работающие порты.

  Пример:

  ```bash
  python main.py status
  ```

  *Примечание:* Это отобразит информацию, только если сервер был запущен.
- **`--help`:** Отображает справочную информацию для команд.

  Пример:

  ```bash
  python main.py --help
  python main.py start --help
  ```

#### Пример использования Python CLI

1. **Запуск сервера:** Запустите сервер на порту 8000:

   ```bash
   python main.py start --port 8000
   ```

2. **Просмотр статуса:** Просмотрите состояние сервера и его работающие порты:

   ```bash
   python main.py status
   ```

3. **Попытка перезапуска:** Попытка запуска сервера на другом порту (например, 8081):

   ```bash
   python main.py start --port 8081
   ```

   В консоли будет отображено сообщение о том, что сервер уже запущен.

4. **Остановка сервера на порту 8000:** Остановите сервер на порту 8000:

   ```bash
   python main.py stop --port 8000
   ```

5. **Просмотр статуса после остановки:** Просмотрите состояние сервера:

   ```bash
   python main.py status
   ```

   Будет отображено сообщение о том, что сервер не работает на порту 8000.
6. **Остановка всех серверов:**

   ```bash
   python main.py stop-all
   ```

7. **Просмотр статуса после остановки всех серверов:**

   ```bash
   python main.py status
   ```

   В консоли будет отображено сообщение о том, что сервер не был инициализирован.

### PowerShell Script

1. Убедитесь, что файлы `server_manager.ps1` (PowerShell Script) и `main.py` (Python CLI) находятся в одном каталоге или укажите правильный путь к `main.py` в переменной `$pythonScriptPath`.
2. Запустите PowerShell от имени администратора.
3. Перейдите в каталог, где находится файл `server_manager.ps1`.
4. Выполните скрипт:

   ```powershell
   .\\server_manager.ps1
   ```

#### Меню

После запуска скрипта вы увидите меню:

```
FastAPI Server Manager
----------------------
1. Start Server
2. Stop Server
3. Stop All Servers
4. Get Server Status
5. Exit
```

Выберите опцию, введя соответствующий номер (1-5) и нажмите Enter.

#### Команды меню

- **`1. Start Server`:**
  - Запрашивает порт (по умолчанию: 8000).
  - Запрашивает хост (по умолчанию: 0.0.0.0).
    - Вы можете пропустить ввод хоста или порта, в этом случае будут использованы значения по умолчанию.
  - Проверяет, доступен ли порт.
  - Вызывает Python CLI `main.py` для запуска сервера FastAPI.

- **`2. Stop Server`:**
  - Запрашивает порт сервера для остановки.
  - Вызывает Python CLI `main.py` для остановки сервера FastAPI на указанном порту.

- **`3. Stop All Servers`:**
  - Вызывает Python CLI `main.py` для остановки всех работающих серверов FastAPI.

- **`4. Get Server Status`:**
  - Вызывает Python CLI `main.py` для отображения состояния всех работающих серверов FastAPI.

- **`5. Exit`:**
  - Выходит из скрипта.

#### Пример использования PowerShell Script

1. **Запуск сервера:**
   - Выберите `1`.
   - Введите порт, например, `8080` (или оставьте поле пустым, чтобы использовать порт по умолчанию `8000`).
   - Введите хост, например, `127.0.0.1` (или оставьте поле пустым, чтобы использовать хост по умолчанию `0.0.0.0`).
2. **Остановка сервера:**
   - Выберите `2`.
   - Введите порт, например, `8080`.
3. **Остановка всех серверов**
   - Выберите `3`.
4. **Просмотр статуса:**
   - Выберите `4`.
5. **Выход**
   - Выберите `5`.

#### Защита скрипта PowerShell от одновременного запуска

Скрипт использует мьютекс, чтобы гарантировать, что только один экземпляр скрипта может быть запущен в любой момент времени. Если вы попытаетесь запустить второй экземпляр, он завершится с ошибкой.

## Архитектура

- `FastApiServer`: Singleton класс, представляющий приложение FastAPI и управляющий запуском сервера (в `main.py`).
- `main.py`: Содержит команды CLI и логику для интерактивного управления сервером на Python.
- `server_manager.ps1`: Скрипт PowerShell, предоставляющий интерактивный интерфейс для управления сервером FastAPI через Python CLI.
- `typer`: Библиотека, используемая для создания интерфейса командной строки (в `main.py`).
- `uvicorn`: ASGI веб-сервер для запуска приложения FastAPI (в `main.py`).
- `Test-NetConnection`: PowerShell cmdlet для проверки портов (в `server_manager.ps1`).
- `System.Threading.Mutex`: .NET class для реализации мьютекса (в `server_manager.ps1`).
- `python.exe`: Вызывает Python для выполнения команд CLI в `main.py` (в `server_manager.ps1`).

## Зависимости

- `python.exe`: Должен быть установлен в системе и доступен через переменную окружения `PATH` (для PowerShell).
- `fastapi`: Web framework для создания API (в Python).
- `typer`: Библиотека для создания интерфейсов командной строки (в Python).
- `uvicorn`: ASGI web server (в Python).
- `pydantic`: Библиотека для валидации данных (в Python).
- `loguru`: Библиотека для логирования (в Python).

## Лицензия

[LICENCE]