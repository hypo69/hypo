# Модуль crypto

## Обзор

Модуль `crypto` предоставляет функции для шифрования и дешифрования данных, используемых в Mega.co.nz, с применением алгоритма AES (Advanced Encryption Standard) в режиме CBC (Cipher Block Chaining). Он также включает функции для подготовки ключей и хеширования строк, обеспечивая безопасность и целостность данных.

## Подробнее

Этот модуль содержит набор криптографических функций, необходимых для обеспечения безопасности данных, передаваемых между клиентом и сервером Mega.co.nz. Он включает функции для шифрования и дешифрования с использованием AES в режиме CBC, а также функции подготовки ключей и хеширования строк. Все эти функции важны для защиты конфиденциальной информации и предотвращения несанкционированного доступа.

## Функции

### `aes_cbc_encrypt`

```python
def aes_cbc_encrypt(data, key):
    """
    Шифрует данные с использованием алгоритма AES в режиме CBC.

    Args:
        data (bytes): Данные для шифрования.
        key (bytes): Ключ шифрования.

    Returns:
        bytes: Зашифрованные данные.

    Raises:
        Отсутствуют.
    """
    ...
```

**Назначение**: Шифрование данных с использованием алгоритма AES в режиме CBC.

**Параметры**:
- `data` (bytes): Данные для шифрования.
- `key` (bytes): Ключ шифрования.

**Возвращает**:
- `bytes`: Зашифрованные данные.

**Как работает функция**:
1. Создает объект шифрования AES в режиме CBC с нулевым вектором инициализации (IV).
2. Шифрует входные данные с использованием предоставленного ключа.

```
A: Создание объекта шифрования AES
|
B: Шифрование данных
|
C: Возврат зашифрованных данных
```

**Примеры**:
```python
key = b'\\0' * 16
data = b'example data'
encrypted_data = aes_cbc_encrypt(data, key)
print(encrypted_data)
```

### `aes_cbc_decrypt`

```python
def aes_cbc_decrypt(data, key):
    """
    Дешифрует данные, зашифрованные с использованием алгоритма AES в режиме CBC.

    Args:
        data (bytes): Зашифрованные данные.
        key (bytes): Ключ шифрования.

    Returns:
        bytes: Дешифрованные данные.

    Raises:
        Отсутствуют.
    """
    ...
```

**Назначение**: Дешифрование данных, зашифрованных с использованием алгоритма AES в режиме CBC.

**Параметры**:
- `data` (bytes): Зашифрованные данные.
- `key` (bytes): Ключ шифрования.

**Возвращает**:
- `bytes`: Дешифрованные данные.

**Как работает функция**:
1. Создает объект дешифрования AES в режиме CBC с нулевым вектором инициализации (IV).
2. Дешифрует входные данные с использованием предоставленного ключа.

```
A: Создание объекта дешифрования AES
|
B: Дешифрование данных
|
C: Возврат дешифрованных данных
```

**Примеры**:
```python
key = b'\\0' * 16
encrypted_data = b'\\x08\\xb1...'  # Зашифрованные данные
decrypted_data = aes_cbc_decrypt(encrypted_data, key)
print(decrypted_data)
```

### `aes_cbc_encrypt_a32`

```python
def aes_cbc_encrypt_a32(data, key):
    """
    Шифрует данные в формате a32 с использованием алгоритма AES в режиме CBC.

    Args:
        data (list[int]): Данные для шифрования в формате a32.
        key (list[int]): Ключ шифрования в формате a32.

    Returns:
        list[int]: Зашифрованные данные в формате a32.

    Raises:
        Отсутствуют.
    """
    ...
```

**Назначение**: Шифрование данных в формате a32 с использованием алгоритма AES в режиме CBC.

**Параметры**:
- `data` (list[int]): Данные для шифрования в формате a32.
- `key` (list[int]): Ключ шифрования в формате a32.

**Возвращает**:
- `list[int]`: Зашифрованные данные в формате a32.

**Как работает функция**:
1. Преобразует входные данные и ключ из формата a32 в строку.
2. Шифрует полученную строку с использованием функции `aes_cbc_encrypt`.
3. Преобразует зашифрованную строку обратно в формат a32.

```
A: Преобразование данных и ключа в строку
|
B: Шифрование данных
|
C: Преобразование зашифрованных данных в формат a32
|
D: Возврат зашифрованных данных в формате a32
```

**Примеры**:
```python
data = [1, 2, 3, 4]
key = [5, 6, 7, 8]
encrypted_data = aes_cbc_encrypt_a32(data, key)
print(encrypted_data)
```

### `aes_cbc_decrypt_a32`

```python
def aes_cbc_decrypt_a32(data, key):
    """
    Дешифрует данные в формате a32, зашифрованные с использованием алгоритма AES в режиме CBC.

    Args:
        data (list[int]): Зашифрованные данные в формате a32.
        key (list[int]): Ключ шифрования в формате a32.

    Returns:
        list[int]: Дешифрованные данные в формате a32.

    Raises:
        Отсутствуют.
    """
    ...
```

**Назначение**: Дешифрование данных в формате a32, зашифрованных с использованием алгоритма AES в режиме CBC.

**Параметры**:
- `data` (list[int]): Зашифрованные данные в формате a32.
- `key` (list[int]): Ключ шифрования в формате a32.

**Возвращает**:
- `list[int]`: Дешифрованные данные в формате a32.

**Как работает функция**:
1. Преобразует входные данные и ключ из формата a32 в строку.
2. Дешифрует полученную строку с использованием функции `aes_cbc_decrypt`.
3. Преобразует дешифрованную строку обратно в формат a32.

```
A: Преобразование данных и ключа в строку
|
B: Дешифрование данных
|
C: Преобразование дешифрованных данных в формат a32
|
D: Возврат дешифрованных данных в формате a32
```

**Примеры**:
```python
data = [1, 2, 3, 4]
key = [5, 6, 7, 8]
decrypted_data = aes_cbc_decrypt_a32(data, key)
print(decrypted_data)
```

### `stringhash`

```python
def stringhash(s, aeskey):
    """
    Вычисляет хеш строки с использованием AES-ключа.

    Args:
        s (str): Строка для хеширования.
        aeskey (list[int]): AES-ключ в формате a32.

    Returns:
        str: Хеш строки в формате base64.

    Raises:
        Отсутствуют.
    """
    ...
```

**Назначение**: Вычисление хеша строки с использованием AES-ключа.

**Параметры**:
- `s` (str): Строка для хеширования.
- `aeskey` (list[int]): AES-ключ в формате a32.

**Как работает функция**:
1. Преобразует входную строку в формат a32.
2. Инициализирует хеш-значение.
3. Выполняет XOR операции над каждой частью входной строки с хеш-значением.
4. Выполняет несколько раундов AES шифрования хеш-значения.
5. Преобразует полученное хеш-значение в формат base64.

```
A: Преобразование строки в формат a32
|
B: Инициализация хеш-значения
|
C: XOR операции и AES шифрование
|
D: Преобразование хеш-значения в формат base64
|
E: Возврат хеша строки
```

**Примеры**:
```python
s = 'example string'
aeskey = [1, 2, 3, 4, 5, 6, 7, 8]
hash_value = stringhash(s, aeskey)
print(hash_value)
```

### `prepare_key`

```python
def prepare_key(a):
    """
    Подготавливает ключ шифрования.

    Args:
        a (list[int]): Входной ключ в формате a32.

    Returns:
        list[int]: Подготовленный ключ в формате a32.

    Raises:
        Отсутствуют.
    """
    ...
```

**Назначение**: Подготовка ключа шифрования.

**Параметры**:
- `a` (list[int]): Входной ключ в формате a32.

**Как работает функция**:
1. Инициализирует промежуточный ключ.
2. Выполняет несколько раундов AES шифрования промежуточного ключа с использованием частей входного ключа.
3. Возвращает подготовленный ключ.

```
A: Инициализация промежуточного ключа
|
B: AES шифрование промежуточного ключа
|
C: Возврат подготовленного ключа
```

**Примеры**:
```python
a = [1, 2, 3, 4, 5, 6, 7, 8]
prepared_key = prepare_key(a)
print(prepared_key)
```

### `encrypt_key`

```python
def encrypt_key(a, key):
    """
    Шифрует ключ с использованием AES в режиме CBC.

    Args:
        a (list[int]): Ключ для шифрования в формате a32.
        key (list[int]): Ключ шифрования в формате a32.

    Returns:
        list[int]: Зашифрованный ключ в формате a32.

    Raises:
        Отсутствуют.
    """
    ...
```

**Назначение**: Шифрование ключа с использованием AES в режиме CBC.

**Параметры**:
- `a` (list[int]): Ключ для шифрования в формате a32.
- `key` (list[int]): Ключ шифрования в формате a32.

**Как работает функция**:
1. Шифрует части входного ключа с использованием AES в режиме CBC.
2. Объединяет зашифрованные части.
3. Возвращает зашифрованный ключ.

```
A: Шифрование частей ключа
|
B: Объединение зашифрованных частей
|
C: Возврат зашифрованного ключа
```

**Примеры**:
```python
a = [1, 2, 3, 4, 5, 6, 7, 8]
key = [9, 10, 11, 12]
encrypted_key = encrypt_key(a, key)
print(encrypted_key)
```

### `decrypt_key`

```python
def decrypt_key(a, key):
    """
    Дешифрует ключ с использованием AES в режиме CBC.

    Args:
        a (list[int]): Зашифрованный ключ в формате a32.
        key (list[int]): Ключ шифрования в формате a32.

    Returns:
        list[int]: Дешифрованный ключ в формате a32.

    Raises:
        Отсутствуют.
    """
    ...
```

**Назначение**: Дешифрование ключа с использованием AES в режиме CBC.

**Параметры**:
- `a` (list[int]): Зашифрованный ключ в формате a32.
- `key` (list[int]): Ключ шифрования в формате a32.

**Как работает функция**:
1. Дешифрует части входного ключа с использованием AES в режиме CBC.
2. Объединяет дешифрованные части.
3. Возвращает дешифрованный ключ.

```
A: Дешифрование частей ключа
|
B: Объединение дешифрованных частей
|
C: Возврат дешифрованного ключа
```

**Примеры**:
```python
a = [1, 2, 3, 4, 5, 6, 7, 8]
key = [9, 10, 11, 12]
decrypted_key = decrypt_key(a, key)
print(decrypted_key)
```

### `enc_attr`

```python
def enc_attr(attr, key):
    """
    Шифрует атрибуты с использованием AES в режиме CBC.

    Args:
        attr (dict): Атрибуты для шифрования.
        key (list[int]): Ключ шифрования в формате a32.

    Returns:
        bytes: Зашифрованные атрибуты.

    Raises:
        Отсутствуют.
    """
    ...
```

**Назначение**: Шифрование атрибутов с использованием AES в режиме CBC.

**Параметры**:
- `attr` (dict): Атрибуты для шифрования.
- `key` (list[int]): Ключ шифрования в формате a32.

**Как работает функция**:
1. Преобразует атрибуты в JSON-строку и добавляет префикс 'MEGA'.
2. Дополняет строку нулевыми символами до кратной длины 16 байт.
3. Шифрует полученную строку с использованием AES в режиме CBC.
4. Возвращает зашифрованные атрибуты.

```
A: Преобразование атрибутов в JSON-строку и добавление префикса
|
B: Дополнение строки нулевыми символами
|
C: Шифрование строки
|
D: Возврат зашифрованных атрибутов
```

**Примеры**:
```python
attr = {'name': 'example', 'size': 1024}
key = [1, 2, 3, 4, 5, 6, 7, 8]
encrypted_attr = enc_attr(attr, key)
print(encrypted_attr)
```

### `dec_attr`

```python
def dec_attr(attr, key):
    """
    Дешифрует атрибуты, зашифрованные с использованием AES в режиме CBC.

    Args:
        attr (bytes): Зашифрованные атрибуты.
        key (list[int]): Ключ шифрования в формате a32.

    Returns:
        dict: Дешифрованные атрибуты.

    Raises:
        Отсутствуют.
    """
    ...
```

**Назначение**: Дешифрование атрибутов, зашифрованных с использованием AES в режиме CBC.

**Параметры**:
- `attr` (bytes): Зашифрованные атрибуты.
- `key` (list[int]): Ключ шифрования в формате a32.

**Как работает функция**:
1. Дешифрует входные данные с использованием AES в режиме CBC.
2. Удаляет нулевые символы и префикс 'MEGA'.
3. Преобразует JSON-строку в словарь.
4. Возвращает дешифрованные атрибуты.

```
A: Дешифрование данных
|
B: Удаление нулевых символов и префикса
|
C: Преобразование JSON-строки в словарь
|
D: Возврат дешифрованных атрибутов
```

**Примеры**:
```python
attr = b'\\x08\\xb1...'  # Зашифрованные атрибуты
key = [1, 2, 3, 4, 5, 6, 7, 8]
decrypted_attr = dec_attr(attr, key)
print(decrypted_attr)