# Модуль ThrottlingMiddleware

## Обзор

Модуль `ThrottlingMiddleware` предназначен для реализации механизма ограничения скорости обработки сообщений в Telegram-боте. Он использует `TTLCache` для хранения информации о том, как часто пользователи отправляют сообщения, и предотвращает слишком частую обработку сообщений от одного и того же пользователя.

## Подробней

Этот модуль предоставляет middleware, который можно подключить к aiogram-боту для защиты от спама и злоупотреблений. Middleware проверяет, не превысил ли пользователь установленный лимит по количеству сообщений за определенный период времени. Если пользователь отправляет сообщения слишком часто, middleware игнорирует эти сообщения.

## Классы

### `ThrottlingMiddleware`

**Описание**: Middleware для ограничения скорости обработки сообщений.

**Как работает класс**:
Класс `ThrottlingMiddleware` инициализируется с параметром `time_limit`, который определяет время (в секундах), в течение которого разрешено отправлять только одно сообщение от одного и того же пользователя. В методе `__call__` проверяется, находится ли `chat.id` пользователя в кэше `TTLCache`. Если `chat.id` есть в кэше, это означает, что пользователь недавно отправлял сообщение, и текущее сообщение не обрабатывается. Если `chat.id` отсутствует в кэше, он добавляется в кэш, и сообщение передается дальше для обработки.

**Методы**:

- `__init__(self, time_limit: int = 2) -> None`: Инициализирует middleware с заданным временным лимитом.
- `__call__(self, handler: Callable[[Message, Dict[str, Any]], Awaitable[Any]], event: Message, data: Dict[str, Any]) -> Any`: Вызывается для каждого входящего сообщения. Проверяет и ограничивает скорость обработки сообщений.

## Функции

### `__init__`

```python
def __init__(self, time_limit: int = 2) -> None:
    """
    Инициализирует middleware ThrottlingMiddleware.

    Args:
        time_limit (int, optional): Временной лимит в секундах для ограничения частоты запросов. По умолчанию 2 секунды.

    Returns:
        None
    """
```

**Как работает функция**:

Функция `__init__` является конструктором класса `ThrottlingMiddleware`. Она принимает один аргумент `time_limit`, который определяет временной интервал (в секундах), в течение которого разрешается отправлять только одно сообщение от одного и того же пользователя. Функция инициализирует атрибут `limit` как экземпляр `TTLCache` с максимальным размером 10000 элементов и временем жизни (TTL), равным `time_limit`.

**Параметры**:

- `time_limit` (int, optional): Временной лимит в секундах для ограничения частоты запросов. По умолчанию равен 2 секундам.

**Возвращает**:

- `None`

### `__call__`

```python
async def __call__(
        self,
        handler: Callable[[Message, Dict[str, Any]], Awaitable[Any]],
        event: Message,
        data: Dict[str, Any]
) -> Any:
    """
    Вызывается для каждого входящего сообщения, проверяет и ограничивает скорость обработки сообщений.

    Args:
        handler (Callable[[Message, Dict[str, Any]], Awaitable[Any]]): Обработчик сообщений.
        event (Message): Объект сообщения.
        data (Dict[str, Any]): Дополнительные данные.

    Returns:
        Any: Результат обработки сообщения.
    """
```

**Как работает функция**:

Функция `__call__` вызывается для каждого входящего сообщения. Она проверяет, находится ли `chat.id` пользователя в кэше `self.limit`. Если `chat.id` уже есть в кэше, это означает, что пользователь недавно отправлял сообщение, и функция возвращает управление, не вызывая обработчик `handler`. Если `chat.id` отсутствует в кэше, он добавляется в кэш, и вызывается обработчик `handler` для обработки сообщения.

Внутри функции происходят следующие действия и преобразования:
1. Проверка наличия `event.chat.id` в `self.limit`.
2. Если `event.chat.id` присутствует, функция завершается.
3. Если `event.chat.id` отсутствует, он добавляется в `self.limit`.
4. Вызывается `handler` с аргументами `event` и `data`.

**Параметры**:

- `handler` (Callable[[Message, Dict[str, Any]], Awaitable[Any]]): Обработчик сообщений, который будет вызван, если сообщение не было отфильтровано.
- `event` (Message): Объект сообщения, содержащий информацию о сообщении и чате.
- `data` (Dict[str, Any]): Словарь с дополнительными данными, которые могут быть переданы обработчику.

**Возвращает**:

- `Any`: Результат вызова обработчика `handler(event, data)`, если сообщение не было отфильтровано, иначе - `None`.