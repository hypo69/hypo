# Документация модуля `utils.py`

## Обзор

Модуль `utils.py` содержит утилиты для обработки успешных платежей в Telegram-боте цифрового магазина. Основная функция модуля - `successful_payment_logic`, которая выполняет логику после успешной оплаты, включая добавление информации о покупке в базу данных, отправку уведомлений администраторам и пользователю, а также возврат звезд за покупку, если оплата была произведена звездами. Модуль использует библиотеки `aiogram`, `loguru`, `sqlalchemy` и собственные модули `bot.config`, `bot.dao`, `bot.user.kbs` и `bot.user.schemas`.

## Подробней

Модуль обрабатывает сценарий, когда пользователь успешно совершил покупку в Telegram-боте. Он записывает информацию о покупке, уведомляет администраторов о новой покупке и отправляет пользователю детали приобретенного товара. Если товар включает файл, модуль отправляет файл пользователю. В случае оплаты звездами, модуль также выполняет возврат звезд пользователю.

## Функции

### `successful_payment_logic`

```python
async def successful_payment_logic(session: AsyncSession, payment_data, currency, user_tg_id, bot: Bot):
    """
    Обрабатывает логику успешной оплаты.
    
    Args:
        session (AsyncSession): Сессия базы данных SQLAlchemy.
        payment_data (dict): Данные платежа.
        currency (str): Валюта платежа.
        user_tg_id (int): Telegram ID пользователя.
        bot (Bot): Экземпляр бота aiogram.
    
    Returns:
        None
    
    Raises:
        Exception: Если возникает ошибка при отправке уведомления администраторам.

    Example:
        # Пример вызова функции
        await successful_payment_logic(session, payment_data, currency, user_tg_id, bot)
    """
```

**Описание**: Обрабатывает логику после успешной оплаты, включая добавление информации о покупке в базу данных, отправку уведомлений администраторам и пользователю, а также возврат звезд за покупку, если оплата была произведена звездами.

**Параметры**:
- `session` (AsyncSession): Сессия базы данных SQLAlchemy для выполнения операций с базой данных.
- `payment_data` (dict): Данные платежа, содержащие информацию о продукте, цене, типе оплаты и идентификаторах пользователя и платежа.
- `currency` (str): Валюта, в которой был произведен платеж.
- `user_tg_id` (int): Telegram ID пользователя, совершившего покупку.
- `bot` (Bot): Экземпляр бота aiogram для отправки сообщений пользователям и администраторам.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `Exception`: Возникает, если происходит ошибка при отправке уведомления администраторам.

**Примеры**:
- Пример вызова функции с параметрами:
```python
await successful_payment_logic(session=session, payment_data=payment_data, currency=currency, user_tg_id=user_tg_id, bot=bot)
```