```markdown
# agentkeepalive

[![NPM version][npm-image]][npm-url]
[![Known Vulnerabilities][snyk-image]][snyk-url]
[![Node.js CI][nodejs-ci-image]][nodejs-ci-url]
[![npm download][download-image]][download-url]

[npm-image]: https://img.shields.io/npm/v/agentkeepalive.svg?style=flat
[npm-url]: https://npmjs.org/package/agentkeepalive
[snyk-image]: https://snyk.io/test/npm/agentkeepalive/badge.svg?style=flat-square
[snyk-url]: https://snyk.io/test/npm/agentkeepalive
[download-image]: https://img.shields.io/npm/dm/agentkeepalive.svg?style=flat-square
[download-url]: https://npmjs.org/package/agentkeepalive
[nodejs-ci-image]: https://github.com/node-modules/agentkeepalive/actions/workflows/nodejs.yml/badge.svg
[nodejs-ci-url]: https://github.com/node-modules/agentkeepalive/actions/workflows/nodejs.yml


Improves the `http.Agent` by adding keep-alive features.  Supports `http` and `https`.

## Key Improvements

- **Default `keepAlive=true`:**  Sockets are maintained in a pool for re-use.
- **Nagle's algorithm disabled:** `socket.setNoDelay(true)` for faster responses.
- **Free socket timeout:** Prevents socket leaks in the free socket pool.  Defaults to 4000ms.
- **Active socket timeout:** Prevents socket leaks in the active socket pool. Defaults to 8000ms or twice the `freeSocketTimeout` (whichever is greater).
- **Active socket TTL:** Configurable TTL for active sockets, further preventing leaks.

## Supported Node.js Versions

Node.js >= 8.0.0

## Installation

```bash
npm install agentkeepalive --save
```

## Creating an Agent

```javascript
const http = require('http');
const Agent = require('agentkeepalive');

const keepaliveAgent = new Agent({
  // Configuration options
  maxSockets: 100,
  maxFreeSockets: 10,
  timeout: 60000, // Active socket timeout (60 seconds)
  freeSocketTimeout: 30000, // Free socket timeout (30 seconds)
});
```

**Options:**

* `keepAlive` (Boolean, default: `true`): Enables keep-alive behavior.  Setting to `false` disables the agent's keep-alive features.
* `keepAliveMsecs` (Number, default: `1000`): Initial delay for TCP Keep-Alive packets (only relevant if `keepAlive` is `true`).
* `freeSocketTimeout` (Number, default: `4000`): Timeout for free sockets in milliseconds.
* `timeout` (Number, default: `8000` or twice `freeSocketTimeout`): Timeout for active sockets in milliseconds.
* `maxSockets` (Number, default: `Infinity`): Maximum number of sockets per host.
* `maxFreeSockets` (Number, default: `256`): Maximum number of free sockets per host.
* `socketActiveTTL` (Number, default: `null`): Time-to-live for active sockets in milliseconds.  If `null`, the socket remains active until it's freed.

## Example Usage (HTTP):

```javascript
const options = {
  host: 'cnodejs.org',
  port: 80,
  path: '/',
  method: 'GET',
  agent: keepaliveAgent,
};

const req = http.request(options, res => {
  // Handle response...
});

req.on('error', err => {
  console.error('Request error:', err);
});

req.end();
```

## Example Usage (HTTPS):

```javascript
const https = require('https');
const HttpsAgent = require('agentkeepalive').HttpsAgent;

const keepaliveAgent = new HttpsAgent();
// ... (rest of the HTTPS request setup)
```


## Monitoring Agent Status

```javascript
// ... (agent creation)

setTimeout(() => {
  if (keepaliveAgent.statusChanged) {
    console.log('[%s] Agent status changed:', new Date(), keepaliveAgent.getCurrentStatus());
  }
}, 2000);
```

* `agent.statusChanged`: Boolean indicating if agent status has changed since last check.
* `agent.getCurrentStatus()`: Returns an object with current socket and request statistics (e.g., `createSocketCount`, `freeSockets`, `sockets`).

## `req.reusedSocket`

This agent supports `req.reusedSocket`, allowing you to detect if a request is being served using a reused socket.  This can be useful for handling `ECONNRESET` errors during keep-alive.

```javascript
const req = http.get(...);
req.on('error', (err) => {
  if (req.reusedSocket && err.code === 'ECONNRESET') {
    // Handle reconnection attempt
  }
});
```


## Benchmarking (See README in the benchmark folder)

## License

[MIT](LICENSE)

```
```