# Модуль для работы с ИИ-агентом, использующим браузер
## Обзор

Модуль `browser_agent.py` предоставляет класс `AIBrowserAgent`, предназначенный для создания и управления ИИ-агентами, которые могут использовать браузер для поиска информации и выполнения задач в интернете.

## Подробнее

Этот модуль позволяет быстро настроить и запустить ИИ-агента, способного искать информацию в Google и анализировать веб-страницы. Он использует библиотеку `browser_use` для взаимодействия с браузером и `langchain_openai` для интеграции с моделями OpenAI.
В коде реализована возможность работы как с драйвером по умолчанию, так и с пользовательским драйвером на основе Selenium или Playwright.

## Классы

### `AIBrowserAgent`

**Описание**: Класс `AIBrowserAgent` предназначен для создания агента, использующего браузер для выполнения задач, таких как поиск аналогов продуктов или ответы на вопросы.

**Принцип работы**:
Класс инициализируется с ключом API OpenAI, названием модели, поисковой системой и опциональным пользовательским драйвером. Он использует `langchain_openai` для взаимодействия с моделями OpenAI и `browser_use` для управления браузером.
Основной метод `run_task` запускает агента для выполнения заданной задачи, а методы `find_product_alternatives` и `ask_async` предоставляют удобные интерфейсы для поиска аналогов продуктов и ответов на вопросы соответственно.

**Атрибуты**:
- `api_key` (str): Ключ API OpenAI.
- `model_name` (str): Название языковой модели OpenAI (по умолчанию "gpt-4o-mini").
- `search_engine` (str): Поисковая система для использования (по умолчанию "google").
- `llm` (ChatOpenAI): Объект языковой модели OpenAI.
- `custom_driver` (Optional[object]): Пользовательский драйвер браузера.

**Методы**:
- `__init__`: Инициализирует класс `AIBrowserAgent`.
- `run_task`: Запускает агента для выполнения заданной задачи.
- `find_product_alternatives`: Ищет аналоги для продукта по заданному URL или SKU.
- `ask`: Синхронная обертка для асинхронного метода `ask_async`.
- `ask_async`: Отвечает на заданный вопрос, используя поиск в интернете.

### `__init__(self, api_key: str, model_name: str = "gpt-4o-mini", search_engine: str = "google", custom_driver: Optional[object] = None)`

```python
    def __init__(self,\
                 api_key: str,\
                 model_name: str = "gpt-4o-mini",\
                 search_engine: str = "google",\
                 custom_driver: Optional[object] = None):
        """
        Инициализирует класс BrowserAgent.

        Args:
            api_key: Ключ API OpenAI (необязательный). Если не указан, будет использован ключ из переменных окружения.
            model_name: Название языковой модели OpenAI для использования (по умолчанию "gpt-4o-mini").
            search_engine: Поисковая система для использования (по умолчанию "google").
            custom_driver: Optionally injected WebDriver instance, defaults to None (browser_use default).
        """
```

**Назначение**: Инициализация экземпляра класса `AIBrowserAgent` с заданными параметрами.

**Параметры**:
- `api_key` (str): Ключ API OpenAI.
- `model_name` (str, optional): Название языковой модели OpenAI. По умолчанию "gpt-4o-mini".
- `search_engine` (str, optional): Поисковая система для использования. По умолчанию "google".
- `custom_driver` (Optional[object], optional): Пользовательский драйвер браузера. По умолчанию `None`.

**Как работает функция**:
1. Сохраняет переданные параметры `api_key`, `model_name`, `search_engine` и `custom_driver` в атрибуты экземпляра класса.
2. Инициализирует атрибут `llm` как экземпляр класса `ChatOpenAI` с использованием переданных `model_name` и `api_key`.

```
A (Прием параметров)
|
B (Сохранение параметров в атрибуты экземпляра класса)
|
C (Инициализация LLM)
```

**Примеры**:
```python
agent = AIBrowserAgent(api_key="your_api_key", model_name="gpt-4o-mini", search_engine="google")
```
```python
agent = AIBrowserAgent(api_key="your_api_key", custom_driver=my_custom_driver)
```

### `async run_task(self, task_prompt: str) -> Optional[str]`

```python
    async def run_task(self, task_prompt: str) -> Optional[str]:
        """
        Запускает агента для выполнения заданной задачи.

        Args:
            task_prompt: Текст задачи для агента.

        Returns:
            Результат выполнения задачи в виде строки, или None в случае ошибки.
        """
```

**Назначение**: Запуск агента для выполнения заданной задачи, заданной в виде текстового запроса.

**Параметры**:
- `task_prompt` (str): Текст задачи для агента.

**Возвращает**:
- `Optional[str]`: Результат выполнения задачи в виде строки, или `None` в случае ошибки.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка во время выполнения задачи.

**Как работает функция**:
1. Логирует начало выполнения задачи.
2. Инициализирует переменную `driver` значением `None`, позволяя `browser_use` создать свой драйвер по умолчанию.
3. Если предоставлен пользовательский драйвер (`self.custom_driver`), присваивает его переменной `driver`.
4. Создает экземпляр класса `Agent` из библиотеки `browser_use`, передавая ему `task_prompt`, `llm` (языковую модель) и `driver`.
5. Запускает агента для выполнения задачи с помощью `await agent.run()`.
6. Логирует завершение выполнения задачи.
7. Пытается закрыть драйвер, если у него есть метод `close`.
8. Возвращает результат выполнения задачи.
9. В случае возникновения исключения логирует ошибку и возвращает `None`.

```
A (Прием task_prompt)
|
B (Инициализация драйвера)
|
C (Создание экземпляра Agent)
|
D (Запуск агента)
|
E (Закрытие драйвера)
|
F (Возврат результата)
```

**Примеры**:
```python
result = await agent.run_task("Найти информацию о последних новостях в мире.")
```

### `async find_product_alternatives(self, product_url: Optional[str] = None, sku: Optional[str] = None) -> Optional[str]`

```python
    async def find_product_alternatives(self, product_url: Optional[str] = None,\
                                        sku: Optional[str] = None) -> Optional[str]:
        """
        Ищет в сети аналоги для продукта по заданному URL или SKU.

        Args:
            product_url: URL продукта, для которого нужно найти аналоги (опционально).
            sku: SKU продукта, для которого нужно найти аналоги (опционально).

        Returns:
            Строку с описанием найденных аналогов, или None в случае ошибки.
        """
```

**Назначение**: Поиск в сети аналогов для продукта по заданному URL или SKU.

**Параметры**:
- `product_url` (Optional[str], optional): URL продукта, для которого нужно найти аналоги. По умолчанию `None`.
- `sku` (Optional[str], optional): SKU продукта, для которого нужно найти аналоги. По умолчанию `None`.

**Возвращает**:
- `Optional[str]`: Строку с описанием найденных аналогов, или `None` в случае ошибки.

**Как работает функция**:
1. Проверяет, передан ли `product_url` или `sku`.
2. Если передан `product_url`, формирует поисковый запрос в формате "аналоги {product_url}".
3. Если передан `sku`, формирует поисковый запрос в формате "аналоги товара с артикулом {sku}".
4. Если не передан ни `product_url`, ни `sku`, логирует предупреждение и возвращает `None`.
5. Кодирует поисковый запрос в URL-safe формат с помощью `urllib.parse.quote_plus`.
6. Формирует URL поисковой системы (Google или DuckDuckGo) с закодированным поисковым запросом.
7. Формирует `task_prompt` для агента, включающий инструкцию использовать указанную поисковую систему, перейти по сформированному URL и предоставить список из 3-5 аналогов продукта с названием и кратким описанием для каждого аналога.
8. Вызывает метод `self.run_task` с сформированным `task_prompt` и возвращает результат.

```
A (Прием product_url или sku)
|
B (Формирование поискового запроса)
|
C (Кодирование поискового запроса)
|
D (Формирование URL поисковой системы)
|
E (Формирование task_prompt)
|
F (Вызов run_task)
```

**Примеры**:
```python
alternatives = await agent.find_product_alternatives(product_url="https://www.apple.com/iphone-14/")
```
```python
alternatives = await agent.find_product_alternatives(sku="1493001")
```

### `ask(self, q: str) -> Optional[str]`

```python
    def ask(self, q: str) -> Optional[str]:
        """
        Синхронная обертка для асинхронного метода ask_async.  Не рекомендуется к использованию.
        """
```

**Назначение**: Синхронная обертка для асинхронного метода `ask_async`. Не рекомендуется к использованию.

**Параметры**:
- `q` (str): Вопрос, на который нужно ответить.

**Возвращает**:
- `Optional[str]`: Ответ на вопрос в виде строки, или `None` в случае ошибки.

**Как работает функция**:
1. Формирует `task_prompt` для агента, включающий инструкцию ответить на заданный вопрос, используя поиск в интернете, если это необходимо.
2. Вызывает метод `self.run_task` с сформированным `task_prompt` и возвращает результат.

```
A (Прием вопроса)
|
B (Формирование task_prompt)
|
C (Вызов run_task)
```

**Примеры**:
```python
answer = agent.ask("Какая сейчас погода в Москве?")
```

### `async ask_async(self, q: str) -> Optional[str]`

```python
    async def ask_async(self, q: str) -> Optional[str]:
        """
        Отвечает на заданный вопрос, используя поиск в интернете, если это необходимо.

        Args:
            question: Вопрос, на который нужно ответить.

        Returns:
            Ответ на вопрос в виде строки, или None в случае ошибки.
        """
```

**Назначение**: Ответ на заданный вопрос, используя поиск в интернете, если это необходимо.

**Параметры**:
- `q` (str): Вопрос, на который нужно ответить.

**Возвращает**:
- `Optional[str]`: Ответ на вопрос в виде строки, или `None` в случае ошибки.

**Как работает функция**:
1. Формирует `task_prompt` для агента, включающий инструкцию ответить на заданный вопрос, используя поиск в интернете, если это необходимо.
2. Вызывает метод `self.run_task` с сформированным `task_prompt` и возвращает результат.

```
A (Прием вопроса)
|
B (Формирование task_prompt)
|
C (Вызов run_task)
```

**Примеры**:
```python
answer = await agent.ask_async("Какая сейчас погода в Москве?")
```

## Функции

### `async def main()`

```python
async def main():
    """
    Пример использования класса BrowserAgent.
    """
```

**Назначение**: Функция `main` демонстрирует пример использования класса `AIBrowserAgent`.

**Как работает функция**:
1. Определяет `api_key` и `model_name`.
2. Создает экземпляр класса `AIBrowserAgent` с заданными параметрами.
3. Запускает поиск аналогов продукта по SKU.
4. Выводит найденные аналоги или сообщение об ошибке.
5. Задает вопрос и получает ответ с помощью `ask_async`.
6. Выводит ответ на вопрос или сообщение об ошибке.

```
A (Определение параметров)
|
B (Создание экземпляра AIBrowserAgent)
|
C (Поиск аналогов продукта)
|
D (Вывод результатов поиска аналогов)
|
E (Задание вопроса)
|
F (Получение ответа на вопрос)
|
G (Вывод ответа на вопрос)
```

**Примеры**:
```python
asyncio.run(main())