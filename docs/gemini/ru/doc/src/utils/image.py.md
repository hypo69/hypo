# Модуль `src.utils.image`

## Обзор

Модуль `src.utils.image` предоставляет асинхронные функции для скачивания, сохранения и обработки изображений. Он включает в себя функциональность для сохранения изображений из URL, сохранения данных изображений в файлы, получения данных изображений, поиска случайных изображений в каталогах, добавления водяных знаков, изменения размера и преобразования форматов изображений.

## Подробнее

Этот модуль предназначен для работы с изображениями, предоставляя инструменты для выполнения различных операций, таких как загрузка, сохранение, изменение размера, добавление водяных знаков и преобразование форматов. Он использует асинхронные операции для повышения производительности и эффективности при обработке изображений. Модуль также включает обработку ошибок и ведение журнала для обеспечения надежности и удобства отладки.

## Классы

### `ImageError`

**Описание**: Пользовательское исключение для ошибок, связанных с изображениями.

## Функции

### `save_image_from_url_async`

```python
async def save_image_from_url_async(image_url: str, filename: Union[str, Path]) -> Optional[str]:
    """
    Downloads an image from a URL and saves it locally asynchronously.

    Args:
        image_url (str): The URL to download the image from.
        filename (Union[str, Path]): The name of the file to save the image to.

    Returns:
        Optional[str]: The path to the saved file, or None if the operation failed.

    Raises:
        ImageError: If the image download or save operation fails.
    """
    ...
```

**Назначение**: Асинхронно загружает изображение из URL-адреса и сохраняет его локально.

**Параметры**:
- `image_url` (str): URL-адрес для загрузки изображения.
- `filename` (Union[str, Path]): Имя файла для сохранения изображения.

**Возвращает**:
- `Optional[str]`: Путь к сохраненному файлу или `None`, если операция не удалась.

**Вызывает исключения**:
- `ImageError`: Если загрузка или сохранение изображения не удались.

**Как работает функция**:

1.  **Инициализация**: Функция принимает URL изображения и имя файла в качестве входных данных.
2.  **Загрузка изображения**: Используется `aiohttp` для асинхронной загрузки изображения из указанного URL.
3.  **Обработка ответа**: Проверяется статус ответа HTTP, и в случае ошибки генерируется исключение.
4.  **Сохранение изображения**: Вызывается функция `save_image_async` для асинхронного сохранения загруженных данных изображения в файл.
5.  **Обработка исключений**: В случае возникновения каких-либо исключений в процессе загрузки или сохранения изображения, они регистрируются с помощью `logger.error`.
6.  **Возврат результата**: Функция возвращает путь к сохраненному файлу или `None` в случае неудачи.

**ASCII Flowchart**:

```
A [Начало]
|
B [Получение image_url и filename]
|
C [Загрузка изображения из image_url с использованием aiohttp]
|
D [Проверка статуса ответа HTTP]
|
E [Сохранение изображения с использованием save_image_async]
|
F [Обработка исключений]
|
G [Возврат пути к сохраненному файлу или None]
|
H [Конец]
```

**Примеры**:

```python
# Пример использования функции
image_url = "https://example.com/image.jpg"
filename = "path/to/save/image.jpg"
result = await save_image_from_url_async(image_url, filename)
if result:
    print(f"Изображение успешно сохранено по пути: {result}")
else:
    print("Не удалось сохранить изображение.")
```

### `save_image`

```python
def save_image(image_data: bytes, file_name: str | Path, format: str = 'PNG') -> Optional[str]:
    """
    Saves image data to a file in the specified format.

    Args:
        image_data (bytes): The binary image data.
        file_name (Union[str, Path]): The name of the file to save the image to.
        format (str): The format to save the image in, default is PNG.

    Returns:
        Optional[str]: The path to the saved file, or None if the operation failed.

    Raises:
        ImageError: If the file cannot be created, saved, or if the saved file is empty.
    """
    ...
```

**Назначение**: Сохраняет данные изображения в файл в указанном формате.

**Параметры**:
- `image_data` (bytes): Двоичные данные изображения.
- `file_name` (Union[str, Path]): Имя файла для сохранения изображения.
- `format` (str): Формат для сохранения изображения, по умолчанию PNG.

**Возвращает**:
- `Optional[str]`: Путь к сохраненному файлу или `None`, если операция не удалась.

**Вызывает исключения**:
- `ImageError`: Если файл не может быть создан, сохранен или если сохраненный файл пуст.

**Как работает функция**:

1.  **Инициализация**: Функция принимает двоичные данные изображения, имя файла и формат в качестве входных данных.
2.  **Создание каталога**: Создает родительский каталог для файла, если он не существует.
3.  **Использование BytesIO**: Использует `BytesIO` для создания объекта в памяти, чтобы избежать двойной записи на диск.
4.  **Открытие и сохранение изображения**: Открывает изображение из `BytesIO`, сбрасывает позицию буфера и сохраняет изображение обратно в `BytesIO` в указанном формате.
5.  **Запись данных в файл**: Записывает отформатированные данные изображения в файл.
6.  **Проверка файла**: Проверяет, был ли создан файл и не является ли он пустым.
7.  **Обработка исключений**: В случае возникновения каких-либо исключений в процессе создания или сохранения изображения, они регистрируются с помощью `logger.exception`.
8.  **Возврат результата**: Функция возвращает путь к сохраненному файлу или `None` в случае неудачи.

**ASCII Flowchart**:

```
A [Начало]
|
B [Получение image_data, file_name и format]
|
C [Создание родительского каталога]
|
D [Использование BytesIO для обработки изображения в памяти]
|
E [Открытие изображения из BytesIO]
|
F [Сохранение изображения в BytesIO в указанном формате]
|
G [Запись данных изображения из BytesIO в файл]
|
H [Проверка существования и размера файла]
|
I [Обработка исключений]
|
J [Возврат пути к сохраненному файлу или None]
|
K [Конец]
```

**Примеры**:

```python
# Пример использования функции
image_data = b"..."  # Двоичные данные изображения
file_name = "path/to/save/image.png"
result = save_image(image_data, file_name)
if result:
    print(f"Изображение успешно сохранено по пути: {result}")
else:
    print("Не удалось сохранить изображение.")
```

### `save_image_async`

```python
async def save_image_async(image_data: bytes, file_name: str | Path, format: str = 'PNG') -> Optional[str]:
    """
    Saves image data to a file in the specified format asynchronously.

    Args:
        image_data (bytes): The binary image data.
        file_name (Union[str, Path]): The name of the file to save the image to.
        format (str): The format to save the image in, default is PNG.

    Returns:
        Optional[str]: The path to the saved file, or None if the operation failed.

    Raises:
        ImageError: If the file cannot be created, saved, or if the saved file is empty.
    """
    ...
```

**Назначение**: Асинхронно сохраняет данные изображения в файл в указанном формате.

**Параметры**:
- `image_data` (bytes): Двоичные данные изображения.
- `file_name` (Union[str, Path]): Имя файла для сохранения изображения.
- `format` (str): Формат для сохранения изображения, по умолчанию PNG.

**Возвращает**:
- `Optional[str]`: Путь к сохраненному файлу или `None`, если операция не удалась.

**Вызывает исключения**:
- `ImageError`: Если файл не может быть создан, сохранен или если сохраненный файл пуст.

**Как работает функция**:

1.  **Инициализация**: Функция принимает двоичные данные изображения, имя файла и формат в качестве входных данных.
2.  **Создание каталога асинхронно**: Создает родительский каталог для файла, если он не существует, используя `asyncio.to_thread`.
3.  **Запись данных в файл асинхронно**: Записывает данные изображения в файл асинхронно, используя `aiofiles`.
4.  **Использование BytesIO**: Использует `BytesIO` для создания объекта в памяти, чтобы избежать двойной записи на диск.
5.  **Открытие и сохранение изображения**: Открывает изображение из `BytesIO`, сбрасывает позицию буфера и сохраняет изображение обратно в `BytesIO` в указанном формате.
6.  **Запись данных в файл асинхронно**: Записывает отформатированные данные изображения в файл асинхронно, используя `aiofiles`.
7.  **Проверка файла асинхронно**: Проверяет, был ли создан файл и не является ли он пустым, используя `aiofiles.os.path.exists` и `aiofiles.os.path.getsize`.
8.  **Обработка исключений**: В случае возникновения каких-либо исключений в процессе создания или сохранения изображения, они регистрируются с помощью `logger.exception`.
9.  **Возврат результата**: Функция возвращает путь к сохраненному файлу или `None` в случае неудачи.

**ASCII Flowchart**:

```
A [Начало]
|
B [Получение image_data, file_name и format]
|
C [Создание родительского каталога асинхронно]
|
D [Запись данных изображения в файл асинхронно]
|
E [Использование BytesIO для обработки изображения в памяти]
|
F [Открытие изображения из BytesIO]
|
G [Сохранение изображения в BytesIO в указанном формате]
|
H [Запись данных изображения из BytesIO в файл асинхронно]
|
I [Проверка существования и размера файла асинхронно]
|
J [Обработка исключений]
|
K [Возврат пути к сохраненному файлу или None]
|
L [Конец]
```

**Примеры**:

```python
# Пример использования функции
image_data = b"..."  # Двоичные данные изображения
file_name = "path/to/save/image.png"
result = await save_image_async(image_data, file_name)
if result:
    print(f"Изображение успешно сохранено по пути: {result}")
else:
    print("Не удалось сохранить изображение.")
```

### `get_image_bytes`

```python
def get_image_bytes(image_path: Path, raw: bool = True) -> Optional[BytesIO | bytes]:
    """
    Reads an image using Pillow and returns its bytes in JPEG format.

    Args:
        image_path (Path): The path to the image file.
        raw (bool): If True, returns a BytesIO object; otherwise, returns bytes. Defaults to True.

    Returns:
        Optional[Union[BytesIO, bytes]]: The bytes of the image in JPEG format, or None if an error occurs.
    """
    ...
```

**Назначение**: Считывает изображение с использованием Pillow и возвращает его байты в формате JPEG.

**Параметры**:
- `image_path` (Path): Путь к файлу изображения.
- `raw` (bool): Если `True`, возвращает объект `BytesIO`; в противном случае возвращает байты. По умолчанию `True`.

**Возвращает**:
- `Optional[Union[BytesIO, bytes]]`: Байты изображения в формате JPEG или `None`, если произошла ошибка.

**Как работает функция**:

1.  **Инициализация**: Функция принимает путь к изображению и флаг `raw` в качестве входных данных.
2.  **Открытие изображения**: Открывает изображение с использованием `PIL.Image.open`.
3.  **Преобразование в байты**: Создает объект `BytesIO` и сохраняет изображение в него в формате JPEG.
4.  **Возврат результата**: Возвращает объект `BytesIO` или байты изображения в зависимости от значения флага `raw`.
5.  **Обработка исключений**: В случае возникновения каких-либо исключений в процессе чтения или преобразования изображения, они регистрируются с помощью `logger.error`.

**ASCII Flowchart**:

```
A [Начало]
|
B [Получение image_path и raw]
|
C [Открытие изображения с использованием Pillow]
|
D [Создание объекта BytesIO]
|
E [Сохранение изображения в BytesIO в формате JPEG]
|
F [Возврат BytesIO или байтов изображения в зависимости от raw]
|
G [Обработка исключений]
|
H [Конец]
```

**Примеры**:

```python
# Пример использования функции
image_path = Path("path/to/image.jpg")
result = get_image_bytes(image_path)
if result:
    print(f"Байты изображения: {result[:100]}...")  # Вывод первых 100 байт
else:
    print("Не удалось получить байты изображения.")
```

### `get_raw_image_data`

```python
def get_raw_image_data(file_name: Union[str, Path]) -> Optional[bytes]:
    """
    Retrieves the raw binary data of a file if it exists.

    Args:
        file_name (Union[str, Path]): The name or path of the file to read.

    Returns:
        Optional[bytes]: The binary data of the file, or None if the file does not exist or an error occurs.
    """
    ...
```

**Назначение**: Извлекает необработанные двоичные данные файла, если он существует.

**Параметры**:
- `file_name` (Union[str, Path]): Имя или путь к файлу для чтения.

**Возвращает**:
- `Optional[bytes]`: Двоичные данные файла или `None`, если файл не существует или произошла ошибка.

**Как работает функция**:

1.  **Инициализация**: Функция принимает имя файла или путь к файлу в качестве входных данных.
2.  **Проверка существования файла**: Проверяет, существует ли файл по указанному пути.
3.  **Чтение данных**: Считывает двоичные данные файла, используя `Path.read_bytes()`.
4.  **Обработка исключений**: В случае возникновения каких-либо исключений в процессе чтения данных, они регистрируются с помощью `logger.error`.
5.  **Возврат результата**: Функция возвращает двоичные данные файла или `None` в случае, если файл не существует или произошла ошибка.

**ASCII Flowchart**:

```
A [Начало]
|
B [Получение file_name]
|
C [Проверка существования файла]
|
D [Чтение двоичных данных файла]
|
E [Обработка исключений]
|
F [Возврат двоичных данных файла или None]
|
G [Конец]
```

**Примеры**:

```python
# Пример использования функции
file_name = "path/to/file.txt"
result = get_raw_image_data(file_name)
if result:
    print(f"Двоичные данные файла: {result[:100]}...")  # Вывод первых 100 байт
else:
    print("Не удалось получить двоичные данные файла.")
```

### `random_image`

```python
def random_image(root_path: Union[str, Path]) -> Optional[str]:
    """
    Recursively searches for a random image in the specified directory.

    Args:
        root_path (Union[str, Path]): The directory to search for images.

    Returns:
        Optional[str]: The path to a random image, or None if no images are found.
    """
    ...
```

**Назначение**: Рекурсивно ищет случайное изображение в указанном каталоге.

**Параметры**:
- `root_path` (Union[str, Path]): Каталог для поиска изображений.

**Возвращает**:
- `Optional[str]`: Путь к случайному изображению или `None`, если изображения не найдены.

**Как работает функция**:

1.  **Инициализация**: Функция принимает путь к каталогу в качестве входных данных.
2.  **Определение расширений**: Определяет список расширений файлов изображений для поиска.
3.  **Поиск файлов**: Рекурсивно ищет все файлы с указанными расширениями в каталоге и его подкаталогах.
4.  **Выбор случайного файла**: Если найдены изображения, выбирает случайное изображение из списка.
5.  **Обработка отсутствия изображений**: Если изображения не найдены, регистрирует предупреждение с помощью `logger.warning`.
6.  **Возврат результата**: Функция возвращает путь к случайному изображению или `None`, если изображения не найдены.

**ASCII Flowchart**:

```
A [Начало]
|
B [Получение root_path]
|
C [Определение расширений файлов изображений]
|
D [Рекурсивный поиск файлов изображений в каталоге]
|
E [Проверка, найдены ли изображения]
|
F [Выбор случайного изображения из списка]
|
G [Обработка отсутствия изображений]
|
H [Возврат пути к случайному изображению или None]
|
I [Конец]
```

**Примеры**:

```python
# Пример использования функции
root_path = "path/to/image/directory"
result = random_image(root_path)
if result:
    print(f"Случайное изображение: {result}")
else:
    print("Изображения не найдены.")
```

### `add_text_watermark`

```python
def add_text_watermark(image_path: str | Path, watermark_text: str, output_path: Optional[str | Path] = None) -> Optional[str]:
    """
    Adds a text watermark to an image.

    Args:
        image_path (Union[str, Path]): Path to the image file.
        watermark_text (str): Text to use as the watermark.
        output_path (Optional[Union[str, Path]]): Path to save the watermarked image.
            Defaults to overwriting the original image.

    Returns:
        Optional[str]: Path to the watermarked image, or None on failure.
    """
    ...
```

**Назначение**: Добавляет текстовый водяной знак к изображению.

**Параметры**:
- `image_path` (Union[str, Path]): Путь к файлу изображения.
- `watermark_text` (str): Текст для использования в качестве водяного знака.
- `output_path` (Optional[Union[str, Path]]): Путь для сохранения изображения с водяным знаком. По умолчанию перезаписывает исходное изображение.

**Возвращает**:
- `Optional[str]`: Путь к изображению с водяным знаком или `None` в случае неудачи.

**Как работает функция**:

1.  **Инициализация**: Функция принимает путь к изображению, текст водяного знака и путь для сохранения в качестве входных данных.
2.  **Открытие изображения**: Открывает изображение с использованием `PIL.Image.open` и преобразует его в формат RGBA.
3.  **Создание прозрачного слоя**: Создает прозрачный слой для водяного знака.
4.  **Определение размера шрифта**: Определяет размер шрифта на основе размера изображения.
5.  **Загрузка шрифта**: Загружает шрифт Arial или использует шрифт по умолчанию, если Arial не найден.
6.  **Определение размеров текста**: Определяет размеры текста водяного знака.
7.  **Определение позиции текста**: Определяет позицию текста водяного знака в центре изображения.
8.  **Рисование текста**: Рисует текст на прозрачном слое.
9.  **Объединение изображения и водяного знака**: Объединяет изображение и водяной знак с использованием `Image.alpha_composite`.
10. **Сохранение изображения**: Сохраняет изображение с водяным знаком.
11. **Обработка исключений**: В случае возникновения каких-либо исключений в процессе добавления водяного знака, они регистрируются с помощью `logger.error`.
12. **Возврат результата**: Функция возвращает путь к изображению с водяным знаком или `None` в случае неудачи.

**ASCII Flowchart**:

```
A [Начало]
|
B [Получение image_path, watermark_text и output_path]
|
C [Открытие изображения и преобразование в RGBA]
|
D [Создание прозрачного слоя для водяного знака]
|
E [Определение размера шрифта на основе размера изображения]
|
F [Загрузка шрифта Arial или использование шрифта по умолчанию]
|
G [Определение размеров текста водяного знака]
|
H [Определение позиции текста в центре изображения]
|
I [Рисование текста на прозрачном слое]
|
J [Объединение изображения и водяного знака]
|
K [Сохранение изображения с водяным знаком]
|
L [Обработка исключений]
|
M [Возврат пути к изображению с водяным знаком или None]
|
N [Конец]
```

**Примеры**:

```python
# Пример использования функции
image_path = "path/to/image.jpg"
watermark_text = "Watermark"
output_path = "path/to/watermarked_image.jpg"
result = add_text_watermark(image_path, watermark_text, output_path)
if result:
    print(f"Изображение с водяным знаком успешно сохранено по пути: {result}")
else:
    print("Не удалось добавить водяной знак к изображению.")
```

### `add_image_watermark`

```python
def add_image_watermark(input_image_path: Path, watermark_image_path: Path, output_image_path: Optional[Path] = None) -> Optional[Path]:
    """
    Adds a watermark to an image and saves the result to the specified output path.

    Args:
        input_image_path (Path): Path to the input image.
        watermark_image_path (Path): Path to the watermark image.
        output_image_path (Optional[Path]): Path to save the watermarked image.
            If not provided, the image will be saved in an "output" directory.

    Returns:
        Optional[Path]: Path to the saved watermarked image, or None if the operation failed.
    """
    ...
```

**Назначение**: Добавляет изображение водяного знака к изображению и сохраняет результат по указанному пути.

**Параметры**:
- `input_image_path` (Path): Путь к исходному изображению.
- `watermark_image_path` (Path): Путь к изображению водяного знака.
- `output_image_path` (Optional[Path]): Путь для сохранения изображения с водяным знаком. Если не указан, изображение будет сохранено в каталоге "output".

**Возвращает**:
- `Optional[Path]`: Путь к сохраненному изображению с водяным знаком или `None`, если операция не удалась.

**Как работает функция**:

1.  **Инициализация**: Функция принимает пути к исходному изображению, изображению водяного знака и путь для сохранения в качестве входных данных.
2.  **Открытие изображений**: Открывает исходное изображение и изображение водяного знака с использованием `PIL.Image.open`.
3.  **Преобразование водяного знака в RGBA**: Преобразует изображение водяного знака в формат RGBA.
4.  **Изменение размера водяного знака**: Изменяет размер водяного знака, чтобы он занимал 8% ширины исходного изображения.
5.  **Определение позиции водяного знака**: Определяет позицию для размещения водяного знака в правом нижнем углу изображения с отступом в 20 пикселей.
6.  **Создание прозрачного слоя**: Создает новый прозрачный слой для объединения изображений.
7.  **Вставка исходного изображения**: Вставляет исходное изображение на прозрачный слой.
8.  **Вставка водяного знака**: Вставляет изображение водяного знака поверх исходного изображения.
9.  **Преобразование режима изображения**: Преобразует прозрачный слой в исходный режим изображения (RGB или P).
10. **Сохранение изображения**: Сохраняет окончательное изображение по указанному пути с оптимизированным качеством.
11. **Обработка исключений**: В случае возникновения каких-либо исключений в процессе добавления водяного знака, они регистрируются с помощью `logger.error`.
12. **Возврат результата**: Функция возвращает путь к изображению с водяным знаком или `None` в случае неудачи.

**ASCII Flowchart**:

```
A [Начало]
|
B [Получение input_image_path, watermark_image_path и output_image_path]
|
C [Открытие исходного изображения и изображения водяного знака]
|
D [Преобразование водяного знака в RGBA]
|
E [Изменение размера водяного знака (8% ширины исходного изображения)]
|
F [Определение позиции водяного знака (правый нижний угол с отступом 20px)]
|
G [Создание прозрачного слоя для объединения изображений]
|
H [Вставка исходного изображения на прозрачный слой]
|
I [Вставка водяного знака поверх исходного изображения]
|
J [Преобразование режима изображения (RGB или P)]
|
K [Сохранение окончательного изображения по указанному пути с оптимизацией]
|
L [Обработка исключений]
|
M [Возврат пути к изображению с водяным знаком или None]
|
N [Конец]
```

**Примеры**:

```python
# Пример использования функции
input_image_path = Path("path/to/input_image.jpg")
watermark_image_path = Path("path/to/watermark.png")
output_image_path = Path("path/to/output_image.jpg")
result = add_image_watermark(input_image_path, watermark_image_path, output_image_path)
if result:
    print(f"Изображение с водяным знаком успешно сохранено по пути: {result}")
else:
    print("Не удалось добавить водяной знак к изображению.")
```

### `resize_image`

```python
def resize_image(image_path: Union[str, Path], size: Tuple[int, int], output_path: Optional[Union[str, Path]] = None) -> Optional[str]:
    """
    Resizes an image to the specified dimensions.

    Args:
        image_path (Union[str, Path]): Path to the image file.
        size (Tuple[int, int]): A tuple containing the desired width and height of the image.
        output_path (Optional[Union[str, Path]]): Path to save the resized image.
            Defaults to overwriting the original image.

    Returns:
        Optional[str]: Path to the resized image, or None on failure.
    """
    ...
```

**Назначение**: Изменяет размер изображения до указанных размеров.

**Параметры**:
- `image_path` (Union[str, Path]): Путь к файлу изображения.
- `size` (Tuple[int, int]): Кортеж, содержащий желаемую ширину и высоту изображения.
- `output_path` (Optional[Union[str, Path]]): Путь для сохранения изображения с измененным размером. По умолчанию перезаписывает исходное изображение.

**Возвращает**:
- `Optional[str]`: Путь к изображению с измененным размером или `None` в случае неудачи.

**Как работает функция**:

1.  **Инициализация**: Функция принимает путь к изображению, размеры и путь для сохранения в качестве входных данных.
2.  **Открытие изображения**: Открывает изображение с использованием `PIL.Image.open`.
3.  **Изменение размера изображения**: Изменяет размер изображения до указанных размеров с использованием `Image.resize`.
4.  **Сохранение изображения**: Сохраняет изображение с измененным размером.
5.  **Обработка исключений**: В случае возникновения каких-либо исключений в процессе изменения размера изображения, они регистрируются с помощью `logger.error`.
6.  **Возврат результата**: Функция возвращает путь к изображению с измененным размером или `None` в случае неудачи.

**ASCII Flowchart**:

```
A [Начало]
|
B [Получение image_path, size и output_path]
|
C [Открытие изображения]
|
D [Изменение размера изображения]
|
E [Сохранение изображения с измененным размером]
|
F [Обработка исключений]
|
G [Возврат пути к изображению с измененным размером или None]
|
H [Конец]
```

**Примеры**:

```python
# Пример использования функции
image_path = "path/to/image.jpg"
size = (500, 500)
output_path = "path/to/resized_image.jpg"
result = resize_image(image_path, size, output_path)
if result:
    print(f"Изображение с измененным размером успешно сохранено по пути: {result}")
else:
    print("Не удалось изменить размер изображения.")
```

### `convert_image`

```python
def convert_image(image_path: Union[str, Path], format: str, output_path: Optional[Union[str, Path]] = None) -> Optional[str]:
    """
    Converts an image to the specified format.

    Args:
        image_path (Union[str, Path]): Path to the image file.
        format (str): Format to convert image to (e.g., "JPEG", "PNG").
        output_path (Optional[Union[str, Path]]): Path to save the converted image.
            Defaults to overwriting the original image.

    Returns:
        Optional[str]: Path to the converted image or None on failure.
    """
    ...
```

**Назначение**: Преобразует изображение в указанный формат.

**Параметры**:
- `image_path` (Union[str, Path]): Путь к файлу изображения.
- `format` (str): Формат для преобразования изображения (например, "JPEG", "PNG").
- `output_path` (Optional[Union[str, Path]]): Путь для сохранения преобразованного изображения. По умолчанию перезаписывает исходное изображение.

**Возвращает**:
- `Optional[str]`: Путь к преобразованному изображению или `None` в случае неудачи.

**Как работает функция**:

1.  **Инициализация**: Функция принимает путь к изображению, формат и путь для сохранения в качестве входных данных.
2.  **Открытие изображения**: Открывает изображение с использованием `PIL.Image.open`.
3.  **Сохранение изображения**: Сохраняет изображение в указанном формате.
4.  **Обработка исключений**: В случае возникновения каких-либо исключений в процессе преобразования изображения, они регистрируются с помощью `logger.error`.
5.  **Возврат результата**: Функция возвращает путь к преобразованному изображению или `None` в случае неудачи.

**ASCII Flowchart**:

```
A [Начало]
|
B [Получение image_path, format и output_path]
|
C [Открытие изображения]
|
D [Сохранение изображения в указанном формате]
|
E [Обработка исключений]
|
F [Возврат пути к преобразованному изображению или None]
|
G [Конец]
```

**Примеры**:

```python
# Пример использования функции
image_path = "path/to/image.jpg"
format = "PNG"
output_path = "path/to/converted_image.png"
result = convert_image(image_path, format, output_path)
if result:
    print(f"Изображение успешно преобразовано и сохранено по пути: {result}")
else:
    print("Не удалось преобразовать изображение.")
```

### `process_images_with_watermark`

```python
def process_images_with_watermark(folder_path: Path, watermark_path: Path) -> None:
    """
    Processes all images in the specified folder by adding a watermark and saving them in an "output" directory.

    Args:
        folder_path (Path): Path to the folder containing images.
        watermark_path (Path): Path to the watermark image.
    """
    ...
```

**Назначение**: Обрабатывает все изображения в указанной папке, добавляя водяной знак и сохраняя их в каталоге "output".

**Параметры**:
- `folder_path` (Path): Путь к папке, содержащей изображения.
- `watermark_path` (Path): Путь к изображению водяного знака.

**Как работает функция**:

1.  **Инициализация**: Функция принимает путь к папке с изображениями и путь к изображению водяного знака в качестве входных данных.
2.  **Проверка существования папки**: Проверяет, существует ли указанная папка.
3.  **Создание выходного каталога**: Создает каталог "output" в указанной папке, если он не существует.
4.  **Перебор файлов в папке**: Перебирает все файлы в указанной папке.
5.  **Проверка типа файла**: Проверяет, является ли файл изображением (PNG, JPG, JPEG).
6.  **Добавление водяного знака**: Добавляет изображение водяного знака к изображению, используя функцию `add_image_watermark`.
7.  **Сохранение изображения**: Со