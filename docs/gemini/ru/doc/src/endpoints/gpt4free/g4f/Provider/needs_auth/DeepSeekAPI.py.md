# Модуль для работы с DeepSeek API через g4f

## Обзор

Модуль `DeepSeekAPI.py` предоставляет асинхронный интерфейс для взаимодействия с API DeepSeek. Он предназначен для интеграции с библиотекой `g4f` и обеспечивает функциональность авторизации и обмена сообщениями с моделями DeepSeek, такими как `deepseek-v3` и `deepseek-r1`. Модуль использует `nodriver` для автоматизации процесса входа в систему и получения токена доступа.

## Подробней

Этот модуль позволяет пользователям взаимодействовать с моделями DeepSeek API через асинхронтные запросы. Он автоматизирует процесс аутентификации, используя `nodriver` для эмуляции браузера и получения токена доступа из `localStorage`. После аутентификации модуль создает чат-сессию и отправляет сообщения, обрабатывая ответы в реальном времени и предоставляя информацию о процессе мышления модели (для поддерживаемых моделей).

## Классы

### `DeepSeekAPI`

**Описание**: Класс `DeepSeekAPI` предоставляет асинхронный интерфейс для взаимодействия с API DeepSeek.

**Наследует**:
- `AsyncAuthedProvider`: Обеспечивает асинхронную аутентификацию.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL для доступа к DeepSeek API.
- `working` (bool): Указывает, работает ли провайдер (зависит от наличия библиотеки `dsk`).
- `needs_auth` (bool): Указывает, требуется ли аутентификация.
- `use_nodriver` (bool): Указывает, используется ли `nodriver` для аутентификации.
- `_access_token` (str | None): Приватный атрибут для хранения токена доступа.
- `default_model` (str): Модель, используемая по умолчанию (`deepseek-v3`).
- `models` (list[str]): Список поддерживаемых моделей (`deepseek-v3`, `deepseek-r1`).

**Методы**:
- `on_auth_async`: Асинхронно аутентифицирует пользователя и возвращает токен доступа.
- `create_authed`: Создает аутентифицированный сеанс и взаимодействует с API для получения ответов.

#### `on_auth_async`

```python
@classmethod
async def on_auth_async(cls, proxy: str = None, **kwargs) -> AsyncIterator:
    """
    Асинхронно аутентифицирует пользователя и возвращает токен доступа.

    Args:
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Yields:
        RequestLogin: Объект запроса на вход.
        AuthResult: Объект с результатами аутентификации, включая токен доступа.

    Raises:
        Exception: Если не удается получить токен доступа.

    Как работает функция:
    1. Проверяет, существует ли атрибут `browser` у класса. Если нет, инициализирует `nodriver` для эмуляции браузера.
    2. Отправляет запрос на вход, используя URL, полученный из переменной окружения `G4F_LOGIN_URL` или URL класса.
    3. Определяет асинхронную функцию `callback`, которая ожидает появления токена доступа в `localStorage` браузера.
    4. Извлекает токен доступа из `localStorage` и сохраняет его в атрибуте класса `_access_token`.
    5. Возвращает объект `AuthResult` с токеном доступа и дополнительными аргументами.
    """
```

**Внутренние функции**:
- `callback(page)`:
    ```python
    async def callback(page):
        """
        Асинхронно ожидает и извлекает токен доступа из `localStorage` браузера.

        Args:
            page: Объект страницы браузера.

        Raises:
            Exception: Если не удается получить токен доступа.
        """
    ```
    **Как работает внутренняя функция `callback`**:
    1. Внутри бесконечного цикла ожидает 1 секунду.
    2. Пытается получить значение ключа `userToken` из `localStorage` страницы.
    3. Преобразует полученное значение JSON в словарь и извлекает значение ключа `value`, которое является токеном доступа.
    4. Если токен доступа получен, цикл прерывается.
    5. Сохраняет токен доступа в атрибуте класса `_access_token`.

**ASCII flowchart**:

```
A[Инициализация nodriver (если необходимо)]
|
B[Запрос на вход (RequestLogin)]
|
C[Ожидание и извлечение токена из localStorage через callback]
|
D[Сохранение токена в _access_token]
|
E[Возврат AuthResult с токеном доступа]
```

**Примеры**:

```python
# Пример асинхронной аутентификации
async for result in DeepSeekAPI.on_auth_async(proxy="http://your_proxy"):
    if isinstance(result, AuthResult):
        print(f"Токен доступа: {result.api_key}")
```

#### `create_authed`

```python
@classmethod
async def create_authed(
    cls,
    model: str,
    messages: Messages,
    auth_result: AuthResult,
    conversation: JsonConversation = None,
    web_search: bool = False,
    **kwargs
) -> AsyncResult:
    """
    Создает аутентифицированный сеанс и взаимодействует с API для получения ответов.

    Args:
        model (str): Модель для использования (например, "deepseek-v3").
        messages (Messages): Список сообщений для отправки.
        auth_result (AuthResult): Результат аутентификации, содержащий токен доступа.
        conversation (JsonConversation, optional): Объект разговора. По умолчанию `None`.
        web_search (bool, optional): Указывает, следует ли использовать веб-поиск. По умолчанию `False`.
        **kwargs: Дополнительные аргументы.

    Yields:
        conversation (JsonConversation): Объект разговора.
        Reasoning (str): Информация о процессе мышления модели.
        chunk (str): Часть ответа модели.
        FinishReason (str): Причина завершения разговора.

    Raises:
        Exception: Если возникает ошибка при взаимодействии с API.

    Как работает функция:
    1. Инициализирует API DeepSeek с использованием токена доступа из `auth_result`.
    2. Создает новый чат-сеанс, если `conversation` не предоставлен.
    3. Отправляет последнее сообщение пользователя и обрабатывает ответы в реальном времени.
    4. Возвращает информацию о процессе мышления модели, части ответа и причину завершения разговора.
    """
```

**ASCII flowchart**:

```
A[Инициализация DeepSeek API с токеном доступа]
|
B[Создание чат-сессии (если conversation is None)]
|
C[Отправка последнего сообщения пользователя]
|
D[Обработка ответов в реальном времени]
|
E[Возврат Reasoning, chunk, FinishReason]
```

**Примеры**:

```python
# Пример создания аутентифицированного сеанса и получения ответов
async for result in DeepSeekAPI.create_authed(
    model="deepseek-v3",
    messages=[{"role": "user", "content": "Hello, how are you?"}],
    auth_result=auth_result
):
    print(result)
```

## Функции

В данном модуле функции отсутствуют.