# Модуль для работы с Excel (`xls`) файлами

## Обзор

Модуль `src.utils.xls` предназначен для конвертации данных между форматами Excel (`xls`) и JSON. Он включает в себя функции для чтения данных из Excel файлов в формат JSON и сохранения JSON данных в Excel файлы. Модуль поддерживает работу с несколькими листами в Excel файле, а также позволяет указывать конкретный лист для чтения.

## Подробнее

Этот модуль предоставляет удобные инструменты для обработки данных, хранящихся в формате Excel, и интеграции их в приложения, использующие JSON. Он облегчает перенос данных между различными системами и обеспечивает гибкость в работе с табличными данными.

## Функции

### `read_xls_as_dict`

```python
def read_xls_as_dict(
    xls_file: str,
    json_file: str = None,
    sheet_name: Union[str, int] = None
) -> Union[Dict, List[Dict], bool]:
    """
    Читает Excel файл и конвертирует его в JSON. Опционально конвертирует указанный лист и сохраняет результат в JSON файл.
    Обрабатывает ошибки.

    Args:
        xls_file (str): Путь к Excel файлу.
        json_file (str, optional): Путь для сохранения JSON файла. По умолчанию `None`.
        sheet_name (Union[str, int], optional): Имя или индекс листа для конвертации. По умолчанию `None`.

    Returns:
        Union[Dict, List[Dict], bool]: Возвращает словарь с данными из Excel файла, список словарей, если указан конкретный лист, или `False` в случае ошибки.

    Raises:
        FileNotFoundError: Если Excel файл не найден.
        Exception: Если возникает ошибка при обработке листа или другая непредвиденная ошибка.
    """
```

**Назначение**: Чтение данных из Excel файла и преобразование их в структуру данных Python (словарь или список словарей), с возможностью сохранения в JSON файл.

**Параметры**:
- `xls_file` (str): Путь к Excel файлу, который необходимо прочитать.
- `json_file` (str, optional): Путь к JSON файлу, в который будут сохранены данные. Если `None`, данные не сохраняются в файл. По умолчанию `None`.
- `sheet_name` (Union[str, int], optional): Имя или индекс листа в Excel файле, который необходимо прочитать. Если `None`, читаются все листы. По умолчанию `None`.

**Возвращает**:
- `Union[Dict, List[Dict], bool]`: Возвращает словарь, где ключи - имена листов, а значения - списки словарей с данными. Если указан `sheet_name`, возвращается список словарей с данными из этого листа. Возвращает `False` в случае ошибки.

**Вызывает исключения**:
- `FileNotFoundError`: Возникает, если не найден указанный Excel файл.
- `Exception`: Возникает при ошибках чтения или обработки данных из Excel файла.

**Как работает функция**:
1. **Проверка наличия файла**: Функция начинает с проверки существования указанного Excel файла. Если файл не найден, функция логирует ошибку и возвращает `False`.
2. **Чтение Excel файла**: С использованием библиотеки `pandas`, функция открывает Excel файл.
3. **Обработка листов**:
   - Если `sheet_name` не указан, функция итерируется по всем листам в Excel файле. Для каждого листа она читает данные и преобразует их в список словарей, добавляя в общий словарь `data_dict`.
   - Если `sheet_name` указан, функция читает данные только с указанного листа и преобразует их в список словарей.
4. **Сохранение в JSON (если указано)**: Если указан `json_file`, функция сохраняет полученные данные в JSON файл с отступами для удобочитаемости и кодировкой UTF-8.
5. **Обработка ошибок**: В случае возникновения ошибок при чтении данных с листов, функция логирует информацию об ошибке и возвращает `False`.
6. **Возврат данных**: Функция возвращает словарь `data_dict`, содержащий данные из Excel файла, или `False` в случае ошибки.

**Внутренние логические блоки и преобразования**:

```
Проверка_существования_файла
↓
Чтение_Excel_файла
↓
Указано_имя_листа? -- Нет → Итерация_по_листам → Чтение_данных_листа → Преобразование_в_словарь
                      |
                      Да → Чтение_данных_указанного_листа → Преобразование_в_словарь
↓
Указан_JSON_файл? -- Да → Сохранение_в_JSON_файл
↓
Возврат_данных
```

**Примеры**:

```python
# Чтение всех листов из Excel файла
data = read_xls_as_dict('input.xlsx')
if data:
    print(data)

# Чтение конкретного листа и сохранение в JSON
data = read_xls_as_dict('input.xlsx', 'output.json', 'Sheet1')
if data:
    print(data)
```

### `save_xls_file`

```python
def save_xls_file(data: Dict[str, List[Dict]], file_path: str) -> bool:
    """Saves JSON data to an Excel file. Handles errors gracefully."""
```

**Назначение**: Сохранение JSON данных в Excel файл, где ключи словаря верхнего уровня становятся именами листов, а значения - данными для этих листов.

**Параметры**:
- `data` (Dict[str, List[Dict]]): Словарь, где ключи - имена листов, а значения - списки словарей с данными для этих листов.
- `file_path` (str): Путь к файлу Excel, в который будут сохранены данные.

**Возвращает**:
- `bool`: Возвращает `True` в случае успешного сохранения данных в Excel файл и `False` в случае ошибки.

**Вызывает исключения**:
- `Exception`: Возникает при ошибках сохранения данных в Excel файл.

**Как работает функция**:
1. **Открытие Excel writer**: Функция использует `pandas.ExcelWriter` для открытия файла Excel в режиме записи. В качестве движка используется `xlsxwriter`.
2. **Итерация по листам**: Функция итерируется по ключам словаря `data`, где каждый ключ представляет имя листа.
3. **Создание DataFrame**: Для каждого листа создается `pandas.DataFrame` из списка словарей, представляющих данные для этого листа.
4. **Запись в Excel**: Данные из `DataFrame` записываются в Excel файл на соответствующий лист. Параметр `index=False` отключает запись индексов строк.
5. **Обработка ошибок**: В случае возникновения ошибок при записи данных, функция логирует информацию об ошибке и возвращает `False`.
6. **Сохранение и закрытие файла**: После записи всех листов, файл сохраняется и закрывается.

**Внутренние логические блоки и преобразования**:

```
Открытие_Excel_writer
↓
Итерация_по_листам
↓
Создание_DataFrame_для_листа
↓
Запись_DataFrame_в_Excel
↓
Сохранение_и_закрытие_файла
```

**Примеры**:

```python
data_to_save = {'Sheet1': [{'column1': 'value1', 'column2': 'value2'}]}
success = save_xls_file(data_to_save, 'output.xlsx')
if success:
    print("Successfully saved to output.xlsx")