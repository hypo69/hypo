# Модуль для экспериментов с моделью AI OpenAI

## Обзор

Модуль предназначен для экспериментов с использованием модели OpenAI. Он берет исходный код или документацию, отправляет ее в модель OpenAI для анализа и получения ответов. Главная цель - автоматизировать создание документации и другие задачи, связанные с анализом кода.

## Подробней

Данный модуль играет роль интерфейса между кодом проекта `hypotez` и моделью OpenAI. Он настраивает и отправляет запросы к модели, а затем обрабатывает и сохраняет полученные результаты. Модуль использует роль выполнения, заданную внутри кода, чтобы определить, какую задачу следует выполнить. Если роль — `doc_writer`, то для генерации документации используется модель **OpenAI GPT-4**.

## Классы

В данном модуле классы отсутствуют.

## Функции

### `main`

```python
def main() -> None:
    """ Main function to process files and interact with the model.

    This function reads a comment file, iterates over specified files in the source directory,
    and sends the file content to a model for analysis. It then processes the model's response.
    """
```

**Назначение**: Основная функция для обработки файлов и взаимодействия с моделью OpenAI.

**Параметры**:
- Отсутствуют.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `Exception`: В случае ошибки при взаимодействии с моделью или сохранении результатов.

**Внутренние функции**:
- Отсутствуют.

**Как работает функция**:

1.  Определяет роль выполнения (по умолчанию `doc_writer`).
2.  В зависимости от роли, выбирает файлы с инструкциями для модели.
3.  Читает инструкции из файлов, используя функцию `read_text_file`.
4.  Инициализирует модель OpenAI с системными инструкциями, именем модели и ID ассистента.
5.  Итерируется по файлам в исходной директории, используя функцию `yield_files_content`.
6.  Формирует входной контент для модели, включая комментарии, расположение файла и код.
7.  Отправляет контент в модель и получает ответ.
8.  Сохраняет ответ модели в файл, используя функцию `save_response`.
9.  Обрабатывает исключения, логируя ошибки с помощью `logger.error`.
10. Делает паузу на 20 секунд во избежание превышения лимитов API.

**ASII flowchart**:

```
Начало
↓
Определение роли -> Выбор инструкций
↓
Чтение инструкций
↓
Инициализация OpenAI модели
↓
Итерация по файлам (src_path, patterns)
↓
Формирование входного контента
↓
Отправка запроса в OpenAI модель -> Получение ответа
↓
Сохранение ответа (save_response)
↓
Обработка исключений (если есть)
↓
Пауза
↓
Конец
```

**Примеры**:
```python
# Пример вызова функции main()
main()
```

### `save_response`

```python
def save_response(file_path: Path, response: str, from_model: str) -> None:
    """ Save the model's response to a markdown file with updated path based on role.

    Args:
        file_path (Path): The original file path being processed.
        response (str): The response from the model to be saved.
    """
```

**Назначение**: Сохраняет ответ модели в markdown-файл, обновляя путь файла в зависимости от роли.

**Параметры**:
- `file_path` (Path): Исходный путь к обрабатываемому файлу.
- `response` (str): Ответ от модели, который необходимо сохранить.
- `from_model` (str): Имя модели, от которой получен ответ.

**Возвращает**:
- `None`

**Вызывает исключения**:
- Отсутствуют.

**Внутренние функции**:
- Отсутствуют.

**Как работает функция**:

1.  Определяет словарь `role_directories`, связывающий роли с директориями для сохранения файлов.
2.  Проверяет наличие текущей роли в словаре. Если роль неизвестна, логирует ошибку и завершает выполнение.
3.  Получает директорию, соответствующую роли.
4.  Формирует новый путь к файлу, заменяя часть пути `'src'` на директорию роли.
5.  Меняет суффикс файла на `.md`.
6.  Создает директорию для сохранения файла, если она не существует.
7.  Сохраняет ответ модели в новый файл.
8.  Выводит сообщение о том, куда был сохранен ответ.

**ASII flowchart**:

```
Начало
↓
Определение директорий для ролей
↓
Проверка роли в словаре -> Получение директории роли
↓
Формирование нового пути к файлу (замена 'src' на директорию роли)
↓
Изменение суффикса файла на .md
↓
Создание директории (если не существует)
↓
Сохранение ответа в файл
↓
Вывод сообщения о сохранении
↓
Конец
```

**Примеры**:
```python
from pathlib import Path

# Пример вызова функции save_response
file_path = Path("src/some/module/file.py")
response = "This is a sample response from the model."
save_response(file_path, response, from_model='openai')
```

### `yield_files_content`

```python
def yield_files_content(
    src_path: Path, patterns: list[str]
) -> Iterator[tuple[Path, str]]:
    """ Yield file content based on patterns from the source directory, excluding certain patterns and directories.

    Args:
        src_path (Path): The base directory to search for files.
        patterns (list[str]): List of file patterns to include (e.g., [\'*.py\', \'*.txt\']).

    Yields:
        Iterator[tuple[Path, str]]: A tuple of file path and its content as a string.
    """
```

**Назначение**: Генерирует содержимое файлов, соответствующих заданным шаблонам из исходной директории, исключая определенные шаблоны и директории.

**Параметры**:
- `src_path` (Path): Базовая директория для поиска файлов.
- `patterns` (list[str]): Список шаблонов файлов для включения (например, `['*.py', '*.txt']`).

**Возвращает**:
- `Iterator[tuple[Path, str]]`: Итератор кортежей, содержащих путь к файлу и его содержимое в виде строки.

**Вызывает исключения**:
- Отсутствуют.

**Внутренние функции**:
- Отсутствуют.

**Как работает функция**:

1.  Определяет регулярные выражения для исключаемых файлов и директорий (файлы, содержащие круглые скобки, и файлы/директории, начинающиеся с трех и более подчеркиваний).
2.  Определяет список служебных директорий, которые необходимо исключить (`.ipynb_checkpoints`, `_experiments`, `__pycache__`, `.git`, `.venv`).
3.  Итерируется по шаблонам файлов.
4.  Для каждого шаблона итерируется по файлам, найденным в `src_path`.
5.  Пропускает файлы, находящиеся в исключаемых директориях.
6.  Пропускает файлы, соответствующие исключаемым шаблонам.
7.  Читает содержимое файла и генерирует кортеж с путем к файлу и содержимым.

**ASII flowchart**:

```
Начало
↓
Определение исключаемых шаблонов и директорий
↓
Итерация по шаблонам файлов
↓
Поиск файлов в директории
↓
Проверка на исключаемые директории -> Пропуск, если найдено
↓
Проверка на исключаемые шаблоны -> Пропуск, если найдено
↓
Чтение содержимого файла
↓
Генерация (путь к файлу, содержимое)
↓
Конец
```

**Примеры**:
```python
from pathlib import Path

# Пример вызова функции yield_files_content
src_path = Path("src")
patterns = ["*.py", "*.md"]
for file_path, content in yield_files_content(src_path, patterns):
    print(f"File: {file_path}")
    print(f"Content: {content[:100]}...")