# Модуль для работы с провайдером MyShell
=============================================

Модуль содержит класс `MyShell`, который используется для взаимодействия с провайдером MyShell.

## Обзор

Модуль `MyShell` предоставляет реализацию для взаимодействия с API MyShell, сервиса для создания и взаимодействия с чат-ботами. Он поддерживает отправку сообщений, потоковую передачу ответов и обход Cloudflare.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для использования в качестве одного из провайдеров для получения ответов от языковой модели. Он реализует абстрактный класс `AbstractProvider` и предоставляет методы для создания запросов к API MyShell.

## Содержание

- [Классы](#Классы)
    - [MyShell](#MyShell)
- [Функции](#Функции)
    - [create_completion](#create_completion)

## Классы

### `MyShell`

**Описание**:
Класс `MyShell` предоставляет реализацию для взаимодействия с API MyShell.

**Наследует**:
- `AbstractProvider`: Абстрактный класс, определяющий интерфейс для всех провайдеров.

**Атрибуты**:
- `url` (str): URL для взаимодействия с MyShell.
- `working` (bool): Указывает, работает ли провайдер в данный момент.
- `supports_gpt_35_turbo` (bool): Поддерживает ли провайдер модель `gpt-3.5-turbo`.
- `supports_stream` (bool): Поддерживает ли провайдер потоковую передачу данных.

## Функции

### `create_completion`

```python
@classmethod
def create_completion(
    cls,
    model: str,
    messages: Messages,
    stream: bool,
    proxy: str = None,
    timeout: int = 120,
    webdriver = None,
    **kwargs
) -> CreateResult:
    """
    Создает завершение чата, используя API MyShell.

    Args:
        model (str): Модель для использования.
        messages (Messages): Список сообщений для отправки.
        stream (bool): Включена ли потоковая передача.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        timeout (int, optional): Время ожидания запроса. По умолчанию 120.
        webdriver:  Веб-драйвер для обхода защиты Cloudflare. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        CreateResult: Результат завершения чата.

    Raises:
        Exception: Если возникает ошибка при взаимодействии с API MyShell.
    """
```

**Назначение**:
Метод `create_completion` отвечает за создание запроса к API MyShell и получение ответа. Он использует веб-драйвер для обхода защиты Cloudflare и отправляет сообщения в формате, требуемом API MyShell.

**Параметры**:
- `cls`: Ссылка на класс `MyShell`.
- `model` (str): Имя используемой модели.
- `messages` (Messages): Список сообщений для отправки в API.
- `stream` (bool): Флаг, указывающий, нужно ли использовать потоковую передачу данных.
- `proxy` (str, optional): Адрес прокси-сервера, если необходимо. По умолчанию `None`.
- `timeout` (int, optional): Максимальное время ожидания ответа от API. По умолчанию 120 секунд.
- `webdriver`:  Веб-драйвер для обхода защиты Cloudflare. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы, которые могут быть переданы.

**Возвращает**:
- `CreateResult`: Результат завершения чата, который может быть либо текстом ответа, либо генератором текста при включенной потоковой передаче.

**Как работает функция**:

1. **Инициализация**:
   - Функция начинает работу с создания сессии веб-драйвера, используя контекстный менеджер `WebDriverSession`. Это обеспечивает автоматическое управление ресурсами драйвера.
2. **Обход Cloudflare**:
   - Вызывается функция `bypass_cloudflare` для обхода защиты Cloudflare, если она активна на сайте MyShell.
3. **Формирование данных запроса**:
   - Подготавливаются данные для отправки в API MyShell. Включается ID бота, сценарий разговора и отформатированное сообщение.
4. **Выполнение JavaScript**:
   - Выполняется JavaScript код через `driver.execute_script`, который отправляет POST-запрос к API MyShell с использованием `fetch`. Этот код также настраивает потоковое чтение ответа.
5. **Чтение потока данных**:
   - В цикле читаются чанки данных из потока ответа, декодируются и извлекаются полезные данные (`content`) из JSON-формата.
6. **Генерация результата**:
   - Если `stream` установлен в `True`, функция возвращает генератор, который выдает чанки данных по мере их поступления. В противном случае, функция объединяет все чанки и возвращает полный ответ.
7. **Обработка завершения**:
   - Цикл завершается, когда поток данных заканчивается (`chunk.done` становится `True`), и генератор перестает выдавать новые значения.

**ASCII Flowchart**:

```
A: Инициализация WebDriverSession
|
B: Обход Cloudflare
|
C: Формирование данных запроса
|
D: Выполнение JavaScript для отправки запроса
|
E: Чтение потока данных
|
F: Извлечение content из JSON
|
G: Выдача чанка данных (stream=True) или объединение всех чанков (stream=False)
|
H: Завершение при окончании потока данных
```

**Примеры**:

Пример 1: Получение ответа в потоковом режиме:

```python
messages = [{"role": "user", "content": "Hello, MyShell!"}]
for chunk in MyShell.create_completion(model="default", messages=messages, stream=True):
    print(chunk, end="")
```

Пример 2: Получение полного ответа без потоковой передачи:

```python
messages = [{"role": "user", "content": "Hello, MyShell!"}]
response = "".join(MyShell.create_completion(model="default", messages=messages, stream=False))
print(response)