# Модуль для работы с H2o API (устаревший)
=================================================

Модуль содержит класс `H2o`, который является устаревшим провайдером и предназначен для взаимодействия с H2o AI API.
Он использует асинхронные запросы для генерации текста на основе предоставленных сообщений.

## Обзор

Модуль `H2o` предоставляет класс `H2o`, который реализует асинхронный генератор для взаимодействия с API `gpt-gm.h2o.ai`. Этот модуль устарел и может быть удален в будущих версиях. Он позволяет отправлять запросы к API с использованием указанной модели и получать сгенерированный текст в виде асинхронного генератора.

## Подробней

Класс `H2o` наследуется от `AsyncGeneratorProvider` и использует библиотеку `aiohttp` для выполнения асинхронных HTTP-запросов. Он поддерживает установку параметров модели, отправку сообщений и получение результатов в виде потока текста.

## Классы

### `H2o(AsyncGeneratorProvider)`

**Описание**:
Класс `H2o` предоставляет интерфейс для взаимодействия с H2o AI API.

**Наследует**:
- `AsyncGeneratorProvider`: Базовый класс для асинхронных провайдеров генерации.

**Атрибуты**:
- `url` (str): URL для взаимодействия с H2o AI API.
- `model` (str): Название модели, используемой по умолчанию, `h2oai/h2ogpt-gm-oasst1-en-2048-falcon-40b-v1`.

**Методы**:
- `create_async_generator(...)`: Создает асинхронный генератор для получения ответов от API.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """ Создает асинхронный генератор для получения ответов от API H2o.

        Args:
            cls (H2o): Ссылка на класс `H2o`.
            model (str): Название используемой модели. Если не указано, используется значение по умолчанию `cls.model`.
            messages (Messages): Список сообщений для отправки в API.
            proxy (str, optional): Адрес прокси-сервера для использования при подключении к API. По умолчанию `None`.
            **kwargs: Дополнительные параметры, которые будут переданы в API.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий текст, сгенерированный API.

        Raises:
            aiohttp.ClientResponseError: Если возникает ошибка при выполнении HTTP-запроса.

        Внутренние функции:
            Отсутствуют.
        """
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор, который взаимодействует с API H2o для генерации текста на основе предоставленных сообщений.

**Как работает функция**:

1.  **Инициализация**:
    *   Определяется модель, если она не указана, используется значение по умолчанию.
    *   Формируются заголовки, включающие Referer.

2.  **Создание сессии**:
    *   Создается асинхронная клиентская сессия с использованием `aiohttp.ClientSession`.

3.  **Настройка параметров**:
    *   Формируются данные для отправки в API, включая принятие условий использования, параметры модели и настройки поиска.
    *   Выполняется POST-запрос к `/settings` для установки параметров сессии.

4.  **Запуск диалога**:
    *   Выполняется POST-запрос к `/conversation` для создания нового диалога с указанной моделью.
    *   Получается идентификатор диалога `conversationId` из ответа.

5.  **Отправка запроса и получение ответа**:
    *   Формируются данные для запроса, включая сообщения, параметры генерации текста (температура, максимальное количество токенов и др.) и опции запроса.
    *   Выполняется POST-запрос к `/conversation/{conversationId}` для отправки запроса на генерацию текста.

6.  **Обработка потока данных**:
    *   Полученный ответ обрабатывается построчно.
    *   Каждая строка декодируется из UTF-8.
    *   Если строка начинается с `data:`, она загружается как JSON.
    *   Из JSON извлекается текст токена, и если токен не является специальным, он возвращается через генератор.

7.  **Завершение диалога**:
    *   После завершения генерации текста выполняется DELETE-запрос к `/conversation/{conversationId}` для завершения диалога.

**Примеры**:

```python
    # Пример использования create_async_generator
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    async def main():
        async for token in H2o.create_async_generator(model="h2oai/h2ogpt-gm-oasst1-en-2048-falcon-40b-v1", messages=messages):
            print(token, end="")

    # Запуск асинхронной функции
    # asyncio.run(main())
```

```python
    # Пример использования с прокси
    messages = [{"role": "user", "content": "Tell me a joke."}]
    async def main():
        async for token in H2o.create_async_generator(model="h2oai/h2ogpt-gm-oasst1-en-2048-falcon-40b-v1", messages=messages, proxy="http://your_proxy:8080"):
            print(token, end="")

    # asyncio.run(main())
```