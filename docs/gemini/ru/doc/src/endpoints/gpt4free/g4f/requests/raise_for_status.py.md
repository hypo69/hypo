# Модуль обработки статусов ответов

## Обзор

Модуль предназначен для обработки HTTP-ответов и генерации исключений в зависимости от статуса ответа и содержимого. Он включает функции для проверки наличия ошибок Cloudflare и OpenAI, а также функции для асинхронной и синхронной обработки ответов.

## Подробней

Этот модуль используется для стандартизации обработки ошибок, возвращаемых различными API, в частности, Cloudflare и OpenAI. Он позволяет унифицировать логику обработки ошибок и предоставляет специализированные исключения для конкретных ситуаций, таких как обнаружение Cloudflare или превышение лимита запросов.

## Функции

### `is_cloudflare`

```python
def is_cloudflare(text: str) -> bool:
    """
    Определяет, является ли переданный текст ответом Cloudflare.

    Args:
        text (str): Текст ответа для анализа.

    Returns:
        bool: `True`, если текст содержит признаки ответа Cloudflare, иначе `False`.
    """
```

**Как работает функция**:

1. Функция принимает строку `text` в качестве входных данных.
2. Проверяет, содержит ли `text` подстроки, характерные для ответов Cloudflare, такие как "Generated by cloudfront", '<p id="cf-spinner-please-wait">', "<title>Attention Required! | Cloudflare</title>", 'id="cf-cloudflare-status"', '<div id="cf-please-wait">', "<title>Just a moment...</title>".
3. Если хотя бы одна из подстрок найдена, функция возвращает `True`. В противном случае возвращает `False`.

```
A: Получение текста ответа
|
B: Проверка на наличие подстрок Cloudflare
|
C: Возврат True, если найдено, иначе False
```

**Примеры**:

```python
>>> is_cloudflare("Generated by cloudfront")
True
>>> is_cloudflare("<title>Attention Required! | Cloudflare</title>")
True
>>> is_cloudflare("Some other text")
False
```

### `is_openai`

```python
def is_openai(text: str) -> bool:
    """
    Определяет, является ли переданный текст ответом OpenAI об ошибке.

    Args:
        text (str): Текст ответа для анализа.

    Returns:
        bool: `True`, если текст содержит признаки ответа OpenAI, иначе `False`.
    """
```

**Как работает функция**:

1. Функция принимает строку `text` в качестве входных данных.
2. Проверяет, содержит ли `text` подстроки, характерные для ответов OpenAI, такие как "<p>Unable to load site</p>" или 'id="challenge-error-text"'.
3. Если хотя бы одна из подстрок найдена, функция возвращает `True`. В противном случае возвращает `False`.

```
A: Получение текста ответа
|
B: Проверка на наличие подстрок OpenAI
|
C: Возврат True, если найдено, иначе False
```

**Примеры**:

```python
>>> is_openai("<p>Unable to load site</p>")
True
>>> is_openai("Some other text")
False
```

### `raise_for_status_async`

```python
async def raise_for_status_async(response: Union[StreamResponse, ClientResponse], message: str = None):
    """
    Асинхронно проверяет статус ответа и вызывает исключение, если ответ не успешен.

    Args:
        response (Union[StreamResponse, ClientResponse]): Объект ответа.
        message (str, optional): Пользовательское сообщение об ошибке. По умолчанию `None`.

    Raises:
        MissingAuthError: Если статус ответа 401.
        CloudflareError: Если статус ответа 403 и обнаружен Cloudflare.
        ResponseStatusError: Если статус ответа 403 и обнаружен OpenAI, 502 или неизвестная ошибка.
        RateLimitError: Если статус ответа 429, 402 или 504.
    """
```

**Как работает функция**:

1. Функция принимает объект ответа `response` (типа `StreamResponse` или `ClientResponse`) и необязательное сообщение `message`.
2. Проверяет, успешен ли ответ (`response.ok`). Если да, функция завершается.
3. Если `message` не предоставлено, функция пытается извлечь его из тела ответа в формате JSON или HTML.
4. В зависимости от статуса ответа и содержимого сообщения, функция вызывает соответствующее исключение:
   - `MissingAuthError`, если статус ответа 401.
   - `CloudflareError`, если статус ответа 403 и `is_cloudflare(message)` возвращает `True`.
   - `ResponseStatusError`, если статус ответа 403 и `is_openai(message)` возвращает `True`, или если статус ответа 502, или если произошла неизвестная ошибка.
   - `RateLimitError`, если статус ответа 429, 402 или 504.

```
A: Получение ответа и сообщения
|
B: Проверка успешности ответа (response.ok)
|
C: Извлечение сообщения из ответа (если message не предоставлено)
|
D: Проверка статуса ответа и содержимого сообщения
|
E: Вызов соответствующего исключения
```

**Примеры**:

```python
# Пример вызова функции с успешным ответом (предположим, что response.ok == True)
await raise_for_status_async(response)  # Функция ничего не делает

# Пример вызова функции с ошибкой Cloudflare
# (предположим, что response.status == 403 и is_cloudflare(message) == True)
try:
    await raise_for_status_async(response)
except CloudflareError as ex:
    print(f"Обнаружена ошибка Cloudflare: {ex}")

# Пример вызова функции с превышением лимита запросов
# (предположим, что response.status == 429)
try:
    await raise_for_status_async(response)
except RateLimitError as ex:
    print(f"Превышен лимит запросов: {ex}")
```

### `raise_for_status`

```python
def raise_for_status(response: Union[Response, StreamResponse, ClientResponse, RequestsResponse], message: str = None):
    """
    Синхронно проверяет статус ответа и вызывает исключение, если ответ не успешен.

    Args:
        response (Union[Response, StreamResponse, ClientResponse, RequestsResponse]): Объект ответа.
        message (str, optional): Пользовательское сообщение об ошибке. По умолчанию `None`.

    Raises:
        MissingAuthError: Если статус ответа 401.
        CloudflareError: Если статус ответа 403 и обнаружен Cloudflare.
        ResponseStatusError: Если статус ответа 403 и обнаружен OpenAI, 502 или неизвестная ошибка.
        RateLimitError: Если статус ответа 429, 402 или 504.
    """
```

**Как работает функция**:

1. Функция принимает объект ответа `response` (типа `Response`, `StreamResponse`, `ClientResponse` или `RequestsResponse`) и необязательное сообщение `message`.
2. Проверяет, содержит ли объект `response` атрибут `status`. Если да, вызывает асинхронную версию `raise_for_status_async` и возвращает её результат.
3. Проверяет, успешен ли ответ (`response.ok`). Если да, функция завершается.
4. Если `message` не предоставлено, функция пытается извлечь его из тела ответа в формате HTML.
5. В зависимости от статуса ответа и содержимого сообщения, функция вызывает соответствующее исключение:
   - `MissingAuthError`, если статус ответа 401.
   - `CloudflareError`, если статус ответа 403 и `is_cloudflare(response.text)` возвращает `True`.
   - `ResponseStatusError`, если статус ответа 403 и `is_openai(response.text)` возвращает `True`, или если статус ответа 502, или если произошла неизвестная ошибка.
   - `RateLimitError`, если статус ответа 429, 402 или 504.

```
A: Получение ответа и сообщения
|
B: Проверка наличия атрибута status
|
C: Вызов raise_for_status_async (если status есть)
|
D: Проверка успешности ответа (response.ok)
|
E: Извлечение сообщения из ответа (если message не предоставлено)
|
F: Проверка статуса ответа и содержимого сообщения
|
G: Вызов соответствующего исключения
```

**Примеры**:

```python
# Пример вызова функции с успешным ответом (предположим, что response.ok == True)
raise_for_status(response)  # Функция ничего не делает

# Пример вызова функции с ошибкой Cloudflare
# (предположим, что response.status_code == 403 и is_cloudflare(response.text) == True)
try:
    raise_for_status(response)
except CloudflareError as ex:
    print(f"Обнаружена ошибка Cloudflare: {ex}")

# Пример вызова функции с превышением лимита запросов
# (предположим, что response.status_code == 429)
try:
    raise_for_status(response)
except RateLimitError as ex:
    print(f"Превышен лимит запросов: {ex}")
```