# –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –º–æ–¥—É–ª—è `utils`

**–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞:**

- **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º**: 7/10
- **–ü–ª—é—Å—ã**:
    - –ö–æ–¥ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–æ–≥–∏—á–µ–Ω –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω.
    - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, —á—Ç–æ —Ö–æ—Ä–æ—à–æ –¥–ª—è Telegram-–±–æ—Ç–∞.
    - –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤ —Ü–µ–ª–æ–º –æ–ø–∏—Å—ã–≤–∞—é—Ç –ª–æ–≥–∏–∫—É.
- **–ú–∏–Ω—É—Å—ã**:
    -  –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤ —Ç–µ–∫—Å—Ç–µ.
    -  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `logger` –∏–∑ `loguru`, –∞ –Ω–µ –∏–∑ `src.logger`.
    -  –¢–µ–∫—Å—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–æ–∂–µ–Ω –¥–ª—è —á—Ç–µ–Ω–∏—è.
    -  –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç RST-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏.
    -  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `try-except` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é:**

1. **–ò–º–ø–æ—Ä—Ç –ª–æ–≥–≥–µ—Ä–∞**: –ò–∑–º–µ–Ω–∏—Ç–µ –∏–º–ø–æ—Ä—Ç –ª–æ–≥–≥–µ—Ä–∞ –Ω–∞ `from src.logger import logger`.
2.  **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫**: –ü–µ—Ä–µ—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–π—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π, —á—Ç–æ–±—ã –æ–Ω –±—ã–ª –±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º—ã–º, –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è —Å—Ç—Ä–æ–∫, –∫—Ä–æ–º–µ —Ç–µ—Ö, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ —Ñ—É–Ω–∫—Ü–∏—è—Ö –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –≤—ã–≤–æ–¥–∞.
3.  **RST-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: –î–æ–±–∞–≤—å—Ç–µ RST-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ `successful_payment_logic`.
4.  **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –ó–∞–º–µ–Ω–∏—Ç–µ –±–ª–æ–∫ `try-except` –Ω–∞ `logger.error` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.
5.  **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ f-—Å—Ç—Ä–æ–∫**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ f-—Å—Ç—Ä–æ–∫–∏ –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞.
6. **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏**: –£—Ç–æ—á–Ω–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –±–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–º–∏ –∏ –æ–ø–∏—Å—ã–≤–∞–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è, –∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∫–æ–Ω—Å—Ç–∞—Ç–∏—Ä–æ–≤–∞–ª–∏ –∏—Ö –Ω–∞–ª–∏—á–∏–µ.

**–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥:**

```python
from aiogram import Bot
from sqlalchemy.ext.asyncio import AsyncSession
from src.logger import logger  # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç –ª–æ–≥–≥–µ—Ä–∞
from bot.config import settings
from bot.dao.dao import PurchaseDao, ProductDao
from bot.user.kbs import main_user_kb
from bot.user.schemas import PaymentData


async def successful_payment_logic(
    session: AsyncSession, payment_data: dict, currency: str, user_tg_id: int, bot: Bot
) -> None:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É, –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –æ –ø–æ–∫—É–ø–∫–µ –≤ –ë–î,
    –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

    :param session: –°–µ—Å—Å–∏—è SQLAlchemy –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î.
    :type session: AsyncSession
    :param payment_data: –î–∞–Ω–Ω—ã–µ –æ–± –æ–ø–ª–∞—Ç–µ.
    :type payment_data: dict
    :param currency: –í–∞–ª—é—Ç–∞ –æ–ø–ª–∞—Ç—ã.
    :type currency: str
    :param user_tg_id: Telegram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    :type user_tg_id: int
    :param bot: –≠–∫–∑–µ–º–ø–ª—è—Ä Telegram –±–æ—Ç–∞.
    :type bot: Bot
    :raises Exception: –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º.

    –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
        >>> from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
        >>> from aiogram import Bot
        >>> from unittest.mock import AsyncMock
        >>> async def test_successful_payment_logic():
        ...     engine = create_async_engine("sqlite+aiosqlite:///:memory:")
        ...     async with engine.begin() as conn:
        ...         await conn.run_sync(Base.metadata.create_all)
        ...     async_session = sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)
        ...     async with async_session() as session:
        ...         bot_mock = AsyncMock(spec=Bot)
        ...         payment_data = {
        ...             "product_id": "1",
        ...             "price": "100",
        ...             "payment_type": "stars",
        ...             "payment_id": "123",
        ...             "user_id": "456",
        ...         }
        ...         await successful_payment_logic(
        ...             session=session,
        ...             payment_data=payment_data,
        ...             currency="USD",
        ...             user_tg_id=123,
        ...             bot=bot_mock
        ...         )
        ...         assert bot_mock.send_message.call_count > 0
        ...         assert bot_mock.send_document.call_count == 0
    """
    product_id = int(payment_data.get('product_id'))
    price = payment_data.get('price')
    payment_type = payment_data.get('payment_type')
    payment_id = payment_data.get('payment_id')
    user_id = payment_data.get('user_id')

    await PurchaseDao.add(session=session, values=PaymentData(**payment_data)) # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –ø–æ–∫—É–ø–∫–µ –≤ –ë–î
    product_data = await ProductDao.find_one_or_none_by_id(session=session, data_id=product_id) # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–æ–≤–∞—Ä–µ

    for admin_id in settings.ADMIN_IDS: # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
        try:
             await bot.send_message(
                chat_id=admin_id,
                text=(
                    f'üí≤ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å c ID {user_id} –∫—É–ø–∏–ª —Ç–æ–≤–∞—Ä <b>{product_data.name}</b> (ID: {product_id}) '
                    f'–∑–∞ <b>{price} {currency}</b>.'
                )
             )
        except Exception as e:
           logger.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º: {e}')# –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ –ª–æ–≥–≥–µ—Ä


    file_text = 'üì¶ <b>–¢–æ–≤–∞—Ä –≤–∫–ª—é—á–∞–µ—Ç —Ñ–∞–π–ª:</b>' if product_data.file_id else 'üìÑ <b>–¢–æ–≤–∞—Ä –Ω–µ –≤–∫–ª—é—á–∞–µ—Ç —Ñ–∞–π–ª—ã:</b>' # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–∞

    product_text = ( # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        'üéâ <b>–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É!</b>\\n\\n'
        'üõí <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–º —Ç–æ–≤–∞—Ä–µ:</b>\\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n'
        f'üîπ <b>–ù–∞–∑–≤–∞–Ω–∏–µ:</b> <b>{product_data.name}</b>\\n'
        f'üîπ <b>–û–ø–∏—Å–∞–Ω–∏–µ:</b>\\n<i>{product_data.description}</i>\\n'
        f'üîπ <b>–¶–µ–Ω–∞:</b> <b>{price} {currency}</b>\\n'
        f'üîπ <b>–ó–∞–∫—Ä—ã—Ç–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</b>\\n<i>{product_data.hidden_content}</i>\\n'
        '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\\n'
        f'{file_text}\\n\\n'
        '‚ÑπÔ∏è <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Å–µ—Ö –≤–∞—à–∏—Ö –ø–æ–∫—É–ø–∫–∞—Ö –≤—ã –º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –≤ –ª–∏—á–Ω–æ–º –ø—Ä–æ—Ñ–∏–ª–µ.</b>'
    )


    if product_data.file_id: # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        await bot.send_document(
            document=product_data.file_id,
            chat_id=user_tg_id,
            caption=product_text,
            reply_markup=main_user_kb(user_tg_id)
        )
    else:
        await bot.send_message(chat_id=user_tg_id, text=product_text, reply_markup=main_user_kb(user_tg_id)) # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç

    if payment_type == 'stars': # –ï—Å–ª–∏ –æ–ø–ª–∞—Ç–∞ –∑–≤–µ–∑–¥–∞–º–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–≤–µ–∑–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        await bot.refund_star_payment(user_id=user_tg_id, telegram_payment_charge_id=payment_id)
```