# Модуль перевода полей товара на языки клиентской базы данных

## Обзор

Модуль `product_fields_translator.py` предназначен для перевода полей товара PrestaShop на языки, используемые в клиентской базе данных. Он содержит функции для обновления идентификаторов языка в словарях полей товара и для применения переводов из таблицы переводов PrestaShop.

## Подробней

Этот модуль играет важную роль в процессе интеграции данных о товарах из PrestaShop в другие системы, где требуется соответствие языковых идентификаторов. Он обеспечивает правильное отображение мультиязычных данных о товарах на стороне клиента.

## Функции

### `rearrange_language_keys`

```python
def rearrange_language_keys(presta_fields_dict: dict, client_langs_schema: dict | List[dict], page_lang: str) -> dict:
    """Функция обновляет идентификатор языка в словаре presta_fields_dict на соответствующий идентификатор
    из схемы клиентских языков при совпадении языка страницы.

    Args:
        presta_fields_dict (dict): Словарь полей товара.
        page_lang (str): Язык страницы.
        client_langs_schema (list | dict): Схема языков клиента.

    Returns:
        dict: Обновленный словарь presta_fields_dict.
    """
```

**Описание**: Обновляет идентификатор языка в словаре `presta_fields_dict` на соответствующий идентификатор из схемы клиентских языков при совпадении языка страницы.

**Как работает функция**:

1.  Итерируется по схеме языков клиента (`client_langs_schema`) для поиска соответствия языка страницы (`page_lang`) на основе полей `locale`, `iso_code` или `language_code`.
2.  Если соответствие найдено, извлекается идентификатор языка клиента (`client_lang_id`).
3.  Затем итерируется по полям товара в словаре `presta_fields_dict`. Если поле является словарем и содержит ключ `language`, обновляется атрибут `id` в каждом элементе списка `language` на строковое представление `client_lang_id`.
4.  Возвращает обновленный словарь `presta_fields_dict`.

**Параметры**:

*   `presta_fields_dict` (dict): Словарь полей товара.
*   `client_langs_schema` (list | dict): Схема языков клиента.
*   `page_lang` (str): Язык страницы.

**Возвращает**:

*   `dict`: Обновленный словарь `presta_fields_dict`.

### `translate_presta_fields_dict`

```python
def translate_presta_fields_dict (presta_fields_dict: dict, 
                                  client_langs_schema: list | dict, 
                                  page_lang: str = None) -> dict:
    """ @Перевод мультиязычных полей в соответствии со схемой значений `id` языка в базе данных клиента
	    Функция получает на вход заполненный словарь полей. Мультиязычные поля содржат значения,
	    полученные с сайта поставщика в виде словаря 
	    ```
	    {
	\t    \'language\':[\
	\t\t\t\t\t    {\'attrs\':{\'id\':\'1\'}, \'value\':value},\
	\t\t\t\t\t    ]\
	    }\
	    ```
	    У клиента язык с ключом `id=1` Может быть любым в зависимости от того на каком языке была 
	    изначально установлена PrestaShop. Чаще всего это английский, но это не правило.
	    Точные соответствия я получаю в схеме языков клиента 
	    locator_description
	    Самый быстрый способ узнать схему API языков - набрать в адресной строке браузера
	    https://API_KEY@mypresta.com/api/languages?display=full&io_format=JSON
	  
    @param client_langs_schema `dict` словарь актуальных языков на клиенте
    @param presta_fields_dict `dict` словарь полей товара собранный со страницы поставщика
    @param page_lang `str` язык страницы поставщика в коде en-US, ru-RU, he_HE. 
    Если не задан - функция пытается определить п тексту
    @returns presta_fields_dict переведенный словарь полей товара
    """
```

**Описание**: Переводит мультиязычные поля в соответствии со схемой значений `id` языка в базе данных клиента.

**Как работает функция**:

1.  Вызывает функцию `rearrange_language_keys` для переупорядочивания ключей таблицы языков.
2.  Получает переводы продукта из таблицы переводов PrestaShop.
3.  Если переводы для данного товара отсутствуют, добавляет текущий перевод как новый.
4.  Итерируется по схеме языков клиента и переведенным записям. Если `iso_code` клиента присутствует в `locale` переведенной записи, записывает перевод из таблицы, обновляя значения в `presta_fields_dict`.
5.  Логирует ошибки, возникающие в процессе перевода.
6.  Возвращает переведенный словарь полей товара `presta_fields_dict`.

**Параметры**:

*   `presta_fields_dict` (dict): Словарь полей товара, собранный со страницы поставщика.
*   `client_langs_schema` (list | dict): Словарь актуальных языков на клиенте.
*   `page_lang` (str, optional): Язык страницы поставщика в коде (например, en-US, ru-RU, he_HE). Если не указан, функция пытается определить язык по тексту. По умолчанию `None`.

**Возвращает**:

*   `dict`: Переведенный словарь полей товара `presta_fields_dict`.

**Вызывает исключения**:

*   `Exception`: Логируется с использованием `logger.error` при возникновении ошибок в процессе перевода.