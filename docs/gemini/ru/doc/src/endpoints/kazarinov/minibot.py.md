# Модуль `minibot`

## Обзор

Модуль `minibot` предназначен для обработки запросов, связанных с созданием прайс-листов для пользователя Казаринова через Telegram-бота. Он включает в себя обработку текстовых сообщений, URL-адресов, голосовых сообщений и документов, а также взаимодействие с AI-моделью Google Gemini для генерации ответов на вопросы.

## Подробнее

Модуль предоставляет функциональность Telegram-бота, способного обрабатывать различные команды и типы сообщений от пользователей. Он использует Google Gemini для обработки текстовых запросов и предоставляет сценарии для обработки URL-адресов, особенно из OneTab, с целью извлечения информации о товарах и ценах. Также реализована обработка голосовых сообщений и документов.

## Классы

### `Config`

**Описание**: Класс `Config` содержит настройки конфигурации для бота, такие как токен Telegram-бота, идентификатор канала, пути к файлам и сообщения.

**Принцип работы**:
Класс `Config` определяет настройки, необходимые для работы бота. В зависимости от режима работы (PRODUCTION или DEV) используются разные токены ботов. Также задаются другие параметры, такие как ID канала, пути к директориям и текстовые сообщения.

**Атрибуты**:
- `ENDPOINT` (str): Имя endpoint.
- `MODE` (str): Режим работы бота (`PRODUCTION` или `DEV`).
- `BOT_TOKEN` (str): Токен Telegram-бота.
- `CHANNEL_ID` (str): ID канала Telegram.
- `PHOTO_DIR` (Path): Путь к директории с фотографиями.
- `COMMAND_INFO` (str): Информация о боте для команды `/info`.
- `UNKNOWN_COMMAND_MESSAGE` (str): Сообщение для неизвестных команд.
- `START_MESSAGE` (str): Приветственное сообщение при старте бота.
- `HELP_MESSAGE` (str): Сообщение помощи с описанием доступных команд.

### `BotHandler`

**Описание**: Класс `BotHandler` обрабатывает команды, полученные от Telegram-бота, и управляет взаимодействием с пользователем.

**Принцип работы**:
Класс `BotHandler` инициализирует обработчик событий Telegram-бота, определяет логику обработки текстовых сообщений, URL-адресов и команды `--next`. Он использует AI-модель Google Gemini для генерации ответов на вопросы.

**Атрибуты**:
- `base_dir` (Path): Базовая директория для хранения ресурсов бота.
- `questions_list` (List[str]): Список вопросов для обработки команды `--next`.
- `model` (GoogleGenerativeAI): Экземпляр класса `GoogleGenerativeAI` для взаимодействия с AI-моделью Gemini.

**Методы**:
- `__init__(self)`: Инициализирует обработчик событий телеграм-бота.
- `handle_message(self, bot: telebot, message: 'message')`: Обрабатывает текстовые сообщения.
- `_send_user_flowchart(self, bot, chat_id)`: Отправляет схему user_flowchart.
- `_handle_url(self, bot, message: 'message')`: Обрабатывает URL, присланный пользователем.
- `_handle_next_command(self, bot, message)`: Обрабатывает команду `--next` и её аналоги.
- `help_command(self, bot, message)`: Обрабатывает команду `/help`.
- `send_pdf(self, bot, message, pdf_file)`: Обрабатывает команду `/sendpdf` для отправки PDF.
- `handle_voice(self, bot, message)`: Обрабатывает голосовые сообщения.
- `_transcribe_voice(self, file_path)`: Транскрибирует голосовое сообщение (заглушка).
- `handle_document(self, bot, message)`: Обрабатывает полученные документы.

## Функции

### `main`

```python
def main(restarts: int = 5):
    """
    Запускает Telegram-бота и обеспечивает его перезапуск в случае ошибок.

    Args:
        restarts (int, optional): Максимальное количество попыток перезапуска бота. По умолчанию 5.

    Raises:
        Exception: Если происходит ошибка во время работы бота.

    Как работает функция:
    1. Инициализирует и запускает Telegram-бота в заданном режиме (`Config.MODE`).
    2. Устанавливает бесконечный цикл для работы бота (`bot.polling(none_stop=True)`).
    3. В случае возникновения исключения (ошибки) при работе бота:
       - Логирует информацию об ошибке.
       - Пытается остановить бота.
       - Если количество попыток перезапуска (`restarts`) больше 1, ждет 10 секунд и повторяет запуск.
       - Если количество попыток перезапуска исчерпано, логирует информацию о превышении количества переподключений.
    """
```

**Описание**: Функция `main` запускает Telegram-бота и обеспечивает его перезапуск в случае ошибок.

**Параметры**:
- `restarts` (int, optional): Максимальное количество попыток перезапуска бота. По умолчанию 5.

**Вызывает исключения**:
- `Exception`: Если происходит ошибка во время работы бота.

**Как работает функция**:

```
Запуск бота
│
├──→ Установка бесконечного цикла для работы бота
│   │
│   └──→ В случае возникновения ошибки:
│       │
│       ├──→ Логирование информации об ошибке
│       │
│       ├──→ Попытка остановить бота
│       │
│       ├──→ Если количество попыток перезапуска > 1:
│       │   │
│       │   ├──→ Ожидание 10 секунд
│       │   │
│       │   └──→ Повторный запуск
│       │
│       └──→ Иначе:
│           │
│           └──→ Логирование информации о превышении количества переподключений
│
└──→ Завершение
```

**Примеры**:

```python
if __name__ == '__main__':
    main(restarts=5)