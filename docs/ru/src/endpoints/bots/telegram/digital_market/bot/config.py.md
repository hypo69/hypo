# Модуль конфигурации бота Telegram для цифрового рынка

## Обзор

Этот модуль содержит настройки и конфигурации для Telegram-бота цифрового рынка, включая параметры подключения к боту, идентификаторы администраторов, токены провайдеров, URL сайта и другие параметры, необходимые для работы бота.

## Подробнее

Этот модуль предоставляет класс `Settings`, который использует `pydantic_settings` для загрузки параметров из переменных среды и обеспечивает удобный доступ к ним через атрибуты класса. Он также инициализирует бота и диспетчер aiogram, а также настраивает логирование.

## Классы

### `Settings`

**Описание**: Класс `Settings` наследуется от `BaseSettings` и предназначен для хранения конфигурационных параметров бота. Он автоматически загружает значения из переменных среды, указанных в файле `.env`.

**Как работает класс**:

1.  **Инициализация**: Класс инициализируется с использованием `pydantic_settings`, который автоматически загружает переменные среды, определенные в файле `.env`. Путь к файлу `.env` определяется как директория, на один уровень выше текущего файла.
2.  **Атрибуты**: Класс содержит атрибуты для хранения различных параметров конфигурации, таких как токен бота, идентификаторы администраторов, токен провайдера, URL сайта, параметры базы данных и учетные данные для MRH (предположительно, платежной системы).
3.  **Метод `get_webhook_url`**: Формирует URL для вебхука на основе URL сайта и токена бота.
4.  **Метод `get_provider_hook_url`**: Формирует URL для вебхука провайдера (robokassa) на основе URL сайта.

**Параметры**:

*   `BOT_TOKEN` (str): Токен Telegram-бота.
*   `ADMIN_IDS` (List[int]): Список идентификаторов администраторов бота.
*   `PROVIDER_TOKEN` (str): Токен провайдера платежей.
*   `FORMAT_LOG` (str, optional): Формат записи логов. По умолчанию: `"{time:YYYY-MM-DD at HH:mm:ss} | {level} | {message}"`.
*   `LOG_ROTATION` (str, optional): Максимальный размер файла лога перед ротацией. По умолчанию: `"10 MB"`.
*   `DB_URL` (str, optional): URL базы данных. По умолчанию: `'sqlite+aiosqlite:///data/db.sqlite3'`.
*   `SITE_URL` (str): URL сайта.
*   `SITE_HOST` (str): Хост сайта.
*   `SITE_PORT` (int): Порт сайта.
*   `MRH_LOGIN` (str): Логин для MRH.
*   `MRH_PASS_1` (str): Первый пароль для MRH.
*   `MRH_PASS_2` (str): Второй пароль для MRH.
*   `IN_TEST` (int): Флаг, указывающий на тестовую среду.

**Методы**:

*   `get_webhook_url`
    ```python
    def get_webhook_url(self) -> str:
        """Динамически формирует путь для вебхука на основе токена и URL сайта."""
        ...
    ```

    **Назначение**: Формирует URL для вебхука на основе URL сайта и токена бота.

    **Параметры**:
    -   Отсутствуют.

    **Возвращает**:
    -   `str`: URL для вебхука.

    **Как работает функция**:
    1.  Функция `get_webhook_url` формирует URL для вебхука, объединяя `SITE_URL` и `BOT_TOKEN` с помощью f-строки.
    2.  Свойство `SITE_URL` содержит базовый URL сайта.
    3.  Свойство `BOT_TOKEN` содержит токен Telegram-бота.
    4.  URL вебхука используется для настройки связи между Telegram-ботом и сервером, чтобы бот мог получать обновления.

    **Примеры**:

    ```python
    settings = Settings()
    webhook_url = settings.get_webhook_url
    print(webhook_url)  # Вывод: https://example.com/<токен_бота>
    ```

*   `get_provider_hook_url`
    ```python
    def get_provider_hook_url(self) -> str:
        """Динамически формирует путь для вебхука на основе токена и URL сайта."""
        ...
    ```

    **Назначение**: Формирует URL для вебхука провайдера (robokassa) на основе URL сайта.

    **Параметры**:
    -   Отсутствуют.

    **Возвращает**:
    -   `str`: URL для вебхука провайдера.

    **Как работает функция**:

    1.  Функция `get_provider_hook_url` формирует URL для вебхука провайдера, объединяя `SITE_URL` и строку `/robokassa` с помощью f-строки.
    2.  Свойство `SITE_URL` содержит базовый URL сайта.
    3.  URL вебхука провайдера используется для настройки связи между платежной системой (в данном случае, robokassa) и сервером, чтобы сервер мог получать уведомления об оплатах.

    **Примеры**:

    ```python
    settings = Settings()
    provider_webhook_url = settings.get_provider_hook_url
    print(provider_webhook_url)  # Вывод: https://example.com/robokassa
    ```

## Функции

### `settings`

**Описание**: Инициализирует экземпляр класса `Settings` для загрузки переменных среды.

**Как работает функция**:

1.  Создается экземпляр класса `Settings`.
2.  При создании экземпляра, `pydantic_settings` автоматически загружает переменные среды из файла `.env` и устанавливает значения соответствующих атрибутов класса.
3.  Теперь можно получить доступ к параметрам конфигурации через атрибуты объекта `settings`.

### `bot`

**Описание**: Инициализирует объект `Bot` из библиотеки `aiogram` с использованием токена, полученного из настроек, и устанавливает режим разбора по умолчанию в HTML.

**Как работает функция**:

1.  Инициализируется объект `Bot` с использованием токена, хранящегося в `settings.BOT_TOKEN`.
2.  Устанавливается режим разбора по умолчанию в HTML с помощью `DefaultBotProperties(parse_mode=ParseMode.HTML)`. Это означает, что все сообщения, отправляемые ботом, будут интерпретироваться как HTML.

### `dp`

**Описание**: Инициализирует диспетчер `Dispatcher` из библиотеки `aiogram` с использованием `MemoryStorage` для хранения состояний.

**Как работает функция**:

1.  Создается экземпляр `MemoryStorage`, который будет использоваться для хранения состояний бота в памяти.
2.  Инициализируется объект `Dispatcher` с использованием `MemoryStorage`. `Dispatcher` отвечает за обработку входящих обновлений от Telegram.

### `admins`

**Описание**: Получает список идентификаторов администраторов из настроек.

**Как работает функция**:

1.  Получает список `ADMIN_IDS` из объекта `settings`. Этот список содержит идентификаторы пользователей, которые имеют права администратора в боте.

### `log_file_path`

**Описание**: Формирует путь к файлу лога на основе расположения текущего файла.

**Как работает функция**:

1.  Использует `os.path.dirname(os.path.abspath(__file__))` для получения абсолютного пути к директории, в которой находится текущий файл.
2.  Объединяет полученный путь с именем файла `"log.txt"` с помощью `os.path.join`.

### `logger.add`

**Описание**: Настраивает логирование с использованием библиотеки `loguru`.

**Как работает функция**:

1.  Вызывается метод `logger.add` для добавления нового обработчика логов.
2.  В качестве параметров передаются:
    *   `log_file_path`: Путь к файлу лога.
    *   `format=settings.FORMAT_LOG`: Формат записи логов, определенный в настройках.
    *   `level="INFO"`: Уровень логирования. Будут записываться все сообщения с уровнем INFO и выше (WARNING, ERROR, CRITICAL).
    *   `rotation=settings.LOG_ROTATION`: Параметр ротации логов. Когда размер файла достигнет указанного значения, файл будет автоматически переименован и начнется запись в новый файл.

### `database_url`

**Описание**: Присваивает URL базы данных из настроек переменной `database_url`.

**Как работает функция**:

1.  Получает значение `DB_URL` из объекта `settings`. Это значение содержит URL для подключения к базе данных.
2.  Присваивает полученное значение переменной `database_url`.