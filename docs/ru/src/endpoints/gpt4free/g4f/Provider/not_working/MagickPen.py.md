# Модуль `MagickPen`

## Обзор

Модуль `MagickPen` предоставляет асинхронный интерфейс для взаимодействия с провайдером `MagickPen`, использующим API `magickpen.com`. Он поддерживает потоковую передачу данных, системные сообщения и историю сообщений.

## Подробнее

Этот модуль предназначен для асинхронного взаимодействия с сервисом `magickpen.com`. Он включает в себя методы для получения учетных данных API, формирования запросов и обработки ответов в асинхронном режиме. Модуль использует `aiohttp` для выполнения асинхронных HTTP-запросов.

## Классы

### `MagickPen`

**Описание**: Класс `MagickPen` является асинхронным генератором и предоставляет методы для взаимодействия с API `magickpen.com`.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL сервиса `magickpen.com`.
- `api_endpoint` (str): URL API endpoint для отправки запросов.
- `working` (bool): Указывает, работает ли провайдер в данный момент (в данном случае `False`).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных (`True`).
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения (`True`).
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений (`True`).
- `default_model` (str): Модель, используемая по умолчанию (`'gpt-4o-mini'`).
- `models` (list): Список поддерживаемых моделей (`['gpt-4o-mini']`).

**Методы**:
- `fetch_api_credentials()`: Асинхронный метод для получения учетных данных API.
- `create_async_generator()`: Асинхронный метод для создания асинхронного генератора для взаимодействия с API.

## Функции

### `fetch_api_credentials`

```python
    @classmethod
    async def fetch_api_credentials(cls) -> tuple:
        """Получает учетные данные API, необходимые для взаимодействия с сервисом MagickPen.

        Args:
            cls (MagickPen): Ссылка на класс `MagickPen`.

        Returns:
            tuple: Кортеж, содержащий `X_API_SECRET` (str), `signature` (str), `timestamp` (str), `nonce` (str) и `secret` (str).

        Raises:
            Exception: Если не удается извлечь все необходимые данные из JavaScript-файла.
        """
```

**Назначение**: Извлекает и возвращает учетные данные API, необходимые для аутентификации и авторизации запросов к `magickpen.com`.

**Параметры**:
- `cls` (MagickPen): Ссылка на класс `MagickPen`.

**Возвращает**:
- `tuple`: Кортеж, содержащий:
    - `X_API_SECRET` (str): Секретный ключ API.
    - `signature` (str): Подпись запроса.
    - `timestamp` (str): Временная метка запроса.
    - `nonce` (str): Случайная строка, используемая для предотвращения повторных атак.
    - `secret` (str): Дополнительный секретный ключ.

**Вызывает исключения**:
- `Exception`: Если не удается извлечь все необходимые данные из JavaScript-файла.

**Как работает функция**:

1. **Запрос JavaScript-файла**: Функция выполняет GET-запрос к JavaScript-файлу (`https://magickpen.com/_nuxt/bf709a9ce19f14e18116.js`) для извлечения учетных данных API.
2. **Извлечение `X_API_SECRET`**: Извлекает значение `X-API-Secret` из текста ответа, используя регулярное выражение.
3. **Генерация временной метки и `nonce`**: Генерирует текущую временную метку в миллисекундах и случайную строку (`nonce`).
4. **Создание подписи**: Формирует строку для подписи, объединяет `TGDBU9zCgM`, временную метку и `nonce`, сортирует их и вычисляет MD5-хеш полученной строки.
5. **Извлечение `secret`**: Извлекает значение `secret` из текста ответа, используя регулярное выражение.
6. **Проверка наличия данных**: Проверяет, что все необходимые данные (`X_API_SECRET`, `timestamp`, `nonce`, `secret`) были успешно извлечены.
7. **Возврат учетных данных**: Возвращает кортеж, содержащий извлеченные и сгенерированные учетные данные.

**ASCII flowchart**:

```
A: Запрос JavaScript-файла
|
B: Извлечение X_API_SECRET
|
C: Генерация timestamp и nonce
|
D: Создание signature
|
E: Извлечение secret
|
F: Проверка наличия данных
|
G: Возврат учетных данных
```

**Примеры**:

```python
# Пример вызова функции (предположительно внутри класса MagickPen)
X_API_SECRET, signature, timestamp, nonce, secret = await MagickPen.fetch_api_credentials()
print(f"X_API_SECRET: {X_API_SECRET}")
print(f"signature: {signature}")
print(f"timestamp: {timestamp}")
print(f"nonce: {nonce}")
print(f"secret: {secret}")
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для взаимодействия с API MagickPen.

        Args:
            cls (MagickPen): Ссылка на класс `MagickPen`.
            model (str): Модель для использования.
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий данные из API.
        """
```

**Назначение**: Создает асинхронный генератор, который отправляет запросы к API `magickpen.com` и возвращает результаты в виде потока данных.

**Параметры**:
- `cls` (MagickPen): Ссылка на класс `MagickPen`.
- `model` (str): Модель для использования.
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий данные из API.

**Как работает функция**:

1. **Получение модели**: Извлекает модель для использования, вызывая `cls.get_model(model)`.
2. **Получение учетных данных**: Получает учетные данные API, вызывая `cls.fetch_api_credentials()`.
3. **Формирование заголовков**: Создает заголовки запроса, включая `nonce`, `secret`, `signature`, `timestamp` и `X-API-Secret`.
4. **Формирование тела запроса**: Формирует тело запроса в формате JSON, включая `query` (сформированный из сообщений) и `turnstileResponse`.
5. **Отправка запроса и обработка ответа**: Отправляет POST-запрос к API endpoint (`cls.api_endpoint`) с использованием `aiohttp.ClientSession`.
6. **Генерация данных**: Асинхронно итерируется по содержимому ответа и генерирует декодированные фрагменты данных.

**ASCII flowchart**:

```
A: Получение модели
|
B: Получение учетных данных
|
C: Формирование заголовков
|
D: Формирование тела запроса
|
E: Отправка запроса и обработка ответа
|
F: Генерация данных
```

**Примеры**:

```python
# Пример вызова функции (предположительно внутри класса MagickPen)
messages = [{"role": "user", "content": "Hello, how are you?"}]
async_generator = await MagickPen.create_async_generator(model="gpt-4o-mini", messages=messages)

async for chunk in async_generator:
    print(chunk, end="")