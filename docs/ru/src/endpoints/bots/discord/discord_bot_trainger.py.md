# Модуль для интеграции и обучения Discord-ботов

## Обзор

Модуль `discord_bot_trainger.py` предназначен для создания и управления Discord-ботами, включая их обучение и взаимодействие с пользователями. Он предоставляет набор команд для подключения к голосовым каналам, отправки текстовых сообщений, обучения моделей и обработки голосовых сообщений.

## Подробней

Этот модуль является частью проекта `hypotez` и обеспечивает интеграцию с Discord для создания интерактивных ботов. Он использует библиотеки `discord.py` для взаимодействия с Discord API, `speech_recognition` для распознавания речи, `gTTS` для синтеза речи и другие вспомогательные библиотеки. Модуль позволяет обучать ботов на основе предоставленных данных, тестировать модели и архивировать файлы.

## Классы

В данном модуле классы отсутствуют.

## Функции

### `on_ready`

```python
@bot.event
async def on_ready():
    """Called when the bot is ready."""
    ...
```

**Назначение**: Вызывается, когда бот готов к работе.

**Как работает функция**:
1. Регистрирует информацию о том, что бот успешно подключился и готов к работе, используя модуль `logger`.

### `hi`

```python
@bot.command(name='hi')
async def hi(ctx):
    """Welcome message."""
    ...
```

**Назначение**: Отправляет приветственное сообщение в канал, из которого была вызвана команда.

**Как работает функция**:
1. Логирует вызов команды `hi` с использованием модуля `logger`.
2. Отправляет сообщение "HI!" в канал, из которого была вызвана команда.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды, содержащий информацию о канале, пользователе и т.д.

### `join`

```python
@bot.command(name='join')
async def join(ctx):
    """Connect the bot to the voice channel."""
    ...
```

**Назначение**: Подключает бота к голосовому каналу, в котором находится пользователь, вызвавший команду.

**Как работает функция**:
1. Логирует вызов команды `join` с использованием модуля `logger`.
2. Проверяет, находится ли автор команды в голосовом канале.
3. Если автор находится в голосовом канале, бот подключается к этому каналу и отправляет подтверждающее сообщение.
4. Если автор не находится в голосовом канале, бот отправляет сообщение об ошибке.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды.

### `leave`

```python
@bot.command(name='leave')
async def leave(ctx):
    """Disconnect the bot from the voice channel."""
    ...
```

**Назначение**: Отключает бота от текущего голосового канала.

**Как работает функция**:
1. Логирует вызов команды `leave` с использованием модуля `logger`.
2. Проверяет, подключен ли бот к голосовому каналу.
3. Если бот подключен к голосовому каналу, он отключается и отправляет подтверждающее сообщение.
4. Если бот не подключен к голосовому каналу, он отправляет сообщение об ошибке.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды.

### `train`

```python
@bot.command(name='train')
async def train(ctx, data: str = None, data_dir: str = None, positive: bool = True, attachment: discord.Attachment = None):
    """Train the model with the provided data."""
    ...
```

**Назначение**: Запускает обучение модели с использованием предоставленных данных.

**Как работает функция**:
1. Логирует вызов команды `train` с использованием модуля `logger`.
2. Проверяет, предоставлен ли файл в качестве вложения. Если да, сохраняет файл во временную директорию и устанавливает путь к файлу в переменную `data`.
3. Вызывает метод `train` объекта `model` с предоставленными данными и параметрами.
4. Если обучение успешно запущено, отправляет сообщение с идентификатором задачи.
5. В противном случае отправляет сообщение об ошибке.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды.
- `data` (str, optional): Путь к файлу с данными для обучения. По умолчанию `None`.
- `data_dir` (str, optional): Путь к директории с данными для обучения. По умолчанию `None`.
- `positive` (bool, optional): Указывает, являются ли данные положительными или отрицательными. По умолчанию `True`.
- `attachment` (discord.Attachment, optional): Файл с данными для обучения, предоставленный в качестве вложения. По умолчанию `None`.

### `test`

```python
@bot.command(name='test')
async def test(ctx, test_data: str):
    """Test the model with the provided test data."""
    ...
```

**Назначение**: Тестирует модель с использованием предоставленных тестовых данных в формате JSON.

**Как работает функция**:
1. Логирует вызов команды `test` с использованием модуля `logger`.
2. Пытается загрузить тестовые данные из JSON-строки.
3. Вызывает метод `predict` объекта `model` с тестовыми данными.
4. Если получены предсказания, отправляет сообщение с результатами и обрабатывает ошибки.
5. В противном случае отправляет сообщение об ошибке.
6. Если тестовые данные имеют неверный формат JSON, отправляет сообщение об ошибке.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды.
- `test_data` (str): Тестовые данные в формате JSON.

### `archive`

```python
@bot.command(name='archive')
async def archive(ctx, directory: str):
    """Archive files in the specified directory."""
    ...
```

**Назначение**: Архивирует файлы в указанной директории.

**Как работает функция**:
1. Логирует вызов команды `archive` с использованием модуля `logger`.
2. Вызывает метод `archive_files` объекта `model` с указанной директорией.
3. Отправляет сообщение об успешном архивировании файлов или сообщение об ошибке, если произошла ошибка.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды.
- `directory` (str): Путь к директории для архивирования.

### `select_dataset`

```python
@bot.command(name='select_dataset')
async def select_dataset(ctx, path_to_dir_positive: str, positive: bool = True):
    """Select a dataset for training the model."""
    ...
```

**Назначение**: Выбирает набор данных для обучения модели и архивирует его.

**Как работает функция**:
1. Логирует вызов команды `select_dataset` с использованием модуля `logger`.
2. Вызывает метод `select_dataset_and_archive` объекта `model` с указанным путем к директории и параметром `positive`.
3. Если набор данных успешно выбран и архивирован, отправляет сообщение с информацией о наборе данных.
4. В противном случае отправляет сообщение об ошибке.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды.
- `path_to_dir_positive` (str): Путь к директории с положительными данными для обучения.
- `positive` (bool, optional): Указывает, являются ли данные положительными или отрицательными. По умолчанию `True`.

### `instruction`

```python
@bot.command(name='instruction')
async def instruction(ctx):
    """Display the instruction message from an external file."""
    ...
```

**Назначение**: Отображает сообщение с инструкциями из внешнего файла.

**Как работает функция**:
1. Логирует вызов команды `instruction` с использованием модуля `logger`.
2. Пытается прочитать содержимое файла с инструкциями.
3. Если файл существует, отправляет его содержимое в канал.
4. В противном случае отправляет сообщение об ошибке.
5. Если возникает ошибка при чтении файла, отправляет сообщение об ошибке.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды.

### `correct`

```python
@bot.command(name='correct')
async def correct(ctx, message_id: int, *, correction: str):
    """Correct a previous response by providing the message ID and the correction."""
    ...
```

**Назначение**: Корректирует предыдущий ответ бота, сохраняя информацию об исправлении.

**Как работает функция**:
1. Логирует вызов команды `correct` с использованием модуля `logger`.
2. Пытается получить сообщение по указанному идентификатору.
3. Если сообщение найдено, логирует и сохраняет исправление.
4. В противном случае отправляет сообщение об ошибке.
5. Если возникает ошибка, отправляет сообщение об ошибке.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды.
- `message_id` (int): Идентификатор сообщения для исправления.
- `correction` (str): Текст исправления.

### `store_correction`

```python
def store_correction(original_text: str, correction: str):
    """Store the correction for future reference or retraining."""
    ...
```

**Назначение**: Сохраняет исправление для будущего использования или переобучения модели.

**Как работает функция**:
1. Логирует вызов функции `store_correction` с использованием модуля `logger`.
2. Открывает файл `corrections_log.txt` в режиме добавления.
3. Записывает в файл оригинальный текст и текст исправления.

**Параметры**:
- `original_text` (str): Оригинальный текст сообщения.
- `correction` (str): Текст исправления.

### `feedback`

```python
@bot.command(name='feedback')
async def feedback(ctx, *, feedback_text: str):
    """Submit feedback about the model's response."""
    ...
```

**Назначение**: Сохраняет текст отзыва о работе модели.

**Как работает функция**:
1. Логирует вызов команды `feedback` с использованием модуля `logger`.
2. Вызывает функцию `store_correction` для сохранения отзыва.
3. Отправляет сообщение с благодарностью за отзыв.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды.
- `feedback_text` (str): Текст отзыва.

### `getfile`

```python
@bot.command(name='getfile')
async def getfile(ctx, file_path: str):
    """Attach a file from the given path."""
    ...
```

**Назначение**: Прикрепляет файл из указанного пути к сообщению.

**Как работает функция**:
1. Логирует вызов команды `getfile` с использованием модуля `logger`.
2. Проверяет, существует ли файл по указанному пути.
3. Если файл существует, прикрепляет его к сообщению и отправляет сообщение.
4. В противном случае отправляет сообщение об ошибке.

**Параметры**:
- `ctx` (discord.ext.commands.Context): Контекст команды.
- `file_path` (str): Путь к файлу для прикрепления.

### `text_to_speech_and_play`

```python
async def text_to_speech_and_play(text, channel):
    """Convert text to speech and play it in a voice channel."""
    ...
```

**Назначение**: Преобразует текст в речь и воспроизводит его в голосовом канале.

**Как работает функция**:
1. Инициализирует `gTTS` для преобразования текста в речь на русском языке.
2. Сохраняет сгенерированный аудиофайл во временную директорию.
3. Подключается к голосовому каналу (если еще не подключен).
4. Воспроизводит аудиофайл в голосовом канале.
5. Отключается от голосового канала после завершения воспроизведения.
6. Логирует завершение воспроизведения.

**Параметры**:
- `text` (str): Текст для преобразования в речь.
- `channel` (discord.VoiceChannel): Голосовой канал для воспроизведения речи.

### `on_message`

```python
@bot.event
async def on_message(message):
    """Handle incoming messages and respond to voice commands."""
    ...
```

**Назначение**: Обрабатывает входящие сообщения и отвечает на голосовые команды.

**Как работает функция**:
1. Игнорирует сообщения от самого бота.
2. Обрабатывает команды, начинающиеся с префикса `!`.
3. Если есть вложения, проверяет, является ли вложение аудиофайлом. Если да, распознает речь в аудиофайле и отправляет распознанный текст модели для получения ответа.
4. Если вложений нет, отправляет текст сообщения модели для получения ответа.
5. Если пользователь находится в голосовом канале, воспроизводит ответ модели в голосовом канале.
6. В противном случае отправляет ответ модели в текстовый канал.

**Параметры**:
- `message` (discord.Message): Входящее сообщение.