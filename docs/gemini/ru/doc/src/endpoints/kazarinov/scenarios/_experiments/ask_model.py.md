# Модуль для проверки валидности ответов от модели

## Обзор

Модуль предназначен для проверки валидности ответов, полученных от AI-моделей, в частности Google Gemini. Он включает в себя функции для загрузки инструкций, подготовки запросов на разных языках (русский и иврит), отправки запросов к модели и обработки полученных ответов. Модуль также содержит функциональность для логирования ошибок и сохранения результатов в формате JSON.

## Подробней

Модуль является частью проекта `hypotez` и используется для экспериментов с AI-моделями в контексте обработки данных о продуктах. Он загружает инструкции для модели на разных языках, формирует запросы на основе этих инструкций и списка продуктов, а затем отправляет запросы к модели Google Gemini. Полученные ответы обрабатываются и сохраняются в файлы JSON. Важной частью является обработка ошибок и повторные попытки при отсутствии ответа от модели или при ошибках парсинга.

## Функции

### `model_ask`

```python
def model_ask(lang: str, attempts: int = 3) -> dict:
    """
    Запрашивает ответ от модели Google Gemini на указанном языке.

    Args:
        lang (str): Язык запроса ('ru' для русского, 'he' для иврита).
        attempts (int, optional): Количество попыток запроса в случае неудачи. По умолчанию 3.

    Returns:
        dict: Словарь с ответом от модели в формате JSON. Возвращает пустой словарь в случае неудачи.
    """
```

**Как работает функция**:

1.  **Инициализация**: Функция принимает язык запроса `lang` и количество попыток `attempts`.
2.  **Выбор запроса**: В зависимости от языка (`lang`) выбирается соответствующий запрос (`q_ru` для русского, `q_he` для иврита).
3.  **Запрос к модели**: Отправляет запрос к модели Google Gemini с использованием метода `model.ask`.
4.  **Обработка ответа**:

    *   Если ответ от модели отсутствует, регистрируется ошибка с помощью `logger.error` и возвращается пустой словарь.
    *   Если ответ получен, пытается распарсить его как JSON с помощью `j_loads`.
    *   Если парсинг не удался, регистрируется ошибка, и, если количество попыток `attempts` больше 1, функция рекурсивно вызывает саму себя с уменьшенным количеством попыток.
    *   Если парсинг успешен, возвращается словарь с данными.

5.  **Возврат результата**: Возвращает словарь с ответом от модели или пустой словарь в случае ошибки.

**ASCII Flowchart**:

```
     Начало
     ↓
     Выбор языка (lang)
     ↓
     Запрос к модели (model.ask)
     ↓
     Есть ответ?
     ├── Нет ──→ Лог ошибки → Возврат {}
     ↓   Да
     Парсинг JSON (j_loads)
     ↓
     Успешно?
     ├── Нет ──→ Лог ошибки → attempts > 1? 
     │            └── Да ──→ Рекурсивный вызов model_ask
     ↓   Да
     Возврат словаря с данными
     ↓
     Конец
```

**Примеры**:

```python
# Пример вызова функции для русского языка
response_ru = model_ask(lang='ru')
print(response_ru)

# Пример вызова функции для иврита с одной попыткой
response_he = model_ask(lang='he', attempts=1)
print(response_he)
```