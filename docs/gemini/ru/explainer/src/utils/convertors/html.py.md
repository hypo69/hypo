## hypotez/src/utils/convertors/html.py

### <алгоритм>

1.  **`html2escape(input_str: str) -> str`**:
    *   **Вход**: HTML строка (`input_str`).
    *   **Действие**: Вызывает метод `StringFormatter.escape_html_tags(input_str)` для преобразования HTML-тегов в escape-последовательности.
    *   **Выход**: Строка с HTML-тегами, замененными на escape-последовательности.
    *   **Пример**:
        *   Вход: `<p>Hello, world!</p>`
        *   Выход: `&lt;p&gt;Hello, world!&lt;/p&gt;`

2.  **`escape2html(input_str: str) -> str`**:
    *   **Вход**: Строка с escape-последовательностями (`input_str`).
    *   **Действие**: Вызывает метод `StringFormatter.unescape_html_tags(input_str)` для преобразования escape-последовательностей обратно в HTML-теги.
    *   **Выход**: Строка с HTML-тегами.
    *   **Пример**:
        *   Вход: `&lt;p&gt;Hello, world!&lt;/p&gt;`
        *   Выход: `<p>Hello, world!</p>`

3.  **`html2dict(html_str: str) -> Dict[str, str]`**:
    *   **Вход**: HTML строка (`html_str`).
    *   **Действие**: Создает экземпляр вложенного класса `HTMLToDictParser` (наследуется от `HTMLParser`).
        *   `HTMLToDictParser` парсит HTML:
            *   `handle_starttag`: сохраняет текущий открывающийся тег (`tag`).
            *   `handle_endtag`: обнуляет текущий открытый тег (`current_tag`).
            *   `handle_data`: если есть открытый тег, то сохраняет текст тега в словарь.
    *   **Выход**: Словарь, где ключи — это HTML-теги, а значения — их содержимое.
    *   **Пример**:
        *   Вход: `<p>Hello</p><a href='link'>World</a>`
        *   Выход: `{'p': 'Hello', 'a': 'World'}`

4.  **`html2ns(html_str: str) -> SimpleNamespace`**:
    *   **Вход**: HTML строка (`html_str`).
    *   **Действие**:
        *   Вызывает `html2dict(html_str)`, чтобы преобразовать HTML в словарь.
        *   Создает объект `SimpleNamespace` из полученного словаря, где ключи словаря становятся атрибутами объекта.
    *   **Выход**: `SimpleNamespace` объект. Атрибутами обьекта являются HTML-теги, а значениями - содержимое тегов.
    *   **Пример**:
        *   Вход: `<p>Hello</p><a href='link'>World</a>`
        *   Выход: `result.p` -> 'Hello', `result.a` -> 'World'

5.  **`html2pdf(html_str: str, pdf_file: str | Path) -> bool | None`**:
    *   **Вход**: HTML строка (`html_str`) и путь к PDF файлу (`pdf_file`).
    *   **Действие**:
        *   Использует библиотеку `weasyprint` для преобразования HTML в PDF.
        *   Возвращает `True` при успешном создании PDF или `None` в случае ошибки.
    *   **Выход**: `True` или `None`.
    *   **Пример**:
        *   Вход: `html_str`: `<p>Hello</p>`, `pdf_file`: `output.pdf`
        *   Выход: `True` или `None` (в случае ошибки).

### <mermaid>

```mermaid
graph LR
    A[input_str: str] --> B(html2escape);
    B --> C[escaped_str: str];
    C --> D(escape2html);
    D --> E[html_str: str];
    F[html_str: str] --> G(html2dict);
    G --> H[html_dict: Dict[str, str]];
    H --> I(SimpleNamespace);
    I --> J[html_ns: SimpleNamespace];
    K[html_str: str] --> L(html2pdf);
    M[pdf_file: str | Path] --> L;
    L --> N[bool | None];
    
    classDef function fill:#f9f,stroke:#333,stroke-width:2px;
    class B,D,G,I,L function;

     
```

**Объяснение зависимостей `mermaid`:**

*   **`input_str`** (string): Строка HTML, которая является входными данными для функций `html2escape` и `escape2html`.
*   **`escaped_str`** (string): Строка с HTML, преобразованная в escape-последовательности, выход функции `html2escape`.
*   **`html_str`** (string): Строка HTML, которая является выходными данными функции `escape2html`.
*   **`html_str`** (string): Строка HTML, которая является входными данными для функций `html2dict` и `html2pdf`.
*    **`html_dict`** (Dict): Словарь, полученный после преобразования HTML, выход функции `html2dict`.
*   **`html_ns`** (SimpleNamespace): Объект SimpleNamespace, полученный из словаря HTML, выход функции `html2ns`.
*   **`pdf_file`** (str | Path): Путь к PDF-файлу, который используется в функции `html2pdf`.
*   **`bool | None`**: Результат работы функции `html2pdf`, который является `True` при успехе, или `None` в случае ошибки.

### <объяснение>

**Импорты:**

*   `re`: Модуль для работы с регулярными выражениями (не используется в текущей версии `html2pdf`).
*   `typing.Dict`: Используется для аннотации типов (указания, что функция возвращает словарь).
*   `pathlib.Path`: Используется для работы с путями к файлам, позволяет оперировать файлами как объектами (не используется в текущем коде).
*   `venv.logger`: Логгер для отладки (используется в коде, но не в текущем коде).
*   `src.logger.logger`: Кастомный логгер для приложения (используется для обработки исключений при импорте `weasyprint`).
*   `types.SimpleNamespace`: Используется для создания объектов, доступ к атрибутам которых осуществляется через точку.
*   `html.parser.HTMLParser`: Класс для разбора HTML.
*   `xhtml2pdf.pisa`: Библиотека для преобразования HTML в PDF (не используется в текущем коде).
*   `weasyprint.HTML`: Библиотека для преобразования HTML в PDF.

**Переменные:**

*   `MODE = 'dev'`: Режим работы (не используется в текущем коде).

**Функции:**

*   **`html2escape(input_str: str) -> str`**:
    *   **Аргументы**:
        *   `input_str` (str): Строка HTML для конвертации.
    *   **Возвращает**: Строку, в которой HTML-теги преобразованы в escape-последовательности.
    *   **Назначение**: Преобразует HTML в текст, безопасный для отображения в текстовых представлениях или XML.
    *   **Пример**:  `html2escape("<p>Text</p>")` вернет `&lt;p&gt;Text&lt;/p&gt;`.

*   **`escape2html(input_str: str) -> str`**:
    *   **Аргументы**:
        *   `input_str` (str): Строка с escape-последовательностями для конвертации.
    *   **Возвращает**: Строку, в которой escape-последовательности преобразованы обратно в HTML-теги.
    *   **Назначение**: Преобразует escape-последовательности обратно в HTML.
    *   **Пример**: `escape2html("&lt;p&gt;Text&lt;/p&gt;")` вернет `<p>Text</p>`.

*   **`html2dict(html_str: str) -> Dict[str, str]`**:
    *   **Аргументы**:
        *   `html_str` (str): Строка HTML для конвертации.
    *   **Возвращает**: Словарь, в котором ключи - это HTML-теги, а значения - текст внутри них.
    *   **Назначение**: Преобразует HTML в словарь для дальнейшей обработки.
    *   **Пример**: `html2dict("<p>Hello</p><a>World</a>")` вернет `{'p': 'Hello', 'a': 'World'}`.
    *   **Вложенный класс `HTMLToDictParser`**:
        *   **Роль**: Кастомный класс для разбора HTML.
        *   **Атрибуты**: `result` (словарь), `current_tag` (текущий открытый тег).
        *   **Методы**: `handle_starttag`, `handle_endtag`, `handle_data`.

*   **`html2ns(html_str: str) -> SimpleNamespace`**:
    *   **Аргументы**:
        *   `html_str` (str): Строка HTML для конвертации.
    *   **Возвращает**: `SimpleNamespace`, в котором HTML-теги становятся атрибутами, а их содержание значениями.
    *   **Назначение**: Преобразует HTML в `SimpleNamespace` для доступа к тегам как к атрибутам.
    *   **Пример**: `html2ns("<p>Hello</p><a>World</a>")` вернет объект, где `result.p` будет `Hello`, а `result.a` будет `World`.

*   **`html2pdf(html_str: str, pdf_file: str | Path) -> bool | None`**:
    *   **Аргументы**:
        *   `html_str` (str): Строка HTML для конвертации.
        *   `pdf_file` (str | Path): Путь к PDF файлу.
    *   **Возвращает**: `True`, если PDF был успешно создан, `None` в противном случае.
    *   **Назначение**: Преобразует HTML в PDF файл.
    *   **Использование `weasyprint`**: используется для преобразования HTML в PDF. Обрабатывает ошибки при преобразовании и выводит сообщение в консоль.

**Потенциальные ошибки и области для улучшения:**

*   **Отсутствует обработка ошибок**:
    *   В `html2escape` и `escape2html` используется `StringFormatter`, но сам класс не представлен, соответственно не ясны механизмы обработки ошибок.
    *   При импорте `weasyprint` есть обработка исключения, но в `html2pdf` обрабатывается только общее исключение, нужно уточнить.
*   **`html2pdf`**:
    *   В версии с `xhtml2pdf` был метод `preprocess_css` для удаления неподдерживаемых псевдоклассов, но он не реализован в текущей версии. Это может привести к проблемам при конвертации CSS, а также к отсутсвию гибкости.
*   **Внешние зависимости**:
    *   Зависимость от `StringFormatter` не показана, что делает код неполным.
*  **Логирование**:
    *   Используется `print` для ошибок, что не является хорошей практикой. Лучше использовать логгер.
*   **Недостаточно комментариев**:
    *   В некоторых функциях отсутствуют комментарии, уточняющие определенные шаги.
*  **Неоднозначность импортов**:
    *   Импорты `venv.logger` и `src.logger.logger` могут привести к путанице.

**Цепочка взаимосвязей с другими частями проекта:**

*   `src.utils.convertors.html` зависит от `src.logger.logger` для логирования ошибок.
*   Функции `html2escape` и `escape2html` предположительно зависят от класса `StringFormatter` (не показан в коде), который вероятно находится в другой части проекта.
*   `html2pdf` использует библиотеку `weasyprint` для генерации PDF.
*   Данный файл может использоваться в различных частях проекта, где требуется конвертация HTML в различные форматы (словарь, `SimpleNamespace`, PDF).