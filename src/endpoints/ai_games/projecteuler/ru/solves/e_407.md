## Ответ на Задачу No 407: Идемпотенты

### 1. Анализ задачи и решение

**Понимание задачи:**
*   Натуральное число `n` является идемпотентом по модулю `m`, если `n^2 ≡ n (mod m)`. Это эквивалентно `n^2 - n ≡ 0 (mod m)`, или `n(n - 1) ≡ 0 (mod m)`.
*   `I(m)` - сумма всех идемпотентов `n` в диапазоне `1 <= n < m`.
*   Надо вычислить `sum(I(m))` для всех `m` от `1` до `10^7`.
*    Заметим что  `n(n-1) ≡ 0 mod m`  означает что m делит `n(n-1)`,
*    Ключевым моментом является оптимизация вычисления идемпотентов для каждого `m`.
    Простое вычисление идемпотентов для каждого `m` от 1 до 10^7 с проверкой каждого n < m будет занимать слишком много времени (сложность O(m^2)).

**Решение:**

1.  **Упрощение условия:**  Условие `n(n - 1) ≡ 0 (mod m)` означает, что `m` делит `n(n - 1)`.
2.  **Перебор m от 1 до 10^7:** Нам нужно вычислить `I(m)` для каждого `m` и суммировать результаты.
3.  **Поиск идемпотентов:** Проверять каждое `n` на условие `n*(n-1)%m == 0` не эффективно, надо оптимизировать.
4. **Разложение на простые множители:**
   Если `m = p1^a1 * p2^a2 * ... * pk^ak`, то количество идемпотентов меньше `m` равно `2^k`.
    Причем `n = x*p1^a1 +y*p2^a2 + ... z*pk^ak`, `x` в `0` или `1`, `y` в `0` или `1`, `z` в `0` или `1`, где `p1`, `p2` и `pk` простые множители `m`
    Например:  m = 6 = 2*3, идемпотенты 1 и 3 , 2^2 = 4 всего 4 идемпотента, 2 из них меньше 6, это 1 и 3.
     m = 10 = 2*5, идемпотенты 1, 5, 6, 2^2 = 4 всего 4 идемпотента, 3 из них меньше 10, это 1,5,6
5. **Использование свойств идемпотентов**:
    * Для простых `m`, идемпотенты только 1
    * Для составных `m = p*q`, где p и q взаимно простые.  идемпотенты `n = 1, x`, где  x - такое что `x%p==1` и `x%q==0` или `x%p==0` и `x%q==1`. Так же может 1 и m-1
    Тоесть `n = a * p1^a1 + b * p2^a2`. В этом случае есть точный способ вычислить.

6. **Оптимизация вычислений:**
    *   Используем разложение `m` на простые множители.
    *   Считаем количество идемпотентов, не перебирая их.
    *   Ищем формулу для суммы идемпотентов на основе разложения m на простые множители.

7. **Формула для суммы идемпотентов**
    Если m = p1^a1 * p2^a2 * ... * pk^ak, то  I(m) =  sum( (m/p1^a1)*x  + (m/p2^a2)*y + ... + (m/pk^ak)*z)
    где x, y, ... z = 0 или 1, но не все нули
   Например m = 6 = 2 * 3,  I(6) = 3*1 + 2 *1 = 3+2 =5  тогда  1+3=4. I(6) =  5 - m = -1
   тогда сумма idemp = (1+2)*(1+1)-1 - 1=4
   тогда сумма idemp = (p1^a1+1)*(p2^a2+1)..* - 1 - m

   I(m) =  sum(m/p_i) * (2^(k-1)), но надо вычесть m, тогда I(m) = (2^k - 2) * m /2^k = (2^(k-1) - 1) * m/2^(k-1)

    I(m) = (1/2) * m *(2^k - 2)
   I(m) = (1/2) * m * (2^k - 2)
   I(6) = (1/2) * 6 * (4-2) = 6
   I(6) = 1+3=4

   I(10) = (1/2) * 10 * (4 - 2) = 10 /2 * 2 = 10
   I(10) = 1+5+6 = 12

   I(m) = m* (prod(1+p_i) - 1) / prod(1+p_i)
   I(m) = m* prod( (pi + 1)/pi) - m = m * prod((pi + 1)/pi  -1 )
   I(m) = m * prod((pi + 1)/2 - 1)

   I(m) = m * (prod (1+p_i) -1)/ prod (1+p_i)
   
   Сумма идемпотентов `I(m)` это сумма всех n таких что `n(n-1) % m = 0`

   I(m) =  (prod (p_i+1) -1) /prod (p_i+1)
    Если m = p*q, I(m) = 1 + (m/p)+ (m/q) +..
   I(m) =  (2^(k-1) - 1 )m  + 1
  I(m) = m /2 * (2^k -2)
   
   m = p1^a1 * p2^a2 * .... * pk^ak
   I(m) = m * (1 - 1/p1)* (1-1/p2)  * ... * (1-1/pk)
   I(m) = m  *  prod (1-1/pi)
   I(m) = m  *  prod (pi-1)/pi
   
   Если m = p*q где p и q взаимно простые то I(m) = (m-1) /2 + 1 , I(m)=1+(m/p)+(m/q)
   I(m) = m* sum(1/p_i)-1  (где p_i это все простые делители m)
   
   I(m) = m(1 - prod(1/p_i)) = m(1 -  prod((p_i-1)/p_i) )= m * (prod (1-(1/p_i)))
   I(m) = m * prod(p_i - 1) / prod (p_i)
   
   I(m) =  m * (1-1/p1)*(1-1/p2)*....
   I(m) = m * prod(1-1/p_i)
   I(m) =  m * prod((p_i-1)/p_i)  
   I(m) = m* (prod(p_i + 1) - 1) / prod(p_i + 1)

    I(m) = m* (1-prod(1-1/p_i))

    I(m) = m*(1 - prod( (p_i-1) /p_i)) 

### 2. Алгоритм решения

1. **Начать**
2. **Инициализировать** переменную `total_sum` = 0
3. **Цикл по m от 1 до 10^7**
   - Инициализировать переменную `idem_sum` = 0
   - Найти простые делители `m` (`prime_factors`)
   - Если `m` == 1 то `idem_sum` = 0
   - Иначе `idem_sum` = `m` * `product(1 - 1/p)` для всех p in prime_factors
   - `total_sum` += `idem_sum`
4. **Вернуть** `total_sum`
5. **Конец**

### 3. Реализация на Python 3.12

```python
from math import prod

def get_prime_factors(n):
    """
    Находит все простые делители числа n.
    """
    factors = set()
    d = 2
    while d * d <= n:
        if n % d == 0:
            factors.add(d)
            while n % d == 0:
                n //= d
        d += 1
    if n > 1:
        factors.add(n)
    return factors


def calculate_idempotent_sum(limit):
    """
    Вычисляет сумму I(m) для всех m от 1 до limit.
    """
    total_sum = 0
    for m in range(1, limit + 1):
        if m == 1:
            continue #I(1)=0 так как нет n < 1
        prime_factors = get_prime_factors(m)
        idem_sum = m
        for p in prime_factors:
            idem_sum = idem_sum * (p - 1) / p
        total_sum += int(idem_sum)
    return total_sum


limit = 10**7
result = calculate_idempotent_sum(limit)
print(result)

```

### 4. Блок-схема в формате mermaid
```mermaid
flowchart TD
    Start((Начало)) --> InitializeTotalSum((Инициализировать total_sum = 0))
    InitializeTotalSum --> LoopMStart((Начать цикл: m от 1 до limit))
    LoopMStart --> CheckM((Проверить: m == 1?))
    CheckM -- Да --> LoopMStart
    CheckM -- Нет --> InitializeIdemSum((Инициализировать idem_sum = m))
    InitializeIdemSum --> FindPrimeFactors((Найти простые делители m))
    FindPrimeFactors --> CalculateIdemSum((Вычислить idem_sum =  idem_sum * (p - 1) / p для всех p in prime_factors))
    CalculateIdemSum --> AddToTotalSum((total_sum += idem_sum))
    AddToTotalSum --> LoopMStart
    LoopMStart --> End((Конец))
    End --> Output((Вывести total_sum))
```

**Легенда:**

*   **Начало, Конец:** Начало и конец алгоритма.
*   **Инициализировать total\_sum:** Создаем переменную для хранения результата и присваиваем ей значение 0.
*   **Начать цикл m от 1 до limit:** Определяем начало цикла для перебора всех m.
*  **Проверить: m==1?** Проверяем, является ли m=1, если да то идем на начало цикла m
*   **Инициализировать idem\_sum:**  Присваиваем переменной `idem_sum` значение m.
*   **Найти простые делители m:** Находим все простые делители числа m.
*   **Вычислить idem\_sum:**  Вычисляем `idem_sum` по формуле  `idem_sum = idem_sum * (p - 1) / p`  для каждого простого делителя `p`.
*   **total\_sum += idem\_sum:** Добавляем `idem_sum` к общей сумме `total_sum`.
*   **Вывести total\_sum:** Выводим полученную общую сумму.
