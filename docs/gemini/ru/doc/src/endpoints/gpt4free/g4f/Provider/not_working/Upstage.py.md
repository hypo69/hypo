# Модуль `Upstage.py`

## Обзор

Модуль предоставляет асинхронный класс `Upstage`, который является провайдером для взаимодействия с API Upstage AI для генерации текста. Он использует `aiohttp` для асинхронных HTTP-запросов и предоставляет функциональность для выбора модели, форматирования запросов и обработки потоковых ответов.

## Подробней

Модуль предназначен для интеграции с другими частями проекта `hypotez`, которые требуют взаимодействия с моделью Upstage AI. Он позволяет отправлять запросы к API Upstage и получать потоковые ответы, что полезно для генерации текста в реальном времени.
В проекте `hypotez` данный модуль используется для реализации взаимодействия с AI-моделью `Upstage`.

## Классы

### `Upstage`

**Описание**: Класс `Upstage` является асинхронным провайдером для работы с API Upstage AI. Он наследует функциональность от `AsyncGeneratorProvider` и `ProviderModelMixin`.

**Наследует**:
- `AsyncGeneratorProvider`: Предоставляет базовую функциональность для асинхронных провайдеров, генерирующих данные.
- `ProviderModelMixin`: Предоставляет функциональность для управления моделями, поддерживаемыми провайдером.

**Атрибуты**:
- `url` (str): URL главной страницы Upstage AI.
- `api_endpoint` (str): URL API для отправки запросов на генерацию текста.
- `working` (bool): Указывает, работает ли провайдер в данный момент.
- `default_model` (str): Модель, используемая по умолчанию, если не указана другая.
- `models` (List[str]): Список поддерживаемых моделей.
- `model_aliases` (Dict[str, str]): Словарь псевдонимов моделей для упрощения использования.

**Методы**:
- `get_model(model: str) -> str`: Возвращает имя модели на основе предоставленного псевдонима или имени модели.
- `create_async_generator(model: str, messages: Messages, proxy: str = None, **kwargs) -> AsyncResult`: Создает асинхронный генератор для отправки запросов к API Upstage и получения потоковых ответов.

## Функции

### `get_model`

```python
    @classmethod
    def get_model(cls, model: str) -> str:
        """
        Возвращает имя модели на основе предоставленного псевдонима или имени модели.

        Args:
            model (str): Имя модели или псевдоним.

        Returns:
            str: Имя модели, если найдено, иначе имя модели по умолчанию.
        """
```

**Назначение**:
Функция `get_model` преобразует входное имя модели или псевдоним в фактическое имя модели, которое будет использоваться в API-запросах.

**Параметры**:
- `model` (str): Имя модели или псевдоним.

**Возвращает**:
- `str`: Имя модели, если найдено в списке поддерживаемых моделей или в словаре псевдонимов. Если модель не найдена, возвращается имя модели по умолчанию.

**Как работает функция**:

1. **Проверка наличия модели в списке поддерживаемых моделей**:
   - Проверяется, есть ли входное имя модели в списке `cls.models`.
   - Если модель найдена в списке, она возвращается.
2. **Проверка наличия модели в словаре псевдонимов**:
   - Если модель не найдена в списке, проверяется, есть ли она в словаре `cls.model_aliases`.
   - Если псевдоним модели найден в словаре, возвращается соответствующее ему имя модели.
3. **Возврат модели по умолчанию**:
   - Если модель не найдена ни в списке, ни в словаре, возвращается значение `cls.default_model`.

```
A: Проверка наличия модели в списке `cls.models`
|
B: Модель найдена в списке?
| Да
C: Возврат модели
| Нет
D: Проверка наличия модели в словаре `cls.model_aliases`
|
E: Псевдоним модели найден в словаре?
| Да
F: Возврат соответствующего имени модели
| Нет
G: Возврат модели по умолчанию `cls.default_model`
```

**Примеры**:

```python
# Пример 1: Модель напрямую указана в списке поддерживаемых моделей
model_name = Upstage.get_model('solar-pro')
print(model_name)  # Вывод: solar-pro

# Пример 2: Использование псевдонима модели
model_name = Upstage.get_model('solar-mini')
print(model_name)  # Вывод: upstage/solar-1-mini-chat

# Пример 3: Модель не найдена, возвращается модель по умолчанию
model_name = Upstage.get_model('unknown-model')
print(model_name)  # Вывод: solar-pro
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для отправки запросов к API Upstage и получения потоковых ответов.

        Args:
            model (str): Имя модели для использования.
            messages (Messages): Список сообщений для отправки в запросе.
            proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
            **kwargs: Дополнительные параметры для передачи в API.

        Returns:
            AsyncResult: Асинхронный генератор, выдающий части ответа от API.
        """
```

**Назначение**:
Функция `create_async_generator` создает асинхронный генератор, который отправляет запросы к API Upstage и возвращает потоковые ответы. Генератор позволяет обрабатывать большие объемы данных по частям, что снижает потребление памяти и улучшает производительность.

**Параметры**:
- `model` (str): Имя модели для использования.
- `messages` (Messages): Список сообщений для отправки в запросе.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры для передачи в API.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий части ответа от API.

**Как работает функция**:

1. **Получение имени модели**:
   - Вызывается метод `cls.get_model(model)` для получения имени модели на основе предоставленного псевдонима или имени модели.
2. **Формирование заголовков запроса**:
   - Создается словарь `headers` с необходимыми HTTP-заголовками для запроса к API Upstage.
3. **Создание асинхронной сессии**:
   - Используется `aiohttp.ClientSession` для создания асинхронной HTTP-сессии с заданными заголовками.
4. **Формирование данных запроса**:
   - Создается словарь `data` с данными для отправки в запросе, включая флаг потоковой передачи (`stream`), сообщения (`messages`) и имя модели (`model`).
5. **Отправка POST-запроса к API**:
   - Отправляется POST-запрос к API Upstage (`cls.api_endpoint`) с использованием асинхронной сессии, данных запроса и прокси-сервера (если указан).
6. **Обработка потокового ответа**:
   - Читается ответ построчно из `response.content`.
   - Каждая строка декодируется из UTF-8 и очищается от лишних пробелов.
   - Если строка начинается с "data: " и не равна "data: [DONE]", то извлекается JSON-данные из строки.
   - Извлеченные данные содержат контент, который выдается через `yield content`.
   - Если строка равна "data: [DONE]", то генератор завершается.

```
A: Получение имени модели с помощью `cls.get_model(model)`
|
B: Формирование заголовков запроса `headers`
|
C: Создание асинхронной сессии `aiohttp.ClientSession`
|
D: Формирование данных запроса `data`
|
E: Отправка POST-запроса к API Upstage
|
F: Чтение ответа построчно из `response.content`
|
G: Декодирование строки из UTF-8 и очистка от пробелов
|
H: Проверка, начинается ли строка с "data: " и не равна ли "data: [DONE]"
| Да
I: Извлечение JSON-данных из строки
|
J: Извлечение контента из JSON-данных
|
K: Выдача контента через `yield content`
| Нет
L: Проверка, равна ли строка "data: [DONE]"
| Да
M: Завершение генератора
| Нет
N: Переход к следующей строке ответа
```

**Примеры**:

```python
# Пример использования асинхронного генератора
import asyncio
from typing import AsyncGenerator

async def main():
    messages = [{"role": "user", "content": "Hello, tell me a story."}]
    model = "solar-pro"

    async def process_generator(generator: AsyncGenerator[str, None]):
        async for chunk in generator:
            print(chunk, end="")

    generator = Upstage.create_async_generator(model=model, messages=messages)
    await process_generator(await generator)

if __name__ == "__main__":
    asyncio.run(main())