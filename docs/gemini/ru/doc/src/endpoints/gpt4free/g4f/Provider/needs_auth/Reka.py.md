# Модуль `Reka`

## Обзор

Модуль `Reka` предоставляет класс `Reka`, который является провайдером для взаимодействия с моделью Reka AI. Он поддерживает потоковую передачу данных и требует аутентификации. Модуль позволяет отправлять текстовые и графические запросы к модели и получать ответы.

## Подробнее

Модуль предназначен для интеграции с платформой Reka AI, обеспечивая возможность использования её моделей для обработки текстовых и графических данных. Он включает в себя функции для получения токена доступа, загрузки изображений и создания запросов к API Reka AI. Этот модуль используется для обмена сообщениями с Reka AI, поддерживая как текстовые, так и графические входные данные, и возвращает ответы в потоковом режиме.

## Классы

### `Reka`

**Описание**: Класс `Reka` является провайдером для взаимодействия с моделью Reka AI.

**Наследует**:
- `AbstractProvider`: Абстрактный базовый класс для всех провайдеров.

**Атрибуты**:
- `domain` (str): Доменное имя Reka AI ("space.reka.ai").
- `url` (str): URL для доступа к Reka AI (f"https://{domain}").
- `working` (bool): Указывает, работает ли провайдер (True).
- `needs_auth` (bool): Указывает, требуется ли аутентификация (True).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных (True).
- `default_vision_model` (str): Модель для работы с изображениями ("reka").
- `cookies` (dict): Куки для аутентификации.
- `proxy` (str): Прокси сервер для выполнения запросов.

**Методы**:
- `create_completion`: Создает запрос к Reka AI и возвращает результат.
- `upload_image`: Загружает изображение на сервер Reka AI.
- `get_access_token`: Получает токен доступа для аутентификации.

## Функции

### `create_completion`

```python
@classmethod
def create_completion(
    cls,
    model: str,
    messages: Messages,
    stream: bool,
    proxy: str = None,
    api_key: str = None,
    image: ImageType = None,
    **kwargs
) -> CreateResult:
    """Создает запрос к Reka AI и возвращает результат.

    Args:
        model (str): Имя используемой модели.
        messages (Messages): Список сообщений для отправки.
        stream (bool): Указывает, использовать ли потоковую передачу данных.
        proxy (str, optional): Прокси-сервер для выполнения запросов. По умолчанию `None`.
        api_key (str, optional): API-ключ для аутентификации. По умолчанию `None`.
        image (ImageType, optional): Изображение для отправки. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        CreateResult: Результат запроса.

    Raises:
        ValueError: Если не найдены куки или отсутствует `appSession` в куках.
    """
    ...
```

**Назначение**: Метод `create_completion` создает запрос к API Reka AI для получения ответа на основе предоставленных сообщений и изображения (если есть). Он обрабатывает аутентификацию, формирует данные запроса и отправляет их на сервер.

**Параметры**:
- `cls`: Ссылка на класс `Reka`.
- `model` (str): Имя используемой модели.
- `messages (Messages)`: Список сообщений, где каждое сообщение содержит роль (`role`) и содержимое (`content`).
- `stream` (bool): Флаг, указывающий, использовать ли потоковый режим для получения ответа.
- `proxy (str, optional)`: URL прокси-сервера, если необходимо использовать прокси для подключения к API. По умолчанию `None`.
- `api_key (str, optional)`: API-ключ для аутентификации. Если не предоставлен, метод пытается получить его из cookies. По умолчанию `None`.
- `image (ImageType, optional)`: Изображение для отправки вместе с запросом. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API.

**Возвращает**:
- `CreateResult`: Результат запроса к API Reka AI. В потоковом режиме возвращает генератор, выдающий части ответа.

**Вызывает исключения**:
- `ValueError`: Если не удалось получить куки для домена `cls.domain` или если в куках отсутствует ключ `appSession`.

**Как работает функция**:

1. **Инициализация**: Устанавливает прокси-сервер из аргумента `proxy`.
2. **Аутентификация**: Если `api_key` не предоставлен, пытается получить его из куки. Если куки отсутствуют или не содержат `appSession`, вызывает исключение `ValueError`.
3. **Формирование сообщений**: Преобразует список сообщений в формат, требуемый API Reka AI.
4. **Обработка изображения**: Если передано изображение, загружает его на сервер Reka AI и добавляет URL изображения в сообщение.
5. **Формирование заголовков**: Создает заголовки HTTP-запроса, включая токен авторизации.
6. **Формирование данных запроса**: Создает JSON-данные запроса, включая историю разговоров, флаг потоковой передачи, параметры модели и случайное начальное число.
7. **Отправка запроса**: Отправляет POST-запрос к API Reka AI с использованием `requests.post`.
8. **Обработка потока**: Если `stream` равен `True`, итерируется по ответу в потоковом режиме и извлекает текстовые данные из каждого блока данных.
9. **Генерация токенов**: Извлекает данные токенов из ответа, удаляет повторяющиеся токены и возвращает их как генератор.

```
A: Проверка API-ключа или получение из cookies
|
B: Формирование истории разговоров
|
C: Загрузка изображения (если есть)
|
D: Формирование заголовков и данных запроса
|
E: Отправка POST-запроса к API Reka AI
|
F: Обработка потока данных и извлечение токенов
```

**Примеры**:

```python
# Пример использования create_completion с текстовыми сообщениями
messages = [{"role": "user", "content": "Hello, how are you?"}]
result = Reka.create_completion(model="reka-core", messages=messages, stream=True, api_key="your_api_key")
for token in result:
    print(token, end="")

# Пример использования create_completion с изображением
from io import BytesIO
from PIL import Image
image = Image.new("RGB", (100, 100), color="red")
image_bytes = BytesIO()
image.save(image_bytes, format="PNG")
image_bytes = image_bytes.getvalue()

messages = [{"role": "user", "content": "What is this?"}]
result = Reka.create_completion(model="reka-core", messages=messages, stream=True, api_key="your_api_key", image=image_bytes)
for token in result:
    print(token, end="")
```

### `upload_image`

```python
def upload_image(cls, access_token: str, image: ImageType) -> str:
    """Загружает изображение на сервер Reka AI.

    Args:
        cls: Ссылка на класс.
        access_token (str): Токен доступа для аутентификации.
        image (ImageType): Изображение для загрузки.

    Returns:
        str: URL загруженного изображения.
    """
    ...
```

**Назначение**: Метод `upload_image` загружает изображение на сервер Reka AI и возвращает URL этого изображения.

**Параметры**:
- `cls`: Ссылка на класс `Reka`.
- `access_token (str)`: Токен доступа для аутентификации.
- `image (ImageType)`: Изображение, которое нужно загрузить.

**Возвращает**:
- `str`: URL загруженного изображения.

**Как работает функция**:

1. **Генерация токена**: Генерирует случайный токен границы для multipart/form-data.
2. **Формирование заголовков**: Создает заголовки HTTP-запроса, включая токен авторизации и Content-Type для multipart/form-data.
3. **Преобразование изображения в байты**: Преобразует изображение в байтовый формат.
4. **Формирование данных запроса**: Создает данные запроса в формате multipart/form-data, включая информацию об изображении (имя файла, тип содержимого) и само изображение.
5. **Отправка запроса**: Отправляет POST-запрос к API Reka AI для загрузки изображения с использованием `requests.post`.
6. **Обработка ответа**: Извлекает URL загруженного изображения из JSON-ответа.

```
A: Генерация токена границы
|
B: Формирование заголовков
|
C: Преобразование изображения в байты
|
D: Формирование данных запроса в формате multipart/form-data
|
E: Отправка POST-запроса к API Reka AI
|
F: Извлечение URL изображения из JSON-ответа
```

**Примеры**:

```python
# Пример использования upload_image
from io import BytesIO
from PIL import Image

# Создаем пример изображения
image = Image.new("RGB", (100, 100), color="red")
image_bytes = BytesIO()
image.save(image_bytes, format="PNG")
image_bytes = image_bytes.getvalue()

# Загружаем изображение и получаем URL
access_token = "your_access_token"
image_url = Reka.upload_image(access_token=access_token, image=image_bytes)
print(f"Image URL: {image_url}")
```

### `get_access_token`

```python
def get_access_token(cls) -> str:
    """Получает токен доступа для аутентификации.

    Returns:
        str: Токен доступа.

    Raises:
        ValueError: Если не удалось получить токен доступа.
    """
    ...
```

**Назначение**: Метод `get_access_token` получает токен доступа для аутентификации в API Reka AI.

**Возвращает**:
- `str`: Токен доступа.

**Вызывает исключения**:
- `ValueError`: Если не удалось получить токен доступа.

**Как работает функция**:

1. **Формирование заголовков**: Создает заголовки HTTP-запроса, включая информацию о браузере и типе запроса.
2. **Отправка запроса**: Отправляет GET-запрос к API Reka AI для получения токена доступа с использованием `requests.get`.
3. **Обработка ответа**: Извлекает токен доступа из JSON-ответа.
4. **Обработка ошибок**: Если запрос не удался или токен не найден, вызывает исключение `ValueError`.

```
A: Формирование заголовков запроса
|
B: Отправка GET-запроса к API Reka AI
|
C: Извлечение токена доступа из JSON-ответа
|
D: Обработка ошибок и вызов исключения ValueError (если необходимо)
```

**Примеры**:

```python
# Пример использования get_access_token
try:
    access_token = Reka.get_access_token()
    print(f"Access Token: {access_token}")
except ValueError as ex:
    print(f"Error getting access token: {ex}")