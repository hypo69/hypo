## <алгоритм>
### Общий рабочий процесс:

1. **Инициализация кампании:**
   -  Создается экземпляр `AliPromoCampaign` с именем кампании, категорией, языком и валютой.
   -  Метод `initialize_campaign` инициализирует данные кампании, загружая их из JSON-файла (если он существует) или создавая новый.
   -  Пример: 
      ```python
      campaign = AliPromoCampaign("test_campaign", "test_category", "EN", "USD")
      campaign.initialize_campaign()
      ```

2.  **Получение продуктов категории:**
    - Метод `get_category_products` получает список продуктов для указанной категории.
    - Если `force` установлен в `True` или нет JSON-файлов, он вызывает `fetch_product_data`, иначе загружает данные из существующих JSON-файлов.
    -  Пример: 
        ```python
        products = campaign.get_category_products(force=True)  # Загрузка новых данных
        products = campaign.get_category_products() # Загрузка из файлов, если есть
        ```
    -  Поток данных:
       -   Вызов `get_category_products` -> Проверка наличия JSON-файлов -> вызов  `fetch_product_data` или загрузка данных из файла -> возвращает список продуктов

3.  **Создание пространств имен (namespaces):**
    - Методы `create_product_namespace`, `create_category_namespace` и `create_campaign_namespace` создают `SimpleNamespace` объекты для хранения данных о продукте, категории и кампании соответственно.
    -   Пример:
         ```python
        product_data = {"product_id": "123", "product_title": "Test Product"}
        product_ns = campaign.create_product_namespace(**product_data)
        ```
    -   Поток данных:
        -   Вход: Словарь данных (например, `product_data`)
        -   Выход: Объект `SimpleNamespace` (например, `product_ns`)

4. **Подготовка продуктов:**
    - Метод `prepare_products` подготавливает данные о продуктах, читая исходный HTML файл и вызывая `process_affiliate_products`.
    -   Пример: 
        ```python
        campaign.prepare_products()
        ```
    -   Поток данных:
        -   Вызов `prepare_products` -> чтение HTML файла -> вызов `process_affiliate_products`
    
5. **Получение данных о продукте:**
    - Метод `fetch_product_data` получает данные о продукте, вызывая `process_affiliate_products`, и возвращает их в виде списка `SimpleNamespace` объектов.
    -   Пример:
        ```python
        product_ids = ["123", "456"]
        products = campaign.fetch_product_data(product_ids)
        ```
    - Поток данных:
        - Вход: Список идентификаторов продуктов (`product_ids`)
        - Вызов: `process_affiliate_products`
        - Выход: Список объектов `SimpleNamespace` (например, `products`)

6. **Сохранение продукта:**
    - Метод `save_product` сохраняет данные о продукте в JSON-файл.
    -   Пример:
        ```python
        product = SimpleNamespace(product_id="123", product_title="Test Product")
        campaign.save_product(product)
        ```
    - Поток данных:
        -   Вход: Объект `SimpleNamespace`, представляющий продукт (например, `product`)
        -   Сериализация данных объекта в JSON-формат с помощью `j_dumps`
        -   Сохранение JSON-данных в файл с помощью `pathlib.Path.write_text`

7. **Получение списка продуктов кампании:**
    - Метод `list_campaign_products` возвращает список заголовков продуктов из категории.
    -   Пример:
         ```python
        product_titles = campaign.list_campaign_products()
         ```
    - Поток данных:
        -   Вход: Объект кампании с уже загруженными продуктами (например, `campaign`)
        -   Итерация по продуктам в `campaign.category.products`
        -   Выход: Список заголовков продуктов (например, `product_titles`)

## <mermaid>
```mermaid
graph TD
    A[Начало] --> B(Создание экземпляра AliPromoCampaign);
    B --> C{Проверка: существует ли файл campaign.json?};
    C -- Да --> D(Загрузка данных кампании из JSON);
    C -- Нет --> E(Создание новой структуры данных кампании);
    D --> F(Инициализация данных кампании);
    E --> F;
    F --> G{Вызов get_category_products};
    G --> H{Проверка: force=True или нет файлов json?};
    H -- Да --> I(Вызов fetch_product_data);
    H -- Нет --> J(Загрузка данных о продуктах из json файлов);
    I --> K(Получение данных о продуктах);
     K --> L(Создание SimpleNamespace для каждого продукта);
    J --> L
    L --> M(Возврат списка продуктов);
    M --> N{Вызов prepare_products};
    N --> O(Чтение исходного HTML-файла);
    O --> P(Вызов process_affiliate_products);
    P --> Q(Создание SimpleNamespace для каждого продукта);
     Q --> R{Вызов fetch_product_data с product_ids};
     R --> S(Вызов process_affiliate_products и создание списка SimpleNamespace);
    S --> T(Возврат списка продуктов);
    T --> U{Вызов save_product(product)};
    U --> V(Сериализация данных продукта в JSON);
    V --> W(Сохранение JSON данных в файл);
    W --> X{Вызов list_campaign_products};
    X --> Y(Извлечение заголовков продуктов из campaign.category.products);
    Y --> Z(Возврат списка заголовков продуктов);
    Z --> AA[Конец];
    

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style AA fill:#f9f,stroke:#333,stroke-width:2px
```

### Описание `mermaid` диаграммы:

-   **Начало (A) и Конец (AA):** Указывают на начало и конец процесса.
-   **Создание экземпляра AliPromoCampaign (B):** Создается объект класса `AliPromoCampaign` для управления кампанией.
-   **Проверка: существует ли файл campaign.json? (C):** Проверяет наличие файла с данными кампании.
-   **Загрузка данных кампании из JSON (D):** Загружает данные кампании из JSON файла, если он существует.
-   **Создание новой структуры данных кампании (E):** Создает структуру данных для новой кампании.
-   **Инициализация данных кампании (F):** Инициализирует данные кампании, загруженные или вновь созданные.
-   **Вызов `get_category_products` (G):** Вызывает метод для получения продуктов категории.
-   **Проверка: `force=True` или нет файлов json? (H):** Проверяет, нужно ли загружать данные из файла или принудительно из сети.
-   **Вызов `fetch_product_data` (I):** Вызывает метод для загрузки данных о продуктах.
-    **Загрузка данных о продуктах из json файлов (J):** Загрузка ранее сохраненных данных о продуктах из json файлов.
-   **Получение данных о продуктах (K):** Получает список данных о продуктах.
-    **Создание SimpleNamespace для каждого продукта (L):**  Создает объект SimpleNamespace для каждого продукта.
-   **Возврат списка продуктов (M):** Возвращает список продуктов.
-   **Вызов `prepare_products` (N):** Вызывает метод для подготовки продуктов.
-   **Чтение исходного HTML-файла (O):** Читает HTML файл с исходными данными.
-    **Вызов `process_affiliate_products` (P):** Вызывает метод обработки аффилированных продуктов.
-    **Создание SimpleNamespace для каждого продукта (Q):** Создание  SimpleNamespace объектов для каждого продукта, после обработки.
-   **Вызов `fetch_product_data` с `product_ids` (R):** Вызывает метод `fetch_product_data` с определенными идентификаторами продуктов.
-   **Вызов `process_affiliate_products` и создание списка `SimpleNamespace` (S):** Вызывает метод `process_affiliate_products` для обработки данных о продуктах и возвращает результат в виде списка объектов `SimpleNamespace`.
-   **Возврат списка продуктов (T):** Возвращает список обработанных продуктов.
-   **Вызов `save_product(product)` (U):** Вызывает метод для сохранения данных продукта.
-   **Сериализация данных продукта в JSON (V):** Преобразует данные о продукте в формат JSON.
-   **Сохранение JSON данных в файл (W):** Сохраняет данные продукта в JSON файл.
-   **Вызов `list_campaign_products` (X):** Вызывает метод для получения списка названий продуктов.
-   **Извлечение заголовков продуктов из `campaign.category.products` (Y):** Извлекает заголовки продуктов из категории.
-   **Возврат списка заголовков продуктов (Z):** Возвращает список заголовков продуктов.
-   Диаграмма описывает последовательность выполнения тестов и методов класса `AliPromoCampaign`.

### Зависимости:
- `pytest`: Фреймворк для тестирования. Используется для написания и запуска тестов.
- `pathlib`: Модуль для работы с путями файлов. Используется для создания путей и записи в файлы.
- `types.SimpleNamespace`: Простой класс для создания объектов с произвольными атрибутами. Используется для представления данных.
- `src.suppliers.aliexpress.campaign.ali_promo_campaign.AliPromoCampaign`: Класс, который тестируется в этом файле.
- `src.utils.jjson.j_dumps`: Функция для сериализации объектов в JSON.
- `src.utils.jjson.j_loads_ns`: Функция для десериализации JSON в объект `SimpleNamespace`.
- `src.utils.file.save_text_file`: Функция для сохранения текста в файл.
- `src.utils.file.read_text_file`: Функция для чтения текста из файла.
- `src.utils.file.get_filenames`: Функция для получения списка файлов по пути.
- `src`: Указывает на папку с исходными файлами проекта, используется для импорта `gs`.

## <объяснение>

### Импорты:

-   `pytest`: Импортируется для создания тестовых функций и использования фикстур.
-   `pathlib.Path`: Используется для работы с путями к файлам, в частности для сохранения данных продуктов.
-   `types.SimpleNamespace`: Используется для создания простых объектов с атрибутами, что позволяет имитировать данные продукта, категории и кампании.
-   `src.suppliers.aliexpress.campaign.ali_promo_campaign.AliPromoCampaign`: Импортируется класс, который тестируется. Представляет кампанию AliExpress.
-   `src.utils.jjson.j_dumps` и `src.utils.jjson.j_loads_ns`: Функции для работы с JSON данными, используется для сохранения и загрузки данных о продуктах.
-   `src.utils.file.save_text_file`, `src.utils.file.read_text_file` и `src.utils.file.get_filenames`: Функции для работы с файлами, используются для чтения HTML файлов и списка файлов.
-   `src.gs`: Импортируется глобальная переменная `gs` (не используется в представленном коде).

### Классы:

-   **`AliPromoCampaign`**: Класс, представляющий кампанию AliExpress.
    -   **Атрибуты:**
        -   `campaign`: Объект `SimpleNamespace` для хранения данных о кампании.
        -   `category`: Объект `SimpleNamespace` для хранения данных о категории.
        -   `language`, `currency`: Язык и валюта кампании.
    -   **Методы:**
        -   `initialize_campaign`: Инициализирует данные кампании, загружая их из JSON-файла (если существует) или создавая новые.
        -   `get_category_products`: Возвращает список продуктов для заданной категории, загружая их из JSON файлов или получая из сети.
        -   `create_product_namespace`: Создает объект `SimpleNamespace` для хранения данных о продукте.
        -   `create_category_namespace`: Создает объект `SimpleNamespace` для хранения данных о категории.
        -   `create_campaign_namespace`: Создает объект `SimpleNamespace` для хранения данных о кампании.
        -   `prepare_products`: Подготавливает данные о продуктах, читая HTML и вызывая `process_affiliate_products`.
        -   `fetch_product_data`: Получает данные о продуктах через `process_affiliate_products`.
        -   `save_product`: Сохраняет данные о продукте в JSON-файл.
        -   `list_campaign_products`: Возвращает список названий продуктов в категории.
        -   `process_affiliate_products`:  Функция обработки продуктов (не входит в данный код, но вызывается другими методами)
        -   `get_prepared_products`: Функция получения подготовленных продуктов (не входит в данный код, но вызывается методом `prepare_products`).
    -   **Взаимодействие:**
        -   Использует функции из `src.utils.jjson` для работы с JSON-данными.
        -   Использует функции из `src.utils.file` для работы с файлами.

### Функции:

-   `campaign()`:
    -   **Аргументы:** Нет.
    -   **Возвращает:** Экземпляр `AliPromoCampaign`.
    -   **Назначение:** Фикстура `pytest`, создающая экземпляр `AliPromoCampaign` для использования в тестах.
-   `test_initialize_campaign(mocker, campaign)`:
    -   **Аргументы:** `mocker` - фикстура для мокирования, `campaign` - фикстура `AliPromoCampaign`.
    -   **Возвращает:** Ничего.
    -   **Назначение:** Тестирует метод `initialize_campaign` на корректную инициализацию данных кампании.
        -   Пример: Мокирует `j_loads_ns` для возврата заданных данных и проверяет что данные кампании инициализированы.
-   `test_get_category_products_no_json_files(mocker, campaign)`:
    -   **Аргументы:** `mocker` - фикстура для мокирования, `campaign` - фикстура `AliPromoCampaign`.
    -   **Возвращает:** Ничего.
    -   **Назначение:** Тестирует метод `get_category_products`, когда нет JSON-файлов.
        -   Пример: Мокирует `get_filenames` для возврата пустого списка и проверяет что возвращаемый список продуктов пуст.
-   `test_get_category_products_with_json_files(mocker, campaign)`:
    -   **Аргументы:** `mocker` - фикстура для мокирования, `campaign` - фикстура `AliPromoCampaign`.
    -   **Возвращает:** Ничего.
    -   **Назначение:** Тестирует метод `get_category_products`, когда JSON-файлы есть.
        -  Пример: Мокирует `get_filenames` для возврата списка файлов и `j_loads_ns` для возврата мок-данных и проверяет, что возвращается список продуктов с корректными данными.
-   `test_create_product_namespace(campaign)`:
    -   **Аргументы:** `campaign` - фикстура `AliPromoCampaign`.
    -   **Возвращает:** Ничего.
    -   **Назначение:** Тестирует метод `create_product_namespace` на корректное создание пространства имен для продукта.
        -   Пример: Вызывает метод `create_product_namespace` и проверяет, что возвращаемый объект `SimpleNamespace` содержит нужные данные.
-   `test_create_category_namespace(campaign)`:
    -   **Аргументы:** `campaign` - фикстура `AliPromoCampaign`.
    -   **Возвращает:** Ничего.
    -   **Назначение:** Тестирует метод `create_category_namespace` на корректное создание пространства имен для категории.
        -   Пример: Вызывает метод `create_category_namespace` и проверяет, что возвращаемый объект `SimpleNamespace` содержит нужные данные.
-   `test_create_campaign_namespace(campaign)`:
    -   **Аргументы:** `campaign` - фикстура `AliPromoCampaign`.
    -   **Возвращает:** Ничего.
    -   **Назначение:** Тестирует метод `create_campaign_namespace` на корректное создание пространства имен для кампании.
        -   Пример: Вызывает метод `create_campaign_namespace` и проверяет, что возвращаемый объект `SimpleNamespace` содержит нужные данные.
-   `test_prepare_products(mocker, campaign)`:
    -   **Аргументы:** `mocker` - фикстура для мокирования, `campaign` - фикстура `AliPromoCampaign`.
    -   **Возвращает:** Ничего.
    -   **Назначение:** Тестирует метод `prepare_products` на вызов метода `process_affiliate_products`.
        -   Пример: Мокирует `get_prepared_products` для возврата пустого списка, `read_text_file` для возврата текста, `get_filenames` для возврата списка файлов и проверяет, что метод `process_affiliate_products` был вызван.
-   `test_fetch_product_data(mocker, campaign)`:
    -   **Аргументы:** `mocker` - фикстура для мокирования, `campaign` - фикстура `AliPromoCampaign`.
    -   **Возвращает:** Ничего.
    -   **Назначение:** Тестирует метод `fetch_product_data` на корректное получение данных о продуктах.
        -   Пример: Мокирует `process_affiliate_products` для возврата списка продуктов и проверяет, что метод возвращает правильный список продуктов.
-   `test_save_product(mocker, campaign)`:
    -   **Аргументы:** `mocker` - фикстура для мокирования, `campaign` - фикстура `AliPromoCampaign`.
    -   **Возвращает:** Ничего.
    -   **Назначение:** Тестирует метод `save_product` на корректное сохранение данных о продукте.
        -   Пример: Мокирует `j_dumps` для возврата JSON строки и `Path.write_text` и проверяет, что метод вызван с нужными данными.
-   `test_list_campaign_products(campaign)`:
    -   **Аргументы:** `campaign` - фикстура `AliPromoCampaign`.
    -   **Возвращает:** Ничего.
    -   **Назначение:** Тестирует метод `list_campaign_products` на корректное получение списка названий продуктов.
        -   Пример: Добавляет мок-продукты в категорию кампании и проверяет, что возвращаемый список заголовков продуктов соответствует ожидаемому.

### Переменные:

-   `MODE`: Глобальная переменная, определяющая режим работы (`dev`), не используется в представленном коде, но возможно используется в других частях проекта.
-  `campaign_name`:  Строка, хранит имя кампании для тестов (`test_campaign`).
-  `category_name`:  Строка, хранит имя категории для тестов (`test_category`).
-  `language`: Строка, хранит язык для тестов (`EN`).
-  `currency`: Строка, хранит валюту для тестов (`USD`).
-   `mock_json_data`, `mock_product_data`, `product_data`, `category_data`, `campaign_data`: Словари, используемые для мокирования и тестирования данных.
-   `product_ids`: Список идентификаторов продуктов, используемый в тестах.
-   `mock_products`: Список объектов `SimpleNamespace`, имитирующих продукты.
-   `product`, `camp`, `products`, `category`, `product_titles` и т.д.: Локальные переменные, используемые для хранения данных в тестах.

### Потенциальные ошибки или области для улучшения:

-   **Зависимость от `process_affiliate_products`**: Тесты мокируют этот метод, что делает их менее интеграционными. Было бы полезно иметь тесты, которые проверяют взаимодействие с этим методом.
-   **Отсутствие явной обработки ошибок**: В коде не видно явной обработки ошибок, например, при чтении файлов или работе с сетью.
-   **Жестко закодированные пути**: Пути к файлам могут быть жестко закодированы, что может привести к проблемам при изменении структуры проекта. Лучше использовать переменные среды или относительные пути.
-   **Ограниченное тестирование**: Тесты проверяют в основном вызовы методов и возвращаемые значения, но не проверяют, как эти методы взаимодействуют друг с другом и с другими частями системы.

### Взаимосвязь с другими частями проекта:

-   **`src.utils.jjson`**: Используется для работы с JSON данными, позволяя сохранять и загружать данные о продуктах, категориях и кампаниях.
-   **`src.utils.file`**: Используется для работы с файловой системой, чтения и записи файлов, получения списка файлов.
-   **`src.suppliers.aliexpress.campaign.ali_promo_campaign`**: Класс, представляющий логику работы с кампаниями AliExpress и являющийся основным объектом тестирования.
-   Тесты предполагают, что другие части проекта (`process_affiliate_products` и `get_prepared_products`) функционируют корректно.