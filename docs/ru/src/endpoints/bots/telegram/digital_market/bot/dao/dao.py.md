# Модуль для работы с базой данных (DAO) цифрового магазина Telegram-бота
========================================================================

Модуль содержит классы DAO (Data Access Object) для взаимодействия с базой данных,
используемой в Telegram-боте цифрового магазина.
Он предоставляет методы для доступа к данным пользователей, покупок, категорий и продуктов.

## Оглавление

- [Обзор](#обзор)
- [Подробнее](#подробнее)
- [Классы](#классы)
    - [`UserDAO`](#userdao)
        - [`get_purchase_statistics`](#get_purchase_statistics)
        - [`get_purchased_products`](#get_purchased_products)
        - [`get_statistics`](#get_statistics)
    - [`PurchaseDao`](#purchasedao)
        - [`get_payment_stats`](#get_payment_stats)
        - [`get_full_summ`](#get_full_summ)
        - [`get_next_id`](#get_next_id)
    - [`CategoryDao`](#categorydao)
    - [`ProductDao`](#productdao)
- [Функции](#функции)

## Обзор

Этот модуль предоставляет Data Access Objects (DAO) для работы с моделями базы данных, такими как пользователи, покупки, категории и продукты.
Он включает в себя классы для выполнения операций CRUD (Create, Read, Update, Delete) и других специализированных запросов к базе данных.
В частности, модуль предоставляет методы для получения статистики о пользователях и покупках, а также для работы с категориями и продуктами.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для работы с базой данных, используемой в Telegram-боте цифрового магазина.
Он предоставляет интерфейс для взаимодействия с базой данных, скрывая детали реализации и упрощая доступ к данным.
Модуль использует SQLAlchemy для работы с базой данных и предоставляет асинхронные методы для выполнения запросов.

## Классы

### `UserDAO`

**Описание**:
DAO для работы с моделью User (пользователь).
Предоставляет методы для получения статистики о покупках пользователя и информации о приобретенных продуктах.

**Наследует**:
- `BaseDAO[User]`: Базовый класс DAO, предоставляющий основные методы для работы с моделью User.

**Атрибуты**:
- `model` (Type[User]): Модель User, с которой работает данный DAO.

**Методы**:
- `get_purchase_statistics`: Получает статистику о покупках пользователя.
- `get_purchased_products`: Получает информацию о приобретенных пользователем продуктах.
- `get_statistics`: Получает общую статистику по пользователям.

#### `get_purchase_statistics`

```python
    @classmethod
    async def get_purchase_statistics(cls, session: AsyncSession, telegram_id: int) -> Optional[Dict[str, int]]:
        """
        Args:
            session (AsyncSession): Асинхронная сессия базы данных.
            telegram_id (int): ID пользователя в Telegram.

        Returns:
            Optional[Dict[str, int]]: Словарь со статистикой покупок пользователя.
                                       Содержит общее число покупок и общую сумму.
                                       Возвращает None в случае ошибки или отсутствия данных.
        """
```

**Назначение**:
Получает статистику о покупках пользователя, включая общее число покупок и общую сумму покупок.

**Параметры**:
- `session` (AsyncSession): Асинхронная сессия базы данных.
- `telegram_id` (int): ID пользователя в Telegram.

**Возвращает**:
- `Optional[Dict[str, int]]`: Словарь со статистикой покупок пользователя. Содержит следующие ключи:
    - `'total_purchases'` (int): Общее число покупок пользователя.
    - `'total_amount'` (int): Общая сумма покупок пользователя.
    Возвращает `None` в случае ошибки или отсутствия данных.

**Вызывает исключения**:
- `SQLAlchemyError`: В случае ошибки при работе с базой данных.

**Как работает функция**:

1. **Подготовка запроса**: Формируется запрос к базе данных для подсчета общего числа покупок и общей суммы покупок для указанного пользователя.
2. **Выполнение запроса**: Запрос выполняется с использованием предоставленной асинхронной сессии базы данных.
3. **Обработка результатов**: Результаты запроса обрабатываются для извлечения общего числа покупок и общей суммы.
4. **Формирование словаря**: Полученные данные формируются в словарь и возвращаются.

```ascii
    Начало
     ↓
    Подготовка запроса (SQLAlchemy)
     ↓
    Выполнение запроса (session.execute)
     ↓
    Обработка результатов (result.one_or_none())
     ↓
    Формирование словаря с результатами
     ↓
    Конец
```

**Примеры**:
```python
    # Пример использования функции
    from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
    from asyncio import run

    async def main():
        engine = create_async_engine("sqlite+aiosqlite:///:memory:")

        async with engine.begin() as conn:
            # await conn.run_sync(Base.metadata.create_all)  # Раскомментировать при необходимости

            async with AsyncSession(engine) as session:
                telegram_id = 12345
                stats = await UserDAO.get_purchase_statistics(session, telegram_id)
                print(stats)

    run(main())
```

#### `get_purchased_products`

```python
    @classmethod
    async def get_purchased_products(cls, session: AsyncSession, telegram_id: int) -> Optional[List[Purchase]]:
        """
        Args:
            session (AsyncSession): Асинхронная сессия базы данных.
            telegram_id (int): ID пользователя в Telegram.

        Returns:
            Optional[List[Purchase]]: Список покупок пользователя с информацией о продуктах.
                                        Возвращает None в случае ошибки или отсутствия данных.
        """
```

**Назначение**:
Получает список покупок пользователя с информацией о приобретенных продуктах.

**Параметры**:
- `session` (AsyncSession): Асинхронная сессия базы данных.
- `telegram_id` (int): ID пользователя в Telegram.

**Возвращает**:
- `Optional[List[Purchase]]`: Список покупок пользователя. Каждый элемент списка содержит информацию о покупке и связанном продукте.
    Возвращает `None` в случае ошибки или отсутствия данных.

**Вызывает исключения**:
- `SQLAlchemyError`: В случае ошибки при работе с базой данных.

**Как работает функция**:

1. **Подготовка запроса**: Формируется запрос к базе данных для получения пользователя с его покупками и связанными продуктами.
2. **Выполнение запроса**: Запрос выполняется с использованием предоставленной асинхронной сессии базы данных.
3. **Обработка результатов**: Результаты запроса обрабатываются для извлечения списка покупок пользователя.
4. **Возврат списка покупок**: Полученный список покупок возвращается.

```ascii
    Начало
     ↓
    Подготовка запроса (SQLAlchemy)
     ↓
    Выполнение запроса (session.execute)
     ↓
    Обработка результатов (result.scalar_one_or_none())
     ↓
    Возврат списка покупок
     ↓
    Конец
```

**Примеры**:
```python
    # Пример использования функции
    from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
    from asyncio import run

    async def main():
        engine = create_async_engine("sqlite+aiosqlite:///:memory:")

        async with engine.begin() as conn:
            # await conn.run_sync(Base.metadata.create_all)  # Раскомментировать при необходимости

            async with AsyncSession(engine) as session:
                telegram_id = 12345
                purchases = await UserDAO.get_purchased_products(session, telegram_id)
                print(purchases)

    run(main())
```

#### `get_statistics`

```python
    @classmethod
    async def get_statistics(cls, session: AsyncSession):
        """
        Args:
            session (AsyncSession): Асинхронная сессия базы данных.

        Returns:
            statistics (Dict): Словарь со статистикой пользователей.
                                Содержит общее количество пользователей, количество новых пользователей за сегодня, за неделю и за месяц.

        Raises:
            SQLAlchemyError: В случае ошибки при работе с базой данных.
        """
```

**Назначение**:
Получает статистику по пользователям, включая общее количество пользователей, количество новых пользователей за сегодня, за неделю и за месяц.

**Параметры**:
- `session` (AsyncSession): Асинхронная сессия базы данных.

**Возвращает**:
- `statistics` (Dict): Словарь со статистикой пользователей. Содержит следующие ключи:
    - `'total_users'` (int): Общее количество пользователей.
    - `'new_today'` (int): Количество новых пользователей, зарегистрированных сегодня.
    - `'new_week'` (int): Количество новых пользователей, зарегистрированных за последнюю неделю.
    - `'new_month'` (int): Количество новых пользователей, зарегистрированных за последний месяц.

**Вызывает исключения**:
- `SQLAlchemyError`: В случае ошибки при работе с базой данных.

**Как работает функция**:

1. **Подготовка запроса**: Формируется запрос к базе данных для подсчета общего количества пользователей и количества новых пользователей за сегодня, за неделю и за месяц.
2. **Выполнение запроса**: Запрос выполняется с использованием предоставленной асинхронной сессии базы данных.
3. **Обработка результатов**: Результаты запроса обрабатываются для извлечения статистики по пользователям.
4. **Формирование словаря**: Полученные данные формируются в словарь и возвращаются.

```ascii
    Начало
     ↓
    Получение текущей даты и времени (datetime.now(UTC))
     ↓
    Подготовка запроса (SQLAlchemy)
     ↓
    Выполнение запроса (session.execute)
     ↓
    Обработка результатов (result.fetchone())
     ↓
    Формирование словаря со статистикой
     ↓
    Логгирование статистики (logger.info)
     ↓
    Конец
```

**Примеры**:
```python
    # Пример использования функции
    from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
    from asyncio import run

    async def main():
        engine = create_async_engine("sqlite+aiosqlite:///:memory:")

        async with engine.begin() as conn:
            # await conn.run_sync(Base.metadata.create_all)  # Раскомментировать при необходимости

            async with AsyncSession(engine) as session:
                statistics = await UserDAO.get_statistics(session)
                print(statistics)

    run(main())
```

### `PurchaseDao`

**Описание**:
DAO для работы с моделью Purchase (покупка).
Предоставляет методы для получения статистики о платежах и общей суммы покупок.

**Наследует**:
- `BaseDAO[Purchase]`: Базовый класс DAO, предоставляющий основные методы для работы с моделью Purchase.

**Атрибуты**:
- `model` (Type[Purchase]): Модель Purchase, с которой работает данный DAO.

**Методы**:
- `get_payment_stats`: Получает статистику о платежах.
- `get_full_summ`: Получает общую сумму покупок.
- `get_next_id`: Получает следующий свободный ID для новой записи.

#### `get_payment_stats`

```python
    @classmethod
    async def get_payment_stats(cls, session: AsyncSession) -> str:
        """
        Args:
            session (AsyncSession): Асинхронная сессия базы данных.

        Returns:
            str: Отформатированная строка со статистикой о платежах.
        """
```

**Назначение**:
Получает статистику о платежах по типам платежных систем (Юкасса, Робокасса, STARS) и формирует отформатированную строку с результатами.

**Параметры**:
- `session` (AsyncSession): Асинхронная сессия базы данных.

**Возвращает**:
- `str`: Отформатированная строка со статистикой о платежах, включающая информацию о суммах, проведенных через Юкассу, Робокассу и STARS.

**Вызывает исключения**:
- `SQLAlchemyError`: В случае ошибки при работе с базой данных.

**Как работает функция**:

1. **Подготовка запроса**: Формируется запрос к базе данных для получения статистики о платежах по типам платежных систем.
2. **Выполнение запроса**: Запрос выполняется с использованием предоставленной асинхронной сессии базы данных.
3. **Обработка результатов**: Результаты запроса обрабатываются для извлечения информации о суммах, проведенных через различные платежные системы.
4. **Формирование словаря**: Полученные данные формируются в словарь для удобства доступа.
5. **Форматирование строки**: Данные из словаря форматируются в строку с использованием f-strings.

```ascii
    Начало
     ↓
    Подготовка запроса (SQLAlchemy)
     ↓
    Выполнение запроса (session.execute)
     ↓
    Обработка результатов (result.all())
     ↓
    Формирование словаря с результатами
     ↓
    Форматирование строки с результатами
     ↓
    Конец
```

**Примеры**:
```python
    # Пример использования функции
    from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
    from asyncio import run

    async def main():
        engine = create_async_engine("sqlite+aiosqlite:///:memory:")

        async with engine.begin() as conn:
            # await conn.run_sync(Base.metadata.create_all)  # Раскомментировать при необходимости

            async with AsyncSession(engine) as session:
                payment_stats = await PurchaseDao.get_payment_stats(session)
                print(payment_stats)

    run(main())
```

#### `get_full_summ`

```python
    @classmethod
    async def get_full_summ(cls, session: AsyncSession) -> int:
        """
        Args:
            session (AsyncSession): Асинхронная сессия базы данных.

        Returns:
            int: Общая сумма покупок.
        """
```

**Назначение**:
Получает общую сумму всех покупок.

**Параметры**:
- `session` (AsyncSession): Асинхронная сессия базы данных.

**Возвращает**:
- `int`: Общая сумма всех покупок.

**Вызывает исключения**:
- `SQLAlchemyError`: В случае ошибки при работе с базой данных.

**Как работает функция**:

1. **Подготовка запроса**: Формируется запрос к базе данных для получения общей суммы всех покупок.
2. **Выполнение запроса**: Запрос выполняется с использованием предоставленной асинхронной сессии базы данных.
3. **Обработка результатов**: Результаты запроса обрабатываются для извлечения общей суммы.
4. **Возврат общей суммы**: Полученная общая сумма возвращается.

```ascii
    Начало
     ↓
    Подготовка запроса (SQLAlchemy)
     ↓
    Выполнение запроса (session.execute)
     ↓
    Обработка результатов (result.scalars().one_or_none())
     ↓
    Возврат общей суммы
     ↓
    Конец
```

**Примеры**:
```python
    # Пример использования функции
    from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
    from asyncio import run

    async def main():
        engine = create_async_engine("sqlite+aiosqlite:///:memory:")

        async with engine.begin() as conn:
            # await conn.run_sync(Base.metadata.create_all)  # Раскомментировать при необходимости

            async with AsyncSession(engine) as session:
                full_summ = await PurchaseDao.get_full_summ(session)
                print(full_summ)

    run(main())
```

#### `get_next_id`

```python
    @classmethod
    async def get_next_id(cls, session: AsyncSession) -> int:
        """
        Args:
            session: Асинхронная сессия базы данных
        Returns:
            Следующий свободный ID
        """
```

**Назначение**:
Возвращает следующий свободный ID для новой записи в таблице покупок.

**Параметры**:
- `session` (AsyncSession): Асинхронная сессия базы данных.

**Возвращает**:
- `int`: Следующий свободный ID для новой записи.

**Вызывает исключения**:
- `SQLAlchemyError`: В случае ошибки при работе с базой данных.

**Как работает функция**:

1. **Подготовка запроса**: Формируется запрос к базе данных для получения максимального ID в таблице покупок и добавления к нему 1. Если таблица пуста, возвращается 1.
2. **Выполнение запроса**: Запрос выполняется с использованием предоставленной асинхронной сессии базы данных.
3. **Обработка результатов**: Результаты запроса обрабатываются для извлечения следующего свободного ID.
4. **Возврат ID**: Полученный ID возвращается.

```ascii
    Начало
     ↓
    Подготовка запроса (SQLAlchemy)
     ↓
    Выполнение запроса (session.execute)
     ↓
    Обработка результатов (result.scalar())
     ↓
    Возврат ID
     ↓
    Конец
```

**Примеры**:
```python
    # Пример использования функции
    from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
    from asyncio import run

    async def main():
        engine = create_async_engine("sqlite+aiosqlite:///:memory:")

        async with engine.begin() as conn:
            # await conn.run_sync(Base.metadata.create_all)  # Раскомментировать при необходимости

            async with AsyncSession(engine) as session:
                next_id = await PurchaseDao.get_next_id(session)
                print(next_id)

    run(main())
```

### `CategoryDao`

**Описание**:
DAO для работы с моделью Category (категория).
Предоставляет основные методы для работы с категориями.

**Наследует**:
- `BaseDAO[Category]`: Базовый класс DAO, предоставляющий основные методы для работы с моделью Category.

**Атрибуты**:
- `model` (Type[Category]): Модель Category, с которой работает данный DAO.

**Методы**:
- Отсутствуют специфичные методы, используются методы базового класса `BaseDAO`.

### `ProductDao`

**Описание**:
DAO для работы с моделью Product (продукт).
Предоставляет основные методы для работы с продуктами.

**Наследует**:
- `BaseDAO[Product]`: Базовый класс DAO, предоставляющий основные методы для работы с моделью Product.

**Атрибуты**:
- `model` (Type[Product]): Модель Product, с которой работает данный DAO.

**Методы**:
- Отсутствуют специфичные методы, используются методы базового класса `BaseDAO`.

## Функции

В данном модуле функции отсутствуют.