# Объяснение кода try_xpath_background.js

Этот JavaScript-код реализует фоновый скрипт для расширения браузера, предназначенного для работы с XPath.  Он обрабатывает сообщения от вкладок, обновляет стили, сохраняет и загружает настройки.

**Структура и основные функции:**

* **`genericListener`:** Централизованный обработчик сообщений, получаемых от различных вкладок.  Использует `browser.runtime.onMessage.addListener` для прослушивания сообщений.

* **`genericListener.listeners`:** Объект, содержащий функции-обработчики для различных типов сообщений.  Каждая функция отвечает за конкретную задачу (например, `storePopupState`, `requestRestorePopupState`, `showAllResults`).


* **`loadDefaultCss`:** Функция для загрузки CSS файла `/css/try_xpath_insert.css` с помощью `XMLHttpRequest`.  Возвращает содержимое файла как Promise.

* **Обработчики сообщений (`genericListener.listeners.*`)**:
    * **`storePopupState`:** Сохраняет состояние попап-окна.
    * **`requestRestorePopupState`:** Восстанавливает состояние попап-окна.
    * **`requestInsertStyleToPopup`:** Отправляет CSS стили для попап-окна.
    * **`showAllResults`:**  Собирает результаты поиска, сохраняет их, а затем открывает новую вкладку для их отображения.
    * **`loadResults`:** Возвращает результаты поиска, полученные ранее.
    * **`updateCss`:** Удаляет и добавляет CSS стили в активной вкладке. Использует `browser.tabs.removeCSS` и `browser.tabs.insertCSS`.  Ключевой момент -  обработка наборов устаревших стилей (`message.expiredCssSet`).
    * **`loadOptions`:** Возвращает текущие значения атрибутов, CSS и стили попап-окна в ответ на запрос.
    * **`requestSetContentInfo`:** Отправляет информацию о атрибутах в активную вкладку.


* **`browser.storage.onChanged.addListener`:**  Обработчик событий изменения настроек в хранилище браузера (например, изменение `attributes`, `css`, `popupCss`).  Обновляет соответствующие переменные.


* **`browser.storage.sync.get`:** Загрузка значений настроек из хранилища. Если CSS файла нет, загружает стандартный по умолчанию.


**Ключевые особенности и пояснения:**

* **Использование Promises:** Функции, загружающие данные (CSS, настройки), используют `Promise` для асинхронной работы. Это позволяет избежать блокирования основного потока.

* **Обработка ошибок (`fu.onError`)**: `catch(fu.onError)`  обрабатывает возможные ошибки при взаимодействии с браузом.  Это важная часть для предотвращения сбоев приложения.

* **`browser.tabs.sendMessage`:** Используется для отправки сообщений в активные вкладки. `frameId` важен для взаимодействия с разными фреймами.

* **`browser.runtime.sendMessage`:** Отправляет сообщения в другой скрипт расширения.

* **`browser.storage.sync`:** Используется для хранения настроек, синхронизируемых в браузере.

* **`genericListener.listeners`:** Правильный способ организовать обработку различных типов сообщений для масштабируемости кода расширения.

**Вывод:**

Код реализует сложную логику взаимодействия с браузером, включая загрузку стилей, обновление настроек и обработку различных сообщений.  Используется `browser API` для взаимодействия с вкладками, фреймами и хранилищем. Принципы использования `Promises`,  обработки ошибок и организации кода (в `genericListener.listeners`) делают код более надежным и масштабируемым.