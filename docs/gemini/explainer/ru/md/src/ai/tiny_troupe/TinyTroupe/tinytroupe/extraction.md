# Модуль `extraction.py` - Экстракция и Нормализация Данных

Этот модуль предоставляет инструменты для структурированной экстракции данных из элементов TinyTroupe (например, агентов и миров). Он позволяет сокращать полученные данные, экспортировать артефакты и демонстрирует отличия агентов-симуляций от AI-помощников, поскольку последние не предназначены для интроспекции таким образом.

**Класс `ResultsExtractor`**

Этот класс отвечает за извлечение данных из агентов и миров TinyTroupe.

*   **`__init__`**: Инициализирует класс, устанавливая путь к шаблону запроса к LLM и инициализируя словари для кеширования результатов экстракции.

*   **`extract_results_from_agent`**: Извлекает ключевые моменты из истории взаимодействий агента.
    *   Принимает на вход экземпляр `TinyPerson`, цель экстракции, описание ситуации, список полей для экстракции и флаг для вывода отладочных сообщений.
    *   Формирует запрос к LLM (OpenAI) с использованием шаблона из файла `prompts/interaction_results_extractor.mustache`, содержащего инструкции для LLM. В запрос включается история взаимодействий агента, цель, и ситуация.
    *   Отправляет запрос к LLM и получает ответ.
    *   Извлекает JSON из ответа LLM и кеширует результат.
    *   Возвращает результат экстракции или None, если запрос не удалось выполнить.

*   **`extract_results_from_world`**: Аналогично `extract_results_from_agent`, но извлекает данные из нескольких агентов в мире.

*   **`save_as_json`**: Сохраняет результаты экстракции в файл JSON.

**Класс `ResultsReducer`**

Этот класс предназначен для сокращения и обработки извлеченных данных.

*   **`__init__`**: Инициализирует класс и создает пустые словари для хранения правил редукции.

*   **`add_reduction_rule`**: Добавляет правило для сокращения данных, сопоставляя триггер с функцией обработки.

*   **`reduce_agent`**: Применяет правила редукции к истории взаимодействий агента.
    *   Итерируется по эпизодической памяти агента.
    *   Если встречается роль "system", пропускает её.
    *   Если роль "user", анализирует стимул и применяет соответствующее правило редукции, если оно найдено.
    *   Если роль "assistant", анализирует действие и применяет соответствующее правило редукции, если оно найдено.
    *   Возвращает список результатов редукции.

*   **`reduce_agent_to_dataframe`**: Преобразует результаты редукции в Pandas DataFrame.

**Класс `ArtifactExporter`**

Этот класс отвечает за экспорт артефактов (результатов симуляции) в различные форматы.

*   **`__init__`**: Инициализирует класс, принимая базовый каталог для экспорта.

*   **`export`**: Экспортирует артефакт в указанный формат (json, txt, docx).
    *   Управляет валидацией и обработкой входных данных.
    *   Обрабатывает различные типы данных артефакта (строка, словарь).
    *   Осуществляет очистку имени артефакта, заменяя недопустимые символы.
    *   Вызывает соответствующие вспомогательные методы для экспорта в определенный формат.

*   **`_export_as_txt`**: Экспорт в текстовый файл.

*   **`_export_as_json`**: Экспорт в JSON-файл.

*   **`_export_as_docx`**: Экспорт в DOCX-файл, использует `pypandoc` для конвертации Markdown в DOCX.


**Класс `Normalizer`**

Этот класс предназначен для нормализации текстовых элементов.

*   **`__init__`**: Инициализирует класс, получая список элементов для нормализации, количество элементов в выводе и флаг для вывода отладочных сообщений.
*   **`normalize`**: Нормализует введенный элемент или список элементов, используя кеширование для повышения производительности.
    *   Получает список элементов для нормализации.
    *   Использует запросы к LLM для нормализации элементов, не найденных в кэше.
    *   Сохраняет нормализованные элементы в кэше.
    *   Возвращает нормализованный элемент или список нормализованных элементов.

Этот модуль демонстрирует использование LLM (OpenAI) для решения задач экстракции и нормализации данных, а также методы обработки различных форматов файлов, включая поддержку Markdown и DOCX.