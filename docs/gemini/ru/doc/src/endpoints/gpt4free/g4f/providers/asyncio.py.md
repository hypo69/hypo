# Модуль для работы с асинхронностью

## Обзор

Модуль предоставляет набор утилит для работы с асинхронным кодом, включая обработку событийных циклов, асинхронных генераторов и итераторов. Он включает функции для получения текущего запущенного цикла событий, преобразования асинхронных генераторов в синхронные и наоборот, а также для безопасного завершения асинхронных задач.

## Подробней

Этот модуль предоставляет инструменты для упрощения работы с асинхронным кодом, особенно в случаях, когда требуется взаимодействие между асинхронными и синхронными частями программы. Он также обрабатывает потенциальные проблемы, такие как вложенные асинхронные циклы и незавершенные асинхронные генераторы.

## Функции

### `get_running_loop`

```python
def get_running_loop(check_nested: bool) -> Optional[AbstractEventLoop]:
    """
    Получает текущий запущенный цикл событий.

    Args:
        check_nested (bool): Если `True`, проверяет, поддерживается ли вложенность асинхронных циклов.

    Returns:
        Optional[AbstractEventLoop]: Текущий запущенный цикл событий или `None`, если цикл не запущен.

    Raises:
        NestAsyncioError: Если `check_nested` равен `True`, и не установлен пакет `nest_asyncio`.

    Как работает функция:
    1. Пытается получить текущий запущенный цикл событий с помощью `asyncio.get_running_loop()`.
    2. Если цикл является экземпляром `uvloop.Loop` (и `has_uvloop` равен `True`), возвращает его.
    3. Если цикл не имеет атрибута `_nest_patched`, пытается применить патч `nest_asyncio`, если `has_nest_asyncio` равен `True`.
    4. Если `check_nested` равен `True`, и `nest_asyncio` не установлен, вызывает исключение `NestAsyncioError`.
    5. Если не удается получить цикл (вызывается `RuntimeError`), возвращает `None`.

    Схема работы:
    Получение текущего цикла событий
    │
    ├── Проверка на uvloop -> Возврат uvloop.Loop
    │
    └── Применение патча nest_asyncio (если необходимо) -> Возврат цикла
    │
    └── Генерация NestAsyncioError (если check_nested и nest_asyncio не установлены)
    │
    └── Вернуть None (если RuntimeError)

    Примеры:
    >>> loop = get_running_loop(check_nested=False)
    >>> if loop:
    ...     print(f"Текущий цикл событий: {loop}")
    """
```

### `await_callback`

```python
async def await_callback(callback: Callable):
    """
    Ожидает выполнения переданной функции обратного вызова.

    Args:
        callback (Callable): Асинхронная функция обратного вызова.

    Returns:
        Any: Результат выполнения функции обратного вызова.

    Как работает функция:
    1. Принимает асинхронную функцию `callback`.
    2. Использует `await` для ожидания выполнения этой функции.
    3. Возвращает результат выполнения функции.

    Схема работы:
    Асинхронная функция обратного вызова
    │
    └── Ожидание выполнения функции -> Возврат результата

    Примеры:
    >>> async def my_callback():
    ...     return "Привет из асинхронной функции!"
    >>> result = asyncio.run(await_callback(my_callback))
    >>> print(result)
    """
```

### `async_generator_to_list`

```python
async def async_generator_to_list(generator: AsyncIterator) -> list:
    """
    Преобразует асинхронный генератор в список.

    Args:
        generator (AsyncIterator): Асинхронный генератор.

    Returns:
        list: Список элементов, сгенерированных асинхронным генератором.

    Как работает функция:
    1. Принимает асинхронный генератор `generator`.
    2. Использует асинхронное включение списка для итерации по генератору и сбора элементов в список.
    3. Возвращает полученный список.

    Схема работы:
    Асинхронный генератор
    │
    └── Асинхронная итерация -> Сбор элементов в список -> Возврат списка

    Примеры:
    >>> async def my_generator():
    ...     for i in range(3):
    ...         yield i
    >>> result = asyncio.run(async_generator_to_list(my_generator()))
    >>> print(result)
    """
```

### `to_sync_generator`

```python
def to_sync_generator(generator: AsyncIterator, stream: bool = True) -> Iterator:
    """
    Преобразует асинхронный генератор в синхронный генератор.

    Args:
        generator (AsyncIterator): Асинхронный генератор.
        stream (bool, optional): Если `True`, возвращает элементы по мере их генерации.
                                 Если `False`, возвращает все элементы сразу после завершения генерации. По умолчанию `True`.

    Returns:
        Iterator: Синхронный генератор, возвращающий элементы из асинхронного генератора.

    Как работает функция:
    1. Получает текущий запущенный цикл событий, используя `get_running_loop(check_nested=False)`.
    2. Если `stream` равен `False`, запускает асинхронный генератор и возвращает все элементы в виде списка, используя `asyncio.run(async_generator_to_list(generator))`.
    3. Если цикл событий не запущен, создает новый цикл и устанавливает его как текущий.
    4. Итерируется по асинхронному генератору, используя `loop.run_until_complete(await_callback(gen.__anext__))` для получения следующего элемента.
    5. Останавливает и закрывает цикл событий после завершения генерации.

    Схема работы:
    Асинхронный генератор
    │
    ├── stream = False -> Преобразование в список (asyncio.run(async_generator_to_list)) -> Возврат списка в виде синхронного генератора
    │
    └── stream = True -> Получение или создание цикла событий
    │   │
    │   └── Итерация по асинхронному генератору (loop.run_until_complete(await_callback(gen.__anext__))) -> Возврат элементов синхронно
    │
    └── Закрытие цикла событий (если был создан)

    Примеры:
    >>> async def my_generator():
    ...     for i in range(3):
    ...         yield i
    >>> sync_generator = to_sync_generator(my_generator())
    >>> for item in sync_generator:
    ...     print(item)
    """
```

### `to_async_iterator`

```python
async def to_async_iterator(iterator) -> AsyncIterator:
    """
    Преобразует синхронный итератор или корутину в асинхронный итератор.

    Args:
        iterator: Синхронный итератор или корутина.

    Returns:
        AsyncIterator: Асинхронный итератор, возвращающий элементы из исходного итератора или корутины.

    Как работает функция:

    1. Проверяет, является ли входной `iterator` асинхронным итератором (имеет метод `__aiter__`). Если да, то асинхронно перебирает его элементы и возвращает их.
    2. Если `iterator` является корутиной (определяется с помощью `asyncio.iscoroutine`), ожидает её выполнения (`await iterator`) и возвращает результат.
    3. В противном случае, если `iterator` является синхронным итератором, перебирает его элементы синхронно и возвращает их.

    Схема работы:

    Входной итератор/корутина
    │
    ├── Проверка на асинхронный итератор (наличие __aiter__) -> Асинхронная итерация и возврат элементов
    │
    ├── Проверка на корутину (asyncio.iscoroutine) -> Ожидание выполнения корутины и возврат результата
    │
    └── Синхронная итерация и возврат элементов

    Примеры:

    1. Преобразование синхронного итератора в асинхронный:
       ```python
       async def main():
           sync_list = [1, 2, 3]
           async_iterator = to_async_iterator(sync_list)
           async for item in async_iterator:
               print(item)
       asyncio.run(main())
       ```

    2. Преобразование корутины в асинхронный итератор:
       ```python
       async def my_coroutine():
           return "Hello"

       async def main():
           async_iterator = to_async_iterator(my_coroutine())
           async for item in async_iterator:
               print(item)
       asyncio.run(main())
       ```
    """