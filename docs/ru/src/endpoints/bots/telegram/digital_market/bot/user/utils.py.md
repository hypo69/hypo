# Модуль `utils.py` для обработки успешных платежей в Telegram боте

## Обзор

Модуль `utils.py` содержит функции, необходимые для обработки успешных платежей в Telegram боте цифрового рынка. Он включает логику добавления информации о покупке в базу данных, отправки уведомлений администраторам и предоставления информации о товаре пользователю. Модуль использует асинхронные функции для эффективного взаимодействия с базой данных и Telegram API.

## Подробнее

Этот модуль играет ключевую роль в завершении процесса покупки в боте. Он обеспечивает запись данных о платеже, информирование заинтересованных сторон (администраторов и пользователей) и предоставление доступа к приобретенному контенту или информации. Использование `PurchaseDao` и `ProductDao` позволяет абстрагироваться от конкретной реализации базы данных, а применение `AsyncSession` обеспечивает асинхронность операций.

## Функции

### `successful_payment_logic`

```python
async def successful_payment_logic(session: AsyncSession, payment_data, currency, user_tg_id, bot: Bot):
    """Обрабатывает логику успешной оплаты, добавляет данные о покупке в БД, отправляет уведомления и информацию пользователю.

    Args:
        session (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных.
        payment_data: Данные о платеже.
        currency: Валюта платежа.
        user_tg_id: ID пользователя в Telegram.
        bot (Bot): Экземпляр бота aiogram для отправки сообщений.

    Returns:
        None

    Raises:
        Exception: Если происходит ошибка при отправке уведомления администраторам.

    """
```

**Назначение**: Обработка логики, связанной с успешным завершением платежа.

**Параметры**:
- `session` (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных.
- `payment_data` (Any): Данные о платеже, полученные от платежной системы. Ожидается, что `payment_data` является словарем.
- `currency` (str): Валюта, в которой был произведен платеж.
- `user_tg_id` (int): Telegram ID пользователя, совершившего покупку.
- `bot` (Bot): Экземпляр Telegram бота, используемый для отправки уведомлений и сообщений.

**Возвращает**:
- `None`: Функция ничего не возвращает явно, но выполняет ряд действий по обработке платежа.

**Вызывает исключения**:
- `Exception`: Может возникнуть при отправке уведомлений администраторам, обрабатывается внутри функции с помощью `logger.error`.

**Как работает функция**:

1.  **Извлечение данных о продукте**: Извлекает `product_id`, `price`, `payment_type`, `payment_id` и `user_id` из `payment_data`.
2.  **Добавление информации о покупке в БД**: Добавляет информацию о платеже в базу данных с помощью `PurchaseDao.add`.
3.  **Получение информации о продукте**: Получает данные о продукте из базы данных с помощью `ProductDao.find_one_or_none_by_id`.
4.  **Отправка уведомлений администраторам**: Отправляет уведомления администраторам о совершенной покупке. В случае ошибки логирует её.
5.  **Отправка информации пользователю**: Формирует текст сообщения с информацией о покупке и отправляет его пользователю. Если у продукта есть файл, отправляет файл с подписью, иначе отправляет только текст.
6.  **Автоматический возврат звезд за покупку**: Если тип оплаты - "stars", то производится возврат звезд пользователю.

**ASII flowchart**:

```
Начало --> Извлечение данных о продукте
    |
    --> Добавление информации о покупке в БД
    |
    --> Получение информации о продукте
    |
    --> Отправка уведомлений администраторам (с обработкой ошибок)
    |
    --> Формирование и отправка информации пользователю (текст или файл)
    |
    --> Если тип оплаты "stars" -> Автоматический возврат звезд за покупку
    |
    Конец
```

**Примеры**:

```python
# Пример вызова функции
await successful_payment_logic(
    session=db_session,
    payment_data={
        "product_id": 123,
        "price": 100,
        "payment_type": "card",
        "payment_id": "payment123",
        "user_id": 456
    },
    currency="USD",
    user_tg_id=789,
    bot=telegram_bot
)

# Пример вызова с оплатой звездами
await successful_payment_logic(
    session=db_session,
    payment_data={
        "product_id": 456,
        "price": 50,
        "payment_type": "stars",
        "payment_id": "payment456",
        "user_id": 123
    },
    currency="STARS",
    user_tg_id=456,
    bot=telegram_bot
)