# Модуль взаимодействия с chatbot.theb.ai

## Обзор

Модуль предназначен для взаимодействия с API chatbot.theb.ai с целью получения ответов на текстовые запросы. Он отправляет POST-запросы к API и обрабатывает получаемые чанки данных, извлекая из них полезную информацию.

## Подробнее

Этот модуль используется для отправки запросов к chatbot.theb.ai и получения сгенерированного текста в режиме реального времени. Он обрабатывает ответы от сервера по частям, извлекая контент из каждого чанка и выводя его на экран. В случае возникновения ошибок, модуль автоматически повторяет попытки отправки запроса.

## Функции

### `format`

```python
def format(chunk):
    """
    Извлекает и печатает контент из чанка данных, полученного от сервера.

    Args:
        chunk: Чанк данных, полученный от сервера.

    Returns:
        None

    Raises:
        Exception: Если не удается извлечь контент из чанка.

    Example:
        >>> chunk = b'{"content":"Пример текста"}'
        >>> format(chunk)
        Пример текста
    """
```

**Как работает функция**:

1.  **Извлечение контента**: Функция пытается извлечь контент из предоставленного чанка данных, используя регулярное выражение `r'content":"(.*)"},"fin'`.
2.  **Вывод контента**: Если контент успешно извлечен, он выводится в стандартный поток вывода с использованием `print(completion_chunk, flush=True, end='')`.
3.  **Обработка ошибок**: Если возникает исключение при извлечении контента, функция выводит сообщение об ошибке и возвращается.

```
    Чанк данных
    │
    └── Поиск контента с использованием регулярного выражения
    │
    ├── Успешно: Извлечение контента
    │   │
    │   └── Вывод контента в стандартный поток вывода
    │
    └── Ошибка: Исключение при извлечении контента
        │
        └── Вывод сообщения об ошибке
```

**Примеры**:

Пример 1: Успешное извлечение контента

```python
chunk = b'{"content":"Hello World!"},"fin'
format(chunk)  # Выведет: Hello World!
```

Пример 2: Неудачное извлечение контента

```python
chunk = b'{"error":"Some error"}'
format(chunk)  # Выведет: [ERROR] an error occured, retrying... | [[b'{"error":"Some error"}']]
```

## Основной цикл обработки запросов

Основной цикл `while True` выполняет следующие действия:

1.  **Отправка запроса**: Отправляет POST-запрос к `https://chatbot.theb.ai/api/chat-process` с использованием библиотеки `curl_cffi`.
2.  **Обработка ответа**: Функция `format` вызывается для каждого чанка данных, полученного в ответе от сервера.
3.  **Выход при успехе**: Если запрос выполнен успешно, программа завершается с кодом 0.
4.  **Обработка ошибок**: Если возникает исключение при отправке запроса, выводится сообщение об ошибке, и цикл повторяется.

```
Начало цикла
│
└── Отправка POST-запроса к API
│
├── Успех: Запрос выполнен успешно
│   │
│   └── Завершение программы
│
└── Ошибка: Исключение при отправке запроса
    │
    └── Вывод сообщения об ошибке
    │
    └── Повтор цикла