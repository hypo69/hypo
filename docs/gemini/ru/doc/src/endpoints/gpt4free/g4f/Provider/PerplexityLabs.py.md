# Модуль `PerplexityLabs.py`

## Обзор

Модуль предназначен для взаимодействия с Perplexity Labs, предоставляя асинхронный генератор для получения ответов от моделей Perplexity AI. Он поддерживает различные модели, такие как `r1-1776`, `sonar-pro`, `sonar` и другие. Модуль использует WebSocket для установления соединения и обмена сообщениями с сервером Perplexity AI.

## Подробней

Этот модуль позволяет отправлять запросы к Perplexity Labs и получать ответы в асинхронном режиме. Он обрабатывает установление соединения, отправку сообщений и получение ответов через WebSocket. Модуль также обеспечивает поддержку прокси и обработку ошибок.

## Классы

### `PerplexityLabs`

**Описание**: Класс `PerplexityLabs` является асинхронным генератором провайдером и предоставляет методы для взаимодействия с Perplexity Labs API.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL Perplexity Labs.
- `working` (bool): Указывает, работает ли провайдер.
- `default_model` (str): Модель, используемая по умолчанию (`r1-1776`).
- `models` (list[str]): Список поддерживаемых моделей.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от Perplexity Labs.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от Perplexity Labs.

    Args:
        model (str): Название модели для использования.
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, предоставляющий ответы от Perplexity Labs.

    Raises:
        ResponseError: Если возникает ошибка при обработке ответа от сервера.
        RuntimeError: При возникновении неизвестной ошибки.

    Внутренние функции:
        Нет внутренних функций.
    """
```

**Назначение**:
Создает асинхронный генератор для взаимодействия с Perplexity Labs и получения ответов от выбранной модели на основе предоставленных сообщений.

**Параметры**:
- `cls`: Ссылка на класс `PerplexityLabs`.
- `model` (str): Имя модели, которую нужно использовать для генерации ответа.
- `messages (Messages)`: Список сообщений для отправки в Perplexity Labs.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который предоставляет ответы от Perplexity Labs.

**Вызывает исключения**:
- `ResponseError`: Возникает, когда происходит ошибка при обработке ответа от сервера.
- `RuntimeError`: Возникает при неизвестной ошибке.

**Как работает функция**:

1. **Настройка заголовков**: Определяются заголовки запроса, включая `Origin` и `Referer`.
2. **Создание асинхронной сессии**: Используется `StreamSession` для создания асинхронной сессии с поддержкой прокси и имитацией браузера Chrome.
3. **Получение SID**: Выполняется GET-запрос к API для получения идентификатора сессии (`sid`).
4. **Авторизация**: Выполняется POST-запрос для авторизации с использованием JWT.
5. **Установка WebSocket соединения**: Устанавливается WebSocket соединение с сервером Perplexity Labs.
6. **Обмен сообщениями**: Отправляются probe-сообщения для установления соединения.
7. **Отправка данных**: Отправляются сообщения пользователя в формате JSON.
8. **Получение ответов**: В цикле принимаются сообщения от сервера, извлекаются данные и передаются через генератор.
9. **Обработка ошибок**: Обрабатываются ошибки, возникающие при получении и обработке сообщений.
10. **Завершение**: Генератор завершается после получения финального сообщения от сервера.

```
Настройка заголовков -> Создание асинхронной сессии -> Получение SID
↓
Авторизация -> Установка WebSocket соединения -> Обмен сообщениями
↓
Отправка данных -> Получение ответов -> Обработка ошибок
↓
Завершение
```

**Примеры**:

```python
# Пример использования create_async_generator
messages = [{"role": "user", "content": "Hello, Perplexity Labs!"}]
model = "r1-1776"
proxy = "http://your_proxy:8080"

async def main():
    async for message in PerplexityLabs.create_async_generator(model=model, messages=messages, proxy=proxy):
        print(message)

# Запуск примера
# import asyncio
# asyncio.run(main())