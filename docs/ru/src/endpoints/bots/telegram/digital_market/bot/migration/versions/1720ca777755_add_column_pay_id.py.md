# Модуль миграции Alembic для добавления колонки `payment_id` в таблицу `purchases`

## Обзор

Этот модуль содержит скрипт миграции Alembic, который добавляет столбец `payment_id` в таблицу `purchases`. Скрипт включает логику для обновления базы данных до последней версии и отката изменений в случае необходимости.

## Подробней

Этот скрипт Alembic предназначен для управления изменениями схемы базы данных. Он автоматически добавляет столбец `payment_id` в таблицу `purchases`, если он еще не существует, и создает уникальный индекс для этого столбца. Скрипт также содержит логику для отката этих изменений, если это необходимо.

## Функции

### `upgrade`

```python
def upgrade() -> None:
    """Добавляет столбец 'payment_id' в таблицу 'purchases', если он еще не существует.

    Args:
        None

    Returns:
        None

    Raises:
        sqlalchemy.exc.SQLAlchemyError: В случае ошибки при выполнении операций с базой данных.

    Как работает функция:
    1. Функция получает соединение с базой данных, используя `op.get_bind()`.
    2. Выполняется запрос `PRAGMA table_info('purchases')` для получения информации о столбцах в таблице `purchases`.
    3. Проверяется, существует ли столбец `payment_id` в таблице.
    4. Если столбец `payment_id` не существует, он добавляется с помощью `op.add_column()`, устанавливается тип `sa.String()` и `nullable=False`.
    5. Создается уникальное ограничение для столбца `payment_id` с помощью `op.create_unique_constraint()`.
    6. Если столбец `payment_id` уже существует, выводится сообщение "Колонка 'payment_id' уже существует, пропускаем добавление".

    Блок-схема работы функции:

    Получение соединения с БД -> Получение информации о столбцах таблицы -> Проверка существования столбца 'payment_id' ->
    |                                                                                                       |
    Нет -> Добавление столбца 'payment_id' -> Создание уникального ограничения 'uq_purchases_payment_id'      |
    |                                                                                                       |
    Да -> Вывод сообщения "Колонка 'payment_id' уже существует, пропускаем добавление"

    Примеры:
        При успешном выполнении, функция добавляет столбец 'payment_id' в таблицу 'purchases' и создает уникальное ограничение для этого столбца.
        Если столбец 'payment_id' уже существует, функция выводит сообщение и не вносит изменений в таблицу.
    """
    ...
```

### `downgrade`

```python
def downgrade() -> None:
    """Удаляет столбец 'payment_id' из таблицы 'purchases', если он существует.

    Args:
        None

    Returns:
        None

    Raises:
        sqlalchemy.exc.SQLAlchemyError: В случае ошибки при выполнении операций с базой данных.

    Как работает функция:
    1. Функция получает соединение с базой данных, используя `op.get_bind()`.
    2. Выполняется запрос `PRAGMA table_info('purchases')` для получения информации о столбцах в таблице `purchases`.
    3. Проверяется, существует ли столбец `payment_id` в таблице.
    4. Если столбец `payment_id` существует, удаляется уникальное ограничение `uq_purchases_payment_id` с помощью `op.drop_constraint()`.
    5. Удаляется столбец `payment_id` с помощью `op.drop_column()`.
    6. Если столбец `payment_id` не существует, выводится сообщение "Колонка 'payment_id' не существует, пропускаем удаление".

    Блок-схема работы функции:

    Получение соединения с БД -> Получение информации о столбцах таблицы -> Проверка существования столбца 'payment_id' ->
    |                                                                                                    |
    Да -> Удаление уникального ограничения 'uq_purchases_payment_id' -> Удаление столбца 'payment_id'     |
    |                                                                                                    |
    Нет -> Вывод сообщения "Колонка 'payment_id' не существует, пропускаем удаление"

    Примеры:
        При успешном выполнении, функция удаляет столбец 'payment_id' из таблицы 'purchases' и удаляет уникальное ограничение для этого столбца.
        Если столбец 'payment_id' не существует, функция выводит сообщение и не вносит изменений в таблицу.
    """
    ...