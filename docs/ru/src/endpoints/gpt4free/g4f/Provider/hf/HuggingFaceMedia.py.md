# Модуль HuggingFaceMedia

## Обзор

Модуль `HuggingFaceMedia` предназначен для взаимодействия с сервисом HuggingFace для генерации изображений и видео на основе текстовых запросов. Он предоставляет асинхронный интерфейс для работы с различными моделями и провайдерами, поддерживаемыми HuggingFace. Модуль поддерживает выбор модели, настройку параметров генерации (таких как соотношение сторон, разрешение) и обработку ответов от API.

## Подробней

Этот модуль является частью проекта `hypotez` и обеспечивает функциональность генерации медиа-контента (изображений и видео) на основе текстовых запросов, используя API HuggingFace. Он абстрагирует детали взаимодействия с различными провайдерами и моделями, предоставляя единый интерфейс для пользователей.

Модуль `HuggingFaceMedia` позволяет пользователям выбирать конкретную модель и провайдера для генерации медиа-контента, а также настраивать параметры генерации, такие как соотношение сторон, разрешение и другие параметры, специфичные для каждой модели. Он также обеспечивает обработку ошибок и исключений, а также логирование информации о процессе генерации.

## Классы

### `HuggingFaceMedia`

**Описание**: Класс `HuggingFaceMedia` является основным классом для взаимодействия с API HuggingFace для генерации изображений и видео.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Позволяет работать с различными моделями.

**Атрибуты**:
- `label` (str): Метка провайдера (по умолчанию "HuggingFace (Image/Video Generation)").
- `parent` (str): Родительский провайдер (по умолчанию "HuggingFace").
- `url` (str): URL сервиса HuggingFace (по умолчанию "https://huggingface.co").
- `working` (bool): Флаг, указывающий, работает ли провайдер (по умолчанию `True`).
- `needs_auth` (bool): Флаг, указывающий, требуется ли аутентификация (по умолчанию `True`).
- `tasks` (List[str]): Список поддерживаемых задач (по умолчанию `["text-to-image", "text-to-video"]`).
- `provider_mapping` (Dict[str, Dict]): Словарь, содержащий соответствия между моделями и провайдерами.
- `task_mapping` (Dict[str, str]): Словарь, содержащий соответствия между моделями и задачами.
- `models` (List[str]): Список доступных моделей.
- `image_models` (List[str]): Список моделей для генерации изображений.
- `video_models` (List[str]): Список моделей для генерации видео.

**Методы**:
- `get_models(**kwargs) -> list[str]`: Возвращает список доступных моделей.
- `get_mapping(model: str, api_key: str = None) -> dict`: Получает соответствие между моделями и провайдерами.
- `create_async_generator(...)`: Создает асинхронный генератор для генерации медиа-контента.

## Функции

### `get_models`

```python
    @classmethod
    def get_models(cls, **kwargs) -> list[str]:
        """Получает список доступных моделей из API HuggingFace.

        Args:
            **kwargs: Дополнительные аргументы.

        Returns:
            list[str]: Список доступных моделей.
        """
```

**Назначение**: Получение списка доступных моделей из API HuggingFace.

**Параметры**:
- `**kwargs`: Дополнительные аргументы, которые могут быть переданы в функцию.

**Возвращает**:
- `list[str]`: Список доступных моделей.

**Как работает функция**:
1. Проверяет, был ли уже получен список моделей. Если да, возвращает его.
2. Если список моделей не был получен, выполняет запрос к API HuggingFace для получения списка моделей и их провайдеров.
3. Фильтрует модели, оставляя только те, которые поддерживают задачи генерации изображений или видео.
4. Формирует список моделей, добавляя информацию о провайдерах для каждой модели.
5. Сохраняет список моделей в атрибуте класса `models`.
6. Формирует списки моделей для генерации изображений и видео.
7. Возвращает список доступных моделей.

```
A - Проверка наличия моделей
|
-- B - Получение моделей из API HuggingFace
|  |
|  C - Фильтрация моделей по задачам
|  |
|  D - Формирование списка моделей с провайдерами
|  |
|  E - Сохранение списка моделей
|  |
|  F - Формирование списков моделей для изображений и видео
|
G - Возврат списка моделей
```

**Примеры**:
```python
models = HuggingFaceMedia.get_models()
print(models)
```

### `get_mapping`

```python
    @classmethod
    async def get_mapping(cls, model: str, api_key: str = None) -> dict:
        """Получает соответствие между моделью и провайдерами из API HuggingFace.

        Args:
            model (str): Название модели.
            api_key (str, optional): API ключ. По умолчанию `None`.

        Returns:
            dict: Соответствие между моделью и провайдерами.
        """
```

**Назначение**: Получение соответствия между моделью и провайдерами из API HuggingFace.

**Параметры**:
- `model` (str): Название модели.
- `api_key` (str, optional): API ключ. По умолчанию `None`.

**Возвращает**:
- `dict`: Соответствие между моделью и провайдерами.

**Как работает функция**:
1. Проверяет, было ли уже получено соответствие для данной модели. Если да, возвращает его.
2. Если соответствие не было получено, выполняет запрос к API HuggingFace для получения информации о модели и ее провайдерах.
3. Фильтрует провайдеров, оставляя только те, которые находятся в статусе "live".
4. Сохраняет соответствие в атрибуте класса `provider_mapping`.
5. Возвращает соответствие между моделью и провайдерами.

```
A - Проверка наличия соответствия
|
-- B - Получение соответствия из API HuggingFace
|  |
|  C - Фильтрация провайдеров по статусу
|  |
|  D - Сохранение соответствия
|
E - Возврат соответствия
```

**Примеры**:
```python
mapping = await HuggingFaceMedia.get_mapping(model="stable-diffusion-v1-5", api_key="YOUR_API_KEY")
print(mapping)
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        api_key: str = None,
        extra_data: dict = {},
        prompt: str = None,
        proxy: str = None,
        timeout: int = 0,
        # Video & Image Generation
        n: int = 1,
        aspect_ratio: str = None,
        # Only for Image Generation
        height: int = None,
        width: int = None,
        # Video Generation
        resolution: str = "480p",
        **kwargs
    ):
        """Создает асинхронный генератор для генерации медиа-контента.

        Args:
            model (str): Название модели.
            messages (Messages): Список сообщений.
            api_key (str, optional): API ключ. По умолчанию `None`.
            extra_data (dict, optional): Дополнительные данные. По умолчанию `{}`.
            prompt (str, optional): Текстовый запрос. По умолчанию `None`.
            proxy (str, optional): Прокси-сервер. По умолчанию `None`.
            timeout (int, optional): Время ожидания. По умолчанию `0`.
            n (int, optional): Количество сгенерированных элементов. По умолчанию `1`.
            aspect_ratio (str, optional): Соотношение сторон. По умолчанию `None`.
            height (int, optional): Высота изображения. По умолчанию `None`.
            width (int, optional): Ширина изображения. По умолчанию `None`.
            resolution (str, optional): Разрешение видео. По умолчанию `"480p"`.
            **kwargs: Дополнительные аргументы.

        Yields:
            ProviderInfo: Информация о провайдере.
            ImageResponse | VideoResponse | Reasoning: Ответ от API.
        """
```

**Назначение**: Создание асинхронного генератора для генерации медиа-контента (изображений и видео) на основе текстового запроса.

**Параметры**:
- `model` (str): Название модели для генерации контента. Может включать имя провайдера (например, "model:provider").
- `messages` (Messages): Список сообщений, используемых для формирования запроса.
- `api_key` (str, optional): API-ключ для доступа к сервису Hugging Face. По умолчанию `None`.
- `extra_data` (dict, optional): Дополнительные параметры, передаваемые в запрос. По умолчанию `{}`.
- `prompt` (str, optional): Текстовый запрос для генерации контента. По умолчанию `None`.
- `proxy` (str, optional): Адрес прокси-сервера для выполнения запроса. По умолчанию `None`.
- `timeout` (int, optional): Максимальное время ожидания ответа от сервера. По умолчанию `0`.
- `n` (int, optional): Количество контента для генерации. По умолчанию `1`.
- `aspect_ratio` (str, optional): Соотношение сторон для генерируемого контента. По умолчанию `None`.
- `height` (int, optional): Высота генерируемого изображения (только для изображений). По умолчанию `None`.
- `width` (int, optional): Ширина генерируемого изображения (только для изображений). По умолчанию `None`.
- `resolution` (str, optional): Разрешение генерируемого видео (только для видео). По умолчанию `"480p"`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `ProviderInfo`: Информация о провайдере, который использовался для генерации контента.
- `ImageResponse | VideoResponse | Reasoning`: Сгенерированный контент (изображение или видео) или информация о процессе генерации.

**Как работает функция**:
1.  **Разделение модели и провайдера**: Если в параметре `model` указан провайдер (например, "model:provider"), происходит разделение имени модели и провайдера.
2.  **Формирование текстового запроса**: Преобразует список сообщений `messages` в текстовый запрос `prompt` с использованием функции `format_image_prompt`.
3.  **Получение соответствия между моделью и провайдерами**: Получает информацию о доступных провайдерах для указанной модели с использованием функции `cls.get_mapping`.
4.  **Определение функции `generate`**: Определяет внутреннюю асинхронную функцию `generate`, которая выполняет запрос к API Hugging Face для генерации контента.
    *   **Выбор провайдера**: Перебирает доступных провайдеров и выбирает того, который соответствует указанному в параметре `model` (если он был указан).
    *   **Формирование URL и данных запроса**: Формирует URL и данные запроса в зависимости от выбранного провайдера и задачи (генерация изображения или видео).
    *   **Выполнение запроса**: Выполняет POST-запрос к API Hugging Face с использованием `StreamSession`.
    *   **Обработка ответа**: Обрабатывает ответ от API, проверяет наличие ошибок и возвращает сгенерированный контент (изображение или видео) или информацию о процессе генерации.
5.  **Запуск задач генерации**: Запускает несколько асинхронных задач для генерации контента в соответствии с параметром `n`.
6.  **Ожидание завершения задач**: Ожидает завершения всех задач генерации, периодически выводя информацию о процессе генерации.
7.  **Возврат результатов**: Возвращает результаты генерации контента (информацию о провайдере, сгенерированный контент и информацию о процессе генерации).

```
A - Разделение модели и провайдера (если указан)
↓
B - Формирование текстового запроса
↓
C - Получение соответствия между моделью и провайдерами
↓
D - Определение внутренней функции `generate`
    ↓
    E - Выбор провайдера
    ↓
    F - Формирование URL и данных запроса
    ↓
    G - Выполнение запроса к API Hugging Face
    ↓
    H - Обработка ответа от API
↓
I - Запуск задач генерации
↓
J - Ожидание завершения задач
↓
K - Возврат результатов
```

**Примеры**:

Пример генерации изображения с использованием модели `stable-diffusion-v1-5`:

```python
messages = [{"role": "user", "content": "A cat wearing a hat"}]
async for response in HuggingFaceMedia.create_async_generator(model="stable-diffusion-v1-5", messages=messages):
    print(response)
```

Пример генерации видео с использованием модели `text-to-video-ms-1.7b`:

```python
messages = [{"role": "user", "content": "A dog running in a park"}]
async for response in HuggingFaceMedia.create_async_generator(model="text-to-video-ms-1.7b", messages=messages):
    print(response)