# Модуль для работы с Dynaspark API
=======================================

Модуль предоставляет асинхронный генератор для взаимодействия с Dynaspark API, позволяющий генерировать ответы на основе предоставленных сообщений, поддерживая передачу изображений.

## Обзор

Модуль `Dynaspark` является частью проекта `hypotez` и предназначен для работы с API Dynaspark. Он предоставляет возможность отправлять запросы к Dynaspark API для генерации ответов на основе текстовых сообщений и изображений. Модуль поддерживает асинхронную работу и потоковую передачу данных, что позволяет эффективно обрабатывать большие объемы информации.

## Подробнее

Модуль `Dynaspark` использует библиотеку `aiohttp` для выполнения асинхронных HTTP-запросов. Он формирует данные запроса в формате `FormData`, что позволяет передавать как текстовые данные, так и изображения. Модуль также включает функции для форматирования запросов и обработки ответов от API Dynaspark.
Модуль предназначен для интеграции с другими частями проекта `hypotez`, где требуется взаимодействие с Dynaspark API для генерации контента на основе текстовых и графических данных.

## Классы

### `Dynaspark`

**Описание**: Класс `Dynaspark` предоставляет методы для взаимодействия с Dynaspark API. Он поддерживает асинхронную генерацию ответов на основе текстовых сообщений и изображений.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Аттрибуты**:
- `url` (str): URL Dynaspark.
- `login_url` (str | None): URL для логина (в данном случае `None`).
- `api_endpoint` (str): URL API Dynaspark для генерации ответов.
- `working` (bool): Указывает, работает ли провайдер (в данном случае `True`).
- `needs_auth` (bool): Указывает, требуется ли аутентификация (в данном случае `False`).
- `use_nodriver` (bool): Указывает, используется ли драйвер (в данном случае `True`).
- `supports_stream` (bool): Указывает, поддерживает ли потоковую передачу (в данном случае `True`).
- `supports_system_message` (bool): Указывает, поддерживает ли системные сообщения (в данном случае `False`).
- `supports_message_history` (bool): Указывает, поддерживает ли историю сообщений (в данном случае `False`).
- `default_model` (str): Модель, используемая по умолчанию (`gemini-1.5-flash`).
- `default_vision_model` (str): Модель для обработки изображений по умолчанию (`gemini-1.5-flash`).
- `vision_models` (list[str]): Список поддерживаемых моделей для обработки изображений.
- `models` (list[str]): Список поддерживаемых моделей.
- `model_aliases` (dict[str, str]): Словарь с псевдонимами моделей.

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        media: MediaListType = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для получения ответов от Dynaspark API.

        Args:
            model (str): Имя используемой модели.
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            media (MediaListType, optional): Список медиафайлов для отправки. По умолчанию `None`.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий ответы от API.
        
        """
```

**Назначение**: Создает асинхронный генератор для взаимодействия с Dynaspark API и получения ответов на основе предоставленных сообщений и медиафайлов.

**Параметры**:
- `model` (str): Имя модели, которую следует использовать для генерации ответа.
- `messages` (Messages): Список сообщений, которые будут отправлены в API для получения ответа.
- `proxy` (str, optional): URL прокси-сервера, если необходимо использовать прокси для подключения к API. По умолчанию `None`.
- `media` (MediaListType, optional): Список медиафайлов (например, изображений), которые будут отправлены в API вместе с сообщениями. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который возвращает ответы от API.

**Как работает функция**:

1. **Подготовка заголовков**: Функция начинает с подготовки заголовков HTTP-запроса, включая `accept`, `accept-language`, `origin`, `referer`, `user-agent` и `x-requested-with`. Эти заголовки используются для имитации запроса от веб-браузера.
2. **Создание сессии `aiohttp`**: Далее, создается асинхронная сессия `aiohttp.ClientSession` с использованием подготовленных заголовков. Эта сессия будет использоваться для отправки HTTP-запроса к API Dynaspark.
3. **Формирование данных запроса**: Создается объект `FormData` из библиотеки `aiohttp`, который будет содержать данные, отправляемые в запросе. В `FormData` добавляются следующие поля:
   - `user_input`: Форматированный промпт, полученный из списка сообщений `messages` с помощью функции `format_prompt`.
   - `ai_model`: Имя модели, указанное в параметре `model`.
   - `file`: Если предоставлены медиафайлы (параметр `media` не `None` и содержит хотя бы один элемент), первый медиафайл преобразуется в байты с помощью функции `to_bytes` и добавляется в `FormData` с указанием имени файла и типа контента.
4. **Отправка запроса и обработка ответа**: Используя асинхронную сессию, отправляется POST-запрос к API Dynaspark по адресу `cls.api_endpoint`. В запросе передаются данные `FormData` и, если указано, прокси-сервер.
5. **Обработка ответа**: После получения ответа от API, функция проверяет статус ответа с помощью `raise_for_status`, чтобы убедиться, что запрос был успешным. Затем извлекается текстовое содержимое ответа и преобразуется в JSON-формат.
6. **Генерация ответа**: Из JSON-ответа извлекается поле `response`, которое содержит сгенерированный ответ от API. Этот ответ возвращается как значение асинхронного генератора с помощью `yield`.

**Внутренние функции**:
- Внутри функции `create_async_generator` нет внутренних функций.

**Flowchart**:

```
    Начало
      ↓
    [Подготовка заголовков]
      ↓
    [Создание асинхронной сессии aiohttp]
      ↓
    [Формирование данных запроса FormData]
      ↓
    [Отправка POST-запроса к API Dynaspark]
      ↓
    [Проверка статуса ответа]
      ↓
    [Извлечение текстового содержимого ответа]
      ↓
    [Преобразование ответа в JSON-формат]
      ↓
    [Извлечение поля 'response' из JSON]
      ↓
    [Генерация ответа через yield]
      ↓
    Конец
```

**Примеры**:

```python
# Пример 1: Создание асинхронного генератора с текстовым сообщением и моделью
model = "gemini-1.5-flash"
messages = [{"role": "user", "content": "Hello, how are you?"}]
generator = Dynaspark.create_async_generator(model=model, messages=messages)

# Пример 2: Создание асинхронного генератора с текстовым сообщением, моделью и прокси
model = "gemini-1.5-flash"
messages = [{"role": "user", "content": "Hello, how are you?"}]
proxy = "http://your-proxy-server:8080"
generator = Dynaspark.create_async_generator(model=model, messages=messages, proxy=proxy)

# Пример 3: Создание асинхронного генератора с текстовым сообщением, моделью и изображением
from io import BytesIO
from PIL import Image

model = "gemini-1.5-flash"
messages = [{"role": "user", "content": "Describe this image."}]
image = Image.new("RGB", (100, 100), color="red")
image_bytes = BytesIO()
image.save(image_bytes, format="PNG")
image_bytes = image_bytes.getvalue()
media = [(image_bytes, "image.png")]
generator = Dynaspark.create_async_generator(model=model, messages=messages, media=media)
```