### –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –º–æ–¥—É–ª—è `dao.py`

**–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞:**

- **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º**: 7/10
- **–ü–ª—é—Å—ã**:
    - –ö–æ–¥ —Ä–∞–∑–±–∏—Ç –Ω–∞ –∫–ª–∞—Å—Å—ã DAO –¥–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏.
    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
    - –ü—Ä–∏—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ –º–æ–¥–µ–ª—è–º.
    - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `selectinload` –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤.
- **–ú–∏–Ω—É—Å—ã**:
    - –ù–µ –≤–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `logger.error` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫.
    - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è f-—Å—Ç—Ä–æ–∫–∏ —Å –¥–≤–æ–π–Ω—ã–º–∏ –∫–∞–≤—ã—á–∫–∞–º–∏, —á—Ç–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç—É.
    - –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `print` –¥–ª—è –≤—ã–≤–æ–¥–∞ –æ—à–∏–±–æ–∫, –≤–º–µ—Å—Ç–æ `logger`.
    - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç RST –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –º–µ—Ç–æ–¥–æ–≤ –∏ –∫–ª–∞—Å—Å–æ–≤.
    - –ù–µ –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã –≤—ã—Ä–æ–≤–Ω–µ–Ω—ã –≤ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é:**

1.  **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
    - –î–æ–±–∞–≤–∏—Ç—å RST-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è –≤—Å–µ—Ö –∫–ª–∞—Å—Å–æ–≤ –∏ –º–µ—Ç–æ–¥–æ–≤, –æ–ø–∏—Å—ã–≤–∞—è –∏—Ö –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ, –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ –∏—Å–∫–ª—é—á–µ–Ω–∏—è.
2.  **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**:
    - –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ `print` –Ω–∞ `logger.error` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –æ—à–∏–±–æ–∫.
    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `logger.info` –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π.
3.  **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**:
    - –£–±—Ä–∞—Ç—å `try-except` –±–ª–æ–∫–∏ –≥–¥–µ –æ–Ω–∏ –Ω–µ –Ω–µ—Å—É—Ç –ø–æ–ª–µ–∑–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏.
4.  **–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
    - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è —Å—Ç—Ä–æ–∫ –≤ –∫–æ–¥–µ, –∫—Ä–æ–º–µ `print`, `input` –∏ `logger`.
    - –í—ã—Ä–æ–≤–Ω—è—Ç—å –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã –≤ –∞–ª—Ñ–∞–≤–∏—Ç–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ.
5.  **–ò–º–µ–Ω–æ–≤–∞–Ω–∏–µ**:
    - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –±–æ–ª—å—à–µ–π —è—Å–Ω–æ—Å—Ç–∏.
6. **–ò–º–ø–æ—Ä—Ç—ã**:
   -  –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `logger` –∏–∑ `src.logger`.

**–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥:**

```python
"""
–ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π Telegram –±–æ—Ç–∞ —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ —Ä—ã–Ω–∫–∞
======================================================================

–ú–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª–∞—Å—Å—ã DAO (Data Access Object) –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –º–æ–¥–µ–ª—è–º–∏,
—Ç–∞–∫–∏–º–∏ –∫–∞–∫ User, Purchase, Category –∏ Product.

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
----------------------
.. code-block:: python

    from sqlalchemy.ext.asyncio import AsyncSession
    from src.endpoints.bots.telegram.digital_market.bot.dao.dao import UserDAO, PurchaseDao
    
    async def main():
        session: AsyncSession = ... #  –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
        user_stats = await UserDAO.get_purchase_statistics(session, 123456)
        payment_stats = await PurchaseDao.get_payment_stats(session)
        print(user_stats)
        print(payment_stats)
"""
from datetime import datetime, timedelta, UTC
from typing import Dict, List, Optional

from sqlalchemy import func, select, case
from sqlalchemy.exc import SQLAlchemyError
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.orm import selectinload

from src.logger import logger #  –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º logger
from bot.dao.base import BaseDAO
from bot.dao.models import Category, Product, Purchase, User


class UserDAO(BaseDAO[User]):
    """
    DAO –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–µ–ª—å—é User.
    """
    model = User

    @classmethod
    async def get_purchase_statistics(cls, session: AsyncSession, telegram_id: int) -> Optional[Dict[str, int]]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–∫—É–ø–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

        :param session: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
        :type session: AsyncSession
        :param telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram.
        :type telegram_id: int
        :return: –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –ø–æ–∫—É–ø–æ–∫ (–æ–±—â–µ–µ —á–∏—Å–ª–æ –ø–æ–∫—É–ø–æ–∫ –∏ –æ–±—â–∞—è —Å—É–º–º–∞), –∏–ª–∏ None, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.
        :rtype: Optional[Dict[str, int]]
        :raises SQLAlchemyError: –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
        
        –ü—Ä–∏–º–µ—Ä:
            >>> async def test():
            >>>     session = ... #  –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
            >>>     stats = await UserDAO.get_purchase_statistics(session, 123456)
            >>>     print(stats)
        """
        try:
            result = await session.execute(
                select(
                    func.count(Purchase.id).label('total_purchases'),
                    func.sum(Purchase.price).label('total_amount'),
                )
                .join(User)
                .filter(User.telegram_id == telegram_id)
            )
            stats = result.one_or_none()

            if stats is None:
                return None

            total_purchases, total_amount = stats
            return {
                'total_purchases': total_purchases,
                'total_amount': total_amount or 0,  # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ —Å—É–º–º–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å None
            }
        except SQLAlchemyError as e:
            logger.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–∫—É–ø–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}') #  –ò—Å–ø–æ–ª—å–∑—É–µ–º logger.error –≤–º–µ—Å—Ç–æ print
            return None

    @classmethod
    async def get_purchased_products(cls, session: AsyncSession, telegram_id: int) -> Optional[List[Purchase]]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

        :param session: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
        :type session: AsyncSession
        :param telegram_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram.
        :type telegram_id: int
        :return: –°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ None, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.
        :rtype: Optional[List[Purchase]]
        :raises SQLAlchemyError: –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.

        –ü—Ä–∏–º–µ—Ä:
            >>> async def test():
            >>>     session = ... #  –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
            >>>     purchases = await UserDAO.get_purchased_products(session, 123456)
            >>>     print(purchases)
        """
        try:
            result = await session.execute(
                select(User)
                .options(selectinload(User.purchases).selectinload(Purchase.product))
                .filter(User.telegram_id == telegram_id)
            )
            user = result.scalar_one_or_none()

            if user is None:
                return None

            return user.purchases
        except SQLAlchemyError as e:
            logger.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–∫—É–ø–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {e}') #  –ò—Å–ø–æ–ª—å–∑—É–µ–º logger.error –≤–º–µ—Å—Ç–æ print
            return None

    @classmethod
    async def get_statistics(cls, session: AsyncSession) -> Dict[str, int]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –æ–±—â—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –Ω–æ–≤—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è, –Ω–µ–¥–µ–ª—é –∏ –º–µ—Å—è—Ü).

        :param session: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
        :type session: AsyncSession
        :return: –°–ª–æ–≤–∞—Ä—å —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
        :rtype: Dict[str, int]
        :raises SQLAlchemyError: –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.

        –ü—Ä–∏–º–µ—Ä:
            >>> async def test():
            >>>     session = ... #  –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
            >>>     stats = await UserDAO.get_statistics(session)
            >>>     print(stats)
        """
        try:
            now = datetime.now(UTC)

            query = select(
                func.count().label('total_users'),
                func.sum(case((cls.model.created_at >= now - timedelta(days=1), 1), else_=0)).label('new_today'),
                func.sum(case((cls.model.created_at >= now - timedelta(days=7), 1), else_=0)).label('new_week'),
                func.sum(case((cls.model.created_at >= now - timedelta(days=30), 1), else_=0)).label('new_month'),
            )

            result = await session.execute(query)
            stats = result.fetchone()

            statistics = {
                'total_users': stats.total_users,
                'new_today': stats.new_today,
                'new_week': stats.new_week,
                'new_month': stats.new_month,
            }

            logger.info(f'–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω–∞: {statistics}') #  –ò—Å–ø–æ–ª—å–∑—É–µ–º logger.info
            return statistics
        except SQLAlchemyError as e:
            logger.error(f'–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: {e}') #  –ò—Å–ø–æ–ª—å–∑—É–µ–º logger.error
            raise


class PurchaseDao(BaseDAO[Purchase]):
    """
    DAO –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–µ–ª—å—é Purchase.
    """
    model = Purchase

    @classmethod
    async def get_payment_stats(cls, session: AsyncSession) -> str:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ —Ç–∏–ø–∞–º.

        :param session: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
        :type session: AsyncSession
        :return: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ —Å–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –ø–ª–∞—Ç–µ–∂–µ–π.
        :rtype: str
        
        –ü—Ä–∏–º–µ—Ä:
            >>> async def test():
            >>>     session = ... #  –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
            >>>     stats = await PurchaseDao.get_payment_stats(session)
            >>>     print(stats)
        """
        query = select(
            cls.model.payment_type, func.sum(cls.model.price).label('total_price')
        ).group_by(cls.model.payment_type)

        result = await session.execute(query)
        stats = result.all()

        totals: Dict[str, float] = {
            'yukassa': 0,
            'robocassa': 0,
            'stars': 0,
        }

        for payment_type, total in stats:
            totals[payment_type] = total or 0

        formatted_stats = (
            f'üí≥ –Æ–∫–∞—Å—Å–∞: {totals["yukassa"]:.2f} ‚ÇΩ\n'
            f'ü§ñ –†–æ–±–æ–∫–∞—Å—Å–∞: {totals["robocassa"]:.2f} ‚ÇΩ\n'
            f'‚≠ê STARS: {totals["stars"]:.0f}\n\n'
            '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–∞ –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç.'
        )

        return formatted_stats

    @classmethod
    async def get_full_summ(cls, session: AsyncSession) -> int:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –æ–±—â—É—é —Å—É–º–º—É –≤—Å–µ—Ö –ø–æ–∫—É–ø–æ–∫.

        :param session: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
        :type session: AsyncSession
        :return: –û–±—â–∞—è —Å—É–º–º–∞ –ø–æ–∫—É–ø–æ–∫.
        :rtype: int

        –ü—Ä–∏–º–µ—Ä:
            >>> async def test():
            >>>     session = ... #  –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
            >>>     total_sum = await PurchaseDao.get_full_summ(session)
            >>>     print(total_sum)
        """
        query = select(func.sum(cls.model.price).label('total_price'))
        result = await session.execute(query)
        total_price = result.scalars().one_or_none()
        return total_price if total_price is not None else 0

    @classmethod
    async def get_next_id(cls, session: AsyncSession) -> int:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —Å–≤–æ–±–æ–¥–Ω—ã–π ID –¥–ª—è –Ω–æ–≤–æ–π –∑–∞–ø–∏—Å–∏.

        :param session: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        :type session: AsyncSession
        :return: –°–ª–µ–¥—É—é—â–∏–π —Å–≤–æ–±–æ–¥–Ω—ã–π ID
        :rtype: int

        –ü—Ä–∏–º–µ—Ä:
            >>> async def test():
            >>>     session = ... #  –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏
            >>>     next_id = await PurchaseDao.get_next_id(session)
            >>>     print(next_id)
        """
        query = select(func.coalesce(func.max(cls.model.id) + 1, 1))
        result = await session.execute(query)
        return result.scalar()


class CategoryDao(BaseDAO[Category]):
    """
    DAO –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–µ–ª—å—é Category.
    """
    model = Category


class ProductDao(BaseDAO[Product]):
    """
    DAO –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –º–æ–¥–µ–ª—å—é Product.
    """
    model = Product