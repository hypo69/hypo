# Модуль для работы с провайдером GPTalk
=========================================

Модуль содержит класс `GPTalk`, который является асинхронным генератором для взаимодействия с сервисом GPTalk.
Он обеспечивает аутентификацию и потоковую передачу текстовых ответов от выбранной модели.

## Обзор

Этот модуль предоставляет асинхронный интерфейс для взаимодействия с сервисом GPTalk. Он автоматически
управляет аутентификацией, поддерживает выбор модели (по умолчанию "gpt-3.5-turbo") и обрабатывает потоковую
передачу данных для получения ответов в реальном времени.

## Подробней

Модуль `GPTalk` предназначен для использования в асинхронных приложениях, требующих интеграции с GPTalk для
генерации текста. Он использует `aiohttp` для выполнения асинхронных HTTP-запросов и автоматически обновляет
токен аутентификации при необходимости.

## Классы

### `GPTalk(AsyncGeneratorProvider)`

**Описание**: Класс `GPTalk` реализует асинхронный генератор для взаимодействия с сервисом GPTalk.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность асинхронного провайдера генератора.

**Атрибуты**:
- `url` (str): URL-адрес сервиса GPTalk (`"https://gptalk.net"`).
- `working` (bool): Флаг, указывающий на работоспособность провайдера (по умолчанию `False`).
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели `gpt-3.5-turbo` (по умолчанию `True`).
- `_auth` (Optional[dict]): Словарь, содержащий данные аутентификации (инициализируется как `None`).
- `used_times` (int): Счетчик использования аутентификационного токена (инициализируется как `0`).

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для взаимодействия с GPTalk.

        Args:
            model (str): Имя используемой модели. Если не указано, используется "gpt-3.5-turbo".
            messages (Messages): Список сообщений для отправки в GPTalk.
            proxy (str, optional): URL-адрес прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncResult: Асинхронный генератор, выдающий ответы от GPTalk.

        Как работает функция:
        1. Устанавливает значение модели по умолчанию, если модель не указана.
        2. Получает текущее время в формате timestamp.
        3. Определяет заголовки HTTP-запроса, включая информацию о браузере и платформе.
        4. Создает асинхронную сессию `aiohttp.ClientSession` с заданными заголовками.
        5. Проверяет необходимость обновления аутентификационных данных. Обновление требуется, если:
            - `cls._auth` не определен (равен `None`).
            - Срок действия текущего токена истек (`cls._auth["expires_at"] < timestamp`).
            - Счетчик использования токена достиг лимита (`cls.used_times == 5`).
        6. Если требуется обновление аутентификации, выполняет следующие действия:
           - Генерирует случайный fingerprint.
           - Отправляет POST-запрос на `/api/chatgpt/user/login` для получения нового токена.
           - Обновляет `cls._auth` полученными данными.
           - Сбрасывает счетчик использования токена `cls.used_times`.
        7. Подготавливает данные для запроса к API чата, включая форматированный промт, параметры модели и timestamp.
        8. Устанавливает заголовок `Authorization` с использованием полученного токена.
        9. Отправляет POST-запрос на `/api/chatgpt/chatapi/text` для получения токена потока.
        10. Увеличивает счетчик использования токена `cls.used_times`.
        11. Извлекает токен потока из ответа.
        12. Отправляет GET-запрос на `/api/chatgpt/chatapi/stream` с токеном потока в качестве параметра.
        13. Асинхронно обрабатывает поток данных, полученный от GPTalk:
            - Проверяет, начинается ли строка с `b"data: "`.
            - Если строка начинается с `b"data: [DONE]"`, завершает генерацию.
            - Извлекает содержимое сообщения из JSON-данных.
            - Выделяет новую часть сообщения, которая не была отправлена ранее.
            - Отправляет новую часть сообщения через `yield`.
            - Обновляет `last_message` для отслеживания уже отправленной части сообщения.

        Raises:
            aiohttp.ClientResponseError: Если HTTP-запрос завершается с ошибкой.

        """
        ...
```

**Как работает функция**:

1.  **Установка параметров**: Функция инициализирует параметры, такие как модель, сообщения и прокси. Если модель не указана, используется "gpt-3.5-turbo".

2.  **Аутентификация**: Функция проверяет, требуется ли аутентификация. Если текущий токен отсутствует, истек или был использован максимальное количество раз, выполняется процесс аутентификации:
    - Создается уникальный fingerprint.
    - Выполняется POST-запрос для получения токена.
    - Токен сохраняется для дальнейшего использования.

3.  **Формирование запроса**: Подготавливаются данные для отправки запроса, включая форматированный промпт, параметры модели и заголовки авторизации.

4.  **Отправка запроса и обработка потока**:
    - Отправляется POST-запрос для получения ответа от GPTalk в виде потока данных.
    - Функция асинхронно обрабатывает поток данных, извлекая содержимое сообщений и передавая их через `yield`.

**Внутренние функции**:
- Внутри данной функции не используются внутренние функции.

**ASCII flowchart**:

```
    Начало
     |
     | Установка параметров (модель, сообщения, прокси)
     |
     | Проверка необходимости аутентификации
     |
     |------ Нет ----> Формирование запроса
     |      |
     |      V
     |    Аутентификация:
     |    - Создание fingerprint
     |    - POST-запрос для получения токена
     |    - Сохранение токена
     |
     | Формирование запроса (данные, заголовки)
     |
     | Отправка POST-запроса для получения потока данных
     |
     | Обработка потока данных:
     |  - Извлечение сообщений
     |  - Передача сообщений через yield
     |
     | Конец
```

**Примеры**:

```python
    # Пример использования create_async_generator
    messages = [{"role": "user", "content": "Привет, как дела?"}]
    async def run_generator():
        async for message in GPTalk.create_async_generator(model="gpt-3.5-turbo", messages=messages):
            print(message)

    # Пример использования с прокси
    async def run_generator_with_proxy():
        async for message in GPTalk.create_async_generator(model="gpt-3.5-turbo", messages=messages, proxy="http://your_proxy:8080"):
            print(message)
```