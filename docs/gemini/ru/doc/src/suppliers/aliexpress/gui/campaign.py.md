# Модуль для работы с редактором кампаний AliExpress (GUI)

## Обзор

Модуль `campaign.py` предоставляет графический интерфейс для редактирования кампаний AliExpress. Он включает в себя функциональность открытия, загрузки, редактирования и подготовки кампаний с использованием файлов JSON. Модуль использует библиотеку `PyQt6` для создания графического интерфейса и `qasync` для асинхронного выполнения операций.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для визуализации и редактирования файлов кампаний AliExpress. Он обеспечивает удобный интерфейс для работы с данными кампаний, позволяя пользователям открывать файлы JSON, просматривать и изменять параметры кампаний, а также подготавливать кампании к дальнейшей обработке.

## Классы

### `CampaignEditor`

**Описание**: Класс `CampaignEditor` представляет собой виджет (QWidget) для редактирования кампаний. Он содержит методы для настройки интерфейса, загрузки файлов кампаний, создания виджетов для редактирования данных и подготовки кампаний.

**Принцип работы**:

Класс `CampaignEditor` инициализирует графический интерфейс пользователя (UI) с кнопками, полями ввода и другими элементами управления. Он позволяет пользователю открывать файлы JSON с данными кампаний, отображать эти данные в полях ввода и изменять их. После внесения изменений пользователь может подготовить кампанию к дальнейшей обработке.

**Атрибуты**:

- `data` (SimpleNamespace): Пространство имен для хранения данных кампании.
- `current_campaign_file` (str): Путь к текущему открытому файлу кампании.
- `editor` (AliCampaignEditor): Экземпляр класса `AliCampaignEditor` для подготовки кампании.
- `main_app`: Ссылка на главный экземпляр приложения.
- `scroll_area` (QtWidgets.QScrollArea): Область прокрутки для размещения виджетов.
- `scroll_content_widget` (QtWidgets.QWidget): Виджет для содержимого области прокрутки.
- `layout` (QtWidgets.QGridLayout): Менеджер компоновки для размещения виджетов в области прокрутки.
- `open_button` (QtWidgets.QPushButton): Кнопка для открытия файла кампании.
- `file_name_label` (QtWidgets.QLabel): Метка для отображения имени файла кампании.
- `prepare_button` (QtWidgets.QPushButton): Кнопка для подготовки кампании.
- `title_input` (QtWidgets.QLineEdit): Поле ввода для заголовка кампании.
- `description_input` (QtWidgets.QLineEdit): Поле ввода для описания кампании.
- `promotion_name_input` (QtWidgets.QLineEdit): Поле ввода для названия акции кампании.

**Методы**:

- `__init__(self, parent=None, main_app=None)`: Инициализирует виджет `CampaignEditor`.
- `setup_ui(self)`: Настраивает пользовательский интерфейс.
- `setup_connections(self)`: Устанавливает соединения между сигналами и слотами.
- `open_file(self)`: Открывает диалоговое окно для выбора файла JSON.
- `load_file(self, campaign_file)`: Загружает JSON файл и создает виджеты для редактирования.
- `create_widgets(self, data)`: Создает виджеты на основе данных из JSON файла.
- `prepare_campaign(self)`: Асинхронно подготавливает кампанию.

## Функции

### `__init__`

```python
def __init__(self, parent=None, main_app=None):
    """ Initialize the CampaignEditor widget """
```

**Назначение**: Инициализация виджета `CampaignEditor`.

**Параметры**:

- `parent` (QtWidgets.QWidget, optional): Родительский виджет. По умолчанию `None`.
- `main_app` (MainApp, optional): Экземпляр главного приложения. По умолчанию `None`.

**Возвращает**:
- None

**Как работает функция**:

1. Вызывает конструктор родительского класса `QtWidgets.QWidget`.
2. Сохраняет ссылку на экземпляр главного приложения (`main_app`) для дальнейшего использования.
3. Вызывает методы `setup_ui()` и `setup_connections()` для настройки интерфейса и соединений.

**Примеры**:

```python
campaign_editor = CampaignEditor(main_app=main_app_instance)
```

### `setup_ui`

```python
def setup_ui(self):
    """ Setup the user interface """
```

**Назначение**: Настройка пользовательского интерфейса.

**Параметры**:
- None

**Возвращает**:
- None

**Как работает функция**:

1. Устанавливает заголовок окна как "Campaign Editor".
2. Устанавливает размер окна как 1800x800 пикселей.
3. Создает область прокрутки (`QScrollArea`) и устанавливает ее как изменяемую по размеру.
4. Создает виджет для содержимого области прокрутки (`scroll_content_widget`) и устанавливает его в область прокрутки.
5. Создает менеджер компоновки (`QGridLayout`) для содержимого области прокрутки и устанавливает выравнивание по верхнему краю.
6. Определяет UI компоненты:
   - Кнопку "Open JSON File" (`open_button`) и устанавливает соединение с методом `open_file()`.
   - Метку для имени файла (`file_name_label`).
   - Кнопку "Prepare Campaign" (`prepare_button`) и устанавливает соединение с методом `prepare_campaign()`.
7. Добавляет компоненты в менеджер компоновки.
8. Создает главный менеджер компоновки (`QVBoxLayout`) и добавляет в него область прокрутки.
9. Устанавливает главный менеджер компоновки для виджета.

**Примеры**:

```python
campaign_editor.setup_ui()
```

### `setup_connections`

```python
def setup_connections(self):
    """ Setup signal-slot connections """
```

**Назначение**: Настройка соединений между сигналами и слотами.

**Параметры**:
- None

**Возвращает**:
- None

**Как работает функция**:

Функция в текущей реализации ничего не делает (`pass`), но предназначена для установки соединений между сигналами и слотами в графическом интерфейсе.

**Примеры**:

```python
campaign_editor.setup_connections()
```

### `open_file`

```python
def open_file(self):
    """ Open a file dialog to select and load a JSON file """
```

**Назначение**: Открытие диалогового окна для выбора и загрузки JSON файла.

**Параметры**:
- None

**Возвращает**:
- None

**Как работает функция**:

1. Открывает диалоговое окно выбора файла с помощью `QFileDialog.getOpenFileName()`.
2. Устанавливает фильтр для отображения только JSON файлов (`*.json`).
3. Если файл не выбран, функция завершается.
4. Вызывает метод `load_file()` для загрузки выбранного файла.

**Примеры**:

```python
campaign_editor.open_file()
```

### `load_file`

```python
def load_file(self, campaign_file):
    """ Load a JSON file """
```

**Назначение**: Загрузка JSON файла.

**Параметры**:

- `campaign_file` (str): Путь к JSON файлу.

**Возвращает**:
- None

**Вызывает исключения**:
- `Exception`: Если не удалось загрузить JSON файл.

**Как работает функция**:

1. Пытается загрузить JSON файл с использованием `j_loads_ns()`.
2. Сохраняет путь к файлу в `self.current_campaign_file`.
3. Устанавливает текст метки (`file_name_label`) с именем файла.
4. Вызывает метод `create_widgets()` для создания виджетов на основе данных из файла.
5. Создает экземпляр класса `AliCampaignEditor` для подготовки кампании.
6. В случае ошибки выводит сообщение об ошибке с помощью `QMessageBox.critical()`.

**Примеры**:

```python
campaign_editor.load_file("path/to/campaign.json")
```

### `create_widgets`

```python
def create_widgets(self, data):
    """ Create widgets based on the data loaded from the JSON file """
```

**Назначение**: Создание виджетов на основе данных, загруженных из JSON файла.

**Параметры**:

- `data` (SimpleNamespace): Данные, загруженные из JSON файла.

**Возвращает**:
- None

**Как работает функция**:

1. Получает менеджер компоновки (`layout`).
2. Удаляет все предыдущие виджеты, кроме кнопок `open_button`, `file_name_label` и `prepare_button`.
3. Создает поле ввода для заголовка (`title_input`) и заполняет его данными из `data.title`.
4. Добавляет метку "Title:" и поле ввода заголовка в менеджер компоновки.
5. Создает поле ввода для описания (`description_input`) и заполняет его данными из `data.description`.
6. Добавляет метку "Description:" и поле ввода описания в менеджер компоновки.
7. Создает поле ввода для названия акции (`promotion_name_input`) и заполняет его данными из `data.promotion_name`.
8. Добавляет метку "Promotion Name:" и поле ввода названия акции в менеджер компоновки.

**Примеры**:

```python
campaign_editor.create_widgets(data)
```

### `prepare_campaign`

```python
@asyncSlot()
async def prepare_campaign(self):
    """ Asynchronously prepare the campaign """
```

**Назначение**: Асинхронная подготовка кампании.

**Параметры**:
- None

**Возвращает**:
- None

**Как работает функция**:

1. Проверяет, создан ли экземпляр `self.editor`.
2. Пытается асинхронно подготовить кампанию с помощью `self.editor.prepare()`.
3. Выводит сообщение об успешной подготовке кампании с помощью `QMessageBox.information()`.
4. В случае ошибки выводит сообщение об ошибке с помощью `QMessageBox.critical()`.

**Примеры**:

```python
await campaign_editor.prepare_campaign()
```

## ASCII flowchart функций
### `open_file`

```
Начало
  ↓
QFileDialog.getOpenFileName() - Открытие диалогового окна выбора файла
  ↓
[Файл выбран?]
  ├──→ Нет: Конец
  ↓ Да
load_file() - Загрузка выбранного файла
  ↓
Конец
```

### `load_file`

```
Начало
  ↓
j_loads_ns() - Загрузка JSON файла
  ↓
Сохранение пути к файлу в self.current_campaign_file
  ↓
Установка текста метки file_name_label с именем файла
  ↓
create_widgets() - Создание виджетов на основе данных из файла
  ↓
Создание экземпляра класса AliCampaignEditor
  ↓
Конец (успех)
  |
  └──→ Исключение: Вывод сообщения об ошибке
      ↓
      Конец (ошибка)
```

### `create_widgets`

```
Начало
  ↓
Получение менеджера компоновки layout
  ↓
Удаление предыдущих виджетов
  ↓
Создание и заполнение поля ввода для заголовка title_input
  ↓
Добавление метки "Title:" и поля ввода заголовка в layout
  ↓
Создание и заполнение поля ввода для описания description_input
  ↓
Добавление метки "Description:" и поля ввода описания в layout
  ↓
Создание и заполнение поля ввода для названия акции promotion_name_input
  ↓
Добавление метки "Promotion Name:" и поля ввода названия акции в layout
  ↓
Конец
```

### `prepare_campaign`

```
Начало
  ↓
[self.editor существует?]
  ├──→ Нет: Конец
  ↓ Да
Попытка асинхронно подготовить кампанию self.editor.prepare()
  ↓
[Успешно?]
  ├──→ Да: Вывод сообщения об успехе
  │       ↓
  │       Конец
  ↓ Нет
Вывод сообщения об ошибке
  ↓
Конец
```