# Модуль для работы с провайдером Ails (g4f)
=================================================

Модуль содержит класс :class:`Ails`, который используется для взаимодействия с сервисом Ails через API caipacity.com для генерации текста.
Провайдер использует асинхронные запросы и предоставляет функциональность для работы с историей сообщений и моделью gpt-3.5-turbo.

## Обзор

Этот модуль предоставляет асинхронный генератор для взаимодействия с API `ai.ls` через `api.caipacity.com`.
Он поддерживает историю сообщений и модель `gpt-3.5-turbo`. Модуль предназначен для использования в асинхронных приложениях,
где требуется генерация текста с использованием указанного провайдера.

## Подробнее

Модуль предназначен для интеграции с системой, требующей взаимодействия с AI-моделью через API `ai.ls`.
Он использует `aiohttp` для асинхронных HTTP-запросов. Ключевой особенностью является асинхронная потоковая передача данных,
что позволяет получать результаты по частям, снижая задержки и улучшая восприятие скорости работы для пользователя.

## Классы

### `Ails(AsyncGeneratorProvider)`

**Описание**: Класс `Ails` предоставляет асинхронный генератор для взаимодействия с API `ai.ls`.

**Наследует**:
- `AsyncGeneratorProvider`: Базовый класс для асинхронных провайдеров генерации текста.

**Атрибуты**:
- `url` (str): URL сервиса `ai.ls`.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений.
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели `gpt-3.5-turbo`.

**Методы**:
- `create_async_generator`: Статический асинхронный метод, создающий асинхронный генератор для получения ответов от API `ai.ls`.

### `create_async_generator`

```python
    @staticmethod
    async def create_async_generator(
        model: str,
        messages: Messages,
        stream: bool,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для получения ответов от API caipacity.com.

        Args:
            model (str): Идентификатор используемой модели.
            messages (Messages): Список сообщений для отправки в API.
            stream (bool): Флаг, указывающий на использование потоковой передачи данных.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы, такие как температура.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий ответы от API.

        Raises:
            Exception: Если ответ содержит признаки ошибки или упоминания `ai.ls` и `ai.ci`.
        """
        ...
```

**Назначение**: Создает асинхронный генератор для получения ответов от API `caipacity.com`.

**Параметры**:
- `model` (str): Идентификатор используемой модели.
- `messages` (Messages): Список сообщений для отправки в API.
- `stream` (bool): Флаг, указывающий на использование потоковой передачи данных.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы, такие как `temperature`.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий ответы от API.

**Вызывает исключения**:
- `Exception`: Если ответ содержит признаки ошибки или упоминания `ai.ls` и `ai.ci`.

**Как работает функция**:
1. **Формирование заголовков**: Функция формирует HTTP-заголовки для запроса к API, включая авторизацию, идентификатор клиента и User-Agent.
2. **Создание асинхронной сессии**: Создается асинхронная сессия с использованием библиотеки `aiohttp` для выполнения HTTP-запросов.
3. **Подготовка данных запроса**:
   - Формируется timestamp в нужном формате.
   - Создается JSON-payload с параметрами запроса, включая модель, температуру, сообщения, дату и хеш.
4. **Выполнение POST-запроса**: Выполняется асинхронный POST-запрос к API `api.caipacity.com` с использованием созданной сессии и JSON-данных.
5. **Обработка потока ответов**:
   - Читаются строки из ответа.
   - Каждая строка декодируется из UTF-8.
   - Если строка начинается с `data: ` и не равна `data: [DONE]`, извлекается содержимое JSON.
   - Извлекается токен из поля `content` в JSON.
   - Если токен содержит признаки ошибки (`ai.ls` или `ai.ci`), вызывается исключение.
   - Токен передается через `yield`, что делает функцию генератором.

```text
Формирование заголовков  --> Создание асинхронной сессии --> Подготовка данных запроса (timestamp, JSON)
    |
    |
    V
Выполнение POST-запроса к API
    |
    |
    V
Обработка потока ответов: чтение, декодирование, извлечение токенов, проверка на ошибки
    |
    |
    V
Вывод токенов через yield (генератор)
```

**Примеры**:

Пример вызова функции:

```python
async def test():
    model = "gpt-3.5-turbo"
    messages = [{"role": "user", "content": "Hello, world!"}]
    stream = True
    proxy = None
    kwargs = {"temperature": 0.7}

    async for token in Ails.create_async_generator(model, messages, stream, proxy, **kwargs):
        print(token, end="")
```

## Функции

### `_hash(json_data: dict[str, str]) -> SHA256`

```python
def _hash(json_data: dict[str, str]) -> SHA256:
    """Вычисляет SHA256 хеш на основе предоставленных данных.

    Args:
        json_data (dict[str, str]): Словарь, содержащий данные для хеширования.

    Returns:
        SHA256: Объект SHA256 хеша.
    """
    ...
```

**Назначение**: Вычисляет SHA256 хеш на основе предоставленных данных.

**Параметры**:
- `json_data` (dict[str, str]): Словарь, содержащий данные для хеширования.

**Возвращает**:
- `SHA256`: Объект SHA256 хеша.

**Как работает функция**:
1. **Формирование базовой строки**: Функция формирует строку для хеширования, конкатенируя значения из `json_data` и фиксированные строки.
2. **Вычисление SHA256**: Вычисляет SHA256 хеш от полученной строки.
3. **Возврат хеша**: Возвращает вычисленный хеш в виде объекта `SHA256`.

```text
Формирование базовой строки -> Вычисление SHA256 -> Возврат хеша
```

**Примеры**:

```python
data = {"t": "1678886400", "m": "Test message"}
hash_value = _hash(data)
print(hash_value)
```

### `_format_timestamp(timestamp: int) -> str`

```python
def _format_timestamp(timestamp: int) -> str:
    """Форматирует timestamp для использования в API запросах.

    Args:
        timestamp (int): Timestamp в миллисекундах.

    Returns:
        str: Отформатированный timestamp.
    """
    ...
```

**Назначение**: Форматирует timestamp для использования в API запросах.

**Параметры**:
- `timestamp` (int): Timestamp в миллисекундах.

**Возвращает**:
- `str`: Отформатированный timestamp.

**Как работает функция**:
1. **Вычисление остатка**: Вычисляет остаток от деления timestamp на 10.
2. **Корректировка**: Если остаток четный, добавляет 1, иначе оставляет как есть.
3. **Форматирование**: Вычитает из исходного timestamp остаток и добавляет скорректированный остаток.
4. **Преобразование в строку**: Преобразует полученное значение в строку.

```text
Вычисление остатка -> Корректировка остатка (если четный) -> Форматирование timestamp -> Преобразование в строку
```

**Примеры**:

```python
timestamp = 1678886405000
formatted_timestamp = _format_timestamp(timestamp)
print(formatted_timestamp)
```