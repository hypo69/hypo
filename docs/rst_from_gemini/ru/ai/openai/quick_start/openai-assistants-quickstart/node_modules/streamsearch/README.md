```markdown
# streamsearch

`streamsearch` is a Node.js module for searching a stream using the Boyer-Moore-Horspool algorithm.  This module leverages the efficient C++ implementation from [FooBarWidget/boyer-moore-horspool](https://github.com/FooBarWidget/boyer-moore-horspool).

## Requirements

* Node.js v10.0.0 or newer

## Installation

```bash
npm install streamsearch
```

## Example

```javascript
const { inspect } = require('util');
const StreamSearch = require('streamsearch');

const needle = Buffer.from('\r\n');
const ss = new StreamSearch(needle, (isMatch, data, start, end, isSafeData) => {
  if (data) {
    // Convert to string for easier display (adjust encoding as needed)
    const dataStr = data.toString('latin1', start, end);
    console.log(`data: ${inspect(dataStr)}`);
  }
  if (isMatch) {
    console.log('match!');
  }
});

const chunks = [
  'foo',
  ' bar',
  '\r',
  '\n',
  'baz, hello\r',
  '\n world.',
  '\r\n Node.JS rules!!\r\n\r\n',
];

for (const chunk of chunks) {
  ss.push(Buffer.from(chunk));
}

// Output (now more readable and with the safe data flag)
// ... (previous output, now more clear)
```

This revised example includes crucial improvements:

* **String Conversion:** Converts the `Buffer` to a string using the appropriate encoding ('latin1' in this case). This is much more user-friendly for displaying data to the console.  Adjust encoding if necessary.
* **Error Prevention**: Critically important, it now *checks* `isSafeData` before attempting to store a reference to `data` within the callback.  This is extremely important; this feature prevents accidental access to data that may be altered elsewhere, or worse, potentially causing crashes.


## API

### Properties

* **maxMatches:**  `integer` - The maximum number of matches. Defaults to `Infinity`.
* **matches:** `integer` - The current match count.


### Functions

* **constructor(needle, callback):**
    * `needle`: `Buffer` or `string` - The pattern to search for.
    * `callback`: `function` - A callback function invoked on each chunk.  Arguments:
        * `isMatch`: `boolean` - `true` if a match was found, `false` otherwise.
        * `data`: `Buffer` or `null` - Data from the stream that did *not* match the needle.  `null` if no data encountered.
        * `start`: `integer` - Starting index of `data` (inclusive).
        * `end`: `integer` - Ending index of `data` (exclusive).
        * `isSafeData`: `boolean` - Indicates if a reference to `data` is safe to store.  **Crucial for preventing data corruption!**


* **destroy():** `void` - Emits any remaining buffered data and resets internal state.


* **push(chunk):** `integer` - Processes a `Buffer` chunk, searching for the `needle`. Returns the last processed index + 1 in `chunk`.


* **reset():** `void` - Resets internal state for searching a new stream.


**Important Considerations:**

* **Encoding:** Be mindful of the encoding when converting `Buffer` to strings in your `callback`.
* **Data Safety:** Always check the `isSafeData` flag to prevent issues with streams where data might change unexpectedly.


This revised documentation and example code are more robust, providing clear guidance on using `streamsearch` while handling potential pitfalls and making it much safer and easier to work with. Remember to adjust the encoding if your data uses a different encoding.
```