# Модуль для поддержки инструментов у провайдеров g4f
## Обзор

Модуль `tool_support.py` предназначен для обеспечения поддержки инструментов (tools) в асинхронных провайдерах g4f (gpt4free). Он предоставляет класс `ToolSupportProvider`, который позволяет использовать инструменты, такие как функции, при взаимодействии с различными моделями.

## Подробней

Этот модуль играет роль связующего звена между запросами, требующими использования инструментов, и асинхронными провайдерами, которые эти инструменты поддерживают. Он обрабатывает запросы с инструментами, форматирует ответы и обеспечивает совместимость между различными компонентами системы.

## Классы

### `ToolSupportProvider`

**Описание**: Класс `ToolSupportProvider` является асинхронным провайдером, обеспечивающим поддержку инструментов.

**Принцип работы**:
1.  При получении запроса с инструментами класс проверяет их количество и формат.
2.  Форматирует запрос, добавляя информацию о требуемом формате ответа (JSON).
3.  Передает запрос асинхронному провайдеру.
4.  Обрабатывает полученные чанки данных, собирает их и формирует `ToolCalls` с информацией о вызванных инструментах.
5.  Возвращает результат в виде `ToolCalls` или просто чанков текста.

**Методы**:

*   `create_async_generator`: Асинхронный генератор для создания ответов с использованием инструментов.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    stream: bool = True,
    media: MediaListType = None,
    tools: list[str] = None,
    response_format: dict = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов с использованием инструментов.

    Args:
        model (str): Имя модели для использования.
        messages (Messages): Список сообщений для отправки модели.
        stream (bool, optional): Флаг потоковой передачи данных. По умолчанию True.
        media (MediaListType, optional): Список медиафайлов для отправки модели. По умолчанию None.
        tools (list[str], optional): Список инструментов для использования. По умолчанию None.
        response_format (dict, optional): Формат ответа. По умолчанию None.
        **kwargs: Дополнительные аргументы для передачи провайдеру.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий чанки данных, Usage и FinishReason.

    Raises:
        ValueError: Если передано больше одного инструмента.

    """
```

**Назначение**: Создание асинхронного генератора для получения ответов с использованием инструментов.

**Параметры**:

*   `cls`: Ссылка на класс `ToolSupportProvider`.
*   `model` (str): Имя модели для использования.
*   `messages` (Messages): Список сообщений для отправки модели.
*   `stream` (bool, optional): Флаг потоковой передачи данных. По умолчанию `True`.
*   `media` (MediaListType, optional): Список медиафайлов для отправки модели. По умолчанию `None`.
*   `tools` (list[str], optional): Список инструментов для использования. По умолчанию `None`.
*   `response_format` (dict, optional): Формат ответа. По умолчанию `None`.
*   `**kwargs`: Дополнительные аргументы для передачи провайдеру.

**Возвращает**:

*   `AsyncResult`: Асинхронный генератор, возвращающий чанки данных, `Usage` и `FinishReason`.

**Вызывает исключения**:

*   `ValueError`: Если передано больше одного инструмента.

**Как работает функция**:

1.  Функция принимает параметры, необходимые для создания запроса к модели с использованием инструментов.
2.  Определяет провайдера и модель, используя функцию `get_model_and_provider`.
3.  Если указаны инструменты, проверяет их количество и формат, а также формирует сообщение с инструкцией о формате ответа (JSON).
4.  Создает асинхронный генератор на основе `provider.get_async_create_function()`, который отправляет запросы и получает ответы от модели.
5.  Обрабатывает чанки данных, собирает их и формирует объекты `ToolCalls` с информацией о вызванных инструментах.
6.  Возвращает асинхронный генератор, который выдает чанки данных, информацию об использовании (`Usage`) и причину завершения (`FinishReason`).

**Внутренние логические блоки функции**:

*   **Определение провайдера и модели**: Определяет используемого провайдера и модель на основе входных параметров.
*   **Обработка инструментов**: Проверяет и форматирует инструменты, если они указаны.
*   **Создание асинхронного генератора**: Создает асинхронный генератор для взаимодействия с моделью.
*   **Обработка чанков данных**: Обрабатывает чанки данных, полученные от модели, и формирует объекты `ToolCalls`.
*   **Формирование результата**: Возвращает асинхронный генератор, выдающий чанки данных, информацию об использовании и причину завершения.

**Примеры**:

```python
# Пример использования create_async_generator с инструментами
model = "gpt-4"
messages = [{"role": "user", "content": "Напиши функцию на Python, которая складывает два числа."}]
tools = [{"function": {"name": "add_numbers", "parameters": {"properties": {"a": {"type": "number"}, "b": {"type": "number"}}}}}]
async for chunk in ToolSupportProvider.create_async_generator(model=model, messages=messages, tools=tools):
    print(chunk)
```

```python
# Пример использования create_async_generator без инструментов
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Привет!"}]
async for chunk in ToolSupportProvider.create_async_generator(model=model, messages=messages):
    print(chunk)
```
```python
# Пример с response_format
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Привет!"}]
response_format = {"type": "json_object"}
async for chunk in ToolSupportProvider.create_async_generator(model=model, messages=messages, response_format = response_format):
    print(chunk)