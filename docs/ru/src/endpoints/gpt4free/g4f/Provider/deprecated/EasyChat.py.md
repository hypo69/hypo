# Модуль `EasyChat`

## Обзор

Модуль `EasyChat` предоставляет класс `EasyChat`, который является провайдером для взаимодействия с сервисом EasyChat для создания завершений текста на основе моделей GPT. Модуль поддерживает потоковую передачу данных и модель `gpt-3.5-turbo`.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для обеспечения доступа к различным сервисам GPT, в данном случае через EasyChat. Он использует `requests` для выполнения HTTP-запросов к API EasyChat и обрабатывает ответы в формате JSON.

## Классы

### `EasyChat(AbstractProvider)`

**Описание**: Класс `EasyChat` реализует взаимодействие с сервисом EasyChat.

**Наследует**:
- `AbstractProvider`: Абстрактный класс-провайдер, определяющий интерфейс для работы с различными сервисами GPT.

**Атрибуты**:
- `url` (str): URL сервиса EasyChat (`"https://free.easychat.work"`).
- `supports_stream` (bool): Поддержка потоковой передачи данных (`True`).
- `supports_gpt_35_turbo` (bool): Поддержка модели `gpt-3.5-turbo` (`True`).
- `working` (bool): Указывает, работает ли провайдер в данный момент (`False`).

**Методы**:
- `create_completion()`: Создает завершение текста на основе переданных параметров.

## Функции

### `create_completion(model: str, messages: list[dict[str, str]], stream: bool, **kwargs: Any) -> CreateResult`

**Назначение**: Создает запрос к сервису EasyChat для генерации текста на основе предоставленных сообщений и параметров.

**Параметры**:
- `model` (str): Идентификатор используемой модели.
- `messages` (list[dict[str, str]]): Список сообщений, используемых в качестве контекста для генерации.
- `stream` (bool): Флаг, указывающий, следует ли использовать потоковую передачу данных.
- `**kwargs` (Any): Дополнительные параметры, такие как температура, штрафы за присутствие и частоту, а также верхнее значение `p`.

**Возвращает**:
- `CreateResult`: Генератор, выдающий фрагменты текста, или строка с результатом, если потоковая передача не используется.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при выполнении HTTP-запроса или при обработке ответа от сервера.

**Как работает функция**:
1. **Выбор сервера**: Функция выбирает случайный активный сервер из списка `active_servers`.
2. **Формирование заголовков**: Формируются заголовки HTTP-запроса, включая информацию о типе контента, User-Agent и другие необходимые параметры.
3. **Формирование данных запроса**: Создается JSON-объект с данными для запроса, включая сообщения, параметры модели и флаги.
4. **Создание сессии**: Инициализируется сессия `requests.Session()` для управления cookies.
5. **Отправка запроса**: Отправляется POST-запрос к API EasyChat с использованием сформированных заголовков и данных.
6. **Обработка ответа**:
   - Если `stream` равен `False`, функция ожидает полный ответ от сервера, преобразует его в JSON и извлекает сгенерированный текст из поля `choices`.
   - Если `stream` равен `True`, функция обрабатывает ответ по частям, извлекая фрагменты текста из каждого чанка и возвращая их через генератор.

**Внутренние функции**: В данной функции внутренних функций нет.

**ASCII flowchart**:

```
Начало
│
└── Выбор_сервера
│
└── Формирование_заголовков
│
└── Формирование_данных
│
└── Создание_сессии
│
└── Отправка_запроса
│
└── Обработка_ответа
│   │
│   ├── Нет_потока? (stream=False)
│   │   └── Извлечение_текста_из_JSON
│   │
│   └── Поток? (stream=True)
│       └── Извлечение_фрагментов_из_чанков
│
└── Конец
```

**Примеры**:

```python
# Пример использования без потоковой передачи
messages = [{"role": "user", "content": "Напиши короткий стих о весне."}]
result = EasyChat.create_completion(model="gpt-3.5-turbo", messages=messages, stream=False)
for text in result:
    print(text)

# Пример использования с потоковой передачей
messages = [{"role": "user", "content": "Расскажи о столице Франции."}]
result = EasyChat.create_completion(model="gpt-3.5-turbo", messages=messages, stream=True)
for chunk in result:
    print(chunk, end="")