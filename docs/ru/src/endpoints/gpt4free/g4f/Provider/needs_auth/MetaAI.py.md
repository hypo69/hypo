# Модуль MetaAI

## Обзор

Модуль `MetaAI` предоставляет асинхронный интерфейс для взаимодействия с Meta AI, используя GraphQL API. Он поддерживает генерацию текста и изображений, а также извлечение источников информации. Модуль предназначен для использования в асинхронных приложениях и интегрируется с другими компонентами проекта `hypotez`.

## Подробней

Модуль реализует класс `MetaAI`, который обеспечивает асинхронное взаимодействие с Meta AI. Он включает в себя функциональность для обновления токена доступа, отправки запросов, получения ответов и обработки ошибок.

Модуль использует следующие основные компоненты:
- `aiohttp` для асинхронных HTTP-запросов.
- `json` для обработки данных в формате JSON.
- `uuid` для генерации уникальных идентификаторов.
- `typing` для аннотации типов.

## Классы

### `Sources`

**Описание**: Класс `Sources` предназначен для хранения и форматирования списка источников информации, полученных от Meta AI.

**Принцип работы**:
Класс инициализируется списком словарей, где каждый словарь содержит информацию об источнике (`title` и `link`). Метод `__str__` форматирует список источников в виде Markdown-ссылок.

**Атрибуты**:
- `list` (List[Dict[str, str]]): Список словарей, представляющих источники информации.

**Методы**:
- `__init__(self, link_list: List[Dict[str, str]]) -> None`: Инициализирует объект `Sources` списком источников.
- `__str__(self) -> str`: Возвращает форматированное представление списка источников в виде Markdown-ссылок.

### `AbraGeoBlockedError`

**Описание**: Класс `AbraGeoBlockedError` представляет собой исключение, которое выбрасывается, когда Meta AI недоступен в определенной географической области.

**Принцип работы**:
Этот класс наследуется от стандартного класса `Exception` и используется для сигнализации о географических ограничениях при использовании Meta AI.

### `MetaAI`

**Описание**: Класс `MetaAI` предоставляет асинхронный интерфейс для взаимодействия с Meta AI, включая генерацию текста и изображений.

**Принцип работы**:
Класс использует `aiohttp.ClientSession` для асинхронных HTTP-запросов к Meta AI. Он поддерживает обновление токена доступа, отправку запросов и обработку ответов. Класс также обрабатывает ошибки и возвращает результаты в формате, пригодном для использования в проекте `hypotez`.

**Атрибуты**:
- `label` (str): Метка провайдера (Meta AI).
- `url` (str): URL Meta AI.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `default_model` (str): Модель, используемая по умолчанию ('meta-ai').
- `session` (ClientSession): Асинхронная HTTP-сессия для выполнения запросов.
- `cookies` (Cookies): Файлы cookie для аутентификации.
- `access_token` (str): Токен доступа для аутентификации.

**Методы**:

- `__init__(self, proxy: str = None, connector: BaseConnector = None)`

    **Назначение**: Инициализирует объект `MetaAI`.

    **Параметры**:
    - `proxy` (str, optional): Прокси-сервер для использования при выполнении запросов. По умолчанию `None`.
    - `connector` (BaseConnector, optional): Кастомный коннектор для `aiohttp.ClientSession`. По умолчанию `None`.

    **Как работает функция**:
    1. Создает асинхронную HTTP-сессию (`ClientSession`) с использованием предоставленного прокси или коннектора.
    2. Устанавливает заголовки по умолчанию (`DEFAULT_HEADERS`).
    3. Инициализирует атрибуты `cookies` и `access_token` в `None`.

    ```
    Создание HTTP-сессии --> Установка заголовков по умолчанию --> Инициализация cookies и access_token
    ```

- `create_async_generator(cls, model: str, messages: Messages, proxy: str = None, **kwargs) -> AsyncResult`

    **Назначение**: Создает асинхронный генератор для получения чанков ответа от Meta AI.

    **Параметры**:
    - `model` (str): Модель для использования.
    - `messages` (Messages): Список сообщений для отправки.
    - `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
    - `**kwargs`: Дополнительные параметры.

    **Возвращает**:
    - `AsyncResult`: Асинхронный генератор чанков ответа.

    **Как работает функция**:
    1. Создает экземпляр класса `MetaAI` с заданным прокси.
    2. Форматирует сообщения с помощью `format_prompt`.
    3. Передает отформатированное сообщение в метод `prompt` экземпляра `MetaAI`.
    4. Итерируется по чанкам, генерируемым методом `prompt`, и возвращает их.

    ```
    Создание экземпляра MetaAI --> Форматирование сообщений --> Вызов метода prompt --> Генерация чанков ответа
    ```

- `update_access_token(self, birthday: str = "1999-01-01")`

    **Назначение**: Обновляет токен доступа для Meta AI.

    **Параметры**:
    - `birthday` (str, optional): Дата рождения пользователя. По умолчанию "1999-01-01".

    **Как работает функция**:
    1. Определяет URL и полезную нагрузку (`payload`) для запроса к API Meta AI.
    2. Добавляет необходимые заголовки, включая `x-fb-friendly-name`, `x-fb-lsd` и `x-asbd-id`.
    3. Выполняет POST-запрос к API с использованием `self.session.post`.
    4. Проверяет статус ответа с помощью `raise_for_status`.
    5. Извлекает токен доступа из JSON-ответа и сохраняет его в `self.access_token`.

    ```
    Определение URL и payload --> Добавление заголовков --> POST-запрос к API --> Проверка статуса ответа --> Извлечение и сохранение токена доступа
    ```

- `prompt(self, message: str, cookies: Cookies = None) -> AsyncResult`

    **Назначение**: Отправляет запрос в Meta AI и возвращает асинхронный генератор ответа.

    **Параметры**:
    - `message` (str): Текст сообщения для отправки.
    - `cookies` (Cookies, optional): Файлы cookie для использования. По умолчанию `None`.

    **Возвращает**:
    - `AsyncResult`: Асинхронный генератор чанков ответа.

    **Вызывает исключения**:
    - `ResponseError`: Если ответ содержит сообщение об ошибке "Something Went Wrong".
    - `RuntimeError`: Если в JSON-ответе есть ошибки.

    **Как работает функция**:
    1. Проверяет и обновляет файлы cookie и токен доступа, если они не установлены или если предоставлены новые файлы cookie.
    2. Определяет URL, заголовки и полезную нагрузку для запроса в зависимости от наличия токена доступа.
    3. Выполняет POST-запрос к API с использованием `self.session.post`.
    4. Проверяет статус ответа с помощью `raise_for_status`.
    5. Итерируется по строкам в ответе и обрабатывает JSON-объекты, содержащие части ответа, изображения и источники.
    6. Генерирует чанки ответа, изображения или источники по мере их получения.
    7. Обрабатывает ошибки в JSON-ответах и выбрасывает исключения при необходимости.

    ```
    Проверка и обновление cookies и access_token --> Определение URL, заголовков и payload --> POST-запрос к API --> Итерация по строкам ответа --> Обработка JSON-объектов --> Генерация чанков ответа, изображений или источников
    ```

- `update_cookies(self, cookies: Cookies = None)`

    **Назначение**: Обновляет файлы cookie для Meta AI.

    **Параметры**:
    - `cookies` (Cookies, optional): Файлы cookie для использования. По умолчанию `None`.

    **Вызывает исключения**:
    - `AbraGeoBlockedError`: Если Meta AI недоступен в данной географической области.

    **Как работает функция**:
    1. Выполняет GET-запрос к главной странице Meta AI с использованием `self.session.get`.
    2. Проверяет наличие сообщения об ошибке `AbraGeoBlockedError` в тексте ответа.
    3. Извлекает значения `_js_datr`, `abra_csrf` и `datr` из текста ответа, если файлы cookie не предоставлены.
    4. Извлекает значения `lsd` и `dtsg` из текста ответа.
    5. Сохраняет обновленные файлы cookie, `lsd` и `dtsg` в атрибутах экземпляра класса.

    ```
    GET-запрос к главной странице Meta AI --> Проверка на AbraGeoBlockedError --> Извлечение значений cookies --> Извлечение значений lsd и dtsg --> Сохранение обновленных значений
    ```

- `fetch_sources(self, fetch_id: str) -> Sources`

    **Назначение**: Извлекает источники информации для заданного `fetch_id`.

    **Параметры**:
    - `fetch_id` (str): Идентификатор запроса.

    **Возвращает**:
    - `Sources`: Объект `Sources`, содержащий список источников информации.

    **Вызывает исключения**:
    - `ResponseError`: Если ответ содержит сообщение об ошибке "Something Went Wrong".
    - `RuntimeError`: Если произошла ошибка при разборе JSON-ответа.

    **Как работает функция**:
    1. Определяет URL, заголовки и полезную нагрузку для запроса в зависимости от наличия токена доступа.
    2. Выполняет POST-запрос к API с использованием `self.session.post`.
    3. Проверяет статус ответа с помощью `raise_for_status`.
    4. Извлекает данные об источниках из JSON-ответа и создает объект `Sources`.
    5. Обрабатывает ошибки в JSON-ответе и выбрасывает исключения при необходимости.

    ```
    Определение URL, заголовков и payload --> POST-запрос к API --> Проверка статуса ответа --> Извлечение данных об источниках --> Создание объекта Sources
    ```

- `extract_value(text: str, key: str = None, start_str = None, end_str = '",') -> str`

    **Назначение**: Извлекает значение из текста на основе заданных параметров.

    **Параметры**:
    - `text` (str): Текст для поиска.
    - `key` (str, optional): Ключ для поиска начальной строки. По умолчанию `None`.
    - `start_str` (str, optional): Начальная строка для поиска. Если `None`, используется `f'{key}":{{"value":"'`.
    - `end_str` (str, optional): Конечная строка для поиска. По умолчанию `',"`.

    **Возвращает**:
    - `str`: Извлеченное значение.

    **Как работает функция**:
    1. Определяет начальную строку для поиска, если она не предоставлена.
    2. Ищет начальную строку в тексте.
    3. Если начальная строка найдена, ищет конечную строку после начальной.
    4. Извлекает значение между начальной и конечной строками и возвращает его.

    ```
    Определение начальной строки --> Поиск начальной строки в тексте --> Поиск конечной строки --> Извлечение значения
    ```

## Функции

### `generate_offline_threading_id() -> str`

**Назначение**: Генерирует идентификатор для оффлайн-треда.

**Возвращает**:
- `str`: Сгенерированный идентификатор треда.

**Как работает функция**:
1. Генерирует случайное 64-битное целое число.
2. Получает текущую временную метку в миллисекундах.
3. Объединяет временную метку и случайное число с использованием битовых операций.
4. Преобразует результат в строку и возвращает его.

```
Генерация случайного числа --> Получение временной метки --> Объединение временной метки и случайного числа --> Преобразование результата в строку
```

**Примеры**:
```python
threading_id = generate_offline_threading_id()
print(f"Generated threading ID: {threading_id}")