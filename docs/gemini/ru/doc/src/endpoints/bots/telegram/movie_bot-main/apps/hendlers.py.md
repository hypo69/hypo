# Модуль обработчиков Telegram-бота для поиска фильмов
## Обзор

Модуль `hendlers.py` содержит обработчики для Telegram-бота, который позволяет пользователям искать фильмы и сериалы. Он использует библиотеку `aiogram` для обработки входящих сообщений и колбэков, а также модуль `apps.search` для выполнения поисковых запросов.

## Подробней

Этот модуль является частью Telegram-бота для поиска фильмов. Он определяет различные обработчики для команд и колбэков, которые позволяют пользователю взаимодействовать с ботом. В частности, модуль обрабатывает команду `/start`, запросы на поиск новых фильмов и ввод названия фильма или сериала. Модуль использует FSM (машину состояний) для управления контекстом диалога с пользователем.

## Классы

### `Params`

**Описание**: Класс `Params` представляет собой машину состояний (FSM), используемую для хранения параметров поиска фильма или сериала.

**Наследует**:
`StatesGroup` из `aiogram.fsm.state`.

**Атрибуты**:
- `type_movie` (State): Состояние, представляющее тип искомого контента (фильм или сериал).
- `name` (State): Состояние, представляющее название искомого контента.

## Функции

### `command_start_handler`

```python
async def command_start_handler(message: Message) -> None:
    """
    Обработчик команды `/start`. Отправляет приветственное сообщение пользователю и предлагает найти фильм.

    Args:
        message (Message): Объект сообщения от Telegram.

    Returns:
        None

    """
```

**Назначение**: Обрабатывает команду `/start`, отправляя приветственное сообщение пользователю и предлагая начать поиск фильма.

**Параметры**:
- `message` (Message): Объект сообщения, содержащий информацию о сообщении, отправленном пользователем.

**Возвращает**:
- `None`

**Как работает функция**:
1. Отправляет приветственное сообщение пользователю с его именем.
2. Предлагает пользователю найти интересующий фильм, отправляя клавиатуру с кнопкой "Найти фильм".

```ascii
Начало
  │
  ├──> Отправка приветственного сообщения пользователю
  │
  └──> Предложение найти фильм с клавиатурой "Найти фильм"
  │
Конец
```

**Примеры**:

```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении команды /start)
# await command_start_handler(message)
```

### `movie_handler`

```python
@router.callback_query(F.data == 'new_movies')
async def movie_handler(callback: CallbackQuery, state: FSMContext) -> None:
    """
    Обработчик колбэка для запроса новых фильмов. Устанавливает состояние `Params.type_movie` и предлагает выбрать тип контента.

    Args:
        callback (CallbackQuery): Объект колбэка от Telegram.
        state (FSMContext): Объект контекста FSM для хранения состояния диалога.

    Returns:
        None
    """
```

**Назначение**: Обрабатывает колбэк `new_movies`, устанавливая состояние машины состояний `Params.type_movie` и предлагая пользователю выбрать тип контента (фильм или сериал).

**Параметры**:
- `callback` (CallbackQuery): Объект колбэка, содержащий информацию о колбэке, отправленном пользователем.
- `state` (FSMContext): Объект контекста FSM, используемый для хранения состояния диалога с пользователем.

**Возвращает**:
- `None`

**Как работает функция**:
1. Устанавливает состояние `Params.type_movie` в FSMContext, чтобы указать, что ожидается ввод типа фильма.
2. Отправляет сообщение пользователю с предложением указать, что он ищет (фильм или сериал), используя клавиатуру `kb.choice`.

```ascii
Начало
  │
  ├──> Установка состояния Params.type_movie
  │
  └──> Отправка сообщения с предложением выбрать тип контента (фильм/сериал)
  │
Конец
```

**Примеры**:

```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении колбэка 'new_movies')
# await movie_handler(callback, state)
```

### `series_handler`

```python
@router.callback_query(F.data == 'series')
async def series_handler(callback: CallbackQuery, state: FSMContext) -> None:
    """
    Обработчик колбэка для выбора сериала. Удаляет предыдущее сообщение, обновляет данные состояния и запрашивает название сериала.

    Args:
        callback (CallbackQuery): Объект колбэка от Telegram.
        state (FSMContext): Объект контекста FSM для хранения состояния диалога.

    Returns:
        None
    """
```

**Назначение**: Обрабатывает колбэк `series`, который соответствует выбору пользователем типа контента "сериал".  Функция удаляет предыдущее сообщение с кнопками выбора типа, обновляет состояние FSMContext, указывая тип контента как "сериал", и запрашивает у пользователя название сериала.

**Параметры**:
- `callback` (CallbackQuery): Объект колбэка, содержащий информацию о колбэке, отправленном пользователем.
- `state` (FSMContext): Объект контекста FSM, используемый для хранения состояния диалога с пользователем.

**Возвращает**:
- `None`

**Как работает функция**:
1. Удаляет предыдущее сообщение с кнопками выбора типа контента.
2. Обновляет данные в FSMContext, устанавливая `type_movie` в значение `series`.
3. Устанавливает состояние `Params.name` в FSMContext, чтобы указать, что ожидается ввод названия.
4. Отправляет сообщение пользователю с запросом названия сериала.

```ascii
Начало
  │
  ├──> Удаление предыдущего сообщения
  │
  ├──> Обновление данных состояния (type_movie = 'series')
  │
  ├──> Установка состояния Params.name
  │
  └──> Отправка сообщения с запросом названия сериала
  │
Конец
```

**Примеры**:

```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении колбэка 'series')
# await series_handler(callback, state)
```

### `film_handler`

```python
@router.callback_query(F.data == 'film')
async def film_handler(callback: CallbackQuery, state: FSMContext) -> None:
    """
    Обработчик колбэка для выбора фильма. Удаляет предыдущее сообщение, обновляет данные состояния и запрашивает название фильма.

    Args:
        callback (CallbackQuery): Объект колбэка от Telegram.
        state (FSMContext): Объект контекста FSM для хранения состояния диалога.

    Returns:
        None
    """
```

**Назначение**: Обрабатывает колбэк `film`, который соответствует выбору пользователем типа контента "фильм". Функция выполняет следующие действия: удаляет предыдущее сообщение с кнопками выбора типа, обновляет состояние FSMContext, устанавливая тип контента как "фильм", и запрашивает у пользователя название фильма.

**Параметры**:
- `callback` (CallbackQuery): Объект колбэка, содержащий информацию о колбэке, отправленном пользователем.
- `state` (FSMContext): Объект контекста FSM, используемый для хранения состояния диалога с пользователем.

**Возвращает**:
- `None`

**Как работает функция**:
1. Удаляет предыдущее сообщение с кнопками выбора типа контента.
2. Обновляет данные в FSMContext, устанавливая `type_movie` в значение `film`.
3. Устанавливает состояние `Params.name` в FSMContext, чтобы указать, что ожидается ввод названия.
4. Отправляет сообщение пользователю с запросом названия фильма.

```ascii
Начало
  │
  ├──> Удаление предыдущего сообщения
  │
  ├──> Обновление данных состояния (type_movie = 'film')
  │
  ├──> Установка состояния Params.name
  │
  └──> Отправка сообщения с запросом названия фильма
  │
Конец
```

**Примеры**:

```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении колбэка 'film')
# await film_handler(callback, state)
```

### `name_handler`

```python
@router.message(Params.name)
async def name_handler(message: Message, state: FSMContext) -> None:
    """
    Обработчик ввода названия фильма/сериала. Обновляет данные состояния, выполняет поисковый запрос и отправляет результат пользователю.

    Args:
        message (Message): Объект сообщения от Telegram, содержащий название фильма/сериала.
        state (FSMContext): Объект контекста FSM для хранения состояния диалога.

    Returns:
        None
    """
```

**Назначение**: Обрабатывает ввод названия фильма или сериала от пользователя.  Функция обновляет данные в FSMContext, выполняет поисковый запрос с использованием введенного названия и типа контента, и отправляет результат пользователю.

**Параметры**:
- `message` (Message): Объект сообщения, содержащий название фильма или сериала, введенное пользователем.
- `state` (FSMContext): Объект контекста FSM, используемый для хранения состояния диалога с пользователем.

**Возвращает**:
- `None`

**Как работает функция**:
1. Обновляет данные в FSMContext, сохраняя введенное пользователем название фильма или сериала.
2. Извлекает из FSMContext название и тип контента.
3. Выполняет поисковый запрос с использованием функции `search_query` из модуля `apps.search`.
4. Отправляет пользователю сообщение с названием и типом контента.
5. Если поисковый запрос вернул результат, отправляет пользователю информацию о найденном фильме или сериале (название, описание, ссылка).
6. Если поисковый запрос не дал результатов, отправляет пользователю сообщение о том, что фильм или сериал не найден.
7. Предлагает пользователю найти новый фильм, отправляя клавиатуру `kb.find_movie`.
8. Очищает состояние FSMContext.

```ascii
Начало
  │
  ├──> Обновление данных состояния (name = message.text)
  │
  ├──> Извлечение данных из состояния (name, type_movie)
  │
  ├──> Выполнение поискового запроса (search_query)
  │
  ├──> Отправка сообщения с названием и типом контента
  │
  ├──> Проверка результата поиска
  │   ├──> Результат найден: Отправка информации о фильме/сериале
  │   └──> Результат не найден: Отправка сообщения о том, что фильм/сериал не найден
  │
  ├──> Предложение найти новый фильм
  │
  └──> Очистка состояния
  │
Конец
```

**Примеры**:

```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении сообщения в состоянии Params.name)
# await name_handler(message, state)