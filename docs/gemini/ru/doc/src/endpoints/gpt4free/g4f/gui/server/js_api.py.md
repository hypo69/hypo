# Документация модуля `js_api.py`

## Обзор

Модуль `js_api.py` является частью проекта `hypotez` и предназначен для организации взаимодействия между JavaScript-интерфейсом и серверной частью приложения. Он расширяет функциональность класса `Api` и предоставляет методы для работы с изображениями, выбора файлов, получения версий, моделей и провайдеров.

## Подробней

Этот модуль обеспечивает связь между веб-интерфейсом и серверной логикой, позволяя пользователю взаимодействовать с приложением через JavaScript. Он обрабатывает запросы на получение информации о моделях и провайдерах, а также позволяет выбирать изображения с камеры или из файловой системы пользователя.

## Классы

### `JsApi`

**Описание**: Класс `JsApi` наследуется от класса `Api` и расширяет его функциональность, добавляя методы для работы с веб-интерфейсом, такие как выбор изображений, получение версий, моделей и провайдеров.

**Принцип работы**:
Класс `JsApi` использует методы из класса `Api` для получения информации о моделях и провайдерах. Он также предоставляет методы для работы с изображениями, позволяя пользователю выбирать изображения с камеры или из файловой системы. Класс взаимодействует с JavaScript-интерфейсом через библиотеку `webview`.

**Методы**:

- `get_conversation(options: dict, message_id: str = None, scroll: bool = None) -> Iterator`: Получает разговор, отправляет чанки сообщений в вебвью и обрабатывает остановку.
- `choose_image()`: Открывает диалоговое окно выбора изображения.
- `take_picture()`: Делает снимок с камеры.
- `on_image_selection(filename)`: Обрабатывает выбор изображения из файловой системы.
- `on_camera(filename)`: Обрабатывает снимок, сделанный камерой.
- `set_selected(input_id: str = None)`: Устанавливает выбранный элемент в веб-интерфейсе.
- `get_version()`: Возвращает версию API.
- `get_models()`: Возвращает список доступных моделей.
- `get_providers()`: Возвращает список доступных провайдеров.
- `get_provider_models(provider: str, **kwargs)`: Возвращает список моделей для указанного провайдера.

## Функции

### `get_conversation`

```python
def get_conversation(self, options: dict, message_id: str = None, scroll: bool = None) -> Iterator:
    """
    Получает разговор, отправляет чанки сообщений в вебвью и обрабатывает остановку.

    Args:
        options (dict): Опции для разговора.
        message_id (str, optional): Идентификатор сообщения. По умолчанию `None`.
        scroll (bool, optional): Флаг прокрутки. По умолчанию `None`.

    Returns:
        Iterator: Итератор сообщений.
    """
```

**Назначение**: Получает разговор на основе предоставленных опций, отправляет чанки сообщений в веб-интерфейс (webview) и обрабатывает остановку процесса.

**Параметры**:
- `options` (dict): Словарь с опциями для разговора, включая `conversation_id` и `provider`. Также может содержать изображение в поле `image`, если оно было выбрано пользователем.
- `message_id` (str, optional): Идентификатор сообщения, который будет передан в веб-интерфейс. По умолчанию `None`.
- `scroll` (bool, optional): Флаг, указывающий, нужно ли прокручивать окно веб-интерфейса. По умолчанию `None`.

**Возвращает**:
- `Iterator`: Итератор, возвращающий сообщения разговора.

**Как работает функция**:
1. **Инициализация**:
   - Функция принимает словарь `options`, содержащий параметры разговора, идентификатор сообщения `message_id` и флаг прокрутки `scroll`.
   - Получает доступ к первому окну веб-интерфейса через `webview.windows[0]`.
   - Проверяет, есть ли изображение, сохраненное в атрибуте `self.image`, и добавляет его в опции, если оно присутствует.

2. **Создание потока ответов**:
   - Вызывает метод `self._create_response_stream`, передавая подготовленные аргументы для разговора и идентификатор разговора.
   - Этот метод возвращает генератор сообщений.

3. **Отправка сообщений в веб-интерфейс**:
   - Для каждого сообщения, полученного из генератора, функция выполняет JavaScript-код в веб-интерфейсе с помощью `window.evaluate_js`.
   - JavaScript-код вызывает функцию `add_message_chunk`, которая добавляет сообщение в интерфейс.
   - JavaScript-код также проверяет, не была ли остановлена обработка, вызывая функцию `is_stopped`. Если обработка остановлена, цикл прерывается.

4. **Очистка**:
   - После завершения цикла (или при его прерывании) функция устанавливает атрибут `self.image` в `None` и вызывает метод `self.set_selected(None)`, чтобы снять выделение с выбранного изображения в интерфейсе.

**Примеры**:

```python
# Пример вызова функции get_conversation с минимальными параметрами
options = {"conversation_id": "123", "provider": "openai"}
js_api = JsApi()
for message in js_api.get_conversation(options):
    print(message)

# Пример вызова функции get_conversation с указанием message_id и scroll
options = {"conversation_id": "456", "provider": "google"}
js_api = JsApi()
for message in js_api.get_conversation(options, message_id="789", scroll=True):
    print(message)
```

### `choose_image`

```python
def choose_image(self):
    """
    Открывает диалоговое окно выбора изображения.
    """
```

**Назначение**: Открывает диалоговое окно для выбора изображения из файловой системы пользователя.

**Как работает функция**:
1. Функция использует `filechooser.open_file` для открытия диалогового окна выбора файла.
2. Параметры `path` и `filters` задают начальный каталог и фильтры для выбора файлов изображений.
3. Функция `on_selection` вызывается после выбора файла, передавая выбранный файл в метод `self.on_image_selection`.

### `take_picture`

```python
def take_picture(self):
    """
    Делает снимок с камеры.
    """
```

**Назначение**: Открывает интерфейс камеры для создания снимка.

**Как работает функция**:
1. Формирует имя файла для сохранения снимка, используя `uuid4` для уникальности имени.
2. Вызывает `camera.take_picture` для открытия интерфейса камеры и сохранения снимка по указанному пути.
3. Функция `on_complete` вызывается после создания снимка, передавая имя файла в метод `self.on_camera`.

### `on_image_selection`

```python
def on_image_selection(self, filename):
    """
    Обрабатывает выбор изображения из файловой системы.

    Args:
        filename: Имя выбранного файла.
    """
```

**Назначение**: Обрабатывает имя файла, выбранного пользователем из файловой системы, и устанавливает его как текущее изображение.

**Параметры**:
- `filename`: Имя выбранного файла (может быть списком, если выбрано несколько файлов).

**Как работает функция**:
1. Проверяет, является ли `filename` списком и содержит ли он элементы. Если да, берет первый элемент списка.
2. Проверяет, существует ли файл с указанным именем.
3. Если файл существует, устанавливает `self.image` в значение `filename`. В противном случае устанавливает `self.image` в `None`.
4. Вызывает `self.set_selected`, передавая `None`, если `self.image` равно `None`, и "image" в противном случае.

### `on_camera`

```python
def on_camera(self, filename):
    """
    Обрабатывает снимок, сделанный камерой.

    Args:
        filename: Имя файла, в который был сохранен снимок.
    """
```

**Назначение**: Обрабатывает имя файла, в который был сохранен снимок, сделанный с камеры, и устанавливает его как текущее изображение.

**Параметры**:
- `filename`: Имя файла, в который был сохранен снимок.

**Как работает функция**:
1. Проверяет, существует ли файл с указанным именем.
2. Если файл существует, устанавливает `self.image` в значение `filename`. В противном случае устанавливает `self.image` в `None`.
3. Вызывает `self.set_selected`, передавая `None`, если `self.image` равно `None`, и "camera" в противном случае.

### `set_selected`

```python
def set_selected(self, input_id: str = None):
    """
    Устанавливает выбранный элемент в веб-интерфейсе.

    Args:
        input_id (str, optional): Идентификатор выбранного элемента. По умолчанию `None`.
    """
```

**Назначение**: Устанавливает визуальное выделение для выбранного элемента в веб-интерфейсе, удаляя выделение с других элементов.

**Параметры**:
- `input_id` (str, optional): Идентификатор элемента, который нужно выделить. По умолчанию `None`.

**Как работает функция**:
1. Получает доступ к первому окну веб-интерфейса через `webview.windows[0]`.
2. Если окно существует, выполняет JavaScript-код для удаления класса `selected` со всех элементов с классом `image-label.selected`.
3. Если `input_id` не равен `None` и равен "image" или "camera", выполняет JavaScript-код для добавления класса `selected` к элементу `<label>` с атрибутом `for`, соответствующим `input_id`.

### `get_version`

```python
def get_version(self):
    """
    Возвращает версию API.
    """
```

**Назначение**: Возвращает версию API, используя метод `get_version` из родительского класса `Api`.

**Как работает функция**:
1. Вызывает метод `super().get_version()`, который возвращает версию API.

### `get_models`

```python
def get_models(self):
    """
    Возвращает список доступных моделей.
    """
```

**Назначение**: Возвращает список доступных моделей, используя метод `get_models` из родительского класса `Api`.

**Как работает функция**:
1. Вызывает метод `super().get_models()`, который возвращает список доступных моделей.

### `get_providers`

```python
def get_providers(self):
    """
    Возвращает список доступных провайдеров.
    """
```

**Назначение**: Возвращает список доступных провайдеров, используя метод `get_providers` из родительского класса `Api`.

**Как работает функция**:
1. Вызывает метод `super().get_providers()`, который возвращает список доступных провайдеров.

### `get_provider_models`

```python
def get_provider_models(self, provider: str, **kwargs):
    """
    Возвращает список моделей для указанного провайдера.

    Args:
        provider (str): Название провайдера.
        **kwargs: Дополнительные аргументы.
    """
```

**Назначение**: Возвращает список моделей, доступных для указанного провайдера, используя метод `get_provider_models` из родительского класса `Api`.

**Параметры**:
- `provider` (str): Название провайдера.
- `**kwargs`: Дополнительные аргументы.

**Как работает функция**:
1. Вызывает метод `super().get_provider_models(provider, **kwargs)`, который возвращает список моделей для указанного провайдера.