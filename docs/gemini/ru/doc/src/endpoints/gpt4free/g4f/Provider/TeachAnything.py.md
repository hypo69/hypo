# Модуль TeachAnything.py

## Обзор

Модуль `TeachAnything.py` предоставляет асинхронный интерфейс для взаимодействия с API сайта [teach-anything.com](https://www.teach-anything.com). Он позволяет генерировать ответы на основе предоставленных сообщений, используя модели, такие как `gemini-1.5-pro` и `gemini-1.5-flash`. Модуль предназначен для интеграции в систему, требующую асинхронной обработки запросов к указанному API.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для обеспечения возможности взаимодействия с сервисом `teach-anything.com`. Он предоставляет класс `TeachAnything`, который упрощает отправку запросов к API и получение ответов в асинхронном режиме. Модуль использует библиотеку `aiohttp` для выполнения асинхронных HTTP-запросов и предоставляет методы для форматирования запросов и обработки ответов. Класс поддерживает выбор модели для генерации ответов.

## Классы

### `TeachAnything`

**Описание**: Класс `TeachAnything` является провайдером асинхронной генерации текста, взаимодействующим с API `teach-anything.com`.

**Принцип работы**:
Класс использует `aiohttp.ClientSession` для отправки асинхронных POST-запросов к API `teach-anything.com`. Он реализует методы для форматирования запроса, установки заголовков и обработки потоковых ответов. Поддерживает выбор различных моделей, таких как `gemini-1.5-pro` и `gemini-1.5-flash`.

**Методы**:

- `create_async_generator`: Асинхронный генератор для создания потока ответов от API.
- `_get_headers`: Статический метод для получения необходимых HTTP-заголовков.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str | None = None,
    **kwargs: Any
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от API `teach-anything.com`.

    Args:
        model (str): Имя используемой модели (например, 'gemini-1.5-pro').
        messages (Messages): Список сообщений для отправки в API.
        proxy (str | None, optional): Адрес прокси-сервера. По умолчанию `None`.
        **kwargs (Any): Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий части ответа от API.

    Raises:
        aiohttp.ClientResponseError: Если HTTP-запрос завершается с ошибкой.

    Как работает функция:

    1. **Формирование заголовков и выбор модели**: Функция начинается с получения необходимых HTTP-заголовков с помощью `cls._get_headers()` и выбора модели с использованием `cls.get_model(model)`.
    2. **Создание асинхронной сессии**: Создается асинхронная сессия `aiohttp.ClientSession` для выполнения HTTP-запросов.
    3. **Форматирование запроса**: Список сообщений `messages` форматируется в строку `prompt` с использованием функции `format_prompt(messages)`.
    4. **Выполнение POST-запроса**: Выполняется POST-запрос к API `teach-anything.com` с использованием `session.post`. Запрос включает в себя `prompt`, параметры прокси и таймаут.
    5. **Обработка потока данных**: Функция итерируется по частям ответа, полученным из `response.content.iter_any()`. Каждая часть добавляется в буфер `buffer`.
    6. **Декодирование и выдача результата**:
       - Пытается декодировать содержимое буфера `buffer` в строку UTF-8.
       - Если декодирование успешно, строка выдается через `yield`, и буфер очищается.
       - Если происходит ошибка декодирования `UnicodeDecodeError`, функция ожидает поступления новых данных в буфер.
    7. **Обработка остатка буфера**: После завершения потока проверяется, остались ли данные в буфере. Если да, функция пытается декодировать их и выдать результат.
    8. **Обработка ошибок декодирования**: Если при декодировании остатка буфера возникает ошибка, она выводится в консоль.

    Внутри функции происходят следующие действия и преобразования:

    A: Получение и подготовка данных (`headers`, `model`, `prompt`).
    |
    -- B: Создание асинхронной сессии (`ClientSession`).
    |
    C: Отправка POST-запроса к API и получение ответа.
    |
    D: Потоковая обработка данных (`iter_any`).
    |
    E: Декодирование (`decode`) и выдача (`yield`) частей ответа.
    |
    F: Обработка остатка данных в буфере.

    Примеры:
    - Пример вызова функции с минимальными параметрами:

    ```python
    model = "gemini-1.5-pro"
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    # result = await TeachAnything.create_async_generator(model=model, messages=messages)
    ```

    - Пример вызова функции с указанием прокси:

    ```python
    model = "gemini-1.5-pro"
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    proxy = "http://your-proxy-address:8080"
    # result = await TeachAnything.create_async_generator(model=model, messages=messages, proxy=proxy)
    ```
    """
    ...
```

### `_get_headers`

```python
@staticmethod
def _get_headers() -> Dict[str, str]:
    """
    Возвращает словарь с HTTP-заголовками, необходимыми для запросов к API `teach-anything.com`.

    Returns:
        Dict[str, str]: Словарь HTTP-заголовков.

    Как работает функция:

    1. **Определение заголовков**: Функция определяет набор HTTP-заголовков, включая `accept`, `accept-language`, `cache-control`, `content-type` и другие.
    2. **Возврат словаря**: Функция возвращает словарь, содержащий все необходимые заголовки и их значения.

    Внутри функции происходят следующие действия и преобразования:

    A: Определение HTTP-заголовков.
    |
    B: Возврат словаря с заголовками.

    Примеры:
    - Пример получения заголовков:

    ```python
    headers = TeachAnything._get_headers()
    print(headers)
    ```
    """
    ...