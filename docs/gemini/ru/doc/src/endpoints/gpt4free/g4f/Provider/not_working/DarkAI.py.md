# Модуль `DarkAI`

## Обзор

Модуль `DarkAI` предоставляет асинхронный интерфейс для взаимодействия с сервисом `darkai.foundation`. Он позволяет отправлять запросы к API для генерации текста на основе предоставленных сообщений, используя различные модели, такие как `gpt-4o`, `gpt-3.5-turbo` и `llama-3-70b`. Модуль поддерживает потоковую передачу данных и использует `aiohttp` для асинхронных запросов.

## Подробней

Модуль предназначен для интеграции с другими компонентами проекта `hypotez`, требующими доступа к API `darkai.foundation` для генерации текста. Он предоставляет удобный способ отправки запросов и обработки потоковых ответов, обеспечивая гибкость в выборе модели и возможность использования прокси. Модуль также обрабатывает ошибки и исключения, возникающие в процессе взаимодействия с API.

## Классы

### `DarkAI`

**Описание**: Класс `DarkAI` является асинхронным провайдером и реализует методы для взаимодействия с API `darkai.foundation`. Он поддерживает потоковую передачу данных и предоставляет возможность выбора модели для генерации текста.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных провайдеров, генерирующих данные.
- `ProviderModelMixin`: Предоставляет общие методы для работы с моделями провайдера.

**Атрибуты**:
- `url` (str): URL сервиса `darkai.foundation`.
- `api_endpoint` (str): URL API для отправки запросов.
- `working` (bool): Флаг, указывающий на работоспособность провайдера. В данном случае всегда `False`.
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных. В данном случае `True`.
- `default_model` (str): Модель, используемая по умолчанию (`llama-3-70b`).
- `models` (list[str]): Список поддерживаемых моделей.
- `model_aliases` (dict[str, str]): Словарь псевдонимов моделей.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения потоковых ответов от API.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для получения потоковых ответов от API darkai.foundation.

        Args:
            model (str): Название модели для генерации текста.
            messages (Messages): Список сообщений для отправки в API.
            proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий потоковые ответы от API.

        Raises:
            Exception: Если возникает ошибка при взаимодействии с API.
        """
        ...
```

**Назначение**: Создает асинхронный генератор для взаимодействия с API `darkai.foundation` и получения потоковых ответов.

**Параметры**:
- `model` (str): Название модели для генерации текста.
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий потоковые ответы от API.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при взаимодействии с API.

**Как работает функция**:
1. **Получение модели**: Функция получает название модели, используя метод `get_model` класса `DarkAI`.
2. **Формирование заголовков**: Функция формирует заголовки HTTP-запроса, включая `accept`, `content-type` и `user-agent`.
3. **Создание сессии**: Функция создает асинхронную сессию `aiohttp` с заданными заголовками и увеличенным таймаутом.
4. **Формирование данных**: Функция форматирует запрос, используя функцию `format_prompt` и формирует данные для отправки в API.
5. **Отправка запроса**: Функция отправляет POST-запрос к API `darkai.foundation` с использованием асинхронной сессии и прокси (если указан).
6. **Обработка ответа**: Функция обрабатывает потоковый ответ от API, читая его небольшими частями (`chunk`).
7. **Декодирование и обработка данных**: Декодирует каждую часть, и если находит в начале `data: `, пытается загрузить JSON из остальной части строки. В зависимости от значения `event` в JSON (`text-chunk` или `stream-end`), возвращает текст или завершает работу.
8. **Обработка ошибок**: Функция обрабатывает исключения, возникающие при взаимодействии с API, и логирует их.

```
A: Получение модели
|
B: Формирование заголовков
|
C: Создание асинхронной сессии
|
D: Формирование данных запроса
|
E: Отправка POST-запроса к API
|
F: Чтение потокового ответа небольшими частями (chunk)
|
G: Декодирование и обработка данных (JSON)
|
H: Возвращение текста или завершение
```

**Примеры**:

Пример 1: Использование с минимальными параметрами.

```python
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Hello, how are you?"}]
async for chunk in DarkAI.create_async_generator(model=model, messages=messages):
    print(chunk, end="")
```

Пример 2: Использование с прокси.

```python
model = "gpt-4o"
messages = [{"role": "user", "content": "Tell me a joke."}]
proxy = "http://your_proxy:8080"
async for chunk in DarkAI.create_async_generator(model=model, messages=messages, proxy=proxy):
    print(chunk, end="")
```