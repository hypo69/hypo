# Модуль перевода полей товара на языки клиентской базы данных

## Обзор

Модуль предназначен для перевода мультиязычных полей товара в соответствии со схемой идентификаторов языка в базе данных клиента PrestaShop. Он получает словарь полей товара, собранный со страницы поставщика, и обновляет идентификаторы языка в соответствии со схемой языков клиента.

## Подробней

Этот модуль играет важную роль в процессе синхронизации данных о товарах между поставщиком и клиентской базой PrestaShop. PrestaShop может иметь различные идентификаторы языков в зависимости от того, на каком языке была изначально установлена система. Этот модуль обеспечивает правильное соответствие языков, чтобы избежать проблем с отображением информации о товарах.

## Функции

### `rearrange_language_keys`

```python
def rearrange_language_keys(presta_fields_dict: dict, client_langs_schema: dict | List[dict], page_lang: str) -> dict:
    """Функция обновляет идентификатор языка в словаре presta_fields_dict на соответствующий идентификатор
    из схемы клиентских языков при совпадении языка страницы.

    Args:
        presta_fields_dict (dict): Словарь полей товара.
        page_lang (str): Язык страницы.
        client_langs_schema (list | dict): Схема языков клиента.

    Returns:
        dict: Обновленный словарь presta_fields_dict.
    """
```

**Назначение**: Обновляет идентификаторы языка в словаре `presta_fields_dict` на соответствующие идентификаторы из схемы клиентских языков, когда язык страницы совпадает.

**Параметры**:

*   `presta_fields_dict` (dict): Словарь полей товара, который требуется обновить.
*   `client_langs_schema` (dict | List[dict]): Схема языков клиента, содержащая соответствия между языками и их идентификаторами.
*   `page_lang` (str): Язык страницы, для которой необходимо выполнить обновление.

**Возвращает**:

*   `dict`: Обновленный словарь `presta_fields_dict` с новыми идентификаторами языков.

**Как работает функция**:

1.  **Поиск идентификатора языка клиента**: Функция перебирает схему языков клиента (`client_langs_schema`) для поиска соответствия языка страницы (`page_lang`). Она проверяет совпадение по полям `locale`, `iso_code` и `language_code`.
2.  **Обновление идентификаторов в полях товара**: Если идентификатор языка клиента найден, функция перебирает поля товара в словаре `presta_fields_dict`. Для каждого поля, содержащего информацию о языке, она обновляет атрибут `id` на найденный идентификатор языка клиента. Важно отметить, что `id` приводится к строке, так как это необходимо для XML парсера.

**ASCII flowchart**:

```
Начало
  ↓
Поиск соответствия языка страницы в схеме языков клиента
  ↓
Найдено соответствие?
  ├── Да → Обновление идентификаторов языка в полях товара
  │    │
  │    Перебор полей товара
  │    ↓
  │    Поле содержит информацию о языке?
  │    ├── Да → Обновление атрибута 'id'
  │    └── Нет
  │    ↓
  └── Нет
  ↓
Конец
```

**Примеры**:

```python
presta_fields_dict = {
    'name': {
        'language': [
            {'attrs': {'id': '1'}, 'value': 'Product Name in English'}
        ]
    }
}
client_langs_schema = [
    {'id': '10', 'locale': 'en-US', 'iso_code': 'en', 'language_code': 'en-us'},
    {'id': '20', 'locale': 'fr-FR', 'iso_code': 'fr', 'language_code': 'fr-fr'}
]
page_lang = 'en-US'

updated_dict = rearrange_language_keys(presta_fields_dict, client_langs_schema, page_lang)
print(updated_dict)
# {'name': {'language': [{'attrs': {'id': '10'}, 'value': 'Product Name in English'}]}}
```

### `translate_presta_fields_dict`

```python
def translate_presta_fields_dict (presta_fields_dict: dict, 
                                  client_langs_schema: list | dict, 
                                  page_lang: str = None) -> dict:
    """ @Перевод мультиязычных полей в соответствии со схемой значений `id` языка в базе данных клиента
	    Функция получает на вход заполненный словарь полей. Мультиязычные поля содржат значения,\n
	    полученные с сайта поставщика в виде словаря \n
	    ```\n
	    {\n
	\t    \'language\':[\n
	\t\t\t\t\t    {\'attrs\':{\'id\':\'1\'}, \'value\':value},\n
	\t\t\t\t\t    ]\n
	    }\n
	    ```\n
	    У клиента язык с ключом `id=1` Может быть любым в зависимости от того на каком языке была \n
	    изначально установлена PrestaShop. Чаще всего это английский, но это не правило.\n
	    Точные соответствия я получаю в схеме языков клиента \n
	    locator_description\n
	    Самый быстрый способ узнать схему API языков - набрать в адресной строке браузера\n
	    https://API_KEY@mypresta.com/api/languages?display=full&io_format=JSON\n
	  \n
    @param client_langs_schema `dict` словарь актуальных языков на клиенте\n
    @param presta_fields_dict `dict` словарь полей товара собранный со страницы поставщика\n
    @param page_lang `str` язык страницы поставщика в коде en-US, ru-RU, he_HE. \n
    Если не задан - функция пытается определить п тексту\n
    @returns presta_fields_dict переведенный словарь полей товара
    """
```

**Назначение**: Переводит мультиязычные поля в соответствии со схемой значений `id` языка в базе данных клиента.

**Параметры**:

*   `presta_fields_dict` (dict): Словарь полей товара, собранный со страницы поставщика. Мультиязычные поля содержат значения, полученные с сайта поставщика в виде словаря.
*   `client_langs_schema` (list | dict): Словарь актуальных языков на клиенте.
*   `page_lang` (str, optional): Язык страницы поставщика в коде (например, en-US, ru-RU, he_HE). Если не задан, функция пытается определить по тексту. По умолчанию `None`.

**Возвращает**:

*   `dict`: Переведенный словарь полей товара `presta_fields_dict`.

**Как работает функция**:

1.  **Переупорядочивание ключей таблицы**: Вызывается функция `rearrange_language_keys` для обновления идентификаторов языка в словаре `presta_fields_dict` в соответствии со схемой языков клиента.
2.  **Получение переводов из таблицы**: Вызывается функция `get_translations_from_presta_translations_table` для получения существующих переводов товара из таблицы переводов.
3.  **Добавление новых переводов**: Если в таблице переводов нет перевода товара, функция добавляет текущий перевод как новый, используя функции `insert_new_translation_to_presta_translations_table`.
4.  **Перевод полей**: Функция перебирает схему языков клиента и записи с переводами. Если `iso_code` языка клиента содержится в `locale` записи перевода, то значения полей товара обновляются на значения из записи перевода.
5.  **Обработка ошибок**: Если во время перевода возникает ошибка, она логируется с использованием `logger.error`.

**ASCII flowchart**:

```
Начало
  ↓
Переупорядочивание ключей таблицы (rearrange_language_keys)
  ↓
Получение переводов из таблицы (get_translations_from_presta_translations_table)
  ↓
Переводы найдены?
  ├── Нет → Добавление текущего перевода как нового
  │    │
  │    Добавление перевода в таблицу (insert_new_translation_to_presta_translations_table)
  │    ↓
  └── Да
  ↓
Перебор схемы языков клиента и записей с переводами
  ↓
Совпадение iso_code языка клиента и locale записи перевода?
  ├── Да → Обновление значений полей товара
  └── Нет
  ↓
Конец
```

**Примеры**:

```python
presta_fields_dict = {
    'name': {
        'language': [
            {'attrs': {'id': '1'}, 'value': 'Product Name in English'}
        ]
    },
    'reference': '12345'
}
client_langs_schema = [
    {'id': '10', 'locale': 'en-US', 'iso_code': 'en', 'language_code': 'en-us'},
    {'id': '20', 'locale': 'fr-FR', 'iso_code': 'fr', 'language_code': 'fr-fr'}
]
page_lang = 'en-US'

translated_dict = translate_presta_fields_dict(presta_fields_dict, client_langs_schema, page_lang)
print(translated_dict)
# {'name': {'language': [{'attrs': {'id': '10'}, 'value': 'Product Name in English'}]}, 'reference': '12345'}
```