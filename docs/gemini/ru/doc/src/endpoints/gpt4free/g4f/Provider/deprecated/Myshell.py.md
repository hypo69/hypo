# Модуль `Myshell.py`

## Обзор

Модуль `Myshell.py` предоставляет асинхронный интерфейс для взаимодействия с сервисом Myshell AI. Он включает в себя класс `Myshell`, который позволяет генерировать текст на основе предоставленных сообщений, используя различные модели, такие как "samantha", "gpt-3.5-turbo" и "gpt-4". Модуль также содержит функции для генерации идентификаторов посетителей и подписей, используемых при взаимодействии с API Myshell.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для обеспечения взаимодействия с сервисом Myshell AI. Он использует асинхронные запросы через библиотеку `aiohttp` для отправки и получения сообщений. Модуль поддерживает выбор различных моделей, а также предоставляет функциональность для генерации уникальных идентификаторов посетителей и подписей, необходимых для аутентификации и авторизации запросов.

## Классы

### `Myshell`

**Описание**: Класс `Myshell` является асинхронным провайдером для взаимодействия с API Myshell. Он предоставляет методы для создания асинхронных генераторов, которые позволяют получать ответы от модели частями.

**Наследует**: `AsyncGeneratorProvider`

**Атрибуты**:
- `url` (str): URL-адрес для подключения к API Myshell ("https://app.myshell.ai/chat").
- `working` (bool): Указывает, работает ли провайдер (всегда `False`).
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель "gpt-3.5-turbo" (`True`).
- `supports_gpt_4` (bool): Указывает, поддерживает ли провайдер модель "gpt-4" (`True`).

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        timeout: int = 90,
        **kwargs
    ) -> AsyncResult:
        """ Создает асинхронный генератор для взаимодействия с API Myshell.

        Args:
            model (str): Имя модели, которую нужно использовать.
            messages (Messages): Список сообщений для отправки в API.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            timeout (int, optional): Время ожидания ответа от API в секундах. По умолчанию `90`.
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий части ответа от API.

        Raises:
            ValueError: Если указанная модель не поддерживается.
            RuntimeError: Если получен неожиданный тип сообщения от API.

        Example:
            >>> async for message_part in Myshell.create_async_generator(model="gpt-3.5-turbo", messages=[{"role": "user", "content": "Hello!"}]):
            ...     print(message_part, end="")
        """
```

**Как работает функция**:
1. **Выбор Bot ID**: Определяет идентификатор бота (`bot_id`) на основе выбранной модели (`model`). Если модель не указана, используется "samantha". Если модель не найдена в списке поддерживаемых, вызывается исключение `ValueError`.
2. **Генерация Visitor ID**: Генерирует уникальный идентификатор посетителя (`visitor_id`) с использованием функции `generate_visitor_id` и user agent.
3. **Создание Сессии Aiohttp**: Создает асинхронную сессию `aiohttp` с заголовком `User-Agent`.
4. **Подключение к Websocket**: Устанавливает websocket-соединение с API Myshell.
5. **Обмен Приветствиями**: Отправляет и получает приветственное сообщение для установки соединения.
6. **Решение Проблемы Captcha**: Добавляет задержку в 5 секунд для обхода проблемы с капчей.
7. **Формирование Данных Чата**: Формирует JSON-структуру с данными чата, включая текст сообщения, идентификатор бота и сгенерированную подпись.
8. **Отправка Сообщения Чата**: Отправляет сообщение чата через websocket.
9. **Прием Сообщений**: Принимает сообщения от API через websocket и обрабатывает их. Если получен текстовый фрагмент, возвращает его через генератор. Если получен финальный флаг, завершает генерацию.
10. **Обработка Неожиданных Сообщений**: При получении неожиданного типа сообщения, такого как "message_replied" или "need_verify_captcha", вызывается исключение `RuntimeError`.

**ASCII схема работы функции**:

```
Начало
  │
  ├─> Определение Bot ID (на основе model)
  │
  ├─> Генерация Visitor ID
  │
  ├─> Создание Aiohttp Session
  │
  ├─> Подключение к Websocket
  │
  ├─> Обмен Приветствиями
  │
  ├─> Задержка (обход Captcha)
  │
  ├─> Формирование Данных Чата
  │
  ├─> Отправка Сообщения Чата
  │
  │   Цикл приема сообщений:
  │   │
  │   ├─> Прием Сообщения из Websocket
  │   │
  │   ├─> Проверка типа сообщения
  │   │   │
  │   │   ├─> Текст: Возврат фрагмента текста
  │   │   │
  │   │   ├─> Финал: Завершение генерации
  │   │   │
  │   │   └─> Неожиданное сообщение: Вызов RuntimeError
  │   │
  │   └─> Конец цикла
  │
  │
  └─> Завершение
```

**Примеры**:

```python
async for message_part in Myshell.create_async_generator(model="gpt-3.5-turbo", messages=[{"role": "user", "content": "Hello!"}]):
    print(message_part, end="")

async for message_part in Myshell.create_async_generator(model="gpt-4", messages=[{"role": "user", "content": "Как дела?"}], proxy="http://your_proxy:8080"):
    print(message_part, end="")
```

## Функции

### `generate_timestamp`

```python
def generate_timestamp() -> str:
    """ Генерирует временную метку в определенном формате.

    Returns:
        str: Временная метка в виде строки.

    Example:
        >>> generate_timestamp()
        '16969243532'
    """
```

**Как работает функция**:

1. **Получение текущего времени**: Получает текущее время в миллисекундах и преобразует его в целое число.
2. **Удаление последней цифры**: Преобразует время в строку и удаляет последнюю цифру.
3. **Вычисление суммы цифр**: Вычисляет сумму цифр полученного числа, умножая каждую четную цифру на 2 и каждую нечетную на 3.
4. **Формирование временной метки**: Объединяет полученные значения в строку и возвращает результат.

**ASCII схема работы функции**:

```
Начало
  │
  ├─> Получение времени (мс)
  │
  ├─> Удаление последней цифры
  │
  ├─> Вычисление суммы цифр
  │
  └─> Формирование метки времени
  │
  └─> Завершение
```

**Примеры**:

```python
generate_timestamp()  # Пример вызова
```

### `generate_signature`

```python
def generate_signature(text: str):
    """ Генерирует подпись для запроса к API Myshell.

    Args:
        text (str): Текст сообщения, для которого генерируется подпись.

    Returns:
        dict: Словарь, содержащий подпись, временную метку и версию.

    Example:
        >>> generate_signature("Hello")
        {'signature': '...', 'timestamp': '...', 'version': 'v1.0.0'}
    """
```

**Как работает функция**:

1. **Генерация временной метки**: Вызывает функцию `generate_timestamp` для получения временной метки.
2. **Определение версии и секрета**: Устанавливает версию API и секретный ключ.
3. **Формирование данных для подписи**: Объединяет версию, текст сообщения, временную метку и секретный ключ в строку.
4. **Вычисление MD5 хеша**: Вычисляет MD5 хеш от полученной строки.
5. **Инвертирование подписи**: Инвертирует полученный хеш.
6. **Формирование словаря с подписью**: Создает словарь, содержащий подпись, временную метку и версию.

**ASCII схема работы функции**:

```
Начало
  │
  ├─> Генерация метки времени
  │
  ├─> Определение версии/секрета
  │
  ├─> Формирование данных
  │
  ├─> Вычисление MD5 хеша
  │
  ├─> Инвертирование подписи
  │
  └─> Формирование словаря
  │
  └─> Завершение
```

**Примеры**:

```python
generate_signature("Hello")  # Пример вызова
```

### `xor_hash`

```python
def xor_hash(B: str):
    """ Вычисляет XOR хеш строки.

    Args:
        B (str): Строка для вычисления хеша.

    Returns:
        str: XOR хеш строки в шестнадцатеричном формате.

    Example:
        >>> xor_hash("test")
        '...'
    """
```

**Как работает функция**:

1. **Инициализация**: Инициализирует пустой список `r` и переменную `i` равной 0.
2. **Внутренняя функция o**: Определяет внутреннюю функцию `o`, которая выполняет XOR операцию между `e` и значением, полученным из списка `r`.
3. **Цикл по строке**: Проходит по каждому символу строки `B`.
4. **Добавление в список**: Добавляет ASCII код символа в список `r`.
5. **XOR операция**: Если длина списка `r` достигает 4, выполняет XOR операцию с использованием внутренней функции `o` и очищает список `r`.
6. **Финальная XOR операция**: Если после цикла в списке `r` остались элементы, выполняет XOR операцию с их использованием.
7. **Возврат хеша**: Возвращает XOR хеш в шестнадцатеричном формате.

**ASCII схема работы функции**:

```
Начало
  │
  ├─> Инициализация
  │
  │   Цикл по строке B:
  │   │
  │   ├─> Добавление в список r
  │   │
  │   ├─> Если len(r) >= 4:
  │   │   │
  │   │   ├─> XOR операция
  │   │   │
  │   │   └─> Очистка списка r
  │   │
  │   └─> Конец цикла
  │
  ├─> Финальная XOR операция
  │
  └─> Возврат хеша
  │
  └─> Завершение
```

**Примеры**:

```python
xor_hash("test")  # Пример вызова
```

### `performance`

```python
def performance() -> str:
    """ Генерирует строку на основе времени выполнения.

    Returns:
        str: Строка, содержащая время и количество итераций.

    Example:
        >>> performance()
        '...'
    """
```

**Как работает функция**:

1. **Получение текущего времени**: Получает текущее время в миллисекундах.
2. **Определение количества итераций**: Увеличивает счетчик `e` до тех пор, пока текущее время не изменится.
3. **Формирование строки**: Объединяет время и количество итераций в строку в шестнадцатеричном формате.

**ASCII схема работы функции**:

```
Начало
  │
  ├─> Получение времени (мс)
  │
  ├─> Определение кол-ва итераций
  │
  └─> Формирование строки
  │
  └─> Завершение
```

**Примеры**:

```python
performance()  # Пример вызова
```

### `generate_visitor_id`

```python
def generate_visitor_id(user_agent: str) -> str:
    """ Генерирует уникальный идентификатор посетителя.

    Args:
        user_agent (str): User agent пользователя.

    Returns:
        str: Уникальный идентификатор посетителя.

    Example:
        >>> generate_visitor_id("Mozilla/5.0 ...")
        '...'
    """
```

**Как работает функция**:

1. **Генерация составляющих**: Генерирует составляющие идентификатора, используя функции `performance`, `random.random`, `xor_hash` и константы.
2. **Формирование идентификатора**: Объединяет полученные составляющие в строку, разделенную дефисами.

**ASCII схема работы функции**:

```
Начало
  │
  ├─> Генерация составляющих
  │
  └─> Формирование идентификатора
  │
  └─> Завершение
```

**Примеры**:

```python
generate_visitor_id("Mozilla/5.0 ...")  # Пример вызова