# `tinytroupe.utils`

## Обзор

Модуль `tinytroupe.utils` предоставляет общие утилиты и вспомогательные функции для проекта TinyTroupe. Включает функции для работы с модельным вводом и выводом, управления моделями, валидации данных, работы с шаблонами, рендеринга, ввода/вывода и других общих задач.

## Содержание

- [Модельный ввод](#модельный-ввод)
  - [`compose_initial_LLM_messages_with_templates`](#compose_initial_llm_messages_with_templates)
- [Модельный вывод](#модельный-вывод)
  - [`extract_json`](#extract_json)
  - [`extract_code_block`](#extract_code_block)
- [Управление моделями](#управление-моделями)
  - [`repeat_on_error`](#repeat_on_error)
- [Валидация](#валидация)
  - [`check_valid_fields`](#check_valid_fields)
  - [`sanitize_raw_string`](#sanitize_raw_string)
  - [`sanitize_dict`](#sanitize_dict)
- [Инженерия промптов](#инженерия-промптов)
  - [`add_rai_template_variables_if_enabled`](#add_rai_template_variables_if_enabled)
- [Рендеринг и разметка](#рендеринг-и-разметка)
  - [`inject_html_css_style_prefix`](#inject_html_css_style_prefix)
  - [`break_text_at_length`](#break_text_at_length)
  - [`pretty_datetime`](#pretty_datetime)
  - [`dedent`](#dedent)
- [Ввод/вывод и утилиты запуска](#вводвывод-и-утилиты-запуска)
  - [`read_config_file`](#read_config_file)
  - [`pretty_print_config`](#pretty_print_config)
  - [`start_logger`](#start_logger)
- [Сериализация JSON](#сериализация-json)
  - [`JsonSerializableRegistry`](#jsonserializableregistry)
- [Другое](#другое)
  - [`name_or_empty`](#name_or_empty)
  - [`custom_hash`](#custom_hash)
  - [`fresh_id`](#fresh_id)

## Модельный ввод

### `compose_initial_LLM_messages_with_templates`

**Описание**:
Компонует начальные сообщения для вызова LLM-модели, предполагая, что это всегда включает системное (общее описание задачи) и необязательное пользовательское сообщение (конкретное описание задачи). Эти сообщения составляются с использованием указанных шаблонов и настроек рендеринга.

**Параметры**:
- `system_template_name` (str): Имя файла шаблона для системного сообщения.
- `user_template_name` (str, optional): Имя файла шаблона для пользовательского сообщения. По умолчанию `None`.
- `rendering_configs` (dict, optional): Словарь с настройками для рендеринга шаблонов. По умолчанию `{}`.

**Возвращает**:
- `list`: Список словарей с сообщениями для LLM, где каждый словарь имеет ключи `"role"` и `"content"`.

## Модельный вывод

### `extract_json`

**Описание**:
Извлекает JSON-объект из строки, игнорируя: любой текст до первой открывающей фигурной скобки; и любые открывающие (`\`\`\`json`) или закрывающие (`\`\`\`) теги Markdown.

**Параметры**:
- `text` (str): Строка для извлечения JSON.

**Возвращает**:
- `dict`: Словарь, представляющий JSON-объект, или пустой словарь, если JSON не может быть извлечен.

### `extract_code_block`

**Описание**:
Извлекает блок кода из строки, игнорируя любой текст до первых открывающих тройных обратных кавычек и любой текст после закрывающих тройных обратных кавычек.

**Параметры**:
- `text` (str): Строка для извлечения блока кода.

**Возвращает**:
- `str`: Строка, представляющая блок кода, или пустая строка, если блок кода не может быть извлечен.

## Управление моделями

### `repeat_on_error`

**Описание**:
Декоратор, который повторяет вызов указанной функции, если возникает исключение из числа указанных, до указанного количества повторных попыток. Если это число повторных попыток превышено, исключение вызывается. Если исключения не возникает, функция возвращается в обычном режиме.

**Параметры**:
- `retries` (int): Количество повторных попыток.
- `exceptions` (list): Список классов исключений для перехвата.

**Возвращает**:
- `function`: Декорированная функция.

## Валидация

### `check_valid_fields`

**Описание**:
Проверяет, являются ли поля в указанном словаре допустимыми, в соответствии со списком допустимых полей. Если нет, вызывает ValueError.

**Параметры**:
- `obj` (dict): Словарь для проверки.
- `valid_fields` (list): Список допустимых полей.

**Вызывает исключения**:
- `ValueError`: Если какой-либо из ключей словаря не содержится в `valid_fields`.

### `sanitize_raw_string`

**Описание**:
Очищает указанную строку, удаляя любые недопустимые символы и обеспечивая, что она не длиннее максимальной длины строки Python.

**Параметры**:
- `value` (str): Строка для очистки.

**Возвращает**:
- `str`: Очищенная строка.

### `sanitize_dict`

**Описание**:
Очищает указанный словарь, удаляя любые недопустимые символы и гарантируя, что словарь не является слишком глубоко вложенным.

**Параметры**:
- `value` (dict): Словарь для очистки.

**Возвращает**:
- `dict`: Очищенный словарь.

## Инженерия промптов

### `add_rai_template_variables_if_enabled`

**Описание**:
Добавляет переменные шаблона RAI в указанный словарь, если включены предупреждения RAI. Они могут быть настроены в файле config.ini. Если включено, переменные будут загружать предупреждения RAI из соответствующих файлов в каталоге `prompts`. В противном случае переменные будут установлены в `None`.

**Параметры**:
- `template_variables` (dict): Словарь переменных шаблона, к которому нужно добавить переменные RAI.

**Возвращает**:
- `dict`: Обновленный словарь переменных шаблона.

## Рендеринг и разметка

### `inject_html_css_style_prefix`

**Описание**:
Вставляет префикс стиля ко всем атрибутам стиля в данной HTML-строке.

**Параметры**:
- `html` (str): HTML-строка для модификации.
- `style_prefix_attributes` (str): Строка с префиксом стиля, который нужно добавить.

**Возвращает**:
- `str`: Модифицированная HTML-строка с добавленным префиксом стиля.

### `break_text_at_length`

**Описание**:
Разбивает текст (или JSON) на указанной длине, вставляя строку "(...)" в точке разрыва. Если максимальная длина равна `None`, содержимое возвращается как есть.

**Параметры**:
- `text` (Union[str, dict]): Текст или словарь для разбивки.
- `max_length` (int, optional): Максимальная длина текста. По умолчанию `None`.

**Возвращает**:
- `str`: Текст с разрывом или исходный текст, если максимальная длина не указана.

### `pretty_datetime`

**Описание**:
Возвращает красивое строковое представление указанного объекта datetime.

**Параметры**:
- `dt` (datetime): Объект datetime для форматирования.

**Возвращает**:
- `str`: Отформатированная строка даты и времени.

### `dedent`

**Описание**:
Удаляет отступ из указанного текста, удаляя все начальные пробелы и отступы.

**Параметры**:
- `text` (str): Текст для удаления отступа.

**Возвращает**:
- `str`: Текст без отступов.

## Ввод/вывод и утилиты запуска

### `read_config_file`

**Описание**:
Читает файл конфигурации `config.ini` из текущего каталога или каталога модуля.

**Параметры**:
- `use_cache` (bool, optional): Использовать ли кэшированную конфигурацию, если она доступна. По умолчанию `True`.
- `verbose` (bool, optional): Выводить ли сообщения отладки. По умолчанию `True`.

**Возвращает**:
- `configparser.ConfigParser`: Объект конфигурации.

**Вызывает исключения**:
- `ValueError`: Если не удается найти файл конфигурации.

### `pretty_print_config`

**Описание**:
Выводит текущую конфигурацию в консоль в удобочитаемом формате.

**Параметры**:
- `config` (configparser.ConfigParser): Объект конфигурации для печати.

### `start_logger`

**Описание**:
Настраивает логгер для использования в приложении, используя настройки из конфигурационного файла.

**Параметры**:
- `config` (configparser.ConfigParser): Объект конфигурации, содержащий настройки логирования.

## Сериализация JSON

### `JsonSerializableRegistry`

**Описание**:
Миксин-класс, который обеспечивает сериализацию и десериализацию JSON, а также регистрацию подклассов.

**Методы**:
- `to_json(include: list = None, suppress: list = None, file_path: str = None) -> dict`: Возвращает JSON-представление объекта.
- `from_json(cls, json_dict_or_path, suppress: list = None, post_init_params: dict = None)`: Загружает JSON-представление объекта и создает экземпляр класса.

## Другое

### `name_or_empty`

**Описание**:
Возвращает имя указанного агента или среды или пустую строку, если агент равен `None`.

**Параметры**:
- `named_entity` (AgentOrWorld): Агент или среда для получения имени.

**Возвращает**:
- `str`: Имя агента или среды или пустая строка.

### `custom_hash`

**Описание**:
Возвращает хэш для указанного объекта. Объект сначала преобразуется в строку, чтобы сделать его хэшируемым. Этот метод является детерминированным, в отличие от встроенной функции `hash()`.

**Параметры**:
- `obj` (Any): Объект для хэширования.

**Возвращает**:
- `str`: Хэш объекта в шестнадцатеричном формате.

### `fresh_id`

**Описание**:
Возвращает свежий идентификатор для нового объекта. Это полезно для создания уникальных идентификаторов для объектов.

**Возвращает**:
- `int`: Уникальный идентификатор.