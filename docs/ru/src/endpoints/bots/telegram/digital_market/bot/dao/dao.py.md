# Модуль dao.py

## Обзор

Модуль `dao.py` содержит классы для доступа к данным (DAO) моделей `User`, `Purchase`, `Category` и `Product`,
используя SQLAlchemy для взаимодействия с базой данных. Он предоставляет методы для выполнения операций CRUD
(создание, чтение, обновление, удаление) и специфические запросы для получения агрегированной информации,
такой как статистика покупок пользователей и общая статистика по базе данных.

## Подробней

Модуль содержит DAO классы для работы с моделями `User`, `Purchase`, `Category` и `Product`.
Каждый DAO класс наследуется от `BaseDAO` и предоставляет методы для выполнения операций с базой данных.
Классы содержат методы для получения данных, создания, обновления и удаления записей, а также методы для
получения агрегированной информации, такой как статистика покупок пользователей и общая статистика по базе данных.

## Классы

### `UserDAO`

**Описание**:
Класс `UserDAO` предоставляет методы для работы с моделью `User`.
Он включает методы для получения статистики покупок пользователя, получения списка приобретенных продуктов и
получения общей статистики по пользователям.

**Как работает класс**:

1.  Наследуется от `BaseDAO`, параметризованного моделью `User`.
2.  Определяет методы для получения статистики покупок пользователя, списка приобретенных продуктов и общей статистики по пользователям.
3.  Использует SQLAlchemy для выполнения запросов к базе данных.

**Методы**:

*   `get_purchase_statistics`: Получает статистику покупок пользователя.
*   `get_purchased_products`: Получает список приобретенных продуктов пользователя.
*   `get_statistics`: Получает общую статистику по пользователям.

#### `get_purchase_statistics`

```python
@classmethod
async def get_purchase_statistics(cls, session: AsyncSession, telegram_id: int) -> Optional[Dict[str, int]]:
    """
    Получает статистику покупок пользователя.

    Args:
        session (AsyncSession): Асинхронная сессия базы данных.
        telegram_id (int): Telegram ID пользователя.

    Returns:
        Optional[Dict[str, int]]: Словарь со статистикой покупок пользователя, содержащий общее число покупок
                                 и общую сумму покупок. Возвращает `None` в случае ошибки.

    Raises:
        SQLAlchemyError: Если возникает ошибка при работе с базой данных.

    """
```

**Как работает функция**:

1.  Выполняет запрос к базе данных для получения общего числа покупок и общей суммы покупок пользователя с заданным `telegram_id`.
2.  Обрабатывает возможные ошибки при работе с базой данных и возвращает `None` в случае ошибки.
3.  Возвращает словарь со статистикой покупок пользователя, содержащий общее число покупок и общую сумму покупок.

#### `get_purchased_products`

```python
@classmethod
async def get_purchased_products(cls, session: AsyncSession, telegram_id: int) -> Optional[List[Purchase]]:
    """
    Получает список приобретенных продуктов пользователя.

    Args:
        session (AsyncSession): Асинхронная сессия базы данных.
        telegram_id (int): Telegram ID пользователя.

    Returns:
        Optional[List[Purchase]]: Список покупок пользователя, где каждая покупка содержит информацию о продукте.
                                 Возвращает `None` в случае, если пользователь не найден.

    Raises:
        SQLAlchemyError: Если возникает ошибка при работе с базой данных.
    """
```

**Как работает функция**:

1.  Выполняет запрос к базе данных для получения пользователя с его покупками и связанными продуктами.
2.  Обрабатывает возможные ошибки при работе с базой данных и возвращает `None` в случае ошибки.
3.  Возвращает список покупок пользователя, где каждая покупка содержит информацию о продукте.

#### `get_statistics`

```python
 @classmethod
 async def get_statistics(cls, session: AsyncSession):
     """
     Получает общую статистику по пользователям: общее количество, новых за сегодня, за неделю и за месяц.
     
     Args:
         session (AsyncSession): Асинхронная сессия базы данных.
     
     Returns:
         dict: Словарь со статистикой пользователей, содержащий общее количество пользователей, количество новых пользователей за сегодня, за неделю и за месяц.
     
     Raises:
         SQLAlchemyError: Если возникает ошибка при работе с базой данных.
     """
```

**Как работает функция**:

1.  Функция `get_statistics` извлекает статистические данные о пользователях, такие как общее количество пользователей, количество новых пользователей за день, неделю и месяц.
2.  Определяется текущая дата и время в UTC.
3.  Выполняется запрос к базе данных для подсчета общего количества пользователей, а также количества новых пользователей, зарегистрированных за последние 1 день, 7 дней и 30 дней. Для этого используется функция `case` из SQLAlchemy, которая позволяет условно подсчитывать количество пользователей в зависимости от даты регистрации.
4.  Результат запроса преобразуется в словарь, содержащий статистику пользователей.
5.  В случае успеха, информация о полученной статистике логируется с использованием `logger.info`.
6.  В случае ошибки при работе с базой данных, информация об ошибке логируется с использованием `logger.error`, и исключение поднимается выше.

### `PurchaseDao`

**Описание**:
Класс `PurchaseDao` предоставляет методы для работы с моделью `Purchase`.
Он включает методы для получения статистики платежей, общей суммы покупок и следующего свободного ID для новой записи.

**Как работает класс**:

1.  Наследуется от `BaseDAO`, параметризованного моделью `Purchase`.
2.  Определяет методы для получения статистики платежей, общей суммы покупок и следующего свободного ID для новой записи.
3.  Использует SQLAlchemy для выполнения запросов к базе данных.

**Методы**:

*   `get_payment_stats`: Получает статистику платежей.
*   `get_full_summ`: Получает общую сумму покупок.
*   `get_next_id`: Получает следующий свободный ID для новой записи.

#### `get_payment_stats`

```python
@classmethod
async def get_payment_stats(cls, session: AsyncSession) -> str:
    """
    Получает статистику платежей.

    Args:
        session (AsyncSession): Асинхронная сессия базы данных.

    Returns:
        str: Строка, содержащая статистику платежей по типам (Юкасса, Робокасса, STARS).

    Raises:
        SQLAlchemyError: Если возникает ошибка при работе с базой данных.
    """
```

**Как работает функция**:

1.  Выполняет запрос к базе данных для получения статистики платежей по типам (Юкасса, Робокасса, STARS).
2.  Форматирует результат в виде строки, содержащей статистику платежей по типам.
3.  Возвращает строку, содержащую статистику платежей по типам.

#### `get_full_summ`

```python
@classmethod
async def get_full_summ(cls, session: AsyncSession) -> int:
    """
    Получает общую сумму покупок.

    Args:
        session (AsyncSession): Асинхронная сессия базы данных.

    Returns:
        int: Общая сумма покупок.

    Raises:
        SQLAlchemyError: Если возникает ошибка при работе с базой данных.
    """
```

**Как работает функция**:

1.  Выполняет запрос к базе данных для получения общей суммы покупок.
2.  Возвращает общую сумму покупок.

#### `get_next_id`

```python
@classmethod
async def get_next_id(cls, session: AsyncSession) -> int:
    """
    Возвращает следующий свободный ID для новой записи.

    Args:
        session: Асинхронная сессия базы данных
    Returns:
        Следующий свободный ID
    """
```

**Как работает функция**:

1.  Функция `get_next_id` предназначена для определения следующего доступного идентификатора (ID) для новой записи в базе данных.
2.  Выполняется SQL-запрос, который использует функцию `func.coalesce` и `func.max` из SQLAlchemy для определения максимального значения `id` в таблице, представленной классом `cls.model`. Если таблица пуста и `func.max(cls.model.id)` возвращает `None`, то `func.coalesce` вернет значение 1. В противном случае, будет возвращено максимальное значение `id` плюс 1.
3.  Результат запроса выполняется с использованием асинхронной сессии `session`, и из полученного результата извлекается скалярное значение (то есть, сам ID).
4.  Полученный ID возвращается как результат работы функции.

### `CategoryDao`

**Описание**:
Класс `CategoryDao` предоставляет методы для работы с моделью `Category`.

**Как работает класс**:

1.  Наследуется от `BaseDAO`, параметризованного моделью `Category`.
2.  Не содержит дополнительных методов, использует методы, предоставляемые `BaseDAO`.

### `ProductDao`

**Описание**:
Класс `ProductDao` предоставляет методы для работы с моделью `Product`.

**Как работает класс**:

1.  Наследуется от `BaseDAO`, параметризованного моделью `Product`.
2.  Не содержит дополнительных методов, использует методы, предоставляемые `BaseDAO`.