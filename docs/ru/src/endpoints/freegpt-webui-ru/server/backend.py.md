# Модуль backend.py

## Обзор

Модуль `backend.py` предоставляет API для взаимодействия с AI-моделями, такими как ChatGPT, с возможностью настройки параметров, включая использование прокси, jailbreak-инструкций и доступа к интернету. Модуль включает функциональность для обработки запросов на разговор, построения сообщений, получения результатов поиска и генерации потоковых ответов.

## Подробней

Этот модуль является частью серверной логики веб-интерфейса FreeGPT на русском языке. Он обрабатывает входящие запросы, формирует контекст для AI-модели, отправляет запросы к модели и возвращает ответы клиенту. Ключевые особенности включают поддержку прокси для обхода ограничений, jailbreak-инструкции для изменения поведения модели и интеграцию с поисковыми сервисами для расширения контекста ответов.

## Классы

### `Backend_Api`

**Описание**: Класс `Backend_Api` отвечает за обработку API-запросов и взаимодействие с AI-моделями.

**Принцип работы**:
Класс инициализируется с Flask-приложением и конфигурацией. Он определяет маршруты для API-запросов, такие как `/backend-api/v2/conversation`, и связывает их с соответствующими функциями обработки. Если включено использование автоматических прокси, запускается поток для периодического обновления списка рабочих прокси.

**Атрибуты**:

- `app`: Flask-приложение.
- `use_auto_proxy` (bool): Флаг, указывающий, следует ли использовать автоматические прокси.
- `routes` (dict): Словарь, определяющий маршруты API и связанные с ними функции и методы.

**Методы**:

- `__init__(self, app, config: dict) -> None`: Инициализирует экземпляр класса `Backend_Api`.
- `_conversation(self)`: Обрабатывает запросы на разговор и возвращает потоковый ответ от AI-модели.

### `Backend_Api.__init__`

```python
def __init__(self, app, config: dict) -> None:
    """
    Инициализирует экземпляр класса `Backend_Api`.

    Args:
        app: Flask-приложение.
        config (dict): Конфигурация приложения.

    Returns:
        None
    """
    ...
```

### `Backend_Api._conversation`

```python
def _conversation(self):
    """
    Обрабатывает запросы на разговор и возвращает потоковый ответ от AI-модели.

    Returns:
        Flask.response_class: Потоковый ответ от AI-модели.
        tuple: Словарь с информацией об ошибке и код состояния HTTP 400 в случае ошибки.
    """
    ...
```

## Функции

### `build_messages`

```python
def build_messages(jailbreak):
    """
    Формирует список сообщений для отправки в AI-модель.

    Args:
        jailbreak: Инструкции для "взлома" (jailbreak) AI-модели.

    Returns:
        list: Список сообщений, готовых для отправки в AI-модель.
    """
    ...
```

**Как работает функция**:

1. **Извлечение данных из запроса**:
   - Извлекает `_conversation` (историю разговора), `internet_access` (флаг доступа к интернету) и `prompt` (текущий запрос пользователя) из JSON-данных запроса.

2. **Генерация системного сообщения**:
   - Формирует системное сообщение, которое задает контекст для AI-модели, включая текущую дату и язык ответа.

3. **Инициализация разговора**:
   - Создает список `conversation`, начиная с системного сообщения.

4. **Добавление истории разговора**:
   - Добавляет существующую историю разговора (`_conversation`) в список сообщений.

5. **Добавление результатов поиска**:
   - Если `internet_access` включен, выполняет поиск в интернете и добавляет результаты в список сообщений.

6. **Добавление jailbreak-инструкций**:
   - Если `jailbreak` включен, добавляет соответствующие инструкции в список сообщений.

7. **Добавление запроса пользователя**:
   - Добавляет текущий запрос пользователя (`prompt`) в список сообщений.

8. **Уменьшение размера разговора**:
   - Ограничивает размер списка сообщений до 13, чтобы избежать ошибок, связанных с количеством токенов API.

9. **Возврат списка сообщений**:
   - Возвращает сформированный список сообщений.

```
A: Извлечение данных из запроса
│
├── B: Генерация системного сообщения
│   │
│   └── C: Инициализация разговора
│       │
│       ├── D: Добавление истории разговора
│       │   │
│       │   ├── E: Добавление результатов поиска (если internet_access включен)
│       │   │   │
│       │   │   └── F: Добавление jailbreak-инструкций (если jailbreak включен)
│       │   │       │
│       │   │       └── G: Добавление запроса пользователя
│       │   │           │
│       │   │           └── H: Уменьшение размера разговора
│       │   │               │
│       │   │               └── I: Возврат списка сообщений
```

**Примеры**:

```python
# Пример вызова функции с jailbreak="Default", internet_access=True
messages = build_messages(jailbreak="Default")

# Пример вызова функции с jailbreak="Custom", internet_access=False
messages = build_messages(jailbreak="Custom")
```

### `fetch_search_results`

```python
def fetch_search_results(query):
    """
    Выполняет поиск в интернете и возвращает результаты в формате, пригодном для AI-модели.

    Args:
        query (str): Поисковый запрос.

    Returns:
        list: Список результатов поиска в формате, пригодном для AI-модели.
    """
    ...
```

**Как работает функция**:

1. **Выполнение поискового запроса**:
   - Отправляет HTTP-запрос к API DuckDuckGo для выполнения поискового запроса.

2. **Обработка результатов**:
   - Извлекает результаты поиска из JSON-ответа.

3. **Формирование списка результатов**:
   - Создает список результатов, добавляя каждый результат в формате: `[index] "snippet" URL:link`.

4. **Возврат списка результатов**:
   - Возвращает сформированный список результатов.

```
A: Выполнение поискового запроса
│
└── B: Обработка результатов
│   │
│   └── C: Формирование списка результатов
│       │
│       └── D: Возврат списка результатов
```

**Примеры**:

```python
# Пример вызова функции с запросом "Python programming"
results = fetch_search_results(query="Python programming")

# Пример вызова функции с запросом "Best restaurants near me"
results = fetch_search_results(query="Best restaurants near me")
```

### `generate_stream`

```python
def generate_stream(response, jailbreak):
    """
    Генерирует потоковый ответ от AI-модели, обрабатывая jailbreak-инструкции при необходимости.

    Args:
        response: Ответ от AI-модели.
        jailbreak: Инструкции для "взлома" (jailbreak) AI-модели.

    Yields:
        str: Часть потокового ответа.
    """
    ...
```

**Как работает функция**:

1. **Проверка jailbreak-инструкций**:
   - Проверяет, включены ли jailbreak-инструкции.

2. **Обработка jailbreak-инструкций**:
   - Если jailbreak включен, итерируется по потоковому ответу, проверяя, был ли "взлом" успешен или нет.
   - Если "взлом" успешен, возвращает оставшуюся часть потокового ответа.
   - Если "взлом" не удался, возвращает ошибку.

3. **Генерация потокового ответа без jailbreak**:
   - Если jailbreak не включен, генерирует потоковый ответ без обработки.

```
A: Проверка jailbreak-инструкций
│
├── B: Обработка jailbreak-инструкций (если jailbreak включен)
│   │
│   ├── C: Итерация по потоковому ответу
│   │   │
│   │   ├── D: Проверка успеха/неудачи "взлома"
│   │   │   │
│   │   │   ├── E: Возврат оставшейся части ответа (если "взлом" успешен)
│   │   │   │
│   │   │   └── F: Возврат ошибки (если "взлом" не удался)
│   │   │
│   └── G: Генерация потокового ответа без обработки (если jailbreak не включен)
```

**Примеры**:

```python
# Пример вызова функции с jailbreak="Default"
stream = generate_stream(response, jailbreak="Default")

# Пример вызова функции с jailbreak=None
stream = generate_stream(response, jailbreak=None)
```

### `response_jailbroken_success`

```python
def response_jailbroken_success(response: str) -> bool:
    """
    Определяет, был ли "взлом" (jailbreak) AI-модели успешным.

    Args:
        response (str): Ответ от AI-модели.

    Returns:
        bool: True, если "взлом" был успешным, иначе False.
    """
    ...
```

**Как работает функция**:

1. **Поиск маркера успешного "взлома"**:
   - Выполняет поиск маркера `ACT:` в ответе AI-модели.

2. **Возврат результата**:
   - Возвращает `True`, если маркер найден, иначе `False`.

```
A: Поиск маркера успешного "взлома"
│
└── B: Возврат результата
```

**Примеры**:

```python
# Пример вызова функции с ответом, содержащим маркер "ACT:"
success = response_jailbroken_success(response="ACT: Hello")

# Пример вызова функции с ответом, не содержащим маркер "ACT:"
success = response_jailbroken_success(response="Hello")
```

### `response_jailbroken_failed`

```python
def response_jailbroken_failed(response):
    """
    Определяет, не удался ли "взлом" (jailbreak) AI-модели.

    Args:
        response: Ответ от AI-модели.

    Returns:
        bool: True, если "взлом" не удался, иначе False.
    """
    ...
```

**Как работает функция**:

1. **Проверка длины ответа**:
   - Проверяет, что длина ответа больше 4 символов.

2. **Проверка начала ответа**:
   - Проверяет, что ответ не начинается с `GPT:` или `ACT:`.

3. **Возврат результата**:
   - Возвращает `True`, если длина ответа больше 4 символов и ответ не начинается с `GPT:` или `ACT:`, иначе `False`.

```
A: Проверка длины ответа
│
└── B: Проверка начала ответа
│   │
│   └── C: Возврат результата
```

**Примеры**:

```python
# Пример вызова функции с ответом "Hello"
failed = response_jailbroken_failed(response="Hello")

# Пример вызова функции с ответом "GPT: Hello"
failed = response_jailbroken_failed(response="GPT: Hello")
```

### `set_response_language`

```python
def set_response_language(prompt):
    """
    Определяет язык запроса и возвращает инструкцию для AI-модели, чтобы она отвечала на этом языке.

    Args:
        prompt: Запрос пользователя.

    Returns:
        str: Инструкция для AI-модели, чтобы она отвечала на языке запроса.
    """
    ...
```

**Как работает функция**:

1. **Определение языка запроса**:
   - Использует `Translator` для определения языка запроса пользователя.

2. **Формирование инструкции**:
   - Формирует инструкцию для AI-модели, чтобы она отвечала на определенном языке.

3. **Возврат инструкции**:
   - Возвращает сформированную инструкцию.

```
A: Определение языка запроса
│
└── B: Формирование инструкции
│   │
│   └── C: Возврат инструкции
```

**Примеры**:

```python
# Пример вызова функции с запросом на английском языке
instruction = set_response_language(prompt={"content": "Hello"})

# Пример вызова функции с запросом на русском языке
instruction = set_response_language(prompt={"content": "Привет"})
```

### `isJailbreak`

```python
def isJailbreak(jailbreak):
    """
    Определяет, включены ли jailbreak-инструкции, и возвращает соответствующие инструкции.

    Args:
        jailbreak: Идентификатор jailbreak-инструкций.

    Returns:
        list | None: Список jailbreak-инструкций, если они включены, иначе None.
    """
    ...
```

**Как работает функция**:

1. **Проверка идентификатора jailbreak**:
   - Проверяет, что идентификатор jailbreak не равен "Default".

2. **Возврат инструкций**:
   - Если идентификатор jailbreak не равен "Default", возвращает соответствующие инструкции из словаря `special_instructions`, если они существуют, иначе `None`.

```
A: Проверка идентификатора jailbreak
│
└── B: Возврат инструкций
```

**Примеры**:

```python
# Пример вызова функции с jailbreak="Default"
instructions = isJailbreak(jailbreak="Default")

# Пример вызова функции с jailbreak="Custom"
instructions = isJailbreak(jailbreak="Custom")
```