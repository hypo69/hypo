# Модуль `PerplexityLabs`

## Обзор

Модуль `PerplexityLabs` предоставляет асинхронный интерфейс для взаимодействия с моделями Perplexity Labs. Он позволяет отправлять сообщения к моделям и получать ответы в виде асинхронного генератора. Модуль поддерживает несколько моделей, включая `r1-1776`, `sonar-pro`, `sonar`, `sonar-reasoning` и `sonar-reasoning-pro`.

## Подробней

Этот модуль предназначен для интеграции с API Perplexity Labs, обеспечивая асинхронное взаимодействие для получения текстовых ответов от AI моделей. Он использует вебсокеты для потоковой передачи данных, что позволяет получать ответы в реальном времени. Модуль обрабатывает установление соединения, отправку запросов и обработку ответов, предоставляя удобный интерфейс для работы с моделями Perplexity Labs.

## Классы

### `PerplexityLabs`

**Описание**: Класс `PerplexityLabs` является асинхронным провайдером, который взаимодействует с API Perplexity Labs для генерации ответов на основе предоставленных сообщений.

**Принцип работы**:

Класс наследуется от `AsyncGeneratorProvider` и `ProviderModelMixin`. Он использует асинхронные сессии для установления соединения с сервером Perplexity Labs через WebSocket. После установки соединения он отправляет сообщения и получает ответы в виде асинхронного генератора.

**Методы**:

- `create_async_generator`: Создает асинхронный генератор для получения ответов от API Perplexity Labs.

#### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для получения ответов от API Perplexity Labs.

        Args:
            model (str): Имя используемой модели.
            messages (Messages): Список сообщений для отправки в модель.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий ответы от API.

        Raises:
            ResponseError: Если возникает ошибка при обработке ответа от API.
            RuntimeError: При возникновении неизвестной ошибки.
            AssertionError: Если возникают неожиданные ответы от сервера.

        Как работает функция:

        1.  **Подготовка заголовков и сессии**: Функция подготавливает заголовки, необходимые для запросов к API, и создает асинхронную сессию с использованием `StreamSession`. Если указан прокси, он также используется в сессии.

        2.  **Установление соединения**: Функция выполняет несколько HTTP-запросов для установления соединения с сервером Perplexity Labs. Эти запросы включают получение идентификатора сессии (sid) и отправку первоначальных данных для аутентификации.

        3.  **Подключение к WebSocket**: После успешного установления HTTP-соединения функция устанавливает WebSocket-соединение, используя полученный идентификатор сессии.

        4.  **Отправка сообщений и получение ответов**: Функция отправляет сообщения к API через WebSocket и ожидает ответы. Ответы обрабатываются и генерируются обратно в виде асинхронного генератора.

        5.  **Обработка ошибок**: Функция обрабатывает возможные ошибки, такие как ошибки при обработке ответов и неожиданные ответы от сервера, и вызывает исключения `ResponseError` или `RuntimeError` в случае возникновения проблем.

        Внутри функции происходят следующие действия и преобразования:

        - **Инициализация сессии**: Создание и настройка асинхронной сессии с заголовками и прокси.
        - **Получение SID**: Выполнение HTTP-запросов для получения идентификатора сессии (SID).
        - **WebSocket handshake**: Установка и проверка WebSocket-соединения.
        - **Отправка сообщений**: Преобразование и отправка сообщений пользователя в формате, требуемом API.
        - **Потоковая обработка ответов**: Получение и обработка ответов от API в режиме реального времени через WebSocket.
        - **Извлечение данных**: Извлечение полезных данных из JSON-ответов.
        - **Обработка завершения**: Определение момента завершения генерации ответа на основе флага `final` в данных ответа.
        - **Обработка источников**: Извлечение и передача информации об источниках, если они присутствуют в ответе.

        Примеры:
            >>> import asyncio
            >>> async def main():
            ...     async for message in PerplexityLabs.create_async_generator(model='r1-1776', messages=[{'role': 'user', 'content': 'Hello, world!'}]):
            ...         print(message, end='')
            >>> asyncio.run(main())
            Hello, world!<think><sources><finish>
        """
```

## Переменные

-   `API_URL` (str): URL для API Perplexity Labs.
-   `WS_URL` (str): URL для WebSocket API Perplexity Labs.
-   `url` (str): URL веб-сайта Perplexity Labs.
-   `working` (bool): Указывает, работает ли провайдер.
-   `default_model` (str): Модель, используемая по умолчанию (`r1-1776`).
-   `models` (List[str]): Список поддерживаемых моделей.