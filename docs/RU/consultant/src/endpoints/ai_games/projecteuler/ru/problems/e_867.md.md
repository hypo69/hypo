# Анализ кода модуля `e_867.md`

**Качество кода**
7
- Плюсы
    - Код содержит четкое описание задачи и условий, что облегчает понимание.
    - Присутствуют примеры, поясняющие определение гармонического и почти гармонического чисел.
    - Задача четко сформулирована, что позволяет сразу приступить к реализации решения.
- Минусы
    - Отсутствует Python-код для решения задачи, представлено только условие задачи.
    - Нет примеров использования `j_loads` или `j_loads_ns`.
    - Не хватает комментариев в формате RST.
    - Не используется логирование ошибок через `logger.error`.
    - Нет проверки и добавления отсутствующих импортов.

**Рекомендации по улучшению**

1.  **Реализовать решение задачи на Python:** Необходимо добавить код, который вычисляет количество почти гармонических чисел до заданного предела.
2.  **Использовать `j_loads` или `j_loads_ns`:** Если бы код работал с файлами JSON, нужно было бы использовать эти функции.
3.  **Добавить комментарии в формате RST:** Описать функции и их параметры с использованием reStructuredText.
4.  **Логирование ошибок:** Вместо стандартных `try-except` добавить логирование ошибок через `logger.error`.
5.  **Проверка и добавление импортов:** Добавить необходимые импорты, такие как `math`, `src.utils.jjson`, `src.logger.logger`, `typing`, если они используются.
6.  **Улучшить структуру:** Разделить код на более мелкие функции для лучшей читаемости и переиспользования.
7.  **Оптимизация:** Провести анализ производительности кода и рассмотреть возможность его оптимизации для более быстрого выполнения, так как для `N = 10^7` потребуется эффективный алгоритм.

**Оптимизированный код**

```python
"""
Модуль для решения задачи 867 проекта Эйлера.
=========================================================================================

Задача: Почти гармонические числа.

Этот модуль содержит функцию для расчета количества почти гармонических чисел,
не превышающих заданное число N.

Пример использования
--------------------

.. code-block:: python

    result = count_almost_harmonic_numbers(100)
    print(result)

"""
import math
from typing import List
from src.logger.logger import logger
# from src.utils.jjson import j_loads, j_loads_ns # TODO: Добавить импорт при необходимости работы с JSON

def count_divisors(n: int) -> int:
    """
    Подсчитывает количество делителей натурального числа n.

    :param n: Натуральное число.
    :return: Количество делителей числа n.
    """
    count = 0
    for i in range(1, int(math.sqrt(n)) + 1):
        if n % i == 0:
            count += 2 if n // i != i else 1
    return count


def sum_of_divisors(n: int) -> int:
    """
    Вычисляет сумму делителей натурального числа n.

    :param n: Натуральное число.
    :return: Сумма делителей числа n.
    """
    total = 0
    for i in range(1, int(math.sqrt(n)) + 1):
        if n % i == 0:
            total += i
            if n // i != i:
                total += n // i
    return total


def is_almost_harmonic(n: int) -> bool:
    """
    Проверяет, является ли число n почти гармоническим.

    :param n: Натуральное число.
    :return: True, если число почти гармоническое, иначе False.
    """
    try:
        d = count_divisors(n)
        sigma = sum_of_divisors(n)
        result = sigma / d
        return abs(result - round(result)) in (0, 0.5)
    except Exception as e:
        logger.error(f"Произошла ошибка при проверке числа {n} на почти гармоничность: {e}")
        return False


def count_almost_harmonic_numbers(limit: int) -> int:
    """
    Подсчитывает количество почти гармонических чисел, не превышающих заданный предел.

    :param limit: Верхняя граница поиска.
    :return: Количество почти гармонических чисел в заданном диапазоне.
    """
    count = 0
    for i in range(1, limit + 1):
        if is_almost_harmonic(i):
            count += 1
    return count


if __name__ == '__main__':
    # Код выполняет проверку для N = 100
    test_limit = 100
    result_100 = count_almost_harmonic_numbers(test_limit)
    print(f"A({test_limit}) = {result_100}")

    # Код выполняет проверку для N = 10^7
    limit = 10**7
    result = count_almost_harmonic_numbers(limit)
    print(f"A({limit}) = {result}")
```