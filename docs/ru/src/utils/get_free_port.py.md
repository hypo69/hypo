# Модуль для поиска свободного порта

## Обзор

Модуль `get_free_port` предназначен для поиска и возврата свободного порта в указанном диапазоне или первого доступного порта, если диапазон не задан. Он проверяет, какие порты в заданном диапазоне не используются, и возвращает первый найденный свободный порт.

## Подробней

Модуль предоставляет функцию `get_free_port`, которая позволяет определить свободный порт для использования в приложениях. Он принимает хост и необязательный диапазон портов в качестве параметров. Если диапазон портов не указан, функция ищет первый доступный порт, начиная с 1024. Модуль использует сокеты для проверки, занят ли порт. В случае возникновения ошибок, таких как неверный формат диапазона портов или отсутствие свободных портов, генерируются исключения `ValueError`.

## Функции

### `get_free_port`

```python
def get_free_port(host: str, port_range: Optional[str | List[str]] = None) -> int:
    """
    Finds and returns a free port within the specified range, or the first available port if no range is given.

    Args:
        host (str): The host address to check for available ports.
        port_range (Optional[str | List[str]], optional): A port range specified as a string "min-max" or a list of strings.
               E.g.: "3000-3999", ["3000-3999", "8000-8010"], None. Defaults to `None`.

    Returns:
        int: An available port number.

    Raises:
        ValueError: If no free port can be found within the specified range, or if the port range is invalid.
    """
```

**Назначение**: Находит и возвращает свободный порт в указанном диапазоне или первый доступный порт, если диапазон не задан.

**Параметры**:
- `host` (str): Адрес хоста для проверки доступных портов.
- `port_range` (Optional[str | List[str]], optional): Диапазон портов, заданный в виде строки "min-max" или списка строк. Например: "3000-3999", ["3000-3999", "8000-8010"], None. По умолчанию `None`.

**Возвращает**:
- `int`: Доступный номер порта.

**Вызывает исключения**:
- `ValueError`: Если не удается найти свободный порт в указанном диапазоне или если диапазон портов недействителен.

**Как работает функция**:
1. Функция `get_free_port` принимает хост и диапазон портов в качестве входных параметров.
2. Если `port_range` указан:
   - Если `port_range` является строкой, функция пытается разобрать его с помощью `_parse_port_range`.
   - Если `port_range` является списком, функция итерируется по элементам списка, пытаясь разобрать каждый элемент как диапазон портов.
   - Для каждого диапазона портов функция итерируется по портам в этом диапазоне и проверяет, используется ли порт с помощью `_is_port_in_use`.
   - Если найден свободный порт, функция возвращает его.
   - Если ни один свободный порт не найден в указанных диапазонах, функция генерирует исключение `ValueError`.
3. Если `port_range` не указан:
   - Функция начинает поиск свободного порта с порта 1024.
   - Она проверяет каждый порт, начиная с 1024, с помощью `_is_port_in_use`.
   - Если найден свободный порт, функция возвращает его.
   - Если ни один свободный порт не найден до 65535, функция генерирует исключение `ValueError`.

```
get_free_port
│
├───port_range is None?
│   │
│   └───Yes: start_port = 1024
│   │   │
│   │   └───check port is free?
│   │   │   │
│   │   │   └───Yes: return port
│   │   │   │
│   │   │   └───No: port += 1
│   │   │
│   └───No: port_range is string?
│   │   │
│   │   └───Yes: parse_port_range
│   │   │   │
│   │   │   └───iterate through port range
│   │   │   │   │
│   │   │   │   └───check port is free?
│   │   │   │   │   │
│   │   │   │   │   └───Yes: return port
│   │   │   │   │   │
│   │   │   │   │   └───No: continue
│   │   │
│   └───No: port_range is list?
│   │   │
│   │   └───Yes: iterate through items in list
│   │   │   │
│   │   │   └───parse_port_range
│   │   │   │   │
│   │   │   │   └───iterate through port range
│   │   │   │   │   │
│   │   │   │   │   └───check port is free?
│   │   │   │   │   │   │
│   │   │   │   │   │   └───Yes: return port
│   │   │   │   │   │   │
│   │   │   │   │   │   └───No: continue
│   │   │
│   └───No: raise ValueError
│
```

**Внутренние функции**:

#### `_is_port_in_use`

```python
        def _is_port_in_use(host: str, port: int) -> bool:
            """
            Checks if a given port is in use on the specified host.

            Args:
                host (str): The host address.
                port (int): The port number to check.

            Returns:
                bool: True if the port is in use, False otherwise.
            """
```

**Назначение**: Проверяет, используется ли указанный порт на заданном хосте.

**Параметры**:
- `host` (str): Адрес хоста.
- `port` (int): Номер порта для проверки.

**Возвращает**:
- `bool`: `True`, если порт используется, `False` в противном случае.

**Как работает функция**:
1. Функция `_is_port_in_use` создает сокет (socket) для проверки доступности порта.
2. Она пытается привязать сокет к указанному хосту и порту.
3. Если привязка успешна, это означает, что порт свободен, и функция возвращает `False`.
4. Если при привязке возникает исключение `OSError`, это означает, что порт занят, и функция возвращает `True`.

#### `_parse_port_range`

```python
        def _parse_port_range(port_range_str: str) -> Tuple[int, int]:
            """
            Parses port range string "min-max" into a tuple (min_port, max_port).

            Args:
                port_range_str (str): The port range string.

            Returns:
                Tuple[int, int]: A tuple containing minimum and maximum port numbers.

            Raises:
                ValueError: If the port range string format is invalid.
            """
```

**Назначение**: Преобразует строку диапазона портов "min-max" в кортеж (min_port, max_port).

**Параметры**:
- `port_range_str` (str): Строка диапазона портов.

**Возвращает**:
- `Tuple[int, int]`: Кортеж, содержащий минимальный и максимальный номера портов.

**Вызывает исключения**:
- `ValueError`: Если формат строки диапазона портов недействителен.

**Как работает функция**:
1. Функция `_parse_port_range` принимает строку, представляющую диапазон портов.
2. Она разделяет строку на две части, используя разделитель '-'.
3. Если разделение не приводит к двум частям, это означает, что формат строки неверен, и генерируется исключение `ValueError`.
4. Функция преобразует обе части в целые числа.
5. Если минимальный порт больше или равен максимальному порту, это также означает, что формат строки неверен, и генерируется исключение `ValueError`.
6. Если все проверки пройдены успешно, функция возвращает кортеж, содержащий минимальный и максимальный номера портов.

**Примеры**:

```python
# Пример 1: Поиск свободного порта в заданном диапазоне
port = get_free_port('localhost', '3000-3005')
print(f'Найден свободный порт: {port}')

# Пример 2: Поиск свободного порта без указания диапазона
port = get_free_port('localhost')
print(f'Найден свободный порт: {port}')

# Пример 3: Поиск свободного порта в списке диапазонов
port = get_free_port('localhost', ['3000-3005', '8000-8005'])
print(f'Найден свободный порт: {port}')