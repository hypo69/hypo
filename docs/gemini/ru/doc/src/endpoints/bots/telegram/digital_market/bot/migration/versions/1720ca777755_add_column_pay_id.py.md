# Модуль миграции базы данных: добавление колонки `pay_id`

## Обзор

Модуль содержит функции для выполнения миграции базы данных, добавляющей колонку `payment_id` в таблицу `purchases`, если она еще не существует. Также содержит функции для отката данной миграции.

## Подробнее

Этот файл описывает миграцию базы данных, которая добавляет столбец `payment_id` в таблицу `purchases`. Миграция выполняется функцией `upgrade` и откатывается функцией `downgrade`. Перед добавлением или удалением столбца выполняется проверка его существования, чтобы избежать ошибок.

## Функции

### `upgrade`

```python
def upgrade() -> None:
    """
    Добавляет колонку 'payment_id' в таблицу 'purchases', если она еще не существует.

    Функция сначала проверяет, существует ли колонка 'payment_id' в таблице 'purchases'.
    Если колонка отсутствует, она добавляется с типом String и устанавливается как NOT NULL.
    Также создается уникальный индекс для данной колонки.

    Если колонка уже существует, выводится сообщение о пропуске добавления.

    Как работает функция:
    1.  Получает текущее соединение с базой данных.
    2.  Запрашивает информацию о таблице 'purchases' для получения списка колонок.
    3.  Проверяет наличие колонки 'payment_id' в списке колонок.
    4.  Если колонки нет, добавляет её и создает уникальный индекс.
    5.  Если колонка есть, выводит сообщение в консоль.
    """
```

**Как работает функция**:

```
    Начало
    │
    └── Получение соединения с БД (conn = op.get_bind())
    │
    └── Запрос информации о таблице (result = conn.execute(sa.text("PRAGMA table_info('purchases')")))
    │
    └── Извлечение имен колонок (columns = [row[1] for row in result])
    │
    └── Проверка существования колонки 'payment_id' (if 'payment_id' not in columns)
    │   ├── Колонка отсутствует → Добавление колонки и уникального индекса (op.add_column, op.create_unique_constraint)
    │   └── Колонка существует → Вывод сообщения (print)
    │
    Конец
```

**Примеры**:

```python
# Пример вызова функции upgrade (обычно вызывается Alembic)
upgrade()
```

### `downgrade`

```python
def downgrade() -> None:
    """
    Удаляет колонку 'payment_id' из таблицы 'purchases', если она существует.

    Функция сначала проверяет, существует ли колонка 'payment_id' в таблице 'purchases'.
    Если колонка существует, она удаляется вместе с уникальным индексом.

    Если колонка не существует, выводится сообщение о пропуске удаления.

    Как работает функция:
    1.  Получает текущее соединение с базой данных.
    2.  Запрашивает информацию о таблице 'purchases' для получения списка колонок.
    3.  Проверяет наличие колонки 'payment_id' в списке колонок.
    4.  Если колонка присутствует, удаляет её и уникальный индекс.
    5.  Если колонки нет, выводит сообщение в консоль.
    """
```

**Как работает функция**:

```
    Начало
    │
    └── Получение соединения с БД (conn = op.get_bind())
    │
    └── Запрос информации о таблице (result = conn.execute(sa.text("PRAGMA table_info('purchases')")))
    │
    └── Извлечение имен колонок (columns = [row[1] for row in result])
    │
    └── Проверка существования колонки 'payment_id' (if 'payment_id' in columns)
    │   ├── Колонка присутствует → Удаление колонки и уникального индекса (op.drop_constraint, op.drop_column)
    │   └── Колонка отсутствует → Вывод сообщения (print)
    │
    Конец
```

**Примеры**:

```python
# Пример вызова функции downgrade (обычно вызывается Alembic)
downgrade()