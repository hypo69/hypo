# Модуль HuggingChat

## Обзор

Модуль `HuggingChat` предоставляет асинхронный интерфейс для взаимодействия с моделью Hugging Face Chat. Он включает поддержку аутентификации, создания бесед, обмена сообщениями и обработки ответов, включая текст, изображения и результаты веб-поиска.

## Подробней

Этот модуль предназначен для интеграции с сервисом Hugging Face Chat, обеспечивая возможность программного доступа к чат-боту. Он поддерживает как текстовые, так и визуальные модели, а также позволяет выполнять поиск в интернете и генерировать заголовки для бесед. Модуль использует библиотеку `curl_cffi` для эффективного выполнения HTTP-запросов.

## Классы

### `Conversation`

**Описание**: Класс `Conversation` представляет собой контейнер для хранения информации о беседе, включая идентификаторы беседы и сообщений для каждой используемой модели.

**Наследует**: `JsonConversation`

**Атрибуты**:
- `models` (dict): Словарь, содержащий информацию о беседах для каждой модели.

### `HuggingChat`

**Описание**: Класс `HuggingChat` реализует асинхронный интерфейс для взаимодействия с Hugging Face Chat. Он предоставляет методы для аутентификации, создания бесед, отправки сообщений и обработки ответов.

**Наследует**: `AsyncAuthedProvider`, `ProviderModelMixin`

**Атрибуты**:
- `domain` (str): Доменное имя Hugging Face Chat (`"huggingface.co"`).
- `origin` (str): Базовый URL Hugging Face Chat (`"https://huggingface.co"`).
- `url` (str): URL чата Hugging Face (`"https://huggingface.co/chat"`).
- `working` (bool): Флаг, указывающий, работает ли провайдер (всегда `True`).
- `use_nodriver` (bool): Флаг, указывающий, используется ли бездрайверный режим (всегда `True`).
- `supports_stream` (bool): Флаг, указывающий, поддерживается ли потоковая передача (всегда `True`).
- `needs_auth` (bool): Флаг, указывающий, требуется ли аутентификация (всегда `True`).
- `default_model` (str): Идентификатор модели по умолчанию.
- `default_vision_model` (str): Идентификатор модели для работы с изображениями по умолчанию.
- `model_aliases` (dict): Словарь псевдонимов моделей.
- `image_models` (list): Список идентификаторов моделей, поддерживающих работу с изображениями.
- `text_models` (list): Список идентификаторов моделей для работы с текстом.

**Методы**:

- `get_models`: Получает список доступных моделей из Hugging Face Chat.
- `on_auth_async`: Выполняет асинхронную аутентификацию пользователя.
- `create_authed`: Создает аутентифицированный запрос к Hugging Face Chat.
- `create_conversation`: Создает новую беседу.
- `fetch_message_id`: Получает идентификатор последнего сообщения в беседе.

## Функции

### `get_models`

```python
@classmethod
def get_models(cls):
    """Получает список доступных моделей из Hugging Face Chat.

    Args:
        cls (HuggingChat): Ссылка на класс HuggingChat.

    Returns:
        list: Список идентификаторов доступных моделей.

    Raises:
        Exception: Если происходит ошибка при чтении моделей.

    Как работает функция:
    1.  Делает запрос к странице чата Hugging Face для получения списка моделей.
    2.  Извлекает JSON с информацией о моделях из HTML-кода страницы.
    3.  Обновляет атрибуты `text_models`, `models` и `vision_models` класса `HuggingChat`.
    4.  В случае ошибки логирует ее и использует резервный список моделей.

    ASCII flowchart:
    A: Запрос HTML страницы чата Hugging Face
    |
    B: Извлечение JSON с информацией о моделях
    |
    C: Обновление атрибутов класса HuggingChat
    |
    D: Обработка ошибок и использование резервного списка
    """
```

### `on_auth_async`

```python
@classmethod
async def on_auth_async(cls, cookies: Cookies = None, proxy: str = None, **kwargs) -> AsyncIterator:
    """Выполняет асинхронную аутентификацию пользователя.

    Args:
        cls (HuggingChat): Ссылка на класс HuggingChat.
        cookies (Cookies, optional): Cookies для аутентификации. По умолчанию `None`.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Yields:
        AuthResult: Результат аутентификации.
        RequestLogin: Запрос на вход, если требуется аутентификация.

    Raises:
        MissingAuthError: Если не удалось пройти аутентификацию.

    Как работает функция:

    1.  Проверяет наличие cookies `hf-chat`. Если они есть, возвращает результат аутентификации.
    2.  Если cookies отсутствуют, запрашивает URL для входа через `RequestLogin`.
    3.  Получает аргументы из бездрайверного режима и возвращает результат аутентификации.
    4.  Если аутентификация не требуется, генерирует случайный `session ID` и возвращает его в cookies.

    ASCII flowchart:
    A: Проверка наличия cookies `hf-chat`
    |
    B: Запрос URL для входа (если cookies отсутствуют)
    |
    C: Получение аргументов из бездрайверного режима
    |
    D: Генерация случайного session ID (если аутентификация не требуется)
    |
    E: Возврат результата аутентификации
    """
```

### `create_authed`

```python
@classmethod
async def create_authed(
    cls,
    model: str,
    messages: Messages,
    auth_result: AuthResult,
    prompt: str = None,
    media: MediaListType = None,
    return_conversation: bool = False,
    conversation: Conversation = None,
    web_search: bool = False,
    **kwargs
) -> AsyncResult:
    """Создает аутентифицированный запрос к Hugging Face Chat.

    Args:
        cls (HuggingChat): Ссылка на класс HuggingChat.
        model (str): Идентификатор модели.
        messages (Messages): Список сообщений в беседе.
        auth_result (AuthResult): Результат аутентификации.
        prompt (str, optional): Дополнительный промпт. По умолчанию `None`.
        media (MediaListType, optional): Список медиафайлов. По умолчанию `None`.
        return_conversation (bool, optional): Флаг, указывающий, нужно ли возвращать объект беседы. По умолчанию `False`.
        conversation (Conversation, optional): Объект беседы. По умолчанию `None`.
        web_search (bool, optional): Флаг, указывающий, нужно ли выполнять поиск в интернете. По умолчанию `False`.
        **kwargs: Дополнительные аргументы.

    Yields:
        str: Текст ответа от чат-бота.
        ImageResponse: Объект с информацией об изображении.
        Sources: Объект с источниками из веб-поиска.
        TitleGeneration: Объект с сгенерированным заголовком.
        Reasoning: Объект с рассуждениями.
        FinishReason: Объект с причиной завершения.
        Conversation: Объект беседы, если `return_conversation` установлен в `True`.

    Raises:
        MissingRequirementsError: Если не установлена библиотека `curl_cffi`.
        MissingAuthError: Если не удалось пройти аутентификацию.
        ResponseError: Если сервер вернул ошибку.

    Как работает функция:

    1.  Проверяет наличие необходимых библиотек и аутентификационных данных.
    2.  Инициализирует сессию `curl_cffi` с использованием данных аутентификации.
    3.  Создает или использует существующую беседу.
    4.  Форматирует запрос и отправляет его в Hugging Face Chat.
    5.  Обрабатывает ответ, извлекая текст, изображения, источники из веб-поиска и другую информацию.
    6.  Возвращает результаты в виде потока объектов.

    ASCII flowchart:
    A: Проверка наличия необходимых библиотек и аутентификационных данных
    |
    B: Инициализация сессии `curl_cffi`
    |
    C: Создание или использование существующей беседы
    |
    D: Форматирование запроса
    |
    E: Отправка запроса в Hugging Face Chat
    |
    F: Обработка ответа и извлечение информации
    |
    G: Возврат результатов в виде потока объектов
    """
```

### `create_conversation`

```python
@classmethod
def create_conversation(cls, session: Session, model: str):
    """Создает новую беседу.

    Args:
        cls (HuggingChat): Ссылка на класс HuggingChat.
        session (Session): Сессия `curl_cffi`.
        model (str): Идентификатор модели.

    Returns:
        str: Идентификатор созданной беседы.

    Raises:
        MissingAuthError: Если не удалось пройти аутентификацию.
        ResponseError: Если сервер вернул ошибку.

    Как работает функция:

    1.  Формирует JSON-данные с указанием используемой модели.
    2.  Отправляет POST-запрос на URL создания беседы.
    3.  Обрабатывает возможные ошибки аутентификации и другие ошибки от сервера.
    4.  Возвращает идентификатор созданной беседы.

    ASCII flowchart:
    A: Формирование JSON-данных
    |
    B: Отправка POST-запроса на URL создания беседы
    |
    C: Обработка ошибок аутентификации и других ошибок
    |
    D: Возврат идентификатора созданной беседы
    """
```

### `fetch_message_id`

```python
@classmethod
def fetch_message_id(cls, session: Session, conversation_id: str):
    """Получает идентификатор последнего сообщения в беседе.

    Args:
        cls (HuggingChat): Ссылка на класс HuggingChat.
        session (Session): Сессия `curl_cffi`.
        conversation_id (str): Идентификатор беседы.

    Returns:
        str: Идентификатор последнего сообщения.

    Raises:
        RuntimeError: Если не удалось получить или извлечь идентификатор сообщения.
        MissingAuthError: Если произошла ошибка аутентификации.
        ResponseError: Если сервер вернул ошибку.

    Как работает функция:

    1.  Отправляет GET-запрос на URL для получения данных о беседе.
    2.  Разбирает ответ, разделяя его на строки и извлекая JSON-данные.
    3.  Извлекает идентификатор последнего сообщения из JSON-данных.
    4.  Обрабатывает возможные ошибки, такие как ошибки аутентификации и ошибки разбора JSON.
    5.  В случае успеха возвращает идентификатор последнего сообщения.

    ASCII flowchart:
    A: Отправка GET-запроса на URL для получения данных о беседе
    |
    B: Разбор ответа на строки и извлечение JSON-данных
    |
    C: Извлечение идентификатора последнего сообщения из JSON-данных
    |
    D: Обработка ошибок
    |
    E: Возврат идентификатора последнего сообщения
    """