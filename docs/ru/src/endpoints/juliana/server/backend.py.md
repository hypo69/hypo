# Модуль backend.py

## Обзор

Модуль `backend.py` предоставляет API для обработки запросов к модели чат-бота, включая поддержку стриминга ответов, интеграцию с прокси-серверами и реализацию jailbreak-инструкций. Модуль содержит класс `Backend_Api`, который инициализирует Flask-приложение и настраивает маршруты для обработки запросов.

## Подробнее

Этот модуль является частью серверной логики приложения. Он обрабатывает входящие запросы, формирует сообщения для модели чат-бота, получает ответы и возвращает их клиенту. Он также включает функциональность для использования прокси-серверов и применения jailbreak-инструкций.
Модуль использует сторонние библиотеки, такие как `googletrans` для определения языка запроса, `requests` для выполнения HTTP-запросов и `flask` для создания API.

## Классы

### `Backend_Api`

**Описание**: Класс `Backend_Api` инициализирует API для обработки запросов к модели чат-бота.

**Принцип работы**:
Класс принимает экземпляр Flask-приложения и конфигурацию в виде словаря. Он настраивает маршруты для обработки запросов и запускает обновление прокси-серверов, если это необходимо.

**Атрибуты**:
- `app`: Экземпляр Flask-приложения.
- `use_auto_proxy` (bool): Флаг, указывающий, следует ли использовать автоматическое обновление прокси-серверов.
- `routes` (dict): Словарь, содержащий маршруты API и соответствующие функции-обработчики.

**Методы**:

- `__init__(self, app, config: dict) -> None`
    ```python
    def __init__(self, app, config: dict) -> None:
        """Инициализирует экземпляр класса Backend_Api.

        Args:
            app: Экземпляр Flask-приложения.
            config (dict): Конфигурация приложения.

        Returns:
            None

        """
    ```
- `_conversation(self)`
    ```python
    def _conversation(self):
        """Обрабатывает запросы к API для получения ответа от модели чат-бота.

        Args:
            self

        Returns:
            Flask.response_class: Возвращает стриминговый ответ от модели чат-бота в формате `text/event-stream` в случае успеха.
            dict: Возвращает словарь с информацией об ошибке в случае неудачи и HTTP-код 400.

        Raises:
            Exception: В случае возникновения ошибки при обработке запроса.

        """
    ```

## Функции

### `build_messages(jailbreak)`

```python
def build_messages(jailbreak):
    """Создает сообщение для отправки в модель чат-бота.

    Args:
        jailbreak: Параметр `jailbreak` из запроса.

    Returns:
        conversation: Список сообщений для отправки в модель чат-бота.

    """
```

**Назначение**: Функция `build_messages` создает сообщение для отправки в модель чат-бота на основе данных из запроса. Она включает системное сообщение, историю разговора, результаты поиска в интернете (если включено) и jailbreak-инструкции (если включено).

**Параметры**:
- `jailbreak`: Параметр `jailbreak` из запроса.

**Возвращает**:
- `conversation`: Список сообщений для отправки в модель чат-бота.

**Как работает функция**:

1.  **Извлечение данных из запроса**: Извлекает данные из объекта `request.json`, включая историю разговора (`_conversation`), флаг доступа к интернету (`internet_access`) и промпт пользователя (`prompt`).
2.  **Формирование системного сообщения**: Создает системное сообщение, включающее текущую дату и язык ответа.
3.  **Инициализация разговора**: Инициализирует список `conversation` системным сообщением.
4.  **Добавление истории разговора**: Добавляет существующую историю разговора в список `conversation`.
5.  **Добавление результатов поиска**: Если включен доступ к интернету, добавляет результаты поиска в список `conversation`.
6.  **Добавление jailbreak-инструкций**: Если включены jailbreak-инструкции, добавляет их в список `conversation`.
7.  **Добавление промпта пользователя**: Добавляет промпт пользователя в список `conversation`.
8.  **Уменьшение размера разговора**: Ограничивает размер списка `conversation` до 13 элементов, чтобы избежать ошибок, связанных с количеством токенов API.

```
Извлечение данных из запроса и формирование системного сообщения
│
↓
Добавление истории разговора
│
↓
Добавление результатов поиска (если включено)
│
↓
Добавление jailbreak-инструкций (если включено)
│
↓
Добавление промпта пользователя
│
↓
Уменьшение размера разговора
│
↓
Возврат списка сообщений
```

**Примеры**:

```python
# Пример вызова функции build_messages с jailbreak
messages = build_messages(jailbreak='Default')

# Пример вызова функции build_messages без jailbreak
messages = build_messages(jailbreak=None)
```

### `fetch_search_results(query)`

```python
def fetch_search_results(query):
    """Получает результаты поиска в интернете.

    Args:
        query: Поисковой запрос.

    Returns:
        results: Список результатов поиска.

    """
```

**Назначение**: Функция `fetch_search_results` выполняет поиск в интернете с использованием DuckDuckGo API и возвращает результаты в виде списка.

**Параметры**:
- `query`: Поисковой запрос.

**Возвращает**:
- `results`: Список результатов поиска.

**Как работает функция**:

1.  **Выполнение запроса к API**: Выполняет GET-запрос к DuckDuckGo API с поисковым запросом и ограничением на 5 результатов.
2.  **Обработка результатов**: Перебирает результаты поиска и формирует строку с информацией о каждом результате, включая сниппет и URL.
3.  **Формирование сообщения**: Создает сообщение с результатами поиска и добавляет его в список `results`.

```
Выполнение запроса к API
│
↓
Обработка результатов и формирование строки с информацией
│
↓
Формирование сообщения с результатами поиска
│
↓
Возврат списка результатов
```

**Примеры**:

```python
# Пример вызова функции fetch_search_results
results = fetch_search_results(query='Что такое Python?')
```

### `generate_stream(response, jailbreak)`

```python
def generate_stream(response, jailbreak):
    """Генерирует стриминговый ответ на основе ответа от модели чат-бота.

    Args:
        response: Ответ от модели чат-бота.
        jailbreak: Параметр `jailbreak` из запроса.

    Yields:
        message: Часть стримингового ответа.

    """
```

**Назначение**: Функция `generate_stream` генерирует стриминговый ответ на основе ответа от модели чат-бота. Она обрабатывает jailbreak-инструкции, если они включены.

**Параметры**:
- `response`: Ответ от модели чат-бота.
- `jailbreak`: Параметр `jailbreak` из запроса.

**Как работает функция**:

1.  **Проверка jailbreak**: Проверяет, включены ли jailbreak-инструкции.
2.  **Обработка jailbreak**: Если jailbreak включен, функция проверяет, успешно ли выполнена jailbreak-инструкция. Если jailbreak выполнен успешно, функция начинает возвращать части ответа от модели чат-бота. Если jailbreak не выполнен, функция возвращает сообщение об ошибке.
3.  **Генерация стримингового ответа**: Если jailbreak не включен, функция просто возвращает части ответа от модели чат-бота.

```
Проверка jailbreak
│
↓
Обработка jailbreak (если включено)
│
↓
Генерация стримингового ответа
│
↓
Возврат части стримингового ответа
```

**Примеры**:

```python
# Пример вызова функции generate_stream с jailbreak
stream = generate_stream(response, jailbreak='Default')

# Пример вызова функции generate_stream без jailbreak
stream = generate_stream(response, jailbreak=None)
```

### `response_jailbroken_success(response: str) -> bool`

```python
def response_jailbroken_success(response: str) -> bool:
    """Проверяет, успешно ли выполнена jailbreak-инструкция.

    Args:
        response (str): Ответ от модели чат-бота.

    Returns:
        bool: True, если jailbreak выполнен успешно, False в противном случае.

    """
```

**Назначение**: Функция `response_jailbroken_success` проверяет, успешно ли выполнена jailbreak-инструкция, путем поиска ключевого слова "ACT:" в ответе от модели чат-бота.

**Параметры**:
- `response` (str): Ответ от модели чат-бота.

**Возвращает**:
- `bool`: `True`, если jailbreak выполнен успешно, `False` в противном случае.

**Как работает функция**:

1.  **Поиск ключевого слова**: Выполняет поиск ключевого слова "ACT:" в ответе от модели чат-бота с использованием регулярного выражения.
2.  **Возврат результата**: Возвращает `True`, если ключевое слово найдено, `False` в противном случае.

```
Поиск ключевого слова "ACT:"
│
↓
Возврат результата
```

**Примеры**:

```python
# Пример вызова функции response_jailbroken_success
success = response_jailbroken_success(response='ACT: Hello, world!')
```

### `response_jailbroken_failed(response)`

```python
def response_jailbroken_failed(response):
    """Проверяет, не провалена ли jailbreak-инструкция.

    Args:
        response: Ответ от модели чат-бота.

    Returns:
        bool: False, если длина ответа меньше 4 символов, в противном случае - если ответ не начинается с GPT: или ACT:

    """
```

**Назначение**: Функция `response_jailbroken_failed` проверяет, не провалена ли jailbreak-инструкция, путем проверки длины ответа и наличия префиксов "GPT:" или "ACT:".

**Параметры**:
- `response`: Ответ от модели чат-бота.

**Возвращает**:
- `bool`: `False`, если длина ответа меньше 4 символов, в противном случае - если ответ не начинается с GPT: или ACT:.

**Как работает функция**:

1.  **Проверка длины ответа**: Проверяет, что длина ответа больше или равна 4 символам.
2.  **Проверка префиксов**: Проверяет, что ответ начинается с "GPT:" или "ACT:".
3.  **Возврат результата**: Возвращает `False`, если длина ответа меньше 4 символов, в противном случае - если ответ не начинается с GPT: или ACT:.

```
Проверка длины ответа
│
↓
Проверка префиксов "GPT:" или "ACT:"
│
↓
Возврат результата
```

**Примеры**:

```python
# Пример вызова функции response_jailbroken_failed
failed = response_jailbroken_failed(response='GPT: Hello, world!')
```

### `set_response_language(prompt)`

```python
def set_response_language(prompt):
    """Определяет язык запроса и формирует инструкцию для модели чат-бота.

    Args:
        prompt: Текст запроса.

    Returns:
        str: Строка с инструкцией для модели чат-бота о языке ответа.

    """
```

**Назначение**: Функция `set_response_language` определяет язык запроса с использованием Google Translate API и формирует инструкцию для модели чат-бота о том, на каком языке следует отвечать.

**Параметры**:
- `prompt`: Текст запроса.

**Возвращает**:
- `str`: Строка с инструкцией для модели чат-бота о языке ответа.

**Как работает функция**:

1.  **Определение языка**: Определяет язык запроса с использованием `translator.detect(prompt['content']).lang`.
2.  **Формирование инструкции**: Формирует строку с инструкцией для модели чат-бота о языке ответа.

```
Определение языка запроса
│
↓
Формирование инструкции для модели чат-бота
│
↓
Возврат инструкции
```

**Примеры**:

```python
# Пример вызова функции set_response_language
instruction = set_response_language(prompt={'content': 'Hello, world!'})
```

### `isJailbreak(jailbreak)`

```python
def isJailbreak(jailbreak):
    """Проверяет, включены ли jailbreak-инструкции.

    Args:
        jailbreak: Параметр `jailbreak` из запроса.

    Returns:
        special_instructions[jailbreak]: Соответствующие инструкции, если jailbreak включен.
        None: В противном случае.

    """
```

**Назначение**: Функция `isJailbreak` проверяет, включены ли jailbreak-инструкции, и возвращает соответствующие инструкции из словаря `special_instructions`.

**Параметры**:
- `jailbreak`: Параметр `jailbreak` из запроса.

**Возвращает**:
- `special_instructions[jailbreak]`: Соответствующие инструкции, если jailbreak включен.
- `None`: В противном случае.

**Как работает функция**:

1.  **Проверка параметра `jailbreak`**: Проверяет, что параметр `jailbreak` не равен "Default".
2.  **Возврат инструкций**: Если параметр `jailbreak` не равен "Default", функция возвращает соответствующие инструкции из словаря `special_instructions`.

```
Проверка параметра jailbreak
│
↓
Возврат инструкций (если включено)
│
↓
Возврат None (если не включено)
```

**Примеры**:

```python
# Пример вызова функции isJailbreak с jailbreak
instructions = isJailbreak(jailbreak='Default')

# Пример вызова функции isJailbreak без jailbreak
instructions = isJailbreak(jailbreak=None)