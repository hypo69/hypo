# Модуль Opchatgpts
## Обзор

Модуль `Opchatgpts` предоставляет асинхронный генератор для взаимодействия с сервисом Opchatgpts.net. Он позволяет отправлять сообщения и получать ответы в режиме реального времени. Модуль поддерживает историю сообщений и модель `gpt-3.5-turbo`.

## Подробней

Этот модуль используется для интеграции с сервисом Opchatgpts.net, предоставляющим доступ к чат-боту. Он создает асинхронный генератор, который отправляет сообщения пользователя на сервер Opchatgpts.net и получает ответы в реальном времени.
Поддерживает проксирование запросов.

## Классы

### `Opchatgpts`

**Описание**: Класс `Opchatgpts` является асинхронным провайдером генератора для взаимодействия с Opchatgpts.net.

**Принцип работы**:
Класс определяет URL сервиса, указывает на поддержку истории сообщений и модели `gpt-3.5-turbo`.
Основная функциональность заключается в методе `create_async_generator`, который создает асинхронный генератор для отправки сообщений и получения ответов от сервиса.

**Атрибуты**:
- `url` (str): URL сервиса Opchatgpts.net.
- `working` (bool): Флаг, указывающий на работоспособность провайдера (по умолчанию `False`).
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений (по умолчанию `True`).
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели `gpt-3.5-turbo` (по умолчанию `True`).

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None, **kwargs) -> AsyncResult:
        """
        Создает асинхронный генератор для взаимодействия с Opchatgpts.net.

        Args:
            cls (Type[Opchatgpts]): Ссылка на класс `Opchatgpts`.
            model (str): Идентификатор модели (не используется в данной реализации).
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncResult: Асинхронный генератор, выдающий ответы от сервиса.

        Raises:
            RuntimeError: Если полученная строка не соответствует ожидаемому формату.
        """
```

**Назначение**: Создает асинхронный генератор, который отправляет сообщения пользователя на сервер Opchatgpts.net и получает ответы в режиме реального времени.

**Параметры**:
- `cls`: Ссылка на класс `Opchatgpts`.
- `model` (str): Идентификатор модели (не используется в данной реализации).
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий ответы от сервиса.

**Вызывает исключения**:
- `RuntimeError`: Если полученная строка не соответствует ожидаемому формату.

**Как работает функция**:

1.  **Подготовка заголовков**:
    Создаются заголовки для HTTP-запроса, включая `User-Agent`, `Accept`, `Origin` и другие необходимые параметры.

2.  **Создание сессии**:
    Используется `aiohttp.ClientSession` для выполнения асинхронных HTTP-запросов. Заголовки передаются при создании сессии.

3.  **Подготовка данных**:
    Формируется словарь `data` с параметрами запроса, такими как `botId`, `chatId`, `contextId`, `messages` и `newMessage`.

4.  **Отправка запроса**:
    Выполняется POST-запрос к адресу `f"{cls.url}/wp-json/mwai-ui/v1/chats/submit"` с использованием сессии, прокси (если указан) и сформированных данных в формате JSON.

5.  **Обработка ответа**:
    Полученный ответ обрабатывается построчно. Каждая строка проверяется на наличие префикса `b"data: "`. Если префикс присутствует, строка декодируется из JSON.

6.  **Генерация результатов**:
    Если в декодированной строке есть ключ `"type"`, проверяется его значение. Если `"type" == "live"`, то извлекаются данные из ключа `"data"` и возвращаются через генератор. Если `"type" == "end"`, цикл завершается.

7.  **Обработка ошибок**:
    Если строка не может быть декодирована из JSON или не содержит ключ `"type"`, выбрасывается исключение `RuntimeError`.

**Внутренние функции**: Нет

**ASCII схема работы функции**:

```
    [Начало]
        ↓
    [Подготовка заголовков]
        ↓
    [Создание асинхронной сессии]
        ↓
    [Подготовка данных для отправки]
        ↓
    [Отправка POST запроса]
        ↓
    [Получение ответа]
        ↓
    [Обработка ответа построчно]
        |
        → [Проверка на наличие префикса b"data: "]
        |   Если префикс отсутствует: [Пропустить строку]
        |   Если префикс присутствует:
        |       ↓
        |   [Декодирование JSON]
        |       ↓
        |   [Проверка наличия ключа "type"]
        |       Если ключа нет: [Выброс исключения RuntimeError]
        |       Если ключ есть:
        |           ↓
        |       [Проверка значения "type"]
        |           Если "type" == "live": [Извлечение данных и передача в генератор]
        |           Если "type" == "end": [Завершение цикла]
        |           Иначе: [Пропустить строку]
        ↓
    [Конец]
```

**Примеры**:

```python
# Пример использования асинхронного генератора
async def main():
    messages = [{"role": "user", "content": "Привет, как дела?"}]
    async for message in Opchatgpts.create_async_generator(model="default", messages=messages):
        print(message)

import asyncio
asyncio.run(main())
```
```python
# Пример использования с прокси
async def main():
    messages = [{"role": "user", "content": "Привет, как дела?"}]
    proxy = "http://your_proxy:8080"  # Замените на ваш прокси
    async for message in Opchatgpts.create_async_generator(model="default", messages=messages, proxy=proxy):
        print(message)

import asyncio
asyncio.run(main())