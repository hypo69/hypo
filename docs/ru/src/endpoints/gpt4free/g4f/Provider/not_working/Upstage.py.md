# Модуль `Upstage`

## Обзор

Модуль `Upstage` предоставляет асинхронный интерфейс для взаимодействия с API Upstage AI для генерации текста. Он использует `aiohttp` для асинхронных HTTP-запросов и предоставляет функциональность для выбора модели, форматирования запросов и обработки потоковых ответов.

## Подробнее

Модуль предназначен для интеграции с другими частями проекта `hypotez`, где требуется взаимодействие с большими языковыми моделями, предоставляемыми Upstage AI. Он поддерживает выбор различных моделей и предоставляет удобный интерфейс для отправки запросов и получения ответов в потоковом режиме.

## Классы

### `Upstage`

**Описание**: Класс `Upstage` является провайдером для работы с API Upstage AI. Он наследует функциональность от `AsyncGeneratorProvider` и `ProviderModelMixin`, предоставляя методы для асинхронной генерации текста и выбора моделей.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Аттрибуты**:
- `url` (str): URL главной страницы Upstage AI.
- `api_endpoint` (str): URL API для запросов на генерацию текста.
- `working` (bool): Указывает, работает ли провайдер в данный момент.
- `default_model` (str): Модель, используемая по умолчанию (`solar-pro`).
- `models` (List[str]): Список поддерживаемых моделей.
- `model_aliases` (Dict[str, str]): Словарь псевдонимов моделей.

#### `get_model`

```python
    @classmethod
    def get_model(cls, model: str) -> str:
        """
        Возвращает имя модели на основе предоставленного псевдонима или имени.

        Args:
            model (str): Имя модели или псевдоним.

        Returns:
            str: Имя модели.

        """
```
**Как работает функция**:

1. Проверяет, входит ли предоставленное имя модели в список поддерживаемых моделей (`cls.models`).
2. Если модель найдена в списке поддерживаемых, возвращает ее имя.
3. Если модель не найдена в списке поддерживаемых, проверяет, есть ли она в словаре псевдонимов моделей (`cls.model_aliases`).
4. Если псевдоним модели найден, возвращает соответствующее имя модели из словаря псевдонимов.
5. Если ни имя модели, ни псевдоним не найдены, возвращает имя модели по умолчанию (`cls.default_model`).

```
Проверка наличия модели в списке поддерживаемых --> Возврат имени модели
                                      |
                                      Нет
                                      |
Проверка наличия модели в словаре псевдонимов --> Возврат имени модели из словаря псевдонимов
                                      |
                                      Нет
                                      |
                                  Возврат имени модели по умолчанию
```

**Примеры**:
```python
    Upstage.get_model('solar-pro')  # Возвращает 'solar-pro'
    Upstage.get_model('solar-mini') # Возвращает 'upstage/solar-1-mini-chat-ja'
    Upstage.get_model('unknown')    # Возвращает 'solar-pro'
```

#### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для взаимодействия с API Upstage AI.

        Args:
            model (str): Имя модели для использования.
            messages (Messages): Список сообщений для отправки в API.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий текст от API.

        Raises:
            Exception: Если возникает ошибка при запросе к API.

        """
```

**Как работает функция**:

1. Получает имя модели с помощью метода `cls.get_model(model)`.
2. Определяет заголовки (`headers`) для HTTP-запроса, включая User-Agent, Referer и Content-Type.
3. Создает асинхронную сессию `aiohttp.ClientSession` с заданными заголовками.
4. Формирует данные (`data`) для отправки в API, включая флаг потоковой передачи, сообщения и имя модели.
5. Отправляет POST-запрос к API (`cls.api_endpoint`) с использованием асинхронной сессии, передавая данные и прокси (если указан).
6. Обрабатывает потоковый ответ от API, декодируя каждую строку и извлекая содержимое из JSON-ответа.
7. Генерирует (`yield`) извлеченное содержимое, если оно присутствует в ответе.
8. Завершает генерацию, когда получает сообщение "data: [DONE]".

```
Получение имени модели --> Определение заголовков HTTP-запроса --> Создание асинхронной сессии
|
Формирование данных для отправки в API
|
Отправка POST-запроса к API
|
Обработка потокового ответа от API
|
Извлечение содержимого из JSON-ответа --> Генерация содержимого (если есть)
|
Завершение генерации при получении сообщения "data: [DONE]"
```

**Примеры**:
```python
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    async for message in Upstage.create_async_generator(model='solar-pro', messages=messages):
        print(message, end='')
```
## Функции

В данном модуле функции отсутствуют