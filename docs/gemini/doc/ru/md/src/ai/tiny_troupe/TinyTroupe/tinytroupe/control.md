# Модуль `tinytroupe.control`

## Обзор

Этот модуль предоставляет механизмы управления симуляцией. Он содержит класс `Simulation` для инициализации, управления и сохранения состояния симуляции, а также декоратор `transactional` для выполнения функций в рамках транзакции, учитывая кэширование.

## Классы

### `Simulation`

**Описание**: Класс, представляющий симуляцию и управляющий её состоянием. Он хранит агентов, окружения и фабрики, а также обеспечивает механизмы кэширования и транзакционного управления.

**Атрибуты**:

- `id`: Идентификатор симуляции (по умолчанию "default").
- `agents`: Список агентов в симуляции.
- `name_to_agent`: Словарь, сопоставляющий имя агента с объектом агента.
- `environments`: Список окружений в симуляции.
- `name_to_environment`: Словарь, сопоставляющий имя окружения с объектом окружения.
- `factories`: Список фабрик в симуляции.
- `name_to_factory`: Словарь, сопоставляющий имя фабрики с объектом фабрики.
- `status`: Текущий статус симуляции ("stopped" или "started").
- `cache_path`: Путь к файлу кэша.
- `auto_checkpoint`: Флаг автоматического сохранения кэша после каждой транзакции.
- `has_unsaved_cache_changes`: Флаг наличия несохранённых изменений в кэше.
- `_under_transaction`: Флаг, указывающий, находится ли симуляция в транзакции.
- `cached_trace`: Список состояний симуляции, кэшированных в файле.
- `execution_trace`: Текущий список состояний симуляции, подлежащих обработке.


**Методы**:

- `__init__(self, id="default", cached_trace: list = None)`: Инициализирует объект `Simulation`.
- `begin(self, cache_path: str = None, auto_checkpoint: bool = False)`: Начинает управление симуляцией.
- `end(self)`: Останавливает управление симуляцией и сохраняет состояние.
- `checkpoint(self)`: Сохраняет текущее состояние симуляции в кэш.
- `add_agent(self, agent)`: Добавляет агента в симуляцию.
- `add_environment(self, environment)`: Добавляет окружение в симуляцию.
- `add_factory(self, factory)`: Добавляет фабрику в симуляцию.
- `_execution_trace_position(self) -> int`: Возвращает текущую позицию в трассе выполнения или -1, если трасса пуста.
- `_function_call_hash(self, function_name, *args, **kwargs) -> int`: Вычисляет хеш заданного вызова функции.
- `_skip_execution_with_cache(self)`: Пропускает текущее выполнение, предполагая наличие кэшированного состояния в той же позиции.
- `_is_transaction_event_cached(self, event_hash) -> bool`: Проверяет, совпадает ли заданный хеш события с соответствующим кэшированным, если таковой есть.
- `_drop_cached_trace_suffix(self)`: Откатывает кэшированную трассу до текущей позиции в трассе выполнения.
- `_add_to_execution_trace(self, state: dict, event_hash: int, event_output)`: Добавляет состояние в список `execution_trace`.
- `_add_to_cache_trace(self, state: dict, event_hash: int, event_output)`: Добавляет состояние в список `cached_trace`.
- `_load_cache_file(self, cache_path: str)`: Загружает кэш из файла.
- `_save_cache_file(self, cache_path: str)`: Сохраняет кэш в файл.
- `begin_transaction(self)`: Начинает транзакцию.
- `end_transaction(self)`: Завершает транзакцию.
- `is_under_transaction(self)`: Проверяет, находится ли агент в транзакции.
- `_clear_communications_buffers(self)`: Очищает буферы связи всех агентов и окружений.
- `_encode_simulation_state(self) -> dict`: Кодирует текущее состояние симуляции.
- `_decode_simulation_state(self, state: dict)`: Декодирует заданное состояние симуляции.


### `Transaction`

**Описание**: Класс, управляющий выполнением функций в рамках транзакции.

**Методы**:

- `__init__(self, obj_under_transaction, simulation, function, *args, **kwargs)`: Инициализирует объект `Transaction`.
- `execute(self)`: Выполняет функцию в рамках транзакции, учитывая кэширование.
- `_encode_function_output(self, output) -> dict`: Кодирует выходное значение функции.
- `_decode_function_output(self, encoded_output: dict)`: Декодирует закодированное выходное значение функции.


## Функции

### `transactional(func)`

**Описание**: Декоратор, который делает функцию транзакционной.

**Параметры**:
- `func`: Функция, которую нужно сделать транзакционной.

**Возвращает**: Обёртку функции.


### `reset()`

**Описание**: Сбрасывает состояние управления симуляцией.


### `_simulation(id="default")`

**Описание**: Возвращает объект `Simulation` по идентификатору.


### `begin(cache_path=None, id="default", auto_checkpoint=False)`

**Описание**: Начинает управление симуляцией.


### `end(id="default")`

**Описание**: Останавливает управление симуляцией.


### `checkpoint(id="default")`

**Описание**: Сохраняет текущее состояние симуляции.


### `current_simulation()`

**Описание**: Возвращает текущую симуляцию.


## Исключения

### `SkipTransaction`

**Описание**: Исключение, сигнализирующее о пропуске транзакции.

### `CacheOutOfSync`

**Описание**: Исключение, сигнализирующее о рассогласовании кэшированной и текущей информации.

### `ExecutionCached`

**Описание**: Исключение, сигнализирующее о том, что предложенное выполнение уже кэшировано.