# Модуль для работы с провайдером Ails (g4f)

## Обзор

Модуль `Ails.py` предназначен для асинхронного взаимодействия с провайдером Ails через API `api.caipacity.com`. 
Он использует асинхронные запросы для генерации текста на основе предоставленных сообщений, поддерживает потоковую передачу данных и предназначен для работы с моделью `gpt-3.5-turbo`.
Модуль включает в себя функции для форматирования временных меток и создания хешей.

## Подробнее

Данный модуль является частью проекта `hypotez` и предоставляет функциональность для работы с провайдером Ails. 
Он использует библиотеку `aiohttp` для выполнения асинхронных HTTP-запросов к API `api.caipacity.com`. 
Модуль поддерживает передачу сообщений, потоковую передачу данных и предназначен для использования с моделью `gpt-3.5-turbo`.
Он также включает функции для форматирования временных меток и создания хешей, которые используются для обеспечения безопасности и целостности данных.

## Классы

### `Ails`

**Описание**: Асинхронный генератор провайдера Ails.

**Наследует**:
- `AsyncGeneratorProvider`: Базовый класс для асинхронных провайдеров, поддерживающих генерацию данных.

**Атрибуты**:
- `url` (str): URL для взаимодействия с провайдером (`https://ai.ls`).
- `working` (bool): Индикатор работоспособности провайдера (в данном случае `False`).
- `supports_message_history` (bool): Поддержка истории сообщений (`True`).
- `supports_gpt_35_turbo` (bool): Поддержка модели `gpt-3.5-turbo` (`True`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от API.

### `create_async_generator`

```python
    @staticmethod
    async def create_async_generator(
        model: str,
        messages: Messages,
        stream: bool,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для получения ответов от API.

        Args:
            model (str): Модель для генерации (в данном случае всегда `gpt-3.5-turbo`).
            messages (Messages): Список сообщений для отправки в API.
            stream (bool): Флаг потоковой передачи данных.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            **kwargs: Дополнительные аргументы (например, `temperature`).

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий текст от API.

        Raises:
            Exception: Если в ответе содержится запрещенный контент ("ai.ls" или "ai.ci").
        """
```

**Назначение**:
Создает асинхронный генератор для получения ответов от API `api.caipacity.com`.

**Параметры**:
- `model` (str): Модель для генерации (в данном случае всегда `gpt-3.5-turbo`).
- `messages` (Messages): Список сообщений для отправки в API.
- `stream` (bool): Флаг потоковой передачи данных.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы (например, `temperature`).

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий текст от API.

**Вызывает исключения**:
- `Exception`: Если в ответе содержится запрещенный контент ("ai.ls" или "ai.ci").

**Как работает функция**:

1.  **Подготовка заголовков**: Формируются заголовки HTTP-запроса, включающие `authorization`, `client-id`, `user-agent` и другие необходимые параметры.
2.  **Создание асинхронной сессии**: Создается асинхронная сессия `ClientSession` с заданными заголовками.
3.  **Формирование данных запроса**: Создается timestamp и формируется JSON-данные для отправки, включающие модель, температуру, сообщения, дату и хеш.
4.  **Отправка POST-запроса**: Отправляется POST-запрос к API `api.caipacity.com` с использованием асинхронной сессии, прокси и JSON-данных.
5.  **Обработка потока ответов**: Читаются данные из потока ответов, декодируются из UTF-8, и извлекаются токены контента из JSON.
6.  **Проверка контента**: Проверяется наличие запрещенных слов в токене (например, "ai.ls" или "ai.ci").
7.  **Генерация токенов**: Возвращается каждый токен контента через `yield`.

**ASCII Flowchart**:

```
    Начало
     |
     V
Заголовки запроса
     |
     V
Асинхронная сессия
     |
     V
Данные запроса (JSON)
     |
     V
POST-запрос к API
     |
     V
Обработка потока ответов
     |
     V
Проверка контента
     |
     V
Генерация токенов
     |
     V
    Конец
```

**Примеры**:

```python
# Пример использования create_async_generator
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Hello, how are you?"}]
stream = True
proxy = "http://your_proxy:8080"

async def main():
    generator = await Ails.create_async_generator(model, messages, stream, proxy=proxy)
    async for token in generator:
        print(token, end="")

# Запуск примера (в асинхронном контексте)
# import asyncio
# asyncio.run(main())
```

## Функции

### `_hash`

```python
def _hash(json_data: dict[str, str]) -> SHA256:
    """
    Создает SHA256 хеш из строки, сформированной на основе данных JSON.

    Args:
        json_data (dict[str, str]): Словарь с данными для хеширования (должен содержать ключи "t" и "m").

    Returns:
        SHA256: SHA256 хеш в виде строки.
    """
```

**Назначение**:
Создает SHA256 хеш из строки, сформированной на основе данных JSON.

**Параметры**:
- `json_data` (dict[str, str]): Словарь с данными для хеширования (должен содержать ключи "t" и "m").

**Возвращает**:
- `SHA256`: SHA256 хеш в виде строки.

**Как работает функция**:

1.  **Формирование базовой строки**: Создается строка `base_string`, включающая значения из `json_data` (ключи `"t"` и `"m"`), а также фиксированные строки.
2.  **Кодирование строки**: Базовая строка кодируется в байты с использованием UTF-8.
3.  **Создание хеша**: Создается SHA256 хеш из закодированной строки.
4.  **Возврат хеша**: Возвращается хеш в виде шестнадцатеричной строки.

**ASCII Flowchart**:

```
    Начало
     |
     V
Формирование базовой строки
     |
     V
Кодирование строки в байты
     |
     V
Создание SHA256 хеша
     |
     V
Возврат хеша
     |
     V
    Конец
```

**Примеры**:

```python
# Пример использования _hash
data = {"t": "1678886400", "m": "Test message"}
hash_value = _hash(data)
print(hash_value)  # Вывод: <SHA256 hash>
```

### `_format_timestamp`

```python
def _format_timestamp(timestamp: int) -> str:
    """
    Форматирует временную метку, корректируя последнюю цифру.

    Args:
        timestamp (int): Временная метка в формате Unix timestamp (в миллисекундах).

    Returns:
        str: Отформатированная временная метка в виде строки.
    """
```

**Назначение**:
Форматирует временную метку, корректируя последнюю цифру.

**Параметры**:
- `timestamp` (int): Временная метка в формате Unix timestamp (в миллисекундах).

**Возвращает**:
- `str`: Отформатированная временная метка в виде строки.

**Как работает функция**:

1.  **Получение последней цифры**: Извлекается последняя цифра временной метки.
2.  **Корректировка последней цифры**: Если последняя цифра четная, она увеличивается на 1; в противном случае остается без изменений.
3.  **Форматирование временной метки**: Временная метка корректируется путем вычитания последней цифры и добавления новой.
4.  **Возврат отформатированной временной метки**: Возвращается отформатированная временная метка в виде строки.

**ASCII Flowchart**:

```
    Начало
     |
     V
Получение последней цифры
     |
     V
Корректировка последней цифры
     |
     V
Форматирование временной метки
     |
     V
Возврат временной метки
     |
     V
    Конец
```

**Примеры**:

```python
# Пример использования _format_timestamp
timestamp = 1678886405
formatted_timestamp = _format_timestamp(timestamp)
print(formatted_timestamp)  # Вывод: 1678886406