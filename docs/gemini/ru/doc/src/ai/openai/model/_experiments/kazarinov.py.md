# Модуль для экспериментов с OpenAI (kazarinov.py)

## Обзор

Модуль предназначен для экспериментов с моделью OpenAI, включая инициализацию модели, отправку запросов и получение ответов. Он также включает в себя функцию для интерактивного общения с моделью через консоль.

## Подробней

Этот модуль содержит класс `OpenAIChat`, который упрощает взаимодействие с API OpenAI. Он позволяет задавать системные инструкции для модели и вести диалог с пользователем. Модуль также включает функцию `chat`, которая предоставляет простой интерфейс командной строки для взаимодействия с моделью OpenAI.
Модуль использует `logger` из `src.logger.logger` для логирования ошибок.

## Классы

### `OpenAIChat`

**Описание**: Класс для взаимодействия с моделью OpenAI.

**Принцип работы**:
1.  **Инициализация**: При инициализации класса задается ключ API OpenAI, системная инструкция и пустой список сообщений. Если системная инструкция предоставлена, она добавляется в список сообщений как сообщение от системы.
2.  **Отправка запроса**: Метод `ask` добавляет сообщение пользователя в список сообщений, отправляет запрос в модель OpenAI и возвращает ответ. Ответ модели добавляется в список сообщений как сообщение от ассистента.
3.  **Обработка ошибок**: В случае возникновения ошибки при отправке запроса, информация об ошибке записывается в лог, и возвращается сообщение об ошибке.

**Атрибуты**:

*   `api_key` (str): Ключ API для доступа к OpenAI.
*   `system_instruction` (str): Системная инструкция для модели.
*   `messages` (list): Список сообщений для поддержания контекста диалога.

**Методы**:

*   `__init__(api_key: str, system_instruction: str = None)`: Инициализация класса `OpenAIChat`.
*   `ask(self, prompt: str) -> str`: Отправляет запрос в модель OpenAI и возвращает ответ.

#### `__init__(self, api_key: str, system_instruction: str = None)`

```python
    def __init__(self, api_key: str, system_instruction: str = None):
        openai.api_key = gs.credentials
        self.system_instruction = system_instruction
        self.messages = []

        if self.system_instruction:
            self.messages.append({"role": "system", "content": self.system_instruction})
```

**Назначение**: Инициализация экземпляра класса `OpenAIChat`.

**Параметры**:

*   `api_key` (str): Ключ API для доступа к OpenAI.
*   `system_instruction` (str, optional): Системная инструкция для модели. По умолчанию `None`.

**Как работает функция**:

1.  Устанавливает ключ API OpenAI, используя `gs.credentials`.
2.  Инициализирует атрибут `system_instruction` переданным значением.
3.  Инициализирует пустой список `messages` для хранения истории сообщений.
4.  Если `system_instruction` не `None`, добавляет системное сообщение в список `messages`.

#### `ask(self, prompt: str) -> str`

```python
    def ask(self, prompt: str) -> str:
        """Отправка вопроса в модель OpenAI и получение ответа"""
        self.messages.append({"role": "user", "content": prompt})

        try:
            response = openai.ChatCompletion.create(
                model="gpt-3.5-turbo",
                messages=self.messages,
                max_tokens=150,
                temperature=0.7
            )
            answer = response['choices'][0]['message']['content']
            self.messages.append({"role": "assistant", "content": answer})
            return answer
        except Exception as e:
            logger.error(f"Ошибка: {e}")
            return "Произошла ошибка при обработке запроса."
```

**Назначение**: Отправляет запрос в модель OpenAI и возвращает ответ.

**Параметры**:

*   `prompt` (str): Текст запроса, отправляемый в модель OpenAI.

**Возвращает**:

*   `str`: Ответ модели OpenAI или сообщение об ошибке в случае неудачи.

**Вызывает исключения**:

*   `Exception`: Возникает при ошибке во время отправки запроса в OpenAI.

**Как работает функция**:

1.  Добавляет сообщение пользователя в список сообщений с ролью "user".
2.  Пытается отправить запрос в OpenAI с использованием `openai.ChatCompletion.create`.
    *   Указывает модель `gpt-3.5-turbo`.
    *   Передает список сообщений `messages`.
    *   Устанавливает максимальное количество токенов `max_tokens` равным 150.
    *   Устанавливает температуру `temperature` равной 0.7.
3.  Извлекает ответ из полученного ответа.
4.  Добавляет ответ модели в список сообщений с ролью "assistant".
5.  Возвращает ответ.
6.  В случае ошибки логирует ошибку с помощью `logger.error` и возвращает сообщение об ошибке.

**Примеры**:

```python
ai = OpenAIChat(api_key='YOUR_API_KEY', system_instruction='You are a helpful assistant.')
response = ai.ask(prompt='What is the capital of France?')
print(response)
```

## Функции

### `chat()`

```python
def chat():
    print("Добро пожаловать в чат с OpenAI!")
    print("Чтобы завершить чат, напишите \'exit\'.\\n")
    
    # Ввод ключа API и инициализация модели
    api_key = input("Введите ваш OpenAI API ключ: ")
    ai = OpenAIChat(api_key=api_key, system_instruction=system_instruction)

    while True:
        # Получаем вопрос от пользователя
        user_input = input("> вопрос\\n> ")
        
        if user_input.lower() == 'exit':
            print("Чат завершен.")
            break
        
        # Отправляем запрос модели и получаем ответ
        response = ai.ask(prompt=user_input)
        
        # Выводим ответ
        print(f">> ответ\\n>> {response}\\n")
```

**Назначение**: Функция для интерактивного общения с моделью OpenAI через консоль.

**Как работает функция**:

1.  Выводит приветственное сообщение и инструкцию по завершению чата.
2.  Запрашивает у пользователя ключ API OpenAI.
3.  Инициализирует экземпляр класса `OpenAIChat` с использованием введенного ключа API и системной инструкции, загруженной из файла.
4.  Входит в бесконечный цикл, в котором:
    *   Запрашивает у пользователя вопрос.
    *   Если пользователь вводит "exit", завершает цикл.
    *   Отправляет запрос в модель OpenAI с использованием метода `ask` класса `OpenAIChat`.
    *   Выводит ответ модели.

**Примеры**:

```python
chat()
```

## Общая схема работы модуля

```
Начало
  │
  │ Загрузка системной инструкции из файла system_instruction.txt
  │
  │ Ввод API ключа пользователем
  │
  │ Создание экземпляра класса OpenAIChat
  │
  │ Цикл:
  │   │
  │   └──> Ввод вопроса пользователем
  │        │
  │        │ Проверка на команду "exit"
  │        │
  │        │ Отправка вопроса в OpenAI
  │        │
  │        │ Получение ответа от OpenAI
  │        │
  │        └──> Вывод ответа пользователю
  │
  │ Завершение
  │
Конец