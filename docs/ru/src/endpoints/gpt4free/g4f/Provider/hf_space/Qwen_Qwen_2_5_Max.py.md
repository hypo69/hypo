# Модуль `Qwen_Qwen_2_5_Max.py`

## Обзор

Модуль предоставляет асинхронный интерфейс для взаимодействия с моделью Qwen Qwen-2.5-Max через API Hugging Face Space. Он позволяет генерировать текст на основе предоставленных сообщений, поддерживая потоковую передачу ответов и системные сообщения.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для интеграции с AI-моделями, размещенными на Hugging Face Space. Он использует асинхронные запросы для взаимодействия с API и предоставляет возможность получения сгенерированного текста в режиме реального времени.

## Классы

### `Qwen_Qwen_2_5_Max`

**Описание**: Класс `Qwen_Qwen_2_5_Max` предоставляет функциональность для взаимодействия с моделью Qwen Qwen-2.5-Max.

**Принцип работы**:
Класс использует `aiohttp` для выполнения асинхронных HTTP-запросов к API Hugging Face Space. Он отправляет запросы для присоединения к очереди обработки, а затем получает данные в реальном времени через потоковый канал.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет общие методы для работы с моделями.

**Атрибуты**:
- `label` (str): Метка провайдера, отображаемая пользователю ("Qwen Qwen-2.5-Max").
- `url` (str): URL Hugging Face Space, где размещена модель ("https://qwen-qwen2-5-max-demo.hf.space").
- `api_endpoint` (str): URL API для присоединения к очереди обработки ("https://qwen-qwen2-5-max-demo.hf.space/gradio_api/queue/join?").
- `working` (bool): Флаг, указывающий на работоспособность провайдера (True).
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи ответов (True).
- `supports_system_message` (bool): Флаг, указывающий на поддержку системных сообщений (True).
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений (False).
- `default_model` (str): Модель по умолчанию ("qwen-qwen2-5-max").
- `model_aliases` (dict): Псевдонимы моделей ({"qwen-2-5-max": default_model}).
- `models` (list): Список поддерживаемых моделей.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения текста от модели.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для получения текста от модели Qwen Qwen-2.5-Max.

        Args:
            model (str): Название модели для использования.
            messages (Messages): Список сообщений для отправки модели.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, выдающий фрагменты текста.

        Raises:
            aiohttp.ClientError: При возникновении ошибок при выполнении HTTP-запросов.
            json.JSONDecodeError: При ошибках декодирования JSON.

        Внутренние функции:
            generate_session_hash(): Генерирует уникальный hash сессии для идентификации запросов.
        """
```

**Назначение**: Создает асинхронный генератор для получения текста от модели Qwen Qwen-2.5-Max.

**Параметры**:
- `cls`: Ссылка на класс `Qwen_Qwen_2_5_Max`.
- `model` (str): Название модели для использования.
- `messages` (Messages): Список сообщений для отправки модели.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий фрагменты текста.

**Вызывает исключения**:
- `aiohttp.ClientError`: При возникновении ошибок при выполнении HTTP-запросов.
- `json.JSONDecodeError`: При ошибках декодирования JSON.

**Как работает функция**:

1. **Генерация уникального идентификатора сессии**: Функция `generate_session_hash` генерирует уникальный идентификатор сессии, который используется для связи между запросами к API.
2. **Подготовка заголовков и полезной нагрузки**: Функция подготавливает заголовки HTTP-запросов и полезную нагрузку (payload) для отправки данных модели. Заголовки включают информацию о User-Agent, Accept, Referer и типе контента. Полезная нагрузка содержит текстовые данные, которые будут обработаны моделью.
3. **Отправка запроса на присоединение к очереди**: Функция отправляет POST-запрос к API-endpoint, чтобы присоединиться к очереди обработки. Ответ содержит идентификатор события, который используется для последующих запросов.
4. **Отправка запроса на получение данных в реальном времени**: Функция отправляет GET-запрос к URL-адресу потока данных, чтобы получить сгенерированный текст в режиме реального времени. Заголовки и параметры запроса содержат информацию о сессии и типе контента.
5. **Обработка потока данных**: Функция асинхронно читает данные из потока ответа, декодирует их и извлекает фрагменты сгенерированного текста. Фрагменты текста передаются через генератор, что позволяет получать текст в режиме реального времени.
6. **Обработка завершения генерации**: Функция проверяет наличие сообщения о завершении генерации и извлекает оставшуюся часть текста. Оставшаяся часть текста также передается через генератор.

```
A: Генерация уникального идентификатора сессии
│
B: Подготовка заголовков и полезной нагрузки
│
C: Отправка запроса на присоединение к очереди
│
D: Получение event_id из ответа
│
E: Отправка запроса на получение данных в реальном времени
│
F: Обработка потока данных и извлечение фрагментов текста
│
G: Проверка на завершение генерации
│
H: Извлечение оставшейся части текста (если есть)
│
I: Выдача фрагментов текста через генератор
```

**Примеры**:

```python
# Пример вызова функции create_async_generator
model_name = "qwen-2-5-max"
messages = [
    {"role": "system", "content": "You are a helpful assistant."},
    {"role": "user", "content": "What is the capital of France?"}
]

async def main():
    generator = await Qwen_Qwen_2_5_Max.create_async_generator(model=model_name, messages=messages)
    async for fragment in generator:
        print(fragment, end="")

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())
```

### `generate_session_hash`

```python
        def generate_session_hash():
            """Generate a unique session hash."""
            return str(uuid.uuid4()).replace(\'-\', \'\')[:8] + str(uuid.uuid4()).replace(\'-\', \'\')[:4]
```

**Назначение**: Генерирует уникальный hash сессии для идентификации запросов.

**Как работает функция**:
1. Генерирует UUID (Universally Unique Identifier) с помощью `uuid.uuid4()`.
2. Удаляет дефисы из UUID, заменяя их пустой строкой с помощью `.replace('-', '')`.
3. Извлекает первые 8 символов из первого UUID и первые 4 символа из второго UUID.
4. Объединяет эти 12 символов в строку, которая и является hash сессии.

**Примеры**:

```python
session_hash = generate_session_hash()
print(session_hash)