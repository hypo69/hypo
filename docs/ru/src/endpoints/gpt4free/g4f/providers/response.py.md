# Модуль для обработки ответов от GPT4Free

## Обзор

Этот модуль содержит классы и функции для обработки различных типов ответов, возвращаемых провайдерами GPT4Free. Он включает в себя форматирование URL-адресов, создание markdown-ссылок и изображений, а также определение классов для представления различных типов ответов, таких как JSON, скрытые ответы, результаты аутентификации, источники и другие.

## Подробней

Модуль предоставляет инструменты для нормализации и форматирования данных, полученных от различных источников, чтобы обеспечить единообразное представление информации для дальнейшей обработки и отображения. Он также включает классы для обработки специфических типов ответов, таких как аудио, видео и изображения, а также для управления метаданными, такими как источники и параметры.

## Функции

### `quote_url`

```python
def quote_url(url: str) -> str:
    """
    Экранирует части URL, сохраняя структуру домена.

    Args:
        url (str): URL для экранирования.

    Returns:
        str: Правильно экранированный URL.
    """
```

**Назначение**: Экранирует части URL-адреса, сохраняя структуру домена. Это необходимо для правильной обработки URL-адресов, содержащих специальные символы.

**Параметры**:
- `url` (str): URL для экранирования.

**Возвращает**:
- `str`: Правильно экранированный URL.

**Как работает функция**:
1. Проверяет, содержит ли URL символы `%`, чтобы избежать двойного экранирования.
2. Разбивает URL на части, разделенные `//`, чтобы разделить протокол и остальную часть URL.
3. Если в URL нет `//`, то это относительный URL, и он экранируется целиком.
4. Если в URL есть `//`, то разделяет остальную часть на домен и путь.
5. Если после домена нет `/`, то это URL домена, и он возвращается без изменений.
6. Если после домена есть `/`, то экранирует путь и возвращает полный URL с экранированным путем.

```
A: Проверка наличия '%' в URL
|
B: Разбиение URL на протокол и остальную часть
|
C: Проверка наличия '//' в URL
|
D: Экранирование относительного URL (если нет '//')
|
E: Разбиение остальной части на домен и путь (если есть '//')
|
F: Проверка наличия '/' после домена
|
G: Возврат URL домена (если нет '/')
|
H: Экранирование пути и возврат полного URL (если есть '/')
```

**Примеры**:

```python
>>> quote_url("https://example.com/path with spaces?query=value")
'https://example.com/path%20with%20spaces?query=value'
>>> quote_url("example.com/path")
'example.com%2Fpath'
```

### `quote_title`

```python
def quote_title(title: str) -> str:
    """
    Нормализует пробелы в заголовке.

    Args:
        title (str): Заголовок для нормализации.

    Returns:
        str: Заголовок с нормализованными пробелами.
    """
```

**Назначение**: Нормализует пробелы в заголовке, заменяя множественные пробелы на один и удаляя пробелы в начале и конце строки.

**Параметры**:
- `title` (str): Заголовок для нормализации.

**Возвращает**:
- `str`: Заголовок с нормализованными пробелами.

**Как работает функция**:
1. Разбивает заголовок на слова, используя пробелы в качестве разделителя.
2. Объединяет слова обратно в строку, разделяя их одним пробелом.
3. Возвращает полученную строку.

```
A: Разбиение заголовка на слова
|
B: Объединение слов обратно в строку с одним пробелом между ними
|
C: Возврат нормализованного заголовка
```

**Примеры**:

```python
>>> quote_title("  Title  with   multiple   spaces  ")
'Title with multiple spaces'
>>> quote_title("")
''
```

### `format_link`

```python
def format_link(url: str, title: Optional[str] = None) -> str:
    """
    Форматирует URL и заголовок как markdown-ссылку.

    Args:
        url (str): URL для создания ссылки.
        title (Optional[str], optional): Заголовок для отображения. Если `None`, извлекается из URL.

    Returns:
        str: Отформатированная markdown-ссылка.
    """
```

**Назначение**: Форматирует URL и заголовок как markdown-ссылку. Если заголовок не указан, он пытается извлечь его из URL.

**Параметры**:
- `url` (str): URL для создания ссылки.
- `title` (Optional[str], optional): Заголовок для отображения. Если `None`, извлекается из URL.

**Возвращает**:
- `str`: Отформатированная markdown-ссылка.

**Как работает функция**:
1. Если заголовок не указан, пытается извлечь его из URL.
2. Экранирует URL и нормализует заголовок.
3. Возвращает markdown-ссылку в формате `[title](url)`.

```
A: Проверка наличия заголовка
|
B: Извлечение заголовка из URL (если нет заголовка)
|
C: Экранирование URL и нормализация заголовка
|
D: Форматирование markdown-ссылки
```

**Примеры**:

```python
>>> format_link("https://example.com", "Example")
'[Example](https://example.com)'
>>> format_link("https://example.com/path?title=Example")
'[example.com/path?title=Example](https://example.com/path?title=Example)'
```

### `format_image`

```python
def format_image(image: str, alt: str, preview: Optional[str] = None) -> str:
    """
    Форматирует данное изображение как markdown-строку.

    Args:
        image (str): Изображение для форматирования.
        alt (str): Альтернативный текст для изображения.
        preview (Optional[str], optional): URL для предварительного просмотра. По умолчанию используется оригинальное изображение.

    Returns:
        str: Отформатированная markdown-строка.
    """
```

**Назначение**: Форматирует изображение как markdown-строку, используя альтернативный текст и URL для предварительного просмотра (если указан).

**Параметры**:
- `image` (str): Изображение для форматирования.
- `alt` (str): Альтернативный текст для изображения.
- `preview` (Optional[str], optional): URL для предварительного просмотра. По умолчанию используется оригинальное изображение.

**Возвращает**:
- `str`: Отформатированная markdown-строка.

**Как работает функция**:
1. Если указан URL для предварительного просмотра, заменяет `{image}` в URL на URL изображения.
2. Экранирует URL для предварительного просмотра и URL изображения.
3. Возвращает markdown-строку в формате `[![alt](preview)](image)`.

```
A: Проверка наличия URL для предварительного просмотра
|
B: Замена '{image}' в URL для предварительного просмотра на URL изображения (если есть URL для предварительного просмотра)
|
C: Экранирование URL для предварительного просмотра и URL изображения
|
D: Форматирование markdown-строки
```

**Примеры**:

```python
>>> format_image("https://example.com/image.jpg", "Example Image")
'![Example Image](https://example.com/image.jpg)'
>>> format_image("https://example.com/image.jpg", "Example Image", "https://example.com/preview/{image}")
'![Example Image](https://example.com/preview/https%3A//example.com/image.jpg)'
```

### `format_images_markdown`

```python
def format_images_markdown(images: Union[str, List[str]], alt: str,
                           preview: Union[str, List[str]] = None) -> str:
    """
    Форматирует данные изображения как markdown-строку.

    Args:
        images (Union[str, List[str]]): Изображение или список изображений для форматирования.
        alt (str): Альтернативный текст для изображений.
        preview (Union[str, List[str]], optional): URL или список URL для предварительного просмотра.
            Если не предоставлен, используются оригинальные изображения.

    Returns:
        str: Отформатированная markdown-строка.
    """
```

**Назначение**: Форматирует одно или несколько изображений в виде markdown-строки. Поддерживает как отдельные изображения, так и списки изображений, а также URL-ы для предварительного просмотра.

**Параметры**:
- `images` (Union[str, List[str]]): Изображение или список изображений для форматирования.
- `alt` (str): Альтернативный текст для изображений.
- `preview` (Union[str, List[str]], optional): URL или список URL для предварительного просмотра. Если не указан, используются оригинальные изображения.

**Возвращает**:
- `str`: Отформатированная markdown-строка.

**Как работает функция**:
1. Если `images` - список из одного элемента, преобразует его в строку.
2. Если `images` - строка, форматирует ее как одно изображение с помощью `format_image`.
3. Если `images` - список, форматирует каждое изображение в списке с помощью `format_image` и объединяет результаты с помощью `\n`.
4. Оборачивает результат флагами `<!-- generated images start -->` и `<!-- generated images end -->`.

```
A: Проверка, является ли images списком из одного элемента
|
B: Преобразование images в строку, если это список из одного элемента
|
C: Проверка, является ли images строкой
|
D: Форматирование images как одного изображения (если это строка)
|
E: Форматирование каждого изображения в списке (если это список)
|
F: Объединение отформатированных изображений с помощью '\n'
|
G: Оборачивание результата флагами
```

**Примеры**:

```python
>>> format_images_markdown("https://example.com/image.jpg", "Example Image")
'\n<!-- generated images start -->\n![Example Image](https://example.com/image.jpg)\n<!-- generated images end -->\n'
>>> format_images_markdown(["https://example.com/image1.jpg", "https://example.com/image2.jpg"], "Example Image")
'\n<!-- generated images start -->\n![#1 Example Image](https://example.com/image1.jpg)\\n![#2 Example Image](https://example.com/image2.jpg)\n<!-- generated images end -->\n'
```

## Классы

### `ResponseType`

```python
class ResponseType:
    """
    Базовый класс для всех типов ответов.
    """
```

**Описание**: Абстрактный базовый класс для всех типов ответов. Определяет абстрактный метод `__str__`, который должен быть реализован в подклассах.

**Методы**:
- `__str__`: Абстрактный метод, который должен возвращать строковое представление ответа.

### `JsonMixin`

```python
class JsonMixin:
    """
    Миксин для классов, которые могут быть представлены в формате JSON.
    """
```

**Описание**: Миксин, предоставляющий методы для работы с атрибутами класса как с JSON-объектом.

**Методы**:
- `__init__`: Инициализирует класс с использованием переданных ключевых аргументов в качестве атрибутов.
- `get_dict`: Возвращает словарь, содержащий все не-приватные атрибуты класса.
- `reset`: Сбрасывает все атрибуты класса.

### `RawResponse`

```python
class RawResponse(ResponseType, JsonMixin):
    """
    Представляет необработанный ответ.

    Inherits:
        ResponseType: Базовый класс для всех типов ответов.
        JsonMixin: Миксин для классов, которые могут быть представлены в формате JSON.
    """
```

**Описание**: Класс, представляющий необработанный ответ. Наследуется от `ResponseType` и `JsonMixin`.

### `HiddenResponse`

```python
class HiddenResponse(ResponseType):
    """
    Представляет скрытый ответ, который не должен отображаться.

    Inherits:
        ResponseType: Базовый класс для всех типов ответов.
    """
```

**Описание**: Класс, представляющий скрытый ответ, который не должен отображаться. Наследуется от `ResponseType`.

**Методы**:
- `__str__`: Возвращает пустую строку.

### `FinishReason`

```python
class FinishReason(JsonMixin, HiddenResponse):
    """
    Представляет причину завершения работы.

    Inherits:
        JsonMixin: Миксин для классов, которые могут быть представлены в формате JSON.
        HiddenResponse: Базовый класс для скрытых ответов.
    """
```

**Описание**: Класс, представляющий причину завершения работы. Наследуется от `JsonMixin` и `HiddenResponse`.

**Методы**:
- `__init__`: Инициализирует класс с указанием причины завершения.

### `ToolCalls`

```python
class ToolCalls(HiddenResponse):
    """
    Представляет список вызовов инструментов.

    Inherits:
        HiddenResponse: Базовый класс для скрытых ответов.
    """
```

**Описание**: Класс, представляющий список вызовов инструментов. Наследуется от `HiddenResponse`.

**Методы**:
- `__init__`: Инициализирует класс со списком вызовов инструментов.
- `get_list`: Возвращает список вызовов инструментов.

### `Usage`

```python
class Usage(JsonMixin, HiddenResponse):
    """
    Представляет информацию об использовании ресурсов.

    Inherits:
        JsonMixin: Миксин для классов, которые могут быть представлены в формате JSON.
        HiddenResponse: Базовый класс для скрытых ответов.
    """
```

**Описание**: Класс, представляющий информацию об использовании ресурсов. Наследуется от `JsonMixin` и `HiddenResponse`.

### `AuthResult`

```python
class AuthResult(JsonMixin, HiddenResponse):
    """
    Представляет результат аутентификации.

    Inherits:
        JsonMixin: Миксин для классов, которые могут быть представлены в формате JSON.
        HiddenResponse: Базовый класс для скрытых ответов.
    """
```

**Описание**: Класс, представляющий результат аутентификации. Наследуется от `JsonMixin` и `HiddenResponse`.

### `TitleGeneration`

```python
class TitleGeneration(HiddenResponse):
    """
    Представляет сгенерированный заголовок.

    Inherits:
        HiddenResponse: Базовый класс для скрытых ответов.
    """
```

**Описание**: Класс, представляющий сгенерированный заголовок. Наследуется от `HiddenResponse`.

**Методы**:
- `__init__`: Инициализирует класс с указанием сгенерированного заголовка.

### `DebugResponse`

```python
class DebugResponse(HiddenResponse):
    """
    Представляет отладочный ответ.

    Inherits:
        HiddenResponse: Базовый класс для скрытых ответов.
    """
```

**Описание**: Класс, представляющий отладочный ответ. Наследуется от `HiddenResponse`.

**Методы**:
- `__init__`: Инициализирует класс с отладочным сообщением.

### `Reasoning`

```python
class Reasoning(ResponseType):
    """
    Представляет ход рассуждений.

    Inherits:
        ResponseType: Базовый класс для всех типов ответов.
    """
```

**Описание**: Класс, представляющий ход рассуждений. Наследуется от `ResponseType`.

**Методы**:
- `__init__`: Инициализирует класс с указанием токена, статуса и состояния размышления.
- `__str__`: Возвращает строковое представление на основе доступных атрибутов.
- `__eq__`: Сравнивает два объекта `Reasoning` на равенство.
- `get_dict`: Возвращает словарь, содержащий атрибуты объекта.

### `Sources`

```python
class Sources(ResponseType):
    """
    Представляет список источников.

    Inherits:
        ResponseType: Базовый класс для всех типов ответов.
    """
```

**Описание**: Класс, представляющий список источников. Наследуется от `ResponseType`.

**Методы**:
- `__init__`: Инициализирует класс списком словарей с источниками.
- `add_source`: Добавляет источник в список, очищая URL при необходимости.
- `__str__`: Возвращает отформатированные источники в виде строки.

### `YouTube`

```python
class YouTube(HiddenResponse):
    """
    Представляет список идентификаторов YouTube-видео.

    Inherits:
        HiddenResponse: Базовый класс для скрытых ответов.
    """
```

**Описание**: Класс, представляющий список идентификаторов YouTube-видео. Наследуется от `HiddenResponse`.

**Методы**:
- `__init__`: Инициализирует класс списком идентификаторов YouTube-видео.
- `to_string`: Возвращает HTML-код для встраивания видео YouTube.

### `AudioResponse`

```python
class AudioResponse(ResponseType):
    """
    Представляет аудио-ответ.

    Inherits:
        ResponseType: Базовый класс для всех типов ответов.
    """
```

**Описание**: Класс, представляющий аудио-ответ. Наследуется от `ResponseType`.

**Методы**:
- `__init__`: Инициализирует класс с аудиоданными в виде байтов.
- `to_uri`: Возвращает аудиоданные в виде URI данных в формате base64.
- `__str__`: Возвращает аудио в виде HTML-элемента.

### `BaseConversation`

```python
class BaseConversation(ResponseType):
    """
    Базовый класс для всех типов бесед.

    Inherits:
        ResponseType: Базовый класс для всех типов ответов.
    """
```

**Описание**: Базовый класс для всех типов бесед. Наследуется от `ResponseType`.

**Методы**:
- `__str__`: Возвращает пустую строку по умолчанию.

### `JsonConversation`

```python
class JsonConversation(BaseConversation, JsonMixin):
    """
    Представляет беседу в формате JSON.

    Inherits:
        BaseConversation: Базовый класс для всех типов бесед.
        JsonMixin: Миксин для классов, которые могут быть представлены в формате JSON.
    """
```

**Описание**: Класс, представляющий беседу в формате JSON. Наследуется от `BaseConversation` и `JsonMixin`.

### `SynthesizeData`

```python
class SynthesizeData(HiddenResponse, JsonMixin):
    """
    Представляет данные для синтеза.

    Inherits:
        HiddenResponse: Базовый класс для скрытых ответов.
        JsonMixin: Миксин для классов, которые могут быть представлены в формате JSON.
    """
```

**Описание**: Класс, представляющий данные для синтеза. Наследуется от `HiddenResponse` и `JsonMixin`.

**Методы**:
- `__init__`: Инициализирует класс с указанием провайдера и данных.

### `SuggestedFollowups`

```python
class SuggestedFollowups(HiddenResponse):
    """
    Представляет предложенные варианты продолжения беседы.

    Inherits:
        HiddenResponse: Базовый класс для скрытых ответов.
    """
```

**Описание**: Класс, представляющий предложенные варианты продолжения беседы. Наследуется от `HiddenResponse`.

### `RequestLogin`

```python
class RequestLogin(HiddenResponse):
    """
    Представляет запрос на вход в систему.

    Inherits:
        HiddenResponse: Базовый класс для скрытых ответов.
    """
```

**Описание**: Класс, представляющий запрос на вход в систему. Наследуется от `HiddenResponse`.

**Методы**:
- `__init__`: Инициализирует класс с указанием метки и URL для входа.
- `to_string`: Возвращает отформатированную ссылку для входа в систему в виде строки.

### `MediaResponse`

```python
class MediaResponse(ResponseType):
    """
    Базовый класс для ответов, содержащих медиафайлы (изображения, видео и т.д.).

    Inherits:
        ResponseType: Базовый класс для всех типов ответов.
    """
```

**Описание**: Базовый класс для ответов, содержащих медиафайлы (изображения, видео и т.д.). Наследуется от `ResponseType`.

**Методы**:
- `__init__`: Инициализирует класс с URL-ами, альтернативным текстом и опциями.
- `get`: Возвращает значение опции по ключу.
- `get_list`: Возвращает URL-ы в виде списка.

### `ImageResponse`

```python
class ImageResponse(MediaResponse):
    """
    Представляет ответ с изображением.

    Inherits:
        MediaResponse: Базовый класс для ответов, содержащих медиафайлы.
    """
```

**Описание**: Класс, представляющий ответ с изображением. Наследуется от `MediaResponse`.

**Методы**:
- `__str__`: Возвращает изображения в виде markdown.

### `VideoResponse`

```python
class VideoResponse(MediaResponse):
    """
    Представляет ответ с видео.

    Inherits:
        MediaResponse: Базовый класс для ответов, содержащих медиафайлы.
    """
```

**Описание**: Класс, представляющий ответ с видео. Наследуется от `MediaResponse`.

**Методы**:
- `__str__`: Возвращает видео в виде HTML-элементов.

### `ImagePreview`

```python
class ImagePreview(ImageResponse):
    """
    Представляет превью изображения.

    Inherits:
        ImageResponse: Базовый класс для ответов с изображениями.
    """
```

**Описание**: Класс, представляющий превью изображения. Наследуется от `ImageResponse`.

**Методы**:
- `__str__`: Возвращает пустую строку для превью.
- `to_string`: Возвращает изображения в виде markdown.

### `PreviewResponse`

```python
class PreviewResponse(HiddenResponse):
    """
    Представляет превью ответа.

    Inherits:
        HiddenResponse: Базовый класс для скрытых ответов.
    """
```

**Описание**: Класс, представляющий превью ответа. Наследуется от `HiddenResponse`.

**Методы**:
- `__init__`: Инициализирует класс с данными превью.
- `to_string`: Возвращает данные превью в виде строки.

### `Parameters`

```python
class Parameters(ResponseType, JsonMixin):
    """
    Представляет параметры ответа.

    Inherits:
        ResponseType: Базовый класс для всех типов ответов.
        JsonMixin: Миксин для классов, которые могут быть представлены в формате JSON.
    """
```

**Описание**: Класс, представляющий параметры ответа. Наследуется от `ResponseType` и `JsonMixin`.

**Методы**:
- `__str__`: Возвращает пустую строку.

### `ProviderInfo`

```python
class ProviderInfo(JsonMixin, HiddenResponse):
    """
    Представляет информацию о провайдере.

    Inherits:
        JsonMixin: Миксин для классов, которые могут быть представлены в формате JSON.
        HiddenResponse: Базовый класс для скрытых ответов.
    """
```

**Описание**: Класс, представляющий информацию о провайдере. Наследуется от `JsonMixin` и `HiddenResponse`.