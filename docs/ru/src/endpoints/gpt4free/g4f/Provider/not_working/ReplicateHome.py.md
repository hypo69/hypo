# Модуль `ReplicateHome`

## Обзор

Модуль `ReplicateHome` предназначен для взаимодействия с платформой Replicate для генерации текста и изображений. Он предоставляет асинхронный генератор, который позволяет получать результаты по частям, что особенно полезно для больших текстовых ответов и изображений. Модуль поддерживает различные модели, включая `google-deepmind/gemma-2b-it` для текста и `stability-ai/stable-diffusion-3` для изображений.

## Подробней

Модуль `ReplicateHome` асинхронно взаимодействует с API Replicate для выполнения задач генерации текста и изображений. Он использует `aiohttp` для выполнения HTTP-запросов и предоставляет методы для форматирования запросов, обработки ответов и обработки ошибок. Модуль поддерживает потоковую передачу результатов, что позволяет клиентам получать частичные результаты по мере их генерации.
`ReplicateHome` является асинхронным провайдером, взаимодействующим с сервисом Replicate.com для генерации как текста, так и изображений. Он использует `aiohttp` для выполнения асинхронных HTTP-запросов и реализует логику опроса API для получения результатов генерации.
Модуль предназначен для интеграции в систему, требующую взаимодействия с моделями машинного обучения, размещенными на Replicate.com.

## Классы

### `ReplicateHome`

**Описание**: Класс `ReplicateHome` является асинхронным провайдером для взаимодействия с API Replicate.

**Принцип работы**:
Класс использует асинхронные запросы для отправки запросов к API Replicate и получения результатов. Он поддерживает как текстовые, так и графические модели.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию результатов.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями.

**Атрибуты**:
- `url` (str): URL платформы Replicate (`https://replicate.com`).
- `api_endpoint` (str): URL API для создания предсказаний (`https://homepage.replicate.com/api/prediction`).
- `working` (bool): Указывает, работает ли провайдер (по умолчанию `False`).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу (по умолчанию `True`).
- `default_model` (str): Модель, используемая по умолчанию (`google-deepmind/gemma-2b-it`).
- `default_image_model` (str): Модель для генерации изображений по умолчанию (`stability-ai/stable-diffusion-3`).
- `image_models` (list): Список поддерживаемых моделей для генерации изображений.
- `text_models` (list): Список поддерживаемых моделей для генерации текста.
- `models` (list): Объединение списков `text_models` и `image_models`.
- `model_aliases` (dict): Словарь псевдонимов моделей для удобства использования.
- `model_versions` (dict): Словарь версий моделей, используемых для запросов к API.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения результатов от API Replicate.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    prompt: str = None,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения результатов от API Replicate.

    Args:
        cls (ReplicateHome): Класс `ReplicateHome`.
        model (str): Название модели для использования.
        messages (Messages): Список сообщений для форматирования запроса.
        prompt (str, optional): Текст запроса. Если не указан, формируется автоматически. По умолчанию `None`.
        proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий результаты от API Replicate.

    Raises:
        Exception: Если предсказание не удалось или истекло время ожидания.

    """
```

**Назначение**:
Функция `create_async_generator` создает и возвращает асинхронный генератор, который взаимодействует с API Replicate для генерации текста или изображений на основе предоставленных параметров.

**Параметры**:
- `cls` (ReplicateHome): Класс `ReplicateHome`.
- `model` (str): Имя модели, которую нужно использовать для генерации.
- `messages` (Messages): Список сообщений, используемых для формирования запроса.
- `prompt` (str, optional): Необязательный параметр, содержащий текст запроса. Если не указан, формируется автоматически. По умолчанию `None`.
- `proxy` (str, optional): Необязательный параметр, содержащий адрес прокси-сервера для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API Replicate.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который предоставляет результаты генерации текста или изображения.

**Вызывает исключения**:
- `Exception`: Вызывается, если предсказание не удалось (`failed`) или истекло время ожидания (`timed out`).

**Как работает функция**:

1. **Определение модели**: Определяет, какую модель использовать, проверяя псевдонимы и приводя к полному имени.
2. **Формирование заголовков**: Создает заголовки HTTP-запроса, необходимые для взаимодействия с API Replicate.
3. **Создание сессии**: Инициализирует асинхронную сессию `aiohttp` с заданными заголовками и прокси-сервером (если указан).
4. **Формирование запроса**: Если `prompt` не указан, формирует его на основе `messages`. Для моделей изображений берет последний элемент `messages` как запрос.
5. **Подготовка данных**: Создает словарь `data` с параметрами модели, версии и запросом.
6. **Отправка запроса**: Отправляет POST-запрос к `api_endpoint` с данными и заголовками.
7. **Получение ID предсказания**: Извлекает `id` предсказания из ответа.
8. **Опрос API**: Циклически опрашивает API Replicate, используя `poll_url`, чтобы получить статус предсказания.
9. **Обработка результатов**:
   - Если статус `succeeded`:
     - Для моделей изображений возвращает URL изображения через `ImageResponse`.
     - Для текстовых моделей возвращает текст по частям через `yield`.
   - Если статус `failed`: вызывает исключение с сообщением об ошибке.
10. **Обработка таймаута**: Если после `max_attempts` статус не `succeeded`, вызывает исключение о таймауте.

**Внутренние функции**:
Внутри функции `create_async_generator` не определены внутренние функции.

**ASCII flowchart**:

```
    Определение модели и версий
    │
    │
    V
    Создание заголовков HTTP
    │
    │
    V
    Создание асинхронной сессии aiohttp
    │
    │
    V
    Формирование тела запроса (prompt)
    │
    │
    V
    Отправка POST запроса к API Replicate
    │
    │
    V
    Получение ID предсказания
    │
    │
    V
    Циклический опрос API для получения статуса
    │
    ├── Статус "succeeded" ───────────────────────────────
    │   │
    │   V
    │   Обработка результата (текст или изображение)
    │   │
    │   V
    │   Возврат результата через yield
    │
    └── Статус "failed" ──────────────────────────────────
        │
        V
        Выброс исключения с сообщением об ошибке
    │
    V
    Обработка таймаута, если статус не "succeeded"
```

**Примеры**:

1. **Генерация текста**:

```python
model_name = "gemma-2b"
messages = [{"role": "user", "content": "Напиши короткое стихотворение о весне."}]
async for chunk in ReplicateHome.create_async_generator(model=model_name, messages=messages):
    print(chunk, end="")
```

2. **Генерация изображения**:

```python
model_name = "sd-3"
messages = [{"role": "user", "content": "A beautiful landscape with mountains and a lake."}]
async for image_response in ReplicateHome.create_async_generator(model=model_name, messages=messages):
    print(image_response.image_url)