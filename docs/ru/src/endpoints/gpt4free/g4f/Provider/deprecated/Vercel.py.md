# Модуль для работы с Vercel API для g4f

## Обзор

Модуль предоставляет класс `Vercel`, который является провайдером для взаимодействия с API Vercel. Он позволяет создавать завершения текста, используя различные модели, поддерживаемые Vercel. Модуль также включает функции для получения anti-bot токена, необходимого для аутентификации запросов.

## Подробнее

Этот модуль является частью системы `g4f` в проекте `hypotez` и предназначен для обеспечения доступа к API Vercel для генерации текста. Он обрабатывает запросы к Vercel, получает ответы и возвращает результаты. В модуле реализована поддержка стриминга, что позволяет получать ответы в режиме реального времени. Для работы модуля требуется установка пакета `PyExecJS`, который используется для выполнения JavaScript-кода.

## Классы

### `Vercel`

**Описание**: Класс `Vercel` является провайдером для взаимодействия с API Vercel.

**Наследует**:
- `AbstractProvider`

**Аттрибуты**:
- `url` (str): URL API Vercel.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `supports_message_history` (bool): Флаг, указывающий, поддерживает ли провайдер историю сообщений.
- `supports_gpt_35_turbo` (bool): Флаг, указывающий, поддерживает ли провайдер модель `gpt-3.5-turbo`.
- `supports_stream` (bool): Флаг, указывающий, поддерживает ли провайдер стриминг.

**Методы**:
- `create_completion()`: Создает завершение текста, используя API Vercel.

### `ModelInfo`

**Описание**: `ModelInfo` - это `TypedDict`, который определяет структуру данных для информации о модели.

**Аттрибуты**:
- `id` (str): Идентификатор модели.
- `default_params` (dict[str, Any]): Параметры по умолчанию для модели.

## Функции

### `create_completion`

```python
@staticmethod
def create_completion(
    model: str,
    messages: Messages,
    stream: bool,
    proxy: str = None,
    **kwargs
) -> CreateResult:
    """Создает завершение текста, используя API Vercel.

    Args:
        model (str): Идентификатор модели для использования.
        messages (Messages): Список сообщений для передачи в модель.
        stream (bool): Флаг, указывающий, следует ли использовать стриминг.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы для передачи в API Vercel.

    Returns:
        CreateResult: Результат завершения текста.

    Raises:
        MissingRequirementsError: Если не установлен пакет `PyExecJS`.
        ValueError: Если указанная модель не поддерживается Vercel.

    Example:
        Примеры вызовов со всем спектром параметров. которы можно передать в функцию
        >>> Vercel.create_completion(model='gpt-3.5-turbo', messages=[{'role': 'user', 'content': 'Hello'}], stream=False)
        <generator object Vercel.create_completion at 0x...>
    """
    ...
```

**Назначение**: Создает запрос к API Vercel для генерации текста на основе предоставленных параметров и возвращает результат.

**Параметры**:
- `model` (str): Идентификатор модели, которую следует использовать для генерации текста.
- `messages` (Messages): Список сообщений, служащих контекстом для генерации текста.
- `stream` (bool): Определяет, использовать ли потоковую передачу данных для получения результата.
- `proxy` (str, optional): Адрес прокси-сервера для использования при выполнении запроса. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API Vercel.

**Возвращает**:
- `CreateResult`: Результат генерации текста.

**Вызывает исключения**:
- `MissingRequirementsError`: Если отсутствует необходимый пакет `PyExecJS`.
- `ValueError`: Если указанная модель не поддерживается Vercel.

**Как работает функция**:

1. Проверяет, установлен ли пакет `PyExecJS`. Если нет, вызывает исключение `MissingRequirementsError`.
2. Если модель не указана, устанавливает значение по умолчанию `gpt-3.5-turbo`. Если модель не найдена в списке поддерживаемых, вызывает исключение `ValueError`.
3. Формирует заголовки запроса, включая anti-bot токен.
4. Создает JSON-данные для запроса, включая модель, сообщения и дополнительные параметры.
5. Выполняет POST-запрос к API Vercel с использованием `requests.post`.
6. В цикле пытается выполнить запрос `max_retries` раз. Если запрос успешен, возвращает результат. Если происходит ошибка, продолжает попытки.
7. Итерируется по содержимому ответа, декодирует каждый токен и возвращает его с помощью `yield`.

**Внутренние функции**: Нет

**Примеры**:

```python
>>> Vercel.create_completion(model='gpt-3.5-turbo', messages=[{'role': 'user', 'content': 'Hello'}], stream=False)
<generator object Vercel.create_completion at 0x...>

>>> Vercel.create_completion(model='gpt-3.5-turbo', messages=[{'role': 'user', 'content': 'Translate to french: Hello'}], stream=True, proxy='http://proxy.example.com')
<generator object Vercel.create_completion at 0x...>
```

### `get_anti_bot_token`

```python
def get_anti_bot_token() -> str:
    """Получает anti-bot токен, необходимый для аутентификации запросов.

    Returns:
        str: Anti-bot токен.
    """
    ...
```

**Назначение**: Функция `get_anti_bot_token` получает anti-bot токен, который необходим для аутентификации запросов к API Vercel.

**Параметры**:
- Нет

**Возвращает**:
- `str`: Anti-bot токен.

**Вызывает исключения**:
- Нет

**Как работает функция**:

1. Формирует заголовки запроса.
2. Выполняет GET-запрос к `https://sdk.vercel.ai/openai.jpeg` для получения данных anti-bot защиты.
3. Декодирует полученные данные из base64.
4. Формирует JavaScript-скрипт для получения токена.
5. Выполняет JavaScript-скрипт с использованием `execjs`.
6. Формирует JSON-данные с токеном.
7. Кодирует JSON-данные в base64 и возвращает результат.

```
Получение anti-bot токена
│
├── Запрос к API Vercel для получения anti-bot защиты
│   │
│   └── Декодирование данных из Base64
│       │
│       └── Формирование JS скрипта
│           │
│           └── Выполнение JS скрипта с помощью execjs
│               │
│               └── Формирование JSON с токеном
│                   │
│                   └── Кодирование JSON в Base64 и возврат токена
│
```

**Примеры**:

```python
>>> get_anti_bot_token()
'eyJ0IjogMTY5ODU2MzIwMCwgInIiOiAiNDJmMzQ1NjAwM2U4YTIwMzUifQ=='
```

### `model_info`

**Описание**: Словарь, содержащий информацию о поддерживаемых моделях Vercel. Ключами словаря являются идентификаторы моделей, а значениями - объекты `ModelInfo`, содержащие идентификатор модели и параметры по умолчанию.

```python
model_info: dict[str, ModelInfo] = {
    # ...
}