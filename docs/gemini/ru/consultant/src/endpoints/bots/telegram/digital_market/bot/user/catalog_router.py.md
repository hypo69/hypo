### –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –º–æ–¥—É–ª—è `catalog_router`

**–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞**:
- **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º**: 7/10
- **–ü–ª—é—Å—ã**:
    - –ö–æ–¥ —Ä–∞–∑–±–∏—Ç –Ω–∞ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–ª–æ–∫–∏, —á—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç –µ–≥–æ –ø–æ–Ω–∏–º–∞–Ω–∏–µ.
    - –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.
    - –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è `aiogram` –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∫–æ–ª–±–µ–∫–æ–≤ –æ—Ç Telegram.
- **–ú–∏–Ω—É—Å—ã**:
    - –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –±–ª–æ–∫–∏ `try-except` –∏–∑–ª–∏—à–Ω–∏, –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫.
    - –ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ RST –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–π –∏ –º–æ–¥—É–ª—è.
    - –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∏–º–ø–æ—Ä—Ç `logger` –∏–∑ `src.logger`.
    - –ù–µ –≤–µ–∑–¥–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤ –∫–æ–¥–µ, –∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –≤ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
    - –ù–µ –≤—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–º–µ—é—Ç –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é**:

- –î–æ–±–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ RST –¥–ª—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏ –º–æ–¥—É–ª—è.
- –ó–∞–º–µ–Ω–∏—Ç—å `try-except` –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ —á–µ—Ä–µ–∑ `logger.error`.
- –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å `logger` –∏–∑ `src.logger`.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤–µ–∑–¥–µ, –≥–¥–µ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ, —Å–æ–≥–ª–∞—Å–Ω–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏.
- –í—ã—Ä–æ–≤–Ω—è—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∏ –∏–º–ø–æ—Ä—Ç–æ–≤ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º–∏ PEP8.
- –£–ª—É—á—à–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞, —á—Ç–æ–±—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å PEP8.
- –í —Ñ—É–Ω–∫—Ü–∏–∏ `send_stars_invoice` `provider_token` –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å, –µ—Å–ª–∏ –æ–Ω –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –ª–∏–±–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π, —á—Ç–æ —Ç–æ–∫–µ–Ω –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.
- –í —Ñ—É–Ω–∫—Ü–∏–∏ `successful_payment` –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º—ã–π —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è `price` –∏ `currency`, –Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ —Ç–µ—Ä–Ω–∞—Ä–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é.

**–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥**:

```python
"""
–ú–æ–¥—É–ª—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ Telegram –±–æ—Ç–µ.
=====================================================

–ú–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ callback-–∑–∞–ø—Ä–æ—Å–æ–≤ –∏ —Å–æ–æ–±—â–µ–Ω–∏–π, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å –∫–∞—Ç–∞–ª–æ–≥–æ–º —Ç–æ–≤–∞—Ä–æ–≤,
–≤–∫–ª—é—á–∞—è –ø—Ä–æ—Å–º–æ—Ç—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–π, —Ç–æ–≤–∞—Ä–æ–≤ –∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã.

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
--------------------

.. code-block:: python

    from aiogram import Dispatcher
    from src.endpoints.bots.telegram.digital_market.bot.user.catalog_router import catalog_router

    dp = Dispatcher()
    dp.include_router(catalog_router)
"""
from aiogram import Router, F
from aiogram.enums import ContentType
from aiogram.types import Message, CallbackQuery, LabeledPrice, PreCheckoutQuery
from sqlalchemy.ext.asyncio import AsyncSession

from src.logger import logger  # –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º logger
from bot.app.utils import generate_payment_link
from bot.config import bot, settings
from bot.dao.dao import UserDAO, CategoryDao, ProductDao, PurchaseDao
from bot.user.kbs import catalog_kb, product_kb, get_product_buy_youkassa, \
    get_product_buy_stars, get_product_buy_robocassa
from bot.user.schemas import TelegramIDModel, ProductCategoryIDModel, PaymentData
from bot.user.utils import successful_payment_logic

catalog_router = Router()


@catalog_router.callback_query(F.data == 'catalog')
async def page_catalog(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback-–∑–∞–ø—Ä–æ—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :param session_without_commit: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è SQLAlchemy –±–µ–∑ –∫–æ–º–º–∏—Ç–∞.
    :type session_without_commit: AsyncSession
    """
    await call.answer('–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞...')
    try:
        await call.message.delete()  # —É–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    except Exception as e:
        logger.error(f'Error deleting message: {e}')  # –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è

    catalog_data = await CategoryDao.find_all(session=session_without_commit)

    await call.message.answer(
        text='–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–æ–≤:',
        reply_markup=catalog_kb(catalog_data)
    )


@catalog_router.callback_query(F.data.startswith('category_'))
async def page_catalog_products(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback-–∑–∞–ø—Ä–æ—Å –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :param session_without_commit: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è SQLAlchemy –±–µ–∑ –∫–æ–º–º–∏—Ç–∞.
    :type session_without_commit: AsyncSession
    """
    category_id = int(call.data.split('_')[-1])
    products_category = await ProductDao.find_all(
        session=session_without_commit,
        filters=ProductCategoryIDModel(category_id=category_id)
    )
    count_products = len(products_category)
    if count_products:
        await call.answer(f'–í –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ {count_products} —Ç–æ–≤–∞—Ä–æ–≤.')
        for product in products_category:
            product_text = (
                f'üì¶ <b>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:</b> {product.name}\n\n'
                f'üí∞ <b>–¶–µ–Ω–∞:</b> {product.price} —Ä—É–±.\n\n'
                f'üìù <b>–û–ø–∏—Å–∞–Ω–∏–µ:</b>\n<i>{product.description}</i>\n\n'
                f'‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ'
            )
            await call.message.answer(
                product_text,
                reply_markup=product_kb(product.id, product.price, 1)
            )
    else:
        await call.answer('–í –¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤.')


@catalog_router.callback_query(F.data.startswith('buy_'))
async def process_about(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback-–∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–∞.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :param session_without_commit: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è SQLAlchemy –±–µ–∑ –∫–æ–º–º–∏—Ç–∞.
    :type session_without_commit: AsyncSession
    """
    user_info = await UserDAO.find_one_or_none(
        session=session_without_commit,
        filters=TelegramIDModel(telegram_id=call.from_user.id)
    )
    _, payment_type, product_id, price = call.data.split('_')

    if payment_type == 'yukassa':
        await send_yukassa_invoice(call, user_info, product_id, price)
    elif payment_type == 'stars':
        await send_stars_invoice(call, user_info, product_id, 10)
    elif payment_type == 'robocassa':
        await send_robocassa_invoice(call, user_info, product_id, price, session_without_commit)

    await call.message.delete()


async def send_yukassa_invoice(call: CallbackQuery, user_info, product_id: int, price: str):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–Ω–≤–æ–π—Å –¥–ª—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ –ÆKassa.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :param user_info: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.
    :type user_info: User
    :param product_id: ID –ø—Ä–æ–¥—É–∫—Ç–∞.
    :type product_id: int
    :param price: –¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞.
    :type price: str
    """
    await bot.send_invoice(
        chat_id=call.from_user.id,
        title=f'–û–ø–ª–∞—Ç–∞ üëâ {price}‚ÇΩ',
        description=f'–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ –æ–ø–ª–∞—Ç—É –≤ —Ä–∞–∑–º–µ—Ä–µ {price}‚ÇΩ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–æ–≤–∞—Ä—É.',
        payload=f'yukassa_{user_info.id}_{product_id}',
        provider_token=settings.PROVIDER_TOKEN,
        currency='rub',
        prices=[LabeledPrice(
            label=f'–û–ø–ª–∞—Ç–∞ {price}',
            amount=int(price) * 100
        )],
        reply_markup=get_product_buy_youkassa(price)
    )


async def send_robocassa_invoice(call: CallbackQuery, user_info, product_id: int, price: str, session: AsyncSession):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Å—Å—ã–ª–∫–æ–π –¥–ª—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ Robocassa.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :param user_info: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.
    :type user_info: User
    :param product_id: ID –ø—Ä–æ–¥—É–∫—Ç–∞.
    :type product_id: int
    :param price: –¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞.
    :type price: str
    :param session: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è SQLAlchemy.
    :type session: AsyncSession
    """
    pay_id = await PurchaseDao.get_next_id(session=session)
    text = f'–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ –æ–ø–ª–∞—Ç—É –≤ —Ä–∞–∑–º–µ—Ä–µ {price}‚ÇΩ, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–æ–≤–∞—Ä—É.'
    description = f'–û–ø–ª–∞—Ç–∞ –∑–∞ —Ç–æ–≤–∞—Ä: ID {user_info.id} ({price}‚ÇΩ)'
    payment_link = generate_payment_link(
        cost=float(price),
        number=pay_id,
        description=description,
        user_id=user_info.id,
        user_telegram_id=call.from_user.id,
        product_id=product_id
    )
    kb = get_product_buy_robocassa(price, payment_link)
    await call.message.answer(text, reply_markup=kb)


async def send_stars_invoice(call: CallbackQuery, user_info, product_id: int, stars_price: int):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–Ω–≤–æ–π—Å –¥–ª—è –æ–ø–ª–∞—Ç—ã –∑–≤–µ–∑–¥–∞–º–∏.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :param user_info: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ.
    :type user_info: User
    :param product_id: ID –ø—Ä–æ–¥—É–∫—Ç–∞.
    :type product_id: int
    :param stars_price: –¶–µ–Ω–∞ –≤ –∑–≤–µ–∑–¥–∞—Ö.
    :type stars_price: int
    """
    await bot.send_invoice(
        chat_id=call.from_user.id,
        title=f'–û–ø–ª–∞—Ç–∞ üëâ {stars_price} ‚≠ê',
        description=f'–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ –æ–ø–ª–∞—Ç—É –≤ —Ä–∞–∑–º–µ—Ä–µ {stars_price} –∑–≤–µ–∑–¥, '
                    f'—á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–æ–≤–∞—Ä—É.',
        payload=f'stars_{user_info.id}_{product_id}',
        provider_token="",  # —Ç–æ–∫–µ–Ω –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –∑–≤–µ–∑–¥
        currency='XTR',
        prices=[LabeledPrice(
            label=f'–û–ø–ª–∞—Ç–∞ {stars_price} ‚≠ê',
            amount=int(stars_price)
        )],
        reply_markup=get_product_buy_stars(stars_price)
    )


@catalog_router.pre_checkout_query(lambda query: True)
async def pre_checkout_query(pre_checkout_q: PreCheckoutQuery):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç pre-checkout query.

    :param pre_checkout_q: –û–±—ä–µ–∫—Ç PreCheckoutQuery.
    :type pre_checkout_q: PreCheckoutQuery
    """
    await bot.answer_pre_checkout_query(pre_checkout_q.id, ok=True)


@catalog_router.message(F.content_type == ContentType.SUCCESSFUL_PAYMENT)
async def successful_payment(message: Message, session_with_commit: AsyncSession):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π –ø–ª–∞—Ç–µ–∂.

    :param message: –û–±—ä–µ–∫—Ç Message —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± —É—Å–ø–µ—à–Ω–æ–º –ø–ª–∞—Ç–µ–∂–µ.
    :type message: Message
    :param session_with_commit: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Å–µ—Å—Å–∏—è SQLAlchemy —Å –∫–æ–º–º–∏—Ç–æ–º.
    :type session_with_commit: AsyncSession
    """
    payment_info = message.successful_payment
    payment_type, user_id, product_id = payment_info.invoice_payload.split('_')

    if payment_type == 'stars':
        price = payment_info.total_amount
        currency = '‚≠ê'
    else:
        price = payment_info.total_amount / 100
        currency = '‚ÇΩ'
    payment_data = {
        'user_id': int(user_id),
        'payment_id': payment_info.telegram_payment_charge_id,
        'price': price,
        'product_id': int(product_id),
        'payment_type': payment_type
    }

    await successful_payment_logic(
        session=session_with_commit,
        payment_data=payment_data,
        currency=currency,
        user_tg_id=message.from_user.id,
        bot=bot
    )