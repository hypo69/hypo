# hypotez/src/endpoints/bots/telegram/ToolBoxbot-main/ToolBox/ToolBox_requests.py

## Обзор

Этот файл содержит класс `ToolBox`, который расширяет функциональность телеграм-бота, добавляя обработку текста, изображений, работу в свободном режиме и информацию о тарифах. Класс использует библиотеки `telebot`, `os`, `json` и другие для взаимодействия с Telegram API, обработки запросов пользователей и интеграции с нейронными сетями.

## Подробней

В данном файле реализована основная логика работы Telegram-бота ToolBox. Он обрабатывает различные типы запросов от пользователей, такие как генерация текста, создание изображений, взаимодействие в свободном режиме и предоставление информации о тарифных планах. Класс `ToolBox` инициализирует бота, загружает текстовые подсказки, настраивает клавиатуры и обрабатывает команды пользователей, используя как собственные методы, так и функциональность нейронных сетей.

## Классы

### `ToolBox`

**Описание**:
Основной класс, управляющий логикой работы Telegram-бота.

**Как работает класс**:
Класс инициализирует бота, загружает подсказки из JSON, определяет обработчики команд и настраивает взаимодействие с пользователем через клавиатуры. Он также интегрируется с нейронными сетями для обработки текста и изображений. Методы класса позволяют обрабатывать запросы на генерацию текста, создание изображений, предоставлять информацию о тарифах и обеспечивать взаимодействие в свободном режиме.

**Методы**:
- `__init__`: Инициализация класса, настройка бота, загрузка подсказок и определение обработчиков команд.
- `__gpt_4o_mini`: Приватный метод для обработки запросов с использованием мини-модели GPT-4o.
- `__FLUX_schnell`: Приватный метод для обработки запросов на генерацию изображений с использованием FLUX schnell.
- `Text_types`: Отображает типы текстов для выбора пользователем.
- `Basic_tariff`: Обрабатывает запрос на подключение базового тарифа.
- `Pro_tariff`: Обрабатывает запрос на подключение профессионального тарифа.
- `TextCommands`: Обрабатывает текстовые команды пользователей.
- `SomeTextsCommand`: Обрабатывает команды, связанные с несколькими текстами.
- `ImageCommand`: Обрабатывает команды для генерации изображений.
- `Image_Regen_And_Upscale`: Обрабатывает запросы на регенерацию и улучшение изображений.
- `FreeCommand`: Обрабатывает команды в свободном режиме.

### `ToolBox.__init__`

```python
def __init__(self):
    """
    Args:
        self (ToolBox): Экземпляр класса ToolBox.

    Returns:
        None

    Raises:
        FileNotFoundError: Если файл "ToolBox/BaseSettings/prompts.json" не найден.
        OSError: Если произошла ошибка при чтении файла "ToolBox/BaseSettings/prompts.json".
        telebot.apihelper.ApiTelegramException: Если токен Telegram-бота недействителен.

    Example:
        >>> tb = ToolBox()
    """
```

**Описание**:
Инициализирует класс `ToolBox`, настраивает основные параметры и загружает необходимые данные.

**Как работает класс**:
- Инициализирует списки `name` и `data` для стартовых кнопок.
- Загружает текстовые подсказки из файла `prompts.json`.
- Инициализирует Telegram-бота с использованием токена из переменной окружения `TOKEN`.
- Создает лямбда-функции для упрощения создания клавиатур.
- Определяет лямбда-функции для различных типов запросов и взаимодействий с пользователем, таких как отправка сообщений, редактирование текста и отображение клавиатур.

### `ToolBox.__gpt_4o_mini`

```python
def __gpt_4o_mini(self, prompt: list[dict], message) -> tuple[dict[str, str], int, int]:
    """
    Args:
        prompt (list[dict]): Список словарей, представляющих запрос для GPT-4o mini.
                               Каждый словарь содержит ключи "role" и "content".
        message: Объект сообщения от Telegram.

    Returns:
        tuple[dict[str, str], int, int]: Кортеж, содержащий:
            - Словарь с ответом от GPT-4o mini.
            - Количество входящих токенов.
            - Количество исходящих токенов.

    Raises:
        telebot.apihelper.ApiTelegramException: Если возникла ошибка при отправке или редактировании сообщения.
        Exception: Если возникла ошибка при обработке запроса GPT-4o mini.

    Example:
        >>> prompt = [{"role": "user", "content": "Напиши короткий рассказ."}]
        >>> message = ...  # Объект сообщения Telegram
        >>> response, incoming_tokens, outgoing_tokens = tb.__gpt_4o_mini(prompt, message)
        >>> print(response['content'])
        Короткий рассказ...
    """
```

**Описание**:
Приватный метод для обработки запросов с использованием мини-модели GPT-4o.

**Как работает функция**:
1. Отправляет пользователю сообщение "Подождите, это должно занять несколько секунд . . .".
2. Вызывает метод `_free_gpt_4o_mini` для получения ответа от модели GPT-4o mini.
3. Редактирует сообщение пользователя, заменяя его ответом от модели.
4. Возвращает ответ, количество входящих и исходящих токенов.

**Параметры**:
- `prompt` (list[dict]): Список словарей, представляющих запрос для GPT-4o mini.
- `message`: Объект сообщения от Telegram.

**Возвращает**:
- `tuple[dict[str, str], int, int]`: Кортеж, содержащий ответ, количество входящих и исходящих токенов.

### `ToolBox.__FLUX_schnell`

```python
def __FLUX_schnell(self, prompt: str, size: list[int], message, seed: int, num_inference_steps: int)-> None:
    """
    Args:
        prompt (str): Текстовый запрос для генерации изображения.
        size (list[int]): Список, содержащий ширину и высоту изображения.
        message: Объект сообщения от Telegram.
        seed (int): Зерно для генерации изображения.
        num_inference_steps (int): Количество шагов для генерации изображения.

    Returns:
        None

    Raises:
        telebot.apihelper.ApiTelegramException: Если возникла ошибка при отправке фотографии или редактировании сообщения.
        Exception: Если возникла ошибка при генерации изображения.

    Example:
        >>> prompt = "Собака в космосе"
        >>> size = [512, 512]
        >>> message = ...  # Объект сообщения Telegram
        >>> seed = 12345
        >>> num_inference_steps = 5
        >>> tb.__FLUX_schnell(prompt, size, message, seed, num_inference_steps)
    """
```

**Описание**:
Приватный метод для обработки запросов на генерацию изображений с использованием FLUX schnell.

**Как работает функция**:
1. Отправляет пользователю сообщение "Подождите, это должно занять несколько секунд . . .".
2. В цикле пытается сгенерировать изображение с использованием метода `_FLUX_schnell`.
3. В случае успеха отправляет сгенерированное изображение пользователю.
4. Удаляет сообщение "Подождите, это должно занять несколько секунд . . .".
5. В случае ошибки отправляет сообщение об ошибке генерации.

**Параметры**:
- `prompt` (str): Текстовый запрос для генерации изображения.
- `size` (list[int]): Список, содержащий ширину и высоту изображения.
- `message`: Объект сообщения от Telegram.
- `seed` (int): Зерно для генерации изображения.
- `num_inference_steps` (int): Количество шагов для генерации изображения.

**Возвращает**:
- `None`

### `ToolBox.Text_types`

```python
def Text_types(self, message):
    """
    Args:
        message: Объект сообщения от Telegram.

    Returns:
        telebot.types.Message: Отредактированное сообщение с вариантами выбора типа текста.

    Raises:
        telebot.apihelper.ApiTelegramException: Если возникла ошибка при редактировании сообщения.

    Example:
        >>> message = ...  # Объект сообщения Telegram
        >>> tb.Text_types(message)
    """
```

**Описание**:
Отображает типы текстов для выбора пользователем.

**Как работает функция**:
1. Определяет список названий и данных для кнопок с типами текстов.
2. Редактирует сообщение пользователя, отображая кнопки с типами текстов.

**Параметры**:
- `message`: Объект сообщения от Telegram.

**Возвращает**:
- `telebot.types.Message`: Отредактированное сообщение с вариантами выбора типа текста.

### `ToolBox.Basic_tariff`

```python
def Basic_tariff(self, message):
    """
    Args:
        message: Объект сообщения от Telegram.

    Returns:
        None

    Raises:
        telebot.apihelper.ApiTelegramException: Если возникла ошибка при отправке инвойса или удалении сообщения.

    Example:
        >>> message = ...  # Объект сообщения Telegram
        >>> tb.Basic_tariff(message)
    """
```

**Описание**:
Обрабатывает запрос на подключение базового тарифа.

**Как работает функция**:
1. Создает клавиатуру с кнопками "Подключить тариф BASIC" и "К тарифам".
2. Создает объект `LabeledPrice` с информацией о стоимости тарифа.
3. Удаляет текущее сообщение пользователя.
4. Отправляет инвойс пользователю с информацией о базовом тарифе.

**Параметры**:
- `message`: Объект сообщения от Telegram.

**Возвращает**:
- `None`

### `ToolBox.Pro_tariff`

```python
def Pro_tariff(self, message):
    """
    Args:
        message: Объект сообщения от Telegram.

    Returns:
        None

    Raises:
        telebot.apihelper.ApiTelegramException: Если возникла ошибка при отправке инвойса или удалении сообщения.

    Example:
        >>> message = ...  # Объект сообщения Telegram
        >>> tb.Pro_tariff(message)
    """
```

**Описание**:
Обрабатывает запрос на подключение профессионального тарифа.

**Как работает функция**:
1. Создает клавиатуру с кнопками "Подключить тариф PRO" и "К тарифам".
2. Создает объект `LabeledPrice` с информацией о стоимости тарифа.
3. Удаляет текущее сообщение пользователя.
4. Отправляет инвойс пользователю с информацией о профессиональном тарифе.

**Параметры**:
- `message`: Объект сообщения от Telegram.

**Возвращает**:
- `None`

### `ToolBox.TextCommands`

```python
def TextCommands(self, message, ind: int):
    """
    Args:
        message: Объект сообщения от Telegram.
        ind (int): Индекс команды.

    Returns:
        tuple[int, int, int]: Кортеж, содержащий количество входящих токенов, количество исходящих токенов и 1.

    Raises:
        telebot.apihelper.ApiTelegramException: Если возникла ошибка при отправке сообщения.

    Example:
        >>> message = ...  # Объект сообщения Telegram
        >>> ind = 0
        >>> tb.TextCommands(message, ind)
    """
```

**Описание**:
Обрабатывает текстовые команды пользователей.

**Как работает функция**:
1. Инициализирует списки для хранения информации и переменные для подсчета токенов.
2. Если команда требует ввода текста, отправляет сообщение с запросом следующего шага.
3. Регистрирует обработчик следующего шага для получения дополнительной информации от пользователя.
4. Формирует запрос на основе введенной информации и отправляет его в GPT-4o mini.
5. В противном случае формирует запрос на основе введенной информации и отправляет его в GPT-4o mini.
6. Возвращает количество входящих и исходящих токенов.

**Параметры**:
- `message`: Объект сообщения от Telegram.
- `ind` (int): Индекс команды.

**Возвращает**:
- `tuple[int, int, int]`: Кортеж, содержащий количество входящих токенов, количество исходящих токенов и 1.

### `ToolBox.SomeTextsCommand`

```python
def SomeTextsCommand(self, message, ind: int, tokens: dict[str, int]):
    """
    Args:
        message: Объект сообщения от Telegram.
        ind (int): Индекс команды.
        tokens (dict[str, int]): Словарь с информацией о количестве токенов.

    Returns:
        tuple[int, int, int]: Кортеж, содержащий количество входящих токенов, количество исходящих токенов и количество текстов.

    Raises:
        telebot.apihelper.ApiTelegramException: Если возникла ошибка при отправке сообщения.

    Example:
        >>> message = ...  # Объект сообщения Telegram
        >>> ind = 0
        >>> tokens = {"incoming_tokens": 1000, "outgoing_tokens": 1000, "free_requests": 10}
        >>> tb.SomeTextsCommand(message, ind, tokens)
    """
```

**Описание**:
Обрабатывает команды, связанные с несколькими текстами.

**Как работает функция**:
1. Запрашивает у пользователя количество текстов, которые нужно обработать.
2. Запрашивает у пользователя текст источника для каждого текста.
3. Запрашивает у пользователя параметры для каждого текста.
4. Формирует запросы для каждого текста и отправляет их в GPT-4o mini.
5. Подсчитывает количество входящих и исходящих токенов.
6. Возвращает количество входящих и исходящих токенов и количество текстов.

**Параметры**:
- `message`: Объект сообщения от Telegram.
- `ind` (int): Индекс команды.
- `tokens` (dict[str, int]): Словарь с информацией о количестве токенов.

**Возвращает**:
- `tuple[int, int, int]`: Кортеж, содержащий количество входящих токенов, количество исходящих токенов и количество текстов.

### `ToolBox.ImageCommand`

```python
def ImageCommand(self, message, prompt: str, size: list[int]):
    """
    Args:
        message: Объект сообщения от Telegram.
        prompt (str): Текстовый запрос для генерации изображения.
        size (list[int]): Список, содержащий ширину и высоту изображения.

    Returns:
        int: Зерно, использованное для генерации изображения.

    Raises:
        telebot.apihelper.ApiTelegramException: Если возникла ошибка при отправке сообщения.

    Example:
        >>> message = ...  # Объект сообщения Telegram
        >>> prompt = "Собака в космосе"
        >>> size = [512, 512]
        >>> tb.ImageCommand(message, prompt, size)
    """
```

**Описание**:
Обрабатывает команды для генерации изображений.

**Как работает функция**:
1. Генерирует случайное зерно для генерации изображения.
2. Вызывает метод `__FLUX_schnell` для генерации изображения.
3. Вызывает метод `ImageChange` для отображения вариантов действий с изображением.
4. Возвращает использованное зерно.

**Параметры**:
- `message`: Объект сообщения от Telegram.
- `prompt` (str): Текстовый запрос для генерации изображения.
- `size` (list[int]): Список, содержащий ширину и высоту изображения.

**Возвращает**:
- `int`: Зерно, использованное для генерации изображения.

### `ToolBox.Image_Regen_And_Upscale`

```python
def Image_Regen_And_Upscale(self, message, prompt: str, size: list[int], seed, num_inference_steps=4):
    """
    Args:
        message: Объект сообщения от Telegram.
        prompt (str): Текстовый запрос для генерации изображения.
        size (list[int]): Список, содержащий ширину и высоту изображения.
        seed (int): Зерно для генерации изображения.
        num_inference_steps (int, optional): Количество шагов для генерации изображения. По умолчанию 4.

    Returns:
        None

    Raises:
        telebot.apihelper.ApiTelegramException: Если возникла ошибка при отправке сообщения.

    Example:
        >>> message = ...  # Объект сообщения Telegram
        >>> prompt = "Собака в космосе"
        >>> size = [512, 512]
        >>> seed = 12345
        >>> tb.Image_Regen_And_Upscale(message, prompt, size, seed)
    """
```

**Описание**:
Обрабатывает запросы на регенерацию и улучшение изображений.

**Как работает функция**:
1. Вызывает метод `__FLUX_schnell` для регенерации или улучшения изображения.

**Параметры**:
- `message`: Объект сообщения от Telegram.
- `prompt` (str): Текстовый запрос для генерации изображения.
- `size` (list[int]): Список, содержащий ширину и высоту изображения.
- `seed` (int): Зерно для генерации изображения.
- `num_inference_steps` (int, optional): Количество шагов для генерации изображения. По умолчанию 4.

**Возвращает**:
- `None`

### `ToolBox.FreeCommand`

```python
def FreeCommand(self, message, prompts: list[str]):
    """
    Args:
        message: Объект сообщения от Telegram.
        prompts (list[str]): Список подсказок.

    Returns:
        tuple[int, int, list[str]]: Кортеж, содержащий количество входящих токенов, количество исходящих токенов и список подсказок.

    Raises:
        telebot.apihelper.ApiTelegramException: Если возникла ошибка при отправке сообщения.

    Example:
        >>> message = ...  # Объект сообщения Telegram
        >>> prompts = []
        >>> tb.FreeCommand(message, prompts)
    """
```

**Описание**:
Обрабатывает команды в свободном режиме.

**Как работает функция**:
1. Добавляет сообщение пользователя в список подсказок.
2. Вызывает метод `__gpt_4o_mini` для обработки запроса.
3. Добавляет ответ от модели в список подсказок.
4. Возвращает количество входящих и исходящих токенов и список подсказок.

**Параметры**:
- `message`: Объект сообщения от Telegram.
- `prompts` (list[str]): Список подсказок.

**Возвращает**:
- `tuple[int, int, list[str]]`: Кортеж, содержащий количество входящих токенов, количество исходящих токенов и список подсказок.