## \file hypotez/src/bots/telegram/bot.py
# -*- coding: utf-8 -*-
#! venv/Scripts/python.exe

""" module: src.bots.telegram """
MODE = 'debug'
""" module: src.bots.telegram """
MODE = 'debug'
"""! Module for interacting with Telegram using a simple bot interface. """

from pathlib import Path
import tempfile
import asyncio
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, CallbackContext

import header
from __init__ import gs
from src.utils import j_loads, j_loads_ns, j_dumps
from src.logger import logger
import requests  # For downloading files
from src.utils.convertors.tts import speech_recognizer, text2speech
from src.utils.file import read_text_file

class TelegramBot:
    """Telegram bot interface class."""

    application: Application

    def __init__(self, token: str):
        """Initialize the Telegram bot.

        Args:
            token (str): Telegram bot token, e.g., `gs.credentials.telegram.bot.kazarinov`.
        """
        self.application = Application.builder().token(token).build()

    async def start(self, update: Update, context: CallbackContext) -> None:
        """Handle the /start command."""
        await update.message.reply_text('Hello! I am your simple bot. Type /help to see available commands.')

    async def help_command(self, update: Update, context: CallbackContext) -> None:
        """Handle the /help command."""
        await update.message.reply_text(
            'Available commands:\n'
            '/start - Start the bot\n'
            '/help - Show this help message'
        )

    async def handle_document(self, update: Update, context: CallbackContext) -> str:
        """Handle received documents.

        Args:
            update (Update): Update object containing the message data.
            context (CallbackContext): Context of the current conversation.

        Returns:
            str: Content of the text document.
        """
        file = await update.message.document.get_file()
        tmp_file_path = await file.download_to_drive()  # Save file locally
        return read_text_file(tmp_file_path)

    async def handle_message(self, update: Update, context: CallbackContext) -> str:
        """Handle any text message.

        Args:
            update (Update): Update object containing the message data.
            context (CallbackContext): Context of the current conversation.

        Returns:
            str: Text received from the user.
        """
        return update.message.text

    async def handle_voice(self, update: Update, context: CallbackContext) -> str:
        """Handle voice messages.

        Args:
            update (Update): Update object containing the message data.
            context (CallbackContext): Context of the current conversation.

        Returns:
            str: Recognized text from the voice message.
        """
        voice_file = await update.message.voice.get_file()
        return speech_recognizer(audio_url=voice_file.file_path)

def main() -> None:
    """Start the bot."""
    token = gs.credentials.telegram.bot.kazarinov
    bot = TelegramBot(token)

    # Register command handlers
    bot.application.add_handler(CommandHandler('start', bot.start))
    bot.application.add_handler(CommandHandler('help', bot.help_command))

    # Register message handlers
    bot.application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, bot.handle_message))
    bot.application.add_handler(MessageHandler(filters.VOICE, bot.handle_voice))
    bot.application.add_handler(MessageHandler(filters.Document.ALL, bot.handle_document))

    # Start the bot
    bot.application.run_polling()

if __name__ == '__main__':
    main()
