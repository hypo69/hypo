# Модуль `product_fields_translator.py`

## Обзор

Модуль предназначен для перевода полей товара на языки, используемые в клиентской базе данных PrestaShop. Он обеспечивает соответствие идентификаторов языков в полях товара со схемой языков, настроенной на стороне клиента, что необходимо для корректного отображения мультиязычного контента.

## Подробней

Этот модуль решает задачу адаптации данных о товарах, полученных от поставщика, к языковым настройкам конкретной установки PrestaShop. Поскольку идентификаторы языков в PrestaShop могут отличаться в зависимости от первоначальной установки, модуль гарантирует, что поля товара будут правильно интерпретированы и отображены на нужном языке.

## Функции

### `rearrange_language_keys`

```python
def rearrange_language_keys(presta_fields_dict: dict, client_langs_schema: dict | List[dict], page_lang: str) -> dict:
    """Функция обновляет идентификатор языка в словаре presta_fields_dict на соответствующий идентификатор
    из схемы клиентских языков при совпадении языка страницы.

    Args:
        presta_fields_dict (dict): Словарь полей товара.
        page_lang (str): Язык страницы.
        client_langs_schema (list | dict): Схема языков клиента.

    Returns:
        dict: Обновленный словарь presta_fields_dict.
    """
```

**Как работает функция**:
Функция `rearrange_language_keys` выполняет поиск соответствия между языком страницы товара (`page_lang`) и идентификаторами языков, представленными в схеме языков клиента (`client_langs_schema`). Если соответствие найдено, функция обновляет атрибут `id` в словаре `presta_fields_dict` для каждого языкового поля товара, заменяя идентификатор языка поставщика на идентификатор языка клиента.

Внутри функции происходят следующие действия и преобразования:
A. Инициализация `client_lang_id` в `None`.
|
B. Итерация по списку языков в `client_langs_schema` для поиска соответствия.
|
C. Если соответствие найдено, `client_lang_id` присваивается значение `id` найденного языка.
|
D. Если `client_lang_id` не `None`, происходит итерация по полям в `presta_fields_dict`.
|
E. Для каждого поля, содержащего информацию о языке, атрибуту `id` присваивается строковое значение `client_lang_id`.

**Параметры**:
- `presta_fields_dict` (dict): Словарь, содержащий поля товара, включая мультиязычные поля с идентификаторами языков поставщика.
- `client_langs_schema` (dict | List[dict]): Схема языков клиента, содержащая информацию о доступных языках и их идентификаторах.
- `page_lang` (str): Язык текущей страницы товара (например, 'en-US', 'ru-RU').

**Возвращает**:
- `dict`: Обновленный словарь `presta_fields_dict`, в котором идентификаторы языков приведены в соответствие со схемой языков клиента.

### `translate_presta_fields_dict`

```python
def translate_presta_fields_dict (presta_fields_dict: dict, 
                                  client_langs_schema: list | dict, 
                                  page_lang: str = None) -> dict:
    """ @Перевод мультиязычных полей в соответствии со схемой значений `id` языка в базе данных клиента
	    Функция получает на вход заполненный словарь полей. Мультиязычные поля содржат значения,
	    полученные с сайта поставщика в виде словаря 
	    ```
	    {
		    'language':[
					    {'attrs':{'id':'1'}, 'value':value},
					    ]
	    }
	    ```
	    У клиента язык с ключом `id=1` Может быть любым в зависимости от того на каком языке была 
	    изначально установлена PrestaShop. Чаще всего это английский, но это не правило.
	    Точные соответствия я получаю в схеме языков клиента 
	    locator_description
	    Самый быстрый способ узнать схему API языков - набрать в адресной строке браузера
	    https://API_KEY@mypresta.com/api/languages?display=full&io_format=JSON
	  
    @param client_langs_schema `dict` словарь актуальных языков на клиенте
    @param presta_fields_dict `dict` словарь полей товара собранный со страницы поставщика
    @param page_lang `str` язык страницы поставщика в коде en-US, ru-RU, he_HE. 
    Если не задан - функция пытается определить п тексту
    @returns presta_fields_dict переведенный словарь полей товара
    """
```

**Как работает функция**:

Функция `translate_presta_fields_dict` выполняет перевод мультиязычных полей товара в соответствии со схемой значений `id` языка в базе данных клиента PrestaShop. Она получает словарь полей товара (`presta_fields_dict`), схему языков клиента (`client_langs_schema`) и язык страницы поставщика (`page_lang`).

Внутри функции происходят следующие действия и преобразования:

A. Вызывается функция `rearrange_language_keys` для переупорядочивания ключей таблицы в соответствии со схемой языков клиента.
|
B. Вызывается функция `get_translations_from_presta_translations_table` для получения переводов из таблицы переводов.
|
C. Проверяется наличие переводов в таблице. Если переводов нет, текущие значения добавляются как новые переводы.
|
D. Если переводы есть, происходит итерация по языкам клиента и записям переводов для обновления значений полей товара.
|
E. В случае возникновения ошибки в процессе перевода, информация об ошибке логируется с использованием `logger.error`.

**Параметры**:

- `presta_fields_dict` (dict): Словарь полей товара, полученный со страницы поставщика.
- `client_langs_schema` (list | dict): Словарь актуальных языков на клиенте.
- `page_lang` (str, optional): Язык страницы поставщика (например, en-US, ru-RU, he_HE). Если не указан, функция пытается определить его автоматически. По умолчанию `None`.

**Возвращает**:

- `dict`: Переведенный словарь полей товара.