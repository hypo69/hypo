# Модуль для работы с Phind API
=================================================

Модуль содержит класс `Phind`, который является асинхронным генератором провайдера и используется для взаимодействия с API Phind.

## Обзор

Модуль `Phind` предоставляет возможность асинхронного взаимодействия с API Phind для получения ответов на запросы. Он поддерживает потоковую передачу ответов, сохранение истории сообщений и имеет настройки для творческого режима. Класс использует `StreamSession` для выполнения HTTP-запросов и обрабатывает ответы в формате `text/event-stream`.

## Подробнее

Этот модуль позволяет интегрировать ответы от Phind в другие приложения, поддерживая как обычные запросы, так и потоковую передачу данных. Он предназначен для использования в асинхронных средах, где требуется неблокирующий ввод-вывод.

## Классы

### `Phind`

**Описание**: Класс `Phind` является асинхронным генератором провайдера для взаимодействия с API Phind.

**Наследует**:
- `AsyncGeneratorProvider`: Этот класс наследует функциональность асинхронного генератора провайдера.

**Атрибуты**:
- `url` (str): URL API Phind (`https://www.phind.com`).
- `working` (bool): Указывает, работает ли провайдер (в данном случае `False`).
- `lockdown` (bool): Указывает, находится ли провайдер в режиме блокировки (`True`).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных (`True`).
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений (`True`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от API Phind.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        timeout: int = 120,
        creative_mode: bool = False,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для получения ответов от API Phind.

        Args:
            model (str): Идентификатор используемой модели.
            messages (Messages): Список сообщений для отправки в API.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            timeout (int, optional): Время ожидания ответа в секундах. По умолчанию `120`.
            creative_mode (bool, optional): Включает ли креативный режим. По умолчанию `False`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий ответы от API Phind.

        Raises:
            RuntimeError: Если возникает ошибка на стороне сервера Phind.

        """
```

**Назначение**: Создает асинхронный генератор для взаимодействия с API Phind и получения ответов на основе предоставленных сообщений.

**Параметры**:
- `model` (str): Идентификатор используемой модели.
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания ответа в секундах. По умолчанию `120`.
- `creative_mode` (bool, optional): Включает ли креативный режим. По умолчанию `False`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий ответы от API Phind.

**Вызывает исключения**:
- `RuntimeError`: Если возникает ошибка на стороне сервера Phind.

**Как работает функция**:

1. **Подготовка заголовков**: Функция начинает с подготовки HTTP-заголовков, необходимых для запроса к API Phind. Устанавливаются параметры `Accept`, `Origin`, `Referer`, `Sec-Fetch-Dest`, `Sec-Fetch-Mode` и `Sec-Fetch-Site`.
2. **Создание сессии**: Создается асинхронная сессия `StreamSession` с заданными заголовками, имитацией браузера Chrome, прокси-сервером (если указан) и временем ожидания.
3. **Получение challenge_seeds**: Отправляется GET-запрос на URL `https://www.phind.com/search?home=true` для получения данных `challenge_seeds` из HTML-кода страницы. Эти данные используются для генерации challenge.
4. **Формирование данных запроса**: Формируется словарь `data`, содержащий вопрос, историю вопросов и ответов, веб-результаты, опции (дата, язык, детальность, идентификатор пользователя, модель ответа, креативный режим, пользовательские ссылки) и контекст.
5. **Генерация challenge**: Генерируется `challenge` с использованием функции `generate_challenge` на основе данных запроса и `challenge_seeds`.
6. **Отправка POST-запроса**: Отправляется POST-запрос на URL `https://https.api.phind.com/infer/` с заголовками и данными в формате JSON.
7. **Обработка потока ответов**: Асинхронно итерируется по строкам ответа, полученного от сервера. Каждая строка проверяется на наличие специальных префиксов, таких как `data: `, `<PHIND_DONE/>`, `<PHIND_BACKEND_ERROR>`, `<PHIND_WEBRESULTS>`, `<PHIND_FOLLOWUP>`, `<PHIND_METADATA>`, `<PHIND_INDICATOR>`, `<PHIND_SPAN_BEGIN>`, `<PHIND_SPAN_END>`.
8. **Обработка ошибок**: Если строка начинается с `<PHIND_BACKEND_ERROR>`, вызывается исключение `RuntimeError`.
9. **Извлечение данных**: Если строка начинается с `data: `, извлекается полезная нагрузка (chunk) и декодируется. Если строка содержит полезные данные, они передаются через `yield`.
10. **Обработка новых строк**: Управляется добавление символов новой строки в выходной поток.

```text
Начало
  ↓
Заголовки и сессия
  ↓
GET запрос для challenge_seeds
  ↓
Формирование данных запроса
  ↓
Генерация challenge
  ↓
POST запрос к API Phind
  ↓
Обработка ответа (построчно)
  |
  → "data:"? → Извлечь данные и yield
  |
  → "<PHIND_DONE/>"? → Завершить
  |
  → "<PHIND_BACKEND_ERROR>"? → RuntimeError
  |
  → Другие префиксы? → Пропустить
  ↓
Конец
```

**Примеры**:

```python
# Пример использования create_async_generator
model = "gpt-4"
messages = [
    {"role": "user", "content": "Hello, Phind!"}
]

async def main():
    generator = await Phind.create_async_generator(model=model, messages=messages)
    async for message in generator:
        print(message)

# Запуск примера (только в асинхронной среде)
# asyncio.run(main())
```

### `deterministic_stringify`

```python
def deterministic_stringify(obj):
    """Преобразует объект в строку JSON с детерминированным порядком ключей.

    Args:
        obj (dict): Объект для преобразования.

    Returns:
        str: Строка JSON с детерминированным порядком ключей.
    """
```

**Назначение**: Преобразует объект (словарь) в строку JSON с детерминированным порядком ключей.

**Параметры**:
- `obj` (dict): Объект для преобразования.

**Возвращает**:
- `str`: Строка JSON с детерминированным порядком ключей.

**Как работает функция**:

1. **Внутренняя функция `handle_value`**: Определяет, как обрабатывать значения разных типов.
   - Если значение является словарем или списком, рекурсивно вызывает `deterministic_stringify` или сортирует элементы списка.
   - Если значение является булевым, преобразует его в строку `'true'` или `'false'`.
   - Если значение является числом (int или float), форматирует его с 8 знаками после запятой и удаляет лишние нули.
   - Если значение является строкой, заключает его в двойные кавычки.
   - В противном случае возвращает `'null'`.

2. **Сортировка элементов**: Сортирует элементы входного словаря `obj` по ключам.

3. **Преобразование в строку**: Преобразует каждый элемент (ключ-значение) в строку формата `"{k}:{handle_value(v)}"`, где `k` - ключ, а `v` - значение, обработанное функцией `handle_value`.

4. **Объединение строк**: Объединяет все полученные строки через запятую.

```text
Начало
  ↓
Определение handle_value
  ↓
Сортировка элементов словаря по ключам
  ↓
Преобразование каждого элемента в строку
  ↓
Объединение строк через запятую
  ↓
Конец
```

**Примеры**:

```python
# Пример использования deterministic_stringify
data = {"b": 2, "a": 1, "c": {"f": 6, "e": 5}}
result = deterministic_stringify(data)
print(result)  # Вывод: a:1.00000000,b:2.00000000,c:{e:5.00000000,f:6.00000000}
```

### `prng_general`

```python
def prng_general(seed, multiplier, addend, modulus):
    """Генерирует псевдослучайное число с использованием общих параметров.

    Args:
        seed (int): Начальное значение.
        multiplier (int): Множитель.
        addend (int): Добавляемое значение.
        modulus (int): Модуль.

    Returns:
        float: Псевдослучайное число в диапазоне [0, 1).
    """
```

**Назначение**: Генерирует псевдослучайное число с использованием общих параметров.

**Параметры**:
- `seed` (int): Начальное значение.
- `multiplier` (int): Множитель.
- `addend` (int): Добавляемое значение.
- `modulus` (int): Модуль.

**Возвращает**:
- `float`: Псевдослучайное число в диапазоне [0, 1).

**Как работает функция**:

1. **Вычисление `a`**: Вычисляет значение `a` как `seed * multiplier + addend`.
2. **Обработка отрицательных значений**: Если `a` отрицательное, возвращает `((a % modulus) - modulus) / modulus`.
3. **Обработка положительных значений**: Если `a` положительное, возвращает `(a % modulus) / modulus`.

```text
Начало
  ↓
Вычисление a = seed * multiplier + addend
  ↓
a < 0?
  |
  → Да: ((a % modulus) - modulus) / modulus
  |
  → Нет: (a % modulus) / modulus
  ↓
Конец
```

**Примеры**:

```python
# Пример использования prng_general
seed = 123
multiplier = 456
addend = 789
modulus = 1000
result = prng_general(seed, multiplier, addend, modulus)
print(result)
```

### `generate_challenge_seed`

```python
def generate_challenge_seed(l):
    """Генерирует seed для challenge на основе входных данных.

    Args:
        l (list): Входные данные.

    Returns:
        int: Seed для challenge.
    """
```

**Назначение**: Генерирует seed для challenge на основе входных данных.

**Параметры**:
- `l` (list): Входные данные.

**Возвращает**:
- `int`: Seed для challenge.

**Как работает функция**:

1. **Преобразование в строку**: Преобразует входные данные `l` в детерминированную строку JSON с помощью функции `deterministic_stringify`.
2. **URL-кодирование**: URL-кодирует полученную строку, используя `parse.quote`.
3. **Вычисление хеша**: Вычисляет хеш полученной строки с помощью функции `simple_hash`.

```text
Начало
  ↓
Преобразование в строку (deterministic_stringify)
  ↓
URL-кодирование
  ↓
Вычисление хеша (simple_hash)
  ↓
Конец
```

**Примеры**:

```python
# Пример использования generate_challenge_seed
data = {"a": 1, "b": 2}
result = generate_challenge_seed(data)
print(result)
```

### `simple_hash`

```python
def simple_hash(s):
    """Вычисляет простой хеш строки.

    Args:
        s (str): Входная строка.

    Returns:
        int: Хеш строки.
    """
```

**Назначение**: Вычисляет простой хеш строки.

**Параметры**:
- `s` (str): Входная строка.

**Возвращает**:
- `int`: Хеш строки.

**Как работает функция**:

1. **Инициализация**: Инициализирует переменную `d` значением 0.
2. **Итерация по символам**: Итерируется по каждому символу входной строки `s`.
3. **Проверка символов**: Проверяет длину символа и его код. Если длина символа больше 1 или код символа больше или равен 256, символ пропускается.
4. **Вычисление хеша**: Вычисляет хеш как `((d << 5) - d + ord(char[0])) & 0xFFFFFFFF`.
5. **Обработка переполнения**: Если `d` больше `0x7FFFFFFF`, вычитает `0x100000000`.

```text
Начало
  ↓
Инициализация d = 0
  ↓
Итерация по символам строки
  ↓
Проверка символа (длина > 1 или код >= 256)?
  |
  → Да: Пропустить символ
  |
  → Нет: Вычисление хеша
  ↓
Обработка переполнения
  ↓
Конец
```

**Примеры**:

```python
# Пример использования simple_hash
text = "hello"
result = simple_hash(text)
print(result)
```

### `generate_challenge`

```python
def generate_challenge(obj, **kwargs):
    """Генерирует challenge на основе объекта и параметров.

    Args:
        obj (dict): Объект для генерации challenge.
        **kwargs: Параметры для функции prng_general.

    Returns:
        float: Сгенерированный challenge.
    """
```

**Назначение**: Генерирует challenge на основе объекта и параметров.

**Параметры**:
- `obj` (dict): Объект для генерации challenge.
- `**kwargs`: Параметры для функции `prng_general`.

**Возвращает**:
- `float`: Сгенерированный challenge.

**Как работает функция**:

1. **Генерация seed**: Генерирует seed с использованием функции `generate_challenge_seed`.
2. **Вызов prng_general**: Вызывает функцию `prng_general` с seed и параметрами `kwargs`.

```text
Начало
  ↓
Генерация seed (generate_challenge_seed)
  ↓
Вызов prng_general
  ↓
Конец
```

**Примеры**:

```python
# Пример использования generate_challenge
data = {"a": 1, "b": 2}
kwargs = {"multiplier": 456, "addend": 789, "modulus": 1000}
result = generate_challenge(data, **kwargs)
print(result)