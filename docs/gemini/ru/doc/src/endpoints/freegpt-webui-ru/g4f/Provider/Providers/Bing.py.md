# Модуль для взаимодействия с Bing Chat API
## Обзор

Модуль `Bing.py` предоставляет интерфейс для взаимодействия с Bing Chat API. Он включает в себя функции для создания бесед, генерации ответов в потоковом режиме и форматирования сообщений. Модуль поддерживает как обычные запросы, так и запросы с контекстом, а также позволяет настраивать параметры запроса с помощью опций.

## Подробней

Модуль предназначен для интеграции с другими частями проекта `hypotez`, где требуется взаимодействие с Bing Chat API.
Он использует асинхронные запросы для обеспечения неблокирующего взаимодействия с сервером Bing.

## Классы

### `optionsSets`

**Описание**: Класс, содержащий наборы опций для настройки поведения Bing Chat.

**Атрибуты**:

- `optionSet` (dict): Словарь, определяющий структуру набора опций.
- `jailbreak` (dict): Словарь с набором опций для "jailbreak" режима.

### `Defaults`

**Описание**: Класс, содержащий значения по умолчанию для различных параметров запроса.

**Атрибуты**:

- `delimiter` (str): Разделитель сообщений.
- `ip_address` (str): IP-адрес для использования в запросах.
- `allowedMessageTypes` (list): Список допустимых типов сообщений.
- `sliceIds` (list): Список идентификаторов срезов.
- `location` (dict): Информация о местоположении.

## Функции

### `_format`

```python
def _format(msg: dict) -> str:
    """
    Форматирует сообщение в JSON-формат и добавляет разделитель.

    Args:
        msg (dict): Словарь с сообщением.

    Returns:
        str: JSON-представление сообщения с разделителем.
    """
```

**Назначение**: Форматирует словарь `msg` в JSON-строку и добавляет разделитель `Defaults.delimiter` в конце.
Это необходимо для правильной передачи сообщений в Bing Chat API.

**Параметры**:
- `msg` (dict): Словарь, представляющий сообщение для отправки.

**Возвращает**:
- `str`: JSON-строка, представляющая сообщение с добавленным разделителем.

**Как работает функция**:
1. Преобразует входящий словарь `msg` в JSON-формат с помощью `json.dumps()`. `ensure_ascii=False` обеспечивает правильную обработку не-ASCII символов.
2. Добавляет разделитель `Defaults.delimiter` в конец JSON-строки.

**ASCII flowchart**:
```
    msg (dict)
    |
    json.dumps(msg, ensure_ascii=False)
    |
    + Defaults.delimiter
    |
    JSON-строка с разделителем
```

**Примеры**:

```python
message = {'text': 'Привет мир!'}
formatted_message = _format(message)
print(formatted_message)
```

### `create_conversation`

```python
async def create_conversation():
    """
    Создает новую беседу с Bing Chat API.

    Returns:
        tuple[str, str, str]: Идентификатор беседы, идентификатор клиента и сигнатура беседы.

    Raises:
        Exception: Если не удалось создать беседу после нескольких попыток.
    """
```

**Назначение**: Функция `create_conversation` асинхронно создает новую беседу с Bing Chat API. Она выполняет несколько попыток запроса к API и возвращает идентификатор беседы, идентификатор клиента и сигнатуру беседы.

**Возвращает**:
- `tuple[str, str, str]`: Кортеж, содержащий:
  - `conversationId` (str): Идентификатор беседы.
  - `clientId` (str): Идентификатор клиента.
  - `conversationSignature` (str): Сигнатура беседы.

**Вызывает исключения**:
- `Exception`: Вызывается, если не удалось создать беседу после 5 попыток.

**Как работает функция**:
1. Функция выполняет цикл из 5 попыток для создания беседы.
2. Внутри цикла отправляется GET-запрос к `https://www.bing.com/turing/conversation/create` с определенными заголовками, имитирующими запрос от браузера.
3. Заголовки включают информацию о браузере, IP-адрес и другие параметры.
4. Если запрос успешен, функция извлекает `conversationId`, `clientId` и `conversationSignature` из JSON-ответа.
5. Если все три значения успешно получены, функция возвращает их.
6. Если после 5 попыток не удалось получить все необходимые значения, вызывается исключение `Exception('Failed to create conversation.')`.

**ASCII flowchart**:

```
    Начало
    |
    Цикл (5 попыток)
    |
    GET-запрос к Bing API
    |
    Извлечение conversationId, clientId, conversationSignature
    |
    Успех?
    |   да
    Выход: conversationId, clientId, conversationSignature
    |   нет
    Конец цикла
    |
    Вызов исключения: Failed to create conversation.
```

**Примеры**:

```python
conversation_id, client_id, conversation_signature = await create_conversation()
print(f"Conversation ID: {conversation_id}")
print(f"Client ID: {client_id}")
print(f"Conversation Signature: {conversation_signature}")
```

### `stream_generate`

```python
async def stream_generate(prompt: str, mode: optionsSets.optionSet = optionsSets.jailbreak, context: bool | str = False):
    """
    Генерирует ответы от Bing Chat API в потоковом режиме.

    Args:
        prompt (str): Текст запроса.
        mode (optionsSets.optionSet, optional): Набор опций для настройки поведения чата. По умолчанию optionsSets.jailbreak.
        context (bool | str, optional): Контекст для запроса. По умолчанию False.

    Yields:
        str: Части ответа от Bing Chat API.

    Raises:
        Exception: Если произошла ошибка при получении ответа от API.
    """
```

**Назначение**: Функция `stream_generate` асинхронно генерирует ответы от Bing Chat API в потоковом режиме. Она устанавливает соединение WebSocket с сервером Bing, отправляет запрос с заданным текстом и контекстом, и затем возвращает части ответа по мере их поступления.

**Параметры**:

- `prompt` (str): Текст запроса, который будет отправлен в Bing Chat API.
- `mode` (optionsSets.optionSet, optional): Набор опций для настройки поведения чата. По умолчанию используется `optionsSets.jailbreak`.
- `context` (bool | str, optional): Контекст для запроса. Может быть `False` (без контекста) или строкой с контекстной информацией. По умолчанию `False`.

**Yields**:

- `str`: Части ответа от Bing Chat API. Функция является генератором и возвращает части ответа по мере их поступления.

**Вызывает исключения**:

- `Exception`: Вызывается, если произошла ошибка при получении ответа от API, например, если сервер возвращает сообщение об ошибке.

**Как работает функция**:

1.  **Инициализация**:
    *   Устанавливает таймаут для HTTP-клиента.
    *   Создает асинхронную сессию HTTP-клиента.
    *   Получает идентификатор беседы, идентификатор клиента и сигнатуру беседы, вызывая функцию `create_conversation`.
2.  **Установка соединения WebSocket**:
    *   Устанавливает соединение WebSocket с сервером Bing Chat API (`wss://sydney.bing.com/sydney/ChatHub`) с использованием SSL-контекста и заголовков.
3.  **Отправка начальных сообщений**:
    *   Отправляет начальное сообщение для установки протокола (`{\'protocol\': \'json\', \'version\': 1}`).
    *   Получает подтверждение от сервера.
4.  **Формирование структуры запроса**:
    *   Создает структуру запроса, включающую текст запроса (`prompt`), параметры режима (`mode`), идентификаторы срезов (`Defaults.sliceIds`), информацию о местоположении (`Defaults.location`) и другие параметры.
    *   Если предоставлен контекст (`context`), добавляет его в структуру запроса.
5.  **Отправка запроса**:
    *   Отправляет структуру запроса на сервер через WebSocket.
6.  **Обработка ответов**:
    *   В цикле ожидает поступления сообщений от сервера.
    *   Разделяет полученные данные на объекты, используя разделитель `Defaults.delimiter`.
    *   Обрабатывает каждый объект:
        *   Если объект содержит сообщение (type=1) и не является сообщением об извинении, извлекает текст сообщения и возвращает его часть (yield).
        *   Если объект содержит ошибку (type=2), вызывает исключение с информацией об ошибке.
        *   Определяет, является ли ответ последним (final=True) на основе определенных условий.
7.  **Завершение**:
    *   Закрывает соединение WebSocket и HTTP-сессию после получения последнего ответа или в случае ошибки.

**ASCII flowchart**:

```
    Начало
    |
    Инициализация (таймаут, сессия, получение conversationId, clientId, conversationSignature)
    |
    Установка соединения WebSocket
    |
    Отправка начальных сообщений (протокол, версия)
    |
    Формирование структуры запроса (prompt, mode, context, и т.д.)
    |
    Отправка запроса через WebSocket
    |
    Цикл обработки ответов
    |
    Получение сообщения от сервера
    |
    Разделение данных на объекты
    |
    Обработка каждого объекта
    |   Сообщение (type=1)?
    |   да
    |   Извлечение текста сообщения
    |   Возврат части сообщения (yield)
    |   Ошибка (type=2)?
    |   да
    |   Вызов исключения с информацией об ошибке
    |   Конец ответа (final=True)?
    |   да
    |   Завершение (закрытие WebSocket и HTTP-сессии)
    |   нет
    Конец цикла
    |
    Конец
```

**Примеры**:

```python
async def main():
    prompt = "Расскажи о себе"
    async for response_part in stream_generate(prompt):
        print(response_part, end="", flush=True)

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())
```

### `run`

```python
def run(generator):
    """
    Запускает асинхронный генератор и возвращает его значения.

    Args:
        generator: Асинхронный генератор.

    Yields:
        Any: Значения, возвращаемые генератором.
    """
```

**Назначение**: Функция `run` предназначена для запуска асинхронного генератора и извлечения его значений. Она позволяет синхронно итерироваться по асинхронному генератору, что может быть полезно в контекстах, где асинхронность не поддерживается напрямую.

**Параметры**:
- `generator`: Асинхронный генератор, который необходимо запустить.

**Yields**:
- `Any`: Значения, возвращаемые асинхронным генератором.

**Как работает функция**:

1.  **Получение event loop**: Получает текущий event loop asyncio с помощью asyncio.get_event_loop().
2.  **Создание асинхронного итератора**: Преобразует переданный генератор в асинхронный итератор с помощью generator.\_\_aiter\_\_().
3.  **Итерация по генератору**:
    *   В бесконечном цикле пытается получить следующее значение из асинхронного итератора с помощью gen.\_\_anext\_\_().
    *   Использует loop.run\_until\_complete() для ожидания завершения асинхронной операции получения следующего значения.
    *   Возвращает полученное значение с помощью yield.
4.  **Обработка исключения StopAsyncIteration**:
    *   Если асинхронный итератор завершается, выбрасывается исключение StopAsyncIteration.
    *   Функция перехватывает это исключение и завершает свою работу.

**ASCII flowchart**:

```
    Начало
    |
    Получение event loop
    |
    Создание асинхронного итератора
    |
    Цикл
    |
    Получение следующего значения из асинхронного итератора
    |
    Ожидание завершения асинхронной операции
    |
    Возврат значения (yield)
    |
    StopAsyncIteration?
    |   да
    |   Выход из цикла
    |   нет
    |   Продолжение цикла
    |
    Конец
```

**Примеры**:

```python
async def my_async_generator():
    yield 1
    await asyncio.sleep(1)
    yield 2
    await asyncio.sleep(1)
    yield 3

def main():
    for value in run(my_async_generator()):
        print(value)

if __name__ == "__main__":
    import asyncio
    main()
```

### `convert`

```python
def convert(messages):
    """
    Преобразует список сообщений в контекст для Bing Chat API.

    Args:
        messages (list): Список сообщений.

    Returns:
        str: Контекст для Bing Chat API.
    """
```

**Назначение**: Функция `convert` преобразует список сообщений в строку контекста, пригодную для использования в запросах к Bing Chat API.

**Параметры**:
- `messages` (list): Список сообщений, где каждое сообщение представляет собой словарь с ключами `role` и `content`.

**Возвращает**:
- `str`: Строка контекста, сформированная из списка сообщений.

**Как работает функция**:

1.  **Инициализация контекста**: Создает пустую строку `context` для накопления преобразованного контекста.
2.  **Итерация по сообщениям**: Перебирает каждое сообщение в списке `messages`.
3.  **Форматирование сообщения**: Для каждого сообщения формирует строку в формате `"[роль](#message)\nсодержимое\n\n"`, где `роль` - роль автора сообщения (например, "user" или "assistant"), а `содержимое` - текст сообщения.
4.  **Добавление в контекст**: Добавляет отформатированную строку сообщения в строку `context`.
5.  **Возврат контекста**: Возвращает строку `context`, содержащую все сообщения, объединенные в формате, пригодном для использования в Bing Chat API.

**ASCII flowchart**:

```
    Начало
    |
    Инициализация context = ""
    |
    Цикл по messages
    |
    Форматирование сообщения: "[role](#message)\ncontent\n\n"
    |
    context += отформатированное сообщение
    |
    Конец цикла
    |
    Возврат context
    |
    Конец
```

**Примеры**:

```python
messages = [
    {'role': 'user', 'content': 'Привет!'},
    {'role': 'assistant', 'content': 'Здравствуйте!'}
]
context = convert(messages)
print(context)
```

### `_create_completion`

```python
def _create_completion(model: str, messages: list, stream: bool, **kwargs):
    """
    Создает запрос к Bing Chat API и возвращает ответ.

    Args:
        model (str): Модель для использования.
        messages (list): Список сообщений.
        stream (bool): Флаг потоковой передачи.
        **kwargs: Дополнительные аргументы.

    Yields:
        str: Части ответа от Bing Chat API.
    """
```

**Назначение**: Функция `_create_completion` создает запрос к Bing Chat API и возвращает ответ. Она принимает список сообщений, модель и флаг потоковой передачи в качестве аргументов.

**Параметры**:

-   `model` (str): Модель, которую следует использовать для создания ответа.
-   `messages` (list): Список сообщений, составляющих контекст для запроса. Каждое сообщение должно быть словарем с ключами `role` (роль отправителя) и `content` (содержимое сообщения).
-   `stream` (bool): Флаг, указывающий, следует ли возвращать ответ в потоковом режиме.
-   `\*\*kwargs`: Дополнительные аргументы, которые могут быть переданы в функцию.

**Yields**:

-   `str`: Части ответа от Bing Chat API, если `stream` равен `True`.

**Как работает функция**:

1.  **Определение запроса и контекста**:
    *   Если в списке сообщений меньше двух элементов, функция считает, что предоставлен только запрос (`prompt`), и устанавливает `context` в `False`.
    *   В противном случае функция считает, что предоставлен контекст, и устанавливает `prompt` равным последнему сообщению в списке, а `context` - результатом преобразования предыдущих сообщений с помощью функции `convert`.
2.  **Вызов функции `stream_generate`**:
    *   Вызывает функцию `stream_generate` с `prompt`, набором параметров `optionsSets.jailbreak` и `context`.
    *   Функция `stream_generate` возвращает генератор, который выдает части ответа от Bing Chat API.
3.  **Потоковая передача ответа**:
    *   Итерируется по генератору, возвращенному функцией `stream_generate`, и передает каждую часть ответа вызывающей стороне с помощью `yield`.

**ASCII flowchart**:

```
    Начало
    |
    Определение запроса и контекста
    |
    Вызов stream_generate(prompt, optionsSets.jailbreak, context)
    |
    Цикл по частям ответа, возвращаемым stream_generate
    |
    Передача каждой части ответа (yield)
    |
    Конец цикла
    |
    Конец
```

**Примеры**:

```python
async def main():
    messages = [
        {'role': 'user', 'content': 'Привет!'},
        {'role': 'assistant', 'content': 'Как дела?'}
    ]
    stream = True
    async for token in _create_completion(model='gpt-4', messages=messages, stream=stream):
        print(token, end="")

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())
```

### `params`

**Описание**: Строка, содержащая информацию о поддерживаемых параметрах функции `_create_completion`.

## Переменные

- `url` (str): URL для Bing Chat.
- `model` (list): Список поддерживаемых моделей.
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи.
- `needs_auth` (bool): Флаг, указывающий на необходимость аутентификации.
- `ssl_context`: Контекст SSL для безопасного соединения.