# Модуль `js_api.py`

## Обзор

Модуль предоставляет класс `JsApi`, который является API для взаимодействия JavaScript-кода с бэкендом приложения. Он включает в себя методы для получения и отправки сообщений, выбора изображений, работы с камерой и управления пользовательским интерфейсом. Этот модуль является частью графического интерфейса `gpt4free`, обеспечивая связь между веб-интерфейсом и логикой обработки запросов к моделям ИИ.

## Подробней

Модуль `js_api.py` служит мостом между JavaScript-кодом, выполняющимся в пользовательском интерфейсе, и Python-кодом, выполняющим логику обработки запросов к моделям ИИ. Он предоставляет набор функций, которые могут быть вызваны из JavaScript для выполнения определенных действий на стороне сервера, таких как получение ответов от моделей ИИ, выбор изображений с устройства пользователя или управление состоянием пользовательского интерфейса.

## Классы

### `JsApi`

**Описание**: Класс `JsApi` расширяет класс `Api` и предоставляет API для взаимодействия JavaScript-кода с бэкендом приложения.

**Наследует**:
- `Api`: Наследует методы для взаимодействия с API, такие как получение версий, моделей и провайдеров.

**Методы**:

- `get_conversation(options: dict, message_id: str = None, scroll: bool = None) -> Iterator`:
  Получает разговор с учетом заданных параметров и отправляет сообщения через JavaScript.
- `choose_image()`:
  Позволяет пользователю выбрать изображение с устройства.
- `take_picture()`:
  Позволяет пользователю сделать снимок с камеры устройства.
- `on_image_selection(filename)`:
  Обрабатывает выбор изображения пользователем.
- `on_camera(filename)`:
  Обрабатывает снимок, сделанный с камеры устройства.
- `set_selected(input_id: str = None)`:
  Устанавливает визуальное состояние выбранного элемента интерфейса.
- `get_version()`:
  Возвращает версию API.
- `get_models()`:
  Возвращает список доступных моделей.
- `get_providers()`:
  Возвращает список доступных провайдеров.
- `get_provider_models(provider: str, **kwargs)`:
  Возвращает список моделей, доступных для указанного провайдера.

## Функции

### `get_conversation`

```python
def get_conversation(self, options: dict, message_id: str = None, scroll: bool = None) -> Iterator:
    """Получает разговор с учетом заданных параметров и отправляет сообщения через JavaScript.

    Args:
        options (dict): Словарь с опциями для разговора.
        message_id (str, optional): Идентификатор сообщения. По умолчанию `None`.
        scroll (bool, optional): Флаг для прокрутки. По умолчанию `None`.

    Returns:
        Iterator: Итератор сообщений.
    """
```

**Назначение**: Метод `get_conversation` используется для получения сообщений из потока ответов, подготовленного на основе заданных параметров разговора, и отправки этих сообщений в JavaScript-код для отображения в пользовательском интерфейсе.

**Параметры**:
- `options` (dict): Словарь, содержащий параметры разговора, такие как `conversation_id`, `provider`, и, возможно, изображение.
- `message_id` (str, optional): Идентификатор сообщения, который может быть использован для обновления конкретного сообщения в интерфейсе. По умолчанию `None`.
- `scroll` (bool, optional): Флаг, указывающий, нужно ли прокручивать интерфейс к новому сообщению. По умолчанию `None`.

**Возвращает**:
- `Iterator`: Итератор, предоставляющий доступ к сообщениям в разговоре.

**Как работает функция**:

1. **Подготовка параметров**: Функция извлекает параметры разговора из словаря `options`, включая `conversation_id` и `provider`. Если в `options` присутствует изображение, оно открывается в бинарном режиме и добавляется в параметры.
2. **Создание потока ответов**: Вызывается метод `self._create_response_stream` для получения потока сообщений на основе подготовленных параметров.
3. **Отправка сообщений в JavaScript**: Для каждого сообщения из потока выполняется JavaScript-код с использованием `window.evaluate_js`. Этот код добавляет сообщение в интерфейс, используя функцию `add_message_chunk`.
4. **Проверка остановки**: После отправки каждого сообщения проверяется, не была ли остановлена отправка сообщений с помощью функции `is_stopped()`, выполняемой в JavaScript-коде. Если отправка остановлена, цикл прерывается.
5. **Сброс состояния**: После завершения отправки сообщений переменная `self.image` сбрасывается в `None`, и вызывается метод `self.set_selected(None)`.

**Внутренние функции**:
- `_create_response_stream`: Создает поток ответов на основе параметров разговора.
- `_prepare_conversation_kwargs`: Подготавливает параметры для запроса разговора.
- `add_message_chunk` (JavaScript): Добавляет фрагмент сообщения в пользовательский интерфейс.
- `is_stopped` (JavaScript): Проверяет, была ли остановлена отправка сообщений.
- `set_selected`: Сбрасывает состояние выбранного элемента интерфейса.

**ASCII Flowchart**:

```
Опции разговора --> Подготовка параметров
    |
    --> Создание потока ответов --> Получение сообщения
    |                                   |
    |                                   --> Отправка сообщения в JavaScript --> Проверка остановки
    |                                                                           |
    -----------------------------------------------------------------------------
    |
    --> Сброс состояния
```

**Примеры**:

```python
# Пример вызова функции get_conversation
options = {
    "conversation_id": "123",
    "provider": "openai",
    "message": "Hello, world!"
}
for message in js_api_instance.get_conversation(options):
    print(message)
```

### `choose_image`

```python
def choose_image(self):
    """Позволяет пользователю выбрать изображение с устройства."""
```

**Назначение**: Метод `choose_image` открывает диалоговое окно выбора файла, позволяя пользователю выбрать изображение из файловой системы устройства.

**Как работает функция**:

1. **Вызов диалогового окна**: Функция вызывает `filechooser.open_file` с параметрами, указывающими на каталог изображений пользователя и поддерживаемые форматы файлов (jpg, jpeg, png, webp, svg).
2. **Обработка выбора**: После выбора файла вызывается функция `self.on_image_selection` с путем к выбранному файлу.

### `take_picture`

```python
def take_picture(self):
    """Позволяет пользователю сделать снимок с камеры устройства."""
```

**Назначение**: Метод `take_picture` активирует камеру устройства и позволяет пользователю сделать снимок, который затем сохраняется в файловой системе.

**Как работает функция**:

1. **Генерация имени файла**: Функция генерирует уникальное имя файла для сохранения снимка, используя `uuid4()` и путь к каталогу изображений пользователя.
2. **Активация камеры**: Вызывается функция `camera.take_picture` с указанием имени файла и функции обратного вызова `self.on_camera`.

### `on_image_selection`

```python
def on_image_selection(self, filename):
    """Обрабатывает выбор изображения пользователем.

    Args:
        filename (str): Путь к выбранному файлу изображения.
    """
```

**Назначение**: Метод `on_image_selection` обрабатывает путь к файлу, выбранному пользователем через диалоговое окно выбора файла.

**Параметры**:
- `filename` (str): Путь к выбранному файлу изображения.

**Как работает функция**:

1. **Извлечение имени файла**: Если `filename` является списком, извлекается первый элемент.
2. **Проверка файла**: Проверяется, существует ли файл по указанному пути.
3. **Установка изображения**: Если файл существует, путь к файлу сохраняется в атрибуте `self.image`. В противном случае `self.image` устанавливается в `None`.
4. **Обновление состояния**: Вызывается метод `self.set_selected` для обновления визуального состояния элемента интерфейса.

### `on_camera`

```python
def on_camera(self, filename):
    """Обрабатывает снимок, сделанный с камеры устройства.

    Args:
        filename (str): Путь к файлу с сделанным снимком.
    """
```

**Назначение**: Метод `on_camera` обрабатывает путь к файлу, содержащему снимок, сделанный с камеры устройства.

**Параметры**:
- `filename` (str): Путь к файлу с сделанным снимком.

**Как работает функция**:

1. **Проверка файла**: Проверяется, существует ли файл по указанному пути.
2. **Установка изображения**: Если файл существует, путь к файлу сохраняется в атрибуте `self.image`. В противном случае `self.image` устанавливается в `None`.
3. **Обновление состояния**: Вызывается метод `self.set_selected` для обновления визуального состояния элемента интерфейса.

### `set_selected`

```python
def set_selected(self, input_id: str = None):
    """Устанавливает визуальное состояние выбранного элемента интерфейса.

    Args:
        input_id (str, optional): Идентификатор выбранного элемента. По умолчанию `None`.
    """
```

**Назначение**: Метод `set_selected` управляет визуальным состоянием выбранных элементов интерфейса, добавляя или удаляя класс `selected` в зависимости от переданного `input_id`.

**Параметры**:
- `input_id` (str, optional): Идентификатор выбранного элемента интерфейса (`image` или `camera`). По умолчанию `None`.

**Как работает функция**:

1. **Получение окна**: Функция пытается получить главное окно приложения `webview`.
2. **Удаление класса `selected`**: Если окно существует, функция выполняет JavaScript-код, который удаляет класс `selected` у любого элемента с классом `image-label.selected`.
3. **Добавление класса `selected`**: Если `input_id` не равен `None` и равен `"image"` или `"camera"`, функция выполняет JavaScript-код, который добавляет класс `selected` элементу `<label>`, связанному с указанным `input_id`.

### `get_version`

```python
def get_version(self):
    """Возвращает версию API."""
```

**Назначение**: Метод `get_version` возвращает версию API, используя метод `get_version` родительского класса `Api`.

### `get_models`

```python
def get_models(self):
    """Возвращает список доступных моделей."""
```

**Назначение**: Метод `get_models` возвращает список доступных моделей, используя метод `get_models` родительского класса `Api`.

### `get_providers`

```python
def get_providers(self):
    """Возвращает список доступных провайдеров."""
```

**Назначение**: Метод `get_providers` возвращает список доступных провайдеров, используя метод `get_providers` родительского класса `Api`.

### `get_provider_models`

```python
def get_provider_models(self, provider: str, **kwargs):
    """Возвращает список моделей, доступных для указанного провайдера.

    Args:
        provider (str): Идентификатор провайдера.
        **kwargs: Дополнительные аргументы.

    Returns:
        Список моделей, доступных для указанного провайдера.
    """
```

**Назначение**: Метод `get_provider_models` возвращает список моделей, доступных для указанного провайдера, используя метод `get_provider_models` родительского класса `Api`.

**Параметры**:
- `provider` (str): Идентификатор провайдера.
- `**kwargs`: Дополнительные аргументы.

**Как работает функция**:
Функция вызывает метод `get_provider_models` родительского класса `Api` с переданными параметрами и возвращает результат.