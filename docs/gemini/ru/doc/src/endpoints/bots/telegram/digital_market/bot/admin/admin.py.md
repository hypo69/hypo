# Модуль для управления административной частью Telegram-бота для цифрового рынка
=========================================================================================

Модуль содержит набор обработчиков для управления административной частью Telegram-бота, включая добавление, удаление и просмотр статистики товаров. Он использует `aiogram` для обработки входящих запросов и `SQLAlchemy` для взаимодействия с базой данных.

## Обзор

В данном модуле реализованы функции для администрирования Telegram-бота, такие как просмотр статистики, управление товарами (добавление, удаление). Модуль использует конечные автоматы (FSM) для управления состояниями при добавлении товара.

## Подробней

Модуль предназначен для администрирования цифрового рынка через Telegram-бота. Он предоставляет администраторам возможность просматривать статистику пользователей и заказов, а также управлять каталогом товаров (добавлять, удалять).
Модуль использует роутеры (`Router`) из библиотеки `aiogram` для обработки различных типов входящих запросов (callback-запросы и текстовые сообщения) и FSM для управления процессом добавления товара.

## Классы

### `AddProduct`

**Описание**: Класс, представляющий состояния для процесса добавления нового товара.
**Наследует**: `StatesGroup` из `aiogram.fsm.state`.

**Атрибуты**:
- `name` (State): Состояние для ввода названия товара.
- `description` (State): Состояние для ввода описания товара.
- `price` (State): Состояние для ввода цены товара.
- `file_id` (State): Состояние для загрузки файла товара.
- `category_id` (State): Состояние для выбора категории товара.
- `hidden_content` (State): Состояние для ввода скрытого контента товара.
- `confirm_add` (State): Состояние для подтверждения добавления товара.

## Функции

### `start_admin`

```python
async def start_admin(call: CallbackQuery):
    """
    Обработчик callback-запроса для входа в админ-панель.

    Args:
        call (CallbackQuery): Объект callback-запроса.

    Raises:
        Exception: Если происходит ошибка при открытии админ-панели.
    """
```

**Назначение**: Обрабатывает callback-запрос `admin_panel` для предоставления доступа к панели администратора.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса, содержащий информацию о запросе от пользователя.

**Возвращает**: Ничего. Функция отправляет сообщение пользователю с интерфейсом админ-панели.

**Вызывает исключения**:
- `Exception`: Обрабатывается внутри функции для случаев, когда не удается отредактировать или отправить сообщение.

**Как работает функция**:
1. Отвечает на callback-запрос, подтверждая доступ к админ-панели.
2. Пытается отредактировать предыдущее сообщение, чтобы отобразить интерфейс админ-панели.
3. Если редактирование не удаётся, пытается удалить предыдущее сообщение и отправить новое с интерфейсом админ-панели.
4. В случае неудачи отправки сообщения, отправляет сообщение об ошибке.

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении callback-запроса)
# await start_admin(callback_query)
```

### `admin_statistic`

```python
async def admin_statistic(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Получает и отображает статистику пользователей и заказов.

    Args:
        call (CallbackQuery): Объект callback-запроса.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных.
    """
```

**Назначение**: Обрабатывает callback-запрос `statistic` для получения и отображения статистики пользователей и заказов.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса, содержащий информацию о запросе от пользователя.
- `session_without_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных.

**Возвращает**: Ничего. Функция отправляет сообщение с статистикой пользователям и заказам.

**Как работает функция**:

1. Отвечает на callback-запрос, уведомляя о начале сбора статистики.
2. Получает статистику пользователей с помощью `UserDAO.get_statistics`.
3. Получает статистику заказов с помощью `PurchaseDao.get_payment_stats`.
4. Формирует текстовое сообщение, содержащее статистику пользователей (общее количество, новые за сегодня, неделю, месяц) и статистику по заказам.
5. Отправляет отредактированное сообщение с статистикой в админ-панель.

ASCII flowchart:

```
A: Получение callback-запроса
│
B: Получение статистики пользователей (UserDAO.get_statistics)
│
C: Получение статистики заказов (PurchaseDao.get_payment_stats)
│
D: Формирование текстового сообщения
│
E: Отправка сообщения с статистикой
```

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении callback-запроса)
# await admin_statistic(callback_query, async_session)
```

### `admin_process_cancel`

```python
async def admin_process_cancel(call: CallbackQuery, state: FSMContext):
    """
    Обрабатывает отмену сценария добавления товара.

    Args:
        call (CallbackQuery): Объект callback-запроса.
        state (FSMContext): Контекст конечного автомата для управления состоянием.
    """
```

**Назначение**: Обрабатывает callback-запрос `cancel` для отмены текущего сценария добавления товара.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса, содержащий информацию о запросе от пользователя.
- `state` (FSMContext): Контекст конечного автомата для управления состоянием.

**Возвращает**: Ничего. Функция отправляет сообщение об отмене добавления товара.

**Как работает функция**:
1. Очищает состояние FSM, чтобы сбросить все данные, связанные с добавлением товара.
2. Отвечает на callback-запрос, уведомляя об отмене сценария.
3. Удаляет предыдущее сообщение.
4. Отправляет новое сообщение с подтверждением отмены и возвратом в админ-панель.

ASCII flowchart:

```
A: Получение callback-запроса (cancel)
│
B: Очистка состояния FSM (state.clear())
│
C: Удаление предыдущего сообщения
│
D: Отправка сообщения об отмене
```

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении callback-запроса)
# await admin_process_cancel(callback_query, fsm_context)
```

### `admin_process_start_dell`

```python
async def admin_process_start_dell(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обрабатывает начало процесса удаления товара.

    Args:
        call (CallbackQuery): Объект callback-запроса.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных.
    """
```

**Назначение**: Обрабатывает callback-запрос `delete_product` для запуска процесса удаления товара.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса, содержащий информацию о запросе от пользователя.
- `session_without_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных.

**Как работает функция**:

1. Отвечает на callback-запрос, подтверждая начало режима удаления товаров.
2. Получает список всех товаров из базы данных с помощью `ProductDao.find_all`.
3. Редактирует сообщение, чтобы отобразить информацию о количестве товаров в базе данных.
4. Для каждого товара формирует текстовое описание, содержащее название, описание, цену и скрытое содержимое.
5. Если у товара есть файл (file_id), отправляет документ с описанием товара и кнопкой для удаления.
6. Если у товара нет файла, отправляет текстовое сообщение с описанием товара и кнопкой для удаления.

ASCII flowchart:

```
A: Получение callback-запроса (delete_product)
│
B: Получение списка всех товаров (ProductDao.find_all)
│
C: Редактирование сообщения с информацией о количестве товаров
│
D: Цикл по товарам:
    │
    ├── E1: Формирование текстового описания товара
    │
    ├── E2: Проверка наличия файла (file_id)
    │   │
    │   ├── F1: Отправка документа (если есть файл)
    │   │
    │   └── F2: Отправка текстового сообщения (если нет файла)
    │
    └── Продолжение цикла
```

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении callback-запроса)
# await admin_process_start_dell(callback_query, async_session)
```

### `admin_process_start_dell` (с префиксом 'dell_')

```python
async def admin_process_start_dell(call: CallbackQuery, session_with_commit: AsyncSession):
    """
    Обрабатывает callback-запрос на удаление конкретного товара.

    Args:
        call (CallbackQuery): Объект callback-запроса.
        session_with_commit (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения изменений в базе данных.
    """
```

**Назначение**: Обрабатывает callback-запросы, начинающиеся с `dell_`, для удаления конкретного товара из базы данных.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса, содержащий информацию о запросе от пользователя.
- `session_with_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения изменений в базе данных.

**Как работает функция**:

1. Извлекает ID товара из данных callback-запроса.
2. Удаляет товар из базы данных с помощью `ProductDao.delete`.
3. Отвечает на callback-запрос, уведомляя об успешном удалении товара.
4. Засыпает на 1.5 секунды, чтобы дать время боту обработать изменения.
5. Удаляет сообщение с информацией о товаре.

ASCII flowchart:

```
A: Получение callback-запроса (dell_*)
│
B: Извлечение ID товара
│
C: Удаление товара из базы данных (ProductDao.delete)
│
D: Уведомление об успешном удалении
│
E: Задержка (asyncio.sleep)
│
F: Удаление сообщения
```

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении callback-запроса)
# await admin_process_start_dell(callback_query, async_session)
```

### `admin_process_products`

```python
async def admin_process_products(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обрабатывает callback-запрос для управления товарами.

    Args:
        call (CallbackQuery): Объект callback-запроса.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных.
    """
```

**Назначение**: Обрабатывает callback-запрос `process_products` для отображения интерфейса управления товарами.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса, содержащий информацию о запросе от пользователя.
- `session_without_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных.

**Как работает функция**:

1. Отвечает на callback-запрос, уведомляя о переходе в режим управления товарами.
2. Получает общее количество товаров из базы данных с помощью `ProductDao.count`.
3. Редактирует сообщение, чтобы отобразить количество товаров и предложить варианты действий (добавление, удаление и т.д.).

ASCII flowchart:

```
A: Получение callback-запроса (process_products)
│
B: Получение общего количества товаров (ProductDao.count)
│
C: Редактирование сообщения с предложением действий
```

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении callback-запроса)
# await admin_process_products(callback_query, async_session)
```

### `admin_process_add_product`

```python
async def admin_process_add_product(call: CallbackQuery, state: FSMContext):
    """
    Обрабатывает callback-запрос для начала процесса добавления товара.

    Args:
        call (CallbackQuery): Объект callback-запроса.
        state (FSMContext): Контекст конечного автомата для управления состоянием.
    """
```

**Назначение**: Обрабатывает callback-запрос `add_product` для запуска сценария добавления нового товара.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса, содержащий информацию о запросе от пользователя.
- `state` (FSMContext): Контекст конечного автомата для управления состоянием.

**Как работает функция**:

1. Отвечает на callback-запрос, уведомляя о начале сценария добавления товара.
2. Удаляет предыдущее сообщение.
3. Отправляет сообщение с запросом имени товара.
4. Обновляет состояние FSM, сохраняя ID последнего сообщения.
5. Устанавливает состояние `AddProduct.name`.

ASCII flowchart:

```
A: Получение callback-запроса (add_product)
│
B: Удаление предыдущего сообщения
│
C: Отправка запроса имени товара
│
D: Обновление состояния FSM (last_msg_id)
│
E: Установка состояния AddProduct.name
```

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении callback-запроса)
# await admin_process_add_product(callback_query, fsm_context)
```

### `admin_process_name`

```python
async def admin_process_name(message: Message, state: FSMContext):
    """
    Обрабатывает ввод имени товара.

    Args:
        message (Message): Объект сообщения.
        state (FSMContext): Контекст конечного автомата для управления состоянием.
    """
```

**Назначение**: Обрабатывает сообщение с именем товара, полученное от пользователя, и переводит FSM в состояние ожидания описания товара.

**Параметры**:
- `message` (Message): Объект сообщения, содержащий текст с именем товара.
- `state` (FSMContext): Контекст конечного автомата для управления состоянием.

**Как работает функция**:

1. Обновляет данные в FSM, сохраняя имя товара.
2. Удаляет предыдущее сообщение пользователя.
3. Отправляет сообщение с запросом короткого описания товара.
4. Обновляет состояние FSM, сохраняя ID последнего сообщения.
5. Устанавливает состояние `AddProduct.description`.

ASCII flowchart:

```
A: Получение сообщения с именем товара
│
B: Обновление данных в FSM (name)
│
C: Удаление предыдущего сообщения
│
D: Отправка запроса описания товара
│
E: Обновление состояния FSM (last_msg_id)
│
F: Установка состояния AddProduct.description
```

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении сообщения)
# await admin_process_name(message, fsm_context)
```

### `admin_process_description`

```python
async def admin_process_description(message: Message, state: FSMContext, session_without_commit: AsyncSession):
    """
    Обрабатывает ввод описания товара.

    Args:
        message (Message): Объект сообщения.
        state (FSMContext): Контекст конечного автомата для управления состоянием.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных.
    """
```

**Назначение**: Обрабатывает сообщение с описанием товара, полученное от пользователя, и переводит FSM в состояние выбора категории товара.

**Параметры**:
- `message` (Message): Объект сообщения, содержащий текст с описанием товара.
- `state` (FSMContext): Контекст конечного автомата для управления состоянием.
- `session_without_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных.

**Как работает функция**:

1. Обновляет данные в FSM, сохраняя описание товара.
2. Удаляет предыдущее сообщение пользователя.
3. Получает список категорий товаров из базы данных с помощью `CategoryDao.find_all`.
4. Отправляет сообщение с кнопками для выбора категории товара.
5. Обновляет состояние FSM, сохраняя ID последнего сообщения.
6. Устанавливает состояние `AddProduct.category_id`.

ASCII flowchart:

```
A: Получение сообщения с описанием товара
│
B: Обновление данных в FSM (description)
│
C: Удаление предыдущего сообщения
│
D: Получение списка категорий товаров (CategoryDao.find_all)
│
E: Отправка сообщения с выбором категории
│
F: Обновление состояния FSM (last_msg_id)
│
G: Установка состояния AddProduct.category_id
```

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении сообщения)
# await admin_process_description(message, fsm_context, async_session)
```

### `admin_process_category`

```python
async def admin_process_category(call: CallbackQuery, state: FSMContext):
    """
    Обрабатывает выбор категории товара.

    Args:
        call (CallbackQuery): Объект callback-запроса.
        state (FSMContext): Контекст конечного автомата для управления состоянием.
    """
```

**Назначение**: Обрабатывает выбор категории товара пользователем и переводит FSM в состояние ввода цены товара.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса, содержащий информацию о выбранной категории.
- `state` (FSMContext): Контекст конечного автомата для управления состоянием.

**Как работает функция**:

1. Извлекает ID категории из данных callback-запроса.
2. Обновляет данные в FSM, сохраняя ID категории.
3. Отвечает на callback-запрос, уведомляя об успешном выборе категории.
4. Редактирует сообщение, запрашивая цену товара.
5. Обновляет состояние FSM, сохраняя ID последнего сообщения.
6. Устанавливает состояние `AddProduct.price`.

ASCII flowchart:

```
A: Получение callback-запроса (add_category_*)
│
B: Извлечение ID категории
│
C: Обновление данных в FSM (category_id)
│
D: Уведомление о выборе категории
│
E: Редактирование сообщения с запросом цены
│
F: Обновление состояния FSM (last_msg_id)
│
G: Установка состояния AddProduct.price
```

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении callback-запроса)
# await admin_process_category(callback_query, fsm_context)
```

### `admin_process_price`

```python
async def admin_process_price(message: Message, state: FSMContext):
    """
    Обрабатывает ввод цены товара.

    Args:
        message (Message): Объект сообщения.
        state (FSMContext): Контекст конечного автомата для управления состоянием.
    """
```

**Назначение**: Обрабатывает сообщение с ценой товара, полученное от пользователя, и переводит FSM в состояние ожидания файла товара.

**Параметры**:
- `message` (Message): Объект сообщения, содержащий текст с ценой товара.
- `state` (FSMContext): Контекст конечного автомата для управления состоянием.

**Как работает функция**:

1. Пытается преобразовать текст сообщения в целое число (цену).
2. Если преобразование успешно:
    - Обновляет данные в FSM, сохраняя цену товара.
    - Удаляет предыдущее сообщение пользователя.
    - Отправляет сообщение с запросом файла товара или возможностью отказаться от загрузки файла.
    - Обновляет состояние FSM, сохраняя ID последнего сообщения.
    - Устанавливает состояние `AddProduct.file_id`.
3. Если преобразование не удаётся, отправляет сообщение об ошибке и просит ввести числовое значение.

ASCII flowchart:

```
A: Получение сообщения с ценой товара
│
B: Попытка преобразования текста в число
│
├── C1: Успешно
│   │
│   ├── D1: Обновление данных в FSM (price)
│   │
│   ├── E1: Удаление предыдущего сообщения
│   │
│   ├── F1: Отправка запроса файла товара
│   │
│   ├── G1: Обновление состояния FSM (last_msg_id)
│   │
│   └── H1: Установка состояния AddProduct.file_id
│
└── C2: Ошибка
    │
    └── D2: Отправка сообщения об ошибке
```

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении сообщения)
# await admin_process_price(message, fsm_context)
```

### `admin_process_without_file` (callback_query)

```python
async def admin_process_without_file(call: CallbackQuery, state: FSMContext):
    """
    Обрабатывает отказ от загрузки файла товара.

    Args:
        call (CallbackQuery): Объект callback-запроса.
        state (FSMContext): Контекст конечного автомата для управления состоянием.
    """
```

**Назначение**: Обрабатывает callback-запрос `without_file`, когда пользователь отказывается от загрузки файла для товара, и переводит FSM в состояние ввода скрытого контента.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса, содержащий информацию о запросе от пользователя.
- `state` (FSMContext): Контекст конечного автомата для управления состоянием.

**Как работает функция**:

1. Обновляет данные в FSM, устанавливая `file_id` в `None`.
2. Отвечает на callback-запрос, уведомляя об отсутствии файла.
3. Редактирует сообщение, запрашивая скрытый контент товара.
4. Обновляет состояние FSM, сохраняя ID последнего сообщения.
5. Устанавливает состояние `AddProduct.hidden_content`.

ASCII flowchart:

```
A: Получение callback-запроса (without_file)
│
B: Обновление данных в FSM (file_id = None)
│
C: Уведомление об отсутствии файла
│
D: Редактирование сообщения с запросом скрытого контента
│
E: Обновление состояния FSM (last_msg_id)
│
F: Установка состояния AddProduct.hidden_content
```

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении callback-запроса)
# await admin_process_without_file(callback_query, fsm_context)
```

### `admin_process_without_file` (message)

```python
async def admin_process_without_file(message: Message, state: FSMContext):
    """
    Обрабатывает получение файла товара.

    Args:
        message (Message): Объект сообщения.
        state (FSMContext): Контекст конечного автомата для управления состоянием.
    """
```

**Назначение**: Обрабатывает сообщение с файлом (документом) товара, полученное от пользователя, и переводит FSM в состояние ввода скрытого контента.

**Параметры**:
- `message` (Message): Объект сообщения, содержащий файл товара.
- `state` (FSMContext): Контекст конечного автомата для управления состоянием.

**Как работает функция**:

1. Обновляет данные в FSM, сохраняя ID файла.
2. Удаляет предыдущее сообщение пользователя.
3. Отправляет сообщение с запросом скрытого контента товара.
4. Обновляет состояние FSM, сохраняя ID последнего сообщения.
5. Устанавливает состояние `AddProduct.hidden_content`.

ASCII flowchart:

```
A: Получение сообщения с файлом товара
│
B: Обновление данных в FSM (file_id)
│
C: Удаление предыдущего сообщения
│
D: Отправка запроса скрытого контента
│
E: Обновление состояния FSM (last_msg_id)
│
F: Установка состояния AddProduct.hidden_content
```

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении сообщения)
# await admin_process_without_file(message, fsm_context)
```

### `admin_process_hidden_content`

```python
async def admin_process_hidden_content(message: Message, state: FSMContext, session_without_commit: AsyncSession):
    """
    Обрабатывает ввод скрытого контента товара.

    Args:
        message (Message): Объект сообщения.
        state (FSMContext): Контекст конечного автомата для управления состоянием.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных.
    """
```

**Назначение**: Обрабатывает сообщение со скрытым контентом товара, полученное от пользователя, и переводит FSM в состояние подтверждения добавления товара.

**Параметры**:
- `message` (Message): Объект сообщения, содержащий текст со скрытым контентом товара.
- `state` (FSMContext): Контекст конечного автомата для управления состоянием.
- `session_without_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения запросов к базе данных.

**Как работает функция**:

1. Обновляет данные в FSM, сохраняя скрытый контент товара.
2. Получает данные о товаре из FSM.
3. Получает информацию о категории товара из базы данных с помощью `CategoryDao.find_one_or_none_by_id`.
4. Формирует текстовое описание товара, включающее название, описание, цену, скрытый контент и категорию.
5. Удаляет предыдущее сообщение пользователя.
6. Если у товара есть файл (file_id), отправляет документ с описанием товара и кнопкой для подтверждения.
7. Если у товара нет файла, отправляет текстовое сообщение с описанием товара и кнопкой для подтверждения.
8. Обновляет состояние FSM, сохраняя ID последнего сообщения.
9. Устанавливает состояние `AddProduct.confirm_add`.

ASCII flowchart:

```
A: Получение сообщения со скрытым контентом
│
B: Обновление данных в FSM (hidden_content)
│
C: Получение данных о товаре из FSM
│
D: Получение информации о категории (CategoryDao.find_one_or_none_by_id)
│
E: Формирование текстового описания товара
│
F: Удаление предыдущего сообщения
│
├── G1: Если есть файл (file_id)
│   │
│   └── H1: Отправка документа с описанием и кнопкой подтверждения
│
└── G2: Если нет файла
    │
    └── H2: Отправка текстового сообщения с описанием и кнопкой подтверждения
│
I: Обновление состояния FSM (last_msg_id)
│
J: Установка состояния AddProduct.confirm_add
```

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении сообщения)
# await admin_process_hidden_content(message, fsm_context, async_session)
```

### `admin_process_confirm_add`

```python
async def admin_process_confirm_add(call: CallbackQuery, state: FSMContext, session_with_commit: AsyncSession):
    """
    Обрабатывает подтверждение добавления товара.

    Args:
        call (CallbackQuery): Объект callback-запроса.
        state (FSMContext): Контекст конечного автомата для управления состоянием.
        session_with_commit (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения изменений в базе данных.
    """
```

**Назначение**: Обрабатывает callback-запрос `confirm_add`, подтверждающий добавление товара, и сохраняет товар в базе данных.

**Параметры**:
- `call` (CallbackQuery): Объект callback-запроса, содержащий информацию о запросе от пользователя.
- `state` (FSMContext): Контекст конечного автомата для управления состоянием.
- `session_with_commit` (AsyncSession): Асинхровая сессия SQLAlchemy для выполнения изменений в базе данных.

**Как работает функция**:

1. Отвечает на callback-запрос, уведомляя о начале сохранения товара.
2. Получает данные о товаре из FSM.
3. Удаляет сообщение с подтверждением товара.
4. Удаляет `last_msg_id` из данных о товаре.
5. Добавляет товар в базу данных с помощью `ProductDao.add`.
6. Отправляет сообщение об успешном добавлении товара.

ASCII flowchart:

```
A: Получение callback-запроса (confirm_add)
│
B: Уведомление о начале сохранения
│
C: Получение данных о товаре из FSM
│
D: Удаление сообщения с подтверждением
│
E: Удаление last_msg_id
│
F: Добавление товара в базу данных (ProductDao.add)
│
G: Отправка сообщения об успехе
```

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически aiogram при получении callback-запроса)
# await admin_process_confirm_add(callback_query, fsm_context, async_session)