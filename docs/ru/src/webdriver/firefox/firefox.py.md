# Модуль `firefox`

## Обзор

Модуль предназначен для работы с браузером Firefox через WebDriver. Он содержит класс `Firefox`, который расширяет стандартный функционал `selenium.webdriver.Firefox`, добавляя возможности настройки профиля, запуска в различных режимах окна (например, kiosk) и установки прокси.

## Подробнее

Этот модуль предоставляет удобный способ запуска браузера Firefox с предустановленными настройками, такими как пользовательский профиль, параметры прокси и пользовательский User-Agent. Он также обрабатывает исключения, которые могут возникнуть при запуске WebDriver, и логирует их для упрощения отладки.

## Классы

### `Firefox`

**Описание**: Класс `Firefox` наследуется от `selenium.webdriver.Firefox` и предоставляет расширенные возможности для управления браузером Firefox.

**Принцип работы**:

1.  Загружаются конфигурации из файла `firefox.json`, который содержит пути к исполняемым файлам `geckodriver` и `firefox`, а также различные опции запуска.
2.  Инициализируется сервис `geckodriver`, который является интерфейсом между Selenium и браузером Firefox.
3.  Создается объект опций Firefox (`Options`), в который добавляются различные аргументы, такие как режим окна, пользовательский User-Agent и настройки прокси.
4.  Если указан пользовательский профиль, он используется для запуска браузера.
5.  Обрабатываются исключения, которые могут возникнуть при запуске WebDriver, такие как отсутствие Firefox или несовместимость версий.
6.  После успешного запуска загружаются исполнители для локаторов и JavaScript сценариев.

**Аттрибуты**:

*   `driver_name` (str): Имя драйвера (в данном случае `'firefox'`).
*   `service` (Service): Сервис `geckodriver`, управляющий экземпляром Firefox.

**Методы**:

*   `__init__`: Инициализирует экземпляр класса `Firefox`, настраивает опции браузера, устанавливает прокси и запускает браузер.
*   `set_proxy`: Настраивает прокси для Firefox, используя данные из словаря прокси.
*   `_payload`: Загружает исполнителей для локаторов и JavaScript сценариев.

### `__init__`

```python
def __init__(self, profile_name: Optional[str] = None,
                 geckodriver_version: Optional[str] = None,
                 firefox_version: Optional[str] = None,
                 user_agent: Optional[str] = None,
                 proxy_file_path: Optional[str] = None,
                 options: Optional[List[str]] = None,
                 window_mode: Optional[str] = None,
                 *args, **kwargs) -> None:
    """ """
```

**Назначение**: Инициализирует экземпляр класса `Firefox`, настраивает опции браузера, устанавливает прокси и запускает браузер.

**Параметры**:

*   `profile_name` (Optional[str]): Имя пользовательского профиля Firefox. По умолчанию `None`.
*   `geckodriver_version` (Optional[str]): Версия `geckodriver`. По умолчанию `None`.
*   `firefox_version` (Optional[str]): Версия Firefox. По умолчанию `None`.
*   `user_agent` (Optional[str]): Пользовательский User-Agent. По умолчанию `None`.
*   `proxy_file_path` (Optional[str]): Путь к файлу с прокси. По умолчанию `None`.
*   `options` (Optional[List[str]]): Список опций для Firefox. По умолчанию `None`.
*   `window_mode` (Optional[str]): Режим окна браузера (`windowless`, `kiosk`, `full_window` и т.д.). По умолчанию `None`.
*   `*args`: Произвольные позиционные аргументы.
*   `**kwargs`: Произвольные именованные аргументы.

**Возвращает**: None

**Вызывает исключения**:

*   `WebDriverException`: Если происходит ошибка при запуске WebDriver (например, несовместимость версий или отсутствие Firefox).
*   `Exception`: При возникновении других ошибок во время инициализации.

**Как работает функция**:

1.  **Инициализация**: Инициализирует основные переменные и загружает конфигурации из файла `firefox.json`.

2.  **Настройка путей**: Определяет пути к исполняемым файлам `geckodriver` и `firefox`.

3.  **Инициализация сервиса**: Создает экземпляр `Service` для управления `geckodriver`.

4.  **Настройка опций**: Создает объект `Options` и добавляет различные опции, такие как режим окна, пользовательский User-Agent и настройки прокси.

5.  **Профиль пользователя**: Если указано имя профиля, пытается использовать его для запуска браузера.

6.  **Запуск WebDriver**: Пытается запустить WebDriver с заданными опциями и обрабатывает возможные исключения.

7.  **Загрузка исполнителей**: После успешного запуска загружает исполнителей для локаторов и JavaScript сценариев.

**Внутренние функции**: Нет.

**Примеры**:

```python
# Пример запуска Firefox с пользовательским профилем и в режиме kiosk
driver = Firefox(profile_name='my_profile', window_mode='kiosk')

# Пример запуска Firefox с указанием версии geckodriver и Firefox
driver = Firefox(geckodriver_version='v0.30.0', firefox_version='90.0')

# Пример запуска Firefox с пользовательским User-Agent
driver = Firefox(user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3')
```

### `set_proxy`

```python
def set_proxy(self, options: Options) -> None:
    """
    Настройка прокси из словаря, возвращаемого get_proxies_dict.

    :param options: Опции Firefox, в которые добавляются настройки прокси.
    :type options: Options
    """
```

**Назначение**: Настраивает прокси для Firefox, используя данные из словаря прокси.

**Параметры**:

*   `options` (Options): Объект опций Firefox, в который добавляются настройки прокси.

**Возвращает**: None

**Вызывает исключения**: Нет.

**Как работает функция**:

1.  **Получение прокси**: Получает словарь прокси из функции `get_proxies_dict`.
2.  **Выбор рабочего прокси**: Перебирает прокси из списка и проверяет их работоспособность с помощью функции `check_proxy`.
3.  **Настройка опций**: Если найден рабочий прокси, настраивает соответствующие опции Firefox в зависимости от протокола прокси (HTTP, SOCKS4, SOCKS5).
4.  **Логирование**: Логирует информацию о настройке прокси или предупреждение, если прокси не найден.

**Внутренние функции**: Нет.

**Примеры**:

```python
# Пример настройки прокси для Firefox
options = Options()
firefox = Firefox()
firefox.set_proxy(options)
```

### `_payload`

```python
def _payload(self) -> None:
    """
   Загружает исполнителей для локаторов и JavaScript сценариев.
    """
```

**Назначение**: Загружает исполнителей для локаторов и JavaScript сценариев, добавляя их как атрибуты к экземпляру класса `Firefox`.

**Параметры**: None

**Возвращает**: None

**Вызывает исключения**: Нет.

**Как работает функция**:

1.  **Создание экземпляра JavaScript**: Создает экземпляр класса `JavaScript`, передавая ему текущий экземпляр `Firefox`.
2.  **Добавление методов JavaScript**: Добавляет методы из экземпляра `JavaScript` (такие как `get_page_lang`, `ready_state`, `get_referrer`, `unhide_DOM_element`, `window_focus`) к текущему экземпляру `Firefox`.
3.  **Создание экземпляра ExecuteLocator**: Создает экземпляр класса `ExecuteLocator`, передавая ему текущий экземпляр `Firefox`.
4.  **Добавление методов ExecuteLocator**: Добавляет методы из экземпляра `ExecuteLocator` (такие как `execute_locator`, `get_webelement_as_screenshot`, `get_webelement_by_locator`, `get_attribute_by_locator`, `send_message`, `send_key_to_webelement`) к текущему экземпляру `Firefox`.

**Внутренние функции**: Нет.

**Примеры**:

```python
# Пример вызова _payload после инициализации Firefox
driver = Firefox()
driver._payload()
```

## Функции

В данном модуле нет отдельных функций, только методы класса `Firefox`.

## ASCII flowchart для `__init__`

```
A[Загрузка конфигурации из firefox.json]
|
B[Определение путей к geckodriver и firefox]
|
C[Инициализация Service(geckodriver_path)]
|
D[Создание Options()]
|
E[Добавление опций из конфигурации]
|
F[Установка режима окна (window_mode)]
|
G[Добавление дополнительных опций (options)]
|
H[Установка User-Agent]
|
I[Установка прокси (если включено)]
|
J[Определение директории профиля]
|
K[Инициализация Firefox с опциями]
|
L[Загрузка исполнителей (_payload())]
|
M[Обработка исключений (WebDriverException, Exception)]
|
N[Выход из программы (sys.exit(1) при ошибке)]
```

## ASCII flowchart для `set_proxy`

```
A[Получение словаря прокси (get_proxies_dict())]
|
B[Перебор прокси из списка]
|
C[Проверка прокси (check_proxy(proxy))]
|
D[Найдена ли рабочая прокси?]
|
E[Настройка опций Firefox в зависимости от протокола]
|
F[Логирование информации о настройке прокси]
|
G[Предупреждение, если прокси не найден]
```

## ASCII flowchart для `_payload`

```
A[Создание экземпляра JavaScript(self)]
|
B[Добавление методов JavaScript к экземпляру Firefox]
|
C[Создание экземпляра ExecuteLocator(self)]
|
D[Добавление методов ExecuteLocator к экземпляру Firefox]