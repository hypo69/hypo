# Модуль `NoowAi`

## Обзор

Модуль `NoowAi` предоставляет асинхронный генератор для взаимодействия с AI-провайдером NoowAI. Он поддерживает использование истории сообщений и модель GPT-3.5 Turbo. Модуль предназначен для получения ответов от AI в режиме реального времени (стриминга).

## Подробней

Этот модуль является частью проекта `hypotez` и реализует взаимодействие с сервисом NoowAI для генерации текста. Он использует асинхронные запросы для получения ответов и обрабатывает их в режиме реального времени. Модуль предоставляет класс `NoowAi`, который наследуется от `AsyncGeneratorProvider` и реализует метод `create_async_generator` для создания асинхронного генератора.

## Классы

### `NoowAi`

**Описание**:
Класс `NoowAi` предоставляет функциональность для взаимодействия с AI-провайдером NoowAI.

**Наследует**:
`AsyncGeneratorProvider` - базовый класс для асинхронных провайдеров, генерирующих данные.

**Атрибуты**:
- `url` (str): URL-адрес сервиса NoowAI.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений (значение: `True`).
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель GPT-3.5 Turbo (значение: `True`).
- `working` (bool): Указывает, работает ли провайдер в данный момент (значение: `False`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от AI.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от AI.

    Args:
        cls (NoowAi): Ссылка на класс `NoowAi`.
        model (str): Модель, используемая для генерации ответов.
        messages (Messages): Список сообщений для отправки в AI.
        proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, предоставляющий ответы от AI.

    Raises:
        RuntimeError: Если возникает ошибка при обработке ответа от AI.
    """
```

**Назначение**:
Метод `create_async_generator` создает асинхронный генератор для получения ответов от AI-провайдера NoowAI. Он отправляет сообщения пользователя в NoowAI и возвращает асинхронный генератор, который выдает ответы в режиме реального времени.

**Параметры**:
- `cls` (NoowAi): Ссылка на класс `NoowAi`.
- `model` (str): Модель, используемая для генерации ответов.
- `messages` (Messages): Список сообщений для отправки в AI.
- `proxy` (str, optional): Адрес прокси-сервера. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, предоставляющий ответы от AI.

**Вызывает исключения**:
- `RuntimeError`: Если возникает ошибка при обработке ответа от AI.

**Внутренние функции**:
- Отсутствуют

**Как работает функция**:

1.  **Формирование заголовков**: Функция начинает с формирования заголовков HTTP-запроса, включая User-Agent, Referer, Content-Type и другие необходимые параметры.
2.  **Создание сессии**: Создается асинхронная сессия с использованием `aiohttp.ClientSession` с заданными заголовками.
3.  **Формирование данных**: Подготавливаются данные для отправки в теле запроса, включая идентификаторы бота, сессии, чата, контекста, а также список сообщений и текст последнего сообщения.
4.  **Отправка запроса**: Отправляется POST-запрос к API NoowAI с использованием асинхронной сессии и прокси (если указан).
5.  **Обработка ответа**: Функция начинает асинхронно итерироваться по строкам в ответе от сервера.
6.  **Извлечение данных**: Для каждой строки проверяется, начинается ли она с префикса `b"data: "`. Если да, то строка декодируется и преобразуется из JSON.
7.  **Проверка типа сообщения**: Проверяется наличие ключа `"type"` в декодированной строке. Если ключ отсутствует, поднимается исключение `RuntimeError`.
8.  **Генерация ответа**: В зависимости от значения ключа `"type"`, функция генерирует различные действия:
    *   Если `"type"` равно `"live"`, то функция возвращает данные из ключа `"data"`.
    *   Если `"type"` равно `"end"`, то функция завершает свою работу.
    *   Если `"type"` равно `"error"`, то поднимается исключение `RuntimeError` с данными из ключа `"data"`.

```
Формирование заголовков и данных  ->  Создание асинхронной сессии
    |                                       |
    |                                       V
    |                         Отправка POST-запроса к API NoowAI
    |                                       |
    |                                       V
    |                         Асинхронная итерация по строкам ответа
    |                                       |
    |                                       V
    |    Проверка префикса "data: " -> Декодирование JSON -> Проверка ключа "type"
    |                                       |
    |                                       V
    |   "live" -> yield данные      "end" -> завершение         "error" -> RuntimeError
```

**Примеры**:

```python
# Пример использования функции create_async_generator
# (Предполагается, что у вас есть настроенный экземпляр класса NoowAi и список сообщений)
# async for message in NoowAi.create_async_generator(model="gpt-3.5-turbo", messages=[{"role": "user", "content": "Hello, how are you?"}]):
#     print(message)