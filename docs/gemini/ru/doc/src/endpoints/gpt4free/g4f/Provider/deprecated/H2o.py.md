# Модуль для работы с провайдером H2o
=============================================

Модуль предоставляет асинхронный генератор для взаимодействия с моделью H2o.ai.
Он включает функции для настройки соединения, отправки запросов и обработки ответов от H2o AI.

## Обзор

Этот модуль позволяет использовать H2o AI в качестве поставщика (провайдера) для генерации текста. Он асинхронный, что позволяет эффективно обрабатывать запросы. Модуль содержит класс `H2o`, который наследуется от `AsyncGeneratorProvider` и предоставляет методы для создания асинхронного генератора.

## Подробнее

Модуль предназначен для интеграции с другими частями проекта, где требуется генерация текста с использованием H2o AI. Он использует `aiohttp` для выполнения асинхронных HTTP-запросов и предоставляет удобный интерфейс для взаимодействия с API H2o.

## Классы

### `H2o`
Описание класса для взаимодействия с H2o AI.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных генераторов.

**Атрибуты**:
- `url` (str): URL-адрес сервиса H2o AI.
- `model` (str): Название используемой модели H2o AI.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от H2o AI.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для получения ответов от H2o AI.

        Args:
            model (str): Название модели, которую следует использовать.
            messages (Messages): Список сообщений для отправки в модель.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            **kwargs: Дополнительные параметры для передачи в модель.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий текст от модели.

        Raises:
            aiohttp.ClientError: Если возникает ошибка при выполнении HTTP-запроса.

        Внутренние функции:
            None
        """
```

**Назначение**:
Создает асинхронный генератор для взаимодействия с моделью H2o AI.

**Параметры**:
- `cls` (H2o): Ссылка на класс `H2o`.
- `model` (str): Название модели, которую следует использовать.
- `messages` (Messages): Список сообщений для отправки в модель.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры для передачи в модель.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий текст от модели.

**Вызывает исключения**:
- `aiohttp.ClientError`: Если возникает ошибка при выполнении HTTP-запроса.

**Как работает функция**:
1. **Инициализация**: Функция начинается с определения модели, которая будет использоваться. Если модель не указана, используется модель по умолчанию (`cls.model`).
2. **Формирование заголовков**: Создаются заголовки, включающие Referer для имитации запроса с сайта H2o.ai.
3. **Создание сессии**: Используется `aiohttp.ClientSession` для управления асинхронными HTTP-запросами.
4. **Настройка параметров**: Отправляется POST-запрос на `/settings` для установки параметров, таких как принятие условий использования и выбор активной модели.
5. **Создание диалога (conversation)**: Отправляется POST-запрос на `/conversation` для создания нового диалога с указанной моделью. Полученный `conversationId` используется для дальнейших запросов.
6. **Формирование данных запроса**: Подготавливаются данные для запроса, включающие сообщения (`inputs`), параметры генерации (`parameters`) и опции (`options`). Параметры включают температуру, максимальное количество токенов и другие настройки.
7. **Отправка запроса и получение данных**: Отправляется POST-запрос на `/conversation/{conversationId}` с данными запроса. Ответ приходит в виде потока данных, разделенных строкой `"data:"`.
8. **Обработка потока данных**: Асинхронно обрабатывается каждая строка ответа. Если строка начинается с `"data:"`, она декодируется как JSON. Из JSON извлекается текст токена, если токен не является специальным.
9. **Генерация текста**: Извлеченный текст токена передается через `yield`, что делает функцию генератором.
10. **Удаление диалога (conversation)**: После завершения получения данных отправляется DELETE-запрос на `/conversation/{conversationId}` для удаления диалога.

ASCII flowchart:

```
    A[Определение модели]
    |
    B[Формирование заголовков]
    |
    C[Создание асинхронной сессии]
    |
    D[Настройка параметров (/settings)]
    |
    E[Создание диалога (/conversation)]
    |
    F[Формирование данных запроса]
    |
    G[Отправка запроса и получение данных (/conversation/{conversationId})]
    |
    H[Обработка потока данных]
    |
    I[Генерация текста (yield)]
    |
    J[Удаление диалога (/conversation)]
```

**Примеры**:

```python
# Пример 1: Использование с минимальными параметрами
async for token in H2o.create_async_generator(model="h2oai/h2ogpt-gm-oasst1-en-2048-falcon-40b-v1", messages=[{"role": "user", "content": "Hello, how are you?"}]):
    print(token, end="")

# Пример 2: Использование с прокси и дополнительными параметрами
async for token in H2o.create_async_generator(model="h2oai/h2ogpt-gm-oasst1-en-2048-falcon-40b-v1", messages=[{"role": "user", "content": "Tell me a joke."}], proxy="http://your-proxy:8080", temperature=0.7):
    print(token, end="")