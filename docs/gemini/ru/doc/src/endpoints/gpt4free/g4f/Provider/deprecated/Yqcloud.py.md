# Модуль для работы с Yqcloud API
## Обзор

Модуль предоставляет асинхронный интерфейс для взаимодействия с Yqcloud API, который позволяет генерировать текст на основе предоставленных сообщений. Он включает в себя функции для создания заголовков запросов и полезной нагрузки, а также асинхронный генератор для обработки потоковых ответов от API.
## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для работы с сервисом Yqcloud, предоставляющим API для генерации текста. Модуль использует асинхронные запросы для взаимодействия с API, что позволяет эффективно обрабатывать потоковые данные. Он также включает в себя обработку ошибок, таких как блокировка IP-адреса из-за обнаружения злоупотреблений.

## Классы

### `Yqcloud`

**Описание**: Класс `Yqcloud` является асинхронным провайдером генератора, который взаимодействует с API Yqcloud для генерации текста на основе предоставленных сообщений.

**Наследует**: `AsyncGeneratorProvider`

**Атрибуты**:
- `url` (str): URL-адрес сервиса Yqcloud.
- `working` (bool): Указывает, работает ли провайдер в данный момент.
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель GPT-3.5 Turbo.

**Методы**:
- `create_async_generator()`: Создает асинхронный генератор для взаимодействия с API Yqcloud.

### `create_async_generator`

```python
    @staticmethod
    async def create_async_generator(
        model: str,
        messages: Messages,
        proxy: str = None,
        timeout: int = 120,
        **kwargs,
    ) -> AsyncResult:
        """Создает асинхронный генератор для взаимодействия с API Yqcloud.

        Args:
            model (str): Модель для генерации текста.
            messages (Messages): Список сообщений для передачи в API.
            proxy (str, optional): Прокси-сервер для использования при подключении. По умолчанию `None`.
            timeout (int, optional): Время ожидания ответа от сервера. По умолчанию `120`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий текст, сгенерированный API Yqcloud.

        Raises:
            RuntimeError: Если IP-адрес заблокирован из-за обнаружения злоупотреблений.

        Как работает функция:
        1. Создает асинхронную сессию с использованием `StreamSession` и переданных параметров (заголовки, прокси, таймаут).
        2. Формирует полезную нагрузку (payload) с использованием функции `_create_payload`.
        3. Отправляет POST-запрос к API Yqcloud (`https://api.aichatos.cloud/api/generateStream`) с полезной нагрузкой.
        4. Обрабатывает чанки потокового ответа, декодирует их и проверяет на наличие сообщения о блокировке IP-адреса.
        5. Если IP-адрес заблокирован, вызывает исключение `RuntimeError`.
        6. Возвращает чанки текста, сгенерированные API Yqcloud.

        Внутренние функции:
            - Отсутствуют.

        """
```
**Назначение**: Создает асинхронный генератор для взаимодействия с API Yqcloud.

**Параметры**:
- `model` (str): Модель для генерации текста.
- `messages` (Messages): Список сообщений для передачи в API.
- `proxy` (str, optional): Прокси-сервер для использования при подключении. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания ответа от сервера. По умолчанию `120`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий текст, сгенерированный API Yqcloud.

**Вызывает исключения**:
- `RuntimeError`: Если IP-адрес заблокирован из-за обнаружения злоупотреблений.

**Как работает функция**:

```
    Создание сессии StreamSession -> Формирование payload -> Отправка POST-запроса к API Yqcloud
    |                                      |                              |
    V                                      |                              |
    Обработка чанков потокового ответа  -> Проверка на блокировку IP ->  Возврат чанков текста
    |                                      |
    V                                      |
    Вызов исключения RuntimeError (если IP заблокирован)
```

**Примеры**:

```python
# Пример использования create_async_generator
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Hello, how are you?"}]
proxy = "http://your_proxy:8080"  # Замените на ваш прокси-сервер
timeout = 120

async def main():
    generator = await Yqcloud.create_async_generator(model, messages, proxy, timeout)
    async for chunk in generator:
        print(chunk, end="")

if __name__ == "__main__":
    import asyncio
    asyncio.run(main())
```

## Функции

### `_create_header`

```python
def _create_header():
    """Создает заголовки для HTTP-запроса.

    Args:
        Нет аргументов.

    Returns:
        dict: Словарь с заголовками для HTTP-запроса.
    """
```

**Назначение**: Создает заголовки для HTTP-запроса.

**Параметры**:
- Нет параметров.

**Возвращает**:
- `dict`: Словарь с заголовками для HTTP-запроса.

**Как работает функция**:
- Функция создает и возвращает словарь с заголовками, необходимыми для выполнения HTTP-запроса к API Yqcloud. Заголовки включают `accept`, `content-type`, `origin` и `referer`.

```
    Создание словаря с заголовками -> Возврат словаря
```

**Примеры**:

```python
# Пример использования _create_header
headers = _create_header()
print(headers)
```

### `_create_payload`

```python
def _create_payload(
    messages: Messages,
    system_message: str = "",
    user_id: int = None,
    **kwargs
):
    """Создает полезную нагрузку (payload) для запроса к API Yqcloud.

    Args:
        messages (Messages): Список сообщений для передачи в API.
        system_message (str, optional): Системное сообщение для установки контекста. По умолчанию "".
        user_id (int, optional): Идентификатор пользователя. Если не указан, генерируется случайный. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        dict: Словарь с данными для отправки в теле запроса.
    """
```

**Назначение**: Создает полезную нагрузку (payload) для запроса к API Yqcloud.

**Параметры**:
- `messages` (Messages): Список сообщений для передачи в API.
- `system_message` (str, optional): Системное сообщение для установки контекста. По умолчанию "".
- `user_id` (int, optional): Идентификатор пользователя. Если не указан, генерируется случайный. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `dict`: Словарь с данными для отправки в теле запроса.

**Как работает функция**:

1. Проверяет, передан ли `user_id`. Если нет, генерирует случайный `user_id` в диапазоне от 1690000544336 до 2093025544336.
2. Формирует словарь с данными, включающими:
    - `prompt`: Отформатированные сообщения с использованием функции `format_prompt`.
    - `network`: Флаг, указывающий на использование сети (всегда `True`).
    - `system`: Системное сообщение.
    - `withoutContext`: Флаг, указывающий на отсутствие контекста (всегда `False`).
    - `stream`: Флаг, указывающий на потоковую передачу данных (всегда `True`).
    - `userId`: Идентификатор пользователя в формате `#/chat/{user_id}`.

```
    Проверка наличия user_id -> Генерация случайного user_id (если отсутствует) -> Формирование словаря payload -> Возврат словаря
```

**Примеры**:

```python
# Пример использования _create_payload
messages = [{"role": "user", "content": "Hello, how are you?"}]
system_message = "You are a helpful assistant."
user_id = 12345

payload = _create_payload(messages, system_message, user_id)
print(payload)