# Модуль для работы с провайдером MyShell
==========================================

Модуль содержит класс `MyShell`, который используется для взаимодействия с сервисом MyShell для генерации текста.
Сервис предоставляет API для обмена сообщениями с ботом и получения ответов в режиме реального времени.

## Оглавление

- [Обзор](#обзор)
- [Классы](#классы)
    - [MyShell](#myshell)
        - [create_completion](#create_completion)

## Обзор

Модуль `MyShell` предоставляет реализацию для взаимодействия с сервисом `MyShell`. Он поддерживает потоковую передачу данных и использует веб-драйвер для обхода защиты Cloudflare и отправки запросов к API.

## Классы

### `MyShell`

**Описание**:
Класс `MyShell` предоставляет методы для взаимодействия с API `MyShell`.
Он наследуется от класса `AbstractProvider` и переопределяет метод `create_completion` для создания запросов и получения ответов от API.

**Атрибуты**:
- `url` (str): URL для взаимодействия с `MyShell` ("https://app.myshell.ai/chat").
- `working` (bool): Указывает, работает ли провайдер (значение `False`).
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель `gpt-3.5-turbo` (значение `True`).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных (значение `True`).

#### `create_completion`

```python
@classmethod
def create_completion(
    cls,
    model: str,
    messages: Messages,
    stream: bool,
    proxy: str = None,
    timeout: int = 120,
    webdriver = None,
    **kwargs
) -> CreateResult:
    """
    Создает запрос к API MyShell и возвращает результат.

    Args:
        model (str): Идентификатор модели, используемой для генерации текста.
        messages (Messages): Список сообщений для отправки в API.
        stream (bool): Флаг, указывающий, следует ли использовать потоковую передачу данных.
        proxy (str, optional): Прокси-сервер для использования при подключении к API. По умолчанию `None`.
        timeout (int, optional): Время ожидания ответа от API в секундах. По умолчанию 120.
        webdriver: Объект веб-драйвера для обхода защиты Cloudflare. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        CreateResult: Результат запроса к API.

    Raises:
        Exception: В случае ошибки при взаимодействии с API.
    """
```

**Назначение**:
Метод `create_completion` отправляет запрос к API `MyShell` и возвращает сгенерированный текст. Он использует веб-драйвер для обхода защиты Cloudflare, формирует данные запроса и выполняет JavaScript для получения потоковых ответов.

**Параметры**:
- `cls` (class): Ссылка на класс `MyShell`.
- `model` (str): Идентификатор используемой модели.
- `messages (Messages)`: Список сообщений для отправки.
- `stream` (bool): Флаг, указывающий, использовать ли потоковую передачу.
- `proxy (str, optional)`: Прокси-сервер. По умолчанию `None`.
- `timeout (int, optional)`: Время ожидания запроса. По умолчанию 120 секунд.
- `webdriver`: Объект веб-драйвера для автоматизации браузера.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `CreateResult`: Результат генерации текста.

**Как работает функция**:

1. **Инициализация сессии WebDriver:**
   - Используется менеджер контекста `WebDriverSession` для управления сессией веб-драйвера. Этот шаг включает в себя настройку драйвера с прокси-сервером, если он указан.
2. **Обход Cloudflare:**
   - Функция `bypass_cloudflare` используется для обхода защиты Cloudflare, чтобы получить доступ к целевому сайту `cls.url`.
3. **Формирование данных запроса:**
   - Создается словарь `data`, содержащий идентификатор бота (`botId`), сценарий разговора (`conversation_scenario`), отформатированное сообщение (`message`) и тип сообщения (`messageType`).
   - Сообщение форматируется с использованием функции `format_prompt(messages)`.
4. **Выполнение JavaScript для отправки запроса:**
   - Скрипт JavaScript отправляет `POST`-запрос к API `MyShell` (`https://api.myshell.ai/v1/bot/chat/send_message`) с использованием `fetch`.
   - В заголовках запроса передаются `accept`, `content-type`, `myshell-service-name` и `visitor-id`.
   - Тело запроса (`body`) содержит JSON-представление словаря `data`.
   - Для чтения потока ответов используется `TextDecoderStream` и `getReader()`.
5. **Получение потоковых ответов:**
   - В цикле `while True` выполняется скрипт JavaScript для чтения чанков данных из потока.
   - Каждый чанк обрабатывается для извлечения содержимого (`content`) из JSON-структуры.
   - Если `content` получен, он возвращается как часть потока.
   - Если чанк пустой или операция чтения завершена, цикл завершается.
6. **Завершение:**
   - Если в процессе чтения возникают ошибки, они перехватываются и логируются.

**ASCII flowchart**:

```
+--------------------------+
| Инициализация WebDriver |
+--------------------------+
      |
      v
+--------------------------+
|    Обход Cloudflare     |
+--------------------------+
      |
      v
+--------------------------+
| Формирование данных     |
+--------------------------+
      |
      v
+--------------------------+
| Отправка запроса (JS)  |
+--------------------------+
      |
      v
+--------------------------+
|  Получение ответов (JS) |
+--------------------------+
      |
      v
+--------------------------+
|   Обработка чанков     |
+--------------------------+
      |
      v
+--------------------------+
|      Возврат ответа     |
+--------------------------+
```

**Примеры**:

Пример использования с потоковой передачей:

```python
messages = [{"role": "user", "content": "Hello, MyShell!"}]
for chunk in MyShell.create_completion(model="default", messages=messages, stream=True):
    print(chunk)