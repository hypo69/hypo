# Модуль интеграции с Google Generative AI

## Обзор

Модуль `GoogleGenerativeAI` предназначен для упрощения взаимодействия с моделями Google Generative AI. Этот класс предоставляет методы для отправки запросов, обработки ответов, управления диалогами и интеграции с различными функциями AI. Он включает надежную обработку ошибок, ведение журнала и параметры конфигурации для обеспечения бесперебойной работы.

## Содержание

- [Обзор](#обзор)
- [Основные функции](#основные-функции)
  - [`__init__`](#__init__)
  - [`config`](#config)
  - [`_start_chat`](#_start_chat)
  - [`_save_dialogue`](#_save_dialogue)
  - [`ask`](#ask)
  - [`chat`](#chat)
  - [`describe_image`](#describe_image)
  - [`upload_file`](#upload_file)
- [Обработка ошибок](#обработка-ошибок)
- [Ведение журнала и история](#ведение-журнала-и-история)
- [Зависимости](#зависимости)
- [Пример использования](#пример-использования)

## Основные функции

### `__init__`

```python
def __init__(self, api_key: str, model_name: Optional[str] = None, generation_config: Optional[Dict] = None, system_instruction: Optional[str] = None, **kwargs)
```

**Описание**: Инициализирует класс `GoogleGenerativeAI` с необходимыми конфигурациями.

**Параметры**:

- `api_key` (str): Ключ API для доступа к Google Generative AI.
- `model_name` (Optional[str], optional): Название модели AI для использования. По умолчанию `None`.
- `generation_config` (Optional[Dict], optional): Конфигурация генерации для модели AI. По умолчанию `None`.
- `system_instruction` (Optional[str], optional): Системные инструкции для модели AI. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы ключевого слова.

**Подробнее**:

- Устанавливает ключ API, имя модели, конфигурацию генерации и системные инструкции.
- Определяет пути для регистрации диалогов и хранения истории.
- Инициализирует модель Google Generative AI.

**Примеры:**

```python
ai = GoogleGenerativeAI(api_key="your_api_key", system_instruction="Instruction")
```

### `config`

```python
def config(self)
```

**Описание**: Извлекает конфигурацию из файла настроек.

**Подробнее**:

- Читает и анализирует файл конфигурации, расположенный по адресу `gs.path.src / 'ai' / 'gemini' / 'gemini.json'`.

**Примеры:**

```python
config_data = ai.config()
```

### `_start_chat`

```python
def _start_chat(self)
```

**Описание**: Начинает сеанс чата с моделью AI.

**Подробнее**:

- Инициализирует сеанс чата с пустой историей.

**Примеры:**

```python
ai._start_chat()
```

### `_save_dialogue`

```python
def _save_dialogue(self, dialogue: list)
```

**Описание**: Сохраняет диалог в текстовый и JSON-файлы.

**Параметры**:

- `dialogue` (list): Список сообщений в диалоге.

**Подробнее**:

- Добавляет каждое сообщение в диалоге в текстовый файл.
- Добавляет каждое сообщение в формате JSON в JSON-файл.

**Примеры:**

```python
dialogue_messages = ["Привет!", "Как дела?"]
ai._save_dialogue(dialogue_messages)
```

### `ask`

```python
def ask(self, q: str, attempts: int = 15) -> Optional[str]
```

**Описание**: Отправляет текстовый запрос модели AI и получает ответ.

**Параметры**:

- `q` (str): Текстовый запрос для отправки.
- `attempts` (int, optional): Количество попыток в случае сетевых ошибок или недоступности сервиса. По умолчанию `15`.

**Возвращает**:

- `Optional[str]`: Сгенерированный ответ от модели AI или `None` в случае ошибки.

**Подробнее**:

- Обрабатывает несколько попыток в случае сетевых ошибок или недоступности сервиса.
- Регистрирует ошибки и повторяет попытки с экспоненциальной задержкой.
- Сохраняет диалог в файлы истории.

**Примеры:**

```python
response = ai.ask("Как дела?")
print(response)
```

### `chat`

```python
def chat(self, q: str) -> str
```

**Описание**: Отправляет сообщение в чат модели AI и получает ответ.

**Параметры**:

- `q` (str): Сообщение чата для отправки.

**Возвращает**:

- `str`: Текст ответа из модели AI.

**Подробнее**:

- Использует сеанс чата, инициализированный `_start_chat`.
- Регистрирует ошибки и возвращает текст ответа.

**Примеры:**

```python
response = ai.chat("Что нового?")
print(response)
```

### `describe_image`

```python
def describe_image(self, image_path: Path) -> Optional[str]
```

**Описание**: Генерирует текстовое описание изображения.

**Параметры**:

- `image_path` (Path): Путь к файлу изображения.

**Возвращает**:

- `Optional[str]`: Сгенерированное описание изображения или `None`, если операция завершилась неудачей.

**Подробнее**:

- Кодирует изображение в base64 и отправляет его в модель AI.
- Возвращает сгенерированное описание или регистрирует ошибку, если операция завершается неудачно.

**Примеры:**

```python
image_description = ai.describe_image(Path("path/to/image.jpg"))
if image_description:
    print(image_description)
```

### `upload_file`

```python
def upload_file(self, file: str | Path | IOBase, file_name: Optional[str] = None) -> bool
```

**Описание**: Загружает файл в модель AI.

**Параметры**:

- `file` (str | Path | IOBase): Файл для загрузки (путь или объект IO).
- `file_name` (Optional[str], optional): Имя файла для отправки. По умолчанию `None`.

**Возвращает**:

- `bool`: `True`, если загрузка файла прошла успешно, иначе `False`.

**Подробнее**:

- Обрабатывает загрузку файла и регистрирует успех или неудачу.
- Предоставляет логику повтора в случае ошибок.

**Примеры:**

```python
success = ai.upload_file("path/to/file.txt")
if success:
    print("Файл успешно загружен.")
```

## Обработка ошибок

Класс включает комплексную обработку ошибок для различных сценариев:

- **Сетевые ошибки**: Повторяет попытки с экспоненциальной задержкой.
- **Недоступность сервиса**: Регистрирует ошибки и повторяет попытки.
- **Ограничения квоты**: Регистрирует и ждет перед повторной попыткой.
- **Ошибки аутентификации**: Регистрирует и прекращает дальнейшие попытки.
- **Недопустимый ввод**: Регистрирует и повторяет попытки с тайм-аутом.
- **Ошибки API**: Регистрирует и прекращает дальнейшие попытки.

## Ведение журнала и история

Все взаимодействия с моделями AI регистрируются, а диалоги сохраняются в текстовом и JSON-форматах для будущего анализа. Это гарантирует, что все операции отслеживаются и могут быть проверены для отладки или аудита.

## Зависимости

- `google.generativeai`
- `requests`
- `grpc`
- `google.api_core.exceptions`
- `google.auth.exceptions`
- `src.logger`
- `src.utils.printer`
- `src.utils.file`
- `src.utils.date_time`
- `src.utils.convertors.unicode`
- `src.utils.jjson`

## Пример использования

```python
ai = GoogleGenerativeAI(api_key="your_api_key", system_instruction="Instruction")
response = ai.ask("Как дела?")
print(response)
```

Этот пример инициализирует класс `GoogleGenerativeAI`, отправляет запрос модели AI и печатает ответ.

---

Для получения более подробной информации обратитесь к исходному коду и комментариям в классе `GoogleGenerativeAI`.