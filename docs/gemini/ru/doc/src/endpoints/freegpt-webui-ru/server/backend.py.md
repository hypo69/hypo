# Модуль backend.py

## Обзор

Модуль `backend.py` является частью проекта `hypotez` и отвечает за обработку запросов к backend API, в частности, за взаимодействие с моделями генерации текста (например, ChatGPT) через API `g4f`. Он также включает функциональность для работы с прокси, перевода текста и обработки инструкций jailbreak.

## Подробнее

Этот модуль предоставляет API endpoint `/backend-api/v2/conversation`, который принимает POST запросы и генерирует ответы на основе предоставленных данных, таких как сообщения, инструкции jailbreak и выбранная модель. Модуль также включает функциональность для получения результатов поиска из интернета и адаптации ответов в зависимости от языка запроса.

## Классы

### `Backend_Api`

**Описание**: Класс `Backend_Api` инкапсулирует логику backend API.

**Принцип работы**: Класс инициализируется с Flask-приложением и конфигурацией. Он определяет маршруты API и соответствующие функции для обработки запросов. Если в конфигурации включено использование auto proxy, класс также запускает поток для обновления списка рабочих прокси.

**Атрибуты**:
- `app`: Flask-приложение.
- `use_auto_proxy` (bool): Флаг, указывающий на использование auto proxy.
- `routes` (dict): Словарь, определяющий маршруты API и соответствующие им функции и методы.

**Методы**:
- `__init__(self, app, config: dict) -> None`: Инициализирует экземпляр класса `Backend_Api`.
- `_conversation(self)`: Обрабатывает запрос на генерацию ответа от модели.

## Функции

### `build_messages(jailbreak)`

```python
def build_messages(jailbreak):
    """
    Формирует список сообщений для отправки в модель.

    Args:
        jailbreak: Инструкция jailbreak.

    Returns:
        list: Список сообщений для отправки в модель.
    """
```

**Назначение**: Функция `build_messages` формирует список сообщений для отправки в модель генерации текста. Она собирает контекст из различных источников, таких как предыдущие сообщения, результаты поиска в интернете и инструкции jailbreak.

**Как работает функция**:

1.  **Извлечение данных из запроса**: Извлекает данные о разговоре, доступе к интернету и запросе пользователя из JSON-запроса.
2.  **Генерация системного сообщения**: Создает системное сообщение, которое содержит информацию о текущей дате и языке ответа.
3.  **Инициализация разговора**: Инициализирует разговор с системным сообщением.
4.  **Добавление существующих сообщений**: Добавляет существующие сообщения в разговор.
5.  **Добавление результатов поиска**: Если включен доступ к интернету, добавляет результаты поиска в разговор.
6.  **Добавление инструкций jailbreak**: Если указаны инструкции jailbreak, добавляет их в разговор.
7.  **Добавление запроса пользователя**: Добавляет запрос пользователя в разговор.
8.  **Уменьшение размера разговора**: Уменьшает размер разговора, чтобы избежать ошибок, связанных с количеством токенов API.
9.  **Возврат списка сообщений**: Возвращает список сообщений.

```
    Извлечение данных из запроса
    │
    Создание системного сообщения
    │
    Инициализация разговора
    │
    Добавление существующих сообщений
    │
    Добавление результатов поиска (если есть доступ к интернету)
    │
    Добавление инструкций jailbreak (если указаны)
    │
    Добавление запроса пользователя
    │
    Уменьшение размера разговора
    │
    Возврат списка сообщений
```

**Примеры**:

```python
# Пример вызова функции с jailbreak
messages = build_messages("Default")

# Пример вызова функции без jailbreak
messages = build_messages(None)
```

### `fetch_search_results(query)`

```python
def fetch_search_results(query):
    """
    Выполняет поиск в интернете и возвращает результаты.

    Args:
        query (str): Поисковый запрос.

    Returns:
        list: Список результатов поиска.
    """
```

**Назначение**: Функция `fetch_search_results` выполняет поиск в интернете с использованием API DuckDuckGo и возвращает результаты в формате, пригодном для добавления в разговор с моделью.

**Как работает функция**:

1.  **Выполнение поискового запроса**: Отправляет GET-запрос к API DuckDuckGo с поисковым запросом и ограничением на количество результатов.
2.  **Обработка результатов**: Обрабатывает результаты поиска, формируя строку с краткими описаниями и URL каждого результата.
3.  **Формирование сообщения**: Формирует сообщение с результатами поиска в формате, пригодном для добавления в разговор с моделью.
4.  **Возврат списка сообщений**: Возвращает список, содержащий сообщение с результатами поиска.

```
    Выполнение поискового запроса
    │
    Обработка результатов
    │
    Формирование сообщения
    │
    Возврат списка сообщений
```

**Примеры**:

```python
# Пример вызова функции с поисковым запросом
results = fetch_search_results("Что такое машинное обучение")
```

### `generate_stream(response, jailbreak)`

```python
def generate_stream(response, jailbreak):
    """
    Генерирует поток сообщений на основе ответа модели.

    Args:
        response: Ответ модели.
        jailbreak: Инструкция jailbreak.

    Yields:
        str: Поток сообщений.
    """
```

**Назначение**: Функция `generate_stream` генерирует поток сообщений на основе ответа модели. Она обрабатывает инструкции jailbreak, проверяя, было ли успешно выполнено условие jailbreak, и возвращает поток сообщений.

**Как работает функция**:

1.  **Проверка jailbreak**: Проверяет, включены ли инструкции jailbreak.
2.  **Обработка jailbreak**: Если инструкции jailbreak включены, функция проверяет, было ли успешно выполнено условие jailbreak. Если условие jailbreak выполнено, функция возвращает поток сообщений. Если условие jailbreak не выполнено, функция возвращает частичный ответ.
3.  **Возврат потока сообщений**: Если инструкции jailbreak не включены, функция возвращает поток сообщений.

```
    Проверка jailbreak
    │
    Обработка jailbreak (если включены инструкции)
    │
    Возврат потока сообщений
```

**Примеры**:

```python
# Пример вызова функции с jailbreak
stream = generate_stream(response, "Default")

# Пример вызова функции без jailbreak
stream = generate_stream(response, None)
```

### `response_jailbroken_success(response: str) -> bool`

```python
def response_jailbroken_success(response: str) -> bool:
    """
    Проверяет, было ли успешно выполнено условие jailbreak.

    Args:
        response (str): Ответ модели.

    Returns:
        bool: True, если условие jailbreak выполнено, False в противном случае.
    """
```

**Назначение**: Функция `response_jailbroken_success` проверяет, было ли успешно выполнено условие jailbreak, путем поиска определенного паттерна в ответе модели.

**Как работает функция**:

1.  **Поиск паттерна**: Ищет паттерн `ACT:` в ответе модели.
2.  **Возврат результата**: Возвращает True, если паттерн найден, False в противном случае.

```
    Поиск паттерна "ACT:" в ответе
    │
    Возврат результата (True, если паттерн найден, False в противном случае)
```

**Примеры**:

```python
# Пример вызова функции с ответом, содержащим паттерн "ACT:"
success = response_jailbroken_success("ACT: Some text")

# Пример вызова функции с ответом, не содержащим паттерн "ACT:"
success = response_jailbroken_success("Some text")
```

### `response_jailbroken_failed(response)`

```python
def response_jailbroken_failed(response):
    """
    Проверяет, не провалилось ли условие jailbreak.

    Args:
        response: Ответ модели.

    Returns:
        bool: False, если длина ответа менее 4 символов или ответ начинается с "GPT:" или "ACT:", True в противном случае.
    """
```

**Назначение**: Функция `response_jailbroken_failed` проверяет, не провалилось ли условие jailbreak, путем анализа начала ответа модели.

**Как работает функция**:

1.  **Проверка длины ответа**: Проверяет, что длина ответа больше или равна 4 символам.
2.  **Проверка начала ответа**: Проверяет, что ответ не начинается с `GPT:` или `ACT:`.
3.  **Возврат результата**: Возвращает `False`, если длина ответа меньше 4 символов или ответ начинается с `GPT:` или `ACT:`, `True` в противном случае.

```
    Проверка длины ответа
    │
    Проверка начала ответа (GPT: или ACT:)
    │
    Возврат результата
```

**Примеры**:

```python
# Пример вызова функции с ответом, начинающимся с "GPT:"
failed = response_jailbroken_failed("GPT: Some text")

# Пример вызова функции с ответом, не начинающимся с "GPT:" или "ACT:"
failed = response_jailbroken_failed("Some text")
```

### `set_response_language(prompt)`

```python
def set_response_language(prompt):
    """
    Определяет язык запроса и возвращает строку с инструкцией для модели.

    Args:
        prompt: Запрос пользователя.

    Returns:
        str: Строка с инструкцией для модели.
    """
```

**Назначение**: Функция `set_response_language` определяет язык запроса пользователя с помощью `googletrans` и возвращает строку с инструкцией для модели, указывающей, на каком языке следует отвечать.

**Как работает функция**:

1.  **Определение языка**: Определяет язык запроса пользователя с помощью `translator.detect`.
2.  **Формирование инструкции**: Формирует строку с инструкцией для модели, указывающей, на каком языке следует отвечать.
3.  **Возврат инструкции**: Возвращает строку с инструкцией.

```
    Определение языка запроса
    │
    Формирование инструкции для модели
    │
    Возврат инструкции
```

**Примеры**:

```python
# Пример вызова функции с запросом на английском языке
instruction = set_response_language({"content": "Hello, how are you?"})

# Пример вызова функции с запросом на русском языке
instruction = set_response_language({"content": "Привет, как дела?"})
```

### `isJailbreak(jailbreak)`

```python
def isJailbreak(jailbreak):
    """
    Проверяет, включены ли инструкции jailbreak.

    Args:
        jailbreak: Инструкция jailbreak.

    Returns:
        list: Инструкции jailbreak, если они включены, None в противном случае.
    """
```

**Назначение**: Функция `isJailbreak` проверяет, включены ли инструкции jailbreak, и возвращает их, если они включены.

**Как работает функция**:

1.  **Проверка значения jailbreak**: Проверяет, что значение `jailbreak` не равно `Default`.
2.  **Возврат инструкций**: Если значение `jailbreak` не равно `Default`, функция возвращает инструкции jailbreak из словаря `special_instructions`, если они там есть. Если инструкции jailbreak не найдены, функция возвращает `None`. Если значение `jailbreak` равно `Default`, функция возвращает `None`.

```
    Проверка значения jailbreak (не равно "Default")
    │
    Возврат инструкций jailbreak (если найдены в special_instructions) или None
```

**Примеры**:

```python
# Пример вызова функции с jailbreak "Default"
instructions = isJailbreak("Default")

# Пример вызова функции с jailbreak "Custom"
instructions = isJailbreak("Custom")
```

### `Backend_Api._conversation(self)`

```python
def _conversation(self):
    """
    Обрабатывает запрос на генерацию ответа от модели.

    Returns:
        flask.Response: Поток сгенерированного текста или словарь с ошибкой.
    """
```

**Назначение**: Метод `_conversation` класса `Backend_Api` обрабатывает POST-запрос к endpoint `/backend-api/v2/conversation`. Он извлекает данные из запроса, генерирует ответ с использованием выбранной модели и возвращает поток сгенерированного текста.

**Как работает функция**:

1.  **Извлечение данных из запроса**: Извлекает данные о стриминге, jailbreak и выбранной модели из JSON-запроса.
2.  **Формирование сообщений**: Формирует список сообщений для отправки в модель с использованием функции `build_messages`.
3.  **Генерация ответа**: Генерирует ответ с использованием API `g4f.ChatCompletion.create`.
4.  **Обработка ошибок**: Обрабатывает возможные ошибки при генерации ответа.
5.  **Возврат потока**: Возвращает поток сгенерированного текста в формате `text/event-stream`.

```
    Извлечение данных из запроса
    │
    Формирование сообщений
    │
    Генерация ответа
    │
    Обработка ошибок
    │
    Возврат потока
```

**Примеры**:

```python
# Пример вызова метода
response = backend_api._conversation()