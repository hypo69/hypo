# Модуль Vitalentum

## Обзор

Модуль предоставляет класс `Vitalentum`, который является асинхронным генератором ответов от API Vitalentum. Поддерживает модель `gpt-3.5-turbo`.
Модуль предназначен для интеграции с сервисом Vitalentum, предоставляющим доступ к языковым моделям через API.

## Подробней

Модуль использует библиотеку `aiohttp` для выполнения асинхронных HTTP-запросов.
Он преобразует входящие сообщения в формат, ожидаемый API Vitalentum, отправляет запрос и возвращает асинхронный генератор, который выдаёт содержимое ответа по частям.

## Классы

### `Vitalentum`

**Описание**:
Класс `Vitalentum` является провайдером асинхронного генератора, взаимодействующим с API Vitalentum.

**Наследует**:
`AsyncGeneratorProvider` - базовый класс для асинхронных провайдеров генераторов.

**Аттрибуты**:
- `url` (str): URL API Vitalentum.
- `supports_gpt_35_turbo` (bool): Указывает, что провайдер поддерживает модель `gpt-3.5-turbo`.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для взаимодействия с API Vitalentum.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для взаимодействия с API Vitalentum.

    Args:
        model (str): Модель, используемая для генерации ответа.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы для передачи в API.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий части ответа от API.

    Raises:
        Exception: В случае ошибки при выполнении HTTP-запроса.

    Example:
        async for content in Vitalentum.create_async_generator(model="gpt-3.5-turbo", messages=[{"role": "user", "content": "Hello"}]):
            print(content, end="")
    """
```

**Назначение**:
Создание асинхронного генератора, который отправляет сообщения в API Vitalentum и возвращает сгенерированный контент частями.

**Параметры**:
- `cls`: Ссылка на класс `Vitalentum`.
- `model` (str): Имя модели, используемой для генерации ответа.
- `messages` (Messages): Список сообщений, отправляемых в API. Каждое сообщение представляет собой словарь с ключами `"role"` (роль отправителя, например, `"user"` или `"bot"`) и `"content"` (текст сообщения).
- `proxy` (str, optional): URL прокси-сервера, если необходимо использовать прокси для подключения к API. По умолчанию `None`.
- `**kwargs`: Дополнительные именованные аргументы, которые передаются в API Vitalentum.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который выдает части сгенерированного контента от API Vitalentum.

**Вызывает исключения**:
- `Exception`: Может возникнуть исключение, если HTTP-запрос завершится с ошибкой или если возникнут проблемы при обработке ответа от API.

**Как работает функция**:

1. **Подготовка заголовков**:
   - Создаются заголовки HTTP-запроса, включающие `User-Agent`, `Accept`, `Origin`, `Referer` и другие необходимые параметры.
   - Заголовки используются для имитации запроса от браузера.
2. **Преобразование сообщений**:
   - Список сообщений (`messages`) преобразуется в формат JSON, ожидаемый API Vitalentum.
   - Роли `"user"` и `"bot"` в сообщениях преобразуются в `"human"` и `"bot"` соответственно.
   - Формируется словарь `conversation`, содержащий историю сообщений.
3. **Формирование данных запроса**:
   - Создается словарь `data`, включающий `conversation`, `temperature` (температура генерации) и дополнительные аргументы (`kwargs`).
4. **Выполнение асинхронного запроса**:
   - Используется `aiohttp.ClientSession` для выполнения асинхронного POST-запроса к API Vitalentum (`f"{cls.url}/api/converse-edge"`).
   - В запрос передаются заголовки (`headers`), данные (`data`) и прокси (`proxy`), если он указан.
5. **Обработка ответа**:
   - Полученный ответ обрабатывается построчно.
   - Каждая строка декодируется из байтов в строку.
   - Если строка начинается с `"data: "`, то она содержит данные от API.
   - Если строка `"data: [DONE]"`, то генерация завершена и цикл прерывается.
   - Иначе строка преобразуется из JSON в словарь.
   - Из словаря извлекается содержимое (`content`) из поля `line["choices"][0]["delta"].get("content")`.
   - Если содержимое существует, оно передается в генератор с помощью `yield content`.

**ASCII flowchart**:

```
Начало
  ↓
[Подготовка заголовков]
  ↓
[Преобразование сообщений]
  ↓
[Формирование данных запроса]
  ↓
[Выполнение асинхронного POST-запроса]
  ↓
[Обработка ответа]
  │
  ├── Строка начинается с "data: "? ── Да → [Обработка данных]
  │   │
  │   └── Нет → [Следующая строка]
  │
  ↓
[Генерация завершена?] ── Да → Конец
  │
  └── Нет → [Обработка данных: Извлечение и передача content через yield]
  ↓
[Следующая итерация обработки ответа]
  ↓
Конец
```

**Примеры**:

```python
# Пример 1: Простой запрос с использованием gpt-3.5-turbo
async for content in Vitalentum.create_async_generator(model="gpt-3.5-turbo", messages=[{"role": "user", "content": "Привет, как дела?"}]):
    print(content, end="")

# Пример 2: Запрос с использованием прокси
async for content in Vitalentum.create_async_generator(model="gpt-3.5-turbo", messages=[{"role": "user", "content": "Расскажи о Python"}], proxy="http://your_proxy:8080"):
    print(content, end="")

# Пример 3: Запрос с дополнительными параметрами
async for content in Vitalentum.create_async_generator(model="gpt-3.5-turbo", messages=[{"role": "user", "content": "Напиши короткий стих"}], temperature=0.9):
    print(content, end="")