# Модуль `DeepInfra`

## Обзор

Модуль `DeepInfra` предоставляет класс для взаимодействия с сервисом DeepInfra, который предоставляет API для работы с различными моделями, включая модели генерации текста и генерации изображений. Этот модуль позволяет использовать модели DeepInfra для создания асинхронных генераторов текста и изображений.

## Подробнее

Модуль предназначен для интеграции с API DeepInfra и обеспечивает удобный интерфейс для работы с моделями, требующими аутентификации. Он включает в себя методы для получения списка доступных моделей, создания асинхронных генераторов текста и создания изображений на основе текстовых запросов. Модуль использует асинхронные запросы для обеспечения неблокирующей работы.

## Классы

### `DeepInfra`

**Описание**: Класс `DeepInfra` является наследником класса `OpenaiTemplate` и предоставляет методы для взаимодействия с API DeepInfra.

**Наследует**: `OpenaiTemplate`

**Атрибуты**:
- `url` (str): URL главной страницы DeepInfra.
- `login_url` (str): URL страницы для получения API ключа.
- `api_base` (str): Базовый URL для API запросов DeepInfra.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `needs_auth` (bool): Флаг, указывающий на необходимость аутентификации.
- `default_model` (str): Модель, используемая по умолчанию для генерации текста.
- `default_image_model` (str): Модель, используемая по умолчанию для генерации изображений.
- `models` (list): Список доступных текстовых моделей (инициализируется при первом вызове `get_models`).
- `image_models` (list): Список доступных моделей для генерации изображений (инициализируется при первом вызове `get_models`).

**Методы**:
- `get_models()`: Возвращает список доступных моделей.
- `get_image_models()`: Возвращает список доступных моделей для генерации изображений.
- `create_async_generator()`: Создает асинхронный генератор для генерации текста или изображения.
- `create_async_image()`: Создает изображение на основе текстового запроса.

## Функции

### `get_models`

```python
    @classmethod
    def get_models(cls, **kwargs):
        """Получает список доступных моделей из API DeepInfra.

        Args:
            **kwargs: Дополнительные параметры.

        Returns:
            list: Список доступных моделей.

        Как работает функция:
        1. Проверяет, был ли уже загружен список моделей (хранится в `cls.models`).
        2. Если список моделей не был загружен, делает запрос к API DeepInfra для получения списка моделей.
        3. Разделяет полученный список на текстовые модели и модели для генерации изображений.
        4. Сохраняет списки моделей в `cls.models` и `cls.image_models`.
        5. Возвращает общий список моделей.

        A → B → C → D → E

        A: Проверка наличия списка моделей
        |
        B: Запрос к API DeepInfra
        |
        C: Разделение моделей на текстовые и графические
        |
        D: Сохранение списков моделей
        |
        E: Возврат общего списка моделей

        Example:
            >>> DeepInfra.get_models()
            ['meta-llama/Meta-Llama-3.1-70B-Instruct', 'stabilityai/sd3.5', ...]
        """
```

### `get_image_models`

```python
    @classmethod
    def get_image_models(cls, **kwargs):
        """Получает список доступных моделей для генерации изображений.

        Args:
            **kwargs: Дополнительные параметры.

        Returns:
            list: Список доступных моделей для генерации изображений.

        Как работает функция:
        1. Проверяет, был ли уже загружен список моделей для генерации изображений (хранится в `cls.image_models`).
        2. Если список моделей не был загружен, вызывает `cls.get_models()` для загрузки всех моделей.
        3. Возвращает список моделей для генерации изображений.

        A → B → C

        A: Проверка наличия списка моделей изображений
        |
        B: Вызов `cls.get_models()`
        |
        C: Возврат списка моделей изображений

        Example:
            >>> DeepInfra.get_image_models()
            ['stabilityai/sd3.5', ...]
        """
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        stream: bool,
        prompt: str = None,
        temperature: float = 0.7,
        max_tokens: int = 1028,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для генерации текста или изображения.

        Args:
            model (str): Название модели для использования.
            messages (Messages): Список сообщений для передачи в модель.
            stream (bool): Флаг, указывающий на необходимость потоковой передачи данных.
            prompt (str, optional): Текстовый запрос. По умолчанию `None`.
            temperature (float, optional): Температура для генерации текста. По умолчанию 0.7.
            max_tokens (int, optional): Максимальное количество токенов для генерации. По умолчанию 1028.
            **kwargs: Дополнительные параметры.

        Yields:
            AsyncResult: Асинхронный результат генерации текста или изображения.

        Как работает функция:
        1. Проверяет, является ли выбранная модель моделью для генерации изображений.
        2. Если модель для генерации изображений, вызывает `cls.create_async_image()` для создания изображения и возвращает результат.
        3. Если модель для генерации текста, устанавливает заголовки для запроса.
        4. Вызывает `super().create_async_generator()` для создания асинхронного генератора текста.
        5. Передает полученные чанки данных.

        A → B → C → D → E

        A: Проверка типа модели (текст или изображение)
        |
        B: Если изображение → Вызов `cls.create_async_image()`
        |
        C: Если текст → Установка заголовков запроса
        |
        D: Вызов `super().create_async_generator()` для создания асинхронного генератора текста
        |
        E: Передача полученных чанков данных

        Example:
            async for chunk in DeepInfra.create_async_generator(
                model='meta-llama/Meta-Llama-3.1-70B-Instruct',
                messages=[{'role': 'user', 'content': 'Hello'}],
                stream=True
            ):
                print(chunk)
        """
```

### `create_async_image`

```python
    @classmethod
    async def create_async_image(
        cls,
        prompt: str,
        model: str,
        api_key: str = None,
        api_base: str = "https://api.deepinfra.com/v1/inference",
        proxy: str = None,
        timeout: int = 180,
        extra_data: dict = {},\
        **kwargs
    ) -> ImageResponse:
        """Создает изображение на основе текстового запроса.

        Args:
            prompt (str): Текстовый запрос для генерации изображения.
            model (str): Название модели для использования.
            api_key (str, optional): API ключ для аутентификации. По умолчанию `None`.
            api_base (str, optional): Базовый URL для API запросов. По умолчанию `"https://api.deepinfra.com/v1/inference"`.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            timeout (int, optional): Время ожидания запроса в секундах. По умолчанию 180.
            extra_data (dict, optional): Дополнительные данные для передачи в запросе. По умолчанию `{}`.
            **kwargs: Дополнительные параметры.

        Returns:
            ImageResponse: Объект `ImageResponse` с информацией об изображении.

        Raises:
            RuntimeError: Если API возвращает ошибку или не содержит изображения.

        Как работает функция:
        1. Устанавливает заголовки для запроса.
        2. Если предоставлен API ключ, добавляет его в заголовки.
        3. Создает асинхронную сессию для выполнения запроса.
        4. Получает название модели для API запроса.
        5. Формирует данные для запроса, включая текстовый запрос и дополнительные данные.
        6. Отправляет POST запрос к API DeepInfra.
        7. Обрабатывает ответ от API.
        8. Извлекает изображение из ответа.
        9. Возвращает объект `ImageResponse` с информацией об изображении.

        A → B → C → D → E → F → G → H → I

        A: Установка заголовков запроса
        |
        B: Добавление API ключа в заголовки (если предоставлен)
        |
        C: Создание асинхронной сессии
        |
        D: Получение названия модели для API запроса
        |
        E: Формирование данных для запроса
        |
        F: Отправка POST запроса к API DeepInfra
        |
        G: Обработка ответа от API
        |
        H: Извлечение изображения из ответа
        |
        I: Возврат объекта `ImageResponse`

        Example:
            image_response = await DeepInfra.create_async_image(
                prompt='A cat',
                model='stabilityai/sd3.5',
                api_key='YOUR_API_KEY'
            )
            print(image_response.images)
        """