# Модуль `ChatgptFree.py`

## Обзор

Модуль предоставляет асинхронный генератор для взаимодействия с моделью `gpt-4o-mini-2024-07-18` через API `chatgptfree.ai`. 
Этот модуль позволяет отправлять сообщения и получать ответы в режиме реального времени. Он также включает в себя логику для обработки ошибок и извлечения необходимой информации из ответов API.

## Подробней

Модуль предназначен для интеграции с платформой `chatgptfree.ai`, предоставляя асинхронный интерфейс для обмена сообщениями с моделью `gpt-4o-mini-2024-07-18`. 
Код извлекает идентификаторы `post_id` и `nonce` из HTML-кода главной страницы, которые необходимы для последующих запросов. 
Затем он формирует запрос с сообщением пользователя и отправляет его на сервер, обрабатывая ответ в реальном времени и возвращая контент в виде асинхронного генератора.

## Классы

### `ChatgptFree`

**Описание**: Класс `ChatgptFree` предоставляет асинхронный генератор для взаимодействия с API `chatgptfree.ai`.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL для доступа к `chatgptfree.ai`.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `_post_id` (str): Идентификатор поста, необходимый для запросов.
- `_nonce` (str): Одноразовый токен, необходимый для запросов.
- `default_model` (str): Модель, используемая по умолчанию (`gpt-4o-mini-2024-07-18`).
- `models` (list): Список поддерживаемых моделей, содержащий только `default_model`.
- `model_aliases` (dict): Словарь, содержащий псевдонимы моделей.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для обмена сообщениями с API.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    timeout: int = 120,
    cookies: dict = None,
    **kwargs
) -> AsyncGenerator[str, None]:
    """
    Создает асинхронный генератор для обмена сообщениями с API `chatgptfree.ai`.

    Args:
        model (str): Модель для использования (например, `gpt-4o-mini-2024-07-18`).
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        timeout (int, optional): Максимальное время ожидания запроса в секундах. По умолчанию `120`.
        cookies (dict, optional): Куки для отправки с запросом. По умолчанию `None`.

    Returns:
        AsyncGenerator[str, None]: Асинхронный генератор, возвращающий контент ответа.

    Raises:
        RuntimeError: Если не удается найти `post_id` или `nonce`.
        Exception: Если возникает ошибка при выполнении запроса.
    """
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор для взаимодействия с API `chatgptfree.ai`. 
Она отправляет сообщения и возвращает ответы в режиме реального времени.

**Параметры**:
- `cls`: Ссылка на класс `ChatgptFree`.
- `model` (str): Модель для использования (например, `gpt-4o-mini-2024-07-18`).
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `timeout` (int, optional): Максимальное время ожидания запроса в секундах. По умолчанию `120`.
- `cookies` (dict, optional): Куки для отправки с запросом. По умолчанию `None`.

**Возвращает**:
- `AsyncGenerator[str, None]`: Асинхронный генератор, возвращающий контент ответа.

**Вызывает исключения**:
- `RuntimeError`: Если не удается найти `post_id` или `nonce`.

**Как работает функция**:

1.  **Инициализация**: Функция принимает параметры, необходимые для взаимодействия с API, такие как модель, сообщения, прокси, таймаут и куки.

2.  **Подготовка заголовков**: Создаются заголовки HTTP-запроса, включая User-Agent, Referer и другие необходимые параметры.

3.  **Создание сессии**: Создается асинхронная сессия с использованием `StreamSession` для управления запросами и ответами. Если `_nonce` не определен, функция пытается получить его с главной страницы `chatgptfree.ai`.

4.  **Извлечение `post_id` и `nonce`**: Извлекаются `post_id` и `nonce` из HTML-кода главной страницы с использованием регулярных выражений. Если не удается найти эти значения, выбрасывается исключение `RuntimeError`.

5.  **Формирование данных запроса**: Формируются данные для POST-запроса, включая `_wpnonce`, `post_id`, URL, действие (`wpaicg_chat_shortcode_message`), сообщение и идентификатор бота.

6.  **Отправка запроса и обработка ответа**: Отправляется POST-запрос на `admin-ajax.php` с сформированными данными и куками. Функция итерируется по строкам ответа, декодирует их и извлекает контент из JSON-данных.

7.  **Генерация контента**: Если строка начинается с `data:`, извлекается JSON, и извлекается контент из поля `choices[0].delta.content`. Этот контент возвращается через асинхронный генератор.

8.  **Обработка ошибок JSON**: Если возникает ошибка при декодировании JSON, функция продолжает обработку.

9.  **Обработка финального ответа**: После завершения итерации по строкам, функция проверяет, остался ли буфер с данными. Если да, она пытается декодировать его как JSON и возвращает поле `data`, если оно присутствует.

10. **Обработка ошибок декодирования**: Если не удается декодировать финальный JSON, выводится сообщение об ошибке.

```
Инициализация
    ↓
Получение nonce (если отсутствует)
    ↓
Формирование данных запроса
    ↓
Отправка POST-запроса
    ↓
Итерация по строкам ответа
    ↓
Извлечение JSON-данных (если строка начинается с "data:")
    ↓
Извлечение контента из choices[0].delta.content
    ↓
Генерация контента через async yield
    ↓
Обработка финального ответа (если есть буфер)
    ↓
Вывод ошибки декодирования (если не удалось декодировать финальный JSON)
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from typing import AsyncGenerator, List, Dict, Optional

async def main():
    messages: List[Dict[str, str]] = [{"role": "user", "content": "Привет!"}]
    model: str = "gpt-4o-mini-2024-07-18"

    async def print_generator(generator: AsyncGenerator[str, None]):
        async for message in generator:
            print(message, end="")

    generator: AsyncGenerator[str, None] = await ChatgptFree.create_async_generator(model=model, messages=messages)
    await print_generator(generator)

if __name__ == "__main__":
    asyncio.run(main())