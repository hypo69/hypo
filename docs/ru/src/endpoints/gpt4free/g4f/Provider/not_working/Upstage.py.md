# Модуль для работы с провайдером Upstage
=================================================

Модуль содержит класс `Upstage`, который используется для взаимодействия с API Upstage AI для генерации текста.
Он поддерживает стриминг ответов и выбор различных моделей.

## Обзор

Модуль предоставляет асинхронный интерфейс для взаимодействия с API Upstage AI, позволяя генерировать текст на основе предоставленных сообщений. Он поддерживает различные модели, предоставляемые Upstage, и обеспечивает возможность использования прокси-серверов.

## Подробней

Этот модуль является частью системы, использующей различные AI-модели для генерации ответов. Класс `Upstage` предоставляет удобный интерфейс для отправки запросов к API Upstage AI и получения результатов в асинхронном режиме.

## Классы

### `Upstage`

**Описание**: Класс для взаимодействия с API Upstage AI.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL главной страницы Upstage AI.
- `api_endpoint` (str): URL API для запросов на завершение текста.
- `working` (bool): Флаг, указывающий, работает ли провайдер в данный момент.
- `default_model` (str): Модель, используемая по умолчанию, если не указана другая.
- `models` (List[str]): Список поддерживаемых моделей.
- `model_aliases` (Dict[str, str]): Словарь псевдонимов моделей для удобства использования.

**Методы**:
- `get_model(model: str) -> str`: Возвращает имя модели на основе псевдонима или имени.
- `create_async_generator(model: str, messages: Messages, proxy: str = None, **kwargs) -> AsyncResult`: Создает асинхронный генератор для получения ответов от API Upstage AI.

## Функции

### `get_model`

```python
    @classmethod
    def get_model(cls, model: str) -> str:
        """Возвращает имя модели на основе псевдонима или имени.

        Args:
            model (str): Имя модели или псевдоним.

        Returns:
            str: Имя модели.
        """
```

**Назначение**: Получение корректного имени модели на основе предоставленного псевдонима или имени.

**Параметры**:
- `model` (str): Имя модели или псевдоним.

**Возвращает**:
- `str`: Имя модели.

**Как работает функция**:
1. Проверяет, является ли предоставленное имя модели (`model`) одним из поддерживаемых (`cls.models`).
2. Если имя модели найдено в списке поддерживаемых моделей, функция возвращает это имя.
3. Если имя модели не найдено в списке поддерживаемых, функция проверяет, есть ли псевдоним для этой модели в `cls.model_aliases`.
4. Если псевдоним найден, функция возвращает соответствующее имя модели из `cls.model_aliases`.
5. Если ни имя модели, ни псевдоним не найдены, функция возвращает имя модели по умолчанию (`cls.default_model`).

```
Проверка наличия имени модели в списке поддерживаемых
     │
     ├───> Имя модели найдено?
     │     │
     │     └───> Возврат имени модели
     │
     └───> Проверка наличия псевдонима модели
           │
           ├───> Псевдоним модели найден?
           │     │
           │     └───> Возврат соответствующего имени модели из псевдонимов
           │
           └───> Возврат имени модели по умолчанию
```

**Примеры**:
```python
Upstage.get_model('solar-pro')  # Возвращает 'solar-pro'
Upstage.get_model('solar-mini') # Возвращает 'upstage/solar-1-mini-chat-ja' (или 'upstage/solar-1-mini-chat' в зависимости от реализации aliases)
Upstage.get_model('unknown')    # Возвращает 'solar-pro' (default_model)
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для получения ответов от API Upstage AI.

        Args:
            model (str): Имя модели.
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.

        Returns:
            AsyncResult: Асинхронный генератор для получения ответов.
        """
```

**Назначение**: Создание асинхронного генератора для взаимодействия с API Upstage AI и получения ответов.

**Параметры**:
- `model` (str): Имя используемой модели.
- `messages` (Messages): Список сообщений, отправляемых в API.
- `proxy` (str, optional): URL прокси-сервера (если требуется). По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, предоставляющий ответы от API.

**Как работает функция**:
1. Получает имя модели, используя метод `get_model`.
2. Определяет заголовки (`headers`) для HTTP-запроса, включая User-Agent, Content-Type и другие необходимые параметры.
3. Создает асинхронную сессию (`ClientSession`) с заданными заголовками.
4. Формирует данные (`data`) для отправки в API, включая сообщения и имя модели.
5. Отправляет POST-запрос к API (`cls.api_endpoint`) с использованием асинхронной сессии, передавая данные и прокси-сервер (если указан).
6. Обрабатывает ответ от API в асинхронном режиме:
   - Читает ответ построчно.
   - Если строка начинается с "data: " и не равна "data: [DONE]", пытается извлечь контент из JSON.
   - Извлеченный контент передается через `yield`, что делает функцию генератором.
   - Если строка равна "data: [DONE]", завершает генерацию.

```
Получение имени модели
     │
     ↓
     Определение заголовков
     │
     ↓
     Создание асинхронной сессии
     │
     ↓
     Формирование данных для отправки
     │
     ↓
     Отправка POST-запроса к API
     │
     ↓
     Обработка ответа от API в асинхронном режиме
     │
     └──> Чтение ответа построчно
     │    │
     │    └──> Проверка строки на "data: " и "[DONE]"
     │         │
     │         ├──> Извлечение контента из JSON
     │         │    │
     │         │    └──> Передача контента через yield
     │         │
     │         └──> Завершение генерации при "data: [DONE]"
     │
     ↓
     Завершение
```

**Примеры**:
```python
# Пример использования create_async_generator
messages = [{"role": "user", "content": "Напиши короткий рассказ."}]
async for message in Upstage.create_async_generator(model='solar-pro', messages=messages):
    print(message, end="")