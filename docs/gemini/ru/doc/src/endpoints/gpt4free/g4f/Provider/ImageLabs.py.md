# Модуль `ImageLabs`

## Обзор

Модуль `ImageLabs` предоставляет функциональность для генерации изображений с использованием API сервиса ImageLabs. Он включает в себя асинхронный генератор изображений на основе текстовых запросов. Модуль поддерживает указание размеров изображения, негативных запросов и отслеживание прогресса генерации.

## Подробней

Модуль `ImageLabs` предназначен для интеграции с другими частями проекта `hypotez`, требующими функциональность генерации изображений на основе текста. Он использует асинхронные запросы для взаимодействия с API ImageLabs, что позволяет эффективно обрабатывать запросы и предоставляет возможность отслеживания прогресса генерации изображения. Модуль предоставляет методы для создания асинхронного генератора изображений и получения информации о доступных моделях.

## Классы

### `ImageLabs`

**Описание**: Класс `ImageLabs` является асинхронным генератором изображений, использующим API ImageLabs.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность асинхронного генератора.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL сервиса ImageLabs.
- `api_endpoint` (str): URL API для генерации изображений.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу.
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`sdxl-turbo`).
- `default_image_model` (str): Модель изображения, используемая по умолчанию.
- `image_models` (List[str]): Список поддерживаемых моделей изображений.
- `models` (List[str]): Список поддерживаемых моделей.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор изображений.
- `get_model`: Возвращает модель, используемую по умолчанию.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    prompt: str = None,
    negative_prompt: str = "",
    width: int = 1152,
    height: int = 896,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор изображений на основе текстового запроса.

    Args:
        cls (Type[ImageLabs]): Ссылка на класс `ImageLabs`.
        model (str): Модель для генерации изображения.
        messages (Messages): Список сообщений, содержащих текстовый запрос.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        prompt (str, optional): Текстовый запрос для генерации изображения. По умолчанию `None`.
        negative_prompt (str, optional): Негативный запрос для генерации изображения. По умолчанию `""`.
        width (int, optional): Ширина изображения. По умолчанию `1152`.
        height (int, optional): Высота изображения. По умолчанию `896`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий изображения.

    Raises:
        Exception: Если происходит ошибка при генерации изображения.
    """
```

**Назначение**: Создает асинхронный генератор изображений на основе текстового запроса. Функция отправляет запрос к API ImageLabs, опрашивает статус задачи и возвращает URL готового изображения.

**Параметры**:
- `cls` (Type[ImageLabs]): Ссылка на класс `ImageLabs`.
- `model` (str): Модель для генерации изображения.
- `messages` (Messages): Список сообщений, содержащих текстовый запрос.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `prompt` (str, optional): Текстовый запрос для генерации изображения. По умолчанию `None`.
- `negative_prompt` (str, optional): Негативный запрос для генерации изображения. По умолчанию `""`.
- `width` (int, optional): Ширина изображения. По умолчанию `1152`.
- `height` (int, optional): Высота изображения. По умолчанию `896`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий изображения.

**Вызывает исключения**:
- `Exception`: Если происходит ошибка при генерации изображения.

**Как работает функция**:

1. **Инициализация**: Функция принимает параметры, необходимые для генерации изображения, включая модель, текстовый запрос, размеры изображения и прокси-сервер (если указан).
2. **Подготовка заголовков**: Формируются заголовки HTTP-запроса, необходимые для взаимодействия с API ImageLabs.
3. **Создание асинхронной сессии**: Создается асинхронная сессия `aiohttp.ClientSession` с заданными заголовками.
4. **Извлечение текстового запроса**: Если `prompt` не указан, текстовый запрос извлекается из последнего сообщения в списке `messages`.
5. **Формирование полезной нагрузки (payload)**: Создается словарь `payload`, содержащий параметры запроса для генерации изображения, такие как текстовый запрос, размеры изображения и негативный запрос.
6. **Отправка запроса на генерацию**: Отправляется POST-запрос к API ImageLabs (`cls.url}/txt2img`) с сформированной полезной нагрузкой.
7. **Получение ID задачи**: Из ответа извлекается `task_id`, который используется для отслеживания прогресса генерации изображения.
8. **Опрос статуса задачи**: В цикле отправляются POST-запросы к API ImageLabs (`cls.url}/progress`) для получения информации о статусе задачи.
9. **Проверка статуса**: Проверяется статус задачи. Если статус равен `Done` или получен URL готового изображения (`final_image_url`), генератор возвращает объект `ImageResponse` с URL изображения и текстовым запросом.
10. **Обработка ошибок**: Если в статусе задачи обнаружена ошибка, вызывается исключение `Exception` с информацией об ошибке.
11. **Ожидание между опросами**: Между опросами статуса задачи происходит ожидание в течение 1 секунды (`asyncio.sleep(1)`).

```text
Начало
  │
  ├── Подготовка заголовков и создание асинхронной сессии
  │
  ├── Извлечение текстового запроса (prompt)
  │   │
  │   └── Если prompt не указан: Извлечь из messages[-1]["content"]
  │
  ├── Формирование полезной нагрузки (payload)
  │   │
  │   └── Создание словаря с параметрами запроса
  │
  ├── Отправка POST-запроса на генерацию изображения
  │   │
  │   └── Получение task_id из ответа
  │
  ├── Цикл опроса статуса задачи
  │   │
  │   ├── Отправка POST-запроса для получения прогресса
  │   │
  │   ├── Проверка статуса
  │   │   │
  │   │   ├── Если статус == "Done" или final_image_url получен:
  │   │   │   │
  │   │   │   └── Yield ImageResponse(images=[final_image_url], alt=prompt)
  │   │   │
  │   │   ├── Если в статусе есть "error":
  │   │   │   │
  │   │   │   └── Вызвать исключение Exception
  │   │   │
  │   │   └── Ожидание 1 секунду
  │   │
  │   └── Повтор цикла
  │
  └── Конец
```

**Примеры**:

Пример 1: Генерация изображения с использованием текстового запроса.

```python
import asyncio
from src.endpoints.gpt4free.g4f.Provider.ImageLabs import ImageLabs
from src.endpoints.gpt4free.g4f.typing import Messages

async def main():
    model = "sdxl-turbo"
    messages: Messages = [{"role": "user", "content": "A futuristic cityscape"}]
    async for image_response in ImageLabs.create_async_generator(model=model, messages=messages):
        print(image_response)

if __name__ == "__main__":
    asyncio.run(main())
```

Пример 2: Генерация изображения с указанием размеров и негативного запроса.

```python
import asyncio
from src.endpoints.gpt4free.g4f.Provider.ImageLabs import ImageLabs
from src.endpoints.gpt4free.g4f.typing import Messages

async def main():
    model = "sdxl-turbo"
    messages: Messages = [{"role": "user", "content": "A cat wearing a hat"}]
    negative_prompt = "blurry, low quality"
    width = 512
    height = 512
    async for image_response in ImageLabs.create_async_generator(
        model=model, messages=messages, negative_prompt=negative_prompt, width=width, height=height
    ):
        print(image_response)

if __name__ == "__main__":
    asyncio.run(main())
```

### `get_model`

```python
@classmethod
def get_model(cls, model: str) -> str:
    """
    Возвращает модель, используемую по умолчанию.

    Args:
        cls (Type[ImageLabs]): Ссылка на класс `ImageLabs`.
        model (str): Модель для получения.

    Returns:
        str: Модель, используемая по умолчанию.
    """
```

**Назначение**: Возвращает модель, используемую по умолчанию.

**Параметры**:
- `cls` (Type[ImageLabs]): Ссылка на класс `ImageLabs`.
- `model` (str): Модель для получения.

**Возвращает**:
- `str`: Модель, используемая по умолчанию.

**Как работает функция**:

Функция `get_model` просто возвращает значение атрибута `cls.default_model`, который содержит имя модели, используемой по умолчанию.

```text
Начало
  │
  └── Возврат cls.default_model
  │
  └── Конец
```

**Примеры**:

Пример 1: Получение модели по умолчанию.

```python
from src.endpoints.gpt4free.g4f.Provider.ImageLabs import ImageLabs

model = ImageLabs.get_model("some_model")
print(model)
```