# Модуль DeepSeekAPI

## Обзор

Модуль `DeepSeekAPI` предназначен для взаимодействия с API DeepSeek. Он предоставляет асинхронный интерфейс для аутентификации, создания чат-сессий и обмена сообщениями с использованием моделей DeepSeek. Модуль использует библиотеку `dsk.api` для взаимодействия с API DeepSeek, а также включает функциональность для веб-поиска и логирования процесса взаимодействия.

## Подробней

Модуль `DeepSeekAPI` является частью проекта `hypotez` и предназначен для использования в качестве провайдера для работы с языковой моделью DeepSeek. Он реализует асинхронную аутентификацию, создает чат-сессии и обеспечивает взаимодействие с моделью DeepSeek для получения ответов на сообщения пользователя.

Модуль использует следующие компоненты:
- `AsyncAuthedProvider`: Базовый класс для асинхронных провайдеров с поддержкой аутентификации.
- `ProviderModelMixin`: Трейт, предоставляющий общую функциональность для моделей провайдеров.
- `get_last_user_message`: Функция для извлечения последнего сообщения пользователя из списка сообщений.
- `get_nodriver`, `get_args_from_nodriver`: Функции для получения экземпляра веб-драйвера и аргументов для его запуска.
- `AuthResult`, `RequestLogin`, `Reasoning`, `JsonConversation`, `FinishReason`: Классы для представления результатов аутентификации, запросов на вход, промежуточных рассуждений, истории разговоров в формате JSON и причин завершения диалога.
- `DskAPI`: Класс из библиотеки `dsk.api` для взаимодействия с API DeepSeek.

Модуль поддерживает следующие модели DeepSeek:
- "deepseek-v3"
- "deepseek-r1"

## Классы

### `DeepSeekAPI`

**Описание**: Класс `DeepSeekAPI` предоставляет асинхронный интерфейс для взаимодействия с API DeepSeek. Он реализует методы для аутентификации, создания чат-сессий и обмена сообщениями.

**Наследует**:
- `AsyncAuthedProvider`: Обеспечивает поддержку асинхронной аутентификации.
- `ProviderModelMixin`: Предоставляет общую функциональность для моделей провайдеров.

**Атрибуты**:
- `url` (str): URL для доступа к API DeepSeek ("https://chat.deepseek.com").
- `working` (bool): Флаг, указывающий, работает ли модуль (зависит от наличия библиотеки `dsk.api`).
- `needs_auth` (bool): Флаг, указывающий, требуется ли аутентификация (True).
- `use_nodriver` (bool): Флаг, указывающий, используется ли безголовый браузер (True).
- `_access_token` (str | None): Приватный атрибут для хранения токена доступа.
- `default_model` (str): Модель, используемая по умолчанию ("deepseek-v3").
- `models` (List[str]): Список поддерживаемых моделей (["deepseek-v3", "deepseek-r1"]).
**Принцип работы**:
    1. Класс использует `AsyncAuthedProvider` для управления аутентификацией, позволяя выполнять вход через веб-интерфейс и сохранять токен доступа.
    2.  При создании экземпляра класса, он использует `DskAPI` для взаимодействия с API DeepSeek, используя токен доступа, полученный в процессе аутентификации.
    3.  Для каждого запроса, класс создает или использует существующую чат-сессию, отправляет сообщения и получает ответы, обрабатывая различные типы ответов, такие как размышления и текст.

**Методы**:
- `on_auth_async`: Асинхронный метод для аутентификации пользователя.
- `create_authed`: Асинхронный метод для создания аутентифицированного запроса к API DeepSeek.

## Функции

### `on_auth_async`

```python
@classmethod
async def on_auth_async(cls, proxy: str = None, **kwargs) -> AsyncIterator:
    """Асинхронно аутентифицирует пользователя, получая токен доступа через веб-интерфейс.

    Args:
        proxy (str, optional): Прокси-сервер для использования при подключении. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncIterator: Асинхронный итератор, возвращающий объекты `RequestLogin` и `AuthResult`.

    Raises:
        Exception: Если не удается получить токен доступа.
    """
```

**Назначение**: Метод `on_auth_async` предназначен для аутентификации пользователя в API DeepSeek. Он использует безголовый браузер для перехода на страницу входа, ожидает ввода данных пользователем, получает токен доступа из локального хранилища браузера и возвращает его.

**Параметры**:
- `proxy` (str, optional): Прокси-сервер для использования при подключении. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncIterator`: Асинхронный итератор, возвращающий объекты `RequestLogin` и `AuthResult`.

**Как работает функция**:

1.  **Инициализация браузера**: Если браузер еще не создан, он создается с помощью функции `get_nodriver()`.
2.  **Запрос на вход**: Функция возвращает объект `RequestLogin`, который указывает на необходимость входа пользователя через веб-интерфейс. URL для входа берется из переменной окружения `G4F_LOGIN_URL` или используется пустая строка, если переменная не определена.
3.  **Получение токена доступа**: Функция запускает асинхронную задачу `callback`, которая периодически проверяет наличие токена доступа в локальном хранилище браузера. Токен извлекается из элемента `userToken` в формате JSON.
4.  **Возврат результата аутентификации**: После получения токена, функция возвращает объект `AuthResult`, содержащий токен доступа и дополнительные аргументы, необходимые для дальнейшей работы с API.

ASCII flowchart:

```
A [Проверка наличия браузера]
|
B [Создание браузера, если отсутствует]
|
C [Запрос на вход (RequestLogin)]
|
D [Запуск асинхронной задачи callback для получения токена]
|
E [Ожидание получения токена из localStorage]
|
F [Возврат результата аутентификации (AuthResult)]
```

**Примеры**:

```python
# Пример вызова функции on_auth_async без прокси
async for result in DeepSeekAPI.on_auth_async():
    print(result)

# Пример вызова функции on_auth_async с прокси
async for result in DeepSeekAPI.on_auth_async(proxy="http://proxy.example.com"):
    print(result)
```

### `create_authed`

```python
@classmethod
async def create_authed(
    cls,
    model: str,
    messages: Messages,
    auth_result: AuthResult,
    conversation: JsonConversation = None,
    web_search: bool = False,
    **kwargs
) -> AsyncResult:
    """Создает аутентифицированный запрос к API DeepSeek и возвращает результат.

    Args:
        model (str): Название модели для использования.
        messages (Messages): Список сообщений для отправки.
        auth_result (AuthResult): Результат аутентификации, содержащий токен доступа.
        conversation (JsonConversation, optional): Объект, содержащий историю разговора. По умолчанию `None`.
        web_search (bool, optional): Флаг, указывающий, следует ли использовать веб-поиск. По умолчанию `False`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный итератор, возвращающий результаты взаимодействия с API DeepSeek.
    """
```

**Назначение**: Метод `create_authed` создает аутентифицированный запрос к API DeepSeek. Он инициализирует API с использованием токена доступа, создает или использует существующую чат-сессию, отправляет сообщения пользователя и возвращает результаты взаимодействия с API DeepSeek.

**Параметры**:
- `model` (str): Название модели для использования.
- `messages` (Messages): Список сообщений для отправки.
- `auth_result` (AuthResult): Результат аутентификации, содержащий токен доступа.
- `conversation` (JsonConversation, optional): Объект, содержащий историю разговора. По умолчанию `None`.
- `web_search` (bool, optional): Флаг, указывающий, следует ли использовать веб-поиск. По умолчанию `False`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный итератор, возвращающий результаты взаимодействия с API DeepSeek.

**Как работает функция**:

1.  **Инициализация API**: Функция инициализирует API DeepSeek с использованием токена доступа, полученного в результате аутентификации.
2.  **Создание чат-сессии**: Если объект `conversation` не предоставлен, функция создает новую чат-сессию с помощью метода `create_chat_session()` API DeepSeek.
3.  **Отправка сообщения**: Функция отправляет последнее сообщение пользователя из списка сообщений в API DeepSeek с помощью метода `chat_completion()`. При этом указывается, следует ли использовать веб-поиск и включено ли "размышление" модели (thinking_enabled).
4.  **Обработка результатов**: Функция итерируется по результатам, возвращаемым API DeepSeek, и генерирует объекты `Reasoning` (если модель "размышляет"), текстовые фрагменты и объекты `FinishReason` (если диалог завершен).

ASCII flowchart:

```
A [Инициализация API с использованием токена доступа]
|
B [Проверка наличия объекта conversation]
|
C [Создание новой чат-сессии, если conversation отсутствует]
|
D [Отправка сообщения пользователя в API]
|
E [Итерация по результатам, возвращаемым API]
|
F [Обработка результатов (Reasoning, текст, FinishReason)]
```

**Примеры**:

```python
# Пример вызова функции create_authed
auth_result = AuthResult(api_key="test_key")
messages = [{"role": "user", "content": "Hello"}]
async for result in DeepSeekAPI.create_authed(model="deepseek-v3", messages=messages, auth_result=auth_result):
    print(result)

# Пример вызова функции create_authed с использованием существующей чат-сессии
auth_result = AuthResult(api_key="test_key")
messages = [{"role": "user", "content": "Hello"}]
conversation = JsonConversation(chat_id="123")
async for result in DeepSeekAPI.create_authed(
    model="deepseek-v3", messages=messages, auth_result=auth_result, conversation=conversation
):
    print(result)