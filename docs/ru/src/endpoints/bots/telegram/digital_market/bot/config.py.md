# Модуль конфигурации бота Telegram для цифрового рынка

## Обзор

Этот модуль содержит настройки и конфигурации, необходимые для работы Telegram-бота цифрового рынка. Он определяет параметры, такие как токен бота, идентификаторы администраторов, URL-адреса веб-сайтов, учетные данные для доступа к внешним сервисам и другие переменные среды. Модуль использует `pydantic_settings` для управления настройками и `aiogram` для создания и управления ботом.

## Подробней

Этот модуль является центральным местом для хранения и управления конфигурацией бота. Он использует переменные среды для гибкой настройки параметров, позволяя изменять поведение бота без изменения кода. Файл `.env` содержит значения этих переменных, которые загружаются при инициализации класса `Settings`.

## Классы

### `Settings`

**Описание**: Класс `Settings` наследуется от `BaseSettings` и определяет все необходимые параметры конфигурации для работы бота. Он также включает методы для динамического формирования URL-адресов вебхуков.

**Как работает класс**:
1.  Класс определяет атрибуты, соответствующие переменным среды, таким как `BOT_TOKEN`, `ADMIN_IDS`, `PROVIDER_TOKEN`, `SITE_URL` и другие.
2.  `SettingsConfigDict` используется для указания, что настройки должны загружаться из файла `.env`, расположенного в родительской директории.
3.  Метод `get_webhook_url` динамически формирует URL-адрес для вебхука на основе токена бота и URL-адреса сайта.
4.  Метод `get_provider_hook_url` динамически формирует URL-адрес для вебхука провайдера платежей (Robokassa).

**Методы**:

*   `get_webhook_url`
*   `get_provider_hook_url`

#### `get_webhook_url`

```python
    @property
    def get_webhook_url(self) -> str:
        """Динамически формирует путь для вебхука на основе токена и URL сайта."""
        ...
```

**Назначение**: Формирует URL-адрес для вебхука Telegram бота.

**Как работает функция**:
1.  Функция использует декоратор `@property`, чтобы метод можно было вызывать как атрибут класса.
2.  Функция возвращает строку, содержащую URL-адрес вебхука, сформированный путем объединения `self.SITE_URL` и `self.BOT_TOKEN`.

**Параметры**:

*   `self` (Settings): Экземпляр класса `Settings`.

**Возвращает**:

*   `str`: URL-адрес вебхука.

**Примеры**:

```python
settings = Settings()
webhook_url = settings.get_webhook_url
print(webhook_url)  # Вывод: https://example.com/<токен_бота>
```

#### `get_provider_hook_url`

```python
    @property
    def get_provider_hook_url(self) -> str:
        """Динамически формирует путь для вебхука на основе токена и URL сайта."""
        ...
```

**Назначение**: Формирует URL-адрес для вебхука провайдера платежей (Robokassa).

**Как работает функция**:
1.  Функция использует декоратор `@property`, чтобы метод можно было вызывать как атрибут класса.
2.  Функция возвращает строку, содержащую URL-адрес вебхука, сформированный путем объединения `self.SITE_URL` и строки `/robokassa`.

**Параметры**:

*   `self` (Settings): Экземпляр класса `Settings`.

**Возвращает**:

*   `str`: URL-адрес вебхука провайдера платежей.

**Примеры**:

```python
settings = Settings()
provider_hook_url = settings.get_provider_hook_url
print(provider_hook_url)  # Вывод: https://example.com/robokassa
```

## Функции

### `database_url`

```python
database_url = settings.DB_URL
```

**Назначение**: Глобальная переменная, содержащая URL-адрес базы данных.

**Как работает функция**:
1.  Переменной присваивается значение атрибута `DB_URL` из экземпляра класса `Settings`.

**Параметры**:

*   `settings` (Settings): Экземпляр класса `Settings`.

### `settings`

```python
settings = Settings()
```

**Назначение**: Инициализация настроек из переменных среды.

**Как работает функция**:
1.  Создается экземпляр класса `Settings`, который автоматически загружает переменные среды из файла `.env`.

**Параметры**:

*   Нет параметров.

### `bot`

```python
bot = Bot(token=settings.BOT_TOKEN, default=DefaultBotProperties(parse_mode=ParseMode.HTML))
```

**Назначение**: Инициализация экземпляра бота aiogram.

**Как работает функция**:
1.  `Bot` - класс для работы с Telegram Bot API.
2.  `token` - передается токен бота, полученный из переменной окружения `BOT_TOKEN`.
3.  `default=DefaultBotProperties(parse_mode=ParseMode.HTML)` - устанавливает режим разметки по умолчанию как HTML для отправки сообщений.

**Параметры**:

*   `token` (str): Токен Telegram-бота.
*   `default` (DefaultBotProperties): Настройки по умолчанию для бота, включая режим разметки.

### `dp`

```python
dp = Dispatcher(storage=MemoryStorage())
```

**Назначение**: Инициализация диспетчера aiogram.

**Как работает функция**:
1.  `Dispatcher` - класс для обработки входящих обновлений от Telegram.
2.  `storage=MemoryStorage()` - устанавливает хранилище в памяти для временных данных.

**Параметры**:

*   `storage` (MemoryStorage): Хранилище для данных состояния.

### `admins`

```python
admins = settings.ADMIN_IDS
```

**Назначение**: Список идентификаторов администраторов бота.

**Как работает функция**:
1.  Получает список идентификаторов администраторов из атрибута `ADMIN_IDS` экземпляра класса `Settings`.

**Параметры**:

*   `settings` (Settings): Экземпляр класса `Settings`.

### `logger`

```python
log_file_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), "log.txt")
logger.add(log_file_path, format=settings.FORMAT_LOG, level="INFO", rotation=settings.LOG_ROTATION)
```

**Назначение**: Настройка логирования с использованием `loguru`.

**Как работает функция**:
1.  Определяет путь к файлу лога (`log.txt`) в той же директории, где находится скрипт.
2.  Использует `logger.add` для настройки логирования:
    *   `log_file_path`: Путь к файлу лога.
    *   `format=settings.FORMAT_LOG`: Формат записи логов, определенный в настройках.
    *   `level="INFO"`: Уровень логирования (INFO и выше).
    *   `rotation=settings.LOG_ROTATION`: Размер файла лога, после которого происходит ротация (10 MB).

**Параметры**:

*   `log_file_path` (str): Путь к файлу лога.
*   `format` (str): Формат записи логов.
*   `level` (str): Уровень логирования.
*   `rotation` (str): Размер файла лога для ротации.