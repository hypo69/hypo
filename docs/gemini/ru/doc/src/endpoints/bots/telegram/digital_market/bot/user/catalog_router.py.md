# Модуль `catalog_router` для Telegram-бота цифрового магазина

## Обзор

Модуль `catalog_router` предназначен для обработки запросов, связанных с каталогом товаров в Telegram-боте цифрового магазина. Он включает в себя обработку выбора категорий, отображение товаров в категориях и организацию процесса покупки с использованием различных платежных систем (ЮKassa, Stars, Robocassa).

## Подробней

Этот модуль обеспечивает навигацию по каталогу товаров, отображение информации о товарах и интеграцию с различными платежными системами для осуществления покупок. Он использует `aiogram` для обработки входящих запросов от пользователей Telegram и `SQLAlchemy` для взаимодействия с базой данных.

## Классы

В данном модуле классы отсутствуют.

## Функции

### `page_catalog`

```python
async def page_catalog(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обрабатывает запрос на отображение каталога товаров.

    Args:
        call (CallbackQuery): Объект CallbackQuery, содержащий информацию о запросе от пользователя.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для выполнения операций с базой данных без коммита.

    Returns:
        None

    Raises:
        Exception: Если происходит ошибка при удалении предыдущего сообщения.

    Как работает функция:
    1. Отвечает на CallbackQuery сообщением "Загрузка каталога...".
    2. Пытается удалить предыдущее сообщение пользователя, чтобы интерфейс оставался чистым.
    3. Получает данные каталога из базы данных, используя `CategoryDao.find_all`.
    4. Отправляет пользователю сообщение со списком категорий товаров, используя клавиатуру `catalog_kb`.

    Внутри функции происходят следующие действия и преобразования:
    A: Отображение сообщения о загрузке каталога.
    |
    -- B: Попытка удаления предыдущего сообщения пользователя.
    |
    C: Получение данных каталога из базы данных.
    |
    D: Отправка сообщения пользователю со списком категорий товаров и клавиатурой.

    Примеры:
        Пример вызова функции:
        >>> await page_catalog(call=callback_query, session_without_commit=session)
    """
    ...
```

### `page_catalog_products`

```python
async def page_catalog_products(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обрабатывает запрос на отображение товаров в выбранной категории каталога.

    Args:
        call (CallbackQuery): Объект CallbackQuery, содержащий информацию о запросе от пользователя.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для выполнения операций с базой данных без коммита.

    Returns:
        None

    Как работает функция:
    1. Извлекает ID категории из данных CallbackQuery.
    2. Получает список товаров, относящихся к данной категории, из базы данных, используя `ProductDao.find_all`.
    3. Если товары в категории есть, отправляет информацию о каждом товаре пользователю.
       Информация включает название, цену и описание товара.
       Для каждого товара также прикрепляется клавиатура `product_kb` для покупки.
    4. Если товаров в категории нет, отправляет пользователю сообщение об отсутствии товаров.

    Внутри функции происходят следующие действия и преобразования:
    A: Извлечение ID категории из CallbackQuery.
    |
    -- B: Получение списка товаров из базы данных для данной категории.
    |
    C: Проверка наличия товаров в категории.
    |
    D - E: Отправка информации о каждом товаре пользователю (если товары есть) или сообщение об отсутствии товаров (если товаров нет).

    Примеры:
        Пример вызова функции:
        >>> await page_catalog_products(call=callback_query, session_without_commit=session)
    """
    ...
```

### `process_about`

```python
async def process_about(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обрабатывает запрос на покупку товара.

    Args:
        call (CallbackQuery): Объект CallbackQuery, содержащий информацию о запросе от пользователя.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для выполнения операций с базой данных без коммита.

    Returns:
        None

    Как работает функция:
    1. Получает информацию о пользователе из базы данных, используя `UserDAO.find_one_or_none`.
    2. Извлекает тип платежа, ID продукта и цену из данных CallbackQuery.
    3. В зависимости от типа платежа, вызывает соответствующую функцию для отправки инвойса (счета) пользователю:
       - `send_yukassa_invoice` для ЮKassa.
       - `send_stars_invoice` для Stars.
       - `send_robocassa_invoice` для Robocassa.
    4. Удаляет сообщение пользователя после обработки запроса.

    Внутри функции происходят следующие действия и преобразования:
    A: Получение информации о пользователе из базы данных.
    |
    -- B: Извлечение типа платежа, ID продукта и цены из CallbackQuery.
    |
    C: Вызов соответствующей функции для отправки инвойса в зависимости от типа платежа.
    |
    D: Удаление сообщения пользователя.

    Примеры:
        Пример вызова функции:
        >>> await process_about(call=callback_query, session_without_commit=session)
    """
    ...
```

### `send_yukassa_invoice`

```python
async def send_yukassa_invoice(call, user_info, product_id, price):
    """
    Отправляет пользователю инвойс (счет) для оплаты через ЮKassa.

    Args:
        call (CallbackQuery): Объект CallbackQuery, содержащий информацию о запросе от пользователя.
        user_info: Информация о пользователе.
        product_id (str): ID продукта, за который производится оплата.
        price (str): Цена товара.

    Returns:
        None

    Как работает функция:
    1. Отправляет инвойс пользователю, используя `bot.send_invoice`.
       Инвойс содержит информацию о платеже (название, описание, цену) и кнопку для оплаты через ЮKassa.
    2. В качестве `payload` передается информация о типе платежа, ID пользователя и ID продукта.
    3. Использует `settings.PROVIDER_TOKEN` для указания провайдера платежа.
    4. Использует `get_product_buy_youkassa` для формирования клавиатуры с кнопкой оплаты.

    Внутри функции происходят следующие действия и преобразования:
    A: Отправка инвойса пользователю с информацией о платеже и кнопкой для оплаты через ЮKassa.

    Примеры:
        Пример вызова функции:
        >>> await send_yukassa_invoice(call=callback_query, user_info=user, product_id="123", price="100")
    """
    ...
```

### `send_robocassa_invoice`

```python
async def send_robocassa_invoice(call, user_info, product_id, price, session: AsyncSession):
    """
    Отправляет пользователю инвойс (счет) для оплаты через Robocassa.

    Args:
        call (CallbackQuery): Объект CallbackQuery, содержащий информацию о запросе от пользователя.
        user_info: Информация о пользователе.
        product_id (str): ID продукта, за который производится оплата.
        price (str): Цена товара.
        session (AsyncSession): Асинхронная сессия SQLAlchemy для выполнения операций с базой данных.

    Returns:
        None

    Как работает функция:
    1. Получает следующий доступный ID для покупки, используя `PurchaseDao.get_next_id`.
    2. Формирует ссылку для оплаты, используя `generate_payment_link`.
       Ссылка содержит информацию о цене, ID покупки, описании и ID пользователя.
    3. Создает клавиатуру с кнопкой для перехода по ссылке оплаты, используя `get_product_buy_robocassa`.
    4. Отправляет пользователю сообщение с текстом и клавиатурой для оплаты через Robocassa.

    Внутри функции происходят следующие действия и преобразования:
    A: Получение следующего доступного ID для покупки.
    |
    -- B: Формирование ссылки для оплаты через Robocassa.
    |
    C: Создание клавиатуры с кнопкой для перехода по ссылке оплаты.
    |
    D: Отправка пользователю сообщения с текстом и клавиатурой для оплаты через Robocassa.

    Примеры:
        Пример вызова функции:
        >>> await send_robocassa_invoice(call=callback_query, user_info=user, product_id="123", price="100", session=session)
    """
    ...
```

### `send_stars_invoice`

```python
async def send_stars_invoice(call, user_info, product_id, stars_price):
    """
    Отправляет пользователю инвойс (счет) для оплаты через Stars (внутренняя валюта).

    Args:
        call (CallbackQuery): Объект CallbackQuery, содержащий информацию о запросе от пользователя.
        user_info: Информация о пользователе.
        product_id (str): ID продукта, за который производится оплата.
        stars_price (int): Цена товара в звездах.

    Returns:
        None

    Как работает функция:
    1. Отправляет инвойс пользователю, используя `bot.send_invoice`.
       Инвойс содержит информацию о платеже (название, описание, цену в звездах) и кнопку для оплаты.
    2. В качестве `payload` передается информация о типе платежа, ID пользователя и ID продукта.
    3. Использует `get_product_buy_stars` для формирования клавиатуры с кнопкой оплаты.

    Внутри функции происходят следующие действия и преобразования:
    A: Отправка инвойса пользователю с информацией о платеже в звездах и кнопкой для оплаты.

    Примеры:
        Пример вызова функции:
        >>> await send_stars_invoice(call=callback_query, user_info=user, product_id="123", stars_price=10)
    """
    ...
```

### `pre_checkout_query`

```python
@catalog_router.pre_checkout_query(lambda query: True)
async def pre_checkout_query(pre_checkout_q: PreCheckoutQuery):
    """
    Обрабатывает предварительный запрос перед оплатой.

    Args:
        pre_checkout_q (PreCheckoutQuery): Объект PreCheckoutQuery, содержащий информацию о предварительном запросе перед оплатой.

    Returns:
        None

    Как работает функция:
    1. Отвечает на предварительный запрос, подтверждая возможность проведения оплаты, используя `bot.answer_pre_checkout_query`.

    Внутри функции происходят следующие действия и преобразования:
    A: Подтверждение возможности проведения оплаты.

    Примеры:
        Пример вызова функции:
        >>> await pre_checkout_query(pre_checkout_q=pre_checkout_query)
    """
    ...
```

### `successful_payment`

```python
@catalog_router.message(F.content_type == ContentType.SUCCESSFUL_PAYMENT)
async def successful_payment(message: Message, session_with_commit: AsyncSession):
    """
    Обрабатывает уведомление об успешной оплате.

    Args:
        message (Message): Объект Message, содержащий информацию об успешной оплате.
        session_with_commit (AsyncSession): Асинхронная сессия SQLAlchemy для выполнения операций с базой данных с коммитом.

    Returns:
        None

    Как работает функция:
    1. Извлекает информацию об оплате из объекта `message.successful_payment`.
    2. Извлекает тип платежа, ID пользователя и ID продукта из `invoice_payload`.
    3. Определяет цену и валюту в зависимости от типа платежа (Stars или другая валюта).
    4. Формирует словарь `payment_data` с информацией об оплате.
    5. Вызывает функцию `successful_payment_logic` для обработки логики после успешной оплаты.

    Внутри функции происходят следующие действия и преобразования:
    A: Извлечение информации об оплате из объекта `message`.
    |
    -- B: Извлечение типа платежа, ID пользователя и ID продукта из `invoice_payload`.
    |
    C: Определение цены и валюты в зависимости от типа платежа.
    |
    D: Формирование словаря `payment_data` с информацией об оплате.
    |
    E: Вызов функции `successful_payment_logic` для обработки логики после успешной оплаты.

    Примеры:
        Пример вызова функции:
        >>> await successful_payment(message=message, session_with_commit=session)
    """
    ...