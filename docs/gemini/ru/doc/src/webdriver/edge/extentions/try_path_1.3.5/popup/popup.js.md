# Документация для `popup.js`

## Обзор

Данный файл `popup.js` является скриптом для всплывающего окна (popup) расширения браузера, предназначенного для тестирования и выполнения XPath-запросов на веб-страницах. Он обрабатывает взаимодействие пользователя с интерфейсом всплывающего окна, отправляет запросы на выполнение XPath-запросов на текущей веб-странице, отображает результаты и управляет состоянием окна.

## Оглавление

1. [Переменные](#переменные)
2. [Функции](#функции)
    - [`sendToActiveTab`](#sendtoactivetab)
    - [`sendToSpecifiedFrame`](#sendtospecifiedframe)
    - [`collectPopupState`](#collectpopupstate)
    - [`changeContextVisible`](#changecontextvisible)
    - [`changeResolverVisible`](#changeresolvervisible)
    - [`changeFrameIdVisible`](#changeframeidvisible)
    - [`changeFrameDesignationVisible`](#changeframedesignationvisible)
    - [`changeHelpVisible`](#changehelpvisible)
    - [`makeExecuteMessage`](#makeexecutemessage)
    - [`getSpecifiedFrameId`](#getspecifiedframeid)
    - [`execContentScript`](#execcontentscript)
    - [`sendExecute`](#sendexecute)
    - [`handleExprEnter`](#handleexprenter)
    - [`showDetailsPage`](#showdetailspage)
    - [`showError`](#showerror)
    - [`genericListener`](#genericlistener)
3. [События](#события)

## Переменные

В файле определены следующие переменные:

- `tx`: Псевдоним для `tryxpath`.
- `fu`: Псевдоним для `tryxpath.functions`.
- `document`: Ссылка на объект `document` текущего окна.
- `noneClass`: CSS класс для скрытия элемента (`"none"`).
- `helpClass`: CSS класс для элементов помощи (`"help"`).
- `invalidTabId`: Идентификатор невалидной вкладки (`browser.tabs.TAB_ID_NONE`).
- `invalidExecutionId`: Идентификатор невалидного выполнения (`NaN`).
- `invalidFrameId`: Идентификатор невалидного фрейма (`-1`).
- Переменные для элементов интерфейса (например, `mainWay`, `mainExpression`, `contextCheckbox` и др.).
- `relatedTabId`: Идентификатор текущей вкладки, на которой выполняются запросы.
- `relatedFrameId`: Идентификатор текущего фрейма, на котором выполняются запросы.
- `executionId`: Идентификатор текущего выполнения запроса.
- `resultedDetails`: Массив с деталями результатов выполнения XPath.
- `detailsPageSize`: Размер страницы для отображения деталей результатов.
- `detailsPageIndex`: Индекс текущей страницы деталей результатов.

## Функции

### `sendToActiveTab`

**Описание**: Отправляет сообщение активной вкладке в текущем окне.

**Параметры**:
- `msg` (Object): Сообщение для отправки.
- `opts` (Object, optional): Дополнительные параметры для отправки сообщения. По умолчанию `{}`.

**Возвращает**:
- `Promise`: Promise, который разрешается с результатом отправки сообщения.

### `sendToSpecifiedFrame`

**Описание**: Отправляет сообщение в указанный фрейм активной вкладки. Если фрейм не найден, выполняется content script для инъекции скрипта.

**Параметры**:
- `msg` (Object): Сообщение для отправки.

**Возвращает**:
- `Promise`: Promise, который разрешается после отправки сообщения или после обработки ошибки.

### `collectPopupState`

**Описание**: Собирает состояние всплывающего окна для сохранения.

**Параметры**:
- Нет.

**Возвращает**:
- `Object`: Объект, содержащий состояние всех элементов всплывающего окна.

### `changeContextVisible`

**Описание**: Изменяет видимость блока контекстного выражения.

**Параметры**:
- Нет.

**Возвращает**:
- `undefined`: Функция ничего не возвращает.

### `changeResolverVisible`

**Описание**: Изменяет видимость блока выражения для резолвера.

**Параметры**:
- Нет.

**Возвращает**:
- `undefined`: Функция ничего не возвращает.

### `changeFrameIdVisible`

**Описание**: Изменяет видимость блока идентификатора фрейма.

**Параметры**:
- Нет.

**Возвращает**:
- `undefined`: Функция ничего не возвращает.

### `changeFrameDesignationVisible`

**Описание**: Изменяет видимость блока выражения для указания фрейма.

**Параметры**:
- Нет.

**Возвращает**:
- `undefined`: Функция ничего не возвращает.

### `changeHelpVisible`

**Описание**: Изменяет видимость элементов помощи.

**Параметры**:
- Нет.

**Возвращает**:
- `undefined`: Функция ничего не возвращает.

### `makeExecuteMessage`

**Описание**: Создает сообщение для выполнения XPath-запроса.

**Параметры**:
- Нет.

**Возвращает**:
- `Object`: Сообщение, содержащее параметры выполнения запроса.

### `getSpecifiedFrameId`

**Описание**: Получает идентификатор указанного фрейма.

**Параметры**:
- Нет.

**Возвращает**:
- `number`: Идентификатор фрейма или `0`, если фрейм не указан.

### `execContentScript`

**Описание**: Выполняет контентные скрипты на странице.

**Параметры**:
- Нет.

**Возвращает**:
- `Promise`: Promise, который разрешается после выполнения скриптов.

### `sendExecute`

**Описание**: Отправляет сообщение на выполнение XPath-запроса.

**Параметры**:
- Нет.

**Возвращает**:
- `undefined`: Функция ничего не возвращает.

### `handleExprEnter`

**Описание**: Обрабатывает нажатие клавиши "Enter" в текстовых полях для отправки запроса.

**Параметры**:
- `event` (Event): Объект события клавиатуры.

**Возвращает**:
- `undefined`: Функция ничего не возвращает.

### `showDetailsPage`

**Описание**: Отображает детали результатов на указанной странице.

**Параметры**:
- `index` (number): Индекс страницы для отображения.

**Возвращает**:
- `undefined`: Функция ничего не возвращает.

### `showError`

**Описание**: Отображает сообщение об ошибке.

**Параметры**:
- `message` (string): Сообщение об ошибке.
- `frameId` (number): Идентификатор фрейма, в котором произошла ошибка.

**Возвращает**:
- `undefined`: Функция ничего не возвращает.

### `genericListener`

**Описание**: Универсальный обработчик сообщений, получаемых из контентных скриптов.

**Параметры**:
- `message` (Object): Объект сообщения.
- `sender` (Object): Объект отправителя.
- `sendResponse` (Function): Функция для отправки ответа.

**Возвращает**:
- Может возвращать `Promise` или другие значения в зависимости от обработчика.

## События

В файле также обрабатываются различные события, включая:

- `load`: Событие загрузки страницы, которое инициализирует все элементы и обработчики событий.
- `click`: События клика на кнопки и заголовки, которые вызывают соответствующие функции.
- `keypress`: События нажатия клавиш, которые вызывают функции для отправки запросов при нажатии "Enter".
- `unload`: Событие выгрузки страницы, которое сохраняет состояние окна.
- `message`: События получения сообщений от контентных скриптов, которые обрабатываются с помощью `genericListener`.

Этот файл обеспечивает основную логику работы всплывающего окна, позволяя пользователю взаимодействовать с расширением для выполнения XPath-запросов.