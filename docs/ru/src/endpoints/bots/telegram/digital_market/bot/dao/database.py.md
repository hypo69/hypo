# Модуль database.py

## Обзор

Модуль `database.py` предназначен для настройки и управления базой данных, используемой в Telegram-боте для цифрового рынка. Он включает в себя создание движка базы данных, фабрики сессий и базового класса для моделей базы данных.

## Подробнее

Этот модуль отвечает за установление соединения с базой данных, определение структуры таблиц и обеспечение асинхронного доступа к данным. Он использует SQLAlchemy для взаимодействия с базой данных и предоставляет удобные инструменты для работы с моделями данных.

## Классы

### `Base`

**Описание**: Базовый класс для всех моделей базы данных.

**Наследует**:
- `AsyncAttrs`: Предоставляет атрибуты для асинхронной работы с базой данных.
- `DeclarativeBase`: Базовый класс для декларативного определения моделей SQLAlchemy.

**Атрибуты**:
- `__abstract__` (bool): Указывает, что класс является абстрактным и не должен создавать отдельную таблицу.
- `id` (int): Первичный ключ таблицы, целое число с автоматической инкрементацией.
- `created_at` (datetime): Дата и время создания записи, устанавливается автоматически при создании.
- `updated_at` (datetime): Дата и время последнего обновления записи, автоматически обновляется при каждом изменении.

**Методы**:
- `to_dict()`: Преобразует объект модели в словарь.

### `__tablename__`

```python
    @classmethod
    @property
    def __tablename__(cls) -> str:
        return cls.__name__.lower() + 's'
```

**Описание**: Возвращает имя таблицы в базе данных, образованное из имени класса в нижнем регистре с добавлением суффикса "s".

**Параметры**:
- `cls` (type): Ссылка на класс.

**Возвращает**:
- `str`: Имя таблицы.

**Как работает**:
1. Получает имя класса (`cls.__name__`).
2. Преобразует имя класса в нижний регистр (`.lower()`).
3. Добавляет суффикс "s" к имени класса.
4. Возвращает полученное имя таблицы.

**Примеры**:
```python
class User(Base):
    pass

print(User.__tablename__)  # Вывод: users
```

### `to_dict`

```python
    def to_dict(self) -> dict:
        # Метод для преобразования объекта в словарь
        return {c.name: getattr(self, c.name) for c in self.__table__.columns}
```

**Описание**: Преобразует объект модели в словарь, где ключами являются имена столбцов таблицы, а значениями - значения соответствующих атрибутов объекта.

**Параметры**:
- `self` (Base): Экземпляр класса `Base`.

**Возвращает**:
- `dict`: Словарь, представляющий объект модели.

**Как работает функция**:
1. Проходит по всем столбцам таблицы (`self.__table__.columns`).
2. Для каждого столбца `c` извлекает имя столбца (`c.name`).
3. Получает значение атрибута объекта, соответствующего имени столбца (`getattr(self, c.name)`).
4. Создает словарь, где ключами являются имена столбцов, а значениями - соответствующие атрибуты объекта.

```ascii
Объект Base -->  Столбцы таблицы  --> Имена столбцов, Значения атрибутов --> Словарь
```

**Примеры**:
```python
from sqlalchemy import Column, Integer, String

class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    name = Column(String)
    age = Column(Integer)

user = User(name='John', age=30)
user_dict = user.to_dict()
print(user_dict)
# Вывод: {'id': None, 'name': 'John', 'age': 30}
```

## Функции

### `engine`

```python
engine = create_async_engine(url=database_url)
```

**Назначение**: Создание асинхронного движка SQLAlchemy для подключения к базе данных.

**Как работает функция**:
1. Использует функцию `create_async_engine` из SQLAlchemy для создания асинхронного движка.
2. В качестве параметра `url` передается строка подключения к базе данных, хранящаяся в переменной `database_url`.

### `async_session_maker`

```python
async_session_maker = async_sessionmaker(engine, class_=AsyncSession)
```

**Назначение**: Создание фабрики сессий для асинхронной работы с базой данных.

**Как работает функция**:
1. Использует функцию `async_sessionmaker` из SQLAlchemy для создания фабрики сессий.
2. В качестве первого параметра передается созданный ранее движок базы данных `engine`.
3. В качестве параметра `class_` передается класс `AsyncSession`, который будет использоваться для создания сессий.