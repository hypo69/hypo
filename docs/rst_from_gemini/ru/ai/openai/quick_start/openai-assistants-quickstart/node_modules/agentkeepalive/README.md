```markdown
# agentkeepalive

[![NPM version][npm-image]][npm-url]
[![Known Vulnerabilities][snyk-image]][snyk-url]
[![Node.js CI][nodejs-ci-image]][nodejs-ci-url]
[![npm download][download-image]][download-url]

**A high-performance HTTP agent for Node.js that enhances the built-in `http.Agent` with keep-alive features to improve performance and prevent socket leaks.**

[npm-image]: https://img.shields.io/npm/v/agentkeepalive.svg?style=flat
[npm-url]: https://npmjs.org/package/agentkeepalive
[snyk-image]: https://snyk.io/test/npm/agentkeepalive/badge.svg?style=flat-square
[snyk-url]: https://snyk.io/test/npm/agentkeepalive
[download-image]: https://img.shields.io/npm/dm/agentkeepalive.svg?style=flat-square
[download-url]: https://npmjs.org/package/agentkeepalive
[nodejs-ci-image]: https://github.com/node-modules/agentkeepalive/actions/workflows/nodejs.yml/badge.svg
[nodejs-ci-url]: https://github.com/node-modules/agentkeepalive/actions/workflows/nodejs.yml


This package provides a custom `http.Agent` implementation that addresses several limitations in the standard agent, particularly regarding socket management and keep-alive behavior.  It enhances performance and stability by preventing socket leaks and improving resource utilization.

## Key Improvements over `http.Agent`

* **Default `keepAlive = true`:**  Sockets are maintained in a pool for reuse, significantly reducing connection setup time for subsequent requests.
* **Nagle's algorithm disabled:** (`socket.setNoDelay(true)`) This optimization improves responsiveness by allowing smaller packets to be sent immediately.
* **Free socket timeout:** Prevents sockets lingering in the free pool indefinitely, avoiding resource exhaustion.  Defaults to 4000ms to mitigate `ECONNRESET` errors.
* **Active socket timeout:** Limits the time a socket remains open while in use.  Defaults to a value >= 8 seconds.
* **TTL for active sockets:** Adds a configurable timeout for active sockets, potentially improving robustness.

## Supported Node.js Versions

Node.js `>= 8.0.0`

## Installation

```bash
npm install agentkeepalive --save
```

## Usage

```javascript
const http = require('http');
const Agent = require('agentkeepalive');

const keepaliveAgent = new Agent({
  maxSockets: 100,
  maxFreeSockets: 10,
  timeout: 60000, // Active socket timeout (60 seconds)
  freeSocketTimeout: 30000, // Free socket timeout (30 seconds)
});

const options = {
  host: 'cnodejs.org',
  port: 80,
  path: '/',
  method: 'GET',
  agent: keepaliveAgent,
};

const req = http.request(options, res => {
  // Handle response...
});

req.on('error', err => {
  console.error('Request error:', err);
});

req.end();

// Check agent status (optional)
setTimeout(() => {
  console.log('Agent status:', keepaliveAgent.getCurrentStatus());
}, 2000);
```

### Agent Options

The `new Agent([options])` constructor accepts the following options:

* **`keepAlive` (boolean, default: `true`):** Enables/disables socket keep-alive.
* **`keepAliveMsecs` (number, default: `1000`):** Initial delay for TCP keep-alive packets (only relevant if `keepAlive` is `true`).
* **`freeSocketTimeout` (number, default: `4000`):** Timeout for free sockets.
* **`timeout` (number):** Timeout for active sockets. Defaults to `freeSocketTimeout * 2` or 8 seconds, whichever is greater.
* **`maxSockets` (number, default: `Infinity`):** Maximum number of sockets per host.
* **`maxFreeSockets` (number, default: `256`):** Maximum number of free sockets per host.
* **`socketActiveTTL` (number, default: `null`):** Socket active time to live.

### `agent.statusChanged` (getter)

Indicates if agent counters have changed since the last check.

### `agent.getCurrentStatus()`

Returns an object containing the current status of the agent (e.g., socket counts, request counts).

### Support for `https`

```javascript
const https = require('https');
const HttpsAgent = require('agentkeepalive').HttpsAgent;

const keepaliveAgent = new HttpsAgent();
// ... rest of the example
```

### `req.reusedSocket`

Indicates whether the request reused a socket.  Useful for retry logic.

## Benchmarking

See the `benchmark` directory for performance comparisons against the standard `http.Agent`.


## License

[MIT](LICENSE)


```