# Модуль `src.utils.xls`

## Обзор

Модуль `src.utils.xls` предоставляет функциональность для конвертации файлов Excel (`xls`) в формат JSON и обратно. Он позволяет читать данные из Excel файлов, преобразовывать их в JSON формат, а также сохранять JSON данные в Excel файлы.

## Подробней

Этот модуль предназначен для работы с данными в формате Excel и JSON. Он включает функции для чтения данных из Excel файлов с возможностью указания конкретного листа, преобразования этих данных в формат JSON, а также сохранения JSON данных обратно в Excel файлы. Модуль использует библиотеку `pandas` для работы с Excel файлами и библиотеку `json` для работы с JSON данными.
В проекте `hypotez` данный модуль может быть полезен для обработки конфигурационных файлов или других данных, хранящихся в формате Excel.

## Функции

### `read_xls_as_dict`

```python
def read_xls_as_dict(
    xls_file: str,
    json_file: str = None,
    sheet_name: Union[str, int] = None
) -> Union[Dict, List[Dict], bool]:
    """
    Читает Excel файл и преобразует его в JSON. Опционально, преобразует указанный лист и сохраняет результат в JSON файл.
    Обрабатывает ошибки.

    Args:
        xls_file (str): Путь к Excel файлу.
        json_file (str, optional): Путь к JSON файлу для сохранения результата. По умолчанию `None`.
        sheet_name (Union[str, int], optional): Имя или индекс листа Excel для чтения. По умолчанию `None`.

    Returns:
        Union[Dict, List[Dict], bool]: Возвращает словарь, содержащий данные из Excel файла, или список словарей, если указан конкретный лист.
        Возвращает `False` в случае ошибки.

    Raises:
        FileNotFoundError: Если указанный Excel файл не найден.
        Exception: Если возникает ошибка при обработке листа Excel.

    Example:
        >>> data = read_xls_as_dict('input.xlsx', 'output.json', 'Sheet1')
        >>> if data:
        ...     print(data)
    """
```

**Назначение**: Чтение данных из Excel файла и преобразование их в формат JSON.

**Параметры**:
- `xls_file` (str): Путь к Excel файлу, который необходимо прочитать.
- `json_file` (str, optional): Путь к JSON файлу, в который нужно сохранить преобразованные данные. Если не указан, данные не сохраняются в файл. По умолчанию `None`.
- `sheet_name` (Union[str, int], optional): Имя или индекс листа Excel, который необходимо прочитать. Если не указан, читаются все листы. По умолчанию `None`.

**Возвращает**:
- `Union[Dict, List[Dict], bool]`: В случае успеха возвращает словарь, где ключи - имена листов, а значения - списки словарей, представляющие строки данных. Если указан `sheet_name`, возвращается список словарей, представляющий данные из указанного листа. В случае ошибки возвращает `False`.

**Вызывает исключения**:
- `FileNotFoundError`: Если указанный Excel файл не найден.
- `Exception`: Если возникает ошибка при обработке листа Excel.

**Как работает функция**:

1.  **Проверка наличия файла**: Функция сначала проверяет, существует ли указанный Excel файл. Если файл не найден, логируется ошибка, и функция возвращает `False`.
2.  **Чтение Excel файла**: Используется `pandas.ExcelFile` для открытия Excel файла.
3.  **Обработка листов**:
    *   Если `sheet_name` не указан, функция перебирает все листы в Excel файле.
    *   Для каждого листа данные считываются с использованием `pd.read_excel` и преобразуются в список словарей с помощью `df.to_dict(orient='records')`.
    *   Полученные данные сохраняются в словарь `data_dict`, где ключи - имена листов, а значения - списки словарей.
    *   Если `sheet_name` указан, функция пытается прочитать только указанный лист и преобразовать его в список словарей.
4.  **Сохранение в JSON (опционально)**: Если указан `json_file`, данные из `data_dict` сохраняются в JSON файл с использованием `json.dump`.
5.  **Обработка ошибок**: Если в процессе чтения или обработки листов возникают ошибки, они логируются, и функция возвращает `False`.
6.  **Возврат данных**: В случае успеха функция возвращает `data_dict`, содержащий данные из Excel файла.

```
Проверка наличия файла
      ↓
Чтение Excel файла
      ↓
Обработка листов:
      ├── sheet_name не указан → Перебор всех листов
      │   ↓
      │   Чтение данных с листа → Преобразование в список словарей → Сохранение в data_dict
      │   ↓
      └── sheet_name указан → Чтение указанного листа → Преобразование в список словарей
      ↓
Сохранение в JSON (опционально)
      ↓
Возврат данных
```

**Примеры**:

```python
# Чтение всех листов из Excel файла
data = read_xls_as_dict('input.xlsx')
if data:
    print(data)

# Чтение конкретного листа из Excel файла и сохранение в JSON
data = read_xls_as_dict('input.xlsx', 'output.json', 'Sheet1')
if data:
    print(data)
```

### `save_xls_file`

```python
def save_xls_file(data: Dict[str, List[Dict]], file_path: str) -> bool:
    """Сохраняет JSON данные в Excel файл. Обрабатывает ошибки."""
```

**Назначение**: Сохранение JSON данных в Excel файл.

**Параметры**:
- `data` (Dict[str, List[Dict]]): Словарь, где ключи - имена листов, а значения - списки словарей, представляющие строки данных.
- `file_path` (str): Путь к Excel файлу, в который нужно сохранить данные.

**Возвращает**:
- `bool`: Возвращает `True` в случае успешного сохранения данных в Excel файл, `False` в случае ошибки.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при сохранении Excel файла.

**Как работает функция**:

1.  **Открытие ExcelWriter**: Функция использует `pd.ExcelWriter` для открытия Excel файла в режиме записи.
2.  **Перебор листов**: Функция перебирает листы в словаре `data`.
3.  **Создание DataFrame**: Для каждого листа создается `pandas.DataFrame` из списка словарей.
4.  **Запись в Excel**: DataFrame записывается в Excel файл на соответствующий лист с использованием `df.to_excel`. Параметр `index=False` отключает запись индексов строк.
5.  **Обработка ошибок**: Если в процессе записи возникают ошибки, они логируются, и функция возвращает `False`.
6.  **Возврат результата**: В случае успеха функция возвращает `True`.

```
Открытие ExcelWriter
      ↓
Перебор листов
      ↓
Создание DataFrame
      ↓
Запись в Excel
      ↓
Возврат результата
```

**Примеры**:

```python
# Сохранение JSON данных в Excel файл
data_to_save = {'Sheet1': [{'column1': 'value1', 'column2': 'value2'}]}
success = save_xls_file(data_to_save, 'output.xlsx')
if success:
    print("Successfully saved to output.xlsx")