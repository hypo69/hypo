# Модуль crypto.py

## Обзор

Модуль `crypto.py` содержит функции для шифрования и дешифрования данных, используемые в контексте работы с облачным хранилищем Mega. Он предоставляет реализации алгоритмов AES в режиме CBC, а также функции для подготовки ключей и хеширования строк.

## Подробней

Этот модуль предоставляет криптографические функции, необходимые для безопасной обработки данных при взаимодействии с Mega. Функции модуля включают шифрование и дешифрование данных с использованием AES в режиме CBC, подготовку ключей и хеширование строк. Эти функции используются для защиты данных, передаваемых между клиентом и сервером Mega.

## Функции

### `aes_cbc_encrypt`

```python
def aes_cbc_encrypt(data, key):
    """
    Шифрует данные с использованием алгоритма AES в режиме CBC.

    Args:
        data (bytes): Данные для шифрования.
        key (bytes): Ключ шифрования.

    Returns:
        bytes: Зашифрованные данные.
    """
    ...
```

**Как работает функция**:

1.  Создает объект шифрования AES в режиме CBC с использованием предоставленного ключа и нулевого вектора инициализации (IV).
2.  Шифрует входные данные с использованием созданного объекта шифрования.
3.  Возвращает зашифрованные данные.

**Параметры**:

*   `data` (bytes): Данные для шифрования.
*   `key` (bytes): Ключ шифрования.

**Возвращает**:

*   `bytes`: Зашифрованные данные.

### `aes_cbc_decrypt`

```python
def aes_cbc_decrypt(data, key):
    """
    Дешифрует данные, зашифрованные алгоритмом AES в режиме CBC.

    Args:
        data (bytes): Зашифрованные данные.
        key (bytes): Ключ дешифрования.

    Returns:
        bytes: Дешифрованные данные.
    """
    ...
```

**Как работает функция**:

1.  Создает объект дешифрования AES в режиме CBC с использованием предоставленного ключа и нулевого вектора инициализации (IV).
2.  Дешифрует входные данные с использованием созданного объекта дешифрования.
3.  Возвращает дешифрованные данные.

**Параметры**:

*   `data` (bytes): Зашифрованные данные.
*   `key` (bytes): Ключ дешифрования.

**Возвращает**:

*   `bytes`: Дешифрованные данные.

### `aes_cbc_encrypt_a32`

```python
def aes_cbc_encrypt_a32(data, key):
    """
    Шифрует данные в формате a32 с использованием алгоритма AES в режиме CBC.

    Args:
        data (list[int]): Данные для шифрования в формате a32.
        key (list[int]): Ключ шифрования в формате a32.

    Returns:
        list[int]: Зашифрованные данные в формате a32.
    """
    ...
```

**Как работает функция**:

1.  Преобразует входные данные и ключ из формата a32 в строку.
2.  Шифрует преобразованные данные с использованием функции `aes_cbc_encrypt`.
3.  Преобразует зашифрованные данные обратно в формат a32.
4.  Возвращает зашифрованные данные в формате a32.

**Параметры**:

*   `data` (list[int]): Данные для шифрования в формате a32.
*   `key` (list[int]): Ключ шифрования в формате a32.

**Возвращает**:

*   `list[int]`: Зашифрованные данные в формате a32.

### `aes_cbc_decrypt_a32`

```python
def aes_cbc_decrypt_a32(data, key):
    """
    Дешифрует данные в формате a32, зашифрованные алгоритмом AES в режиме CBC.

    Args:
        data (list[int]): Зашифрованные данные в формате a32.
        key (list[int]): Ключ дешифрования в формате a32.

    Returns:
        list[int]: Дешифрованные данные в формате a32.
    """
    ...
```

**Как работает функция**:

1.  Преобразует входные данные и ключ из формата a32 в строку.
2.  Дешифрует преобразованные данные с использованием функции `aes_cbc_decrypt`.
3.  Преобразует дешифрованные данные обратно в формат a32.
4.  Возвращает дешифрованные данные в формате a32.

**Параметры**:

*   `data` (list[int]): Зашифрованные данные в формате a32.
*   `key` (list[int]): Ключ дешифрования в формате a32.

**Возвращает**:

*   `list[int]`: Дешифрованные данные в формате a32.

### `stringhash`

```python
def stringhash(s, aeskey):
    """
    Вычисляет хеш строки с использованием AES ключа.

    Args:
        s (str): Строка для хеширования.
        aeskey (list[int]): AES ключ в формате a32.

    Returns:
        str: Хеш строки в формате base64.
    """
    ...
```

**Как работает функция**:

1.  Преобразует строку `s` в формат a32.
2.  Инициализирует хеш-значение `h32` нулями.
3.  Выполняет XOR операции между элементами `s32` и `h32`.
4.  Выполняет 0x4000 итераций шифрования `h32` с использованием AES в режиме CBC с ключом `aeskey`.
5.  Преобразует результат в base64 и возвращает его.

**Параметры**:

*   `s` (str): Строка для хеширования.
*   `aeskey` (list[int]): AES ключ в формате a32.

**Возвращает**:

*   `str`: Хеш строки в формате base64.

### `prepare_key`

```python
def prepare_key(a):
    """
    Подготавливает ключ шифрования на основе входных данных.

    Args:
        a (list[int]): Входные данные для подготовки ключа.

    Returns:
        list[int]: Подготовленный ключ.
    """
    ...
```

**Как работает функция**:

1.  Инициализирует `pkey` константами.
2.  Выполняет 0x10000 итераций:
    *   Разбивает входные данные `a` на блоки по 4 элемента.
    *   Шифрует `pkey` с использованием AES в режиме CBC с ключом, сформированным из текущего блока `a`.
3.  Возвращает подготовленный ключ `pkey`.

**Параметры**:

*   `a` (list[int]): Входные данные для подготовки ключа.

**Возвращает**:

*   `list[int]`: Подготовленный ключ.

### `encrypt_key`

```python
def encrypt_key(a, key):
    """
    Шифрует ключ `a` с использованием ключа `key`.

    Args:
        a (list[int]): Ключ для шифрования.
        key (list[int]): Ключ шифрования.

    Returns:
        list[int]: Зашифрованный ключ.
    """
    ...
```

**Как работает функция**:

1.  Разбивает ключ `a` на блоки по 4 элемента.
2.  Шифрует каждый блок с использованием AES в режиме CBC с ключом `key`.
3.  Объединяет зашифрованные блоки и возвращает результат.

**Параметры**:

*   `a` (list[int]): Ключ для шифрования.
*   `key` (list[int]): Ключ шифрования.

**Возвращает**:

*   `list[int]`: Зашифрованный ключ.

### `decrypt_key`

```python
def decrypt_key(a, key):
    """
    Дешифрует ключ `a` с использованием ключа `key`.

    Args:
        a (list[int]): Зашифрованный ключ.
        key (list[int]): Ключ дешифрования.

    Returns:
        list[int]: Дешифрованный ключ.
    """
    ...
```

**Как работает функция**:

1.  Разбивает ключ `a` на блоки по 4 элемента.
2.  Дешифрует каждый блок с использованием AES в режиме CBC с ключом `key`.
3.  Объединяет дешифрованные блоки и возвращает результат.

**Параметры**:

*   `a` (list[int]): Зашифрованный ключ.
*   `key` (list[int]): Ключ дешифрования.

**Возвращает**:

*   `list[int]`: Дешифрованный ключ.

### `enc_attr`

```python
def enc_attr(attr, key):
    """
    Шифрует атрибуты с использованием AES ключа.

    Args:
        attr (dict): Атрибуты для шифрования.
        key (list[int]): AES ключ в формате a32.

    Returns:
        bytes: Зашифрованные атрибуты.
    """
    ...
```

**Как работает функция**:

1.  Преобразует атрибуты `attr` в JSON-строку и добавляет префикс 'MEGA'.
2.  Дополняет строку нулевыми байтами до кратности 16.
3.  Шифрует строку с использованием AES в режиме CBC с ключом `key`.
4.  Возвращает зашифрованные атрибуты.

**Параметры**:

*   `attr` (dict): Атрибуты для шифрования.
*   `key` (list[int]): AES ключ в формате a32.

**Возвращает**:

*   `bytes`: Зашифрованные атрибуты.

### `dec_attr`

```python
def dec_attr(attr, key):
    """
    Дешифрует атрибуты, зашифрованные AES ключом.

    Args:
        attr (bytes): Зашифрованные атрибуты.
        key (list[int]): AES ключ в формате a32.

    Returns:
        dict: Дешифрованные атрибуты.
    """
    ...
```

**Как работает функция**:

1.  Дешифрует атрибуты `attr` с использованием AES в режиме CBC с ключом `key`.
2.  Удаляет нулевые байты из дешифрованной строки.
3.  Удаляет префикс 'MEGA' и преобразует JSON-строку в словарь.
4.  Возвращает дешифрованные атрибуты.

**Параметры**:

*   `attr` (bytes): Зашифрованные атрибуты.
*   `key` (list[int]): AES ключ в формате a32.

**Возвращает**:

*   `dict`: Дешифрованные атрибуты.