# Модуль `minibot`

## Обзор

Модуль `minibot` представляет собой простой Telegram-бот, предназначенный для обработки запросов, связанных с `emil-design.com`. Он использует библиотеку `telebot` для взаимодействия с Telegram API и предоставляет функциональность для обработки текстовых сообщений, URL-адресов, голосовых сообщений и документов. Бот также интегрирован с моделью Google Gemini AI для генерации ответов на текстовые запросы.

## Подробней

Этот модуль является частью проекта `hypotez` и расположен в директории `src/endpoints/emil/`. Он предназначен для предоставления пользователям возможности взаимодействовать с сервисами `emil-design.com` через Telegram. Бот обрабатывает различные типы сообщений, включая текстовые команды, URL-адреса (в частности, ссылки `one-tab.com`), голосовые сообщения и документы. Он использует Google Gemini AI для предоставления ответов на текстовые запросы и выполняет сценарии на основе предоставленных URL-адресов.

## Содержание

- [Классы](#классы)
  - [`BotHandler`](#BotHandler)
- [Функции](#функции)
  - [`command_start`](#command_start)
  - [`command_help`](#command_help)
  - [`command_info`](#command_info)
  - [`command_time`](#command_time)
  - [`command_photo`](#command_photo)
  - [`handle_voice_message`](#handle_voice_message)
  - [`handle_document_message`](#handle_document_message)
  - [`handle_text_message`](#handle_text_message)
  - [`handle_unknown_command`](#handle_unknown_command)

## Классы

### `BotHandler`

**Описание**: Класс `BotHandler` отвечает за обработку команд, полученных от Telegram-бота. Он включает методы для обработки текстовых сообщений, URL-адресов и других команд.

**Как работает класс**:
- Инициализируется с использованием класса `Scenario` для выполнения сценариев на основе предоставленных данных.
- Использует `GoogleGenerativeAI` для обработки текстовых запросов и генерации ответов.
- Содержит методы для отправки сообщений, обработки URL-адресов `one-tab.com`, обработки команд и работы с голосовыми сообщениями и документами.
- Включает методы для взаимодействия с Telegram API через объект `telebot`.

**Методы**:
- [`__init__`](#__init__): Инициализирует экземпляр класса `BotHandler`, настраивая сценарии, модель AI и список вопросов.
- [`handle_message`](#handle_message): Обрабатывает текстовые сообщения, определяя, является ли сообщение командой, URL-адресом или обычным текстом.
- [`_send_user_flowchart`](#_send_user_flowchart): Отправляет схему user_flowchart пользователю.
- [`_handle_url`](#_handle_url): Обрабатывает URL-адрес, извлекая данные и запуская сценарий.
- [`_handle_next_command`](#_handle_next_command): Обрабатывает команду "--next" и ее аналоги, отправляя случайный вопрос и ответ.
- [`help_command`](#help_command): Обрабатывает команду /help, отправляя справку с доступными командами.
- [`send_pdf`](#send_pdf): Обрабатывает команду /sendpdf, отправляя PDF-файл пользователю.
- [`handle_voice`](#handle_voice): Обрабатывает голосовые сообщения, распознавая текст и отправляя его пользователю.
- [`_transcribe_voice`](#_transcribe_voice): Заглушка для транскрибирования голосового сообщения.
- [`handle_document`](#handle_document): Обрабатывает полученные документы, сохраняя их во временный файл.

#### `__init__`

```python
def __init__(self):
    """Инициализация обработчика событий телеграм-бота."""
    ...
```

**Описание**: Инициализирует экземпляр класса `BotHandler`, настраивая сценарии, модель AI и список вопросов.

**Как работает функция**:
- Инициализирует объект `Scenario` для выполнения пользовательских сценариев.
- Создает экземпляр `GoogleGenerativeAI`, используя API-ключ из переменной окружения `GEMINI_API`.
- Определяет список вопросов `questions_list`, которые могут быть использованы для взаимодействия с пользователем.

**Параметры**:
- Отсутствуют.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- Отсутствуют.

**Примеры**:
```python
handler = BotHandler()
```

#### `handle_message`

```python
def handle_message(self, bot: telebot, message: 'message'):
    """Обработка текстовых сообщений."""
    ...
```

**Описание**: Обрабатывает текстовые сообщения, определяя, является ли сообщение командой, URL-адресом или обычным текстом.

**Как работает функция**:
- Получает текст сообщения.
- Если текст равен "?", отправляет схему user_flowchart.
- Если текст является URL-адресом, обрабатывает его.
- Если текст является командой "--next" или ее аналогом, обрабатывает ее.
- В противном случае пытается получить ответ от модели AI и отправить его пользователю.
- В случае ошибки логирует ее и отправляет сообщение об ошибке пользователю.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `message` (message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- `Exception`: Если происходит ошибка во время взаимодействия с моделью AI.

**Примеры**:
```python
bot = telebot.TeleBot("токен_бота")
message = telebot.types.Message(...)  # Объект сообщения
handler = BotHandler()
handler.handle_message(bot, message)
```

#### `_send_user_flowchart`

```python
def _send_user_flowchart(self, bot, chat_id):
    """Отправка схемы user_flowchart."""
    ...
```

**Описание**: Отправляет схему `user_flowchart` пользователю.

**Как работает функция**:
- Формирует путь к файлу `user_flowchart.png`.
- Пытается открыть и отправить фотографию пользователю.
- В случае ошибки логирует ее и отправляет сообщение об ошибке пользователю.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `chat_id` (int): ID чата пользователя.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- `FileNotFoundError`: Если файл схемы не найден.

**Примеры**:
```python
bot = telebot.TeleBot("токен_бота")
chat_id = 123456789
handler = BotHandler()
handler._send_user_flowchart(bot, chat_id)
```

#### `_handle_url`

```python
def _handle_url(self, bot, message: 'message'):
    """Обработка URL, присланного пользователем."""
    ...
```

**Описание**: Обрабатывает URL-адрес, присланный пользователем.

**Как работает функция**:
- Получает URL-адрес из сообщения.
- Проверяет, начинается ли URL-адрес с `https://one-tab.com`.
- Извлекает данные из URL-адреса с помощью `fetch_target_urls_onetab`.
- Запускает сценарий `run_scenario` с полученными данными.
- В случае ошибки логирует ее и отправляет сообщение об ошибке пользователю.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `message` (message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- `Exception`: Если происходит ошибка во время получения данных из OneTab или выполнения сценария.

**Примеры**:
```python
bot = telebot.TeleBot("токен_бота")
message = telebot.types.Message(...)  # Объект сообщения
handler = BotHandler()
handler._handle_url(bot, message)
```

#### `_handle_next_command`

```python
def _handle_next_command(self, bot, message):
    """Обработка команды '--next' и её аналогов."""
    ...
```

**Описание**: Обрабатывает команду `--next` и ее аналоги, отправляя случайный вопрос и ответ.

**Как работает функция**:
- Выбирает случайный вопрос из списка `questions_list`.
- Получает ответ от модели AI на выбранный вопрос.
- Отправляет вопрос и ответ пользователю.
- В случае ошибки логирует ее и отправляет сообщение об ошибке пользователю.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `message` (message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- `Exception`: Если происходит ошибка во время чтения вопросов или взаимодействия с моделью AI.

**Примеры**:
```python
bot = telebot.TeleBot("токен_бота")
message = telebot.types.Message(...)  # Объект сообщения
handler = BotHandler()
handler._handle_next_command(bot, message)
```

#### `help_command`

```python
def help_command(self, bot, message):
    """Обработка команды /help."""
    ...
```

**Описание**: Обрабатывает команду `/help`, отправляя справку с доступными командами.

**Как работает функция**:
- Отправляет пользователю сообщение со списком доступных команд и их описанием.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `message` (message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- Отсутствуют.

**Примеры**:
```python
bot = telebot.TeleBot("токен_бота")
message = telebot.types.Message(...)  # Объект сообщения
handler = BotHandler()
handler.help_command(bot, message)
```

#### `send_pdf`

```python
def send_pdf(self, bot, message, pdf_file):
    """Обработка команды /sendpdf для отправки PDF."""
    ...
```

**Описание**: Обрабатывает команду `/sendpdf`, отправляя PDF-файл пользователю.

**Как работает функция**:
- Открывает PDF-файл в режиме чтения байтов.
- Отправляет файл пользователю с помощью `bot.send_document`.
- В случае ошибки логирует ее и отправляет сообщение об ошибке пользователю.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `message` (message): Объект сообщения от пользователя.
- `pdf_file` (str): Путь к PDF-файлу.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- `Exception`: Если происходит ошибка при отправке PDF-файла.

**Примеры**:
```python
bot = telebot.TeleBot("токен_бота")
message = telebot.types.Message(...)  # Объект сообщения
pdf_file = "example.pdf"
handler = BotHandler()
handler.send_pdf(bot, message, pdf_file)
```

#### `handle_voice`

```python
def handle_voice(self, bot, message):
    """Обработка голосовых сообщений."""
    ...
```

**Описание**: Обрабатывает голосовые сообщения, распознавая текст и отправляя его пользователю.

**Как работает функция**:
- Получает информацию о файле голосового сообщения.
- Загружает файл голосового сообщения.
- Сохраняет файл во временную директорию.
- Транскрибирует голосовое сообщение с помощью `_transcribe_voice`.
- Отправляет распознанный текст пользователю.
- В случае ошибки логирует ее и отправляет сообщение об ошибке пользователю.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `message` (message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- `Exception`: Если происходит ошибка при обработке голосового сообщения.

**Примеры**:
```python
bot = telebot.TeleBot("токен_бота")
message = telebot.types.Message(...)  # Объект сообщения
handler = BotHandler()
handler.handle_voice(bot, message)
```

#### `_transcribe_voice`

```python
def _transcribe_voice(self, file_path):
    """Транскрибирование голосового сообщения (заглушка)."""
    ...
```

**Описание**: Транскрибирование голосового сообщения (заглушка).

**Как работает функция**:
- Возвращает строку "Распознавание голоса ещё не реализовано.".
- Этот метод предназначен для будущей реализации функциональности транскрибирования голосовых сообщений.

**Параметры**:
- `file_path` (str): Путь к файлу голосового сообщения.

**Возвращает**:
- `str`: Строка "Распознавание голоса ещё не реализовано.".

**Вызывает исключения**:
- Отсутствуют.

**Примеры**:
```python
file_path = "voice_message.ogg"
handler = BotHandler()
transcribed_text = handler._transcribe_voice(file_path)
print(transcribed_text)  # Вывод: Распознавание голоса ещё не реализовано.
```

#### `handle_document`

```python
def handle_document(self, bot, message):
    """Обработка полученных документов."""
    ...
```

**Описание**: Обрабатывает полученные документы, сохраняя их во временный файл.

**Как работает функция**:
- Получает информацию о файле документа.
- Загружает файл документа.
- Сохраняет файл во временную директорию.
- Отправляет сообщение пользователю о том, что файл сохранен.
- В случае ошибки логирует ее и отправляет сообщение об ошибке пользователю.

**Параметры**:
- `bot` (telebot): Экземпляр Telegram-бота.
- `message` (message): Объект сообщения от пользователя.

**Возвращает**:
- `bool`: `True`, если документ успешно обработан, `False` в противном случае.

**Вызывает исключения**:
- `Exception`: Если происходит ошибка при обработке документа.

**Примеры**:
```python
bot = telebot.TeleBot("токен_бота")
message = telebot.types.Message(...)  # Объект сообщения
handler = BotHandler()
result = handler.handle_document(bot, message)
print(result)
```

## Функции

### `command_start`

```python
@bot.message_handler(commands=['start'])
def command_start(message):
    """Обработка команды /start."""
    ...
```

**Описание**: Обрабатывает команду `/start`, отправляя приветственное сообщение пользователю.

**Как работает функция**:
- Получает объект сообщения от пользователя.
- Логирует информацию об использовании команды `/start`.
- Отправляет приветственное сообщение пользователю, используя текст из `config.START_MESSAGE`.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- Отсутствуют.

**Примеры**:
```python
# Пример вызова (непосредственно вызывается telebot)
# Когда пользователь отправляет команду /start, эта функция автоматически вызывается ботом.
```

### `command_help`

```python
@bot.message_handler(commands=['help'])
def command_help(message):
    """Обработка команды /help."""
    ...
```

**Описание**: Обрабатывает команду `/help`, отправляя справку с доступными командами.

**Как работает функция**:
- Получает объект сообщения от пользователя.
- Логирует информацию об использовании команды `/help`.
- Вызывает метод `help_command` класса `BotHandler` для отправки справки пользователю.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- Отсутствуют.

**Примеры**:
```python
# Пример вызова (непосредственно вызывается telebot)
# Когда пользователь отправляет команду /help, эта функция автоматически вызывается ботом.
```

### `command_info`

```python
@bot.message_handler(commands=['info'])
def command_info(message):
    """Обработка команды /info."""
    ...
```

**Описание**: Обрабатывает команду `/info`, отправляя информацию о боте.

**Как работает функция**:
- Получает объект сообщения от пользователя.
- Логирует информацию об использовании команды `/info`.
- Отправляет информацию о боте пользователю, используя текст из `config.COMMAND_INFO`.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- Отсутствуют.

**Примеры**:
```python
# Пример вызова (непосредственно вызывается telebot)
# Когда пользователь отправляет команду /info, эта функция автоматически вызывается ботом.
```

### `command_time`

```python
@bot.message_handler(commands=['time'])
def command_time(message):
    """Обработка команды /time."""
    ...
```

**Описание**: Обрабатывает команду `/time`, отправляя текущее время пользователю.

**Как работает функция**:
- Получает объект сообщения от пользователя.
- Логирует информацию об использовании команды `/time`.
- Получает текущее время и форматирует его.
- Отправляет текущее время пользователю.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- Отсутствуют.

**Примеры**:
```python
# Пример вызова (непосредственно вызывается telebot)
# Когда пользователь отправляет команду /time, эта функция автоматически вызывается ботом.
```

### `command_photo`

```python
@bot.message_handler(commands=['photo'])
def command_photo(message):
    """Обработка команды /photo."""
    ...
```

**Описание**: Обрабатывает команду `/photo`, отправляя случайное фото из директории.

**Как работает функция**:
- Получает объект сообщения от пользователя.
- Логирует информацию об использовании команды `/photo`.
- Пытается отправить случайное фото из директории `config.PHOTO_DIR`.
- Если в директории нет фото, отправляет сообщение об отсутствии фото.
- Если директория не найдена, отправляет сообщение о том, что директория не найдена.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- `FileNotFoundError`: Если директория с фотографиями не найдена.

**Примеры**:
```python
# Пример вызова (непосредственно вызывается telebot)
# Когда пользователь отправляет команду /photo, эта функция автоматически вызывается ботом.
```

### `handle_voice_message`

```python
@bot.message_handler(content_types=['voice'])
def handle_voice_message(message):
    """Обработка голосовых сообщений."""
    ...
```

**Описание**: Обрабатывает голосовые сообщения, отправленные пользователем.

**Как работает функция**:
- Получает объект сообщения от пользователя.
- Логирует информацию об отправке голосового сообщения.
- Вызывает метод `handle_voice` класса `BotHandler` для обработки голосового сообщения.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- Отсутствуют.

**Примеры**:
```python
# Пример вызова (непосредственно вызывается telebot)
# Когда пользователь отправляет голосовое сообщение, эта функция автоматически вызывается ботом.
```

### `handle_document_message`

```python
@bot.message_handler(content_types=['document'])
def handle_document_message(message):
    """Обработка полученных документов."""
    ...
```

**Описание**: Обрабатывает документы, отправленные пользователем.

**Как работает функция**:
- Получает объект сообщения от пользователя.
- Логирует информацию об отправке документа.
- Вызывает метод `handle_document` класса `BotHandler` для обработки документа.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- Отсутствуют.

**Примеры**:
```python
# Пример вызова (непосредственно вызывается telebot)
# Когда пользователь отправляет документ, эта функция автоматически вызывается ботом.
```

### `handle_text_message`

```python
@bot.message_handler(func=lambda message: message.text and not message.text.startswith('/'))
def handle_text_message(message):
    """Обработка текстовых сообщений."""
    ...
```

**Описание**: Обрабатывает текстовые сообщения, отправленные пользователем, которые не являются командами (не начинаются с `/`).

**Как работает функция**:
- Получает объект сообщения от пользователя.
- Логирует информацию об отправленном текстовом сообщении.
- Вызывает метод `handle_message` класса `BotHandler` для обработки текстового сообщения.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- Отсутствуют.

**Примеры**:
```python
# Пример вызова (непосредственно вызывается telebot)
# Когда пользователь отправляет текстовое сообщение, не являющееся командой, эта функция автоматически вызывается ботом.
```

### `handle_unknown_command`

```python
@bot.message_handler(func=lambda message: message.text and message.text.startswith('/'))
def handle_unknown_command(message):
    """Обработка неизвестных команд."""
    ...
```

**Описание**: Обрабатывает неизвестные команды, отправленные пользователем (сообщения, начинающиеся с `/`, но не являющиеся известными командами).

**Как работает функция**:
- Получает объект сообщения от пользователя.
- Логирует информацию об отправленной неизвестной команде.
- Отправляет пользователю сообщение о том, что команда неизвестна, используя текст из `config.UNKNOWN_COMMAND_MESSAGE`.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Вызывает исключения**:
- Отсутствуют.

**Примеры**:
```python
# Пример вызова (непосредственно вызывается telebot)
# Когда пользователь отправляет неизвестную команду, эта функция автоматически вызывается ботом.
```