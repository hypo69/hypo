# Модуль AiAsk

## Обзор

Модуль `AiAsk` представляет собой асинхронный провайдер для взаимодействия с сервисом aiask.me. Он поддерживает ведение истории сообщений и работу с моделью GPT-3.5 Turbo.

## Подробней

Модуль использует асинхронные запросы для обмена сообщениями с сервером aiask.me. Он предназначен для интеграции с другими частями проекта, где требуется взаимодействие с указанным сервисом.

## Классы

### `AiAsk`

**Описание**: Класс `AiAsk` является асинхронным провайдером, предназначенным для взаимодействия с сервисом [aiask.me](https://e.aiask.me). Он наследуется от `AsyncGeneratorProvider` и предоставляет функциональность для отправки сообщений и получения ответов в асинхронном режиме.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность асинхронного генератора.

**Аттрибуты**:
- `url` (str): URL-адрес сервиса aiask.me.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений.
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели GPT-3.5 Turbo.
- `working` (bool): Флаг, указывающий на работоспособность провайдера (установлен в `False`).

**Методы**:
- `create_async_generator`: Асинхронный метод для создания генератора, отправляющего сообщения и получающего ответы от сервиса aiask.me.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Асинхронно создает генератор для взаимодействия с API aiask.me.

        Args:
            cls: Класс, для которого создается генератор.
            model (str): Используемая модель (не используется в данном коде).
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы, такие как `temperature`.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий ответы от API.

        Raises:
            RuntimeError: Если достигнут лимит запросов (Rate limit reached).
        """
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор для взаимодействия с API aiask.me. Она отправляет сообщения и возвращает ответы, полученные от API, используя асинхронные запросы.

**Параметры**:
- `cls`: Класс, для которого создается генератор.
- `model` (str): Используемая модель (фактически не используется в данном коде, но передается как параметр).
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): Адрес прокси-сервера для использования при отправке запросов. По умолчанию `None`.
- `**kwargs`: Дополнительные именованные аргументы, которые могут включать, например, параметр `temperature` для контроля случайности ответов модели.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который выдает ответы от API aiask.me.

**Вызывает исключения**:
- `RuntimeError`: Вызывается, когда достигнут лимит запросов (`Rate limit reached`).

**Как работает функция**:

1. **Установка заголовков**:
   - Определяются HTTP-заголовки, включающие `accept`, `origin` и `referer`, необходимые для взаимодействия с API.
2. **Асинхронная сессия**:
   - Создается асинхронная сессия `aiohttp.ClientSession` с заданными заголовками для выполнения HTTP-запросов.
3. **Формирование данных**:
   - Формируются данные для отправки в теле запроса, включая флаг `continuous`, идентификатор `id`, список сообщений `list`, модель `models`, пустой `prompt`, температуру `temperature` и пустой `title`.
4. **Отправка запроса и обработка ответа**:
   - Отправляется POST-запрос к API (`cls.url/v1/chat/gpt/`) с использованием асинхронной сессии и прокси (если указан).
   - Если запрос завершается с ошибкой, вызывается `response.raise_for_status()`, что приведет к исключению.
5. **Чтение и генерация чанков**:
   - Читается ответ от сервера по частям (чанкам) в асинхронном режиме.
   - Буфер используется для накопления данных, пока не будет получен полный ответ.
   - Проверяется, не начался ли ответ с сообщения о лимите запросов.
   - Если лимит не достигнут, чанк декодируется и возвращается через `yield`.
   - Если получен полный текст сообщения о лимите запросов, вызывается исключение `RuntimeError`.

**ASCII Flowchart**:

```
Начало
  ↓
Установка HTTP-заголовков
  ↓
Создание асинхронной сессии (ClientSession)
  ↓
Формирование данных запроса (data)
  ↓
Отправка POST-запроса к API aiask.me
  ↓
Начало чтения ответа по частям (чанкам)
  |
  ├──→ Чтение чанка данных
  |     ↓
  |     Добавление чанка в буфер
  |     ↓
  |     Проверка на сообщение о лимите запросов
  |     ↓
  |     Если лимит:
  |     └──→ Выброс RuntimeError("Rate limit reached")
  |     ↓
  └──→ Если не лимит:
        ↓
        Декодирование буфера
        ↓
        Выдача буфера через yield
        ↓
        Очистка буфера
  ↓
Конец (генератор завершается, когда нет больше данных)
```

**Примеры**:

```python
# Пример использования функции create_async_generator
import asyncio
from typing import List, Dict, AsyncGenerator

async def main():
    messages: List[Dict[str, str]] = [
        {"role": "user", "content": "Привет!"}
    ]

    async def print_generator(generator: AsyncGenerator[str, None]):
        async for message in generator:
            print(message, end="")

    generator = AiAsk.create_async_generator(model="gpt-3.5-turbo", messages=messages)
    await print_generator(await generator)

if __name__ == "__main__":
    asyncio.run(main())