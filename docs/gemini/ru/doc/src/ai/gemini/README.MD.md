# Документация модуля Google Generative AI Integration

## Обзор

Модуль `src.ai.gemini` предназначен для интеграции с моделями Generative AI от Google. Он предоставляет класс `GoogleGenerativeAI`, который упрощает взаимодействие с этими моделями, включая отправку запросов, обработку ответов, управление диалогами и интеграцию с различными AI-функциями. Модуль включает надежную обработку ошибок, логирование и параметры конфигурации для обеспечения бесперебойной работы.

## Подробнее

Этот модуль обеспечивает удобный интерфейс для работы с Google Gemini API, позволяя легко интегрировать возможности генеративного ИИ в различные приложения. Класс `GoogleGenerativeAI` предоставляет методы для отправки текстовых запросов, обработки изображений и управления диалогами, а также обеспечивает надежную обработку ошибок и логирование для облегчения отладки и мониторинга.

## Классы

### `GoogleGenerativeAI`

**Описание**: Класс `GoogleGenerativeAI` предназначен для взаимодействия с моделями Generative AI от Google.

**Принцип работы**: Класс инициализируется с использованием API-ключа, имени модели, конфигурации генерации и системных инструкций. Он предоставляет методы для отправки запросов, управления диалогами и обработки ошибок. Внутри класса используются библиотеки `google.generativeai` и другие вспомогательные модули для выполнения задач.

**Атрибуты**:

- `api_key` (str): API-ключ для доступа к Google Generative AI.
- `model_name` (Optional[str]): Имя используемой модели. По умолчанию `None`.
- `generation_config` (Optional[Dict]): Конфигурация генерации. По умолчанию `None`.
- `system_instruction` (Optional[str]): Системные инструкции для модели. По умолчанию `None`.

**Методы**:
- `__init__(self, api_key: str, model_name: Optional[str] = None, generation_config: Optional[Dict] = None, system_instruction: Optional[str] = None, **kwargs)`: Инициализирует класс `GoogleGenerativeAI`.
- `config()`: Извлекает конфигурацию из файла настроек.
- `_start_chat(self)`: Начинает чат-сессию с AI-моделью.
- `_save_dialogue(self, dialogue: list)`: Сохраняет диалог в текстовые и JSON-файлы.
- `ask(self, q: str, attempts: int = 15) -> Optional[str]`: Отправляет текстовый запрос AI-модели и получает ответ.
- `chat(self, q: str) -> str`: Отправляет сообщение в чат AI-модели и получает ответ.
- `describe_image(self, image_path: Path) -> Optional[str]`: Генерирует текстовое описание изображения.
- `upload_file(self, file: str | Path | IOBase, file_name: Optional[str] = None) -> bool`: Загружает файл в AI-модель.

## Функции

### `__init__`

```python
def __init__(self, api_key: str, model_name: Optional[str] = None, generation_config: Optional[Dict] = None, system_instruction: Optional[str] = None, **kwargs):
    """Инициализирует класс GoogleGenerativeAI с необходимыми конфигурациями.

    Args:
        api_key (str): API-ключ для доступа к Google Generative AI.
        model_name (Optional[str], optional): Имя используемой модели. По умолчанию None.
        generation_config (Optional[Dict], optional): Конфигурация генерации. По умолчанию None.
        system_instruction (Optional[str], optional): Системные инструкции для модели. По умолчанию None.
        **kwargs: Дополнительные аргументы.

    Raises:
        Exception: Если возникает ошибка при инициализации модели или создании необходимых директорий.
    """
    ...
```

**Назначение**: Инициализирует экземпляр класса `GoogleGenerativeAI` с заданными параметрами.

**Параметры**:
- `api_key` (str): API-ключ для доступа к Google Generative AI.
- `model_name` (Optional[str], optional): Имя используемой модели. По умолчанию `None`.
- `generation_config` (Optional[Dict], optional): Конфигурация генерации. По умолчанию `None`.
- `system_instruction` (Optional[str], optional): Системные инструкции для модели. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при инициализации модели или создании необходимых директорий.

**Как работает функция**:
1. Функция инициализирует API-ключ, имя модели, конфигурацию генерации и системные инструкции.
2. Определяет пути для логирования диалогов и хранения истории.
3. Инициализирует Google Generative AI модель.
4. Создает необходимые директории для сохранения истории диалогов.

```
Инициализация параметров
│
Создание путей к файлам
│
Инициализация модели Generative AI
│
Создание директорий для истории диалогов
```

**Примеры**:
```python
ai = GoogleGenerativeAI(api_key="your_api_key", system_instruction="Instruction")
```

### `config`

```python
def config():
    """Извлекает конфигурацию из файла настроек.

    Returns:
        dict: Словарь с конфигурацией.

    Raises:
        FileNotFoundError: Если файл конфигурации не найден.
        json.JSONDecodeError: Если файл конфигурации содержит неверный JSON.
        Exception: При возникновении других ошибок при чтении файла конфигурации.
    """
    ...
```

**Назначение**: Извлекает конфигурацию из файла `gemini.json`.

**Параметры**:
- Нет

**Возвращает**:
- `dict`: Словарь с конфигурацией.

**Вызывает исключения**:
- `FileNotFoundError`: Если файл конфигурации не найден.
- `json.JSONDecodeError`: Если файл конфигурации содержит неверный JSON.
- `Exception`: При возникновении других ошибок при чтении файла конфигурации.

**Как работает функция**:
1. Определяет путь к файлу конфигурации `gemini.json`.
2. Открывает файл и загружает JSON-данные.
3. Возвращает словарь с конфигурацией.

```
Определение пути к файлу
│
Чтение JSON из файла
│
Возврат конфигурации
```

**Примеры**:
```python
config = GoogleGenerativeAI.config()
```

### `_start_chat`

```python
def _start_chat(self):
    """Начинает чат-сессию с AI-моделью.

    Returns:
        google.generativeai.generative_models.ChatSession: Объект чат-сессии.
    """
    ...
```

**Назначение**: Начинает чат-сессию с AI-моделью.

**Параметры**:
- Нет

**Возвращает**:
- `google.generativeai.generative_models.ChatSession`: Объект чат-сессии.

**Как работает функция**:
1. Инициализирует чат-сессию с пустой историей.
2. Возвращает объект чат-сессии.

```
Инициализация чат-сессии
│
Возврат объекта чат-сессии
```

**Примеры**:
```python
chat_session = ai._start_chat()
```

### `_save_dialogue`

```python
def _save_dialogue(self, dialogue: list):
    """Сохраняет диалог в текстовые и JSON-файлы.

    Args:
        dialogue (list): Список сообщений в диалоге.

    Raises:
        Exception: Если возникает ошибка при записи в файл.
    """
    ...
```

**Назначение**: Сохраняет диалог в текстовые и JSON-файлы для последующего анализа и отладки.

**Параметры**:
- `dialogue` (list): Список сообщений в диалоге.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при записи в файл.

**Как работает функция**:
1. Формирует пути к файлам для сохранения диалога в формате TXT и JSON.
2. Записывает каждое сообщение диалога в TXT-файл, добавляя временную метку и разделители.
3. Записывает весь диалог в JSON-файл.
4. Обрабатывает возможные исключения при записи в файл, логируя ошибку.

```
Формирование путей к файлам
│
Запись сообщений в TXT-файл
│
Запись диалога в JSON-файл
│
Обработка исключений
```

**Примеры**:
```python
ai._save_dialogue(dialogue)
```

### `ask`

```python
def ask(self, q: str, attempts: int = 15) -> Optional[str]:
    """Отправляет текстовый запрос AI-модели и получает ответ.

    Args:
        q (str): Текст запроса.
        attempts (int, optional): Максимальное количество попыток. По умолчанию 15.

    Returns:
        Optional[str]: Ответ от AI-модели или None в случае ошибки.

    Raises:
        Exception: Если все попытки завершились неудачей.
    """
    ...
```

**Назначение**: Отправляет текстовый запрос AI-модели и возвращает полученный ответ.

**Параметры**:
- `q` (str): Текст запроса.
- `attempts` (int, optional): Максимальное количество попыток отправки запроса. По умолчанию 15.

**Возвращает**:
- `Optional[str]`: Ответ от AI-модели или `None` в случае ошибки.

**Вызывает исключения**:
- `Exception`: Если все попытки завершились неудачей.

**Как работает функция**:
1. Функция пытается отправить запрос `q` к AI-модели `attempts` раз.
2. В случае сетевых ошибок или недоступности сервиса, функция логирует ошибку и повторяет попытку с экспоненциальной задержкой.
3. Если достигнуто максимальное количество попыток, функция логирует ошибку и возвращает `None`.
4. Если запрос успешен, функция сохраняет диалог в файлы истории и возвращает ответ от AI-модели.

```
Отправка запроса
│
Обработка ошибок
│
Сохранение диалога
│
Возврат ответа
```

**Примеры**:
```python
response = ai.ask("Как дела?")
print(response)
```

### `chat`

```python
def chat(self, q: str) -> str:
    """Отправляет сообщение в чат AI-модели и получает ответ.

    Args:
        q (str): Текст сообщения.

    Returns:
        str: Ответ от AI-модели.

    Raises:
        Exception: Если возникает ошибка при отправке сообщения.
    """
    ...
```

**Назначение**: Отправляет сообщение в чат AI-модели и возвращает ответ.

**Параметры**:
- `q` (str): Текст сообщения.

**Возвращает**:
- `str`: Ответ от AI-модели.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при отправке сообщения.

**Как работает функция**:
1. Функция использует чат-сессию, инициализированную с помощью `_start_chat`.
2. Отправляет сообщение `q` в чат AI-модели.
3. Логирует ошибки, если они возникают.
4. Возвращает текст ответа от AI-модели.

```
Отправка сообщения в чат
│
Обработка ошибок
│
Возврат ответа
```

**Примеры**:
```python
response = ai.chat("Привет!")
print(response)
```

### `describe_image`

```python
def describe_image(self, image_path: Path) -> Optional[str]:
    """Генерирует текстовое описание изображения.

    Args:
        image_path (Path): Путь к изображению.

    Returns:
        Optional[str]: Текстовое описание изображения или None в случае ошибки.

    Raises:
        Exception: Если возникает ошибка при обработке изображения или отправке запроса.
    """
    ...
```

**Назначение**: Генерирует текстовое описание изображения, используя AI-модель.

**Параметры**:
- `image_path` (Path): Путь к файлу изображения.

**Возвращает**:
- `Optional[str]`: Текстовое описание изображения или `None` в случае ошибки.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при обработке изображения или отправке запроса.

**Как работает функция**:
1. Кодирует изображение в формат base64.
2. Отправляет закодированное изображение в AI-модель.
3. Возвращает сгенерированное описание или логирует ошибку, если операция не удалась.

```
Кодирование изображения в base64
│
Отправка изображения в AI-модель
│
Возврат описания изображения
```

**Примеры**:
```python
image_description = ai.describe_image(Path("path/to/image.jpg"))
if image_description:
    print(image_description)
```

### `upload_file`

```python
def upload_file(self, file: str | Path | IOBase, file_name: Optional[str] = None) -> bool:
    """Загружает файл в AI-модель.

    Args:
        file (str | Path | IOBase): Путь к файлу, файловый объект или строка с содержимым файла.
        file_name (Optional[str], optional): Имя файла. По умолчанию None.

    Returns:
        bool: True, если файл успешно загружен, False в случае ошибки.
    """
    ...
```

**Назначение**: Загружает файл в AI-модель для обработки.

**Параметры**:
- `file` (str | Path | IOBase): Путь к файлу, файловый объект или строка с содержимым файла.
- `file_name` (Optional[str], optional): Имя файла. По умолчанию `None`.

**Возвращает**:
- `bool`: `True`, если файл успешно загружен, `False` в случае ошибки.

**Как работает функция**:
1. Обрабатывает различные типы входных данных (`str`, `Path`, `IOBase`) для чтения содержимого файла.
2. Вызывает метод `_upload` для фактической загрузки файла.
3. Логирует информацию об успешной или неуспешной загрузке.
4. Обеспечивает повторную попытку загрузки в случае ошибки.

```
Обработка типа файла
│
Вызов _upload для загрузки файла
│
Логирование результата
│
Повторная попытка в случае ошибки
```

**Примеры**:
```python
file_path = "path/to/file.txt"
success = ai.upload_file(file_path)
if success:
    print("Файл успешно загружен")
```
```markdown