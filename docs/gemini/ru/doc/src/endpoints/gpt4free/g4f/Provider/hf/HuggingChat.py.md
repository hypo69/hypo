# Модуль HuggingChat
## Обзор
Модуль `HuggingChat.py` предоставляет реализацию асинхронного провайдера для взаимодействия с Hugging Face Chat API. Он включает в себя функциональность для аутентификации, создания бесед, отправки сообщений и обработки ответов, включая текст, изображения и результаты веб-поиска.

## Подробнее
Этот модуль позволяет интегрировать модели Hugging Face в проект `hypotez` для обработки текстовых и графических запросов. Он использует асинхронные запросы для обеспечения неблокирующего взаимодействия с API. Модуль поддерживает потоковую передачу ответов, что позволяет получать ответы в режиме реального времени.

## Классы

### `Conversation`
Описание назначения класса: Класс `Conversation` представляет собой структуру данных для хранения информации о беседе, включая идентификаторы бесед и сообщений для различных моделей.
**Наследует**: `JsonConversation`

**Атрибуты**:
- `models` (dict): Словарь, содержащий информацию о беседах для разных моделей, где ключ - это идентификатор модели, а значение - словарь с идентификаторами беседы и сообщения.

### `HuggingChat`
Описание назначения класса: Класс `HuggingChat` реализует асинхронного провайдера для взаимодействия с Hugging Face Chat API. Он предоставляет методы для аутентификации, создания бесед, отправки сообщений и обработки ответов.
**Наследует**: `AsyncAuthedProvider`, `ProviderModelMixin`

**Атрибуты**:
- `domain` (str): Доменное имя Hugging Face Chat.
- `origin` (str): Базовый URL Hugging Face Chat.
- `url` (str): URL для взаимодействия с Hugging Face Chat API.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `use_nodriver` (bool): Флаг, указывающий, использовать ли бездрайверный режим.
- `supports_stream` (bool): Флаг, указывающий, поддерживает ли провайдер потоковую передачу ответов.
- `needs_auth` (bool): Флаг, указывающий, требуется ли аутентификация.
- `default_model` (str): Модель, используемая по умолчанию.
- `default_vision_model` (str): Модель для обработки изображений, используемая по умолчанию.
- `model_aliases` (dict): Словарь псевдонимов моделей.
- `image_models` (list): Список моделей, поддерживающих обработку изображений.
- `text_models` (list): Список текстовых моделей.

**Методы**:
- `get_models()`: Получает список доступных моделей из API Hugging Face Chat.
- `on_auth_async()`: Выполняет асинхронную аутентификацию пользователя.
- `create_authed()`: Создает аутентифицированный запрос к API Hugging Face Chat.
- `create_conversation()`: Создает новую беседу.
- `fetch_message_id()`: Получает идентификатор последнего сообщения в беседе.

## Функции

### `get_models`
```python
    @classmethod
    def get_models(cls):
        ...
```
**Назначение**: Получение списка доступных моделей из API Hugging Face Chat.

**Как работает функция**:

1.  **Проверка наличия моделей**:
    *   Функция проверяет, были ли уже загружены модели (`if not cls.models:`). Если модели еще не загружены, выполняется дальнейшая логика для их получения.
2.  **Выполнение запроса к API**:
    *   Выполняется HTTP GET-запрос к URL (`cls.url`) для получения списка моделей.
3.  **Извлечение списка моделей из текста ответа**:
    *   Используется регулярное выражение (`re.search`) для поиска блока JSON, содержащего информацию о моделях.
    *   Удаляются параметры моделей (`re.sub(r\',parameters:{[^}]+?}\', \'\', text)`), чтобы упростить дальнейший парсинг.
    *   Заменяются значения `void 0` на `null` (`text = text.replace(\'void 0\', \'null\')`) для совместимости с JSON.
    *   Добавляются кавычки к ключам JSON (`re.sub(r\'([{,])([A-Za-z0-9_]+?):\', add_quotation_mark, text)`) для корректного парсинга.
    *   JSON-текст преобразуется в структуру данных Python (`json.loads(text)`).
4.  **Извлечение идентификаторов моделей**:
    *   Извлекаются идентификаторы текстовых моделей (`cls.text_models = [model["id"] for model in models]`).
    *   Обновляется общий список моделей (`cls.models = cls.text_models + cls.image_models`).
    *   Определяются модели, поддерживающие мультимодальность (`cls.vision_models = [model["id"] for model in models if model["multimodal"]]`).
5.  **Обработка ошибок**:
    *   Если в процессе получения или обработки моделей возникает исключение, оно логируется с использованием `debug.error`.
    *   В случае ошибки, список моделей заменяется на резервный список (`cls.models = [*fallback_models]`).
6.  **Возврат списка моделей**:
    *   Функция возвращает список доступных моделей (`return cls.models`).

```
A: Проверка наличия моделей
|
B: Запрос к API Hugging Face
|
C: Извлечение списка моделей из ответа
|
D: Обработка и обновление списка моделей
|
E: Обработка ошибок
|
F: Возврат списка моделей
```
**Пример**:
```python
    models = HuggingChat.get_models()
    print(models)
```

### `on_auth_async`
```python
    @classmethod
    async def on_auth_async(cls, cookies: Cookies = None, proxy: str = None, **kwargs) -> AsyncIterator:
        ...
```
**Назначение**: Асинхронная аутентификация пользователя.

**Параметры**:
- `cookies` (Cookies, optional): Файлы cookie для аутентификации. По умолчанию `None`.
- `proxy` (str, optional): Прокси-сервер для использования при аутентификации. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Как работает функция**:

1.  **Проверка наличия cookie**:
    *   Проверяет, переданы ли файлы cookie (`if cookies is None:`). Если нет, пытается получить их из браузера (`get_cookies`).
    *   Если в файлах cookie есть `hf-chat`, возвращает результат аутентификации с этими cookie.
2.  **Запрос на ввод данных для аутентификации**:
    *   Если требуется аутентификация (`if cls.needs_auth:`), возвращает запрос на ввод данных для аутентификации (`RequestLogin`).
    *   Выполняет аутентификацию с использованием данных, полученных из веб-драйвера (`get_args_from_nodriver`).
3.  **Генерация session ID**:
    *   Если аутентификация не требуется, генерирует случайный `session ID` и возвращает результат аутентификации с этим ID.

```
A: Проверка наличия cookie
|
B: Получение cookie или запрос на ввод данных
|
C: Аутентификация через веб-драйвер
|
D: Генерация session ID (если не требуется аутентификация)
|
E: Возврат результата аутентификации
```
**Пример**:
```python
    async for result in HuggingChat.on_auth_async(cookies=cookies):
        print(result)
```

### `create_authed`
```python
    @classmethod
    async def create_authed(
        cls,
        model: str,
        messages: Messages,
        auth_result: AuthResult,
        prompt: str = None,
        media: MediaListType = None,
        return_conversation: bool = False,
        conversation: Conversation = None,
        web_search: bool = False,
        **kwargs
    ) -> AsyncResult:
        ...
```

**Назначение**: Создает аутентифицированный запрос к API Hugging Face Chat.

**Параметры**:
- `model` (str): Идентификатор модели.
- `messages` (Messages): Список сообщений для отправки.
- `auth_result` (AuthResult): Результат аутентификации.
- `prompt` (str, optional): Дополнительный промпт. По умолчанию `None`.
- `media` (MediaListType, optional): Список медиафайлов для отправки. По умолчанию `None`.
- `return_conversation` (bool, optional): Флаг, указывающий, нужно ли возвращать объект беседы. По умолчанию `False`.
- `conversation` (Conversation, optional): Объект беседы. По умолчанию `None`.
- `web_search` (bool, optional): Флаг, указывающий, нужно ли использовать веб-поиск. По умолчанию `False`.
- `**kwargs`: Дополнительные аргументы.

**Как работает функция**:

1.  **Проверка зависимостей**:
    *   Проверяет, установлен ли пакет `curl_cffi`. Если нет, вызывает исключение `MissingRequirementsError`.
2.  **Выбор модели**:
    *   Определяет модель для использования, выбирая `default_vision_model`, если переданы медиафайлы и не указана модель.
    *   Получает модель с помощью `cls.get_model(model)`.
3.  **Создание сессии**:
    *   Создает сессию `curl_cffi.requests.Session` с использованием данных аутентификации.
4.  **Инициализация беседы**:
    *   Если объект беседы не передан или не содержит информации о моделях, создает новый объект `Conversation`.
5.  **Создание или получение идентификатора беседы**:
    *   Если модель не найдена в `conversation.models`, создает новую беседу с помощью `cls.create_conversation`.
    *   Получает идентификатор последнего сообщения с помощью `cls.fetch_message_id`.
    *   Сохраняет информацию о беседе в `conversation.models`.
6.  **Формирование входных данных**:
    *   Формирует входные данные для запроса, используя `format_prompt` для новых бесед и `get_last_user_message` для продолжения существующих.
7.  **Формирование настроек запроса**:
    *   Создает словарь `settings`, содержащий входные данные, идентификатор сообщения, флаги для повторных запросов и веб-поиска, а также информацию об используемых инструментах.
8.  **Формирование заголовков запроса**:
    *   Создает словарь `headers`, содержащий заголовки, необходимые для запроса.
9.  **Формирование тела запроса**:
    *   Создает объект `CurlMime` и добавляет данные и медиафайлы в тело запроса.
10. **Отправка запроса и обработка ответа**:
    *   Отправляет POST-запрос к API с использованием сессии, заголовков и тела запроса.
    *   Обрабатывает ответ построчно, декодируя JSON и извлекая данные в зависимости от типа сообщения (`stream`, `finalAnswer`, `file`, `webSearch`, `title`, `reasoning`).
    *   Возвращает результаты в виде асинхронного генератора.

```
A: Проверка зависимостей
|
B: Выбор модели
|
C: Создание сессии
|
D: Инициализация беседы
|
E: Создание или получение идентификатора беседы
|
F: Формирование входных данных
|
G: Формирование настроек запроса
|
H: Формирование заголовков запроса
|
I: Формирование тела запроса
|
J: Отправка запроса и обработка ответа
|
K: Возврат результатов
```
**Пример**:
```python
    async for result in HuggingChat.create_authed(
        model="default",
        messages=[{"role": "user", "content": "Hello"}],
        auth_result=auth_result
    ):
        print(result)
```

### `create_conversation`
```python
    @classmethod
    def create_conversation(cls, session: Session, model: str):
       ...
```

**Назначение**: Создает новую беседу.

**Параметры**:
- `session` (Session): Сессия `curl_cffi.requests.Session` для выполнения запросов.
- `model` (str): Идентификатор модели.

**Как работает функция**:

1.  **Выбор модели по умолчанию для изображений**:
    *   Если указанная модель входит в список моделей для обработки изображений (`cls.image_models`), она заменяется на модель по умолчанию (`cls.default_model`).
2.  **Формирование данных запроса**:
    *   Создается словарь `json_data`, содержащий идентификатор модели.
3.  **Отправка запроса**:
    *   Отправляется POST-запрос к API для создания новой беседы.
4.  **Обработка ошибок**:
    *   Если возвращается код состояния 401, вызывается исключение `MissingAuthError`.
    *   Если возвращается код состояния 400, вызывается исключение `ResponseError`.
5.  **Извлечение идентификатора беседы**:
    *   Извлекается идентификатор созданной беседы из JSON-ответа (`response.json().get('conversationId')`).
6.  **Возврат идентификатора беседы**:
    *   Возвращает идентификатор созданной беседы.

```
A: Выбор модели по умолчанию для изображений
|
B: Формирование данных запроса
|
C: Отправка запроса
|
D: Обработка ошибок
|
E: Извлечение идентификатора беседы
|
F: Возврат идентификатора беседы
```
**Пример**:
```python
    conversation_id = HuggingChat.create_conversation(session, "default")
    print(conversation_id)
```

### `fetch_message_id`
```python
    @classmethod
    def fetch_message_id(cls, session: Session, conversation_id: str):
        ...
```

**Назначение**: Получает идентификатор последнего сообщения в беседе.

**Параметры**:
- `session` (Session): Сессия `curl_cffi.requests.Session` для выполнения запросов.
- `conversation_id` (str): Идентификатор беседы.

**Как работает функция**:

1.  **Выполнение запроса**:
    *   Выполняется GET-запрос к API для получения данных беседы.
2.  **Разбор ответа**:
    *   Разбивает ответ на строки и пытается разобрать каждую строку как JSON.
    *   Ищет строку, содержащую JSON с ключом `nodes`, и сохраняет ее в `json_data`.
3.  **Обработка ошибок**:
    *   Если не удается разобрать данные или найти нужные ключи, вызывается исключение `RuntimeError`.
    *   Проверяется, не является ли последнее сообщение сообщением об ошибке, и если да, вызывается исключение `MissingAuthError` или `ResponseError`.
4.  **Извлечение идентификатора сообщения**:
    *   Извлекает идентификатор последнего сообщения из структуры данных JSON.
5.  **Возврат идентификатора сообщения**:
    *   Возвращает идентификатор последнего сообщения.

```
A: Выполнение запроса
|
B: Разбор ответа
|
C: Обработка ошибок
|
D: Извлечение идентификатора сообщения
|
E: Возврат идентификатора сообщения
```
**Пример**:
```python
    message_id = HuggingChat.fetch_message_id(session, "conversation_id")
    print(message_id)