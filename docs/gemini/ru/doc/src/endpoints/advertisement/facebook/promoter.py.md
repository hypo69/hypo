# Модуль: src.endpoints.advertisement.facebook.promoter

## Обзор

Модуль `promoter.py` предназначен для автоматизации процесса продвижения контента (сообщений и событий) в группах Facebook. Он содержит класс `FacebookPromoter`, который использует WebDriver для публикации рекламных материалов, учитывая языковые и валютные предпочтения групп, а также избегая повторной публикации одних и тех же материалов.

## Подробней

Модуль обрабатывает кампании и события, публикуя их в группах Facebook, при этом избегая дублирования. Он включает в себя функции для получения URL создания события, логирования ошибок и обновления данных о продвижении в группах.

## Функции

### `get_event_url`

```python
def get_event_url(group_url: str) -> str:
    """
    Возвращает URL для создания события в Facebook, заменяя `group_id` на значение из входного URL.

    Args:
        group_url (str): URL группы Facebook, содержащий `group_id`.

    Returns:
        str: Модифицированный URL для создания события.
    """
```

**Как работает функция**:

1.  Извлекает `group_id` из URL группы Facebook.
2.  Формирует базовый URL для создания события.
3.  Создает параметры запроса, включая `acontext`, `dialog_entry_point` и `group_id`.
4.  Кодирует параметры запроса в строку запроса.
5.  Возвращает полный URL для создания события с добавленными параметрами.

## Классы

### `FacebookPromoter`

**Описание**: Класс `FacebookPromoter` предназначен для продвижения товаров и событий AliExpress в группах Facebook.

**Как работает класс**:

Класс автоматизирует процесс публикации рекламных материалов в группах Facebook, используя WebDriver. Он обеспечивает продвижение категорий и событий, избегая дублирования. Класс учитывает языковые и валютные предпочтения групп, а также интервалы между публикациями.

**Методы**:

#### `__init__`

```python
def __init__(self, d: Driver, promoter: str, group_file_paths: Optional[list[str | Path] | str | Path] = None, no_video: bool = False):
    """
    Инициализирует промоутер для групп Facebook.

    Args:
        d (Driver): WebDriver instance for browser automation.
        promoter (str): Имя промоутера.
        group_file_paths (Optional[list[str | Path]  |  str | Path], optional): Список путей к файлам, содержащим данные групп. Defaults to None.
        no_video (bool, optional): Флаг для отключения видео в постах. Defaults to False.
    """
```

**Как работает метод**:

1.  Инициализирует экземпляр класса `FacebookPromoter` с заданными параметрами.
2.  Сохраняет переданные параметры в атрибуты класса (`promoter`, `d`, `group_file_paths`, `no_video`).
3.  Если `group_file_paths` не указан, использует функцию `get_filenames` для получения списка файлов групп из директории `gs.path.google_drive / 'facebook' / 'groups'`.
4.  Инициализирует спиннер для отображения процесса выполнения.

#### `promote`

```python
def promote(self, group: SimpleNamespace, item: SimpleNamespace, is_event: bool = False, language: str = None, currency: str = None) -> bool:
    """
    Продвигает категорию или событие в группе Facebook.
    """
```

**Как работает метод**:

1.  Проверяет, соответствует ли язык и валюта группы указанным значениям (если они заданы).
2.  Определяет имя элемента (категории или события) для продвижения.
3.  Устанавливает атрибуты события или сообщения (заголовок, описание, время начала и окончания, рекламная ссылка).
4.  В зависимости от типа продвигаемого элемента (событие или сообщение) вызывает соответствующую функцию (`post_event` или `post_message`).
5.  Если продвижение выполнено успешно, обновляет данные группы (`update_group_promotion_data`).
6.  Возвращает `True` в случае успешного продвижения, `False` в случае ошибки.

#### `log_promotion_error`

```python
def log_promotion_error(self, is_event: bool, item_name: str):
    """
    Логирует ошибку продвижения для категории или события.
    """
```

**Как работает метод**:

1.  Записывает сообщение об ошибке в лог, указывая тип элемента (событие или категория) и его имя.

#### `update_group_promotion_data`

```python
def update_group_promotion_data(self, group: SimpleNamespace, item_name: str, is_event: bool = False):
    """
    Обновляет данные группы после успешного продвижения.
    """
```

**Как работает метод**:

1.  Получает текущую временную метку.
2.  Обновляет атрибут `last_promo_sended` группы текущей временной меткой.
3.  Добавляет имя продвигаемого элемента в список `promoted_events` или `promoted_categories` группы, в зависимости от типа элемента (событие или категория).

#### `process_groups`

```python
def process_groups(self, campaign_name: str = None, events: list[SimpleNamespace] = None, is_event: bool = False, group_file_paths: list[str] = None, group_categories_to_adv: list[str] = ['sales'], language: str = None, currency: str = None):
    """
    Обрабатывает все группы для текущей кампании или продвижения события.
    """
```

**Как работает метод**:

1.  Проверяет, заданы ли имя кампании или список событий для продвижения.
2.  Перебирает файлы групп, указанные в `group_file_paths`.
3.  Загружает данные каждой группы из соответствующего файла.
4.  Для каждой группы проверяет интервал между продвижениями (если это не событие).
5.  Проверяет, соответствует ли категория группы списку категорий для продвижения и активен ли статус группы.
6.  Получает элемент для продвижения (категорию или событие).
7.  Проверяет, не был ли уже продвинут данный элемент в этой группе.
8.  Получает URL группы и выполняет продвижение, вызывая метод `promote`.
9.  Сохраняет обновленные данные группы в файл.
10. Делает случайную задержку между 30 и 420 секундами.

#### `get_category_item`

```python
def get_category_item(self, campaign_name: str, group: SimpleNamespace, language: str, currency: str) -> SimpleNamespace:
    """
    Получает элемент категории для продвижения на основе кампании и промоутера.
    """
```

**Как работает метод**:

1.  В зависимости от промоутера (`aliexpress` или другой) выполняет следующие действия:
    *   Если промоутер `aliexpress`, использует класс `AliCampaignEditor` для получения списка категорий и выбора случайной категории для продвижения.
    *   Если промоутер не `aliexpress`, загружает данные кампании из файла и выбирает случайную категорию для продвижения.
2.  Получает описание категории из файла `description.txt`.
3.  Получает путь к изображению категории (если оно есть).
4.  Возвращает элемент категории для продвижения.

#### `check_interval`

```python
def check_interval(self, group: SimpleNamespace) -> bool:
    """
    Проверяет, прошло ли достаточно времени для продвижения этой группы.
    """
```

**Как работает метод**:

1.  Проверяет, прошло ли достаточно времени с момента последнего продвижения группы.

#### `validate_group`

```python
def validate_group(self, group: SimpleNamespace) -> bool:
    """
    Проверяет, что данные группы корректны.
    """
```

**Как работает метод**:

1.  Проверяет, что группа существует и содержит атрибуты `group_url` и `group_categories`.