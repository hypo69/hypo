# Модуль `base_provider`

## Обзор

Модуль `base_provider` содержит базовые классы и структуры данных, используемые для реализации различных провайдеров, предоставляющих функциональность для создания завершений (completions) на основе моделей машинного обучения. Он включает в себя абстрактные классы для синхронных, асинхронных и асинхронных генераторов, а также вспомогательные функции и классы для обработки параметров, ошибок и аутентификации.

## Подробней

Этот модуль является основой для создания новых провайдеров в проекте `hypotez`. Он определяет интерфейсы и предоставляет общую логику, необходимую для взаимодействия с различными API и моделями. Модуль также включает в себя механизмы для кэширования аутентификационных данных, обработки ошибок и безопасной передачи параметров.

## Классы

### `AbstractProvider`

**Описание**: Абстрактный базовый класс для всех провайдеров. Он определяет основной интерфейс для создания завершений и предоставляет общую логику для работы с параметрами и асинхронными задачами.

**Методы**:

- `create_completion(model: str, messages: Messages, stream: bool, **kwargs) -> CreateResult`:
    - **Назначение**: Абстрактный метод для создания завершения с заданными параметрами.
    - **Параметры**:
        - `model` (str): Модель для использования.
        - `messages` (Messages): Сообщения для обработки.
        - `stream` (bool): Использовать ли потоковую передачу.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `CreateResult`: Результат процесса создания.
    - **Вызывает исключения**:
        - `NotImplementedError`: Если метод не переопределен в производных классах.

- `create_async(model: str, messages: Messages, *, timeout: int = None, loop: AbstractEventLoop = None, executor: ThreadPoolExecutor = None, **kwargs) -> str`:
    - **Назначение**: Асинхронно создает результат на основе заданной модели и сообщений.
    - **Параметры**:
        - `model` (str): Модель для использования при создании.
        - `messages` (Messages): Сообщения для обработки.
        - `timeout` (int, optional): Время ожидания для асинхронной задачи. По умолчанию `None`.
        - `loop` (AbstractEventLoop, optional): Используемый event loop. По умолчанию `None`.
        - `executor` (ThreadPoolExecutor, optional): Executor для запуска асинхронных задач. По умолчанию `None`.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `str`: Созданный результат в виде строки.
    - **Как работает функция**:
        1. Получает event loop. Если `loop` не указан, использует текущий запущенный event loop.
        2. Определяет внутреннюю функцию `create_func`, которая вызывает `cls.create_completion` с переданными параметрами и объединяет полученные чанки.
        3. Запускает `create_func` в executor с использованием `loop.run_in_executor` и ожидает завершения задачи в течение `timeout`.

        **ASII flowchart**:

        ```
        Начало
        ↓
        Получение Event Loop
        ↓
        Определение create_func (вызов create_completion и объединение чанков)
        ↓
        Запуск create_func в Executor
        ↓
        Ожидание результата с timeout
        ↓
        Возврат результата
        Конец
        ```

    - **Примеры**:

        ```python
        # Пример вызова create_async
        async def example():
            result = await AbstractProvider.create_async(model='test_model', messages=[{'role': 'user', 'content': 'test message'}], timeout=10)
            print(result)
        ```

- `get_create_function() -> callable`:
    - **Назначение**: Возвращает функцию для создания завершений.
    - **Возвращает**:
        - `callable`: Функция `create_completion`.

- `get_async_create_function() -> callable`:
    - **Назначение**: Возвращает асинхронную функцию для создания завершений.
    - **Возвращает**:
        - `callable`: Функция `create_async`.

- `get_parameters(as_json: bool = False) -> dict[str, Parameter]`:
    - **Назначение**: Возвращает параметры, поддерживаемые провайдером.
    - **Параметры**:
        - `as_json` (bool, optional): Если `True`, возвращает параметры в формате JSON. По умолчанию `False`.
    - **Возвращает**:
        - `dict[str, Parameter]`: Словарь параметров.
    - **Как работает функция**:
        1. Извлекает параметры из сигнатуры функции `create_async_generator` (если класс является `AsyncGeneratorProvider`), `create_async` (если класс является `AsyncProvider`) или `create_completion`.
        2. Фильтрует параметры, оставляя только те, которые указаны в `SAFE_PARAMETERS` и удовлетворяют условиям (например, `stream` должен поддерживаться).
        3. Если `as_json` равен `True`, преобразует параметры в формат JSON, используя примеры значений из `PARAMETER_EXAMPLES` или значения по умолчанию для каждого типа данных.

        **ASII flowchart**:

        ```
        Начало
        ↓
        Определение функции создания (create_async_generator, create_async или create_completion)
        ↓
        Извлечение параметров из сигнатуры функции
        ↓
        Фильтрация параметров (SAFE_PARAMETERS, supports_stream)
        ↓
        Если as_json:
            Преобразование параметров в формат JSON
        ↓
        Возврат параметров
        Конец
        ```

    - **Внутренние функции**:
        - `get_type_as_var(annotation: type, key: str, default)`:
            - **Назначение**: Возвращает значение переменной на основе аннотации типа.
            - **Параметры**:
                - `annotation` (type): Аннотация типа переменной.
                - `key` (str): Ключ параметра.
                - `default`: Значение по умолчанию.
            - **Возвращает**:
                - Значение переменной.

- `params` (property):
    - **Назначение**: Возвращает строку, содержащую список поддерживаемых параметров провайдера.
    - **Возвращает**:
        - `str`: Строка с информацией о поддерживаемых параметрах.

### `AsyncProvider`

**Описание**: Класс, предоставляющий асинхронную функциональность для создания завершений.

**Наследует**: `AbstractProvider`

**Методы**:

- `create_completion(model: str, messages: Messages, stream: bool = False, **kwargs) -> CreateResult`:
    - **Назначение**: Создает результат завершения синхронно, запуская асинхронную задачу.
    - **Параметры**:
        - `model` (str): Модель для использования.
        - `messages` (Messages): Сообщения для обработки.
        - `stream` (bool, optional): Указывает, следует ли передавать результаты потоком. По умолчанию `False`.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `CreateResult`: Результат создания завершения.
    - **Как работает функция**:
        1. Проверяет, запущен ли event loop, используя `get_running_loop`.
        2. Запускает асинхронную функцию `cls.create_async` с использованием `asyncio.run` и возвращает результат.

        **ASII flowchart**:

        ```
        Начало
        ↓
        Проверка наличия Event Loop
        ↓
        Запуск create_async через asyncio.run
        ↓
        Возврат результата
        Конец
        ```

- `create_async(model: str, messages: Messages, **kwargs) -> str`:
    - **Назначение**: Абстрактный метод для создания асинхронных результатов.
    - **Параметры**:
        - `model` (str): Модель для использования при создании.
        - `messages` (Messages): Сообщения для обработки.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Вызывает исключения**:
        - `NotImplementedError`: Если этот метод не переопределен в производных классах.
    - **Возвращает**:
        - `str`: Созданный результат в виде строки.

- `get_create_function() -> callable`:
    - **Назначение**: Возвращает функцию для создания завершений.
    - **Возвращает**:
        - `callable`: Функция `create_completion`.

- `get_async_create_function() -> callable`:
    - **Назначение**: Возвращает асинхронную функцию для создания завершений.
    - **Возвращает**:
        - `callable`: Функция `create_async`.

### `AsyncGeneratorProvider`

**Описание**: Класс, предоставляющий асинхронную функциональность генератора для потоковой передачи результатов.

**Наследует**: `AbstractProvider`

**Атрибуты**:
    - `supports_stream` (bool): Поддерживает потоковую передачу данных.

**Методы**:

- `create_completion(model: str, messages: Messages, stream: bool = True, **kwargs) -> CreateResult`:
    - **Назначение**: Создает результат потоковой передачи синхронно.
    - **Параметры**:
        - `model` (str): Модель для использования при создании.
        - `messages` (Messages): Сообщения для обработки.
        - `stream` (bool, optional): Указывает, следует ли передавать результаты потоком. По умолчанию `True`.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `CreateResult`: Результат создания потоковой передачи.
    - **Как работает функция**:
        1. Преобразует асинхронный генератор, полученный из `cls.create_async_generator`, в синхронный генератор с помощью `to_sync_generator`.

        **ASII flowchart**:

        ```
        Начало
        ↓
        Вызов create_async_generator
        ↓
        Преобразование асинхронного генератора в синхронный (to_sync_generator)
        ↓
        Возврат результата
        Конец
        ```

- `create_async_generator(model: str, messages: Messages, stream: bool = True, **kwargs) -> AsyncResult`:
    - **Назначение**: Абстрактный метод для создания асинхронного генератора.
    - **Параметры**:
        - `model` (str): Модель для использования при создании.
        - `messages` (Messages): Сообщения для обработки.
        - `stream` (bool, optional): Указывает, следует ли передавать результаты потоком. По умолчанию `True`.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Вызывает исключения**:
        - `NotImplementedError`: Если этот метод не переопределен в производных классах.
    - **Возвращает**:
        - `AsyncResult`: Асинхронный генератор, выдающий результаты.

- `get_create_function() -> callable`:
    - **Назначение**: Возвращает функцию для создания завершений.
    - **Возвращает**:
        - `callable`: Функция `create_completion`.

- `get_async_create_function() -> callable`:
    - **Назначение**: Возвращает асинхронную функцию для создания завершений.
    - **Возвращает**:
        - `callable`: Функция `create_async_generator`.

### `ProviderModelMixin`

**Описание**: Миксин для добавления поддержки моделей в провайдеры.

**Атрибуты**:

- `default_model` (str): Модель по умолчанию.
- `models` (list[str]): Список поддерживаемых моделей.
- `model_aliases` (dict[str, str]): Словарь псевдонимов моделей.
- `image_models` (list): Список моделей изображений.
- `vision_models` (list): Список моделей компьютерного зрения.
- `last_model` (str): Последняя использованная модель.

**Методы**:

- `get_models(**kwargs) -> list[str]`:
    - **Назначение**: Возвращает список поддерживаемых моделей.
    - **Параметры**:
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `list[str]`: Список моделей.
    - **Как работает функция**:
        1. Если `cls.models` не определен и `cls.default_model` задан, возвращает список, содержащий только `cls.default_model`.
        2. В противном случае возвращает `cls.models`.

- `get_model(model: str, **kwargs) -> str`:
    - **Назначение**: Возвращает модель на основе заданного имени.
    - **Параметры**:
        - `model` (str): Имя модели.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `str`: Модель.
    - **Вызывает исключения**:
        - `ModelNotSupportedError`: Если модель не поддерживается.
    - **Как работает функция**:
        1. Если `model` не задан и `cls.default_model` определен, возвращает `cls.default_model`.
        2. Если `model` есть в `cls.model_aliases`, возвращает соответствующий псевдоним.
        3. Если `model` нет в списке поддерживаемых моделей и `cls.models` не пуст, вызывает исключение `ModelNotSupportedError`.
        4. Устанавливает `cls.last_model` и `debug.last_model` в значение `model`.

### `RaiseErrorMixin`

**Описание**: Миксин для обработки ошибок в ответах API.

**Методы**:

- `raise_error(data: dict, status: int = None)`:
    - **Назначение**: Вызывает исключение на основе данных об ошибке.
    - **Параметры**:
        - `data` (dict): Данные об ошибке.
        - `status` (int, optional): HTTP-статус ответа. По умолчанию `None`.
    - **Вызывает исключения**:
        - `ResponseError`: Если в данных есть сообщение об ошибке.
        - `MissingAuthError`: Если статус равен 401 и в данных есть сообщение об ошибке.
        - `PaymentRequiredError`: Если статус равен 402 и в данных есть сообщение об ошибке.
    - **Как работает функция**:
        1. Проверяет наличие ключей `error_message` или `error` в данных.
        2. В зависимости от типа данных в `error` (строка, логическое значение или словарь) вызывает соответствующее исключение.
        3. Если в данных нет ошибок и нет `choices` или `data`, вызывает `ResponseError` с сообщением о недействительном ответе.

### `AuthFileMixin`

**Описание**: Миксин для работы с файлами кэша аутентификации.

**Методы**:

- `get_cache_file() -> Path`:
    - **Назначение**: Возвращает путь к файлу кэша.
    - **Возвращает**:
        - `Path`: Путь к файлу кэша.
    - **Как работает функция**:
        1. Формирует имя файла на основе имени класса (или `cls.parent`, если он существует) и сохраняет его в каталоге для cookies.

### `AsyncAuthedProvider`

**Описание**: Класс, предоставляющий асинхронную функциональность с аутентификацией и кэшированием.

**Наследует**: `AsyncGeneratorProvider`, `AuthFileMixin`

**Методы**:

- `on_auth_async(**kwargs) -> AuthResult`:
    - **Назначение**: Асинхронно выполняет аутентификацию.
    - **Параметры**:
        - `**kwargs`: Дополнительные именованные аргументы, включая `api_key`.
    - **Возвращает**:
        - `AuthResult`: Результат аутентификации.
    - **Вызывает исключения**:
        - `MissingAuthError`: Если `api_key` не передан в `kwargs`.
    - **Как работает функция**:
        1. Проверяет наличие ключа `api_key` в `kwargs`.
        2. Если `api_key` отсутствует, вызывает исключение `MissingAuthError`.
        3. Возвращает объект `AuthResult`.

- `on_auth(**kwargs) -> AuthResult`:
    - **Назначение**: Выполняет аутентификацию синхронно.
    - **Параметры**:
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `AuthResult`: Результат аутентификации.
    - **Как работает функция**:
        1. Вызывает асинхронный метод `cls.on_auth_async` и преобразует результат в синхронный генератор (если результат является асинхронным итератором) или запускает асинхронную задачу с помощью `asyncio.run`.

- `get_create_function() -> callable`:
    - **Назначение**: Возвращает функцию для создания завершений.
    - **Возвращает**:
        - `callable`: Функция `create_completion`.

- `get_async_create_function() -> callable`:
    - **Назначение**: Возвращает асинхронную функцию для создания завершений.
    - **Возвращает**:
        - `callable`: Функция `create_async_generator`.

- `write_cache_file(cache_file: Path, auth_result: AuthResult = None)`:
    - **Назначение**: Записывает или удаляет файл кэша аутентификации.
    - **Параметры**:
        - `cache_file` (Path): Путь к файлу кэша.
        - `auth_result` (AuthResult, optional): Результат аутентификации. По умолчанию `None`.
    - **Как работает функция**:
        1. Если `auth_result` не `None`, создает родительские каталоги для файла (если они не существуют) и записывает данные `auth_result` в файл в формате JSON.
        2. Если `auth_result` равен `None` и файл существует, удаляет файл.

- `create_completion(model: str, messages: Messages, **kwargs) -> CreateResult`:
    - **Назначение**: Создает результат завершения с использованием аутентификации и кэширования.
    - **Параметры**:
        - `model` (str): Модель для использования.
        - `messages` (Messages): Сообщения для обработки.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `CreateResult`: Результат создания завершения.
    - **Как работает функция**:
        1. Получает путь к файлу кэша.
        2. Пытается прочитать данные аутентификации из файла кэша.
        3. Если файл существует, использует данные из файла для создания аутентифицированного запроса.
        4. Если файл не существует или данные в нем недействительны, выполняет аутентификацию с использованием `cls.on_auth`.
        5. Записывает результат аутентификации в файл кэша.

        **ASII flowchart**:

        ```
        Начало
        ↓
        Получение пути к файлу кэша
        ↓
        Попытка чтения данных аутентификации из файла
        ↓
        Если файл существует:
            Использование данных из файла для создания аутентифицированного запроса
        Иначе:
            Выполнение аутентификации (cls.on_auth)
        ↓
        Запись результата аутентификации в файл кэша
        ↓
        Возврат результата
        Конец
        ```

- `create_async_generator(model: str, messages: Messages, **kwargs) -> AsyncResult`:
    - **Назначение**: Создает асинхронный генератор с использованием аутентификации и кэширования.
    - **Параметры**:
        - `model` (str): Модель для использования.
        - `messages` (Messages): Сообщения для обработки.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `AsyncResult`: Асинхронный генератор, выдающий результаты.
    - **Как работает функция**:
        1. Получает путь к файлу кэша.
        2. Пытается прочитать данные аутентификации из файла кэша.
        3. Если файл существует, использует данные из файла для создания аутентифицированного запроса.
        4. Если файл не существует или данные в нем недействительны, выполняет асинхронную аутентификацию с использованием `cls.on_auth_async`.
        5. Записывает результат аутентификации в файл кэша.

        **ASII flowchart**:

        ```
        Начало
        ↓
        Получение пути к файлу кэша
        ↓
        Попытка чтения данных аутентификации из файла
        ↓
        Если файл существует:
            Использование данных из файла для создания аутентифицированного запроса
        Иначе:
            Выполнение асинхронной аутентификации (cls.on_auth_async)
        ↓
        Запись результата аутентификации в файл кэша
        ↓
        Возврат результата
        Конец
        ```

## Функции

В данном модуле функции отсутствуют.