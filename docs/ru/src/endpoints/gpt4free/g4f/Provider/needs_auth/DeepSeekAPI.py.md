# Модуль `DeepSeekAPI`

## Обзор

Модуль `DeepSeekAPI` предоставляет асинхронный интерфейс для взаимодействия с API DeepSeek. Он позволяет создавать чат-сессии, отправлять сообщения и получать ответы от модели. Модуль поддерживает аутентификацию и может быть использован для интеграции в другие приложения и сервисы.

## Подробнее

Модуль предназначен для работы с API DeepSeek, требующим аутентификации. Он использует библиотеку `dsk.api` для взаимодействия с API. В случае отсутствия этой библиотеки, функциональность модуля будет ограничена. Модуль предоставляет методы для аутентификации, создания чат-сессий и отправки сообщений.

## Классы

### `DeepSeekAPI`

**Описание**: Класс `DeepSeekAPI` является асинхронным провайдером и предоставляет интерфейс для взаимодействия с API DeepSeek.

**Наследует**:
- `AsyncAuthedProvider`: Обеспечивает асинхронную аутентификацию.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL для взаимодействия с DeepSeek API.
- `working` (bool): Указывает, работает ли модуль (зависит от наличия `dsk.api`).
- `needs_auth` (bool): Указывает, требуется ли аутентификация.
- `use_nodriver` (bool): Указывает, следует ли использовать `nodriver` для аутентификации.
- `_access_token` (str | None): Приватный атрибут для хранения токена доступа.
- `default_model` (str): Модель, используемая по умолчанию ("deepseek-v3").
- `models` (List[str]): Список поддерживаемых моделей (["deepseek-v3", "deepseek-r1"]).

**Методы**:
- `on_auth_async()`: Асинхронный метод для аутентификации.
- `create_authed()`: Асинхронный метод для создания аутентифицированного запроса.

### `on_auth_async`

```python
   @classmethod
    async def on_auth_async(cls, proxy: str = None, **kwargs) -> AsyncIterator:
        """ Асинхронно обрабатывает аутентификацию, получая токен доступа для дальнейших запросов к API DeepSeek.

        Args:
            proxy (str, optional): Прокси-сервер для использования при подключении. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncIterator: Асинхронный итератор, возвращающий объекты `RequestLogin` и `AuthResult`.

        Raises:
            Exception: Если не удается получить токен доступа.

        """
```

**Параметры**:
- `proxy` (str, optional): Прокси-сервер для использования при подключении. По умолчанию `None`.
- `kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncIterator`: Асинхронный итератор, возвращающий объекты `RequestLogin` и `AuthResult`.

**Как работает функция**:
1. Проверяет, инициализирован ли `browser` (браузер) класса. Если нет, получает `browser` и `stop_browser` с помощью `get_nodriver()`.
2. Отправляет `RequestLogin` с URL для аутентификации.
3. Определяет асинхронную функцию `callback`, которая ожидает появления токена доступа в `localStorage` страницы и сохраняет его в `cls._access_token`.
4. Получает аргументы из `nodriver` с использованием `get_args_from_nodriver()`, передавая URL, прокси и `callback`.
5. Возвращает `AuthResult` с токеном доступа и аргументами.

```text
    +---------------------+
    |  Проверка browser   |
    +---------------------+
          |
          V
    +---------------------+
    |  Запрос RequestLogin |
    +---------------------+
          |
          V
    +---------------------+
    |  Ожидание токена    |
    +---------------------+
          |
          V
    +---------------------+
    |  Получение AuthResult|
    +---------------------+
```

**Примеры**:

```python
# Пример вызова функции on_auth_async
async for result in DeepSeekAPI.on_auth_async(proxy="http://proxy.example.com"):
    print(result)
```

### `create_authed`

```python
    @classmethod
    async def create_authed(
        cls,
        model: str,
        messages: Messages,
        auth_result: AuthResult,
        conversation: JsonConversation = None,
        web_search: bool = False,
        **kwargs
    ) -> AsyncResult:
        """ Создает аутентифицированный запрос к API DeepSeek.

        Args:
            model (str): Название модели для использования.
            messages (Messages): Список сообщений для отправки.
            auth_result (AuthResult): Результат аутентификации.
            conversation (JsonConversation, optional): Объект разговора. По умолчанию `None`.
            web_search (bool, optional): Флаг включения веб-поиска. По умолчанию `False`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный результат запроса.

        """
```

**Параметры**:
- `model` (str): Название модели для использования.
- `messages` (Messages): Список сообщений для отправки.
- `auth_result` (AuthResult): Результат аутентификации.
- `conversation` (JsonConversation, optional): Объект разговора. По умолчанию `None`.
- `web_search` (bool, optional): Флаг включения веб-поиска. По умолчанию `False`.
- `kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный результат запроса.

**Как работает функция**:
1. Инициализирует API DeepSeek с использованием токена аутентификации из `auth_result`.
2. Если `conversation` не предоставлен, создает новую чат-сессию с помощью `api.create_chat_session()` и создает объект `JsonConversation`.
3. Отправляет сообщения пользователя с использованием `api.chat_completion()`, включая параметры для включения размышлений (`thinking_enabled`) и веб-поиска (`search_enabled`).
4. Обрабатывает чанки ответов, генерируя `Reasoning` (если включено размышление) и контент текста.
5. Возвращает `FinishReason` при завершении.

```text
    +-----------------------------+
    |  Инициализация API DeepSeek  |
    +-----------------------------+
          |
          V
    +-----------------------------+
    |  Создание чат-сессии        |
    +-----------------------------+
          |
          V
    +-----------------------------+
    |  Отправка сообщений         |
    +-----------------------------+
          |
          V
    +-----------------------------+
    |  Обработка чанков ответов   |
    +-----------------------------+
          |
          V
    +-----------------------------+
    |  Возврат FinishReason       |
    +-----------------------------+
```

**Примеры**:

```python
# Пример вызова функции create_authed
auth_result = AuthResult(api_key="test_key")
async for result in DeepSeekAPI.create_authed(
    model="deepseek-v3",
    messages=[{"role": "user", "content": "Hello"}],
    auth_result=auth_result,
    web_search=True
):
    print(result)
```
```python
        async def callback(page):
            """ Функция выполняет ожидание и получение токена доступа из локального хранилища страницы.

            Args:
                page: Объект страницы браузера, предоставляемый `nodriver`.

            Returns:
                None

            """
```
**Как работает функция**:
1. Запускает бесконечный цикл, который выполняется до тех пор, пока не будет получен токен доступа.
2. Приостанавливает выполнение на 1 секунду с помощью `asyncio.sleep(1)`.
3. Пытается получить значение `userToken` из `localStorage` страницы с помощью `page.evaluate()`.
4. Преобразует полученное значение из JSON в словарь и извлекает значение по ключу `value`.
5. Если токен доступа получен, сохраняет его в `cls._access_token` и выходит из цикла.

```text
    +-------------------------+
    |  Запуск бесконечного цикла |
    +-------------------------+
          |
          V
    +-------------------------+
    |  Ожидание 1 секунду      |
    +-------------------------+
          |
          V
    +-------------------------+
    |  Получение userToken     |
    +-------------------------+
          |
          V
    +-------------------------+
    |  Извлечение значения     |
    +-------------------------+
          |
          V
    +-------------------------+
    |  Сохранение токена       |
    +-------------------------+
```

**Примеры**:
```python
# Пример использования callback
async def example():
    page = None # <инструкция для модели gemini:Предположим, что `page` это объект `Page`, полученный из `browser` nodriver.>
    await callback(page)
    print(DeepSeekAPI._access_token)