## ИНСТРУКЦИЯ:

Анализируй предоставленный код подробно и объясни его функциональность. Ответ должен включать три раздела:

1.  **<алгоритм>**: Опиши рабочий процесс в виде пошаговой блок-схемы, включая примеры для каждого логического блока, и проиллюстрируй поток данных между функциями, классами или методами.
2.  **<mermaid>**: Напиши код для диаграммы в формате `mermaid`, проанализируй и объясни все зависимости,
    которые импортируются при создании диаграммы.
    **ВАЖНО!** Убедитесь, что все имена переменных, используемые в диаграмме `mermaid`,
    имеют осмысленные и описательные имена. Имена переменных вроде `A`, `B`, `C`, и т.д., не допускаются!

    **Дополнительно**: Если в коде есть импорт `import header`, добавьте блок `mermaid` flowchart, объясняющий `header.py`:\
    ```mermaid
    flowchart TD
        Start --> Header[<code>header.py</code><br> Determine Project Root]

        Header --> import[Import Global Settings: <br><code>from src import gs</code>]
    ```

3.  **<объяснение>**: Предоставьте подробные объяснения:
    *   **Импорты**: Их назначение и взаимосвязь с другими пакетами `src.`.
    *   **Классы**: Их роль, атрибуты, методы и взаимодействие с другими компонентами проекта.
    *   **Функции**: Их аргументы, возвращаемые значения, назначение и примеры.
    *   **Переменные**: Их типы и использование.
    *   Выделите потенциальные ошибки или области для улучшения.

Дополнительно, постройте цепочку взаимосвязей с другими частями проекта (если применимо).

Это обеспечивает всесторонний и структурированный анализ кода.
## Формат ответа: `.md` (markdown)
**КОНЕЦ ИНСТРУКЦИИ**

## Алгоритм

1. **Инициализация переменных и DOM-элементов:**
   *   Объявляются переменные для хранения настроек атрибутов (например, `elementAttr`, `contextAttr`) и стилей (например, `style`, `popupBodyWidth`, `popupBodyHeight`).
   *   Получаются DOM-элементы из HTML-страницы по их ID (например, `element-attribute`, `style`).
   *   Создается элемент `div` для тестирования атрибутов.

2. **Функция `isValidAttrName(name)`:**
   *   Принимает имя атрибута (`name`) в качестве аргумента.
   *   Пытается установить атрибут с заданным именем на тестовом элементе `testElement` со значением `"testValue"`.
   *   Если установка атрибута проходит успешно, возвращает `true`. В противном случае (при возникновении ошибки) возвращает `false`.
   *   _Пример:_ `isValidAttrName("data-test-attr")` вернет `true`, если атрибут допустим. `isValidAttrName("invalid-attr$")` вернет `false`.

3. **Функция `isValidAttrNames(names)`:**
   *   Принимает объект `names`, где ключи - это имена атрибутов, а значения - сами имена атрибутов.
   *   Проходит в цикле по всем именам атрибутов в объекте `names` и вызывает функцию `isValidAttrName` для каждого.
   *   Если хотя бы одно имя атрибута не является допустимым (т.е. `isValidAttrName` возвращает `false`), функция возвращает `false`.
   *   Если все имена атрибутов являются допустимыми, функция возвращает `true`.
   *   _Пример:_ `isValidAttrNames({ element: "data-element", context: "data-context" })` вернет `true`, если оба атрибута допустимы. `isValidAttrNames({ element: "data-element", context: "invalid-attr$" })` вернет `false`.

4. **Функция `isValidStyleLength(len)`:**
   *   Принимает строку `len` (длина стиля).
   *   Проверяет, соответствует ли строка формату "auto" или "<число>px", используя регулярное выражение `/^auto$|^[1-9]\d*px$/`.
   *   Возвращает `true`, если строка соответствует формату, и `false` в противном случае.
   *   _Пример:_ `isValidStyleLength("auto")` вернет `true`. `isValidStyleLength("100px")` вернет `true`. `isValidStyleLength("100")` вернет `false`. `isValidStyleLength("100pxx")` вернет `false`.

5. **Функция `loadDefaultCss()`:**
   *   Создает `Promise`.
   *   Использует `XMLHttpRequest` для асинхронного получения содержимого файла `try_xpath_insert.css` из расширения браузера.
   *   При успешном получении содержимого CSS вызывает `resolve` с текстом CSS.
   *   _Пример:_ Возвращает `Promise`, который разрешается с CSS-текстом.

6. **Функция `extractBodyStyles(css)`:**
   *   Принимает строку `css` (CSS-текст).
   *   Использует регулярное выражение `/width:(.+?);.*height:(.+?);/` для извлечения значений `width` и `height` из CSS.
   *   Возвращает объект `styles` с ключами `width` и `height`. Если значения не найдены, то возвращает пустые строки.
   *   _Пример:_ `extractBodyStyles("body{width:367px;height:auto;}")` вернет `{ width: "367px", height: "auto" }`. `extractBodyStyles("body{color:red;}")` вернет `{ width: "", height: "" }`.

7. **Функция `createPopupCss(bodyStyles)`:**
    *   Принимает объект `bodyStyles` (свойства `width` и `height`).
    *   Формирует CSS-правило для элемента `body`, устанавливая его размеры на основе значений `bodyStyles`.
    *   _Пример:_ `createPopupCss({ width: "367px", height: "auto" })` вернет `body{width:367px;height:auto;}`

8. **Событие `window.addEventListener("load", ...)`:**
    *   Выполняется после полной загрузки страницы.
    *   Получает DOM-элементы ввода (атрибуты и стили).
    *   Отправляет сообщение `browser.runtime.sendMessage` для получения сохраненных значений атрибутов и стилей.
    *   После получения данных, заполняет поля ввода значениями.
    *   Устанавливает обработчик события `click` на кнопку `save`:
        *   Собирает значения атрибутов из полей ввода.
        *   Проверяет допустимость имен атрибутов с помощью `isValidAttrNames`.
        *   Проверяет допустимость размеров стилей с помощью `isValidStyleLength`.
        *   Если данные не валидны, отображает сообщение об ошибке.
        *   Сохраняет значения атрибутов, стилей и сгенерированного CSS в `browser.storage.sync`.
        *   Отображает сообщение об успехе или ошибке.
    *   Устанавливает обработчик события `click` на кнопку `show-default`:
        *   Устанавливает значения атрибутов в значения по умолчанию.
        *   Загружает CSS по умолчанию с помощью `loadDefaultCss`.
        *   Устанавливает размеры popup body в значения по умолчанию.

## Mermaid

```mermaid
flowchart TD
    subgraph Options Page
        A[Load Page] --> B{Get DOM Elements};
        B --> C{Send Message "loadOptions"};
        C --> D[Receive Stored Settings];
        D --> E{Set Input Values};

        E --> F{Click Save Button};
        F --> G[Get Input Values];
        G --> H{Validate Attributes};
        H -- Invalid Attributes --> I[Show Error Message];
        H -- Valid Attributes --> J{Validate Styles};
        J -- Invalid Styles --> K[Show Error Message];
        J -- Valid Styles --> L[Create Popup CSS];
        L --> M{Save Settings to Storage};
        M --> N{Show Success Message};
        
        E --> O{Click Show Default Button};
        O --> P[Set Default Attribute Values];
        P --> Q{Load Default CSS};
        Q --> R[Set Default Popup Styles];
    end
    
    subgraph Helper Functions
    S[isValidAttrName(name)]
    T[isValidAttrNames(names)]
    U[isValidStyleLength(len)]
    V[loadDefaultCss()]
    W[extractBodyStyles(css)]
    X[createPopupCss(bodyStyles)]
    end

   H --> S
   T --> S
   J --> U
   Q --> V
   D --> W
   L --> X
```
### Объяснение зависимостей в mermaid:
*   **Options Page**:  Основной поток выполнения, который происходит на странице настроек. Состоит из этапов загрузки страницы, получения элементов DOM, запроса сохраненных настроек, установки значений полей ввода и обработки нажатий на кнопки "Save" и "Show Default".
*   **Helper Functions**: Группа вспомогательных функций, которые используются внутри основного потока для выполнения валидации, загрузки данных и трансформации CSS.

    *   `isValidAttrName(name)`: Проверяет допустимость имени атрибута.
    *   `isValidAttrNames(names)`: Проверяет допустимость всех имен атрибутов в объекте.
    *   `isValidStyleLength(len)`: Проверяет, является ли строка допустимой длиной стиля CSS.
    *   `loadDefaultCss()`: Загружает CSS по умолчанию из файла расширения.
    *   `extractBodyStyles(css)`: Извлекает значения ширины и высоты из CSS-текста.
    *   `createPopupCss(bodyStyles)`: Создает CSS для тела попапа на основе предоставленных стилей.

## Объяснение

### Импорты
В данном коде не используется никаких импортов в привычном понимании (например, `import ... from ...`). Вместо этого используются глобальные объекты и переменные, определенные в контексте расширения браузера.
* `tryxpath` и `tryxpath.functions` (сокращенно `tx` и `fu`) - предположительно это глобальные переменные, предоставляемые средой расширения,  содержащие логику работы расширения, и функции для работы с xpath, отлова ошибок.
* `window` -  глобальный объект, представляющий окно браузера.

### Функции
*   `isValidAttrName(name)`:
    *   **Аргументы:** `name` (string) - имя атрибута.
    *   **Возвращаемое значение:** `boolean` - `true`, если атрибут допустим, `false` в противном случае.
    *   **Назначение:** Проверяет, является ли заданное имя допустимым именем атрибута.
    *   **Пример:** `isValidAttrName("data-my-attr")` вернет `true`, если атрибут допустим, `isValidAttrName("invalid-@attr")` вернет `false`.
*   `isValidAttrNames(names)`:
    *   **Аргументы:** `names` (object) - объект, содержащий имена атрибутов в качестве значений.
    *   **Возвращаемое значение:** `boolean` - `true`, если все атрибуты допустимы, `false` в противном случае.
    *   **Назначение:** Проверяет, являются ли все имена атрибутов в заданном объекте допустимыми.
    *   **Пример:** `isValidAttrNames({ element: "data-element", context: "data-context" })` вернет `true`, `isValidAttrNames({ element: "data-element", context: "invalid-@context" })` вернет `false`.
*   `isValidStyleLength(len)`:
    *   **Аргументы:** `len` (string) - строка, представляющая длину стиля.
    *   **Возвращаемое значение:** `boolean` - `true`, если строка соответствует допустимому формату длины стиля, `false` в противном случае.
    *   **Назначение:** Проверяет, соответствует ли строка формату "auto" или "<число>px".
    *   **Пример:** `isValidStyleLength("auto")` вернет `true`, `isValidStyleLength("100px")` вернет `true`, `isValidStyleLength("100")` вернет `false`.
*   `loadDefaultCss()`:
    *   **Аргументы:** нет.
    *   **Возвращаемое значение:** `Promise`, который разрешается со строкой, содержащей содержимое CSS.
    *   **Назначение:** Асинхронно загружает содержимое CSS из файла `try_xpath_insert.css`.
    *   **Пример:** `loadDefaultCss().then(css => console.log(css))` выведет в консоль содержимое CSS.
*   `extractBodyStyles(css)`:
    *   **Аргументы:** `css` (string) - строка, содержащая CSS.
    *   **Возвращаемое значение:** `object` - объект с ключами `width` и `height`, содержащий значения, извлеченные из CSS. Если значения не найдены, то пустые строки.
    *   **Назначение:** Извлекает значения `width` и `height` из строки CSS.
    *   **Пример:** `extractBodyStyles("body{width:367px;height:auto;}")` вернет `{ width: "367px", height: "auto" }`, `extractBodyStyles("body{color:red;}")` вернет `{ width: "", height: "" }`.
*   `createPopupCss(bodyStyles)`:
    *   **Аргументы:** `bodyStyles` (object) - объект с ключами `width` и `height`.
    *   **Возвращаемое значение:** `string` - строка, содержащая CSS-правило для элемента `body`.
    *   **Назначение:** Формирует CSS-правило для элемента `body`, устанавливая его размеры на основе значений `bodyStyles`.
    *   **Пример:** `createPopupCss({ width: "367px", height: "auto" })` вернет `body{width:367px;height:auto;}`.

### Переменные
*   `defaultAttributes`: `const object` - Объект, содержащий имена атрибутов по умолчанию, используемые для элементов.
*   `defaultPopupBodyStyles`: `const object` - Объект, содержащий стили по умолчанию для тела попапа.
*   `elementAttr`, `contextAttr`, `focusedAttr`, `ancestorAttr`, `frameAttr`, `frameAncestorAttr`: `HTMLInputElement` - DOM-элементы, которые представляют текстовые поля ввода для соответствующих атрибутов.
*   `style`: `HTMLInputElement` - DOM-элемент, который представляет текстовое поле ввода для CSS.
*   `popupBodyWidth`, `popupBodyHeight`: `HTMLInputElement` - DOM-элементы, которые представляют текстовые поля ввода для ширины и высоты попапа.
*   `message`: `HTMLDivElement` - DOM-элемент, который используется для отображения сообщений пользователю.
*   `testElement`: `HTMLDivElement` - Временный DOM-элемент для проверки валидности атрибутов.
* `tx` - сокращение от `tryxpath` - объект, содержащий логику работы расширения.
* `fu` - сокращение от `tryxpath.functions` - объект, содержащий утилиты.

### Потенциальные ошибки и улучшения
*   **Отсутствие обработки ошибок при загрузке CSS:** В функции `loadDefaultCss` не обрабатываются ошибки, которые могут возникнуть при выполнении запроса XMLHttpRequest. Нужно добавить `req.onerror = reject` для корректной обработки ошибок загрузки.
*   **Дублирование кода:**  Код для установки значений полей ввода при загрузке и при нажатии кнопки "show-default" дублируется. Можно создать функцию для установки значений полей ввода.
*   **Недостаточная валидация стилей:** Функция `isValidStyleLength` проверяет только формат длины, но не проверяет другие потенциально некорректные стили CSS.
*   **Отсутствие комментариев:** Код не содержит комментариев, которые могли бы помочь понять его назначение и логику работы.

### Взаимосвязь с другими частями проекта
*   **`browser.runtime.sendMessage`:** Используется для отправки сообщений другим частям расширения, в частности, для получения сохраненных настроек.
*   **`browser.storage.sync.set`:** Используется для сохранения настроек в хранилище браузера, что позволяет синхронизировать их между различными экземплярами браузера.
*   **`tryxpath`:** Предполагается, что это основной модуль расширения, который отвечает за основную логику, связанную с xpath и манипулированием DOM.

В целом, данный код отвечает за настройку атрибутов и стилей расширения. Он обеспечивает возможность изменять значения атрибутов и стилей через UI и сохранять эти настройки для последующего использования.