# Модуль для взаимодействия с ChatGptEs

## Обзор

Модуль `ChatGptEs` предоставляет асинхронный генератор для взаимодействия с API ChatGPT.es. Он использует библиотеку `curl_cffi` для обхода Cloudflare и поддерживает стриминг ответов. Модуль предназначен для генерации текста на основе предоставленных сообщений с использованием различных моделей, таких как `gpt-4`, `gpt-4o` и `gpt-4o-mini`.

## Подробнее

Модуль предназначен для интеграции с другими частями проекта, требующими генерации текста с использованием ChatGPT.es. Он обеспечивает обход защиты Cloudflare и поддерживает различные модели.

## Классы

### `ChatGptEs`

**Описание**: Класс `ChatGptEs` предоставляет функциональность для взаимодействия с API ChatGPT.es.

**Наследует**:

- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями.

**Атрибуты**:

- `url` (str): URL ChatGPT.es.
- `api_endpoint` (str): URL API для отправки сообщений.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер стриминг.
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`gpt-4o`).
- `models` (List[str]): Список поддерживаемых моделей (`gpt-4`, `gpt-4o`, `gpt-4o-mini`).
- `SYSTEM_PROMPT` (str): Системное сообщение, используемое для настройки поведения модели.

**Методы**:

- `create_async_generator()`: Создает асинхронный генератор для получения ответов от API.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от API ChatGPT.es.

    Args:
        model (str): Название используемой модели.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий ответы от API.

    Raises:
        MissingRequirementsError: Если не установлен пакет `curl_cffi`.
        ValueError: Если статус код ответа не 200 или если ответ имеет неожиданный формат.

    Внутренние функции:
        Отсутствуют.
    """
```

**Назначение**: Создает асинхронный генератор для взаимодействия с API ChatGPT.es.

**Параметры**:

- `model` (str): Название используемой модели.
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:

- `AsyncResult`: Асинхронный генератор, возвращающий ответы от API.

**Вызывает исключения**:

- `MissingRequirementsError`: Если не установлен пакет `curl_cffi`.
- `ValueError`: Если статус код ответа не 200 или если ответ имеет неожиданный формат.

**Как работает функция**:

1. **Проверка зависимостей**:
   - Проверяет, установлен ли пакет `curl_cffi`. Если нет, вызывает исключение `MissingRequirementsError`.
2. **Подготовка запроса**:
   - Получает название модели.
   - Форматирует промпт, объединяя системное сообщение и предоставленные сообщения.
3. **Создание сессии**:
   - Создает сессию `curl_cffi` для автоматического обхода Cloudflare.
   - Устанавливает заголовки запроса, такие как `user-agent`, `referer`, `origin` и `content-type`.
   - Если предоставлен прокси, устанавливает его в сессии.
4. **Получение `nonce` и `post_id`**:
   - Отправляет начальный запрос на URL ChatGPT.es для получения `nonce` и `post_id`.
   - Использует регулярные выражения для извлечения `nonce` из ответа.
   - Если `nonce` не найден, пытается найти альтернативные шаблоны или использует значение по умолчанию.
   - Аналогично извлекает `post_id` из ответа или использует значение по умолчанию.
5. **Подготовка данных**:
   - Генерирует случайный `client_id`.
   - Подготавливает данные для POST-запроса, включая `nonce`, `post_id`, URL, действие, сообщение, `bot_id`, `chatbot_identity`, `wpaicg_chat_client_id` и историю чата.
6. **Отправка POST-запроса**:
   - Отправляет POST-запрос на API endpoint с подготовленными данными.
7. **Обработка ответа**:
   - Проверяет статус код ответа. Если он не 200, вызывает исключение `ValueError`.
   - Извлекает данные из JSON-ответа.
   - Проверяет наличие ошибки в данных и вызывает исключение `ValueError`, если она обнаружена.
   - Возвращает данные в виде асинхронного генератора.

**ASCII Flowchart**:

```
    Проверка curl_cffi
    ↓
    Форматирование промпта
    ↓
    Создание сессии curl_cffi
    ↓
    Получение nonce и post_id
    ↓
    Подготовка данных POST-запроса
    ↓
    Отправка POST-запроса
    ↓
    Обработка ответа
    ↓
    Выдача результата (генератор)
```

**Примеры**:

```python
# Пример использования с минимальными параметрами
async for message in ChatGptEs.create_async_generator(model='gpt-4o', messages=[{'role': 'user', 'content': 'Hello'}]):
    print(message)

# Пример использования с прокси
async for message in ChatGptEs.create_async_generator(model='gpt-4', messages=[{'role': 'user', 'content': 'Как дела?'}], proxy='http://proxy.example.com'):
    print(message)