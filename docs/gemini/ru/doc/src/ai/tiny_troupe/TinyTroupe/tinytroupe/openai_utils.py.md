# tinytroupe/openai_utils.py

## Обзор

Модуль `openai_utils.py` предоставляет утилиты для взаимодействия с API OpenAI и Azure OpenAI Service, включая поддержку кэширования запросов, управления конфигурацией и обработки ошибок. Он содержит классы для отправки сообщений, получения эмбеддингов, а также регистрации и управления различными типами API-клиентов.

## Содержание

- [Конфигурация по умолчанию](#конфигурация-по-умолчанию)
- [Классы](#классы)
    - [LLMCall](#llmcall)
    - [OpenAIClient](#openaiclient)
    - [AzureClient](#azureclient)
- [Исключения](#исключения)
    - [InvalidRequestError](#invalidrequesterror)
    - [NonTerminalError](#nonterminalerror)
- [Реестр клиентов](#реестр-клиентов)
- [Вспомогательные функции](#вспомогательные-функции)
    - [register_client](#register_client)
    - [_get_client_for_api_type](#_get_client_for_api_type)
    - [client](#client)
    - [force_api_type](#force_api_type)
    - [force_api_cache](#force_api_cache)
    - [force_default_value](#force_default_value)

## Конфигурация по умолчанию

В этом разделе определены значения параметров по умолчанию, используемых для взаимодействия с API OpenAI. Эти значения считываются из файла конфигурации (`config.ini`) и могут быть переопределены.

- `model`:  Используемая модель OpenAI (по умолчанию `gpt-4`).
- `max_tokens`:  Максимальное количество токенов в ответе (по умолчанию `1024`).
- `temperature`:  Температура для контроля случайности ответов (по умолчанию `0.3`).
- `top_p`:  Параметр `top_p` для контроля разнообразия ответов (по умолчанию `0`).
- `frequency_penalty`:  Штраф за частоту повторений (по умолчанию `0.0`).
- `presence_penalty`: Штраф за наличие повторений (по умолчанию `0.0`).
- `timeout`:  Таймаут запроса к API (по умолчанию `30.0`).
- `max_attempts`: Максимальное количество попыток запроса к API (по умолчанию `0.0`).
- `waiting_time`: Время ожидания между попытками запроса к API (по умолчанию `0.5`).
- `exponential_backoff_factor`: Множитель экспоненциальной задержки (по умолчанию `5`).
- `embedding_model`:  Модель для создания эмбеддингов (по умолчанию `text-embedding-3-small`).
- `cache_api_calls`:  Флаг для включения/выключения кэширования API (по умолчанию `False`).
- `cache_file_name`: Имя файла для кэша API (по умолчанию `openai_api_cache.pickle`).

## Классы

### `LLMCall`

**Описание**: Класс, представляющий вызов языковой модели. Содержит входные сообщения, конфигурацию модели и выходные данные модели.

**Методы**:
- `__init__`: Инициализирует экземпляр `LLMCall` с заданными шаблонами системы и пользователя.

    **Параметры**:
    - `system_template_name` (str): Название шаблона системного сообщения.
    - `user_template_name` (str, optional): Название шаблона сообщения пользователя. По умолчанию `None`.
    - `**model_params`: Дополнительные параметры модели.
- `call`: Вызывает языковую модель с заданной конфигурацией рендеринга.
     
    **Параметры**:
    - `**rendering_configs`: Дополнительные параметры для рендеринга шаблонов сообщений.
    
    **Возвращает**:
        - `str | None`: Содержимое ответа модели или `None`, если ответ не содержит ключа 'content'.
    
- `__repr__`: Возвращает строковое представление объекта `LLMCall`.

### `OpenAIClient`

**Описание**: Утилитарный класс для взаимодействия с API OpenAI.

**Методы**:

- `__init__`: Инициализирует клиент OpenAI.

    **Параметры**:
    - `cache_api_calls` (bool, optional): Флаг для включения/выключения кэширования API. По умолчанию значение из конфигурации.
    - `cache_file_name` (str, optional): Имя файла для кэша API. По умолчанию значение из конфигурации.
- `set_api_cache`: Включает или выключает кэширование вызовов API.

    **Параметры**:
        - `cache_api_calls` (bool): Флаг для включения/выключения кэширования API.
        - `cache_file_name` (str, optional): Имя файла для кэша API. По умолчанию значение из конфигурации.
- `_setup_from_config`: Настраивает конфигурацию API OpenAI для этого клиента.
- `send_message`: Отправляет сообщение в API OpenAI и возвращает ответ.

    **Параметры**:
    - `current_messages` (list): Список словарей, представляющих историю разговора.
    - `model` (str, optional): ID модели для генерации ответа. По умолчанию значение из конфигурации.
    - `temperature` (float, optional): Температура для контроля случайности ответов. По умолчанию значение из конфигурации.
    - `max_tokens` (int, optional): Максимальное количество токенов в ответе. По умолчанию значение из конфигурации.
    - `top_p` (float, optional): Параметр top_p для контроля разнообразия ответов. По умолчанию значение из конфигурации.
    - `frequency_penalty` (float, optional): Штраф за частоту повторений. По умолчанию значение из конфигурации.
    - `presence_penalty` (float, optional): Штраф за наличие повторений. По умолчанию значение из конфигурации.
     - `stop` (list, optional): Список строк, при появлении которых генерация останавливается. По умолчанию пустой список.
    - `timeout` (float, optional): Максимальное время ожидания ответа от API. По умолчанию значение из конфигурации.
    - `max_attempts` (int, optional): Максимальное количество попыток запроса к API. По умолчанию значение из конфигурации.
    - `waiting_time` (float, optional): Время ожидания между попытками запроса к API. По умолчанию значение из конфигурации.
    - `exponential_backoff_factor` (float, optional): Множитель экспоненциальной задержки. По умолчанию значение из конфигурации.
    - `n` (int, optional): Количество ответов, которые нужно сгенерировать. По умолчанию `1`.
     - `echo` (bool, optional): Флаг для включения/выключения возврата входного сообщения в ответе. По умолчанию `False`.

    **Возвращает**:
    - `dict | None`: Словарь, представляющий сгенерированный ответ, или `None` в случае ошибки.

    **Вызывает исключения**:
    - `InvalidRequestError`: Если запрос к API недействителен.
    - `openai.BadRequestError`: Если запрос к API недействителен.
    - `openai.RateLimitError`: Если достигнут лимит запросов к API.
    - `NonTerminalError`: Если произошла нетерминальная ошибка.
- `_raw_model_call`: Выполняет непосредственный вызов API OpenAI.

    **Параметры**:
    - `model` (str): ID модели для вызова API.
    - `chat_api_params` (dict): Параметры для API.
    
    **Возвращает**:
         - response: Ответ от API.
- `_raw_model_response_extractor`: Извлекает ответ из ответа API.

     **Параметры**:
    - `response` (dict): Ответ от API.

    **Возвращает**:
    - `dict`: Извлеченный ответ.
- `_count_tokens`: Подсчитывает количество токенов OpenAI в списке сообщений.

    **Параметры**:
    - `messages` (list): Список словарей, представляющих историю разговора.
    - `model` (str): Название модели для кодирования строки.

    **Возвращает**:
     -  `int | None`: Количество токенов или `None` в случае ошибки.
    
    **Вызывает исключения**:
        - `NotImplementedError`: Если подсчет токенов не реализован для указанной модели.
- `_save_cache`: Сохраняет кэш API на диск.
- `_load_cache`: Загружает кэш API с диска.
- `get_embedding`: Получает эмбеддинг заданного текста, используя указанную модель.

    **Параметры**:
        - `text` (str): Текст для получения эмбеддинга.
        - `model` (str, optional): Название модели для получения эмбеддинга. По умолчанию значение из конфигурации.
    
    **Возвращает**:
        -  `list`: Эмбеддинг текста.
- `_raw_embedding_model_call`: Выполняет непосредственный вызов API OpenAI для получения эмбеддинга.

     **Параметры**:
    - `text` (str): Текст для получения эмбеддинга.
    - `model` (str):  Название модели для получения эмбеддинга.
    
    **Возвращает**:
         - response: Ответ от API.
- `_raw_embedding_model_response_extractor`: Извлекает эмбеддинг из ответа API.

     **Параметры**:
    - `response` (dict): Ответ от API.
    
    **Возвращает**:
         - `list`: Эмбеддинг текста.

### `AzureClient`

**Описание**: Класс для взаимодействия с Azure OpenAI Service API, наследуется от `OpenAIClient`.

**Методы**:

-   `__init__`: Инициализирует клиент Azure.

    **Параметры**:
    - `cache_api_calls` (bool, optional): Флаг для включения/выключения кэширования API. По умолчанию значение из конфигурации.
    - `cache_file_name` (str, optional): Имя файла для кэша API. По умолчанию значение из конфигурации.

-   `_setup_from_config`: Настраивает конфигурацию Azure OpenAI Service API для этого клиента.
- `_raw_model_call`: Выполняет непосредственный вызов API Azure OpenAI Service.
    
    **Параметры**:
    - `model` (str): ID модели для вызова API.
    - `chat_api_params` (dict): Параметры для API.
    
    **Возвращает**:
         - response: Ответ от API.

## Исключения

### `InvalidRequestError`

**Описание**: Исключение, возникающее, когда запрос к API OpenAI недействителен.

### `NonTerminalError`

**Описание**: Исключение, возникающее при возникновении неопределенной ошибки, при которой можно повторить запрос.

## Реестр клиентов

В этом разделе реализована логика регистрации и управления различными типами API-клиентов. По умолчанию поддерживаются OpenAI и Azure OpenAI Service API.

## Вспомогательные функции

### `register_client`

**Описание**: Регистрирует клиент для заданного типа API.

**Параметры**:
- `api_type` (str): Тип API, для которого регистрируется клиент.
- `client`: Клиент, который нужно зарегистрировать.

### `_get_client_for_api_type`

**Описание**: Возвращает клиент для заданного типа API.

**Параметры**:
- `api_type` (str): Тип API, для которого нужно получить клиент.

**Возвращает**:
- Клиент для заданного типа API.

**Вызывает исключения**:
- `ValueError`: Если указанный тип API не поддерживается.

### `client`

**Описание**: Возвращает клиент для настроенного типа API.

**Возвращает**:
- Клиент для настроенного типа API.

### `force_api_type`

**Описание**: Принудительно устанавливает использование заданного типа API, переопределяя любую другую конфигурацию.

**Параметры**:
- `api_type` (str): Тип API, который нужно использовать.

### `force_api_cache`

**Описание**: Принудительно устанавливает конфигурацию кэша API, переопределяя любую другую конфигурацию.

**Параметры**:
- `cache_api_calls` (bool): Флаг для включения/выключения кэширования API.
- `cache_file_name` (str, optional): Имя файла для кэша API. По умолчанию значение из конфигурации.

### `force_default_value`

**Описание**: Принудительно устанавливает значение по умолчанию для указанного ключа конфигурации.

**Параметры**:
- `key` (str): Ключ, который нужно переопределить.
- `value`: Значение, которое нужно использовать для ключа.

**Вызывает исключения**:
- `ValueError`: Если указанный ключ не является допустимым ключом конфигурации.