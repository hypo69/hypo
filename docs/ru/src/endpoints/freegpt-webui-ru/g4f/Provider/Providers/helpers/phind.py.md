# Модуль для взаимодействия с Phind API

## Обзор

Модуль предназначен для отправки запросов к API Phind с целью получения ответов на заданные вопросы. Он использует библиотеку `curl_cffi` для выполнения HTTP-запросов и обрабатывает полученные данные для вывода пользователю.

## Подробнее

Модуль формирует JSON-запрос с вопросом пользователя и различными опциями (например, уровень экспертизы, дата, язык). Затем он отправляет этот запрос к API Phind и обрабатывает поступающие чанки данных, выводя их в консоль. В случае возникновения ошибки, модуль пытается повторить запрос.

## Функции

### `output`

```python
def output(chunk):
    """Обрабатывает и выводит чанки данных, полученные от API Phind.

    Args:
        chunk (bytes): Часть данных, полученная от API.

    Returns:
        None

    Raises:
        json.decoder.JSONDecodeError: Если возникает ошибка при декодировании JSON.

    Как работает функция:
    1. **Проверка на метаданные**: Проверяет, содержит ли чанк метаданные `PHIND_METADATA`. Если да, функция завершается.
    2. **Обработка пустых чанков**: Заменяет определенные последовательности пустых данных на более короткие эквиваленты.
    3. **Декодирование**: Декодирует чанк из байтов в строку.
    4. **Замена данных**: Удаляет префикс `data: ` и заменяет последовательности символов новой строки.
    5. **Вывод чанка**: Выводит обработанный чанк в консоль.

    Внутри функции происходят следующие действия и преобразования:
    A: Проверка на наличие метаданных в чанке.
    |
    B: Обработка пустых чанков.
    |
    C: Декодирование чанка из байтов в строку.
    |
    D: Замена префиксов и последовательностей символов новой строки.
    |
    E: Вывод обработанного чанка в консоль.

    Примеры:
    >>> output(b'data: {"answer": "Example answer"}')
    {"answer": "Example answer"}
    """
    try:
        if b'PHIND_METADATA' in chunk:
            return
        
        if chunk == b'data:  \\r\\ndata: \\r\\ndata: \\r\\n\\r\\n':
            chunk = b'data:  \\n\\r\\n\\r\\n'

        chunk = chunk.decode()

        chunk = chunk.replace('data: \\r\\n\\r\\ndata: ', 'data: \\n')
        chunk = chunk.replace('\\r\\ndata: \\r\\ndata: \\r\\n\\r\\n', '\\n\\r\\n\\r\\n')
        chunk = chunk.replace('data: ', '').replace('\\r\\n\\r\\n', '')

        print(chunk, flush=True, end = '')
        
    except json.decoder.JSONDecodeError:
        pass
```

## Основной цикл

Основной цикл модуля выполняет следующие действия:

1. **Отправка запроса**: Отправляет POST-запрос к API Phind с использованием библиотеки `curl_cffi`.
2. **Обработка ответа**: Функция `output` используется в качестве `content_callback` для обработки поступающих чанков данных.
3. **Выход при успехе**: В случае успешного получения и обработки ответа, программа завершается с кодом 0.
4. **Обработка ошибок**: Если во время запроса возникает исключение, выводится сообщение об ошибке, и цикл повторяется.

```python
while True:
    try:
        response = requests.post('https://www.phind.com/api/infer/answer',
                         headers=headers, data=json_data, content_callback=output, timeout=999999, impersonate='safari15_5')
        
        exit(0)
    
    except Exception as e:
        print('an error occured, retrying... |', e, flush=True)
        continue