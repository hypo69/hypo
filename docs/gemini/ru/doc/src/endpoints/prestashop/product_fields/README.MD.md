# Модуль ProductFields

## Обзор

Класс `ProductFields` предназначен для управления и структурирования данных о продукте в формате, требуемом API PrestaShop. Этот класс предоставляет полный интерфейс для обработки полей продукта, включая поля для одного и нескольких языков. Он гарантирует, что данные правильно отформатированы и проверены перед отправкой в API PrestaShop.

## Содержание

1. [Введение](#введение)
2. [Инициализация класса](#инициализация-класса)
3. [Поля продукта](#поля-продукта)
   - [Одноязычные поля](#одноязычные-поля)
   - [Многоязычные поля](#многоязычные-поля)
4. [Ассоциации](#ассоциации)
5. [Значения по умолчанию](#значения-по-умолчанию)
6. [Обработка ошибок](#обработка-ошибок)
7. [Примеры использования](#примеры-использования)
8. [Заключение](#заключение)

## Введение

Класс `ProductFields` — это класс Python, который инкапсулирует структуру и поведение полей продукта в базе данных PrestaShop. Он разработан, чтобы упростить процесс создания, обновления и управления данными о продукте, предоставляя понятный и последовательный интерфейс для взаимодействия с полями продукта.

Класс особенно полезен для разработчиков, работающих с API PrestaShop, поскольку он гарантирует, что все необходимые поля правильно отформатированы и проверены перед отправкой в API.

## Инициализация класса

### `__init__`

```python
def __init__(self):
    """Инициализирует класс ProductFields.

    Args:
        self (ProductFields): Экземпляр класса ProductFields.

    Как работает функция:
    - Загружает список полей продукта, используя метод `_load_product_fields_list`.
    - Инициализирует словарь `language`, содержащий соответствия между кодами языков ('en', 'he', 'ru') и их идентификаторами.
    - Создает объект `SimpleNamespace` с именем `presta_fields` для хранения полей продукта, инициализируя их значения как `None`.
    - Инициализирует словарь `assist_fields_dict` для хранения дополнительных полей, таких как URL-адрес изображения по умолчанию и список URL-адресов изображений.
    - Вызывает метод `_payload` для загрузки значений по умолчанию для полей продукта.

    Внутри функции происходят следующие действия и преобразования:
    A. Загрузка списка полей продукта из файла.
    |
    B. Инициализация словаря языков.
    |
    C. Создание объекта SimpleNamespace для хранения полей продукта.
    |
    D. Инициализация словаря для дополнительных полей.
    |
    E. Загрузка значений по умолчанию для полей продукта.
    """
    self.product_fields_list = self._load_product_fields_list()
    self.language = {'en': 1, 'he': 2, 'ru': 3}
    self.presta_fields = SimpleNamespace(**{key: None for key in self.product_fields_list})
    self.assist_fields_dict = {
        'default_image_url': '',
        'images_urls': []
    }
    self._payload()
```

### `_load_product_fields_list`

```python
def _load_product_fields_list(self) -> List[str]:
    """Загружает список полей продукта из текстового файла.

    Args:
        self (ProductFields): Экземпляр класса ProductFields.

    Returns:
        List[str]: Список полей продукта.

    Как работает функция:
    - Читает содержимое текстового файла, расположенного по пути `Path(gs.path.src, 'product', 'product_fields', 'fields_list.txt')`.
    - Использует функцию `read_text_file` для чтения файла.
    - Возвращает список строк, где каждая строка представляет собой поле продукта.

    Внутри функции происходят следующие действия и преобразования:
    A. Формирование пути к файлу со списком полей продукта.
    |
    B. Чтение содержимого файла.
    |
    C. Преобразование содержимого в список строк.
    |
    D. Возврат списка полей продукта.
    """
    return read_text_file(Path(gs.path.src, 'product', 'product_fields', 'fields_list.txt'), as_list=True)
```

### `_payload`

```python
def _payload(self) -> bool:
    """Загружает значения по умолчанию для полей продукта из JSON-файла.

    Args:
        self (ProductFields): Экземпляр класса ProductFields.

    Returns:
        bool: True, если значения успешно загружены, иначе False.

    Как работает функция:
    - Загружает данные из JSON-файла, расположенного по пути `Path(gs.path.src, 'product', 'product_fields', 'product_fields_default_values.json')`, используя функцию `j_loads`.
    - Если загрузка данных не удалась (например, файл не найден или имеет неверный формат), записывает сообщение отладки в лог и возвращает `False`.
    - Если данные успешно загружены, перебирает элементы словаря `data` и устанавливает соответствующие атрибуты экземпляра класса.
    - Возвращает `True` после успешной загрузки и установки значений по умолчанию.

    Внутри функции происходят следующие действия и преобразования:
    A. Загрузка данных из JSON-файла.
    |
    B. Проверка успешности загрузки данных.
    |
    C. Перебор элементов в загруженных данных.
    |
    D. Установка значений атрибутов экземпляра класса.
    |
    E. Возврат результата операции.
    """
    data = j_loads(Path(gs.path.src, 'product', 'product_fields', 'product_fields_default_values.json'))
    if not data:
        logger.debug(f"Ошибка загрузки полей из файла {gs.path.src}/product/product_fields/product_fields_default_values.json")
        return False
    for name, value in data.items():
        setattr(self, name, value)
    return True
```

## Поля продукта

### Одноязычные поля

Одноязычные поля — это поля, которые не требуют перевода и хранятся на одном языке. Примеры включают `id_product`, `id_supplier`, `id_manufacturer` и т.д.

#### Пример: `id_product`

```python
@property
def id_product(self) -> Optional[int]:
    """Получает значение поля id_product.

    Returns:
        Optional[int]: Значение поля id_product или None, если оно не установлено.
    """
    return self.presta_fields.id_product

@id_product.setter
def id_product(self, value: int = None):
    """Устанавливает значение поля id_product.

    Args:
        value (int, optional): Значение для установки. По умолчанию None.

    Как работает функция:
    - Пытается установить значение атрибута `id_product` в объекте `presta_fields` равным переданному значению `value`.
    - Если возникает исключение `ProductFieldException`, записывает сообщение об ошибке в лог, указывая, какое поле вызвало ошибку и какие данные были переданы.

    Внутри функции происходят следующие действия и преобразования:
    A. Попытка установить значение поля id_product.
    |
    B. Обработка исключения в случае ошибки.
    |
    C. Запись сообщения об ошибке в лог.
    """
    try:
        self.presta_fields.id_product = value
    except ProductFieldException as ex:
        logger.error(f"""Ошибка заполнения поля: \'ID\' данными {value}\n        Ошибка: """, ex)
        return
```

### Многоязычные поля

Многоязычные поля — это поля, которые требуют перевода и хранятся на нескольких языках. Примеры включают `name`, `description`, `meta_title` и т.д.

#### Пример: `name`

```python
@property
def name(self):
    """Возвращает значение поля имени продукта.

    Returns:
        str: Значение имени продукта или пустая строка, если имя не задано.
    """
    return self.presta_fields.name or ''

@name.setter
def name(self, value: str, lang:str = 'en') -> bool:
    """Устанавливает значение поля имени продукта для указанного языка.

    Args:
        value (str): Значение имени продукта.
        lang (str, optional): Код языка. По умолчанию 'en'.

    Returns:
        bool: True, если значение успешно установлено, иначе False.

    Как работает функция:
    - Пытается установить значение атрибута `name` в объекте `presta_fields` в виде словаря, содержащего информацию о языке и значении.
    - Если возникает исключение `ProductFieldException`, записывает сообщение об ошибке в лог, указывая, какое поле вызвало ошибку и какие данные были переданы.

    Внутри функции происходят следующие действия и преобразования:
    A. Формирование структуры данных для многоязычного поля.
    |
    B. Попытка установить значение поля имени продукта.
    |
    C. Обработка исключения в случае ошибки.
    |
    D. Запись сообщения об ошибке в лог.
    """
    try:
        self.presta_fields.name: dict = {'language':
                                                    [
                                                        {'attrs':{'id':self.language[lang]}, 'value': value},
                                                    ]
                                                 }
        return True
    except ProductFieldException as ex:
        logger.error(f"""Ошибка заполнения поля: \'name\' данными {value}\n        Ошибка: """, ex)
        return
```

## Ассоциации

Ассоциации используются для связывания продуктов с другими сущностями, такими как категории, производители и поставщики. Свойство `associations` позволяет устанавливать и получать эти ассоциации.

#### Пример: `associations`

```python
@property
def associations(self) -> Optional[Dict]:
    """Возвращает словарь ассоциаций продукта.

    Returns:
        Optional[Dict]: Словарь ассоциаций продукта или None, если ассоциации не установлены.
    """
    return self.presta_fields.associations or None

@associations.setter
def associations(self, value: Dict[str, Optional[str]]):
    """Устанавливает ассоциации продукта.

    Args:
        value (Dict[str, Optional[str]]): Словарь ассоциаций продукта.

    Как работает функция:
    - Устанавливает значение атрибута `associations` в объекте `presta_fields` равным переданному значению `value`.

    Внутри функции происходят следующие действия и преобразования:
    A. Установка значения поля ассоциаций.
    """
    self.presta_fields.associations = value
```

## Значения по умолчанию

Значения по умолчанию для полей продукта можно загрузить из JSON-файла с помощью метода `_payload`. Этот метод гарантирует, что все поля имеют значение по умолчанию, которое можно переопределить при необходимости.

## Обработка ошибок

Класс включает надежную обработку ошибок для перехвата и регистрации любых исключений, которые происходят во время установки полей продукта. Это гарантирует, что любые проблемы регистрируются и могут быть решены разработчиком.

#### Пример: Обработка ошибок в `id_product`

```python
@id_product.setter
def id_product(self, value: int = None):
    """Устанавливает значение поля id_product.

    Args:
        value (int, optional): Значение для установки. По умолчанию None.

    Как работает функция:
    - Пытается установить значение атрибута `id_product` в объекте `presta_fields` равным переданному значению `value`.
    - Если возникает исключение `ProductFieldException`, записывает сообщение об ошибке в лог, указывая, какое поле вызвало ошибку и какие данные были переданы.

    Внутри функции происходят следующие действия и преобразования:
    A. Попытка установить значение поля id_product.
    |
    B. Обработка исключения в случае ошибки.
    |
    C. Запись сообщения об ошибке в лог.
    """
    try:
        self.presta_fields.id_product = value
    except ProductFieldException as ex:
        logger.error(f"""Ошибка заполнения поля: \'ID\' данными {value}\n        Ошибка: """, ex)
        return
```

## Примеры использования

### Пример 1: Установка одноязычного поля

```python
product = ProductFields()
product.id_product = 123
print(product.id_product)
```

### Пример 2: Установка многоязычного поля

```python
product = ProductFields()
product.name = "Product Name", lang='en'
print(product.name)
```

### Пример 3: Установка ассоциаций

```python
product = ProductFields()
product.associations = {'categories': [{'id': 2}, {'id': 3}]}
print(product.associations)
```

## Заключение

Класс `ProductFields` — мощный инструмент для управления данными о продукте в API PrestaShop. Он предоставляет понятный и последовательный интерфейс для обработки одноязычных и многоязычных полей, гарантируя, что данные правильно отформатированы и проверены перед отправкой в API. Благодаря надежной обработке ошибок и поддержке значений по умолчанию класс упрощает процесс работы с данными о продукте в PrestaShop.