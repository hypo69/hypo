# Модуль GetGpt для работы с провайдером g4f
## Обзор

Модуль `GetGpt.py` предназначен для взаимодействия с сервисом `chat.getgpt.world` через API. Он предоставляет функцию `_create_completion`, которая отправляет запросы к API и возвращает ответы в потоковом режиме. Модуль также содержит вспомогательные функции для шифрования данных.
## Подробней

Этот модуль используется для получения ответов от модели `gpt-3.5-turbo` через API `chat.getgpt.world`. Он включает функции шифрования для защиты передаваемых данных и поддерживает потоковую передачу ответов.

## Функции

### `_create_completion`

```python
def _create_completion(model: str, messages: list, stream: bool, **kwargs):
    """
    Создает запрос к API для получения ответа от модели GPT.

    Args:
        model (str): Идентификатор модели, например, 'gpt-3.5-turbo'.
        messages (list): Список сообщений для отправки в запросе.
        stream (bool): Флаг, указывающий, нужно ли использовать потоковый режим.
        **kwargs: Дополнительные параметры запроса, такие как temperature, top_p, max_tokens и т.д.

    Yields:
        str: Части ответа от API в потоковом режиме.

    Пример:
        >>> messages = [{"role": "user", "content": "Hello, how are you?"}]
        >>> for chunk in _create_completion(model='gpt-3.5-turbo', messages=messages, stream=True):
        ...     print(chunk, end='')
        I'm doing well, thank you for asking. How can I assist you today?
    """
```

**Как работает функция**:

1.  Функция `_create_completion` принимает параметры, необходимые для создания запроса к API `chat.getgpt.world`.
2.  Внутри функции определяются две внутренние функции: `encrypt` и `pad_data`.
3.  Функция `encrypt` шифрует данные запроса, используя алгоритм AES.
4.  Функция `pad_data` добавляет отступы к данным, чтобы они соответствовали размеру блока AES.
5.  Формируются заголовки запроса, включая `Content-Type`, `Referer` и `user-agent`.
6.  Данные запроса формируются в формате JSON, включающем сообщения, параметры модели и другие настройки.
7.  Данные шифруются с помощью функции `encrypt` и отправляются в запросе к API.
8.  Функция отправляет POST-запрос к `https://chat.getgpt.world/api/chat/stream` с заголовками и зашифрованными данными.
9.  Затем функция итерирует по строкам ответа, декодирует их и извлекает содержимое ответа модели, которое возвращается в потоковом режиме.

**Внутренние функции**:

#### `encrypt`

```python
def encrypt(e):
    """
    Шифрует входные данные с использованием алгоритма AES.

    Args:
        e (str): Данные для шифрования.

    Returns:
        str: Зашифрованные данные в шестнадцатеричном формате.

    Пример:
        >>> encrypted_data = encrypt('test data')
        >>> print(encrypted_data)
        '...'
    """
```

**Как работает функция**:

1.  Функция `encrypt` принимает строку `e` в качестве входных данных, которые необходимо зашифровать.
2.  Генерирует случайные шестнадцатеричные строки `t` и `n` длиной 8 символов каждая, которые будут использоваться как ключ и вектор инициализации (IV) для шифра AES.
3.  Кодирует входную строку `e` в байты, используя кодировку UTF-8.
4.  Инициализирует шифр AES в режиме CBC с использованием сгенерированного ключа `t` и вектора инициализации `n`.
5.  Вызывает функцию `pad_data` для добавления отступов к входным данным, чтобы их длина была кратна размеру блока AES.
6.  Шифрует данные с помощью шифра AES и преобразует результат в шестнадцатеричный формат.
7.  Возвращает зашифрованные данные, ключ и вектор инициализации в виде одной строки.

#### `pad_data`

```python
def pad_data(data: bytes) -> bytes:
    """
    Добавляет отступы к данным, чтобы их длина была кратна размеру блока AES.

    Args:
        data (bytes): Данные для добавления отступов.

    Returns:
        bytes: Данные с добавленными отступами.

    Пример:
        >>> padded_data = pad_data(b'test')
        >>> print(padded_data)
        b'test\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c\\x0c'
    """
```

**Как работает функция**:

1.  Функция `pad_data` принимает байтовую строку `data` в качестве входных данных, к которым необходимо добавить отступы.
2.  Определяет размер блока AES с помощью `AES.block_size`.
3.  Вычисляет размер необходимого отступа, чтобы длина данных была кратна размеру блока.
4.  Создает байтовую строку `padding`, содержащую символы отступа, где каждый символ равен размеру отступа.
5.  Добавляет отступ в конец входных данных и возвращает результат.

**Параметры**:

*   `model` (str): Идентификатор модели.
*   `messages` (list): Список сообщений для отправки.
*   `stream` (bool): Флаг потоковой передачи.
*   `**kwargs` (dict): Дополнительные параметры запроса.

**Возвращает**:

*   `Generator[str, None, None]`: Генератор строк с частями ответа от API.

**Примеры**:

```python
messages = [{"role": "user", "content": "Hello, how are you?"}]
for chunk in _create_completion(model='gpt-3.5-turbo', messages=messages, stream=True):
    print(chunk, end='')
# Вывод: I'm doing well, thank you for asking. How can I assist you today?
```

### `params`

```python
params = f'g4f.Providers.{os.path.basename(__file__)[:-3]} supports: ' + \
    '(%s)' % ', '.join(
        [f'{name}: {get_type_hints(_create_completion)[name].__name__}' for name in _create_completion.__code__.co_varnames[:_create_completion.__code__.co_argcount]])
```

**Описание**:
Эта строка кода формирует строку с информацией о поддержке параметров функцией `_create_completion`.
Она использует `os.path.basename(__file__)[:-3]` для получения имени текущего файла без расширения `.py`, чтобы указать, к какому провайдеру относится эта информация.
Затем она извлекает имена и типы параметров функции `_create_completion` с помощью `get_type_hints` и формирует строку, перечисляющую поддерживаемые параметры и их типы.

**Как работает**:

1.  `os.path.basename(__file__)[:-3]` извлекает имя файла (например, "GetGpt.py") и удаляет последние три символа (".py"), чтобы получить имя модуля ("GetGpt").
2.  `_create_completion.__code__.co_varnames[:_create_completion.__code__.co_argcount]` получает список имен параметров функции `_create_completion`.
3.  `get_type_hints(_create_completion)` возвращает словарь, содержащий типы параметров функции `_create_completion`.
4.  Генератор списка `[f'{name}: {get_type_hints(_create_completion)[name].__name__}' for name in _create_completion.__code__.co_varnames[:_create_completion.__code__.co_argcount]]` создает список строк, где каждая строка имеет формат "имя\_параметра: тип\_параметра".
5.  `', '.join(...)` объединяет элементы списка в одну строку, разделяя их запятыми и пробелами.
6.  Вся строка форматируется с использованием f-строки, чтобы создать строку с информацией о поддерживаемых параметрах.

**Примеры**:

```python
print(params)
# g4f.Providers.GetGpt supports: (model: str, messages: list, stream: bool, kwargs: dict)