# Модуль для взаимодействия с Phind API
=========================================

Модуль предназначен для отправки запросов к API Phind для получения ответов на вопросы. Он использует библиотеку `curl_cffi` для выполнения HTTP-запросов и обрабатывает полученные данные для вывода результатов.

## Обзор

Этот модуль отправляет запрос к API Phind, используя предоставленный prompt из конфигурации. Конфигурация включает в себя модель, сообщения и другие параметры. Результаты возвращаются в режиме реального времени. Модуль также обрабатывает ошибки и повторяет запросы при необходимости.

## Функции

### `output`

```python
def output(chunk):
    """
    Обрабатывает и выводит полученные чанки данных из ответа API Phind.

    Args:
        chunk (bytes): Часть данных, полученная от API.

    Returns:
        None

    Raises:
        json.decoder.JSONDecodeError: Если возникает ошибка при декодировании JSON.

    """
```

**Назначение**: Обрабатывает и выводит чанки данных, полученные от API Phind. Функция фильтрует метаданные, заменяет определенные последовательности символов и декодирует чанки, чтобы напечатать их в консоль.

**Параметры**:
- `chunk` (bytes): Часть данных, полученная от API в виде байтов.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `json.decoder.JSONDecodeError`: Возникает, если происходит ошибка при декодировании JSON.

**Как работает функция**:
1. **Проверка метаданных**: Функция проверяет, содержит ли чанк метаданные `b'PHIND_METADATA'`. Если да, функция завершается.
2. **Обработка специальных случаев**: Функция заменяет определенные последовательности символов, чтобы привести данные к нужному формату.
3. **Декодирование чанка**: Пытается декодировать чанк из байтов в строку.
4. **Замена подстрок**: Заменяет `'data: \\r\\n\\r\\ndata: '` на `'data: \\n'`, `'\\r\\ndata: \\r\\ndata: \\r\\n\\r\\n'` на `'\\n\\r\\n\\r\\n'`, и `'data: '` на `''`. Также удаляет `'\\r\\n\\r\\n'`.
5. **Вывод чанка**: Выводит обработанный чанк в консоль с `flush=True` и `end = ''`, чтобы обеспечить немедленный вывод и избежать добавления лишних символов новой строки.
6. **Обработка ошибок JSON**: В случае ошибки декодирования JSON функция просто пропускает этот чанк.

```
A: Проверка на PHIND_METADATA
|
B: Обработка специальных последовательностей символов
|
C: Декодирование chunk
|
D: Замена подстрок
|
E: Вывод chunk в консоль
|
F: Обработка JSONDecodeError (пропуск чанка)
```

**Примеры**:

```python
# Пример вызова функции output с тестовыми данными
test_chunk = b"data: {'test': 'value'}\\r\\n\\r\\n"
output(test_chunk)  # Выведет: {'test': 'value'}
```

## Основной цикл программы

Основной цикл программы отправляет запросы к API Phind до тех пор, пока не получит успешный ответ или не произойдет неустранимая ошибка.

```python
while True:
    try:
        response = requests.post('https://www.phind.com/api/infer/answer',
                         headers=headers, data=json_data, content_callback=output, timeout=999999, impersonate='safari15_5')
        
        exit(0)
    
    except Exception as e:
        print('an error occured, retrying... |', e, flush=True)
        continue
```

**Как работает цикл**:
1. **Отправка запроса**: Отправляет POST-запрос к API Phind с заголовками и данными JSON. Функция `output` используется в качестве `content_callback` для обработки данных в реальном времени.
2. **Выход при успехе**: Если запрос выполнен успешно, программа завершается с кодом 0.
3. **Обработка исключений**: Если возникает исключение, выводит сообщение об ошибке и повторяет запрос.

**Примеры**:
- Запуск скрипта приведет к отправке запроса к API Phind и выводу результатов в консоль. В случае ошибки будет предпринята повторная попытка.
```python
# Пример запуска скрипта
# python your_script_name.py '{"messages": [{"content": "What is the capital of France?"}], "model": "gpt-4"}'