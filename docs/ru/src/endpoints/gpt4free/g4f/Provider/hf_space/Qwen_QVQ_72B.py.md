# Модуль `Qwen_QVQ_72B`

## Обзор

Модуль `Qwen_QVQ_72B` предоставляет асинхронный интерфейс для взаимодействия с моделью Qwen QVQ-72B, размещенной на платформе Hugging Face Space. Он позволяет отправлять текстовые запросы и изображения для генерации ответов. Модуль поддерживает как текстовые, так и мультимодальные запросы (с изображениями).

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для обеспечения доступа к модели Qwen QVQ-72B через API Hugging Face Space. Он использует асинхронные запросы для эффективного взаимодействия с API и предоставляет методы для форматирования запросов и обработки ответов. Модуль также обрабатывает ошибки, возникающие при взаимодействии с API, и предоставляет информацию об ошибках в удобочитаемом формате.

## Классы

### `Qwen_QVQ_72B`

**Описание**: Класс `Qwen_QVQ_72B` реализует асинхронный интерфейс для взаимодействия с моделью Qwen QVQ-72B. Он наследует функциональность от классов `AsyncGeneratorProvider` и `ProviderModelMixin`.

**Принцип работы**:
1.  **Инициализация**: При создании экземпляра класса устанавливаются основные параметры, такие как URL, API endpoint и модель по умолчанию.
2.  **Формирование запроса**: Метод `create_async_generator` формирует запрос к API, включая необходимые заголовки и данные.
3.  **Отправка запроса**: Запрос отправляется на API endpoint с использованием асинхронной сессии.
4.  **Обработка ответа**: Ответ от API обрабатывается по частям (chunks) для генерации текста.
5.  **Генерация результата**: Результат возвращается в виде асинхронного генератора.

**Аттрибуты**:
*   `label` (str): Метка провайдера, `"Qwen QVQ-72B"`.
*   `url` (str): URL Hugging Face Space, `"https://qwen-qvq-72b-preview.hf.space"`.
*   `api_endpoint` (str): API endpoint для генерации, `"/gradio_api/call/generate"`.
*   `working` (bool): Индикатор работоспособности, `True`.
*   `default_model` (str): Модель по умолчанию, `"qwen-qvq-72b-preview"`.
*   `default_vision_model` (str): Модель для работы с изображениями по умолчанию, `"qwen-qvq-72b-preview"`.
*   `model_aliases` (dict): Алиасы моделей, `{"qvq-72b": default_vision_model}`.
*   `vision_models` (list): Список моделей для работы с изображениями, `list(model_aliases.keys())`.
*   `models` (list): Список моделей, `vision_models`.

**Методы**:

*   `create_async_generator`: Создает асинхронный генератор для получения ответов от модели.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls, model: str, messages: Messages,
        media: MediaListType = None,
        api_key: str = None, 
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для получения ответов от модели Qwen QVQ-72B.

        Args:
            model (str): Имя модели для использования.
            messages (Messages): Список сообщений для отправки в модель.
            media (MediaListType, optional): Список медиафайлов (например, изображений) для отправки в модель. По умолчанию `None`.
            api_key (str, optional): API ключ для аутентификации. По умолчанию `None`.
            proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncResult: Асинхронный генератор, который возвращает ответы от модели.

        Raises:
            ResponseError: Если при обработке ответа возникает ошибка, связанная с превышением лимита GPU token.
            RuntimeError: Если не удается прочитать ответ от API.

        Example:
            Пример вызова функции:

            ```python
            async def main():
                model = "qwen-qvq-72b-preview"
                messages = [{"role": "user", "content": "Hello, Qwen!"}]
                async for response in Qwen_QVQ_72B.create_async_generator(model, messages):
                    print(response, end="")
            ```
        """
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор для получения ответов от модели Qwen QVQ-72B. Она принимает список сообщений и медиафайлов (если есть) и отправляет их в API. Ответ от API обрабатывается по частям (chunks) и возвращается в виде асинхронного генератора.

**Параметры**:

*   `cls`: Ссылка на класс `Qwen_QVQ_72B`.
*   `model` (str): Имя модели для использования.
*   `messages` (Messages): Список сообщений для отправки в модель.
*   `media` (MediaListType, optional): Список медиафайлов (например, изображений) для отправки в модель. По умолчанию `None`.
*   `api_key` (str, optional): API ключ для аутентификации. По умолчанию `None`.
*   `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
*   `**kwargs`: Дополнительные параметры.

**Возвращает**:

*   `AsyncResult`: Асинхронный генератор, который возвращает ответы от модели.

**Вызывает исключения**:

*   `ResponseError`: Если при обработке ответа возникает ошибка, связанная с превышением лимита GPU token.
*   `RuntimeError`: Если не удается прочитать ответ от API.

**Как работает функция**:

1.  **Установка заголовков**: Функция устанавливает заголовки запроса, включая `Accept` и `Authorization` (если предоставлен `api_key`).
2.  **Создание асинхронной сессии**: Создается асинхронная сессия для выполнения HTTP-запросов.
3.  **Обработка медиафайлов**: Если предоставлены медиафайлы, они загружаются на сервер с использованием `FormData`.
4.  **Формирование данных запроса**: Данные запроса формируются в зависимости от наличия медиафайлов.
5.  **Отправка запроса**: Запрос отправляется на API endpoint с использованием асинхронной сессии.
6.  **Обработка ответа**: Ответ от API обрабатывается по частям (chunks) для генерации текста.
7.  **Генерация результата**: Результат возвращается в виде асинхронного генератора.

**Внутренние функции**: Нет

**Примеры**:

```python
async def main():
    model = "qwen-qvq-72b-preview"
    messages = [{"role": "user", "content": "Hello, Qwen!"}]
    async for response in Qwen_QVQ_72B.create_async_generator(model, messages):
        print(response, end="")
```

```ascii
    Начало
      ↓
Установка заголовков запроса (headers)
      ↓
Создание асинхронной сессии (session)
      ├───→ Есть медиафайлы? (media)
      │     └───→ Да: Загрузка медиафайлов на сервер (upload)
      │     └───→ Нет: Пропуск загрузки
      ↓
Формирование данных запроса (data)
      ↓
Отправка POST запроса на API endpoint (session.post)
      ↓
Обработка ответа по частям (chunks)
      ├───→ Чтение event_id из ответа
      │     ↓
      │   Отправка GET запроса для получения event (event_response)
      │     ↓
      │   Обработка чанков из event_response
      │     ├───→ Чанк начинается с "event: "?
      │     │     └───→ Да: Извлечение типа события (event)
      │     │     └───→ Нет: Пропуск
      │     ↓
      │     ├───→ Чанк начинается с "data: "?
      │     │     └───→ Да: Обработка данных
      │     │     │     ├───→ event == "error"?
      │     │     │     │     └───→ Да: Выброс исключения ResponseError
      │     │     │     │     └───→ Нет: Продолжение
      │     │     │     ├───→ event in ("complete", "generating")?
      │     │     │     │     └───→ Да: Попытка загрузить JSON из чанка (json.loads)
      │     │     │     │     │     ├───→ Успешно?
      │     │     │     │     │     │     └───→ Да: Обработка данных в зависимости от типа события
      │     │     │     │     │     │     └───→ Нет: Выброс исключения RuntimeError
      │     │     │     │     │     └───→ Нет: Продолжение
      │     │     │     │     └───→ event == "generating"?
      │     │     │     │         └───→ Да: Извлечение текста из данных
      │     │     │     │         └───→ Нет: Выход из цикла
      │     │     │     └───→ Нет: Пропуск
      │     │     └───→ Нет: Пропуск
      │     ↓
      └───→ Генерация и возврат результата