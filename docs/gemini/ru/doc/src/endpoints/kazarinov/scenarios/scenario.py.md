# Модуль: `src.endpoints.kazarinov.scenarios.scenario`

## Обзор

Модуль предназначен для реализации сценариев обработки данных для проекта "Казаринов". Он включает в себя функции для извлечения данных из веб-страниц, их обработки с использованием AI, генерации отчетов и сохранения результатов.

## Подробнее

Модуль содержит классы и функции, необходимые для автоматизации процесса сбора и обработки данных о товарах с различных веб-сайтов, их перевода на разные языки с использованием AI и создания отчетов. Он использует библиотеки `BeautifulSoup`, `requests`, `telebot`, `asyncio` и другие для выполнения этих задач.

## Функции

### `fetch_target_urls_onetab`

```python
def fetch_target_urls_onetab(one_tab_url: str) -> tuple[str, str, list[str]] | bool:
    """
    Функция парсит целевые URL из полученного OneTab.

    Args:
        one_tab_url (str): URL OneTab, содержащий целевые URL.

    Returns:
        tuple[str, str, list[str]] | bool: Возвращает кортеж, содержащий цену, имя и список URL.
        Возвращает `False`, если произошла ошибка.

    Raises:
        requests.exceptions.RequestException: Если возникает ошибка при выполнении HTTP-запроса.

    Как работает функция:
    1. Выполняет GET-запрос к указанному URL OneTab.
    2. Извлекает ссылки на целевые страницы из HTML-кода страницы.
    3. Извлекает цену и имя из элемента `div` с классом `tabGroupLabel`.
    4. Возвращает цену, имя и список URL в виде кортежа.

    Внутри функции происходят следующие действия и преобразования:
     A: Выполнение HTTP-запроса к URL OneTab
     |
     -- B: Парсинг HTML-содержимого с использованием BeautifulSoup
     |
     C: Извлечение URL, цены и имени из HTML-кода

    Пример:
        >>> one_tab_url = "http://example.com/onetab"
        >>> price, mexiron_name, urls = fetch_target_urls_onetab(one_tab_url)
        >>> if price and mexiron_name and urls:
        ...     print(f"Цена: {price}, Имя: {mexiron_name}, URL: {urls[0]}")
    """
    ...
```

## Классы

### `Scenario`

```python
class Scenario(QuotationBuilder):
    """Исполнитель сценария для Казаринова"""

    def __init__(self, mexiron_name:Optional[str] = gs.now, driver:Optional[Firefox | Playwrid | str] = None, **kwards):
        """Сценарий сбора информации."""
        ...
```

**Описание**: Класс `Scenario` предназначен для выполнения сценариев, связанных со сбором информации о товарах, их обработкой и формированием отчетов. Он наследуется от класса `QuotationBuilder`.

**Как работает класс**:
1. Инициализируется с именем, драйвером и дополнительными аргументами.
2. Устанавливает режим окна в `normal`.
3. Инициализирует драйвер, если он не был передан при создании экземпляра класса.
4. Вызывает конструктор родительского класса `QuotationBuilder`.

**Методы**:

- `__init__`: Инициализирует экземпляр класса `Scenario`.
- `run_scenario_async`: Асинхронно выполняет сценарий сбора и обработки данных.

**Параметры**:

- `mexiron_name` (Optional[str]): Имя для сценария. По умолчанию текущее время.
- `driver` (Optional[Firefox | Playwrid | str]): Драйвер для управления браузером. По умолчанию `None`.
- `**kwards`: Дополнительные именованные аргументы.

### `Scenario.run_scenario_async`

```python
async def run_scenario_async(
        self,
        urls: List[str],  
        price: Optional[str] = '',
        mexiron_name: Optional[str] = gs.now, 
        bot: Optional[telebot.TeleBot] = None,
        chat_id: Optional[int] = 0,
        attempts: int = 3,
    ) -> bool:
        """
        Executes the scenario: parses products, processes them via AI, and stores data.
        """
        ...
```

**Назначение**: Асинхронно выполняет сценарий сбора и обработки данных о товарах.

**Параметры**:
- `urls` (List[str]): Список URL для сбора данных о товарах.
- `price` (Optional[str]): Цена. По умолчанию пустая строка.
- `mexiron_name` (Optional[str]): Имя для сценария. По умолчанию текущее время.
- `bot` (Optional[telebot.TeleBot]): Экземпляр бота Telegram для отправки уведомлений. По умолчанию `None`.
- `chat_id` (Optional[int]): ID чата Telegram для отправки уведомлений. По умолчанию 0.
- `attempts` (int): Количество попыток выполнения сценария. По умолчанию 3.

**Возвращает**:
- `bool`: `True`, если сценарий выполнен успешно, иначе `False`.

**Как работает функция**:

1.  **Инициализация**: Инициализирует список для хранения данных о товарах.
2.  **Сбор данных о товарах**:
    *   Итерируется по списку URL.
    *   Определяет граббер на основе URL.
    *   Извлекает поля товара с использованием граббера.
    *   Преобразует поля товара.
    *   Сохраняет данные о товаре.
3.  **Обработка данных с использованием AI**:
    *   Итерируется по списку языков (`he`, `ru`).
    *   Вызывает AI для обработки данных о товарах и перевода на текущий язык.
4.  **Создание отчета**:
    *   Генерирует отчет на основе обработанных данных.
    *   Сохраняет отчет в формате JSON.
    *   Создает отчеты с использованием `ReportGenerator`.

**Внутренние блоки функции**:
- **Инициализация** (products_list = []): Создание пустого списка для хранения данных о товарах.
- **Сбор данных** (for url in urls): Цикл по URL для сбора информации о товарах.
- **AI обработка** (for lang in langs_list): Цикл по языкам для обработки данных с использованием AI.
- **Создание отчета** (reporter = ReportGenerator(if_need_docx=False)): Создание отчетов на основе обработанных данных.

**Примеры**:

```python
# Пример вызова run_scenario_async
scenario = Scenario()
urls = ['http://example.com/product1', 'http://example.com/product2']
asyncio.run(scenario.run_scenario_async(urls=urls, mexiron_name='test_scenario'))
```

## Другие функции

### `run_sample_scenario`

```python
def run_sample_scenario():
    """"""
    ...
```

**Назначение**: Выполняет пример сценария для демонстрации работы модуля.

**Как работает функция**:
1.  Определяет список URL для сбора данных.
2.  Создает экземпляр класса `Scenario`.
3.  Запускает асинхронный сценарий с использованием списка URL и имени сценария.

**Примеры**:

```python
# Пример вызова run_sample_scenario
run_sample_scenario()
```