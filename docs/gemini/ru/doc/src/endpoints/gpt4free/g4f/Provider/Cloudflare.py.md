# Модуль Cloudflare

## Обзор

Модуль `Cloudflare` предоставляет асинхронный интерфейс для взаимодействия с AI-моделями, размещенными на платформе Cloudflare AI Playground. Он поддерживает потоковую передачу данных, системные сообщения и ведение истории сообщений. Модуль использует `nodriver` для получения аргументов сессии, если это возможно, или `curl_cffi` в качестве альтернативы.

## Подробнее

Модуль предназначен для упрощения взаимодействия с API Cloudflare AI, предоставляя методы для получения списка доступных моделей и создания асинхронных генераторов для обмена сообщениями с моделями. Он также управляет cookies для поддержания сессии и кэширует их для повторного использования.

## Классы

### `Cloudflare`

**Описание**: Класс `Cloudflare` является основным классом для взаимодействия с AI-моделями Cloudflare.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных генераторов.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями.
- `AuthFileMixin`: Предоставляет методы для аутентификации с использованием файлов.

**Атрибуты**:
- `label` (str): Метка провайдера ("Cloudflare AI").
- `url` (str): URL AI Playground ("https://playground.ai.cloudflare.com").
- `working` (bool): Указывает, работает ли провайдер (True).
- `use_nodriver` (bool): Указывает, использовать ли `nodriver` (True).
- `api_endpoint` (str): URL для API-выводов ("https://playground.ai.cloudflare.com/api/inference").
- `models_url` (str): URL для получения списка моделей ("https://playground.ai.cloudflare.com/api/models").
- `supports_stream` (bool): Указывает, поддерживает ли потоковую передачу (True).
- `supports_system_message` (bool): Указывает, поддерживает ли системные сообщения (True).
- `supports_message_history` (bool): Указывает, поддерживает ли историю сообщений (True).
- `default_model` (str): Модель по умолчанию ("@cf/meta/llama-3.3-70b-instruct-fp8-fast").
- `model_aliases` (dict): Псевдонимы моделей.
- `_args` (dict): Аргументы для сессии.

**Методы**:
- `get_models()`: Возвращает список доступных моделей.
- `create_async_generator()`: Создает асинхронный генератор для взаимодействия с моделью.

## Функции

### `get_models`

```python
@classmethod
def get_models(cls) -> str:
    """Возвращает список доступных моделей.

    Args:
        cls (Cloudflare): Класс Cloudflare.

    Returns:
        str: Список доступных моделей.
    """
```

**Назначение**:
Метод `get_models` предназначен для получения списка доступных AI-моделей с платформы Cloudflare AI Playground. Если список моделей еще не был получен, метод выполняет HTTP-запрос к API Cloudflare для получения списка моделей и сохраняет его в атрибуте класса `cls.models`.

**Как работает функция**:

1. **Проверка наличия моделей в кэше**:
   - Функция сначала проверяет, был ли уже получен список моделей и сохранен в атрибуте `cls.models`. Если список уже существует, он возвращается немедленно.

2. **Инициализация аргументов сессии**:
   - Если `cls.models` пуст, функция проверяет, инициализированы ли аргументы сессии `cls._args`.
   - Если `cls._args` равен `None`, происходит попытка его инициализации:
     - Сначала проверяется наличие `nodriver`. Если `nodriver` доступен, он используется для получения аргументов сессии.
     - Если `nodriver` недоступен, проверяется наличие `curl_cffi`. Если `curl_cffi` недоступен, возвращается текущее значение `cls.models` (которое, вероятно, является пустым списком).
     - Если `curl_cffi` доступен, используются стандартные заголовки `DEFAULT_HEADERS` и пустые cookies для инициализации `cls._args`.

3. **Получение списка моделей с использованием HTTP-запроса**:
   - Используется `Session` (из модуля `requests`) для выполнения HTTP-запроса к `cls.models_url`.
   - Cookies, полученные в ответе, объединяются с существующими cookies в `cls._args`.
   - Обрабатываются возможные ошибки HTTP-ответа с использованием `raise_for_status`. В случае ошибки возвращается текущее значение `cls.models`.
   - Если запрос успешен, извлекается JSON-данные из ответа и извлекается список имен моделей из поля `models`. Этот список сохраняется в `cls.models`.

4. **Возврат списка моделей**:
   - В конце функция возвращает список моделей `cls.models`.

**ASII flowchart**:

```
A: Проверка cls.models
|
N: cls.models существует?
|   \___Y: Возврат cls.models
|
|   N: Инициализация cls._args
|   |
|   N: has_nodriver?
|   |   \___Y: Получение аргументов сессии с использованием nodriver
|   |
|   N: has_curl_cffi?
|   |   \___Y: Использование DEFAULT_HEADERS и cookies
|   |       \___N: Возврат cls.models
|
B: Создание HTTP-сессии
|
C: Выполнение GET-запроса к cls.models_url
|
D: Обработка ответа
|
E: Извлечение списка моделей из JSON
|
F: Сохранение списка моделей в cls.models
|
G: Возврат cls.models
```

**Примеры**:

```python
# Пример вызова функции get_models
models = Cloudflare.get_models()
if models:
    print(f"Доступные модели: {models}")
else:
    print("Не удалось получить список моделей")
```

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    max_tokens: int = 2048,
    cookies: Cookies = None,
    timeout: int = 300,
    **kwargs
) -> AsyncResult:
    """Создает асинхронный генератор для взаимодействия с моделью.

    Args:
        cls (Cloudflare): Класс Cloudflare.
        model (str): Имя модели.
        messages (Messages): Список сообщений.
        proxy (str, optional): URL прокси-сервера. По умолчанию None.
        max_tokens (int, optional): Максимальное количество токенов. По умолчанию 2048.
        cookies (Cookies, optional): Cookies для сессии. По умолчанию None.
        timeout (int, optional): Время ожидания запроса. По умолчанию 300.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор для взаимодействия с моделью.
    """
```

**Назначение**:
Метод `create_async_generator` создает асинхронный генератор, который позволяет взаимодействовать с AI-моделью Cloudflare. Он принимает модель, список сообщений и параметры конфигурации, такие как прокси, максимальное количество токенов, cookies и время ожидания.

**Как работает функция**:

1. **Инициализация аргументов сессии**:
   - Проверяется, инициализированы ли аргументы сессии `cls._args`. Если нет, то происходит попытка их инициализации из кэш-файла, с использованием `nodriver` или стандартных заголовков и cookies.

2. **Подготовка данных для запроса**:
   - Преобразует список сообщений в формат, требуемый API Cloudflare.

3. **Выполнение POST-запроса к API**:
   - Используется `StreamSession` для выполнения асинхронного POST-запроса к `cls.api_endpoint` с подготовленными данными.
   - Cookies, полученные в ответе, объединяются с существующими cookies в `cls._args`.

4. **Обработка потоковых данных**:
   - Асинхронно итерируется по строкам в ответе.
   - Если строка начинается с `b'0:'`, она декодируется как JSON и возвращается.
   - Если строка начинается с `b'e:'`, она декодируется как JSON, извлекаются данные об использовании и причина завершения, которые также возвращаются.

5. **Кэширование аргументов сессии**:
   - После завершения запроса аргументы сессии сохраняются в кэш-файл.

**ASII flowchart**:

```
A: Проверка cls._args
|
N: cls._args существует?
|   \___Y: Использование существующих cls._args
|
|   N: Попытка инициализации из кэш-файла
|   |
|   N: Кэш-файл существует?
|   |   \___Y: Загрузка cls._args из кэш-файла
|   |
|   N: Использование nodriver?
|   |   \___Y: Получение аргументов сессии с использованием nodriver
|   |
|   Использование DEFAULT_HEADERS и cookies
|
B: Подготовка данных для запроса
|
C: Создание StreamSession и выполнение POST-запроса к cls.api_endpoint
|
D: Обработка потоковых данных
|
E: Декодирование и возврат JSON-данных
|
F: Извлечение и возврат данных об использовании и причины завершения
|
G: Кэширование cls._args в файл
```

**Примеры**:

```python
# Пример вызова функции create_async_generator
import asyncio

async def main():
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    generator = await Cloudflare.create_async_generator(model="@cf/meta/llama-3-8b-instruct", messages=messages)
    async for item in generator:
        print(item)

if __name__ == "__main__":
    asyncio.run(main())