# Модуль для поиска свободного порта

## Обзор

Модуль `get_free_port` предоставляет функциональность для поиска свободного порта на указанном хосте. Он позволяет указать диапазон портов для поиска или найти первый доступный порт, если диапазон не задан.

## Подробней

Этот модуль предназначен для использования в ситуациях, когда необходимо динамически выделить порт для сетевого сервиса или приложения. Он проверяет, занят ли порт, пытаясь привязать к нему сокет. Если привязка удается, порт считается свободным.

Модуль содержит функцию `get_free_port`, которая принимает хост и необязательный диапазон портов в качестве аргументов. Диапазон портов может быть задан строкой в формате "min-max" или списком строк. Если диапазон не указан, функция начинает поиск с порта 1024 и увеличивает его до тех пор, пока не найдет свободный.

## Функции

### `get_free_port`

```python
def get_free_port(host: str, port_range: Optional[str | List[str]] = None) -> int:
    """
    Находит и возвращает свободный порт в указанном диапазоне или первый доступный порт, если диапазон не задан.

    Args:
        host (str): Адрес хоста для проверки доступных портов.
        port_range (Optional[str | List[str]], optional): Диапазон портов, заданный строкой "min-max" или списком строк.
            Например: "3000-3999", ["3000-3999", "8000-8010"], None. По умолчанию `None`.

    Returns:
        int: Доступный номер порта.

    Raises:
        ValueError: Если не удается найти свободный порт в указанном диапазоне или если диапазон портов недействителен.

    Example:
        >>> get_free_port('localhost', '3000-3005')
        3001
    """
    ...
```

**Как работает функция**:
1. **Обработка `port_range`**:
   - Проверяет, был ли предоставлен `port_range`.
   - Если `port_range` является строкой, пытается разобрать её, вызвав `_parse_port_range`. Если разбор не удался, регистрирует ошибку и вызывает `ValueError`.
   - Если `port_range` является списком, перебирает каждый элемент списка, пытаясь разобрать его как диапазон портов. Если элемент не является строкой или разбор не удался, регистрирует ошибку и переходит к следующему элементу.
   - Если `port_range` имеет недопустимый тип, регистрирует ошибку и вызывает `ValueError`.

2. **Поиск свободного порта в диапазоне**:
   - Если `port_range` предоставлен (в виде строки или списка), функция перебирает порты в указанном диапазоне (или диапазонах).
   - Для каждого порта вызывает `_is_port_in_use`, чтобы проверить, используется ли порт.
   - Если порт не используется, функция возвращает номер порта.

3. **Поиск первого доступного порта**:
   - Если `port_range` не предоставлен, функция начинает поиск с порта 1024 и увеличивает его до тех пор, пока не найдет свободный.
   - Для каждого порта вызывает `_is_port_in_use`, чтобы проверить, используется ли порт.
   - Если порт не используется, функция возвращает номер порта.
   - Если ни один порт не найден до 65535, регистрирует ошибку и вызывает `ValueError`.

4. **Обработка ошибок**:
   - Если не удается найти свободный порт в указанном диапазоне, регистрирует ошибку и вызывает `ValueError`.

**Параметры**:
- `host` (str): Адрес хоста для проверки доступных портов.
- `port_range` (Optional[str | List[str]], optional): Диапазон портов, заданный строкой "min-max" или списком строк. По умолчанию `None`.

**Возвращает**:
- `int`: Доступный номер порта.

**Вызывает исключения**:
- `ValueError`: Если не удается найти свободный порт в указанном диапазоне или если диапазон портов недействителен.

**Примеры**:

```python
# Пример 1: Поиск свободного порта в диапазоне 3000-3005
port = get_free_port('localhost', '3000-3005')
print(f'Свободный порт: {port}')

# Пример 2: Поиск свободного порта в списке диапазонов
port = get_free_port('localhost', ['3000-3005', '8000-8010'])
print(f'Свободный порт: {port}')

# Пример 3: Поиск первого доступного порта
port = get_free_port('localhost')
print(f'Свободный порт: {port}')
```

### `_is_port_in_use`

```python
def _is_port_in_use(host: str, port: int) -> bool:
    """
    Проверяет, используется ли данный порт на указанном хосте.

    Args:
        host (str): Адрес хоста.
        port (int): Номер порта для проверки.

    Returns:
        bool: True, если порт используется, False в противном случае.
    """
    ...
```

**Как работает функция**:

1. **Создание сокета**:
   - Создает TCP сокет (socket.AF_INET, socket.SOCK_STREAM) с использованием менеджера контекста `with`. Это гарантирует, что сокет будет закрыт после использования.

2. **Привязка сокета к адресу**:
   - Пытается привязать сокет к указанному адресу (хост и порт) с помощью `sock.bind((host, port))`.

3. **Проверка доступности порта**:
   - Если привязка удается, это означает, что порт свободен. Функция возвращает `False`.
   - Если привязка вызывает исключение `OSError`, это означает, что порт занят или недоступен. Функция возвращает `True`.

**Параметры**:
- `host` (str): Адрес хоста.
- `port` (int): Номер порта для проверки.

**Возвращает**:
- `bool`: `True`, если порт используется, `False` в противном случае.

**Вызывает исключения**:
- Отсутствуют явные исключения, но может возникнуть `OSError` при попытке привязки к занятому порту.

**Примеры**:

```python
# Пример 1: Проверка, занят ли порт 8080 на localhost
is_used = _is_port_in_use('localhost', 8080)
print(f'Порт 8080 занят: {is_used}')

# Пример 2: Проверка, занят ли порт 5000 на localhost
is_used = _is_port_in_use('localhost', 5000)
print(f'Порт 5000 занят: {is_used}')
```

### `_parse_port_range`

```python
def _parse_port_range(port_range_str: str) -> Tuple[int, int]:
    """
    Разбирает строку диапазона портов "min-max" в кортеж (min_port, max_port).

    Args:
        port_range_str (str): Строка диапазона портов.

    Returns:
        Tuple[int, int]: Кортеж, содержащий минимальный и максимальный номера портов.

    Raises:
        ValueError: Если формат строки диапазона портов недействителен.
    """
    ...
```

**Как работает функция**:

1. **Разделение строки**:
   - Разделяет входную строку `port_range_str` на две части, используя символ `-` в качестве разделителя. Результат сохраняется в списке `parts`.

2. **Проверка количества частей**:
   - Проверяет, содержит ли список `parts` ровно два элемента. Если нет, это означает, что формат строки неверен. Регистрирует ошибку с помощью `logger.error` и вызывает исключение `ValueError` с соответствующим сообщением.

3. **Преобразование в целые числа**:
   - Преобразует первый и второй элементы списка `parts` в целые числа, используя функцию `int()`. Результаты сохраняются в переменных `min_port` и `max_port` соответственно.

4. **Проверка минимального и максимального портов**:
   - Проверяет, является ли `min_port` больше или равным `max_port`. Если это так, это означает, что диапазон портов недействителен. Регистрирует ошибку с помощью `logger.error` и вызывает исключение `ValueError` с соответствующим сообщением.

5. **Возврат диапазона портов**:
   - Если все проверки пройдены успешно, функция возвращает кортеж, содержащий `min_port` и `max_port`.

6. **Обработка исключений**:
   - Если в процессе преобразования строки в целое число возникает исключение `ValueError`, это означает, что строка имеет неверный формат. Регистрирует ошибку с помощью `logger.error` и вызывает исключение `ValueError` с соответствующим сообщением.

**Параметры**:
- `port_range_str` (str): Строка диапазона портов.

**Возвращает**:
- `Tuple[int, int]`: Кортеж, содержащий минимальный и максимальный номера портов.

**Вызывает исключения**:
- `ValueError`: Если формат строки диапазона портов недействителен.

**Примеры**:

```python
# Пример 1: Разбор корректной строки диапазона портов
min_port, max_port = _parse_port_range('3000-3005')
print(f'Минимальный порт: {min_port}, Максимальный порт: {max_port}')

# Пример 2: Разбор некорректной строки диапазона портов (неверный формат)
try:
    min_port, max_port = _parse_port_range('3000:3005')
except ValueError as ex:
    print(f'Ошибка: {ex}')

# Пример 3: Разбор некорректной строки диапазона портов (min >= max)
try:
    min_port, max_port = _parse_port_range('3005-3000')
except ValueError as ex:
    print(f'Ошибка: {ex}')