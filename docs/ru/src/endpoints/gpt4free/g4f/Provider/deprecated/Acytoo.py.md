# Модуль Acytoo

## Обзор

Модуль предоставляет асинхронный генератор для взаимодействия с сервисом Acytoo, который использует модель GPT-3.5-turbo. Он позволяет отправлять запросы к API Acytoo и получать ответы в виде потока данных.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для работы с одним из поставщиков услуг GPT4Free - Acytoo. Он предоставляет асинхронный интерфейс для обмена сообщениями с моделью GPT-3.5-turbo через API Acytoo. Модуль поддерживает прокси и позволяет настраивать параметры запроса, такие как температуру.

## Классы

### `Acytoo`

**Описание**: Класс `Acytoo` является асинхронным генератором провайдера, предназначенным для взаимодействия с сервисом Acytoo.

**Наследует**: `AsyncGeneratorProvider`

**Аттрибуты**:

- `url` (str): URL сервиса Acytoo (`https://chat.acytoo.com`).
- `working` (bool): Флаг, указывающий на работоспособность провайдера (в данном случае `False`).
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений (`True`).
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели GPT-3.5-turbo (`True`).

**Методы**:

- `create_async_generator`: Создает асинхронный генератор для взаимодействия с API Acytoo.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для взаимодействия с API Acytoo.

    Args:
        model (str): Название модели (в данном случае всегда 'gpt-3.5-turbo').
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные параметры для передачи в API.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий ответы от API Acytoo.

    Как работает функция:
    1. Создает сессию aiohttp для выполнения асинхронных запросов.
    2. Отправляет POST-запрос к API Acytoo.
    3. Получает ответ в виде потока данных.
    4. Декодирует поток и выдает его части через генератор.

    Примеры:
        Пример вызова функции:
        >>> async for chunk in Acytoo.create_async_generator(model='gpt-3.5-turbo', messages=[{'role': 'user', 'content': 'Hello'}]):
        ...     print(chunk, end='')
    """
```

**Внутренние функции**: Отсутствуют.

**Параметры**:

- `cls`: Ссылка на класс `Acytoo`.
- `model` (str): Имя модели для использования (фактически всегда `gpt-3.5-turbo`).
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): URL прокси-сервера (если требуется). По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:

- `AsyncResult`: Асинхронный генератор, выдающий части ответа от API Acytoo.

**Как работает функция**:

1. **Инициализация сессии**: Создается асинхронная сессия `aiohttp.ClientSession` с заголовками, полученными из функции `_create_header()`.

2. **Отправка запроса**: Выполняется POST-запрос к адресу `f'{cls.url}/api/completions'` с использованием указанного прокси (если он предоставлен) и полезной нагрузкой (payload), сформированной функцией `_create_payload(messages, **kwargs)`.

3. **Обработка ответа**:
   - Проверяется статус ответа с помощью `response.raise_for_status()`, что вызывает исключение в случае ошибки (например, 404 или 500).
   - Если запрос успешен, начинается итерация по содержимому ответа с использованием `response.content.iter_any()`. Этот метод позволяет получать данные по частям (chunks).

4. **Генерация данных**:
   - Для каждой полученной части данных (chunk) выполняется проверка `if stream:`. Это необходимо, чтобы избежать обработки пустых частей.
   - Если часть данных не пуста, она декодируется в строку с использованием `stream.decode()` и выдается через `yield`.

```text
create_async_generator
│
├───► Создание aiohttp.ClientSession с заголовками _create_header()
│
├───► Отправка POST-запроса к API Acytoo (proxy, _create_payload)
│
├───► Проверка статуса ответа (response.raise_for_status())
│
└───► Итерация по частям ответа (response.content.iter_any())
    │
    └───► Декодирование части ответа (stream.decode())
        │
        └───► Выдача декодированной части (yield)
```

### `_create_header`

```python
def _create_header():
    """
    Создает заголовок для HTTP-запроса.

    Returns:
        dict: Словарь с заголовками.

    Как работает функция:
        Функция создает и возвращает словарь, содержащий HTTP-заголовки,
        необходимые для запросов к API Acytoo. В данном случае, устанавливается
        тип содержимого (content-type) как 'application/json' и указывается,
        что клиент принимает любой тип ответа ('*/*').
    """
```

**Внутренние функции**: Отсутствуют.

**Параметры**: Отсутствуют.

**Возвращает**:

- `dict`: Словарь с заголовками `accept` и `content-type`.

**Как работает функция**:

Функция создает словарь с HTTP-заголовками, необходимыми для запросов к API Acytoo.

```text
_create_header
│
└───► Создание словаря с заголовками ('accept': '*/*', 'content-type': 'application/json')
│
└───► Возврат словаря с заголовками
```

### `_create_payload`

```python
def _create_payload(messages: Messages, temperature: float = 0.5, **kwargs):
    """
    Создает полезную нагрузку (payload) для отправки в API Acytoo.

    Args:
        messages (Messages): Список сообщений для отправки.
        temperature (float, optional): Температура модели. По умолчанию 0.5.
        **kwargs: Дополнительные параметры.

    Returns:
        dict: Словарь с данными для отправки в API.

    Как работает функция:
        Функция создает словарь, содержащий данные, необходимые для запроса
        к API Acytoo. Включает ключ API (по умолчанию пустой), имя модели
        (по умолчанию 'gpt-3.5-turbo'), список сообщений, температуру и пароль
        (по умолчанию пустой).
    """
```

**Внутренние функции**: Отсутствуют.

**Параметры**:

- `messages` (Messages): Список сообщений.
- `temperature` (float, optional): Температура модели. По умолчанию `0.5`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:

- `dict`: Словарь с данными для отправки в API.

**Как работает функция**:

Функция создает словарь, представляющий собой полезную нагрузку (payload) для запроса к API Acytoo. Этот словарь включает в себя различные параметры, такие как ключ API, имя модели, список сообщений, температуру и пароль.

```text
_create_payload
│
├───► Создание словаря с параметрами ('key', 'model', 'messages', 'temperature', 'password')
│
└───► Возврат словаря с данными
```