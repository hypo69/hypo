# Модуль `FreeNetfly`

## Обзор

Модуль `FreeNetfly` предоставляет асинхронный генератор для взаимодействия с API `free.netfly.top`. Он позволяет получать ответы от моделей, таких как `gpt-3.5-turbo` и `gpt-4`, используя асинхронные запросы. Модуль включает в себя обработку ошибок, повторные попытки и потоковую передачу данных.

## Подробней

Этот модуль предназначен для интеграции с другими частями проекта `hypotez`, требующими взаимодействия с API `free.netfly.top` для генерации текста или выполнения других задач, поддерживаемых моделями `gpt-3.5-turbo` и `gpt-4`. Он использует асинхронные запросы для обеспечения неблокирующей работы и эффективной обработки данных.

## Классы

### `FreeNetfly`

**Описание**: Класс `FreeNetfly` является асинхронным генератором провайдера и миксином модели провайдера. Он предназначен для взаимодействия с API `free.netfly.top`.

**Принцип работы**:
1.  Определяет URL и API endpoint для `free.netfly.top`.
2.  Указывает поддерживаемые модели (`gpt-3.5-turbo`, `gpt-4`).
3.  Реализует метод `create_async_generator` для создания асинхронного генератора, который отправляет запросы к API и обрабатывает ответы.
4.  Использует метод `_process_response` для обработки потоковых данных, полученных от API.

**Аттрибуты**:

*   `url` (str): URL сайта `free.netfly.top`.
*   `api_endpoint` (str): Endpoint API для выполнения запросов.
*   `working` (bool): Флаг, указывающий, работает ли провайдер.
*   `default_model` (str): Модель, используемая по умолчанию (`gpt-3.5-turbo`).
*   `models` (List[str]): Список поддерживаемых моделей (`gpt-3.5-turbo`, `gpt-4`).

**Методы**:

*   `create_async_generator`: Создает асинхронный генератор для отправки запросов и получения ответов от API.
*   `_process_response`: Обрабатывает потоковые данные, полученные от API, и извлекает контент.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для взаимодействия с API FreeNetfly.

    Args:
        model (str): Имя используемой модели.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий текстовые фрагменты ответа.

    Raises:
        ClientError: Если возникает ошибка клиента при отправке запроса.
        asyncio.TimeoutError: Если время ожидания ответа истекает.

    """
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор, который отправляет запросы к API `free.netfly.top` и возвращает ответы в виде потока текстовых фрагментов.

**Параметры**:

*   `cls`: Ссылка на класс `FreeNetfly`.
*   `model` (str): Имя используемой модели (`gpt-3.5-turbo` или `gpt-4`).
*   `messages` (Messages): Список сообщений для отправки в API.
*   `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
*   `**kwargs`: Дополнительные параметры, которые могут быть переданы в API.

**Возвращает**:

*   `AsyncResult`: Асинхронный генератор, выдающий текстовые фрагменты ответа от API.

**Вызывает исключения**:

*   `ClientError`: Если возникает ошибка при отправке запроса (например, ошибка сети).
*   `asyncio.TimeoutError`: Если время ожидания ответа от API истекает.

**Как работает функция**:

1.  **Подготовка заголовков**: Функция устанавливает необходимые HTTP-заголовки, включая `accept`, `content-type`, `user-agent` и другие.
2.  **Формирование данных запроса**: Создает словарь `data`, содержащий сообщения, имя модели, параметры температуры, штрафы за присутствие и частоту, а также верхний предел вероятности.
3.  **Настройка повторных попыток**: Устанавливает максимальное количество повторных попыток (`max_retries`) и начальную задержку между ними (`retry_delay`).
4.  **Цикл повторных попыток**:
    *   Пытается отправить запрос к API в цикле, пока не будет достигнуто максимальное количество попыток.
    *   Использует `ClientSession` для управления HTTP-сессией.
    *   Отправляет POST-запрос к API endpoint с заданными заголовками, данными и прокси-сервером (если указан).
    *   Обрабатывает ответ от API, вызывая `_process_response` для получения асинхронного генератора, который выдает текстовые фрагменты.
    *   Если запрос успешен, функция завершается и возвращает результат.
    *   Если возникает исключение `ClientError` или `asyncio.TimeoutError`, функция ждет заданное время, увеличивает задержку и повторяет попытку.
5.  **Обработка ошибок**: Если все попытки заканчиваются неудачей, функция вызывает последнее исключение.

**Внутренние функции**: Нет

**ASCII flowchart**:

```
    Начало
    │
    ├── Заголовки и данные запроса
    │
    ├── Цикл повторных попыток (max_retries)
    │   ├── Отправка POST-запроса к API
    │   │   ├── Успех: Обработка ответа через _process_response
    │   │   │   └── Выход из функции
    │   │   └── Ошибка (ClientError, asyncio.TimeoutError):
    │   │       ├── Проверка: Достигнуто ли max_retries?
    │   │       │   ├── Да: Выброс исключения
    │   │       │   └── Нет: Ожидание и увеличение задержки
    │   └── Конец цикла
    │
    └── Конец
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from typing import List, Dict, AsyncGenerator

async def process_stream(generator: AsyncGenerator[str, None]):
    async for item in generator:
        print(item, end="")

async def main():
    model_name = "gpt-3.5-turbo"
    messages: List[Dict[str, str]] = [
        {"role": "system", "content": "You are a helpful assistant."},
        {"role": "user", "content": "Tell me a joke."}
    ]
    
    generator = await FreeNetfly.create_async_generator(model=model_name, messages=messages)
    await process_stream(generator)

if __name__ == "__main__":
    asyncio.run(main())
```

### `_process_response`

```python
@classmethod
async def _process_response(cls, response) -> AsyncGenerator[str, None]:
    """
    Обрабатывает асинхронный ответ от API, извлекая текстовые фрагменты.

    Args:
        response: Асинхронный ответ от API.

    Returns:
        AsyncGenerator[str, None]: Асинхронный генератор, выдающий текстовые фрагменты.

    """
```

**Назначение**: Функция `_process_response` обрабатывает асинхронный ответ от API, извлекая и выдавая текстовые фрагменты из потоковых данных.

**Параметры**:

*   `cls`: Ссылка на класс `FreeNetfly`.
*   `response`: Асинхронный ответ от API.

**Возвращает**:

*   `AsyncGenerator[str, None]`: Асинхронный генератор, выдающий текстовые фрагменты, полученные из ответа API.

**Вызывает исключения**:

*   `json.JSONDecodeError`: Если не удается декодировать JSON из строки.
*   `KeyError`: Если в структуре JSON отсутствует ожидаемый ключ.

**Как работает функция**:

1.  **Инициализация буфера**: Создает пустую строку `buffer` для накопления данных.
2.  **Обработка потока данных**:
    *   Итерируется по строкам в содержимом ответа (`response.content`).
    *   Декодирует каждую строку из байтов в UTF-8 и добавляет её в буфер.
    *   Проверяет, заканчивается ли буфер на `\n\n` (что указывает на конец блока данных).
3.  **Разделение и обработка подстрок**:
    *   Разделяет буфер на подстроки по символу новой строки (`\n`).
    *   Итерируется по подстрокам и проверяет, начинаются ли они с `data: `.
    *   Если подстрока равна `data: [DONE]`, функция завершается.
    *   Пытается извлечь JSON из подстроки, удалив префикс `data: `.
    *   Извлекает содержимое из JSON, используя ключи `choices`, `0`, `delta` и `content`.
    *   Если содержимое существует, функция выдает его через `yield`.
    *   Обрабатывает исключения `json.JSONDecodeError` и `KeyError`, если возникают ошибки при декодировании JSON или отсутствует ключ.
4.  **Обработка оставшихся данных в буфере**: После завершения обработки потока данных, функция проверяет, остался ли какой-либо текст в буфере. Если да, то выполняет те же действия, что и в цикле обработки потока.

**Внутренние функции**: Нет

**ASCII flowchart**:

```
    Начало
    │
    ├── Инициализация буфера
    │
    ├── Цикл по строкам в response.content
    │   ├── Декодирование строки и добавление в буфер
    │   ├── Проверка: buffer.endswith('\n\n')?
    │   │   ├── Да: Разделение буфера на подстроки
    │   │   │   ├── Цикл по подстрокам
    │   │   │   │   ├── Проверка: subline.startswith('data: ')?
    │   │   │   │   │   ├── Да: Проверка: subline == 'data: [DONE]'?
    │   │   │   │   │   │   ├── Да: Выход из функции
    │   │   │   │   │   │   └── Нет: Извлечение JSON и содержимого
    │   │   │   │   │   │       ├── Успех: yield content
    │   │   │   │   │   │       └── Ошибка (json.JSONDecodeError, KeyError): Обработка ошибки
    │   │   │   │   │   └── Нет: Продолжение цикла
    │   │   │   │   └── Конец цикла по подстрокам
    │   │   │   └── Очистка буфера
    │   │   └── Нет: Продолжение цикла по строкам
    │   └── Конец цикла по строкам
    │
    ├── Обработка оставшихся данных в буфере (если есть)
    │   ├── Аналогично обработке в цикле по строкам
    │   └── Выдача содержимого (если есть)
    │
    └── Конец
```

**Примеры**:

```python
# Пример использования _process_response
import asyncio
from aiohttp import ClientResponse, ClientSession
from typing import AsyncGenerator

async def process_response(response: ClientResponse):
    async for content in FreeNetfly._process_response(response):
        print(content, end="")

async def main():
    async with ClientSession() as session:
        async with session.get("https://free.netfly.top") as response:  # Замените URL на актуальный
            await process_response(response)

if __name__ == "__main__":
    asyncio.run(main())