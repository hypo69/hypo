## <алгоритм>

**Блок-схема работы бота:**

1.  **Инициализация**:
    *   Импортируются необходимые библиотеки и модули (telegram, os, pySmartDL, pydrive и т.д.).
    *   Инициализируется `GoogleAuth` для работы с Google Drive.
    *   Получается токен Telegram бота из `Creds.TG_TOKEN`.
    *   Создаётся объект `Updater` для работы с Telegram API.
    *   Создается `dispatcher` для обработки команд и сообщений.

2.  **Обработчики команд**:
    *   `/start`:
        *   Отправляет приветственное сообщение пользователю, используя его имя.
        *   *Пример*: `/start` -> "Привет, *Имя пользователя*!..."
    *   `/help`:
        *   Отправляет справочное сообщение с информацией о доступных командах.
        *    *Пример*: `/help` -> "Список команд: /auth, /start, /help, /revoke, ..."
    *   `/auth`:
        *   Проверяет наличие сохраненных учетных данных Google Drive.
        *   Если нет, отправляет URL-адрес для авторизации.
        *   Если есть, обновляет токен или авторизуется с сохранёнными данными.
        *   *Пример*: `/auth` -> "Пожалуйста, перейдите по этой ссылке..." или "Уже авторизованы."
    *    `/revoke`:
        *   Удаляет сохраненные учетные данные пользователя, если они существуют.
        *   *Пример*: `/revoke` -> "Токен успешно отозван" или "Ошибка при удалении токена"
    *   `/update`:
        *   Отправляет сообщение о статусе бота (текст из `TEXT.UPDATE`)
        *    *Пример*: `/update` -> "Бот работает и принимает команды"
    
3.  **Обработчик токена**:
    *   При получении сообщения проверяет, является ли текст токеном Google Drive.
    *   Если является, пытается авторизоваться с токеном и сохранить его.
    *   Отправляет сообщение об успехе или ошибке авторизации.
    *    *Пример*: Сообщение: "токен_от_google_drive" -> "Успешно авторизовано" или "Ошибка авторизации"

4.  **Обработчик URL**:
    *   При получении сообщения с URL (через `Filters.regex(r'http')`)
        *  Отправляет сообщение "Обработка..."
        *  Извлекает URL из сообщения.
        *   Проверяет наличие сохранённых учетных данных Google Drive.
        *   Если учетные данные отсутствуют, отправляет сообщение "Не авторизован".
        *   Если есть, то выполняется один из вариантов:
            *   Если URL содержит `openload` или `oload`, то отправляет сообщение об ошибке.
            *   Если URL содержит `dropbox.com`, скачивает файл используя `DPBOX` и `wget_dl`.
            *   Если URL содержит `mega.nz`, скачивает файл используя `Mega.from_credentials` и `download_from_url`.
            *  В иных случаях, скачивает файл по URL через `wget_dl`
            *   В случае ошибки скачивания, если `TEXT.DOWN_TWO` активировано, использует `SmartDL`
        *   Проверяет наличие ошибки в имени скачанного файла ("error" in filename). В случае ошибки удаляет файл и отправляет сообщение об ошибке
        *   Если скачивание прошло успешно, загружает файл на Google Drive через функцию `upload`
        *   Отправляет сообщение с информацией о загруженном файле (имя, размер, URL).
        *   Удаляет скачанный файл с сервера после загрузки.
            *    *Пример*: Сообщение: "https://example.com/file.mp4" -> "Имя файла.mp4, Размер: 100MB, Ссылка: ..."

5. **Запуск бота**:
    *   Регистрируются все обработчики команд и сообщений.
    *   Бот начинает отслеживать обновления с помощью `updater.start_polling()`.
    *   Бот переходит в режим ожидания `updater.idle()`.

## <mermaid>

```mermaid
flowchart TD
    Start --> Initialize[Инициализация]
    Initialize --> CommandHandlers[Регистрация обработчиков команд]
    CommandHandlers --> MessageHandler[Регистрация обработчика сообщений]
    MessageHandler --> StartPolling[Запуск бота]
    StartPolling --> Idle[Бот в режиме ожидания]

    subgraph Command Handlers
    
        CommandHandlerStart[Обработчик /start]
        CommandHandlerHelp[Обработчик /help]
        CommandHandlerAuth[Обработчик /auth]
        CommandHandlerRevoke[Обработчик /revoke]
        CommandHandlerUpdate[Обработчик /update]
    
    
    CommandHandlers --> CommandHandlerStart
    CommandHandlers --> CommandHandlerHelp
    CommandHandlers --> CommandHandlerAuth
    CommandHandlers --> CommandHandlerRevoke
    CommandHandlers --> CommandHandlerUpdate
    end

    subgraph Message Handlers
    
    MessageHandlerToken[Обработчик токенов]
    MessageHandlerURL[Обработчик URL]

     MessageHandler --> MessageHandlerToken
     MessageHandler --> MessageHandlerURL
     end


    subgraph Обработчики Сообщений и Команд
        MessageHandlerToken -- Token Message --> AuthToken[Авторизация токеном]
        MessageHandlerURL -- URL Message --> CheckAuth[Проверка авторизации]

        CheckAuth -- Auth -->  DownloadFile[Скачать файл]
        CheckAuth -- No Auth -->  SendNotAuthMessage[Отправить сообщение "Не авторизован"]
    
        DownloadFile -- Openload/Oload Link --> SendErrorOpenload[Отправить сообщение об ошибке Openload]
        DownloadFile -- Dropbox Link --> DownloadDropbox[Скачать через DPBOX]
        DownloadFile -- Mega Link --> DownloadMega[Скачать через Mega]
        DownloadFile -- Other Link -->  DownloadWget[Скачать через wget]
        DownloadWget -- Download Fail --> DownloadSmartDL[Скачать через SmartDL]
        DownloadSmartDL -- Download Fail --> SendErrorDownload[Отправить ошибку скачивания]

        DownloadFile --> UploadFile[Загрузить файл на Google Drive]
        UploadFile -- Upload Success --> SendSuccessMessage[Отправить сообщение об успешной загрузке]
        UploadFile -- Upload Fail --> SendErrorUpload[Отправить сообщение об ошибке загрузки]


        CommandHandlerStart --> SendStartMessage[Отправить приветствие]
        CommandHandlerHelp --> SendHelpMessage[Отправить справку]
        CommandHandlerAuth --> CheckGoogleAuth[Проверка авторизации Google]
        CheckGoogleAuth -- Not Auth --> SendAuthUrl[Отправить URL авторизации]
        CheckGoogleAuth -- Already Auth --> SendAlreadyAuth[Сообщение "Уже авторизованы"]
        CommandHandlerRevoke --> RevokeAuth[Удалить сохранённый токен]
         RevokeAuth -- Success --> SendRevokeSuccess[Сообщение об успешном удалении токена]
         RevokeAuth -- Fail --> SendRevokeFail[Сообщение о неудачном удалении токена]
        CommandHandlerUpdate --> SendUpdateMessage[Отправить сообщение о статусе]

       
    end
```
**Объяснение зависимостей в mermaid:**

*   **Инициализация** - начальная стадия, подготавливающая окружение для работы бота.
*   **Регистрация обработчиков команд** - устанавливает соответствие между командами Telegram и функциями их обрабатывающими.
*  **Регистрация обработчика сообщений** - устанавливает соответствие между типами сообщений и функциями их обрабатывающими
*   **Запуск бота** - запускает процесс получения и обработки обновлений от Telegram API.
*   **Бот в режиме ожидания** - бот ожидает новых сообщений или команд.
*   **Обработчики Сообщений и Команд** - подграф, в котором описаны все обработчики.
    *   **Авторизация токеном** - проверяет токен и сохраняет его.
    *   **Проверка авторизации** - проверяет, авторизован ли пользователь в Google Drive.
    *   **Отправить сообщение "Не авторизован"** - отправляет сообщение о необходимости авторизации.
    *   **Скачать файл** - запускает процесс скачивания файла по URL.
    *   **Отправить сообщение об ошибке Openload** - сообщение об ошибке скачивания openload
    *   **Скачать через DPBOX** - загрузка через DPBOX
    *   **Скачать через Mega** - загрузка через MEGA
    *    **Скачать через wget** - загрузка обычным wget
     *   **Скачать через SmartDL** - загрузка через SmartDL
    *   **Отправить ошибку скачивания** - сообщение об ошибке скачивания
    *   **Загрузить файл на Google Drive** - загрузка файла на google drive
    *    **Отправить сообщение об успешной загрузке** - отправка сообщения об успехе загрузки на гугл диск
    *    **Отправить сообщение об ошибке загрузки** - отправка сообщения об ошибке загрузки на гугл диск
    *   **Отправить приветствие** - отправка стартового сообщения бота
    *   **Отправить справку** - отправка сообщения со списком команд бота
     *   **Проверка авторизации Google** - проверяет наличие учетной записи гугл
    *  **Отправить URL авторизации** - сообщение со ссылкой на авторизацию гугл
    *   **Сообщение "Уже авторизованы"** - сообщение о том что авторизация уже прошла
    *   **Удалить сохранённый токен** - удаляет токен пользователя
    *   **Сообщение об успешном удалении токена** - отправка сообщения об успешном удалении
    *   **Сообщение о неудачном удалении токена** - отправка сообщения о неуспешном удалении
    *   **Отправить сообщение о статусе** - отправляет сообщение о статусе бота
## <объяснение>

**Импорты:**

*   `json`: Для работы с данными в формате JSON (не используется в данном коде, но импортирован).
*   `telegram.ext`: Набор инструментов для создания Telegram-ботов, включая `CommandHandler`, `MessageHandler`, `Filters`, `Updater`, `dispatcher`, `run_async`.
*   `telegram`: Основной модуль для работы с Telegram API, включая `ParseMode` для форматирования текста.
*   `os`: Для работы с файловой системой, например, для удаления файлов и проверки их существования.
*   `sys`: Для доступа к параметрам командной строки и системным функциям (не используется напрямую в этом коде, но импортирован).
*  `upload`: Модуль содержащий функцию `upload` для загрузки файлов на Google Drive.
*   `creds`: Модуль, содержащий токен Telegram-бота (`Creds.TG_TOKEN`).
*   `pySmartDL`: Библиотека для загрузки файлов, используется как второй вариант загрузчика.
*   `pydrive.auth`: Модуль для авторизации в Google Drive API.
*   `plugins`:  Пакет с плагинами для бота.
    *   `TEXT`: Модуль, содержащий текстовые константы.
     *   `tok_rec`: Модуль, содержащий функцию `is_token` для проверки, является ли текст токеном.
    *  `dpbox`: Модуль, содержащий функцию `DPBOX` для работы с ссылками dropbox.
    *  `wdl`: Модуль, содержащий функцию `wget_dl` для скачивания файлов через wget.
*   `time`: Для работы со временем (не используется непосредственно).
*   `subprocess`: Для запуска процессов из кода(не используется непосредственно).
*   `re`: Для работы с регулярными выражениями (не используется).
*   `mega`: Библиотека для работы с Mega.nz.

**Переменные:**

*   `bot_token`: Токен Telegram-бота, полученный из `Creds.TG_TOKEN`.
*   `updater`: Объект `Updater` для работы с Telegram API.
*   `dp`: Объект `Dispatcher` для обработки команд и сообщений.
*   `gauth`: Объект `GoogleAuth` для авторизации в Google Drive API.
*   `FOLDER_MIME_TYPE`: MIME-тип для папок в Google Drive.
*   `http`: Переменная для хранения объекта HTTP (не используется напрямую).
*   `initial_folder`: Переменная для хранения начальной папки (не используется).
*   `ID`: Идентификатор пользователя (или чата), используемый как имя файла для хранения токена.
*   `msg`: Текст сообщения пользователя.
*   `token`: Токен авторизации Google Drive.
*   `url`: URL для скачивания файла.
*   `sent_message`: Объект сообщения, отправленного ботом, используется для редактирования текста сообщения.
*   `filename`: Имя скачанного файла.
*  `DownloadStatus`: Флаг статуса загрузки
*   `m`: Объект для работы с MEGA
*  `SIZE`: Размер файла в MB
*  `FILENAME`: Имя файла без пути
*  `FILELINK`: Ссылка на файл на Google Drive

**Функции:**

*   `help(update, context)`:
    *   Аргументы: `update` (объект обновления Telegram), `context` (контекст).
    *   Отправляет пользователю справочное сообщение.
    *   Пример вызова: когда пользователь отправляет команду `/help`.
*   `auth(update, context)`:
    *   Аргументы: `update` (объект обновления Telegram), `context` (контекст).
    *   Выполняет авторизацию в Google Drive, либо запрашивает токен.
    *   Пример вызова: когда пользователь отправляет команду `/auth`.
*   `token(update, context)`:
    *   Аргументы: `update` (объект обновления Telegram), `context` (контекст).
    *   Обрабатывает токен, полученный от пользователя, и авторизует в Google Drive.
    *   Пример вызова: когда пользователь отправляет токен в виде текста.
*   `start(update, context)`:
    *   Аргументы: `update` (объект обновления Telegram), `context` (контекст).
    *   Отправляет приветственное сообщение пользователю.
    *   Пример вызова: когда пользователь отправляет команду `/start`.
*   `revoke_tok(update, context)`:
    *   Аргументы: `update` (объект обновления Telegram), `context` (контекст).
    *   Удаляет сохраненный токен пользователя, если он существует.
    *   Пример вызова: когда пользователь отправляет команду `/revoke`.
*   `UPLOAD(update, context)`:
    *   Аргументы: `update` (объект обновления Telegram), `context` (контекст).
    *   Обрабатывает URL, скачивает файл и загружает его в Google Drive.
    *   Пример вызова: когда пользователь отправляет сообщение, содержащее URL.
*   `status(update, context)`:
     *   Аргументы: `update` (объект обновления Telegram), `context` (контекст).
    *   Отправляет сообщение о статусе бота.
    *  Пример вызова: когда пользователь отправляет команду `/update`.

**Классы:**

*   `Creds`: Класс для хранения учетных данных.  В данном контексте используется для получения токена Telegram бота.
*   `GoogleAuth`: Класс из `pydrive.auth` для авторизации в Google Drive API.
*  `Mega`: Класс из библиотеки `mega` для работы с mega.nz

**Потенциальные ошибки и области для улучшения:**

*   **Обработка ошибок**:  В коде есть `try-except` блоки, но обработка ошибок может быть более детальной. Например, вместо простого вывода ошибки, можно отправлять более информативные сообщения пользователю.
*   **Логирование**: Добавить логирование для отслеживания действий бота и отладки.
*   **Разделение функциональности**: Функцию `UPLOAD` можно разбить на более мелкие функции для лучшей читаемости и поддержки.
*   **Управление файлами**: Управление временными файлами можно улучшить, добавив автоматическое удаление в случае ошибок и т.д.
* **Конфигурация:** Можно вынести текстовые константы и другие параметры в отдельный файл конфигурации.
*   **Безопасность**: Хранение токена пользователя в файле может быть небезопасным. Рассмотреть альтернативные способы хранения.
*  **Зависимости**: Не все импортированные библиотеки используются, это необходимо исправить.

**Связи с другими частями проекта:**

*   `Creds.TG_TOKEN`: Получает токен Telegram-бота из модуля `creds`.
*   `plugins.TEXT`: Использует константы из модуля `plugins.TEXT` для сообщений бота.
*   `upload`: Модуль `upload.py` используется для загрузки файлов на Google Drive.
* `plugins.tok_rec`: Модуль для проверки токена.
*  `plugins.dpbox`: Модуль для работы с ссылками Dropbox
*  `plugins.wdl`: Модуль для скачивания файлов
*  `pydrive.auth`: Используется для авторизации Google Drive

Этот анализ предоставляет подробное описание функциональности кода, его структуры, используемых библиотек и возможных проблем.