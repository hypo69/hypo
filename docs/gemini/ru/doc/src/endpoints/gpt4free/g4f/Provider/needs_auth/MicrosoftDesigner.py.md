# Модуль `MicrosoftDesigner.py`

## Обзор

Модуль `MicrosoftDesigner.py` предназначен для работы с Microsoft Designer для генерации изображений на основе текстовых запросов. Он использует асинхронные запросы и предоставляет функциональность для получения изображений через API Microsoft Designer. Модуль поддерживает различные размеры изображений и использует HAR-файлы или nodriver для получения токена доступа и user-agent.

## Подробней

Модуль интегрируется с Microsoft Designer для генерации изображений, используя предоставленный текстовый запрос. Он поддерживает различные модели и размеры изображений, а также использует HAR-файлы или nodriver для получения необходимых учетных данных.

## Классы

### `MicrosoftDesigner`

**Описание**: Класс `MicrosoftDesigner` является асинхронным генератором изображений, использующим API Microsoft Designer.

**Принцип работы**:
Класс наследует `AsyncGeneratorProvider` и `ProviderModelMixin`, что позволяет ему асинхронно генерировать изображения на основе текстовых запросов. Он использует HAR-файлы или nodriver для получения токена доступа и user-agent.

**Аттрибуты**:
- `label` (str): Метка провайдера, `"Microsoft Designer"`.
- `url` (str): URL Microsoft Designer, `"https://designer.microsoft.com"`.
- `working` (bool): Флаг, указывающий, работает ли провайдер, `True`.
- `use_nodriver` (bool): Флаг, указывающий, используется ли nodriver, `True`.
- `needs_auth` (bool): Флаг, указывающий, требуется ли аутентификация, `True`.
- `default_image_model` (str): Модель изображения по умолчанию, `"dall-e-3"`.
- `image_models` (List[str]): Список поддерживаемых моделей изображений.
- `models` (List[str]): Псевдоним для `image_models`.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для генерации изображений.
- `generate`: Генерирует изображение на основе текстового запроса.

#### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    prompt: str = None,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """Создает асинхронный генератор для генерации изображений.

    Args:
        cls (type): Ссылка на класс.
        model (str): Модель изображения для использования.
        messages (Messages): Список сообщений для формирования запроса.
        prompt (str, optional): Текстовый запрос. По умолчанию `None`.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор изображений.

    Как работает функция:
    1. Определяется размер изображения на основе выбранной модели. Если модель не является моделью по умолчанию и находится в списке поддерживаемых моделей, устанавливается соответствующий размер изображения.
    2. Вызывается метод `generate` с отформатированным запросом изображения, размером изображения и прокси-сервером (если указан).
    3. Возвращается асинхронный генератор, который генерирует изображения на основе текстового запроса.

    ascii
    Определение размера изображения -> Вызов метода generate -> Возврат асинхронного генератора

    """
    ...
```

#### `generate`

```python
@classmethod
async def generate(cls, prompt: str, image_size: str, proxy: str = None) -> ImageResponse:
    """Генерирует изображение на основе текстового запроса.

    Args:
        cls (type): Ссылка на класс.
        prompt (str): Текстовый запрос.
        image_size (str): Размер изображения.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.

    Returns:
        ImageResponse: Объект `ImageResponse`, содержащий URL сгенерированных изображений.

    Raises:
        NoValidHarFileError: Если не удалось найти access_token в HAR файле.

    Как работает функция:
    1. Пытается прочитать access_token и user_agent из HAR-файла с помощью функции `readHAR`. Если возникает исключение `NoValidHarFileError`, то переходит к следующему шагу.
    2. Если чтение из HAR-файла не удалось, пытается получить access_token и user_agent с помощью функции `get_access_token_and_user_agent`. Если возникает исключение `MissingRequirementsError`, то генерируется исключение `NoValidHarFileError`.
    3. Вызывает функцию `create_images` с полученными access_token, user_agent, размером изображения и прокси-сервером (если указан) для создания изображений.
    4. Возвращает объект `ImageResponse`, содержащий URL сгенерированных изображений.

    ascii

    Попытка чтения из HAR-файла -> (Если неуспешно) Попытка получения access_token и user_agent -> Вызов create_images -> Возврат ImageResponse

    """
    ...
```

## Функции

### `create_images`

```python
async def create_images(prompt: str, access_token: str, user_agent: str, image_size: str, proxy: str = None, seed: int = None):
    """Создает изображения на основе текстового запроса, используя API Microsoft Designer.

    Args:
        prompt (str): Текстовый запрос.
        access_token (str): Токен доступа для аутентификации.
        user_agent (str): User-Agent для HTTP-запросов.
        image_size (str): Размер изображения.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        seed (int, optional): Зерно для генерации случайных чисел. По умолчанию `None`.

    Returns:
        list[str]: Список URL сгенерированных изображений.

    Как работает функция:
    1. Определяет URL для запроса к API Microsoft Designer.
    2. Если seed не указан, генерируется случайное целое число в диапазоне от 0 до 10000.
    3. Определяются заголовки HTTP-запроса, включая User-Agent, Authorization и другие необходимые параметры.
    4. Формируются данные формы (form_data) для отправки в запросе, включая текстовый запрос, размер изображения и другие параметры.
    5. Создается асинхронная сессия клиента с использованием `aiohttp.ClientSession`.
    6. Отправляется POST-запрос к API Microsoft Designer с заголовками и данными формы.
    7. Обрабатывается ответ от API, проверяется статус и извлекается информация о polling_response.
    8. В цикле выполняется опрос API до тех пор, пока не будут получены URL сгенерированных изображений.
    9. Извлекаются URL изображений из ответа API и возвращаются в виде списка.

    ascii

    Определение URL -> Определение заголовков -> Формирование данных формы -> Отправка POST-запроса -> Обработка ответа -> Цикл опроса API -> Извлечение URL изображений -> Возврат списка URL

    """
    ...
```

### `readHAR`

```python
def readHAR(url: str) -> tuple[str, str]:
    """Читает HAR-файлы для извлечения токена доступа и user-agent.

    Args:
        url (str): URL для поиска в HAR-файлах.

    Returns:
        tuple[str, str]: Токен доступа и user-agent.

    Raises:
        NoValidHarFileError: Если не удалось найти токен доступа в HAR-файлах.

    Как работает функция:
    1. Проходит по списку HAR-файлов, полученных из `get_har_files()`.
    2. Для каждого файла пытается загрузить содержимое как JSON. Если файл не является JSON, переходит к следующему файлу.
    3. Проходит по записям в HAR-файле и ищет запись, URL которой начинается с заданного URL.
    4. Извлекает заголовки из записи и проверяет наличие токена авторизации и user-agent.
    5. Если токен авторизации и user-agent найдены, возвращает их.
    6. Если ни в одном HAR-файле не удалось найти токен доступа, вызывает исключение `NoValidHarFileError`.

    ascii

    Перебор HAR-файлов -> Загрузка содержимого JSON -> Поиск записи с URL -> Извлечение заголовков -> Возврат токена и user-agent -> (Если не найдено) Вызов исключения

    """
    ...
```

### `get_access_token_and_user_agent`

```python
async def get_access_token_and_user_agent(url: str, proxy: str = None):
    """Получает токен доступа и user-agent с использованием nodriver.

    Args:
        url (str): URL для открытия в браузере.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.

    Returns:
        tuple[str, str]: Токен доступа и user-agent.

    Как работает функция:
    1. Запускает браузер с использованием `get_nodriver()`, указывая прокси-сервер (если указан) и каталог пользовательских данных.
    2. Открывает заданный URL в браузере.
    3. Извлекает user-agent из браузера.
    4. В цикле пытается извлечь токен доступа из локального хранилища браузера.
    5. Если токен доступа не найден, ожидает 1 секунду и повторяет попытку.
    6. После извлечения токена доступа закрывает страницу и останавливает браузер.
    7. Возвращает токен доступа и user-agent.

    ascii

    Запуск браузера -> Открытие URL -> Извлечение user-agent -> Цикл извлечения токена -> Закрытие страницы -> Остановка браузера -> Возврат токена и user-agent

    """
    ...