# Модуль `scenario`

## Обзор

Модуль `scenario` предназначен для выполнения сценариев сбора информации о товарах с различных веб-сайтов, их обработки с использованием AI и последующего формирования отчетов. Он включает в себя классы и функции для парсинга URL, сбора данных о товарах, обработки этих данных с помощью AI-моделей (например, Google Gemini) и создания отчетов на разных языках. Модуль является частью проекта `hypotez` и используется в контексте работы с endpoint `kazarinov`.

## Подробней

Этот модуль играет ключевую роль в автоматизации процесса сбора и обработки информации о товарах. Он использует различные инструменты, такие как `BeautifulSoup` для парсинга HTML, `requests` для отправки HTTP-запросов, а также AI-модели для обработки и перевода данных. Сценарий включает в себя следующие этапы: сбор URL товаров, парсинг данных о товарах с использованием специализированных граберов, обработка данных с помощью AI, и генерация отчетов. Модуль также поддерживает интеграцию с `Telegram` ботом для отправки уведомлений о процессе выполнения.

## Функции

### `fetch_target_urls_onetab`

```python
def fetch_target_urls_onetab(one_tab_url: str) -> tuple[str, str, list[str]] | bool:
    """
    Функция паресит целевые URL из полученного OneTab.
    """
```

**Описание**: Извлекает целевые URL, цену и имя из OneTab URL.

**Как работает функция**: Функция отправляет GET-запрос по указанному `one_tab_url`, парсит HTML-контент с использованием `BeautifulSoup`, извлекает ссылки на товары и данные о цене и имени. Если данные о цене и имени отсутствуют, устанавливает значения по умолчанию.

**Параметры**:
- `one_tab_url` (str): URL OneTab, содержащий целевые URL.

**Возвращает**:
- `tuple[str, str, list[str]] | bool`: Кортеж, содержащий цену, имя и список URL. Возвращает `False, False, False` в случае ошибки.

**Вызывает исключения**:
- `requests.exceptions.RequestException`: Возникает при ошибке выполнения HTTP-запроса.

**Примеры**:
```python
one_tab_url = "https://www.one-tab.com/..."
price, mexiron_name, urls = fetch_target_urls_onetab(one_tab_url)
if urls:
    print(f"Найдено {len(urls)} URL")
```

## Классы

### `Scenario`

**Описание**: Класс `Scenario` предназначен для исполнения сценария сбора информации о товарах, их обработки с использованием AI и формирования отчетов.

**Как работает класс**: Класс инициализируется с именем, драйвером для управления браузером и другими параметрами конфигурации. Он наследуется от класса `QuotationBuilder` и использует его методы для построения отчетов. Основной метод `run_scenario_async` выполняет последовательность действий: сбор данных о товарах, их AI-обработку и генерацию отчетов на разных языках.

**Методы**:
- `__init__`: Инициализирует экземпляр класса `Scenario`.
- `run_scenario_async`: Запускает сценарий сбора, обработки и формирования отчетов.

#### `__init__`

```python
def __init__(self, mexiron_name:Optional[str] = gs.now, driver:Optional[Firefox | Playwrid | str] = None, **kwards):
    """Сценарий сбора информации."""
```

**Описание**: Инициализирует экземпляр класса `Scenario`.

**Как работает класс**:\
Инициализация `Scenario` включает в себя настройку драйвера (браузера) для сбора данных и вызов конструктора родительского класса `QuotationBuilder` для инициализации общих параметров, таких как имя и настройки экспорта.

**Параметры**:
- `mexiron_name` (Optional[str], optional): Имя для сценария. По умолчанию `gs.now`.
- `driver` (Optional[Firefox | Playwrid | str], optional): Драйвер для управления браузером. По умолчанию `None`.
- `kwards`: Дополнительные параметры конфигурации.

**Примеры**:
```python
s = Scenario(mexiron_name='test_scenario', window_mode='headless')
```

#### `run_scenario_async`

```python
async def run_scenario_async(
    self,
    urls: List[str],  
    price: Optional[str] = '',
    mexiron_name: Optional[str] = gs.now, 
    bot: Optional[telebot.TeleBot] = None,
    chat_id: Optional[int] = 0,
    attempts: int = 3,
) -> bool:
    """
    Executes the scenario: parses products, processes them via AI, and stores data.
    """
```

**Описание**: Запускает сценарий сбора данных о товарах, их AI-обработку и формирование отчетов.

**Как работает функция**:
1. **Сбор товаров**:
   - Перебирает список URL.
   - Использует `get_graber_by_supplier_url` для получения грабера (парсер) для каждого URL.
   - Собирает поля товара с использованием грабера.
   - Преобразует полученные данные.
   - Сохраняет данные о товаре.

2. **AI processing**:
   - Обрабатывает список товаров с использованием AI-модели (`gemini`).
   - Переводит данные на разные языки (`he`, `ru`).

3. **Report creating**:
   - Создает отчеты на основе обработанных данных.
   - Сохраняет отчеты в формате JSON и DOCX.

**Параметры**:
- `urls` (List[str]): Список URL для сбора данных.
- `price` (Optional[str], optional): Цена. По умолчанию ''.
- `mexiron_name` (Optional[str], optional): Имя для сценария. По умолчанию `gs.now`.
- `bot` (Optional[telebot.TeleBot], optional): Telegram бот для отправки уведомлений. По умолчанию `None`.
- `chat_id` (Optional[int], optional): ID чата для отправки уведомлений. По умолчанию `0`.
- `attempts` (int, optional): Количество попыток выполнения сценария. По умолчанию `3`.

**Возвращает**:
- `bool`: `True` в случае успешного выполнения сценария.

**Примеры**:
```python
urls_list = ['https://www.morlevi.co.il/product/21039', 'https://www.ivory.co.il/catalog.php?id=85473']
s = Scenario(window_mode='headless')
asyncio.run(s.run_scenario_async(urls=urls_list, mexiron_name='test_quotation'))
```

## Функции

### `run_sample_scenario`

```python
def run_sample_scenario():
    """"""
    ...
```

**Описание**: Запускает пример сценария.

**Как работает функция**:
   - Создает список URL-адресов для демонстрации.
   - Инициализирует класс `Scenario` с параметром `window_mode='headless'`.
   - Запускает асинхронный сценарий `run_scenario_async` с заданными URL-адресами и именем.

**Параметры**:
    - Отсутствуют

**Возвращает**:
    - Отсутствует

**Примеры**:
```python
run_sample_scenario()
```