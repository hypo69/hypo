# Модуль `training.py`

## Обзор

Модуль `training.py` предназначен для работы с OpenAI API, включая управление моделями, ассистентами и процессами обучения. Он содержит класс `OpenAIModel`, который предоставляет методы для взаимодействия с OpenAI API, загрузки и настройки моделей, отправки запросов, а также для обучения и сохранения данных.

## Подробней

Модуль облегчает взаимодействие с OpenAI API, предоставляя удобный интерфейс для выполнения различных задач, связанных с машинным обучением и обработкой естественного языка. Основные возможности включают:

*   Управление моделями и ассистентами.
*   Отправка запросов к моделям OpenAI.
*   Обучение моделей на основе предоставленных данных.
*   Анализ тональности сообщений.
*   Логирование и сохранение диалогов для дальнейшего использования.

## Классы

### `OpenAIModel`

**Описание**: Класс `OpenAIModel` предназначен для взаимодействия с OpenAI API и управления моделями.

**Принцип работы**:

1.  **Инициализация**: При инициализации класса происходит подключение к OpenAI API с использованием API ключа, загрузка ассистента и создание треда.
2.  **Управление моделями и ассистентами**: Класс предоставляет методы для получения списка доступных моделей и ассистентов, а также для установки активного ассистента.
3.  **Взаимодействие с моделью**: Класс позволяет отправлять сообщения модели и получать ответы, а также анализировать тональность ответов.
4.  **Обучение модели**: Класс предоставляет методы для обучения модели на основе предоставленных данных и сохранения результатов обучения.

**Аттрибуты**:

*   `model` (str): Имя используемой модели. По умолчанию `"gpt-4o-mini"`.
*   `client` (OpenAI): Клиент OpenAI для взаимодействия с API.
*   `current_job_id` (str): ID текущей задачи обучения.
*   `assistant_id` (str): ID используемого ассистента.
*   `assistant` (Any): Объект ассистента.
*   `thread` (Any): Объект треда.
*   `system_instruction` (str): Системная инструкция для модели.
*   `dialogue_log_path` (str | Path): Путь к файлу для сохранения диалогов.
*   `dialogue` (List[Dict[str, str]]): Список диалогов.
*   `assistants` (List[SimpleNamespace]): Список доступных ассистентов.
*   `models_list` (List[str]): Список доступных моделей.

**Методы**:

*   `__init__(api_key:str, system_instruction: str = None, model_name:str = 'gpt-4o-mini', assistant_id: str = None)`: Инициализирует объект `OpenAIModel` с ключом API, системной инструкцией и ID ассистента.
*   `list_models() -> List[str]`: Возвращает список доступных моделей из OpenAI API.
*   `list_assistants() -> List[str]`: Возвращает список доступных ассистентов из JSON файла.
*   `set_assistant(assistant_id: str)`: Устанавливает ассистента, используя предоставленный ID.
*   `_save_dialogue()`: Сохраняет весь диалог в JSON файл.
*   `determine_sentiment(message: str) -> str`: Определяет тональность сообщения (положительная, отрицательная или нейтральная).
*   `ask(message: str, system_instruction: str = None, attempts: int = 3) -> str`: Отправляет сообщение модели и возвращает ответ.
*   `describe_image(image_path: str | Path, prompt:Optional[str] = None, system_instruction:Optional[str] = None ) -> str`: Отправляет изображение в OpenAI API и возвращает описание.
*   `describe_image_by_requests(image_path: str | Path, prompt:str = None) -> str`: Отправляет изображение в OpenAI API и получает описание, используя `requests`.
*   `dynamic_train()`: Динамически загружает предыдущие диалоги и обучает модель на их основе.
*   `train(data: str = None, data_dir: Path | str = None, data_file: Path | str = None, positive: bool = True) -> str | None`: Обучает модель на основе предоставленных данных.
*   `save_job_id(job_id: str, description: str, filename: str = "job_ids.json")`: Сохраняет ID задачи обучения с описанием в файл.

## Функции

### `__init__`

```python
def __init__(self, api_key:str, system_instruction: str = None, model_name:str = 'gpt-4o-mini', assistant_id: str = None):
```

**Назначение**: Инициализирует объект `OpenAIModel`.

**Параметры**:

*   `api_key` (str): Ключ API для доступа к OpenAI.
*   `system_instruction` (str, optional): Системная инструкция для модели. По умолчанию `None`.
*   `model_name` (str, optional): Имя модели для использования. По умолчанию `'gpt-4o-mini'`.
*   `assistant_id` (str, optional): ID ассистента для использования. По умолчанию `None`.

**Как работает функция**:

1.  Инициализирует клиент OpenAI с использованием предоставленного API ключа или ключа из конфигурации.
2.  Устанавливает ID текущей задачи (job ID) в `None`.
3.  Устанавливает ID ассистента, используя предоставленный ID или ID из конфигурации.
4.  Устанавливает системную инструкцию.
5.  Загружает ассистента и создает тред для взаимодействия.

```
Инициализация → Установка API ключа → Определение ID ассистента → Загрузка ассистента → Создание треда
```

**Примеры**:

```python
model = OpenAIModel(api_key="YOUR_API_KEY", system_instruction="You are a helpful assistant.")
model = OpenAIModel(api_key="YOUR_API_KEY", assistant_id="asst_123")
```

### `list_models`

```python
def list_models(self) -> List[str]:
```

**Назначение**: Получает список доступных моделей из OpenAI API.

**Параметры**:

*   Нет

**Возвращает**:

*   `List[str]`: Список ID доступных моделей.

**Как работает функция**:

1.  Пытается получить список моделей из OpenAI API.
2.  Извлекает ID каждой модели из полученных данных.
3.  Логирует список загруженных моделей.
4.  В случае ошибки логирует ошибку и возвращает пустой список.

```
Получение моделей из API → Извлечение ID моделей → Логирование списка моделей
```

**Примеры**:

```python
model = OpenAIModel(api_key="YOUR_API_KEY")
models = model.list_models
print(models)
```

### `list_assistants`

```python
def list_assistants(self) -> List[str]:
```

**Назначение**: Загружает список доступных ассистентов из JSON файла.

**Параметры**:

*   Нет

**Возвращает**:

*   `List[str]`: Список имен ассистентов.

**Как работает функция**:

1.  Загружает данные ассистентов из JSON файла, используя `j_loads_ns`.
2.  Извлекает имя каждого ассистента из загруженных данных.
3.  Логирует список загруженных ассистентов.
4.  В случае ошибки логирует ошибку и возвращает пустой список.

```
Загрузка ассистентов из JSON → Извлечение имен ассистентов → Логирование списка ассистентов
```

**Примеры**:

```python
model = OpenAIModel(api_key="YOUR_API_KEY")
assistants = model.list_assistants
print(assistants)
```

### `set_assistant`

```python
def set_assistant(self, assistant_id: str):
```

**Назначение**: Устанавливает ассистента, используя предоставленный ID.

**Параметры**:

*   `assistant_id` (str): ID ассистента для установки.

**Как работает функция**:

1.  Устанавливает ID ассистента в атрибут класса.
2.  Получает информацию об ассистенте из OpenAI API, используя предоставленный ID.
3.  Логирует успешную установку ассистента.
4.  В случае ошибки логирует ошибку.

```
Установка ID ассистента → Получение информации об ассистенте из API → Логирование установки ассистента
```

**Примеры**:

```python
model = OpenAIModel(api_key="YOUR_API_KEY")
model.set_assistant("asst_123")
```

### `_save_dialogue`

```python
def _save_dialogue(self):
```

**Назначение**: Сохраняет весь диалог в JSON файл.

**Параметры**:

*   Нет

**Как работает функция**:

1.  Сохраняет текущий диалог в JSON файл, используя `j_dumps`.

```
Сохранение диалога в JSON
```

**Примеры**:

```python
model = OpenAIModel(api_key="YOUR_API_KEY")
model.dialogue.append({"role": "user", "content": "Hello"})
model._save_dialogue()
```

### `determine_sentiment`

```python
def determine_sentiment(self, message: str) -> str:
```

**Назначение**: Определяет тональность сообщения (положительная, отрицательная или нейтральная).

**Параметры**:

*   `message` (str): Сообщение для анализа.

**Возвращает**:

*   `str`: Тональность сообщения ('positive', 'negative' или 'neutral').

**Как работает функция**:

1.  Приводит сообщение к нижнему регистру.
2.  Проверяет наличие положительных, отрицательных и нейтральных слов в сообщении.
3.  Возвращает соответствующую тональность.

```
Приведение к нижнему регистру → Проверка на положительные слова → Проверка на отрицательные слова → Проверка на нейтральные слова
```

**Примеры**:

```python
model = OpenAIModel(api_key="YOUR_API_KEY")
sentiment = model.determine_sentiment("This is a great message!")
print(sentiment)  # Вывод: positive
```

### `ask`

```python
def ask(self, message: str, system_instruction: str = None, attempts: int = 3) -> str:
```

**Назначение**: Отправляет сообщение модели и возвращает ответ.

**Параметры**:

*   `message` (str): Сообщение для отправки.
*   `system_instruction` (str, optional): Системная инструкция для модели. По умолчанию `None`.
*   `attempts` (int, optional): Количество попыток повтора запроса. По умолчанию `3`.

**Возвращает**:

*   `str`: Ответ от модели.

**Как работает функция**:

1.  Формирует список сообщений для отправки модели, включая системную инструкцию и сообщение пользователя.
2.  Отправляет запрос к OpenAI API.
3.  Анализирует тональность ответа.
4.  Добавляет сообщения и тональность в диалог.
5.  Сохраняет диалог.
6.  В случае ошибки логирует ошибку, ждет 3 секунды и повторяет запрос, если количество попыток больше 0.

```
Формирование сообщений → Отправка запроса к API → Анализ тональности → Добавление в диалог → Сохранение диалога
```

**Примеры**:

```python
model = OpenAIModel(api_key="YOUR_API_KEY")
response = model.ask("Hello, how are you?")
print(response)
```

### `describe_image`

```python
def describe_image(self, image_path: str | Path, prompt:Optional[str] = None, system_instruction:Optional[str] = None ) -> str:
```

**Назначение**: Отправляет изображение в OpenAI API и возвращает описание.

**Параметры**:

*   `image_path` (str | Path): Путь к файлу изображения.
*   `prompt` (Optional[str], optional): Подсказка для описания изображения. По умолчанию `None`.
*   `system_instruction` (Optional[str], optional): Системная инструкция для модели. По умолчанию `None`.

**Возвращает**:

*   `str`: Описание изображения.

**Как работает функция**:

1.  Кодирует изображение в base64.
2.  Формирует список сообщений, включая системную инструкцию и изображение.
3.  Отправляет запрос в OpenAI API.
4.  Пытается извлечь описание изображения из ответа.
5.  В случае ошибки логирует ошибку.

```
Кодирование изображения в base64 → Формирование сообщений → Отправка запроса к API → Извлечение описания изображения
```

**Примеры**:

```python
model = OpenAIModel(api_key="YOUR_API_KEY")
image_path = "path/to/image.jpg"
description = model.describe_image(image_path, prompt="Describe this image")
print(description)
```

### `describe_image_by_requests`

```python
def describe_image_by_requests(self, image_path: str | Path, prompt:str = None) -> str:
```

**Назначение**: Отправляет изображение в OpenAI API и получает описание, используя `requests`.

**Параметры**:

*   `image_path` (str | Path): Путь к файлу изображения.
*   `prompt` (str, optional): Подсказка для описания изображения. По умолчанию `None`.

**Как работает функция**:

1.  Кодирует изображение в base64.
2.  Формирует заголовки и полезную нагрузку (payload) для HTTP запроса.
3.  Отправляет POST запрос в OpenAI API.
4.  Пытается извлечь описание изображения из ответа.
5.  В случае ошибки логирует ошибку.

```
Кодирование изображения в base64 → Формирование заголовков и payload → Отправка POST запроса → Извлечение описания изображения
```

**Примеры**:

```python
model = OpenAIModel(api_key="YOUR_API_KEY")
image_path = "path/to/image.jpg"
description = model.describe_image_by_requests(image_path, prompt="Describe this image")
print(description)
```

### `dynamic_train`

```python
def dynamic_train(self):
```

**Назначение**: Динамически загружает предыдущие диалоги и обучает модель на их основе.

**Параметры**:

*   Нет

**Как работает функция**:

1.  Загружает предыдущие диалоги из JSON файла.
2.  Отправляет диалоги в OpenAI API для обучения модели.
3.  Логирует успешное обучение или отсутствие диалогов.
4.  В случае ошибки логирует ошибку.

```
Загрузка диалогов из JSON → Отправка диалогов в API → Логирование результата
```

**Примеры**:

```python
model = OpenAIModel(api_key="YOUR_API_KEY")
model.dynamic_train()
```

### `train`

```python
def train(self, data: str = None, data_dir: Path | str = None, data_file: Path | str = None, positive: bool = True) -> str | None:
```

**Назначение**: Обучает модель на основе предоставленных данных.

**Параметры**:

*   `data` (str, optional): Путь к CSV файлу или строка в формате CSV с данными. По умолчанию `None`.
*   `data_dir` (Path | str, optional): Директория, содержащая CSV файлы для обучения. По умолчанию `None`.
*   `data_file` (Path | str, optional): Путь к одному CSV файлу с данными для обучения. По умолчанию `None`.
*   `positive` (bool, optional): Указывает, являются ли данные положительными или отрицательными. По умолчанию `True`.

**Возвращает**:

*   `str | None`: ID задачи обучения или `None` в случае ошибки.

**Как работает функция**:

1.  Определяет директорию с данными для обучения.
2.  Загружает данные из файла или директории.
3.  Отправляет данные в OpenAI API для обучения модели.
4.  Логирует ID задачи обучения.
5.  В случае ошибки логирует ошибку и возвращает `None`.

```
Определение директории с данными → Загрузка данных → Отправка данных в API → Логирование ID задачи
```

**Примеры**:

```python
model = OpenAIModel(api_key="YOUR_API_KEY")
job_id = model.train(data_file="path/to/training_data.csv", positive=True)
print(job_id)
```

### `save_job_id`

```python
def save_job_id(self, job_id: str, description: str, filename: str = "job_ids.json"):
```

**Назначение**: Сохраняет ID задачи обучения с описанием в файл.

**Параметры**:

*   `job_id` (str): ID задачи обучения.
*   `description` (str): Описание задачи.
*   `filename` (str, optional): Имя файла для сохранения. По умолчанию `"job_ids.json"`.

**Как работает функция**:

1.  Формирует данные о задаче обучения.
2.  Проверяет, существует ли файл для сохранения.
3.  Если файл не существует, создает его и сохраняет данные.
4.  Если файл существует, загружает существующие данные, добавляет новые данные и сохраняет все данные в файл.

```
Формирование данных о задаче → Проверка существования файла → Сохранение данных в файл
```

**Примеры**:

```python
model = OpenAIModel(api_key="YOUR_API_KEY")
model.save_job_id("job_123", "Training model with new data", filename="job_ids.json")
```

### `main`

```python
def main():
```

**Назначение**: Главная функция для инициализации `OpenAIModel` и демонстрации использования.

**Как работает функция**:

1.  Инициализирует модель `OpenAIModel` с системной инструкцией и ID ассистента.
2.  Выводит список доступных моделей.
3.  Выводит список доступных ассистентов.
4.  Отправляет вопрос модели и выводит ответ.
5.  Выполняет динамическое обучение модели.
6.  Обучает модель, используя данные из файла.
7.  Сохраняет ID задачи обучения.
8.  Описывает изображение.

```
Инициализация модели → Вывод списка моделей → Вывод списка ассистентов → Отправка вопроса → Динамическое обучение → Обучение модели → Сохранение ID задачи → Описание изображения
```

## Примеры

```python
# Инициализация модели
model = OpenAIModel(api_key="YOUR_API_KEY", system_instruction="You are a helpful assistant.")

# Получение списка моделей
models = model.list_models

# Получение списка ассистентов
assistants = model.list_assistants

# Отправка вопроса модели
response = model.ask("Hello, how are you?")

# Динамическое обучение модели
model.dynamic_train()

# Обучение модели
training_result = model.train(data_file="path/to/training_data.csv")

# Сохранение ID задачи обучения
model.save_job_id(training_result, "Training model with new data", filename="job_ids.json")

# Описание изображения
image_path = "path/to/image.jpg"
description = model.describe_image(image_path)