## Анализ кода `hypotez/src/endpoints/bots/telegram/movie_bot-main/apps/search.py`

### 1. <алгоритм>

**Блок-схема:**

```mermaid
graph TD
    A[Начало] --> B{Загрузка переменных окружения из .env};
    B --> C{Определение `search_query(query, type_movie='series')`};
    C --> D{Формирование поискового запроса `term` для Google};
    D --> E{Выполнение GET запроса к Google с User-Agent и параметрами поиска};
    E --> F{Парсинг HTML ответа с помощью BeautifulSoup};
    F --> G{Поиск всех блоков `div` с классом `g`};
    G --> H{Проверка наличия найденных блоков};
    H -- Да --> I{Перебор найденных блоков};
    I --> J{Поиск ссылки `<a>`, заголовка `<h3>` и описания `<div>` в текущем блоке};
    J --> K{Проверка наличия ссылки, заголовка и описания};
    K -- Да --> L{Проверка, является ли предпоследний элемент ссылки числом};
    L -- Да --> M{Формирование словаря с данными и возврат его};
    M --> O[Конец, возвращается словарь с данными];
    L -- Нет --> I;    
    K -- Нет --> I;
    H -- Нет --> N{Возврат `None`};
    N --> O;
    I -- Закончил --> N;
    O --> P{Вызов `search_query` с тестовым запросом и вывод результата при запуске скрипта};
    P --> Q[Конец программы];
```

**Примеры для логических блоков:**

*   **B:** Загрузка переменных окружения из файла `.env`. Например, если в `.env` есть `API_KEY=12345`, то эта переменная будет доступна в скрипте.
*   **D:** `query = "Игра престолов"`, `type_movie = "series"`. Результат: `term = "site:www.kinopoisk.ru/series Игра престолов"`.
*   **E:** Выполняется GET-запрос к `https://www.google.com/search` с параметрами `{"q": "site:www.kinopoisk.ru/series Игра престолов", "hl": "ru"}` и User-Agent, полученным из функции `get_useragent()`.
*   **F:**  HTML ответ, полученный от Google, передается в `BeautifulSoup` для парсинга.
*   **G:** Находит все блоки `div` с классом `g`, каждый из которых обычно представляет результат поиска Google.
*   **J:** Внутри блока ищется тег `<a>` (ссылка), тег `<h3>` (заголовок), и тег `<div>` с `style="-webkit-line-clamp:2"` (описание).
*   **L:**  `link["href"]` может быть вида `https://www.kinopoisk.ru/series/123456/`. `link["href"].split("/")` разделит строку на `['https:', '', 'www.kinopoisk.ru', 'series', '123456', '']`.  `link["href"].split("/")[-2]` вернет `'123456'`, которое должно быть числом.
*   **M:** Если все условия соблюдены, формируется словарь: `{'link': 'https://w2.kpfr.wiki/series/123456', 'title': 'Игра престолов (сериал, 8 сезонов)', 'description': 'Эпическая сага о борьбе за власть...'}`, где `123456` - это `id` фильма.
*   **N:** Если не найдено ни одного подходящего результата или если не найдены ссылка, заголовок или описание, функция возвращает `None`.
*   **P:** Вызов `search_query('теория большого взрыва')` и печать результата.

### 2. <mermaid>

```mermaid
flowchart TD
    A[Start] --> B(load_dotenv());
    B --> C{search_query(query, type_movie='series')};
    C --> D[Формирование поискового запроса term];
    D --> E{get(url, headers, params, timeout)};
    E --> F(BeautifulSoup(resp.text, "html.parser"));
    F --> G{Поиск div.g};
    G --> H{if result_block};
    H -- Yes --> I{for result in result_block};
    I --> J{Поиск a, h3, div};
    J --> K{if link and title and description};
    K -- Yes --> L{if link["href"].split("/")[-2].isdigit()};
    L -- Yes --> M[Формирование и возврат словаря];
    L -- No --> I;
    K -- No --> I;
    H -- No --> N[Возврат None];
    I -- Закончил --> N;
    N --> O[End];
     M --> O;
    O --> P{if __name__ == '__main__'};
    P --> Q{print(search_query('теория большого взрыва'))};
    Q --> R[End Program];
    
    style B fill:#f9f,stroke:#333,stroke-width:2px
    style E fill:#ccf,stroke:#333,stroke-width:2px
    style F fill:#ccf,stroke:#333,stroke-width:2px
```

**Анализ зависимостей:**

*   **`os`**: Стандартная библиотека Python, используется не напрямую в этом коде, но может использоваться внутри загрузки переменных окружения `load_dotenv()`, которая его импортирует.
*   **`bs4` (BeautifulSoup)**: Используется для парсинга HTML, полученного от Google.
*   **`dotenv`**: Библиотека для загрузки переменных окружения из файла `.env`.
*   **`requests`**: Библиотека для выполнения HTTP-запросов, используется для отправки запроса к Google.
*   `apps.useragent.get_useragent()`: Функция из модуля `useragent.py` для получения случайного user-agent, чтобы имитировать браузерный запрос.

### 3. <объяснение>

**Импорты:**

*   `import os`: Библиотека `os` предоставляет функции для взаимодействия с операционной системой. Она может использоваться внутри `load_dotenv()` для поиска и загрузки файла `.env`.
*   `from bs4 import BeautifulSoup`: Импортирует класс `BeautifulSoup` из библиотеки `bs4`, которая используется для парсинга HTML и XML.
*   `from dotenv import load_dotenv`: Импортирует функцию `load_dotenv` из библиотеки `python-dotenv`, которая используется для загрузки переменных окружения из файла `.env` в переменные окружения.
*   `from requests import get`: Импортирует функцию `get` из библиотеки `requests`, которая используется для отправки HTTP GET запросов.
*   `from apps.useragent import get_useragent`: Импортирует функцию `get_useragent` из пользовательского модуля `apps.useragent`. Эта функция возвращает случайный user-agent для имитации браузера.

**Функция `search_query`:**

*   **Аргументы:**
    *   `query`: строка, поисковый запрос (например, "Игра престолов").
    *   `type_movie`: строка, тип контента ("series" по умолчанию или "movie").
*   **Назначение:** Выполняет поиск на Google по сайту `kinopoisk.ru` для заданного запроса и типа контента. Возвращает словарь с ссылкой, заголовком и описанием первого найденного релевантного результата или `None`, если результат не найден.
*   **Логика:**
    1.  Формирует поисковый запрос `term` для Google, включая директиву `site:` для поиска только на `www.kinopoisk.ru`.
    2.  Выполняет GET-запрос к Google с использованием случайного User-Agent и параметров поиска.
    3.  Парсит HTML ответ с помощью `BeautifulSoup`.
    4.  Находит все блоки `div` с классом `g` (результаты поиска).
    5.  Для каждого найденного блока ищет ссылку `<a>`, заголовок `<h3>` и описание `<div>`.
    6.  Проверяет, что все три элемента найдены.
    7.  Проверяет, что предпоследняя часть URL ссылки является числом (обычно это ID фильма/сериала).
    8.  Если все проверки пройдены, формирует словарь с:
        *   `link`:  ссылка в формате `https://w2.kpfr.wiki/{type_movie}/{id}`, где id это число из ссылки `kinopoisk.ru`
        *   `title`: текст из заголовка `<h3>`.
        *   `description`: текст из описания `<div>`, обрезанный до конца + "..."
    9.  Возвращает сформированный словарь или `None`, если ничего не найдено.
*   **Возвращаемое значение:** Словарь с данными о фильме/сериале (ссылка, заголовок, описание) или `None`.
*   **Пример:**
    `search_query("Игра престолов", type_movie="series")` может вернуть:
    ```python
    {
        'link': 'https://w2.kpfr.wiki/series/123456',
        'title': 'Игра престолов (сериал, 8 сезонов)',
        'description': 'Эпическая сага о борьбе за власть...'
    }
    ```

**Переменные:**

*   `term`: Строка, сформированный поисковый запрос для Google.
*   `resp`: Объект `Response` от библиотеки `requests`, содержащий ответ от сервера Google.
*   `soup`: Объект `BeautifulSoup`, представляющий HTML-документ для парсинга.
*   `result_block`: Список объектов `Tag` от `BeautifulSoup`, представляющих блоки результатов поиска.
*   `link`, `title`, `description`: Объекты `Tag` от `BeautifulSoup`, представляющие соответствующие элементы в блоке результатов.

**Потенциальные ошибки и области для улучшения:**

*   **Обработка ошибок:** Код не обрабатывает возможные ошибки при выполнении запроса к Google (например, сетевые ошибки или таймауты). Рекомендуется добавить обработку исключений (`try...except`) для более надежной работы.
*   **Изменения в структуре HTML Google:** Структура HTML страниц Google может меняться, что может привести к поломке парсинга. Желательно использовать более надежные способы парсинга или отслеживать изменения структуры.
*   **Зависимость от w2.kpfr.wiki**: Код жестко привязан к формату ссылок `w2.kpfr.wiki`.
*   **User-Agent:** Использование случайного user-agent может помочь обойти ограничения, но не гарантирует полной защиты от блокировки.
*   **Повторение кода**: Частичное дублирование кода в случае поиска серии или фильма. Это можно вынести в отдельную функцию.
*   **Использование f-string**: При конкатенации строк, для большего удобства и читаемости можно использовать f-string.
*   **Тестирование**: Не хватает автоматизированных тестов.

**Взаимосвязи с другими частями проекта:**

*   Данный скрипт предназначен для получения информации о фильмах/сериалах с помощью поиска Google и преобразования этой информации в формат, удобный для использования ботом.
*   Результаты работы этого скрипта могут использоваться в другом модуле проекта для отправки сообщений в Telegram боте.

**Дополнительно:**
В коде нет импорта `import header`, поэтому блок `mermaid` для `header.py` не требуется.