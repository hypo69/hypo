# Документация модуля `fast_api`

## Обзор

Этот модуль предоставляет компоненты для создания и управления FastAPI серверами через удаленный вызов процедур (RPC) с использованием библиотеки `xmlrpc`. Модуль состоит из серверной (`fast_api_rpc.py`) и клиентской (`main.py`) частей, обеспечивающих гибкое управление серверами извне.

## Подробнее

Модуль позволяет управлять FastAPI серверами удаленно, разделяя логику управления сервером и пользовательский интерфейс. Это достигается за счет использования XML-RPC для взаимодействия между процессами.

## Основные компоненты:

### `fast_api_rpc.py` (серверная часть)

#### `FastApiServer`

**Описание**: Класс, содержащий логику для запуска FastAPI-сервера. Отвечает за создание и настройку веб-сервера, а также за добавление новых маршрутов.

#### `CommandHandler`

**Описание**: Класс, управляющий вызовами функций управления сервером.

**Принцип работы**:
Класс предоставляет методы для управления сервером, которые могут вызываться удаленно через XML-RPC. Включает в себя функции запуска, остановки, получения статуса серверов, добавления новых маршрутов и завершения работы сервера. Экземпляр `SimpleXMLRPCServer` создается для прослушивания запросов на порту `9000` (по умолчанию). XML-RPC сервер запускается в отдельном потоке, что позволяет ему работать параллельно с остальным кодом.

**Методы**:
- `__init__(self)`:
    - **Назначение**: Инициализирует класс `CommandHandler`, создает и запускает XML-RPC сервер.
    - **Как работает функция**:
    1. Создается экземпляр `SimpleXMLRPCServer`, который начинает прослушивать запросы на порту `9000`.
    2. Регистрируются все методы класса для удаленного вызова.
    3. Запускается XML-RPC сервер в отдельном потоке.
    ```
    Создание SimpleXMLRPCServer --> Регистрация методов --> Запуск сервера в отдельном потоке
    ```
- `register_instance(self)`:
    - **Назначение**: Делает все методы экземпляра класса доступными для удаленного вызова через XML-RPC.
- `start_server(self, port: int, host: str)`:
    - **Назначение**: Запускает FastAPI сервер на указанном порту и хосте.
- `stop_server(self, port: int)`:
    - **Назначение**: Останавливает FastAPI сервер на указанном порту.
- `stop_all_servers(self)`:
    - **Назначение**: Останавливает все запущенные FastAPI серверы.
- `status_servers(self)`:
    - **Назначение**: Возвращает статус всех FastAPI серверов.
- `add_new_route(self, port: int, path: str, response: str)`:
    - **Назначение**: Добавляет новый маршрут к указанному FastAPI серверу.
- `shutdown(self)`:
    - **Назначение**: Завершает работу XML-RPC сервера.

### `main.py` (клиентская часть)

#### `ServerProxy`

**Описание**: Класс из библиотеки `xmlrpc.client`, используемый для создания объекта, через который можно вызывать методы XML-RPC сервера.

#### Цикл `while True`

**Описание**: Основной цикл, отображающий меню доступных команд, запрашивающий ввод пользователя, парсящий введенную строку и вызывающий соответствующий метод RPC-сервера.

**Принцип работы**:
Клиентская часть предоставляет пользовательский интерфейс для отправки команд на сервер. Использует `ServerProxy` для установления соединения с XML-RPC сервером и вызова удаленных методов.

## Взаимодействие между компонентами:

1. **Запуск `fast_api_rpc.py`**:
   - Создается экземпляр `CommandHandler`.
   - В конструкторе `CommandHandler` создается XML-RPC сервер, который начинает прослушивать порт `9000`.
   - Запускается FastAPI-сервер(ы) в соответствии с кодом, который мы создали.
2. **Запуск `main.py`**:
   - Создается экземпляр `CommandHandler` (но он не играет роли, поскольку в `main.py` используется только RPC-клиент).
   - Создается `ServerProxy`, который подключается к XML-RPC серверу по адресу `http://localhost:9000`.
   - `main.py` начинает показывать меню и ожидать ввода пользователя.
3. **Ввод команды**:
   - `main.py` анализирует введенную строку, выделяет команду и порт.
   - `main.py` вызывает метод RPC-сервера через объект `rpc_client`.
4. **Обработка запроса на сервере**:
   - XML-RPC клиент `rpc_client` создает XML-сообщение, которое отправляет на сервер `fast_api_rpc.py`.
   - XML-RPC сервер в `fast_api_rpc.py` получает этот запрос.
   - Вызывается соответствующий метод у объекта `CommandHandler`.
5. **Возврат ответа**:
   - XML-RPC сервер формирует ответ и отправляет его обратно клиенту `main.py`.
6. **Отображение результата**:
   - `main.py` отображает результат в консоль.
7. **Повторение цикла**:
   - `main.py` возвращается к началу цикла, отображая меню и ожидая ввода следующей команды.

## Преимущества данного подхода:

*   **Управление сервером из другой программы**: Возможность контролировать запущенный сервер через другой процесс или даже с другой машины.
*   **Разделение кода**: Логика управления сервером и пользовательский интерфейс разделены, что делает код более модульным и легким в обслуживании.
*   **Гибкость**: Возможность добавления новых методов управления сервером, которые автоматически становятся доступными через RPC.