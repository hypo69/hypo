# Модуль `src.utils.smtp`

## Обзор

Модуль `src.utils.smtp` предоставляет интерфейс для отправки и получения электронных писем с использованием протоколов SMTP и IMAP. Он включает функции для отправки электронных писем через SMTP и получения электронных писем через IMAP.

## Подробнее

Модуль предназначен для обеспечения возможности взаимодействия с электронной почтой из других частей проекта `hypotez`. Он использует модуль `smtplib` для отправки писем и модуль `imaplib` для их получения. Важно отметить, что учетные данные для доступа к SMTP и IMAP серверам должны передаваться через переменные окружения, а не быть жестко закодированными в коде. Это необходимо для обеспечения безопасности и гибкости конфигурации.

## Функции

### `send`

```python
def send(subject: str = '', body: str = '', to: str = 'one.last.bit@gmail.com') -> bool:
    """
    Args:
        subject (str, optional): Тема письма. По умолчанию ''.
        body (str, optional): Тело письма. По умолчанию ''.
        to (str, optional): Адрес получателя. По умолчанию 'one.last.bit@gmail.com'.

    Returns:
        bool: `True`, если письмо успешно отправлено, `False` в противном случае.

    Raises:
        Exception: В случае возникновения ошибки при отправке письма.

    **Как работает функция**:
    Функция `send` отправляет электронное письмо через SMTP-сервер. Сначала она устанавливает соединение с SMTP-сервером, используя данные из словаря `_connection`. Затем она создает MIME-сообщение с указанной темой и телом, и отправляет его указанному получателю. В случае возникновения ошибки, она логируется с использованием `logger.error`.

    ```
    +---------------------+
    |  Начало функции     |
    +---------------------+
         |
         V
    +---------------------+
    |  Создание SMTP      |
    |  соединения         |
    +---------------------+
         |
         V
    +---------------------+
    |  Настройка TLS       |
    |  и аутентификация   |
    +---------------------+
         |
         V
    +---------------------+
    |  Создание MIME       |
    |  сообщения          |
    +---------------------+
         |
         V
    +---------------------+
    |  Отправка письма     |
    +---------------------+
         |
         V
    +---------------------+
    |  Завершение          |
    |  соединения         |
    +---------------------+
         |
         V
    +---------------------+
    |  Обработка ошибок    |
    +---------------------+
         |
         V
    +---------------------+
    |  Конец функции       |
    +---------------------+
    ```
    """
```

**Описание**: Отправляет электронное письмо. Возвращает `True` в случае успеха, `False` в противном случае. Логирует ошибки.

**Параметры**:
- `subject` (str, optional): Тема письма. По умолчанию пустая строка.
- `body` (str, optional): Тело письма. По умолчанию пустая строка.
- `to` (str, optional): Адрес электронной почты получателя. По умолчанию 'one.last.bit@gmail.com'.

**Возвращает**:
- `bool`: `True`, если письмо успешно отправлено, `False` в противном случае.

**Вызывает исключения**:
- `Exception`: Возникает при любых ошибках, связанных с отправкой электронной почты.

**Примеры**:

```python
from src.utils.smtp import send

# Пример отправки письма с указанием темы и тела
success = send(subject='Тестовое письмо', body='Это тестовое письмо.', to='test@example.com')
if success:
    print('Письмо успешно отправлено!')
else:
    print('Ошибка при отправке письма.')

# Пример отправки письма с использованием параметров по умолчанию
success = send()
if success:
    print('Письмо успешно отправлено!')
else:
    print('Ошибка при отправке письма.')
```

### `receive`

```python
def receive(imap_server: str, user: str, password: str, folder: str = 'inbox') -> Optional[List[Dict[str, str]]]:
    """
    Args:
        imap_server (str): Адрес IMAP-сервера.
        user (str): Имя пользователя для подключения к IMAP-серверу.
        password (str): Пароль для подключения к IMAP-серверу.
        folder (str, optional): Папка для чтения писем. По умолчанию 'inbox'.

    Returns:
        Optional[List[Dict[str, str]]]: Список словарей, представляющих электронные письма, или `None` в случае ошибки. Каждый словарь содержит ключи 'subject', 'from' и 'body'.

    Raises:
        Exception: В случае возникновения ошибки при получении писем.
    
    **Как работает функция**:
    Функция `receive` получает электронные письма из IMAP-сервера. Она подключается к IMAP-серверу, используя предоставленные учетные данные, выбирает указанную папку и извлекает все электронные письма. Затем она преобразует каждое электронное письмо в словарь, содержащий тему, отправителя и тело, и возвращает список этих словарей. В случае возникновения ошибки, она логируется с использованием `logger.error`.
    
    ```
    +---------------------+
    |  Начало функции     |
    +---------------------+
         |
         V
    +---------------------+
    |  Подключение к       |
    |  IMAP-серверу        |
    +---------------------+
         |
         V
    +---------------------+
    |  Аутентификация      |
    +---------------------+
         |
         V
    +---------------------+
    |  Выбор папки         |
    +---------------------+
         |
         V
    +---------------------+
    |  Поиск всех писем    |
    +---------------------+
         |
         V
    +---------------------+
    |  Извлечение данных   |
    |  из каждого письма   |
    +---------------------+
         |
         V
    +---------------------+
    |  Формирование списка |
    |  словарей            |
    +---------------------+
         |
         V
    +---------------------+
    |  Завершение          |
    |  соединения         |
    +---------------------+
         |
         V
    +---------------------+
    |  Обработка ошибок    |
    +---------------------+
         |
         V
    +---------------------+
    |  Конец функции       |
    +---------------------+
    ```
    """
```

**Описание**: Извлекает электронные письма. Возвращает список словарей, представляющих электронные письма, или `None` в случае ошибки. Логирует ошибки.

**Параметры**:
- `imap_server` (str): Адрес IMAP-сервера.
- `user` (str): Имя пользователя для подключения к IMAP-серверу.
- `password` (str): Пароль для подключения к IMAP-серверу.
- `folder` (str, optional): Папка для чтения писем. По умолчанию 'inbox'.

**Возвращает**:
- `Optional[List[Dict[str, str]]]`: Список словарей, представляющих электронные письма, или `None` в случае ошибки. Каждый словарь содержит ключи 'subject', 'from' и 'body'.

**Вызывает исключения**:
- `Exception`: Возникает при любых ошибках, связанных с получением электронной почты.

**Примеры**:

```python
from src.utils.smtp import receive

# Пример получения писем из папки "inbox"
emails = receive(imap_server='imap.example.com', user='test@example.com', password='password', folder='inbox')
if emails:
    for email in emails:
        print(f"Тема: {email['subject']}")
        print(f"От: {email['from']}")
        print(f"Тело: {email['body'][:100]}...")  # Вывод первых 100 символов тела письма
else:
    print('Ошибка при получении писем.')

# Пример получения писем из папки "Sent"
emails = receive(imap_server='imap.example.com', user='test@example.com', password='password', folder='Sent')
if emails:
    for email in emails:
        print(f"Тема: {email['subject']}")
        print(f"От: {email['from']}")
        print(f"Тело: {email['body'][:100]}...")  # Вывод первых 100 символов тела письма
else:
    print('Ошибка при получении писем.')