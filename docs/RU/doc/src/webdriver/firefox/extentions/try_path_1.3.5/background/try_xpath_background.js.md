# Фоновый скрипт расширения Try XPath

## Обзор

Этот скрипт является фоновым скриптом расширения Try XPath для Firefox. Он обрабатывает сообщения от других частей расширения, управляет стилями, результатами поиска и настройками.

## Оглавление

- [Обзор](#обзор)
- [Переменные](#переменные)
- [Функции](#функции)
  - [`loadDefaultCss`](#loaddefaultcss)
  - [`genericListener`](#genericlistener)
- [Слушатели сообщений](#слушатели-сообщений)
  - [`storePopupState`](#storepopupstate)
  - [`requestRestorePopupState`](#requestrestorepopupstate)
  - [`requestInsertStyleToPopup`](#requestinsertstyletopopup)
  - [`showAllResults`](#showallresults)
  - [`loadResults`](#loadresults)
  - [`updateCss`](#updatecss)
  - [`loadOptions`](#loadoptions)
  - [`requestSetContentInfo`](#requestsetcontentinfo)
- [Слушатель изменений в хранилище](#слушатель-изменений-в-хранилище)
- [Инициализация](#инициализация)

## Переменные

- `tx`: Псевдоним для объекта `tryxpath`.
- `fu`: Псевдоним для объекта `tryxpath.functions`.
- `popupState`: Состояние всплывающего окна.
- `popupCss`: CSS для всплывающего окна.
- `results`: Объект для хранения результатов поиска.
- `css`: CSS для вставки в страницу.
- `attributes`: Объект с именами атрибутов данных, используемых для разметки элементов на странице.

## Функции

### `loadDefaultCss`

**Описание**: Загружает CSS из файла `/css/try_xpath_insert.css`.

**Возвращает**:
- `Promise<string>`: Промис, который разрешается с текстом CSS.

### `genericListener`

**Описание**: Общий слушатель сообщений от других частей расширения. Вызывает соответствующую функцию в зависимости от события.

**Параметры**:
- `message` (object): Объект сообщения, отправленный из другой части расширения.
- `sender` (object): Объект, содержащий информацию об отправителе сообщения.
- `sendResponse` (function): Функция для отправки ответа на сообщение.

## Слушатели сообщений

### `storePopupState`

**Описание**: Сохраняет состояние всплывающего окна.

**Параметры**:
- `message` (object): Объект сообщения, содержащий состояние всплывающего окна.

### `requestRestorePopupState`

**Описание**: Отправляет сообщение с запросом на восстановление состояния всплывающего окна.

### `requestInsertStyleToPopup`

**Описание**: Отправляет сообщение с запросом на вставку CSS во всплывающее окно.

### `showAllResults`

**Описание**: Сохраняет результаты поиска и открывает страницу с результатами.

**Параметры**:
- `message` (object): Объект сообщения, содержащий результаты поиска.
- `sender` (object): Объект, содержащий информацию об отправителе сообщения.

### `loadResults`

**Описание**: Отправляет сохраненные результаты поиска в ответ на запрос.

**Параметры**:
- `message` (object): Объект сообщения.
- `sender` (object): Объект, содержащий информацию об отправителе сообщения.
- `sendResponse` (function): Функция для отправки ответа на сообщение.

**Возвращает**:
- `true`: Необходимо для асинхронного ответа.

### `updateCss`

**Описание**: Удаляет старый и вставляет новый CSS на страницу.

**Параметры**:
- `message` (object): Объект сообщения, содержащий информацию об удаляемых стилях.
- `sender` (object): Объект, содержащий информацию об отправителе сообщения.

### `loadOptions`

**Описание**: Отправляет текущие настройки расширения.

**Параметры**:
- `message` (object): Объект сообщения.
- `sender` (object): Объект, содержащий информацию об отправителе сообщения.
- `sendResponse` (function): Функция для отправки ответа на сообщение.

**Возвращает**:
- `true`: Необходимо для асинхронного ответа.

### `requestSetContentInfo`

**Описание**: Отправляет сообщение с запросом на установку информации о контенте.

**Параметры**:
- `message` (object): Объект сообщения.
- `sender` (object): Объект, содержащий информацию об отправителе сообщения.

## Слушатель изменений в хранилище

**Описание**: Обновляет переменные `attributes`, `css` и `popupCss` при их изменении в хранилище.

## Инициализация

**Описание**: Загружает настройки из хранилища и устанавливает начальные значения `attributes`, `css` и `popupCss`. Загружает CSS по умолчанию, если в хранилище нет сохраненного CSS.