# `executor.py` — инструмент для работы с веб-элементами.
   
   Он использует конфигурации в виде локаторов (например, из `product.json`) и выполняет на их основе действия, предоставляя гибкость и возможность повторного использования кода. Он включает в себя множество настроек для более тонкого управления процессом работы с браузером.

**1. Основная идея:**

   -   `executor.py` предоставляет класс `ExecuteLocator`, который используется для взаимодействия с веб-элементами на странице.
   -   Он получает инструкции из локаторов (например, из `product.json`) и выполняет соответствующие действия.
   -   Локатор — это словарь (или `SimpleNamespace`), содержащий информацию о том, как найти элемент и что с ним делать (извлечь атрибут, кликнуть, ввести текст и т.д.).

**2. Ключевые компоненты:**

   -   **`ExecuteLocator` class:**
        -   `driver`: Экземпляр веб-драйвера (например, Chrome, Firefox, Edge, Playwright).
        -   `actions`: Объект `ActionChains` для выполнения сложных действий (например, ввод текста с зажатыми клавишами).
        -   `by_mapping`: Словарь для преобразования строковых значений `by` в константы `selenium.webdriver.common.by.By` (например, "XPATH" -> `By.XPATH`).
        -   `execute_locator`: Главный метод, который принимает локатор и выполняет действия с элементом.
        -   `evaluate_locator`: Метод для оценки значений атрибутов, чтобы при необходимости извлекать значения клавишь.
        -   `get_attribute_by_locator`: Метод для получения значений атрибутов элемента.
        -   `get_webelement_by_locator`: Метод для получения веб-элемента(ов) по локатору.
        -   `get_webelement_as_screenshot`: Метод для получения скриншота элемента.
        -   `execute_event`: Метод для выполнения событий (клик, пауза, ввод текста и т.д.).
        -   `send_message`: Метод для ввода текста в элемент.

   -   **Локаторы (из `product.json`):**
        -   `attribute`: Атрибут элемента, который нужно извлечь. Может быть строкой (имя атрибута, как `innerText`, `value`), или словарём с парами ключ значение `{src:alt}`.
        -   `by`: Тип локатора (`XPATH`, `ID`, `CSS_SELECTOR` и т.д. или `VALUE`, для присвоения значения, указанного в `attribute`).
        -   `selector`: Селектор для поиска элемента (например, XPath-выражение, CSS-селектор).
        -   `if_list`: Правило для обработки списка элементов (если их несколько) - `first`, `last`, `all`, `even`, `odd`.
        -   `use_mouse`: Признак использовать ли мышь или нет.
        -   `timeout`: Время ожидания элемента.
        -   `timeout_for_event`: Тип ожидания (`presence_of_element_located`, `element_to_be_clickable`).
        -   `event`: Событие, которое нужно выполнить (`click()`, `screenshot()`, `send_keys()`).
        -    `logic for attribue[AND|OR|XOR|VALUE|null]`: логика для работы с атрибутом. (не реализовано)
         -    `logic for action[AND|OR|XOR|VALUE|null]`: логика для работы с событием. (не реализовано)
        -   `mandatory`: Является ли обязательным для выполнения или нет.
        -   `locator_description`: Описание локатора.
**3. Разбор логики работы `ExecuteLocator`:**

   -   **`execute_locator(locator, ...)`:**
        -   Принимает локатор (как словарь или SimpleNamespace).
        -   Преобразует локатор к `SimpleNamespace`, если это обычный словарь.
        -   Проверяет, есть ли `attribute`, `event`, или `mandatory` (если нет - это локатор заглушка и он возвращает `None`).
        -   Вызывает `_parse_locator(locator, message)` для обработки локатора.
   -  **`_parse_locator(locator, message)`:**
        -   Проверяет наличие `event`, `attribute` или `mandatory` (если нет - это локатор заглушка и он возвращает `None`).
        -   Пытается получить значение атрибута. Если указан `by='VALUE'` - сразу возвращает значение.
        -   Если указано `event`  -  вызывает `execute_event`.
        -   Если указано `attribute` - вызывает `get_attribute_by_locator`.
         -   Иначе пытается получить web element по локатору `get_webelement_by_locator`
   -   **`evaluate_locator(attribute)`:**
        -   Принимает атрибут.
        -   Ищет в строке паттерн вида `%KEY%` и заменяет его на значение константы из библиотеки `selenium.webdriver.common.keys.Keys`
        -   Возвращает строковое значение атрибута.
        -   Если `attribute` это список - обходит его рекурсивно.
   -   **`get_attribute_by_locator(locator, ...)`:**
        -   Получает веб-элемент(ы) через `get_webelement_by_locator`.
        -   Если элемент(ы) не найдены, возвращает `None`.
        -   Если `locator.attribute` начинается с `"{",` то пытается распарсить строку как словарь `{attr1:attr2}`.
        -    Если  `web_element` это список - возвращает атрибуты каждого элемента.
        -   Возвращает значение атрибута(ов) элемента(ов).
   -   **`get_webelement_by_locator(locator, timeout, timeout_for_event)`:**
        -   Принимает локатор и таймаут.
        -   Если `timeout = 0` пытается сразу найти элемент(ы).
        -   Если `timeout > 0`, то ожидает появления элемента(ов) с помощью `WebDriverWait`, используя указанное условие `timeout_for_event`.
        -   Возвращает список элементов если `if_list == 'all'`,  иначе первый, последний, чётные или не чётные элементы, в зависимости от значения `locator.if_list`.
   -   **`get_webelement_as_screenshot(locator, ...)`:**
        -   Получает веб-элемент с помощью `get_webelement_by_locator`.
        -   Делает скриншот элемента.
        -   Возвращает поток байтов (png) со скриншотом элемента.
   -   **`execute_event(locator, ...)`:**
        -   Выполняет события, перечисленные в `locator.event` (может быть несколько событий через `;`).
        -   Поддерживает события:
            -   `click()`: Кликает на элемент.
            -   `pause(N)`: Пауза на N секунд.
            -   `upload_media()`: Отправляет файл через `send_keys` (требуется `message`).
            -   `screenshot()`: Делает скриншот элемента через `get_webelement_as_screenshot`.
            -   `clear()`: Очищает поле ввода.
            -   `send_keys()`: Отправляет клавиши (комбинации клавиш).
            -   `type()`: Вводит текст.
        -   Возвращает результат выполнения события.
   -   **`send_message(locator, ...)`:**
        -   Получает веб-элемент с помощью `get_webelement_by_locator`.
         -   Вызывает  `type_message`, для ввода текста.
         -   Возвращает  `True` в случае успешного выполнения, или `None` если элемент не был найден.
**4. Как это работает с `product.json`:**

   -   `product.json` содержит набор локаторов для каждого поля продукта.
   -   Когда нужно извлечь данные о продукте, код проходит по каждому локатору и вызывает `execute_locator` с соответствующим локатором.
   -   `execute_locator` на основе настроек выполняет действия с веб-элементами и возвращает результат.

**Пример:**

```json
  "id_manufacturer": {
    "attribute": "innerText",
    "by": "XPATH",
    "selector": "//span[@class = 'ltr sku-copy']",
    "if_list": "first",
    "use_mouse": false,
    "mandatory": true,
    "timeout": 0,
    "timeout_for_event": "presence_of_element_located",
    "event": null,
    "locator_description": "SKU manufacturer"
  },
```

   -   `attribute: "innerText"`: нужно получить текст элемента.
   -   `by: "XPATH"`: тип локатора — XPath.
   -   `selector: "//span[@class = 'ltr sku-copy']"`: XPath-выражение для поиска элемента.
   -   `if_list: "first"`: если таких элементов несколько, использовать первый.
   -   `event: null`: событие не выполняется
   -   `mandatory: true`: локатор обязателен к выполнению.

   - `executor`  найдет элемент по XPATH, получит его текст через `innerText` и вернёт результат.

**5. Основные преимущества:**

   -   **Гибкость:** Локаторы можно легко менять, не трогая основной код.
   -   **Удобство:** Единая логика для всех действий с элементами.
   -   **Переиспользуемость:** Методы класса `ExecuteLocator` можно использовать в разных контекстах.
   -   **Асинхронность:** Использование `asyncio` для неблокирующего выполнения операций.
   -   **Поддержка различных типов локаторов:** Можно использовать `XPATH`, `CSS`, `ID` и др.

