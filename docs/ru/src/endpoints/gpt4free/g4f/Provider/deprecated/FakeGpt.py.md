# Модуль `FakeGpt`

## Обзор

Модуль `FakeGpt` представляет собой асинхронный провайдер для взаимодействия с моделью `text-davinci-002-render-sha` через API `chat-shared2.zhile.io`. Он предназначен для генерации текста на основе предоставленных сообщений. Модуль использует асинхронные запросы для обеспечения неблокирующей работы.

## Подробней

Модуль `FakeGpt` предназначен для эмуляции работы с GPT моделями, используя API `chat-shared2.zhile.io`. Он выполняет следующие основные шаги:

1.  Получение токена доступа (`access_token`) и cookie, если они еще не установлены.
2.  Формирование запроса с использованием предоставленных сообщений и метаданных.
3.  Отправка запроса к API и получение ответа в виде потока событий (`event-stream`).
4.  Обработка каждого события для извлечения сгенерированного текста.
5.  Возврат сгенерированного текста как асинхронного генератора.

Этот модуль важен для интеграции с другими частями проекта, где требуется взаимодействие с GPT-подобными моделями, в частности для создания "фейковых" ответов или тестирования интеграции с внешними сервисами.

## Классы

### `FakeGpt`

**Описание**: Класс `FakeGpt` является асинхронным провайдером, который взаимодействует с API `chat-shared2.zhile.io` для генерации текста на основе предоставленных сообщений.

**Наследует**:

*   `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных генераторов.

**Атрибуты**:

*   `url` (str): URL-адрес API `chat-shared2.zhile.io`.
*   `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели `gpt-35-turbo`.
*   `working` (bool): Флаг, указывающий на работоспособность провайдера.
*   `_access_token` (Optional[str]): Токен доступа для аутентификации.
*   `_cookie_jar` (Optional[CookieJar]): Cookie jar для хранения cookie сессии.

**Методы**:

*   `create_async_generator()`: Создает асинхронный генератор для получения сгенерированного текста.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """ Создает асинхронный генератор для получения сгенерированного текста.

    Args:
        cls (FakeGpt): Ссылка на класс `FakeGpt`.
        model (str): Название модели для генерации текста.
        messages (Messages): Список сообщений для формирования запроса.
        proxy (Optional[str]): Адрес прокси-сервера (если требуется).
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий сгенерированный текст.

    Raises:
        RuntimeError: Если не получен валидный ответ от API.

    """
```

**Назначение**: Функция `create_async_generator` создает и возвращает асинхронный генератор, который позволяет получать текст, сгенерированный моделью `text-davinci-002-render-sha` через API `chat-shared2.zhile.io`. Она отвечает за аутентификацию, формирование запроса и обработку ответа от API.

**Параметры**:

*   `cls` (FakeGpt): Ссылка на класс `FakeGpt`.
*   `model` (str): Название модели для генерации текста.
*   `messages` (Messages): Список сообщений для формирования запроса.
*   `proxy` (Optional[str]): Адрес прокси-сервера (если требуется). По умолчанию `None`.
*   `**kwargs`: Дополнительные аргументы.

**Возвращает**:

*   `AsyncResult`: Асинхронный генератор, возвращающий сгенерированный текст.

**Вызывает исключения**:

*   `RuntimeError`: Если не получен валидный ответ от API.

**Как работает функция**:

1.  **Подготовка заголовков**: Функция начинает с подготовки необходимых HTTP-заголовков, включая `User-Agent`, `Referer` и `sec-ch-ua`.
2.  **Создание сессии**: Создается асинхронная сессия `ClientSession` с установленными заголовками и cookie jar.
3.  **Получение токена доступа**:
    *   Если токен доступа (`_access_token`) отсутствует, функция запрашивает список токенов с сервера.
    *   Выбирает случайный токен из списка.
    *   Выполняет аутентификацию с выбранным токеном.
    *   Получает токен доступа из сессии.
4.  **Формирование запроса**:
    *   Формирует JSON-запрос с использованием предоставленных сообщений и метаданных.
    *   Устанавливает необходимые заголовки, включая токен доступа.
5.  **Отправка запроса и обработка ответа**:
    *   Отправляет POST-запрос к API `chat-shared2.zhile.io` с сформированными данными и заголовками.
    *   Получает ответ в виде потока событий (`event-stream`).
    *   Обрабатывает каждое событие, извлекая сгенерированный текст.
    *   Возвращает текст через асинхронный генератор.
6.  **Обработка ошибок**:
    *   Если не получен валидный ответ, выбрасывается исключение `RuntimeError`.

```
    Начало
     │
     ├─► Проверка наличия access_token
     │    │
     │    ├─► Если access_token отсутствует:
     │    │    │
     │    │    ├─► Запрос списка токенов
     │    │    │
     │    │    ├─► Выбор случайного токена
     │    │    │
     │    │    ├─► Аутентификация с выбранным токеном
     │    │    │
     │    │    └─► Получение access_token
     │    │
     │    └─► Если access_token присутствует:
     │
     ├─► Формирование JSON-запроса
     │
     ├─► Отправка POST-запроса к API
     │
     ├─► Обработка потока событий (event-stream)
     │    │
     │    ├─► Извлечение сгенерированного текста из каждого события
     │    │
     │    └─► Возврат текста через асинхронный генератор
     │
     └─► Обработка ошибок
          │
          └─► Если не получен валидный ответ:
               │
               └─► Выброс исключения RuntimeError
```

**Примеры**:

```python
# Пример вызова функции create_async_generator
messages = [
    {"role": "user", "content": "Напиши короткий рассказ о космосе."}
]
async def main():
    generator = await FakeGpt.create_async_generator(model="text-davinci-002-render-sha", messages=messages)
    async for text in generator:
        print(text, end="")

# Запуск примера (необходимо для асинхронного кода)
# import asyncio
# asyncio.run(main())