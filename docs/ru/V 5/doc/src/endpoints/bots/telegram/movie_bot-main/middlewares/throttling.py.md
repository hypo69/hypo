# Модуль ThrottlingMiddleware

## Обзор

Модуль `ThrottlingMiddleware` предназначен для реализации механизма ограничения скорости (throttling) обработки входящих сообщений в Telegram-боте. Он предотвращает перегрузку бота за счет ограничения количества запросов от одного и того же пользователя в течение заданного периода времени.

## Подробней

Этот модуль предоставляет класс `ThrottlingMiddleware`, который является middleware для aiogram. Он использует `TTLCache` для хранения информации о том, когда пользователь в последний раз отправлял сообщение, и предотвращает обработку сообщений, если они отправляются слишком часто. Это полезно для защиты бота от злоупотреблений и для обеспечения стабильной работы.

## Классы

### `ThrottlingMiddleware`

**Описание**: Middleware для ограничения скорости обработки сообщений в Telegram-боте.

**Как работает класс**: Класс инициализируется с заданным временным лимитом `time_limit` (по умолчанию 2 секунды). Он использует `TTLCache` для хранения идентификаторов чатов и времени их последнего запроса. При каждом входящем сообщении проверяется, находится ли идентификатор чата в кэше. Если да, то сообщение не обрабатывается. Если нет, то идентификатор чата добавляется в кэш, и сообщение передается дальше по цепочке обработки.

**Методы**:
- `__init__`: Инициализирует экземпляр класса `ThrottlingMiddleware`.
- `__call__`: Вызывается при каждом входящем сообщении. Проверяет, следует ли обрабатывать сообщение, и передает его дальше по цепочке обработки.

#### `__init__`

```python
def __init__(self, time_limit: int = 2) -> None:
    """
    Инициализирует экземпляр класса ThrottlingMiddleware.

    Args:
        time_limit (int, optional): Временной лимит в секундах, в течение которого сообщения от одного и того же пользователя будут задерживаться. По умолчанию 2 секунды.

    Returns:
        None

    Raises:
        None
    """
    ...
```

**Описание**: Инициализирует экземпляр класса `ThrottlingMiddleware`.

**Как работает функция**: Функция принимает параметр `time_limit`, который определяет временной интервал, в течение которого сообщения от одного и того же пользователя будут ограничиваться. Она создает экземпляр `TTLCache` с максимальным размером 10000 элементов и временем жизни (ttl), равным `time_limit`.

**Параметры**:
- `time_limit` (int, optional): Временной лимит в секундах, в течение которого сообщения от одного и того же пользователя будут задерживаться. По умолчанию 2 секунды.

**Возвращает**:
- `None`

**Вызывает исключения**:
- Отсутствуют

**Примеры**:

```python
middleware = ThrottlingMiddleware(time_limit=3)
```

#### `__call__`

```python
async def __call__(
        self,
        handler: Callable[[Message, Dict[str, Any]], Awaitable[Any]],
        event: Message,
        data: Dict[str, Any]
) -> Any:
    """
    Вызывается при каждом входящем сообщении.

    Args:
        handler (Callable[[Message, Dict[str, Any]], Awaitable[Any]]): Обработчик сообщений.
        event (Message): Объект сообщения от Telegram.
        data (Dict[str, Any]): Дополнительные данные.

    Returns:
        Any: Результат обработки сообщения.

    Raises:
        None
    """
    ...
```

**Описание**: Вызывается при каждом входящем сообщении.

**Как работает функция**: Функция проверяет, находится ли идентификатор чата (`event.chat.id`) в кэше `self.limit`. Если идентификатор чата уже есть в кэше, это означает, что пользователь недавно отправлял сообщение, и текущее сообщение не обрабатывается (возвращается `None`). Если идентификатора чата нет в кэше, он добавляется в кэш, и сообщение передается дальше по цепочке обработки, вызывая `await handler(event, data)`.

**Параметры**:
- `handler` (Callable[[Message, Dict[str, Any]], Awaitable[Any]]): Обработчик сообщений.
- `event` (Message): Объект сообщения от Telegram.
- `data` (Dict[str, Any]): Дополнительные данные.

**Возвращает**:
- `Any`: Результат обработки сообщения.

**Вызывает исключения**:
- Отсутствуют

**Примеры**:

```python
async def my_handler(event: Message, data: Dict[str, Any]) -> None:
    print('Message processed')

middleware = ThrottlingMiddleware(time_limit=2)
result = await middleware(my_handler, event, data)
```