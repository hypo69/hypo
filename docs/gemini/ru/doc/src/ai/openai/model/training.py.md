# Модуль для работы с моделями OpenAI и их обучением

## Обзор

Модуль `training.py` предназначен для работы с OpenAI API, управления моделями и их обучения. Он включает в себя класс `OpenAIModel`, который предоставляет интерфейс для взаимодействия с OpenAI API, загрузки доступных моделей и ассистентов, настройки ассистентов, отправки сообщений моделям, выполнения динамической донастройки и обучения моделей на основе предоставленных данных.

## Подробней

Модуль содержит класс `OpenAIModel`, который используется для взаимодействия с OpenAI API и выполнения задач обучения моделей. Он позволяет загружать список доступных моделей и ассистентов, настраивать ассистентов, отправлять сообщения моделям и обучать их на основе предоставленных данных. Этот модуль важен для интеграции с OpenAI API в проекте `hypotez` и позволяет использовать модели OpenAI для различных задач.

## Классы

### `OpenAIModel`

**Описание**: Класс `OpenAIModel` предназначен для взаимодействия с OpenAI API и управления моделями.

**Принцип работы**:
Класс инициализируется с API-ключом, системной инструкцией и ID ассистента. Он загружает доступные модели и ассистентов, а также предоставляет методы для настройки ассистентов, отправки сообщений моделям, выполнения динамической донастройки и обучения моделей на основе предоставленных данных.

**Аттрибуты**:
- `model` (str): Имя используемой модели OpenAI (по умолчанию "gpt-4o-mini").
- `client` (OpenAI): Клиент OpenAI для взаимодействия с API.
- `current_job_id` (str): ID текущей задачи обучения.
- `assistant_id` (str): ID используемого ассистента.
- `assistant` (Any): Объект ассистента, полученный из OpenAI API.
- `thread` (Any): Объект треда, используемый для общения с ассистентом.
- `system_instruction` (str): Системная инструкция для модели.
- `dialogue_log_path` (str | Path): Путь к файлу для сохранения истории диалога.
- `dialogue` (List[Dict[str, str]]): Список сообщений в диалоге.
- `assistants` (List[SimpleNamespace]): Список доступных ассистентов.
- `models_list` (List[str]): Список доступных моделей.

**Методы**:
- `__init__`: Инициализирует объект `OpenAIModel` с API-ключом, системной инструкцией и ID ассистента.
- `list_models`: Динамически получает и возвращает доступные модели из OpenAI API.
- `list_assistants`: Динамически загружает доступных ассистентов из JSON-файла.
- `set_assistant`: Устанавливает ассистента, используя предоставленный ID.
- `_save_dialogue`: Сохраняет весь диалог в JSON-файл.
- `determine_sentiment`: Определяет тональность сообщения (положительная, отрицательная или нейтральная).
- `ask`: Отправляет сообщение модели и возвращает ответ вместе с анализом тональности.
- `describe_image`: Отправляет изображение в OpenAI API и получает описание.
- `describe_image_by_requests`: Отправляет изображение в OpenAI API, используя библиотеку requests, и получает описание.
- `dynamic_train`: Динамически загружает предыдущий диалог и донастраивает модель на его основе.
- `train`: Обучает модель на основе указанных данных или каталога.
- `save_job_id`: Сохраняет ID задачи обучения с описанием в файл.

## Функции

### `__init__`

```python
def __init__(self, api_key:str, system_instruction: str = None, model_name:str = 'gpt-4o-mini', assistant_id: str = None):
```

**Назначение**: Инициализация объекта `OpenAIModel` с API-ключом, системной инструкцией и ID ассистента.

**Параметры**:
- `api_key` (str): API-ключ для доступа к OpenAI API.
- `system_instruction` (str, optional): Системная инструкция для модели. По умолчанию `None`.
- `model_name` (str, optional): Имя модели для использования. По умолчанию 'gpt-4o-mini'.
- `assistant_id` (str, optional): ID ассистента. По умолчанию ID ассистента code_assistant, хранящийся в `gs.credentials.openai.assistant_id`.

**Возвращает**:
- `None`

**Как работает функция**:

1.  Инициализирует клиент OpenAI с использованием предоставленного API-ключа.
2.  Устанавливает ID текущей задачи (`current_job_id`) в `None`.
3.  Устанавливает ID ассистента (`assistant_id`) либо на предоставленный, либо на значение по умолчанию из `gs.credentials.openai.assistant_id.code_assistant`.
4.  Сохраняет системную инструкцию (`system_instruction`).
5.  Загружает ассистента и создает новый тред для взаимодействия с ним через OpenAI API.

```
Инициализация клиента OpenAI  -> Установка ID текущей задачи
↓
Установка ID ассистента -> Сохранение системной инструкции
↓
Загрузка ассистента и создание нового треда
```

**Примеры**:

```python
model = OpenAIModel(api_key='your_api_key', system_instruction="You are a helpful assistant.", assistant_id="asst_your_assistant_id")
```

### `list_models`

```python
@property
def list_models(self) -> List[str]:
```

**Назначение**: Динамически получает и возвращает список доступных моделей из OpenAI API.

**Параметры**:
- `None`

**Возвращает**:
- `List[str]`: Список ID моделей, доступных через OpenAI API.

**Вызывает исключения**:
- `Exception`: Возникает, если происходит ошибка при загрузке моделей.

**Как работает функция**:

1.  Пытается получить список доступных моделей из OpenAI API с помощью `self.client.models.list()`.
2.  Извлекает ID каждой модели из полученных данных и сохраняет их в список `model_list`.
3.  Логирует список загруженных моделей с использованием `logger.info`.
4.  В случае возникновения ошибки логирует ошибку с использованием `logger.error` и возвращает пустой список.

```
Попытка получить список доступных моделей из OpenAI API
↓
Извлечение ID каждой модели из полученных данных
↓
Логирование списка загруженных моделей
↓
Обработка ошибок: логирование ошибки и возврат пустого списка
```

**Примеры**:

```python
models = model.list_models
pprint(models)
```

### `list_assistants`

```python
@property
def list_assistants(self) -> List[str]:
```

**Назначение**: Динамически загружает доступных ассистентов из JSON-файла.

**Параметры**:
- `None`

**Возвращает**:
- `List[str]`: Список имен ассистентов.

**Вызывает исключения**:
- `Exception`: Возникает, если происходит ошибка при загрузке ассистентов.

**Как работает функция**:

1.  Пытается загрузить доступных ассистентов из JSON-файла, используя `j_loads_ns`.
2.  Извлекает имена каждого ассистента из загруженных данных и сохраняет их в список `assistant_list`.
3.  Логирует список загруженных ассистентов с использованием `logger.info`.
4.  В случае возникновения ошибки логирует ошибку с использованием `logger.error` и возвращает пустой список.

```
Попытка загрузить список доступных ассистентов из JSON-файла
↓
Извлечение имен каждого ассистента из загруженных данных
↓
Логирование списка загруженных ассистентов
↓
Обработка ошибок: логирование ошибки и возврат пустого списка
```

**Примеры**:

```python
assistants = model.list_assistants
pprint(assistants)
```

### `set_assistant`

```python
def set_assistant(self, assistant_id: str):
```

**Назначение**: Устанавливает ассистента, используя предоставленный ID.

**Параметры**:
- `assistant_id` (str): ID ассистента, которого нужно установить.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `Exception`: Возникает, если происходит ошибка при установке ассистента.

**Как работает функция**:

1.  Пытается установить ID ассистента (`self.assistant_id`) на предоставленный `assistant_id`.
2.  Получает информацию об ассистенте из OpenAI API с помощью `self.client.beta.assistants.retrieve(assistant_id)`.
3.  Логирует успешную установку ассистента с использованием `logger.info`.
4.  В случае возникновения ошибки логирует ошибку с использованием `logger.error`.

```
Установка ID ассистента
↓
Получение информации об ассистенте из OpenAI API
↓
Логирование успешной установки ассистента
↓
Обработка ошибок: логирование ошибки
```

**Примеры**:

```python
model.set_assistant(assistant_id="asst_your_assistant_id")
```

### `_save_dialogue`

```python
def _save_dialogue(self):
```

**Назначение**: Сохраняет весь диалог в JSON-файл.

**Параметры**:
- `None`

**Возвращает**:
- `None`

**Как работает функция**:

1.  Сохраняет текущий диалог (`self.dialogue`) в JSON-файл, используя функцию `j_dumps` и путь к файлу `self.dialogue_log_path`.

```
Сохранение текущего диалога в JSON-файл
```

**Примеры**:

```python
model._save_dialogue()
```

### `determine_sentiment`

```python
def determine_sentiment(self, message: str) -> str:
```

**Назначение**: Определяет тональность сообщения (положительная, отрицательная или нейтральная).

**Параметры**:
- `message` (str): Сообщение для анализа.

**Возвращает**:
- `str`: Тональность сообщения ('positive', 'negative' или 'neutral').

**Как работает функция**:

1.  Приводит сообщение к нижнему регистру.
2.  Проверяет наличие позитивных слов в сообщении. Если есть, возвращает "positive".
3.  Проверяет наличие негативных слов в сообщении. Если есть, возвращает "negative".
4.  Проверяет наличие нейтральных слов в сообщении. Если есть, возвращает "neutral".
5.  Если ни одно из вышеперечисленных условий не выполнено, возвращает "neutral".

```
Приведение сообщения к нижнему регистру
↓
Проверка наличия позитивных слов в сообщении
↓
Проверка наличия негативных слов в сообщении
↓
Проверка наличия нейтральных слов в сообщении
↓
Возврат "neutral", если ни одно из условий не выполнено
```

**Примеры**:

```python
sentiment = model.determine_sentiment("This is a great message!")
print(sentiment)  # Вывод: positive
```

### `ask`

```python
def ask(self, message: str, system_instruction: str = None, attempts: int = 3) -> str:
```

**Назначение**: Отправляет сообщение модели и возвращает ответ вместе с анализом тональности.

**Параметры**:
- `message` (str): Сообщение для отправки модели.
- `system_instruction` (str, optional): Системная инструкция. По умолчанию `None`.
- `attempts` (int, optional): Количество попыток повторной отправки сообщения в случае ошибки. По умолчанию `3`.

**Возвращает**:
- `str`: Ответ от модели.

**Как работает функция**:

1.  Инициализирует список `messages`.
2.  Если задана системная инструкция (в аргументе или в атрибуте класса), добавляет её в список `messages`.
3.  Добавляет сообщение пользователя в список `messages`.
4.  Отправляет запрос к модели с использованием `self.client.chat.completions.create`.
5.  Извлекает ответ из полученного ответа.
6.  Определяет тональность ответа с использованием `self.determine_sentiment`.
7.  Добавляет системную инструкцию, сообщение пользователя и ответ ассистента с тональностью в историю диалога (`self.dialogue`).
8.  Сохраняет историю диалога с использованием `self._save_dialogue()`.
9.  Возвращает ответ от модели.
10. В случае ошибки логирует ошибку, ждет 3 секунды и пытается отправить сообщение повторно, если количество попыток больше 0. Если все попытки исчерпаны, возвращает `None`.

```
Инициализация списка messages
↓
Добавление системной инструкции (если есть) в список messages
↓
Добавление сообщения пользователя в список messages
↓
Отправка запроса к модели
↓
Извлечение ответа из полученного ответа
↓
Определение тональности ответа
↓
Добавление системной инструкции, сообщения пользователя и ответа ассистента с тональностью в историю диалога
↓
Сохранение истории диалога
↓
Возврат ответа от модели
↓
Обработка ошибок: логирование ошибки, ожидание и повторная отправка сообщения (если есть попытки)
```

**Примеры**:

```python
response = model.ask("Hello, how are you?", system_instruction="You are a helpful assistant.")
print(response)
```

### `describe_image`

```python
def describe_image(self, image_path: str | Path, prompt:Optional[str] = None, system_instruction:Optional[str] = None ) -> str:
```

**Назначение**: <Напиши назначение функции>

**Параметры**:
- `image_path` (str | Path): <Напиши что означает параметр>
- `prompt` (Optional[str], optional): <Напиши что означает параметр>. По умолчанию `None`.
- `system_instruction` (Optional[str], optional): <Напиши что означает параметр>. По умолчанию `None`.

**Возвращает**:
- `str`: <Что возвращает функция>

**Как работает функция**:

1.  <Опиши подробно как работает функция>
2.  <...>

```
<Блок 1>
↓
<Блок 2>
↓
<Блок 3>
```

**Примеры**:

```python
<Пример использования функции>
```

### `describe_image_by_requests`

```python
def describe_image_by_requests(self, image_path: str | Path, prompt:str = None) -> str:
```

**Назначение**: Отправляет изображение в OpenAI API, используя библиотеку `requests`, и получает описание.

**Параметры**:
- `image_path` (str | Path): Путь к изображению.
- `prompt` (str, optional): Подсказка для описания изображения. По умолчанию `None`.

**Как работает функция**:

1.  Кодирует изображение в base64.
2.  Формирует заголовки запроса с указанием типа контента и авторизацией.
3.  Создает полезную нагрузку (payload) с указанием модели, сообщения пользователя (включающего текст подсказки и закодированное изображение) и максимального количества токенов.
4.  Отправляет POST-запрос к OpenAI API.
5.  Обрабатывает ответ от API и извлекает описание изображения.
6.  В случае ошибки логирует информацию об ошибке.

```
Кодирование изображения в base64
↓
Формирование заголовков запроса
↓
Создание полезной нагрузки (payload)
↓
Отправка POST-запроса к OpenAI API
↓
Обработка ответа от API и извлечение описания изображения
↓
Обработка ошибок: логирование информации об ошибке
```

**Примеры**:

```python
image_path = gs.path.google_drive / 'images' / 'example_image.jpg'
description = model.describe_image_by_requests(image_path, prompt="Describe the objects in this image.")
```

### `dynamic_train`

```python
def dynamic_train(self):
```

**Назначение**: Динамически загружает предыдущий диалог и донастраивает модель на его основе.

**Параметры**:
- `None`

**Как работает функция**:

1.  Пытается загрузить предыдущий диалог из файла `dailogue.json`, используя функцию `j_loads`.
2.  Если диалог найден, отправляет запрос к OpenAI API для донастройки модели на основе загруженного диалога.
3.  Логирует успешную донастройку модели или отсутствие предыдущего диалога.
4.  В случае ошибки логирует информацию об ошибке.

```
Попытка загрузить предыдущий диалог из файла dailogue.json
↓
Если диалог найден:
  → Отправка запроса к OpenAI API для донастройки модели
  → Логирование успешной донастройки
↓
Если диалог не найден:
  → Логирование отсутствия предыдущего диалога
↓
Обработка ошибок: логирование информации об ошибке
```

**Примеры**:

```python
model.dynamic_train()
```

### `train`

```python
def train(self, data: str = None, data_dir: Path | str = None, data_file: Path | str = None, positive: bool = True) -> str | None:
```

**Назначение**: Обучает модель на основе указанных данных или каталога.

**Параметры**:
- `data` (str, optional): Путь к CSV-файлу или строка в формате CSV с данными.
- `data_dir` (Path | str, optional): Каталог, содержащий CSV-файлы для обучения.
- `data_file` (Path | str, optional): Путь к одному CSV-файлу с данными для обучения.
- `positive` (bool, optional): Указывает, являются ли данные положительными или отрицательными. По умолчанию `True`.

**Возвращает**:
- `str | None`: ID задачи обучения или `None`, если произошла ошибка.

**Как работает функция**:

1.  Если `data_dir` не указан, устанавливает его в значение по умолчанию (`gs.path.google_drive / 'AI' / 'training'`).
2.  Пытается загрузить данные для обучения из `data`, `data_file` или `data_dir` с использованием функции `j_loads`.
3.  Отправляет запрос к OpenAI API для создания задачи обучения с использованием загруженных данных.
4.  Сохраняет ID задачи обучения в атрибут `self.current_job_id` и возвращает его.
5.  В случае ошибки логирует информацию об ошибке и возвращает `None`.

```
Если data_dir не указан:
  → Установка data_dir в значение по умолчанию
↓
Попытка загрузить данные для обучения
↓
Отправка запроса к OpenAI API для создания задачи обучения
↓
Сохранение ID задачи обучения и возврат его
↓
Обработка ошибок: логирование информации об ошибке и возврат None
```

**Примеры**:

```python
training_result = model.train(data_file=gs.path.google_drive / 'AI' / 'training_data.csv')
```

### `save_job_id`

```python
def save_job_id(self, job_id: str, description: str, filename: str = "job_ids.json"):
```

**Назначение**: Сохраняет ID задачи обучения с описанием в файл.

**Параметры**:
- `job_id` (str): ID задачи обучения для сохранения.
- `description` (str): Описание задачи обучения.
- `filename` (str, optional): Имя файла для сохранения ID задач. По умолчанию `"job_ids.json"`.

**Как работает функция**:

1.  Создает словарь `job_data` с информацией о задаче обучения (ID, описание и время создания).
2.  Определяет путь к файлу для сохранения данных (`job_file`).
3.  Если файл не существует, создает его и сохраняет в него список с данными о задаче обучения.
4.  Если файл существует, загружает существующие данные, добавляет к ним новые данные о задаче обучения и сохраняет обновленный список в файл.

```
Создание словаря job_data с информацией о задаче обучения
↓
Определение пути к файлу для сохранения данных
↓
Если файл не существует:
  → Создание файла и сохранение данных о задаче обучения
↓
Если файл существует:
  → Загрузка существующих данных
  → Добавление новых данных о задаче обучения
  → Сохранение обновленного списка в файл
```

**Примеры**:

```python
model.save_job_id(training_result, "Training model with new data", filename="job_ids.json")
```

### `main`

```python
def main():
```

**Назначение**: Главная функция для инициализации `OpenAIModel` и демонстрации использования.

**Как работает функция**:

1.  Инициализация модели:
    *   Создается инстанс `OpenAIModel` с системной инструкцией и ID ассистента.
2.  Вывод списка доступных моделей:
    *   Вызывается метод `list_models` для получения списка доступных моделей.
    *   Полученный список моделей выводится в консоль.
3.  Вывод списка доступных ассистентов:
    *   Вызывается метод `list_assistants` для получения списка доступных ассистентов.
    *   Список ассистентов выводится в консоль.
4.  Отправка вопроса модели:
    *   Определяется строка вопроса `user_input`.
    *   Вызывается метод `ask` для отправки вопроса модели и получения ответа.
    *   Вопрос пользователя и ответ модели выводятся в консоль.
5.  Динамическое обучение:
    *   Вызывается метод `dynamic_train` для выполнения динамической донастройки на основе предыдущего диалога.
6.  Обучение модели:
    *   Вызывается метод `train` для обучения модели с использованием данных из указанного файла (`training_data.csv`).
    *   ID задачи обучения выводится в консоль.
7.  Сохранение ID задачи обучения:
    *   Если ID задачи обучения получен, вызывается метод `save_job_id` для сохранения ID с описанием в JSON-файл.
8.  Описание изображения:
    *   Определяется путь к изображению `image_path`.
    *   Вызывается метод `describe_image` для получения описания изображения.
    *   Описание изображения выводится в консоль.

```
Инициализация модели
↓
Вывод списка доступных моделей
↓
Вывод списка доступных ассистентов
↓
Отправка вопроса модели
↓
Динамическое обучение
↓
Обучение модели
↓
Сохранение ID задачи обучения
↓
Описание изображения
```

**Примеры**:

```python
if __name__ == "__main__":
    main()