# Модуль AllenAI

## Обзор

Модуль `AllenAI` предоставляет асинхронный генератор для взаимодействия с API Ai2 Playground. Он позволяет отправлять запросы к различным моделям, поддерживаемым Ai2 Playground, и получать потоковые ответы. Модуль поддерживает сохранение истории разговоров и использование прокси.

## Подробней

Этот модуль предназначен для интеграции с сервисом Ai2 Playground, предоставляющим доступ к различным моделям обработки естественного языка. Он использует асинхронные запросы для обеспечения неблокирующего взаимодействия с API и поддерживает потоковую передачу данных для эффективной обработки больших объемов текста.

## Классы

### `Conversation`

**Описание**: Класс `Conversation` используется для хранения истории разговора с моделью AllenAI. Он наследуется от `JsonConversation` и содержит информацию о родительском сообщении и идентификаторе анонимного пользователя.

**Принцип работы**:
Класс предназначен для хранения контекста диалога с Ai2 Playground. Он хранит историю сообщений, идентификатор анонимного пользователя и информацию о родительском сообщении, что позволяет поддерживать контекст в многошаговых беседах.

**Методы**:

- `__init__(self, model: str)`:
    - **Назначение**: Инициализирует новый объект `Conversation`.
    - **Параметры**:
        - `model` (str): Название используемой модели.
    
- `parent: str = None`:
    - **Назначение**: Атрибут класса, хранящий идентификатор родительского сообщения. По умолчанию `None`.
- `x_anonymous_user_id: str = None`:
    - **Назначение**: Атрибут класса, хранящий идентификатор анонимного пользователя. По умолчанию `None`.

### `AllenAI`

**Описание**: Класс `AllenAI` является провайдером асинхронного генератора для взаимодействия с API Ai2 Playground. Он предоставляет методы для создания асинхронных запросов и получения потоковых ответов от моделей AllenAI.

**Принцип работы**:
Класс `AllenAI` реализует логику взаимодействия с API Ai2 Playground. Он формирует multipart/form-data запросы, отправляет их к API и обрабатывает потоковые ответы. Поддерживается выбор модели, передача прокси, а также сохранение и использование истории разговоров.

**Параметры**:

- `label` (str): Метка провайдера ("Ai2 Playground").
- `url` (str): URL Ai2 Playground ("https://playground.allenai.org").
- `login_url` (str): URL для логина (отсутствует, `None`).
- `api_endpoint` (str): URL API для отправки сообщений ("https://olmo-api.allen.ai/v4/message/stream").
- `working` (bool): Указывает, работает ли провайдер (True).
- `needs_auth` (bool): Указывает, требуется ли аутентификация (False).
- `use_nodriver` (bool): Указывает, нужно ли использовать драйвер (False).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных (True).
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения (False).
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений (True).
- `default_model` (str): Модель, используемая по умолчанию ('tulu3-405b').
- `models` (List[str]): Список поддерживаемых моделей.
- `model_aliases` (Dict[str, str]): Словарь псевдонимов моделей.

**Методы**:

- `create_async_generator(model: str, messages: Messages, proxy: str = None, host: str = "inferd", private: bool = True, top_p: float = None, temperature: float = None, conversation: Conversation = None, return_conversation: bool = False, **kwargs) -> AsyncResult`:

    - **Назначение**: Создает асинхронный генератор для получения ответов от API AllenAI.

    - **Параметры**:
        - `model` (str): Название модели для использования.
        - `messages` (Messages): Список сообщений для отправки.
        - `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
        - `host` (str, optional): Хост. По умолчанию "inferd".
        - `private` (bool, optional): Указывает, является ли разговор приватным. По умолчанию `True`.
        - `top_p` (float, optional): Значение top_p. По умолчанию `None`.
        - `temperature` (float, optional): Значение temperature. По умолчанию `None`.
        - `conversation` (Conversation, optional): Объект `Conversation` для сохранения истории разговора. По умолчанию `None`.
        - `return_conversation` (bool, optional): Указывает, нужно ли возвращать объект `Conversation` в результате. По умолчанию `False`.
        - `**kwargs`: Дополнительные аргументы.

    - **Возвращает**:
        - `AsyncResult`: Асинхронный генератор, возвращающий текстовые фрагменты ответа модели.

    - **Как работает функция**:

        1. **Формирование запроса**: Функция принимает параметры модели, сообщения и прокси-сервера, после чего подготавливает данные для отправки в Ai2 Playground API.
        2. **Инициализация или обновление контекста**: Если передан объект `Conversation`, функция использует его для сохранения контекста диалога. В противном случае создается новый объект `Conversation`.
        3. **Создание multipart/form-data запроса**: Формируется запрос в формате `multipart/form-data`, включающий параметры модели, хоста, контента сообщения и другие опциональные параметры.
        4. **Отправка запроса и обработка ответа**: Отправляется асинхронный POST-запрос к API Ai2 Playground, и ответ обрабатывается потоково.
        5. **Извлечение и обработка данных**: Из потока данных извлекаются фрагменты текста, относящиеся к ответу ассистента, и передаются через генератор.
        6. **Завершение разговора**: По достижении конца разговора (определяется по флагу `final` или `finish_reason`) сохраняется контекст диалога и возвращается признак завершения `FinishReason("stop")`.

    - **Внутренние логические блоки**:
        - `Формирование_промпта`: Подготавливает текстовый промпт для отправки в API на основе списка сообщений.
        - `Инициализация_конверсации`: Создает или обновляет объект `Conversation` для хранения истории разговора.
        - `Формирование_данных_формы`: Создает multipart/form-data запрос с необходимыми параметрами.
        - `Отправка_запроса_и_получение_ответа`: Отправляет запрос к API и получает потоковый ответ.
        - `Обработка_фрагментов_ответа`: Извлекает и обрабатывает фрагменты текста из потокового ответа.
        - `Завершение_сессии`: Сохраняет контекст диалога и возвращает признак завершения.

    - **Примеры**:

        ```python
        messages = [{"role": "user", "content": "Hello, how are you?"}]
        async for message in AllenAI.create_async_generator(model="tulu3-405b", messages=messages):
            print(message)
        ```

## Функции

### `format_prompt(messages: Messages) -> str`

Данная функция находится в модуле `helper` и преобразует список сообщений в строку, пригодную для отправки в API.

### `get_last_user_message(messages: Messages) -> str`

Данная функция находится в модуле `helper` и извлекает последнее сообщение пользователя из списка сообщений.

```python
def get_last_user_message(messages: Messages) -> str:
    """
    Извлекает последнее сообщение пользователя из списка сообщений.

    Args:
        messages (Messages): Список сообщений, где каждое сообщение является словарем с ключами "role" и "content".

    Returns:
        str: Содержимое последнего сообщения пользователя, если оно найдено.
             Возвращает пустую строку, если список сообщений пуст или не содержит сообщений от пользователя.

    Example:
        >>> messages = [
        ...     {"role": "assistant", "content": "Hello"},
        ...     {"role": "user", "content": "How are you?"}
        ... ]
        >>> get_last_user_message(messages)
        'How are you?'
    """