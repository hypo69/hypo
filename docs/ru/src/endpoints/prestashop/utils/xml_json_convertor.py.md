# Модуль для конвертации XML в JSON и обратно

## Обзор

Модуль `xml_json_convertor.py` предоставляет утилиты для конвертации данных из формата XML в JSON (словарь Python) и обратно. Он содержит функции для парсинга XML строк, преобразования XML деревьев элементов в словарные представления и создания XML из JSON-подобных словарей.

## Подробней

Этот модуль облегчает взаимодействие с данными в формате XML, позволяя преобразовывать их в более удобный для работы формат JSON и наоборот. Он используется в проекте для обработки данных, получаемых или отправляемых в формате XML, например, при взаимодействии с API PrestaShop.

## Функции

### `dict2xml`

```python
def dict2xml(json_obj: dict, root_name: str = "product") -> str:
    """Преобразует JSON словарь в XML строку.

    Args:
        json_obj (dict): JSON словарь для преобразования.
        root_name (str, optional): Имя корневого элемента. По умолчанию "product".

    Returns:
        str: XML строковое представление JSON.
    """
```

**Как работает функция:**

1.  Функция принимает JSON-подобный словарь `json_obj` и имя корневого элемента `root_name`.
2.  Внутри функция определяет вложенную функцию `build_xml_element`, которая рекурсивно строит XML элементы на основе JSON данных.
3.  Создается корневой элемент XML с именем `root_name`.
4.  Вызывается функция `build_xml_element` для построения дерева XML элементов на основе данных из `json_obj`.
5.  Полученное XML дерево преобразуется в строку в кодировке UTF-8 и возвращается.

**Параметры:**

*   `json_obj` (dict): JSON словарь, который необходимо преобразовать в XML.
*   `root_name` (str, optional): Имя корневого элемента XML. По умолчанию "product".

**Возвращает:**

*   `str`: XML строковое представление JSON словаря.

**Внутренние функции:**

#### `build_xml_element`

```python
def build_xml_element(parent, data):
    """Рекурсивно конструирует XML элементы из JSON данных."""
```

**Как работает функция:**

1.  Функция рекурсивно строит XML элементы на основе JSON данных.
2.  Если данные являются словарем, перебирает элементы словаря и создает соответствующие XML элементы.
    *   Если ключ начинается с "@", то это атрибут элемента.
    *   Если ключ "#text", то это текстовое значение элемента.
    *   Иначе создается подэлемент и рекурсивно вызывается `build_xml_element` для него.
3.  Если данные являются списком, перебирает элементы списка и рекурсивно вызывает `build_xml_element` для каждого элемента.
4.  Если данные являются простым значением, то устанавливает текстовое значение родительского элемента.

**Параметры:**

*   `parent`: Родительский XML элемент.
*   `data`: Данные для построения XML элемента.

### `_parse_node`

```python
def _parse_node(node: ET.Element) -> dict | str:
    """Разбирает XML узел в словарь.

    Args:
        node (ET.Element): XML элемент для разбора.

    Returns:
        dict | str: Представление XML узла в виде словаря, или строка, если узел не имеет атрибутов или дочерних элементов.
    """
```

**Как работает функция:**

1.  Функция принимает XML элемент `node` в качестве аргумента.
2.  Инициализирует пустой словарь `tree` для хранения результата и словарь `attrs` для хранения атрибутов элемента.
3.  Перебирает атрибуты XML элемента, извлекая имя и значение каждого атрибута. Атрибуты, соответствующие `href`, пропускаются.
4.  Извлекает текстовое значение XML элемента, удаляя пробельные символы в начале и конце.
5.  Если у элемента есть атрибуты, добавляет их в словарь `tree` под ключом `attrs`.
6.  Перебирает дочерние элементы XML элемента.
    *   Для каждого дочернего элемента рекурсивно вызывает функцию `_parse_node`.
    *   Создает словарь `cdict` с результатом разбора дочернего элемента.
    *   Если дочерний элемент имеет значение, устанавливает значение `value` в пустую строку.
    *   Если имя дочернего элемента еще не встречалось в словаре `tree`, добавляет его.
    *   Если имя дочернего элемента уже есть в словаре `tree`, преобразует значение в список и добавляет новый элемент.
7.  Если у элемента нет дочерних элементов, добавляет текстовое значение в словарь `tree` под ключом `value`.
8.  Если в словаре `tree` содержится только ключ `value`, возвращает значение напрямую.
9.  Возвращает словарь `tree`, представляющий XML узел.

**Параметры:**

*   `node` (ET.Element): XML элемент, который необходимо разобрать.

**Возвращает:**

*   `dict | str`: Словарь, представляющий XML узел, или строка, если узел не имеет атрибутов или дочерних элементов.

### `_make_dict`

```python
def _make_dict(tag: str, value: any) -> dict:
    """Генерирует новый словарь с тегом и значением.

    Args:
        tag (str): Имя тега XML элемента.
        value (any): Значение, связанное с тегом.

    Returns:
        dict: Словарь с именем тега в качестве ключа и значением в качестве значения словаря.
    """
```

**Как работает функция:**

1.  Функция принимает имя тега `tag` и значение `value`.
2.  Присваивает значение `value` переменной `tag_values`.
3.  Ищет в имени тега регулярное выражение для определения пространства имен.
    *   Если пространство имен найдено, создает словарь `tag_values` с ключом `'value'` и значением `value`.
    *   Добавляет пространство имен в словарь `tag_values` под ключом `'xmlns'`.
4.  Возвращает словарь с именем тега в качестве ключа и `tag_values` в качестве значения.

**Параметры:**

*   `tag` (str): Имя тега XML элемента.
*   `value` (any): Значение, связанное с тегом.

**Возвращает:**

*   `dict`: Словарь с именем тега в качестве ключа и значением в качестве значения словаря.

### `xml2dict`

```python
def xml2dict(xml: str) -> dict:
    """Разбирает XML строку в словарь.

    Args:
        xml (str): XML строка для разбора.

    Returns:
        dict: Представление XML в виде словаря.
    """
```

**Как работает функция:**

1.  Функция принимает XML строку `xml` в качестве аргумента.
2.  Преобразует XML строку в дерево элементов с помощью `ET.fromstring(xml)`.
3.  Вызывает функцию `ET2dict` для преобразования дерева элементов в словарь.
4.  Возвращает словарь, представляющий XML структуру.

**Параметры:**

*   `xml` (str): XML строка, которую необходимо разобрать.

**Возвращает:**

*   `dict`: Словарь, представляющий XML структуру.

### `ET2dict`

```python
def ET2dict(element_tree: ET.Element) -> dict:
    """Преобразует дерево XML элементов в словарь.

    Args:
        element_tree (ET.Element): Дерево XML элементов.

    Returns:
        dict: Представление дерева XML элементов в виде словаря.
    """
```

**Как работает функция:**

1.  Функция принимает дерево XML элементов `element_tree` в качестве аргумента.
2.  Вызывает функцию `_make_dict` для преобразования дерева элементов в словарь, используя тег корневого элемента и результат разбора узла.
3.  Возвращает словарь, представляющий дерево XML элементов.

**Параметры:**

*   `element_tree` (ET.Element): Дерево XML элементов, которое необходимо преобразовать.

**Возвращает:**

*   `dict`: Словарь, представляющий дерево XML элементов.

### `presta_fields_to_xml`

```python
def presta_fields_to_xml(presta_fields_dict: dict) -> str:
    """! Преобразует JSON словарь в XML строку с фиксированным корневым элементом 'prestashop'.

    Args:
        presta_fields_dict (dict): JSON словарь, содержащий данные (без ключа 'prestashop').

    Returns:
        str: XML строковое представление JSON.
    """
```

**Как работает функция:**

1.  Функция принимает JSON-подобный словарь `presta_fields_dict`, который содержит данные для преобразования в XML.
2.  Определяет вложенную функцию `build_xml_element`, которая рекурсивно строит XML элементы на основе JSON данных.
3.  Проверяет, что `presta_fields_dict` не пуст. Если он пуст, возвращает пустую строку.
4.  Извлекает первый ключ из `presta_fields_dict`, который будет использоваться в качестве имени динамического элемента (например, 'product', 'category' и т.д.).
5.  Создает корневой элемент XML с именем "prestashop".
6.  Создает динамический подэлемент корневого элемента с именем, полученным из первого ключа `presta_fields_dict`.
7.  Вызывает функцию `build_xml_element` для построения дерева XML элементов на основе данных из `presta_fields_dict`.
8.  Полученное XML дерево преобразуется в строку в кодировке UTF-8 и возвращается.

**Параметры:**

*   `presta_fields_dict` (dict): JSON словарь, который необходимо преобразовать в XML.

**Возвращает:**

*   `str`: XML строковое представление JSON словаря.

**Внутренние функции:**

#### `build_xml_element`

```python
def build_xml_element(parent, data):
    """Рекурсивно конструирует XML элементы из JSON данных."""
```

**Как работает функция:**

1.  Функция рекурсивно строит XML элементы на основе JSON данных.
2.  Если данные являются словарем, перебирает элементы словаря и создает соответствующие XML элементы.
    *   Если ключ начинается с "@", то это атрибут элемента.
    *   Если ключ "#text", то это текстовое значение элемента.
    *   Иначе создается подэлемент и рекурсивно вызывается `build_xml_element` для него.
3.  Если данные являются списком, перебирает элементы списка и рекурсивно вызывает `build_xml_element` для каждого элемента.
4.  Если данные являются простым значением, то устанавливает текстовое значение родительского элемента.

**Параметры:**

*   `parent`: Родительский XML элемент.
*   `data`: Данные для построения XML элемента.