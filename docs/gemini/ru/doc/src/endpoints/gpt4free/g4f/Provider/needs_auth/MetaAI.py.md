# Модуль MetaAI

## Обзор

Модуль `MetaAI` предоставляет асинхронный интерфейс для взаимодействия с моделью Meta AI. Он включает в себя функциональность для получения ответов на текстовые запросы, обработки изображений и получения источников информации.

## Подробнее

Модуль предназначен для интеграции с другими частями проекта `hypotez`, требующими доступа к возможностям Meta AI. Он использует `aiohttp` для выполнения асинхронных HTTP-запросов и включает в себя механизмы для обновления cookies и access token для обеспечения стабильной работы. Модуль также обрабатывает ошибки, связанные с географическими ограничениями и проблемами при получении данных.

## Классы

### `Sources`

**Описание**: Класс представляет собой список источников информации, полученных от Meta AI.

**Атрибуты**:
- `list` (List[Dict[str, str]]): Список словарей, каждый из которых содержит информацию об источнике, включая заголовок и ссылку.

**Методы**:
- `__init__(self, link_list: List[Dict[str, str]]) -> None`: Инициализирует экземпляр класса `Sources` списком источников.
- `__str__(self) -> str`: Возвращает строковое представление списка источников в формате Markdown.

### `AbraGeoBlockedError`

**Описание**: Класс исключения, который вызывается, когда Meta AI недоступна в определенной стране из-за географических ограничений.

### `MetaAI`

**Описание**: Класс предоставляет асинхронный интерфейс для взаимодействия с моделью Meta AI.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию ответов.
- `ProviderModelMixin`: Предоставляет общие методы для работы с моделями провайдеров.

**Атрибуты**:
- `label` (str): Метка провайдера ("Meta AI").
- `url` (str): URL Meta AI ("https://www.meta.ai").
- `working` (bool): Указывает, что провайдер находится в рабочем состоянии (True).
- `default_model` (str): Модель по умолчанию ('meta-ai').
- `session` (ClientSession): Асинхронная HTTP-сессия для выполнения запросов.
- `cookies` (Cookies): Cookie для аутентификации.
- `access_token` (str): Токен доступа для выполнения запросов.

**Методы**:
- `__init__(self, proxy: str = None, connector: BaseConnector = None)`: Инициализирует экземпляр класса `MetaAI`.
    - `proxy` (str, optional): Прокси-сервер для использования при выполнении запросов. По умолчанию `None`.
    - `connector` (BaseConnector, optional): HTTP-коннектор для использования с `ClientSession`. По умолчанию `None`.

- `create_async_generator(cls, model: str, messages: Messages, proxy: str = None, **kwargs) -> AsyncResult`: Создает асинхронный генератор для получения ответов от Meta AI.
    - `model` (str): Модель для использования.
    - `messages` (Messages): Список сообщений для отправки.
    - `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
    - `kwargs` (dict): Дополнительные аргументы.

- `update_access_token(self, birthday: str = "1999-01-01")`: Обновляет токен доступа, необходимый для выполнения запросов.
    - `birthday` (str, optional): Дата рождения для использования при обновлении токена. По умолчанию "1999-01-01".

- `prompt(self, message: str, cookies: Cookies = None) -> AsyncResult`: Отправляет текстовый запрос в Meta AI и возвращает асинхронный генератор ответов.
    - `message` (str): Текст запроса.
    - `cookies` (Cookies, optional): Cookie для аутентификации. По умолчанию `None`.

- `update_cookies(self, cookies: Cookies = None)`: Обновляет cookie, используемые для аутентификации.
    - `cookies` (Cookies, optional): Cookie для обновления. По умолчанию `None`.

- `fetch_sources(self, fetch_id: str) -> Sources`: Получает источники информации для ответа Meta AI.
    - `fetch_id` (str): Идентификатор для получения источников.

- `extract_value(text: str, key: str = None, start_str = None, end_str = ',') -> str`: Извлекает значение из текста на основе заданных параметров.
    - `text` (str): Текст для извлечения значения.
    - `key` (str, optional): Ключ для поиска значения. По умолчанию `None`.
    - `start_str` (str, optional): Начальная строка для поиска значения. По умолчанию `None`.
    - `end_str` (str, optional): Конечная строка для поиска значения. По умолчанию `','`.

## Функции

### `generate_offline_threading_id`

```python
def generate_offline_threading_id() -> str:
    """
    Generates an offline threading ID.

    Returns:
        str: The generated offline threading ID.
    """
    # Generate a random 64-bit integer
    random_value = random.getrandbits(64)
    
    # Get the current timestamp in milliseconds
    timestamp = int(time.time() * 1000)
    
    # Combine timestamp and random value
    threading_id = (timestamp << 22) | (random_value & ((1 << 22) - 1))
    
    return str(threading_id)
```

**Назначение**: Генерирует идентификатор треда для оффлайн-режима.

**Возвращает**:
- `str`: Сгенерированный идентификатор треда.

**Как работает функция**:

1. **Генерация случайного значения**: Генерирует случайное 64-битное целое число.
2. **Получение текущей метки времени**: Получает текущую метку времени в миллисекундах.
3. **Комбинирование метки времени и случайного значения**: Объединяет метку времени и случайное значение с использованием битовых операций.
4. **Преобразование в строку**: Преобразует полученный идентификатор в строку.

```
Генерация случайного значения   Получение текущей метки времени   Комбинирование и преобразование
           |                                 |                               |
           V                                 V                               V
     Случайное число               Текущая метка времени       Идентификатор треда (строка)
```

**Примеры**:

```python
threading_id = generate_offline_threading_id()
print(f"Generated threading ID: {threading_id}")
```

---