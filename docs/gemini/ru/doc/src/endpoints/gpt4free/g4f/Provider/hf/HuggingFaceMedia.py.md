# Модуль HuggingFaceMedia

## Обзор

Модуль `HuggingFaceMedia` предназначен для работы с моделями Hugging Face, генерирующими изображения и видео. Он предоставляет функциональность для асинхронной генерации медиаконтента на основе текстовых запросов, используя различные API и провайдеры, интегрированные в Hugging Face. Модуль поддерживает задачи преобразования текста в изображение (`text-to-image`) и текста в видео (`text-to-video`).

## Подробнее

Этот модуль является частью проекта `hypotez` и позволяет интегрировать возможности генерации медиаконтента от Hugging Face в другие части проекта. Он использует асинхронные запросы для взаимодействия с API Hugging Face и поддерживает различные параметры для настройки генерации изображений и видео.

## Классы

### `HuggingFaceMedia`

**Описание**: Класс `HuggingFaceMedia` является асинхронным провайдером для генерации изображений и видео на основе моделей Hugging Face.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями провайдера.

**Атрибуты**:
- `label` (str): Метка провайдера ("HuggingFace (Image/Video Generation)").
- `parent` (str): Родительский провайдер ("HuggingFace").
- `url` (str): URL Hugging Face ("https://huggingface.co").
- `working` (bool): Указывает, что провайдер работает (True).
- `needs_auth` (bool): Указывает, требуется ли аутентификация (True).
- `tasks` (list[str]): Список поддерживаемых задач (["text-to-image", "text-to-video"]).
- `provider_mapping` (dict[str, dict]): Словарь соответствия моделей и провайдеров.
- `task_mapping` (dict[str, str]): Словарь соответствия моделей и задач.

**Методы**:
- `get_models()`: Возвращает список доступных моделей.
- `get_mapping()`: Возвращает информацию о провайдерах для указанной модели.
- `create_async_generator()`: Создает асинхронный генератор для генерации медиаконтента.

## Функции

### `get_models`

```python
@classmethod
def get_models(cls, **kwargs) -> list[str]:
    """
    Возвращает список доступных моделей для генерации изображений и видео.

    Args:
        **kwargs: Дополнительные аргументы (не используются).

    Returns:
        list[str]: Список доступных моделей.
    """
    ...
```

**Назначение**:
Метод `get_models` получает список доступных моделей из API Hugging Face и сохраняет их в атрибуте класса `cls.models`. Он также определяет соответствие между моделями и задачами (например, text-to-image или text-to-video).

**Как работает функция**:
1.  **Проверка наличия моделей**: Проверяет, был ли уже получен список моделей. Если `cls.models` пуст, то выполняется запрос к API Hugging Face.
2.  **Запрос к API**: Отправляет GET-запрос к API Hugging Face для получения списка моделей с поддержкой inference и информацией о провайдерах.
3.  **Обработка ответа**:
    *   Если запрос успешен (`response.ok`), обрабатывает JSON-ответ, чтобы извлечь информацию о моделях и их провайдерах.
    *   Формирует словарь `providers`, где ключи - это идентификаторы моделей, а значения - списки провайдеров, поддерживающих эти модели.
    *   Создает список `new_models`, содержащий идентификаторы моделей и информацию о провайдерах в формате "model:provider".
    *   Формирует словарь `cls.task_mapping`, где ключи - это идентификаторы моделей, а значения - соответствующие задачи (text-to-image или text-to-video).
    *   Разделяет модели на списки `cls.image_models` и `cls.video_models` в зависимости от поддерживаемой задачи.
4.  **Кэширование моделей**: Сохраняет полученные списки моделей в атрибутах класса `cls.models`, `cls.image_models` и `cls.video_models`.
5.  **Обработка ошибок**: Если запрос к API завершается с ошибкой, устанавливает `cls.models` в пустой список.

6.  **Возвращает список моделей**: Возвращает список доступных моделей (`cls.models`).

```
A: Проверка наличия моделей (cls.models)
|
B: Запрос к API Hugging Face
|
C: Обработка ответа API
|   |
|   D: Формирование словаря providers
|   |
|   E: Создание списка new_models
|   |
|   F: Формирование словаря cls.task_mapping
|   |
|   G: Разделение моделей на списки cls.image_models и cls.video_models
|
H: Кэширование моделей
|
I: Обработка ошибок
|
J: Возврат списка моделей
```

**Примеры**:
```python
models = HuggingFaceMedia.get_models()
if models:
    print(f"Доступные модели: {models}")
else:
    print("Не удалось получить список моделей.")
```

### `get_mapping`

```python
@classmethod
async def get_mapping(cls, model: str, api_key: str = None):
    """
    Получает информацию о провайдерах для указанной модели.

    Args:
        model (str): Идентификатор модели.
        api_key (str, optional): API ключ. По умолчанию `None`.

    Returns:
        dict: Информация о провайдерах для указанной модели.
    """
    ...
```

**Назначение**:
Метод `get_mapping` получает информацию о провайдерах для указанной модели из API Hugging Face и сохраняет её в атрибуте класса `cls.provider_mapping`.

**Как работает функция**:

1.  **Проверка кэша**: Проверяет, есть ли информация о провайдерах для указанной модели в кэше (`cls.provider_mapping`). Если есть, возвращает её.
2.  **Формирование заголовков**: Создает заголовки для HTTP-запроса, включая `Content-Type` и, при необходимости, `Authorization` с API-ключом.
3.  **Выполнение запроса**: Отправляет асинхронный GET-запрос к API Hugging Face для получения информации о модели и её провайдерах.
4.  **Обработка ответа**:
    *   Проверяет статус ответа и вызывает исключение `raise_for_status`, если возникла ошибка.
    *   Извлекает информацию о провайдерах из JSON-ответа и фильтрует только "live" провайдеров.
    *   Сохраняет полученную информацию в кэше `cls.provider_mapping`.
5.  **Возврат информации**: Возвращает словарь с информацией о провайдерах для указанной модели.

```
A: Проверка кэша (cls.provider_mapping)
|
B: Формирование заголовков
|
C: Выполнение запроса к API Hugging Face
|
D: Обработка ответа API
|   |
|   E: Проверка статуса ответа
|   |
|   F: Извлечение информации о провайдерах
|   |
|   G: Сохранение информации в кэше cls.provider_mapping
|
H: Возврат информации о провайдерах
```

**Примеры**:
```python
import asyncio

async def main():
    model_info = await HuggingFaceMedia.get_mapping("stabilityai/stable-diffusion-2")
    if model_info:
        print(f"Информация о провайдерах: {model_info}")
    else:
        print("Не удалось получить информацию о провайдерах.")

asyncio.run(main())
```

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    api_key: str = None,
    extra_data: dict = {},
    prompt: str = None,
    proxy: str = None,
    timeout: int = 0,
    # Video & Image Generation
    n: int = 1,
    aspect_ratio: str = None,
    # Only for Image Generation
    height: int = None,
    width: int = None,
    # Video Generation
    resolution: str = "480p",
    **kwargs
):
    """
    Создает асинхронный генератор для генерации медиаконтента.

    Args:
        model (str): Идентификатор модели.
        messages (Messages): Список сообщений для формирования запроса.
        api_key (str, optional): API ключ. По умолчанию `None`.
        extra_data (dict, optional): Дополнительные данные для запроса. По умолчанию `{}`.
        prompt (str, optional): Текст запроса. По умолчанию `None`.
        proxy (str, optional): Proxy server. По умолчанию `None`.
        timeout (int, optional): Время ожидания запроса. По умолчанию `0`.
        n (int, optional): Количество генерируемых медиафайлов. По умолчанию `1`.
        aspect_ratio (str, optional): Соотношение сторон изображения/видео. По умолчанию `None`.
        height (int, optional): Высота изображения. По умолчанию `None`.
        width (int, optional): Ширина изображения. По умолчанию `None`.
        resolution (str, optional): Разрешение видео. По умолчанию "480p".
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncGenerator: Асинхронный генератор для получения медиаконтента.
    """
    ...
```

**Назначение**:
Метод `create_async_generator` создает асинхронный генератор для генерации медиаконтента на основе текстового запроса, используя указанную модель и параметры. Он выбирает подходящего провайдера из API Hugging Face и выполняет запросы к этому провайдеру для генерации изображений или видео.

**Как работает функция**:

1.  **Выбор провайдера**:
    *   Если указан конкретный провайдер в параметре `model` (например, "model:provider"), он используется.
    *   Если провайдер не указан, выбирается первый доступный провайдер для указанной модели.
2.  **Форматирование запроса**: Форматирует текстовый запрос (`prompt`) на основе списка сообщений (`messages`).
3.  **Получение информации о провайдерах**: Получает информацию о доступных провайдерах для указанной модели с помощью метода `cls.get_mapping`.
4.  **Подготовка заголовков**: Создает заголовки для HTTP-запроса, включая `Content-Type` и, при необходимости, `Authorization` с API-ключом.
5.  **Определение параметров генерации**:
    *   Определяет соотношение сторон (`aspect_ratio`) для изображения или видео. Если не указано, устанавливает значение по умолчанию ("1:1" для изображений, "16:9" для видео).
    *   Формирует дополнительные параметры (`extra_data`) для запроса в зависимости от задачи (text-to-image или text-to-video) и выбранного провайдера.
6.  **Асинхронная генерация**:
    *   Определяет внутреннюю асинхронную функцию `generate`, которая выполняет запросы к API Hugging Face для генерации медиаконтента.
    *   В цикле запускает несколько задач (`asyncio.create_task`) для параллельной генерации медиафайлов.
    *   Ожидает завершения всех задач и возвращает результаты в виде асинхронного генератора.
7.  **Обработка результатов**:
    *   После завершения каждой задачи, извлекает информацию о провайдере (`provider_info`) и медиаконтент (`media_response`) из результата задачи.
    *   Возвращает информацию о провайдере, медиаконтент и промежуточные статусы (`Reasoning`) через асинхронный генератор.
8.  **Обработка ошибок**:
    *   Обрабатывает ошибки, возникающие при выполнении запросов к API Hugging Face, и логирует их.
    *   Вызывает исключение `ModelNotSupportedError`, если указанная модель не поддерживается.

```
A: Выбор провайдера
|
B: Форматирование запроса
|
C: Получение информации о провайдерах
|
D: Подготовка заголовков
|
E: Определение параметров генерации
|
F: Асинхронная генерация (внутренняя функция generate)
|   |
|   G: Запуск задач для параллельной генерации
|   |
|   H: Ожидание завершения задач
|
I: Обработка результатов
|
J: Обработка ошибок
|
K: Возврат результатов через асинхронный генератор
```

**Примеры**:
```python
import asyncio
from typing import List, Dict, Optional

async def main():
    model_name = "stabilityai/stable-diffusion-2"
    messages: List[Dict[str, str]] = [{"role": "user", "content": "A cat in space"}]
    api_key: Optional[str] = "YOUR_API_KEY"  # Замените на свой API ключ, если требуется
    
    generator = HuggingFaceMedia.create_async_generator(
        model=model_name,
        messages=messages,
        api_key=api_key,
        n=1,
        height=512,
        width=512
    )
    
    async for item in generator:
        print(item)

asyncio.run(main())