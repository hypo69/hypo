# Модуль gemini_simplechat.main

## Обзор

Модуль предоставляет простой чат на основе модели Google Gemini. Он включает в себя FastAPI приложение с настроенным CORS, эндпоинт для обработки запросов чата и функцию для запуска локального сервера.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для обеспечения интерфейса взаимодействия с моделью Google Gemini. Он использует FastAPI для создания API, позволяющего отправлять текстовые запросы и получать ответы от модели Gemini. Расположение файла `hypotez/src/endpoints/gemini_simplechat/main.py` указывает на то, что он является основным файлом для функциональности чата Gemini.

## Классы

### `ChatRequest`

**Описание**: Модель запроса чата, используемая для валидации входящих сообщений.

**Аттрибуты**:
- `message` (str): Текст сообщения, отправленного пользователем.

## Функции

### `root`

```python
async def root():
    """
    Возвращает HTML-контент главной страницы.

    Returns:
        HTMLResponse: HTML-контент главной страницы.

    Raises:
        HTTPException: Если происходит ошибка при чтении файла шаблона.

    """
```

**Назначение**: Функция обрабатывает GET-запрос к корневому пути ("/"). Она пытается прочитать содержимое HTML-файла и вернуть его в качестве ответа.

**Как работает функция**:

1.  **Чтение HTML-файла**: Функция пытается прочитать содержимое HTML-файла, путь к которому определяется переменной `gs.fast_api.index_path`.
2.  **Обработка исключений**: Если происходит ошибка при чтении файла (например, файл не найден), функция возбуждает исключение `HTTPException` с кодом состояния 500 и детальным сообщением об ошибке.
3.  **Возврат HTML-контента**: Если чтение файла прошло успешно, функция возвращает `HTMLResponse` с содержимым файла.

```
    A[Чтение HTML-файла]
    |
    B[Обработка исключений]
    |
    C[Возврат HTML-контента]
```

**Примеры**:

```python
# Пример успешного вызова
# (Предполагается, что файл index.html существует и доступен)
response = await root()
print(response.status_code)  # 200
```

```python
# Пример вызова, когда файл index.html не найден
# (В этом случае будет возбуждено исключение HTTPException)
try:
    response = await root()
except HTTPException as ex:
    print(ex.status_code)  # 500
    print(ex.detail)  # Error reading templates: [Errno 2] No such file or directory: ...
```

### `chat`

```python
async def chat(request: ChatRequest):
    """
    Обрабатывает POST-запрос к эндпоинту "/api/chat".

    Args:
        request (ChatRequest): Объект запроса, содержащий сообщение пользователя.

    Returns:
        dict: Ответ от модели Gemini.

    Raises:
        HTTPException: Если происходит ошибка при взаимодействии с моделью Gemini.
    """
```

**Назначение**: Функция обрабатывает POST-запросы к эндпоинту "/api/chat". Она принимает запрос, содержащий сообщение пользователя, и отправляет его в модель Google Gemini для получения ответа.

**Как работает функция**:

1.  **Получение сообщения**: Функция извлекает сообщение пользователя из объекта `request` типа `ChatRequest`.
2.  **Взаимодействие с моделью Gemini**: Функция вызывает метод `chat` объекта `model` (экземпляр класса `GoogleGenerativeAI`), передавая ему сообщение пользователя.
3.  **Обработка ответа**: Функция получает ответ от модели Gemini и возвращает его в виде словаря.
4.  **Обработка исключений**: Если происходит ошибка при взаимодействии с моделью Gemini, функция логирует ошибку с помощью `logger.error` и возбуждает исключение `HTTPException` с кодом состояния 500 и детальным сообщением об ошибке.

```
    A[Получение сообщения от пользователя]
    |
    B[Взаимодействие с моделью Gemini]
    |
    C[Обработка ответа]
    |
    D[Обработка исключений]
```

**Примеры**:

```python
# Пример успешного вызова
# (Предполагается, что модель Gemini доступна и возвращает ответ)
request = ChatRequest(message="Hello")
response = await chat(request)
print(response)  # {'response': 'Hello from Gemini'}
```

```python
# Пример вызова, когда модель Gemini недоступна
# (В этом случае будет возбуждено исключение HTTPException)
try:
    request = ChatRequest(message="Hello")
    response = await chat(request)
except HTTPException as ex:
    print(ex.status_code)  # 500
    print(ex.detail)  # Error in chat: ...
```
```python
if __name__ == "__main__":
    """
    Запускает Uvicorn-сервер, если скрипт вызывается напрямую.
    """
```

**Назначение**: Этот блок кода запускает Uvicorn-сервер, если скрипт вызывается напрямую (а не импортируется как модуль).

**Как работает функция**:

1.  **Проверка условия `if __name__ == "__main__":`**: Этот код выполняется только в том случае, если скрипт запускается как основная программа.
2.  **Запуск Uvicorn**: Используется функция `uvicorn.run()` для запуска FastAPI-приложения. Параметры `host` и `port` берутся из конфигурации `gs.fast_api`.

### Внутренние переменные
- `app`: FastAPI приложение. Используется для определения эндпоинтов и обработки запросов.
- `system_instruction`: Инструкция для модели Gemini, загруженная из файла.
- `model`: Экземпляр класса `GoogleGenerativeAI`, используемый для взаимодействия с моделью Gemini.

## Модули
- `fastapi`: Используется для создания API.
- `uvicorn`: Используется для запуска локального сервера.
- `pydantic`: Используется для валидации данных.
- `src.ai.GoogleGenerativeAI`: Используется для взаимодействия с моделью Gemini.
- `src.utils.jjson`: Используется для загрузки JSON-файлов.
- `src.logger`: Используется для логирования.

```

```