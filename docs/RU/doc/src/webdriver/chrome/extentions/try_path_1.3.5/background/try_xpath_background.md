# Модуль try_xpath_background.js

## Обзор

Данный JavaScript-модуль отвечает за обработку сообщений, полученных от вкладок, и выполнение соответствующих действий. Он реализует функционал для управления отображением результатов поиска XPath, загрузки стилей и настройки атрибутов. Модуль использует API браузера для взаимодействия с вкладками и хранилищем настроек.

## Переменные

### `tx`

**Описание**: псевдоним для `tryxpath`.

### `fu`

**Описание**: псевдоним для `tryxpath.functions`.

### `popupState`

**Описание**: Хранит состояние всплывающего окна.

### `popupCss`

**Описание**: Стиль CSS для всплывающего окна.

### `results`

**Описание**: Хранит результаты поиска XPath.

### `css`

**Описание**:  Хранит загруженный CSS-код.

### `attributes`

**Описание**: Объект, содержащий атрибуты для выделения элементов.


## Функции

### `loadDefaultCss`

**Описание**: Загружает CSS-стили по умолчанию из файла `/css/try_xpath_insert.css`.

**Возвращает**:
- `Promise<string>`:  Текст загруженного CSS.

**Обрабатывает исключения**:
- `Ошибка запроса`: Обрабатывается в `catch` блоке `fu.onError`.


### `genericListener`

**Описание**: Общая обработчика сообщений.

**Параметры**:
- `message`: Объект с данными сообщения.
- `sender`: Объект, описывающий отправителя сообщения.
- `sendResponse`: Функция для отправки ответа.

**Возвращает**:
- `boolean` или `void`:  Возвращает `true`, если обработка завершена, или ничего.


**Обрабатывает исключения**:
- `Ошибка обработки сообщения`: Обрабатывается в `genericListener.listeners`.


### `genericListener.listeners.storePopupState`

**Описание**: Запоминает состояние всплывающего окна.

**Параметры**:
- `message`: Объект с данными сообщения. Содержит поле `state` со значением состояния всплывающего окна.

**Возвращает**:
- `void`


### `genericListener.listeners.requestRestorePopupState`

**Описание**: Восстанавливает состояние всплывающего окна.

**Параметры**:
- `message`: Объект с данными сообщения. Содержит поле `state` со значением состояния всплывающего окна.

**Возвращает**:
- `void`

### `genericListener.listeners.requestInsertStyleToPopup`

**Описание**: Отправляет сообщение для вставки CSS-стиля в всплывающее окно.

**Возвращает**:
- `void`


### `genericListener.listeners.showAllResults`

**Описание**: Создает новую вкладку для отображения результатов поиска.

**Параметры**:
- `message`: Объект с данными сообщения.
- `sender`: Объект, описывающий отправителя сообщения.

**Возвращает**:
- `void`


### `genericListener.listeners.loadResults`

**Описание**: Отправляет результаты поиска в ответ на запрос.

**Параметры**:
- `message`: Объект с данными сообщения.
- `sender`: Объект, описывающий отправителя сообщения.
- `sendResponse`: Функция для отправки ответа.

**Возвращает**:
- `true`: Указывает, что обработка завершена успешно.

**Обрабатывает исключения**:
- `fu.onError`: В случае ошибки при отправке ответа.


### `genericListener.listeners.updateCss`

**Описание**: Обновляет CSS-стили на вкладке.

**Параметры**:
- `message`: Объект с данными сообщения. Содержит `expiredCssSet` со списком устаревших CSS-правил.
- `sender`: Объект, описывающий отправителя сообщения.

**Возвращает**:
- `void`

**Обрабатывает исключения**:
- `fu.onError`: В случае ошибки при добавлении или удалении CSS.


### `genericListener.listeners.loadOptions`

**Описание**: Отправляет атрибуты, стили и CSS всплывающего окна.

**Параметры**:
- `message`: Объект с данными сообщения.
- `sender`: Объект, описывающий отправителя сообщения.
- `sendResponse`: Функция для отправки ответа.

**Возвращает**:
- `true`: Указывает, что обработка завершена успешно.


### `genericListener.listeners.requestSetContentInfo`

**Описание**: Устанавливает информацию об атрибутах для элементов.

**Параметры**:
- `message`: Объект с данными сообщения.
- `sender`: Объект, описывающий отправителя сообщения.

**Возвращает**:
- `void`


## Обработчики изменений хранилища

### `browser.storage.onChanged.addListener`

**Описание**: Обработчик изменений в хранилище. Обновляет `attributes`, `css` и `popupCss` при изменениях.

**Параметры**:
- `changes`: Объект, содержащий информацию о внесенных изменениях.

**Возвращает**:
- `void`


## Инициализация

### `browser.storage.sync.get`

**Описание**: Загружает значения из синхронизированного хранилища браузера.

**Параметры**:
- `options`: Объект с заданными значениями по умолчанию.

**Возвращает**:
- `Promise<Object>`:  Возвращает загруженные значения.

**Обрабатывает исключения**:
- `fu.onError`: В случае ошибки при получении значений из хранилища.