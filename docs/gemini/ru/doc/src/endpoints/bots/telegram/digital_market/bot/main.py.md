# Модуль main.py

## Обзор

Модуль `main.py` является точкой входа для Telegram-бота `digital_market` и отвечает за настройку, запуск и остановку приложения. Он включает в себя регистрацию промежуточного программного обеспечения (middleware), маршрутизаторов (routers), настройку webhook-ов, а также обработку событий запуска и остановки приложения.

## Подробней

Этот модуль выполняет следующие основные функции:

1.  **Настройка и запуск бота**: Определяет команды по умолчанию для бота, устанавливает webhook для приема обновлений от Telegram и отправляет уведомления администраторам о запуске и остановке бота.
2.  **Регистрация компонентов приложения**: Регистрирует middleware для работы с базой данных и маршрутизаторы для обработки различных типов запросов (административные, пользовательские, запросы каталога).
3.  **Создание и настройка веб-приложения**: Создает веб-приложение на основе `aiohttp`, настраивает маршруты для обработки webhook-ов, результатов и ошибок Robokassa, а также главной страницы.
4.  **Обработка событий жизненного цикла приложения**: Определяет функции, которые выполняются при запуске и остановке приложения, включая отправку уведомлений администраторам, удаление webhook-а и закрытие сессии бота.

## Функции

### `set_default_commands`

```python
async def set_default_commands():
    """
    Устанавливает команды по умолчанию для бота.
    """
```

**Описание**: Устанавливает команды по умолчанию для Telegram-бота, такие как `/start`.

**Параметры**:

-   Нет

**Возвращает**:

-   `None`

**Вызывает исключения**:

-   Не вызывает исключений.

**Примеры**:

```python
await set_default_commands()
```

### `on_startup`

```python
async def on_startup(app):
    """
    Выполняется при запуске приложения.
    """
```

**Описание**: Функция, выполняемая при запуске приложения. Она устанавливает команды по умолчанию для бота, устанавливает webhook и отправляет сообщение администраторам о запуске бота.

**Параметры**:

-   `app` (`web.Application`): Экземпляр веб-приложения `aiohttp`.

**Возвращает**:

-   `None`

**Вызывает исключения**:

-   `Exception`: В случае ошибки при отправке сообщения администратору.

**Примеры**:

```python
app = web.Application()
app.on_startup.append(on_startup)
```

### `on_shutdown`

```python
async def on_shutdown(app):
    """
    Выполняется при остановке приложения.
    """
```

**Описание**: Функция, выполняемая при остановке приложения. Она отправляет сообщение администраторам об остановке бота, удаляет webhook и закрывает сессию бота.

**Параметры**:

-   `app` (`web.Application`): Экземпляр веб-приложения `aiohttp`.

**Возвращает**:

-   `None`

**Вызывает исключения**:

-   `Exception`: В случае ошибки при отправке сообщения администратору.

**Примеры**:

```python
app = web.Application()
app.on_shutdown.append(on_shutdown)
```

### `register_middlewares`

```python
def register_middlewares():
    """
    Регистрирует мидлвари для диспетчера.
    """
```

**Описание**: Регистрирует middleware для диспетчера, такие как `DatabaseMiddlewareWithoutCommit` и `DatabaseMiddlewareWithCommit`.

**Параметры**:

-   Нет

**Возвращает**:

-   `None`

**Вызывает исключения**:

-   Не вызывает исключений.

**Примеры**:

```python
register_middlewares()
```

### `register_routers`

```python
def register_routers():
    """
    Регистрирует маршруты для диспетчера.
    """
```

**Описание**: Регистрирует маршруты для диспетчера, включая маршруты для каталога, пользователей и администраторов.

**Параметры**:

-   Нет

**Возвращает**:

-   `None`

**Вызывает исключения**:

-   Не вызывает исключений.

**Примеры**:

```python
register_routers()
```

### `create_app`

```python
def create_app():
    """
    Создает и настраивает приложение aiohttp.
    """
```

**Описание**: Создает и настраивает приложение `aiohttp`, регистрирует обработчики маршрутов, настраивает приложение с диспетчером и ботом, а также регистрирует функции запуска и остановки.

**Параметры**:

-   Нет

**Возвращает**:

-   `app` (`web.Application`): Созданное и настроенное веб-приложение `aiohttp`.

**Вызывает исключения**:

-   Не вызывает исключений.

**Примеры**:

```python
app = create_app()
```

### `main`

```python
def main():
    """
    Главная функция для запуска приложения.
    """
```

**Описание**: Главная функция для запуска приложения. Она регистрирует middleware и маршрутизаторы, создает приложение и запускает его.

**Параметры**:

-   Нет

**Возвращает**:

-   `None`

**Вызывает исключения**:

-   Не вызывает исключений.

**Примеры**:

```python
main()
```