# Модуль `Bard.py`

## Обзор

Модуль предоставляет интерфейс для взаимодействия с моделью Google Bard. Он позволяет отправлять запросы к Bard и получать ответы. Модуль использует библиотеку `requests` для отправки HTTP-запросов и `browser_cookie3` для получения файлов cookie из браузера, необходимых для аутентификации.

## Подробней

Этот код является частью проекта `hypotez` и предназначен для интеграции с различными AI-провайдерами. Он специфически реализует взаимодействие с Google Bard, используя endpoint `https://bard.google.com`. Для работы требуется аутентификация, основанная на cookies, полученных из браузера пользователя. Важно отметить, что для корректной работы может потребоваться использование прокси из-за ограничений доступа к Google Bard в некоторых странах.

## Функции

### `_create_completion`

```python
def _create_completion(model: str, messages: list, stream: bool, **kwargs):
    """
    Создает запрос к модели Google Bard и возвращает ответ.

    Args:
        model (str): Название модели (в данном случае всегда 'Palm2').
        messages (list): Список сообщений для отправки в Bard. Каждое сообщение представляет собой словарь с ключами 'role' и 'content'.
        stream (bool): Флаг, определяющий, использовать ли потоковую передачу данных (в данном случае всегда `False`).
        **kwargs: Дополнительные аргументы, такие как прокси.

    Returns:
        Generator[str, None, None]: Генератор, выдающий части ответа от Bard. В случае ошибки выдает 'error'.

    Raises:
        KeyError: Если не удается получить cookie '__Secure-1PSID' из браузера.
        requests.RequestException: В случае проблем с HTTP-запросом.
        json.JSONDecodeError: Если не удается декодировать ответ JSON.

    Как работает функция:
    1. Извлекает cookie '__Secure-1PSID' из браузера Chrome для аутентификации.
    2. Форматирует список сообщений в строку, пригодную для отправки в Bard.
    3. Определяет, использовать ли прокси.
    4. Создает HTTP-сессию и устанавливает необходимые заголовки, включая cookie '__Secure-1PSID'.
    5. Получает токен `SNlM0e`, необходимый для отправки запросов.
    6. Формирует параметры запроса и данные для отправки.
    7. Отправляет POST-запрос к Bard и получает ответ.
    8. Извлекает данные чата из ответа и выдает их по частям с использованием генератора.

    Внутри функции происходят следующие действия и преобразования:
    A. **Извлечение cookie**: Извлекает значение cookie '__Secure-1PSID' из браузера Chrome.
    |
    B. **Форматирование сообщений**: Преобразует список сообщений в строку, пригодную для отправки в Bard.
    |
    C. **Настройка прокси**: Устанавливает параметры прокси, если они указаны.
    |
    D. **Создание HTTP-сессии**: Создает HTTP-сессию с необходимыми заголовками, включая cookie '__Secure-1PSID'.
    |
    E. **Получение токена SNlM0e**: Получает токен SNlM0e, необходимый для отправки запросов.
    |
    F. **Отправка запроса и получение ответа**: Отправляет POST-запрос к Bard и получает ответ.
    |
    G. **Извлечение данных чата**: Извлекает данные чата из ответа и выдает их по частям с использованием генератора.

    Примеры:
    Пример 1: Отправка простого запроса без прокси.
    ```python
    messages = [{'role': 'user', 'content': 'Hello, Bard!'}]
    for response_part in _create_completion(model='Palm2', messages=messages, stream=False):
        print(response_part)
    ```

    Пример 2: Отправка запроса с использованием прокси.
    ```python
    messages = [{'role': 'user', 'content': 'Tell me a joke.'}]
    proxy = 'your_proxy_address:port'
    for response_part in _create_completion(model='Palm2', messages=messages, stream=False, proxy=proxy):
        print(response_part)
    ```

    Пример 3: Обработка ошибки при отсутствии cookie.
    ```python
    try:
        messages = [{'role': 'user', 'content': 'Hi'}]
        for response_part in _create_completion(model='Palm2', messages=messages, stream=False):
            print(response_part)
    except KeyError as ex:
        logger.error('Не удалось получить cookie __Secure-1PSID', ex, exc_info=True)
    ```
    """
    ...

```

## Переменные

- `url`: URL-адрес Google Bard (`https://bard.google.com`).
- `model`: Список поддерживаемых моделей (в данном случае `['Palm2']`).
- `supports_stream`: Флаг, указывающий, поддерживает ли модель потоковую передачу данных (`False`).
- `needs_auth`: Флаг, указывающий, требуется ли аутентификация (`True`).
- `params`: Строка, содержащая информацию о поддерживаемых типах данных для функции `_create_completion`.