```markdown
# proxy-from-env

`proxy-from-env` is a Node.js package that exports a function (`getProxyForUrl`)
to determine the appropriate proxy URL for a given input URL based on standard
proxy environment variables.  This function considers `NO_PROXY` to potentially
disable proxying for specific hosts.

## Installation

```bash
npm install proxy-from-env
```

## Usage

```javascript
const getProxyForUrl = require('proxy-from-env').getProxyForUrl;
const url = require('url');

const targetUrl = 'https://example.com';
const proxyUrl = getProxyForUrl(targetUrl);

if (proxyUrl) {
  console.log(`Using proxy: ${proxyUrl}`);
  // ... handle proxying the request to proxyUrl ...
  const parsedTargetUrl = url.parse(targetUrl);
  const parsedProxyUrl = url.parse(proxyUrl);
  // Construct the request options for the HTTP proxy, including the correct headers.
  const httpOptions = {
    protocol: parsedProxyUrl.protocol,
    hostname: parsedProxyUrl.hostname,
    port: parsedProxyUrl.port,
    path: parsedTargetUrl.href,  // Important: Use the full target URL's path
    headers: {
      Host: parsedTargetUrl.host,
    },
  };

  // Example using `https` module (adapt for other modules)
  const https = require('https');

  https.get(httpOptions, (res) => {
    console.log(`Status: ${res.statusCode}`);
  }).on('error', (error) => {
    console.error('Error:', error);
  });

} else {
  console.log('No proxy configured.');
  // ... handle the direct request to targetUrl ...
  const https = require('https');
  https.get(targetUrl, (res) => {
    console.log(`Status: ${res.statusCode}`);
  }).on('error', (error) => {
    console.error('Error:', error);
  });
}

```

## Environment Variables

The library supports environment variables for setting proxies.  These variables
are case-insensitive. Lowercase names take precedence over uppercase.

* **`NO_PROXY`**: A list of hostnames (optionally with ports).  If the target URL
  matches any entry in `NO_PROXY`, no proxy will be used.  Spaces and commas can
  separate entries.

* **Protocol-Specific Proxy Variables**:  Variables like `HTTP_PROXY`,
  `HTTPS_PROXY`, `FTP_PROXY`, etc. These should be used to set proxy servers
  specific to the protocol of the target URL.

* **`ALL_PROXY`**: Fallback proxy if no protocol-specific proxy is found.

**Important Considerations:**

* **Error Handling**: The example code includes basic error handling for the
  `https.get` request. Robust error handling is crucial in production code.
* **Request Method**: The example uses `https.get`.  For other methods (e.g.,
  `https.request`), you need to adapt the code accordingly to handle the
  request options appropriately.
* **`NO_PROXY` Matching**: The matching logic for `NO_PROXY` is complex and
  based on observed behavior from various systems (e.g., cURL).  Refer to the
  original documentation for full details on how hostnames and ports are
  compared.
* **URL Parsing**: Using `url.parse` is essential for correctly handling URLs and
  extracting necessary components like host, port, and path.
* **Security**:  Ensure you thoroughly validate input URLs and proxy configurations
  to prevent security vulnerabilities.  Never blindly trust user input or
  environment variables.

## Example with `NO_PROXY`

```
// Set NO_PROXY to disable proxies for example.com
process.env.NO_PROXY = 'example.com';

// ... your code using getProxyForUrl ...
```

This will result in a direct request to `example.com` if the environment variable is set.

## External Resources

The library attempts to follow standard practices from various HTTP clients
(e.g., cURL, wget) regarding proxy environment variables.  The cited external
resources in the original documentation provide further context on parsing
and usage.


```
```
