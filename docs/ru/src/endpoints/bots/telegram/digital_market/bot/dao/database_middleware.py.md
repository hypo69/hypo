# Документация модуля `database_middleware.py`

## Обзор

Модуль `database_middleware.py` содержит классы промежуточного программного обеспечения (middleware) для работы с базой данных в контексте Telegram-бота на основе `aiogram`. Он включает абстрактный базовый класс `BaseDatabaseMiddleware`, а также его реализации `DatabaseMiddlewareWithoutCommit` и `DatabaseMiddlewareWithCommit`, которые управляют сессиями базы данных и их жизненным циклом во время обработки запросов.

## Содержание

1.  [Класс `BaseDatabaseMiddleware`](#класс-basedatabasemiddleware)
    *   [Метод `__call__`](#__call__)
    *   [Метод `set_session`](#метод-set_session)
    *   [Метод `after_handler`](#метод-after_handler)
2.  [Класс `DatabaseMiddlewareWithoutCommit`](#класс-databasemiddlewarewithoutcommit)
    *   [Метод `set_session`](#метод-set_session-1)
3.  [Класс `DatabaseMiddlewareWithCommit`](#класс-databasemiddlewarewithcommit)
    *   [Метод `set_session`](#метод-set_session-2)
    *   [Метод `after_handler`](#метод-after_handler-1)

## Классы

### `BaseDatabaseMiddleware`

**Описание**:
Базовый класс middleware для управления сессиями базы данных. Он обеспечивает создание и закрытие сессии, а также обработку ошибок и откат транзакций.

**Методы**:

#### `__call__`

**Описание**:
Основной метод middleware, вызывается для обработки события. Создает сессию базы данных, устанавливает её в данные, вызывает обработчик, выполняет действия после хендлера и закрывает сессию.

**Параметры**:
- `handler` (Callable[[Message | CallbackQuery, Dict[str, Any]], Awaitable[Any]]): Функция-обработчик события.
- `event` (Message | CallbackQuery): Событие от Telegram API.
- `data` (Dict[str, Any]): Словарь данных, передаваемый между middleware и обработчиком.

**Возвращает**:
- `Any`: Результат работы обработчика.

**Вызывает исключения**:
- `Exception`: Любое исключение, возникшее во время работы обработчика.

#### `set_session`

**Описание**:
Метод для установки сессии в словарь данных.

**Параметры**:
- `data` (Dict[str, Any]): Словарь данных.
- `session`: Сессия базы данных.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `NotImplementedError`: Если метод не переопределен в подклассе.

#### `after_handler`

**Описание**:
Метод для выполнения действий после вызова хендлера (например, коммит).

**Параметры**:
- `session`: Сессия базы данных.

**Возвращает**:
- `None`

### `DatabaseMiddlewareWithoutCommit`

**Описание**:
Middleware, который устанавливает сессию базы данных в данные без автоматического коммита.

**Методы**:

#### `set_session`

**Описание**:
Устанавливает сессию базы данных в словарь данных под ключом `session_without_commit`.

**Параметры**:
- `data` (Dict[str, Any]): Словарь данных.
- `session`: Сессия базы данных.

**Возвращает**:
- `None`

### `DatabaseMiddlewareWithCommit`

**Описание**:
Middleware, который устанавливает сессию базы данных в данные и выполняет коммит после успешного выполнения обработчика.

**Методы**:

#### `set_session`

**Описание**:
Устанавливает сессию базы данных в словарь данных под ключом `session_with_commit`.

**Параметры**:
- `data` (Dict[str, Any]): Словарь данных.
- `session`: Сессия базы данных.

**Возвращает**:
- `None`

#### `after_handler`

**Описание**:
Выполняет коммит сессии базы данных после успешного выполнения обработчика.

**Параметры**:
- `session`: Сессия базы данных.

**Возвращает**:
- `None`