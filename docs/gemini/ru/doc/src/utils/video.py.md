# Модуль для работы с видео
=================================================

Модуль `src.utils.video` предоставляет асинхронные функции для скачивания и сохранения видеофайлов, а также для получения видеоданных. Он включает обработку ошибок и логирование для обеспечения надежной работы.

Пример использования
----------------------

```python
>>> import asyncio
>>> asyncio.run(save_video_from_url("https://example.com/video.mp4", "local_video.mp4"))
PosixPath('local_video.mp4')  # или None, если не удалось

>>> data = get_video_data("local_video.mp4")
>>> if data:
...     print(data[:10])  # Вывести первые 10 байт для проверки
b'\x00\x00\x00...'
```

## Оглавление

- [Обзор](#обзор)
- [Подробнее](#подробнее)
- [Функции](#функции)
    - [`save_video_from_url`](#save_video_from_url)
    - [`get_video_data`](#get_video_data)
    - [`main`](#main)

## Обзор

Модуль содержит функции для асинхронной загрузки и сохранения видео с использованием URL, а также для получения двоичных данных видеофайла. Он включает обработку ошибок и логирование.

## Подробнее

Этот модуль предоставляет инструменты для работы с видеофайлами, такие как скачивание видео по URL-адресу и сохранение его локально, а также чтение данных видеофайла. Он использует асинхронные операции для обеспечения неблокирующего поведения.

## Функции

### `save_video_from_url`

```python
async def save_video_from_url(url: str, save_path: str) -> Optional[Path]:
    """Скачивает видео с URL-адреса и сохраняет его локально асинхронно.

    Args:
        url (str): URL-адрес, с которого нужно скачать видео.
        save_path (str): Путь для сохранения скачанного видео.

    Returns:
        Optional[Path]: Путь к сохраненному файлу или `None`, если операция не удалась. Возвращает `None` при ошибках и если размер файла равен 0 байт.

    Raises:
        aiohttp.ClientError: При сетевых проблемах во время скачивания.
    """
```

**Назначение**: Асинхронно скачивает видеофайл по указанному URL-адресу и сохраняет его в указанном месте на диске. Функция обрабатывает сетевые ошибки и проверяет целостность сохраненного файла.

**Параметры**:
- `url` (str): URL-адрес видеофайла для скачивания.
- `save_path` (str): Локальный путь для сохранения скачанного видеофайла.

**Возвращает**:
- `Optional[Path]`: Объект `Path`, представляющий путь к сохраненному файлу, если скачивание и сохранение прошли успешно. Возвращает `None` в случае ошибки или если размер файла после скачивания равен 0 байт.

**Вызывает исключения**:
- `aiohttp.ClientError`: Возникает при сетевых проблемах во время скачивания видео.
- `Exception`: Возникает при любых других ошибках во время выполнения функции, таких как ошибки записи файла.

**Как работает функция**:
1. Функция принимает URL-адрес видео и путь для сохранения файла.
2. Создается асинхронная сессия клиента с использованием `aiohttp`.
3. Выполняется GET-запрос к указанному URL-адресу.
4. Проверяется статус ответа на наличие HTTP-ошибок.
5. Создаются родительские директории для пути сохранения, если они не существуют.
6. Открывается файл для записи в двоичном режиме асинхронно.
7. Чтение содержимого ответа чанками (по 8192 байт) и запись их в файл до тех пор, пока не будет достигнут конец содержимого.
8. После завершения скачивания проверяется, был ли файл успешно сохранен и не является ли он пустым.
9. В случае успеха возвращается путь к сохраненному файлу.
10. В случае возникновения ошибок, таких как сетевые проблемы или ошибки записи файла, функция логирует ошибку и возвращает `None`.

```
save_video_from_url
│
├─── create_session (aiohttp.ClientSession)
│   │
│   └─── get_response (session.get(url))
│       │
│       ├─── raise_for_status (response.raise_for_status())
│       │
│       ├─── create_directories (save_path.parent.mkdir)
│       │
│       └─── open_file (aiofiles.open(save_path, "wb"))
│           │
│           └─── read_chunks_and_write (response.content.read(8192) -> file.write(chunk))
│               │
│               └─── check_file_integrity (save_path.exists() and save_path.stat().st_size > 0)
│
└─── return_path (return save_path)

```

**Примеры**:
```python
import asyncio
from pathlib import Path
# Пример успешного скачивания
url = "https://example.com/video.mp4"
save_path = "local_video.mp4"
result = asyncio.run(save_video_from_url(url, save_path))
if result:
    print(f"Видео сохранено в {result}")

# Пример неудачного скачивания из-за сетевой ошибки
url = "https://example.com/non_existent_video.mp4"
save_path = "local_video.mp4"
result = asyncio.run(save_video_from_url(url, save_path))
if result is None:
    print("Не удалось скачать видео")
```

### `get_video_data`

```python
def get_video_data(file_name: str) -> Optional[bytes]:
    """Извлекает двоичные данные видеофайла, если он существует.

    Args:
        file_name (str): Путь к видеофайлу для чтения.

    Returns:
        Optional[bytes]: Двоичные данные файла, если он существует, или `None`, если файл не найден или произошла ошибка.
    """
```

**Назначение**: Читает и возвращает двоичные данные видеофайла. Функция проверяет существование файла перед чтением и обрабатывает возможные ошибки при чтении файла.

**Параметры**:
- `file_name` (str): Путь к видеофайлу, данные которого необходимо прочитать.

**Возвращает**:
- `Optional[bytes]`: Двоичные данные видеофайла в виде объекта `bytes`, если файл существует и чтение прошло успешно. Возвращает `None`, если файл не найден или произошла ошибка при чтении.

**Вызывает исключения**:
- Отсутствуют явные исключения, но функция обрабатывает исключения, которые могут возникнуть при открытии и чтении файла.

**Как работает функция**:
1. Функция принимает путь к видеофайлу.
2. Проверяется существование файла по указанному пути.
3. Если файл не существует, функция логирует ошибку и возвращает `None`.
4. Если файл существует, он открывается в двоичном режиме для чтения.
5. Считываются все данные из файла.
6. В случае успеха возвращаются двоичные данные файла.
7. В случае возникновения ошибок при открытии или чтении файла, функция логирует ошибку и возвращает `None`.

```
get_video_data
│
├─── check_file_exists (file_path.exists())
│   │
│   └─── open_file (open(file_path, "rb"))
│       │
│       └─── read_file (file.read())
│
└─── return_data (return file.read())
```

**Примеры**:

```python
# Пример успешного чтения данных из файла
file_name = "local_video.mp4"
data = get_video_data(file_name)
if data:
    print(f"Прочитано {len(data)} байт из файла {file_name}")

# Пример неудачного чтения из-за отсутствия файла
file_name = "non_existent_video.mp4"
data = get_video_data(file_name)
if data is None:
    print(f"Файл {file_name} не найден")
```

### `main`

```python
def main():
    """
    Основная функция для демонстрации работы функций модуля.
    """
```

**Назначение**:
Основная функция для демонстрации работы функций модуля.

**Параметры**:
- Отсутствуют.

**Возвращает**:
- Ничего.

**Как работает функция**:
1. Определяет URL-адрес видео и путь для сохранения.
2. Запускает асинхронную функцию `save_video_from_url` для скачивания и сохранения видео.
3. Выводит сообщение об успехе или неудаче скачивания.

```
main
│
├─── set_url_and_path
│
└─── run_save_video_from_url (asyncio.run(save_video_from_url(url, save_path)))
│
└─── print_result
```

**Примеры**:

```python
# Пример запуска функции main
if __name__ == "__main__":
    main()