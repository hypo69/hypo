# Модуль для работы с H2o API
=================================

Модуль содержит класс :class:`H2o`, который используется для взаимодействия с H2o AI API для генерации текста.
Он поддерживает асинхронный режим работы и предоставляет возможность настройки параметров запроса.

## Обзор

Этот модуль предоставляет асинхронный интерфейс для взаимодействия с API H2o.ai. Он позволяет отправлять запросы на генерацию текста, используя указанную модель, и получать результаты в виде асинхронного генератора. Модуль также поддерживает использование прокси-серверов для выполнения запросов.

## Подробней

Модуль предназначен для использования в асинхронных приложениях, требующих взаимодействия с API H2o.ai для генерации текста. Он предоставляет удобный интерфейс для настройки параметров запроса, таких как температура, максимальное количество токенов и другие. Модуль также обеспечивает обработку ошибок и исключений, возникающих при выполнении запросов.

## Классы

### `H2o`

**Описание**:
Класс `H2o` является асинхронным провайдером генерации текста, использующим API H2o.ai.

**Наследует**:

- `AsyncGeneratorProvider`: H2o наследует функциональность асинхронного генератора от `AsyncGeneratorProvider`.

**Атрибуты**:

- `url` (str): URL API H2o.ai.
- `model` (str): Название используемой модели.

**Методы**:

- `create_async_generator`: Создает асинхронный генератор для получения текста от API H2o.ai.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения текста от API H2o.ai.

    Args:
        model (str): Название используемой модели.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные параметры для передачи в API.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий текст от API H2o.ai.

    Raises:
        Exception: Возникает при ошибках при выполнении запроса к API.

    """
```

**Назначение**:
Функция `create_async_generator` создает асинхронный генератор, который отправляет запросы в API H2o.ai и возвращает сгенерированный текст. Она использует `aiohttp.ClientSession` для выполнения асинхронных HTTP-запросов и обрабатывает ответы от API, извлекая текст из потока данных.

**Параметры**:

- `cls` (type[H2o]): Класс, для которого вызывается метод.
- `model` (str): Название используемой модели. Если не указано, используется значение по умолчанию из атрибута `cls.model`.
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры для передачи в API, такие как `temperature`, `max_new_tokens` и другие.

**Возвращает**:

- `AsyncResult`: Асинхронный генератор, возвращающий текст от API H2o.ai.

**Вызывает исключения**:

- `Exception`: Возникает при ошибках при выполнении запроса к API, например, при неверном формате ответа или сетевых проблемах.

**Как работает функция**:

1. **Инициализация**: Функция `create_async_generator` начинает работу с подготовки необходимых данных и заголовков для запроса. Если модель не указана, используется значение по умолчанию из атрибута `cls.model`.
2. **Создание сессии**: Создается асинхронная сессия `aiohttp.ClientSession` с необходимыми заголовками, включая `Referer`.
3. **Настройка параметров**: Отправляется POST-запрос к `/settings` для установки параметров, таких как принятие условий использования и включение поиска.
4. **Создание диалога**: Отправляется POST-запрос к `/conversation` для создания нового диалога с указанной моделью.
5. **Формирование данных запроса**: Формируются данные запроса, включающие отформатированные сообщения, параметры генерации текста (температура, максимальное количество токенов и т.д.) и опции запроса (уникальные идентификаторы, флаг повторной попытки и т.д.).
6. **Отправка запроса и получение данных**: Отправляется POST-запрос к `/conversation/{conversationId}` с данными запроса. Функция начинает асинхронно читать поток данных из ответа.
7. **Обработка потока данных**: Для каждой строки в потоке данных проверяется, начинается ли она с префикса `data:`. Если да, строка преобразуется из JSON и извлекается текст из поля `token.text`, если токен не является специальным.
8. **Завершение диалога**: После завершения получения данных отправляется DELETE-запрос к `/conversation/{conversationId}` для завершения диалога.
9. **Генерация текста**: Функция `create_async_generator` использует `yield` для возвращения каждой части сгенерированного текста, что позволяет использовать ее как асинхронный генератор.

**Внутренние функции**: Нет

**Примеры**:

```python
import asyncio
from typing import AsyncGenerator, List, Dict, Any

from g4f.Provider import H2o

async def main():
    messages: List[Dict[str, str]] = [
        {"role": "user", "content": "Напиши небольшое стихотворение о природе."}
    ]
    model: str = "h2oai/h2ogpt-gm-oasst1-en-2048-falcon-40b-v1"

    generator: AsyncGenerator[str, Any] = await H2o.create_async_generator(model=model, messages=messages)
    async for message in generator:
        print(message, end="")

if __name__ == "__main__":
    asyncio.run(main())
```

**ASCII flowchart**:

```
A: Получение параметров (model, messages, proxy, kwargs)
|
B: Создание aiohttp.ClientSession с заголовками
|
C: Отправка POST-запроса к /settings для настройки параметров
|
D: Отправка POST-запроса к /conversation для создания диалога
|
E: Формирование данных запроса (inputs, parameters, stream, options)
|
F: Отправка POST-запроса к /conversation/{conversationId} для получения данных
|
G: Асинхронное чтение потока данных из ответа
|
H: Обработка каждой строки потока данных (извлечение текста из JSON)
|
I: Отправка DELETE-запроса к /conversation/{conversationId} для завершения диалога
|
J: Генерация текста (yield)