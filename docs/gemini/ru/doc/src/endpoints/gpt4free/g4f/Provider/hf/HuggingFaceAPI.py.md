# Модуль HuggingFaceAPI

## Обзор

Модуль `HuggingFaceAPI` предназначен для взаимодействия с моделями Hugging Face для генерации текста. Он предоставляет класс `HuggingFaceAPI`, который наследуется от `OpenaiTemplate` и реализует методы для получения моделей, создания асинхронного генератора и выполнения других связанных задач. Этот модуль обеспечивает поддержку различных моделей, включая модели для работы с текстом и изображениями.

## Подробней

Модуль `HuggingFaceAPI` является частью проекта `hypotez` и предназначен для интеграции с моделями Hugging Face для задач генерации текста. Он использует API Hugging Face для взаимодействия с моделями и предоставляет удобный интерфейс для работы с ними. Этот модуль поддерживает как текстовые, так и визуальные модели, а также предоставляет возможность настройки параметров запроса, таких как максимальное количество токенов и длина входных данных.

## Классы

### `HuggingFaceAPI`

**Описание**: Класс `HuggingFaceAPI` предназначен для взаимодействия с API Hugging Face для генерации текста.

**Наследует**: `OpenaiTemplate`

**Атрибуты**:

- `label` (str): Метка провайдера "HuggingFace (Text Generation)".
- `parent` (str): Родительский провайдер "HuggingFace".
- `url` (str): URL API Hugging Face "https://api-inference.huggingface.com".
- `api_base` (str): Базовый URL API Hugging Face "https://api-inference.huggingface.co/v1".
- `working` (bool): Указывает, работает ли провайдер (True).
- `needs_auth` (bool): Указывает, требуется ли аутентификация (True).
- `default_model` (str): Модель по умолчанию (`default_llama_model`).
- `default_vision_model` (str): Визуальная модель по умолчанию (`default_vision_model`).
- `vision_models` (list[str]): Список визуальных моделей (`vision_models`).
- `model_aliases` (dict[str, str]): Псевдонимы моделей (`model_aliases`).
- `fallback_models` (list[str]): Резервные модели (`text_models` + `vision_models`).
- `provider_mapping` (dict[str, dict]): Сопоставление моделей с провайдерами.

**Методы**:

- `get_model(model: str, **kwargs) -> str`: Возвращает модель на основе предоставленного имени.
- `get_models(**kwargs) -> list[str]`: Возвращает список доступных моделей.
- `get_mapping(model: str, api_key: str = None) -> dict`: Возвращает сопоставление моделей с провайдерами.
- `create_async_generator(model: str, messages: Messages, api_base: str = None, api_key: str = None, max_tokens: int = 2048, max_inputs_lenght: int = 10000, media: MediaListType = None, **kwargs)`: Создает асинхронный генератор для генерации текста.

## Функции

### `get_model`

```python
    @classmethod
    def get_model(cls, model: str, **kwargs) -> str:
        """Возвращает модель на основе предоставленного имени.

        Args:
            model (str): Имя модели.
            **kwargs: Дополнительные аргументы.

        Returns:
            str: Имя модели.

        Raises:
            ModelNotSupportedError: Если модель не поддерживается.
        """
        ...
```

**Назначение**: Получение имени модели.

**Параметры**:

- `model` (str): Имя модели, которую необходимо получить.
- `**kwargs`: Дополнительные именованные аргументы, которые могут быть переданы в функцию.

**Возвращает**:

- `str`: Имя модели.

**Вызывает исключения**:

- `ModelNotSupportedError`: Если модель не поддерживается.

**Как работает функция**:

1.  Функция `get_model` пытается получить модель, используя метод `super().get_model(model, **kwargs)`.
2.  Если возникает исключение `ModelNotSupportedError`, функция возвращает исходное имя модели `model`.

```ascii
      A
      |
      B
```

Где:

- `A`: Попытка получить модель с использованием родительского класса.
- `B`: Возврат исходного имени модели, если модель не поддерживается.

**Примеры**:

```python
HuggingFaceAPI.get_model("google/gemma-3-27b-it")
HuggingFaceAPI.get_model("some_unsupported_model")
```

### `get_models`

```python
    @classmethod
    def get_models(cls, **kwargs) -> list[str]:
        """Возвращает список доступных моделей.

        Args:
            **kwargs: Дополнительные аргументы.

        Returns:
            list[str]: Список доступных моделей.
        """
        ...
```

**Назначение**: Получение списка доступных моделей.

**Параметры**:

- `**kwargs`: Дополнительные именованные аргументы, которые могут быть переданы в функцию.

**Возвращает**:

- `list[str]`: Список доступных моделей.

**Как работает функция**:

1.  Функция `get_models` проверяет, инициализирован ли список моделей `cls.models`.
2.  Если список не инициализирован, функция отправляет GET-запрос к API Hugging Face для получения списка моделей.
3.  Если запрос успешен, функция извлекает идентификаторы моделей из JSON-ответа и добавляет их в список `cls.models`.
4.  Если запрос не успешен или произошла ошибка, функция использует резервный список моделей `cls.fallback_models`.
5.  Функция возвращает список доступных моделей `cls.models`.

```ascii
     A
     |
     B
     |
     -- C
     |
     D - E
     |
     F
```

Где:

- `A`: Проверка, инициализирован ли список моделей.
- `B`: Отправка GET-запроса к API Hugging Face.
- `C`: Извлечение идентификаторов моделей из JSON-ответа.
- `D`: Проверка статуса провайдера и задачи.
- `E`: Добавление идентификаторов моделей в список.
- `F`: Использование резервного списка моделей в случае ошибки.

**Примеры**:

```python
HuggingFaceAPI.get_models()
```

### `get_mapping`

```python
    @classmethod
    async def get_mapping(cls, model: str, api_key: str = None) -> dict:
        """Возвращает сопоставление моделей с провайдерами.

        Args:
            model (str): Имя модели.
            api_key (str, optional): Ключ API. По умолчанию `None`.

        Returns:
            dict: Сопоставление моделей с провайдерами.
        """
        ...
```

**Назначение**: Получение сопоставления моделей с провайдерами.

**Параметры**:

- `model` (str): Имя модели, для которой необходимо получить сопоставление.
- `api_key` (str, optional): Ключ API для аутентификации. По умолчанию `None`.

**Возвращает**:

- `dict`: Сопоставление моделей с провайдерами.

**Как работает функция**:

1.  Функция `get_mapping` проверяет, существует ли сопоставление для данной модели в `cls.provider_mapping`.
2.  Если сопоставление существует, функция возвращает его.
3.  Если сопоставление не существует, функция отправляет GET-запрос к API Hugging Face для получения информации о модели.
4.  Функция извлекает сопоставление провайдеров из JSON-ответа и сохраняет его в `cls.provider_mapping`.
5.  Функция возвращает сопоставление моделей с провайдерами.

```ascii
     A
     |
     B
     |
     C
     |
     D
```

Где:

- `A`: Проверка, существует ли сопоставление для данной модели.
- `B`: Отправка GET-запроса к API Hugging Face.
- `C`: Извлечение сопоставления провайдеров из JSON-ответа.
- `D`: Возврат сопоставления моделей с провайдерами.

**Примеры**:

```python
HuggingFaceAPI.get_mapping("google/gemma-3-27b-it")
HuggingFaceAPI.get_mapping("some_unsupported_model", api_key="your_api_key")
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        api_base: str = None,
        api_key: str = None,
        max_tokens: int = 2048,
        max_inputs_lenght: int = 10000,
        media: MediaListType = None,
        **kwargs
    ):
        """Создает асинхронный генератор для генерации текста.

        Args:
            model (str): Имя модели.
            messages (Messages): Список сообщений для генерации.
            api_base (str, optional): Базовый URL API. По умолчанию `None`.
            api_key (str, optional): Ключ API. По умолчанию `None`.
            max_tokens (int, optional): Максимальное количество токенов. По умолчанию 2048.
            max_inputs_lenght (int, optional): Максимальная длина входных данных. По умолчанию 10000.
            media (MediaListType, optional): Список медиафайлов. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.
        """
        ...
```

**Назначение**: Создание асинхронного генератора для генерации текста.

**Параметры**:

- `model` (str): Имя модели, которую необходимо использовать для генерации текста.
- `messages` (Messages): Список сообщений, которые будут переданы модели для генерации текста.
- `api_base` (str, optional): Базовый URL API. По умолчанию `None`.
- `api_key` (str, optional): Ключ API для аутентификации. По умолчанию `None`.
- `max_tokens` (int, optional): Максимальное количество токенов в сгенерированном тексте. По умолчанию 2048.
- `max_inputs_lenght` (int, optional): Максимальная длина входных данных. По умолчанию 10000.
- `media` (MediaListType, optional): Список медиафайлов, которые будут переданы модели. По умолчанию `None`.
- `**kwargs`: Дополнительные именованные аргументы, которые могут быть переданы в функцию.

**Как работает функция**:

1.  Функция `create_async_generator` сначала определяет модель, которую необходимо использовать для генерации текста. Если модель не указана и предоставлены медиафайлы, используется визуальная модель по умолчанию.
2.  Затем функция получает сопоставление модели с провайдерами, используя метод `cls.get_mapping(model, api_key)`.
3.  Если сопоставление не найдено, функция вызывает исключение `ModelNotSupportedError`.
4.  Далее функция перебирает провайдеров, определенных в сопоставлении. Для каждого провайдера функция создает URL API и определяет задачу.
5.  Если задача не является `conversational`, функция вызывает исключение `ModelNotSupportedError`.
6.  Затем функция вызывает метод `super().create_async_generator()` для создания асинхронного генератора, который будет генерировать текст.
7.  Если во время генерации возникает исключение `PaymentRequiredError`, функция продолжает перебор провайдеров.
8.  Если все провайдеры были перебраны и возникла ошибка, функция вызывает исключение `error`.

```ascii
      A
      |
      B
      |
      -- C
      |
      D - E
      |
      F
```

Где:

- `A`: Определение модели для генерации текста.
- `B`: Получение сопоставления модели с провайдерами.
- `C`: Перебор провайдеров, определенных в сопоставлении.
- `D`: Определение URL API и задачи для каждого провайдера.
- `E`: Создание асинхронного генератора для генерации текста.
- `F`: Обработка исключений и перебор провайдеров в случае ошибки.

**Примеры**:

```python
async for chunk in HuggingFaceAPI.create_async_generator(
    model="google/gemma-3-27b-it",
    messages=[{"role": "user", "content": "Hello, how are you?"}],
    api_key="your_api_key",
    max_tokens=100
):
    print(chunk)
```

### `calculate_lenght`

```python
def calculate_lenght(messages: Messages) -> int:
    """Calculate lenght messages

    Args:
        messages (Messages): _description_

    Returns:
        int: _description_
    """
    return sum([len(message["content"]) + 16 for message in messages])
```

**Назначение**: Вычисляет длину сообщений.

**Параметры**:

- `messages` (Messages): Список сообщений, для которых необходимо вычислить длину.

**Возвращает**:

- `int`: Общая длина всех сообщений.

**Как работает функция**:

1. Функция `calculate_lenght` принимает список сообщений `messages`.
2. Для каждого сообщения в списке вычисляется длина содержимого (`message["content"]`) и к ней добавляется число 16.
3. Суммируются все вычисленные значения длин.
4. Функция возвращает общую длину всех сообщений.

```ascii
     A
     |
     B
     |
     C
```

Где:

- `A`: Функция принимает список сообщений `messages`.
- `B`: Вычисляется длина содержимого каждого сообщения и добавляется 16.
- `C`: Возвращается общая длина всех сообщений.

**Примеры**:

```python
messages = [{"role": "user", "content": "Hello"}, {"role": "assistant", "content": "Hi"}]
length = calculate_lenght(messages)
print(length)  # Вывод: 30