# Модуль `helper`

## Обзор

Модуль `helper` содержит набор вспомогательных функций, используемых в различных частях проекта `hypotez` для обработки строк, форматирования сообщений, генерации случайных строк и других задач.

## Подробнее

Этот модуль предоставляет функции для преобразования различных типов данных в строки, форматирования промптов для моделей, извлечения системных сообщений, а также генерации случайных строк. Он используется для подготовки данных и взаимодействия с различными API.

## Функции

### `to_string`

```python
def to_string(value) -> str:
    """
    Преобразует значение в строку.

    Args:
        value: Значение для преобразования. Может быть строкой, словарем или списком.

    Returns:
        str: Строковое представление значения.
    """
```

**Как работает функция:**
Функция `to_string` принимает значение любого типа и преобразует его в строку. Если значение является строкой, оно возвращается без изменений. Если значение является словарем, проверяется наличие ключей "name" или "bucket_id". Если есть "bucket_id", функция пытается прочитать содержимое bucket-а, используя путь, полученный с помощью `get_bucket_dir`, и возвращает объединенную строку. Если есть ключ "type" со значением "text", возвращается значение, соответствующее ключу "text". Если значение является списком, функция рекурсивно вызывает `to_string` для каждого элемента и возвращает объединенную строку. В противном случае, функция вызывает `str(value)` и возвращает результат.

**Примеры:**

```python
to_string("test")  # возвращает "test"
to_string({"type": "text", "text": "some text"})  # возвращает "some text"
```

### `format_prompt`

```python
def format_prompt(messages: Messages, add_special_tokens: bool = False, do_continue: bool = False, include_system: bool = True) -> str:
    """
    Форматирует список сообщений в строку, опционально добавляя специальные токены.

    Args:
        messages (Messages): Список словарей сообщений, каждый из которых содержит 'role' и 'content'.
        add_special_tokens (bool): Флаг, указывающий, следует ли добавлять специальные токены форматирования.
        do_continue (bool): Флаг, указывающий, нужно ли продолжать форматирование.
        include_system (bool): Флаг, указывающий, нужно ли включать системные сообщения.

    Returns:
        str: Отформатированная строка, содержащая все сообщения.
    """
```

**Как работает функция:**
Функция `format_prompt` форматирует список сообщений, чтобы подготовить их для использования в языковых моделях. Если `add_special_tokens` равно `False` и длина списка сообщений меньше или равна 1, возвращается строковое представление содержимого первого сообщения. Функция преобразует список сообщений, исключая системные сообщения, если `include_system` равно `False`. Затем она объединяет сообщения в строку, добавляя роль каждого сообщения и его содержимое, и при необходимости добавляет "Assistant:" в конце.

**Примеры:**

```python
messages = [{"role": "user", "content": "Hello"}]
format_prompt(messages)  # возвращает "User: Hello\nAssistant:"
```

### `get_system_prompt`

```python
def get_system_prompt(messages: Messages) -> str:
    """
    Извлекает системные сообщения из списка сообщений и объединяет их в строку.

    Args:
        messages (Messages): Список словарей сообщений.

    Returns:
        str: Объединенные системные сообщения.
    """
```

**Как работает функция:**
Функция `get_system_prompt` извлекает все сообщения с ролью "system" из списка сообщений и объединяет их в одну строку, разделенную символом новой строки.

**Примеры:**

```python
messages = [{"role": "system", "content": "You are a helpful assistant."}, {"role": "user", "content": "Hello"}]
get_system_prompt(messages)  # возвращает "You are a helpful assistant."
```

### `get_last_user_message`

```python
def get_last_user_message(messages: Messages) -> str:
    """
    Извлекает последнее сообщение от пользователя из списка сообщений.

    Args:
        messages (Messages): Список словарей сообщений.

    Returns:
        str: Последнее сообщение от пользователя.
    """
```

**Как работает функция:**
Функция `get_last_user_message` извлекает последнее сообщение с ролью "user" из списка сообщений. Функция перебирает сообщения в обратном порядке и возвращает содержимое последнего сообщения от пользователя, если оно не пустое. Если таких сообщений нет, возвращается пустая строка.

**Примеры:**

```python
messages = [{"role": "assistant", "content": "Hi"}, {"role": "user", "content": "Hello"}]
get_last_user_message(messages)  # возвращает "Hello"
```

### `format_image_prompt`

```python
def format_image_prompt(messages, prompt: str = None) -> str:
    """
    Форматирует промпт для генерации изображений.

    Args:
        messages: Список словарей сообщений.
        prompt (str, optional): Промпт для генерации изображений. По умолчанию `None`.

    Returns:
        str: Отформатированный промпт.
    """
```

**Как работает функция:**
Функция `format_image_prompt` форматирует промпт для генерации изображений. Если передан параметр `prompt`, возвращается его значение. В противном случае вызывается функция `get_last_user_message` для извлечения последнего сообщения от пользователя, которое и возвращается.

**Примеры:**

```python
messages = [{"role": "user", "content": "Cat"}]
format_image_prompt(messages)  # возвращает "Cat"
```

### `format_prompt_max_length`

```python
def format_prompt_max_length(messages: Messages, max_lenght: int) -> str:
    """
    Форматирует промпт, обрезая его до максимальной длины.

    Args:
        messages (Messages): Список словарей сообщений.
        max_lenght (int): Максимальная длина промпта.

    Returns:
        str: Отформатированный промпт, обрезанный до максимальной длины.
    """
```

**Как работает функция:**
Функция `format_prompt_max_length` форматирует промпт, обрезая его до максимальной длины, если это необходимо. Сначала промпт форматируется с использованием функции `format_prompt`. Если длина промпта превышает `max_lenght`, функция пытается укоротить промпт, используя различные стратегии: сначала оставляет только первые три и последние три сообщения, затем оставляет только системные сообщения и последнее сообщение пользователя, и, наконец, оставляет только последнее сообщение пользователя. Если даже после этого длина промпта превышает `max_lenght`, возвращается содержимое последнего сообщения.

**Примеры:**

```python
messages = [{"role": "user", "content": "Very long text"}]
format_prompt_max_length(messages, 5)  # возвращает "Very long text"
```

### `get_random_string`

```python
def get_random_string(length: int = 10) -> str:
    """
    Генерирует случайную строку указанной длины, содержащую строчные буквы и цифры.

    Args:
        length (int, optional): Длина генерируемой случайной строки. По умолчанию 10.

    Returns:
        str: Случайная строка указанной длины.
    """
```

**Как работает функция:**

Функция `get_random_string` генерирует случайную строку указанной длины. Она использует модуль `random` для выбора случайных символов из набора строчных букв и цифр и объединяет их в строку.

**Примеры:**

```python
get_random_string(5)  # возвращает, например, "a1b2c"
```

### `get_random_hex`

```python
def get_random_hex(length: int = 32) -> str:
    """
    Генерирует случайную шестнадцатеричную строку длиной n символов.

    Returns:
        str: Случайная шестнадцатеричная строка из n символов.
    """
```

**Как работает функция:**

Функция `get_random_hex` генерирует случайную шестнадцатеричную строку заданной длины. Она использует модуль `random` для выбора случайных символов из набора шестнадцатеричных цифр (a-f и 0-9) и объединяет их в строку.

**Примеры:**

```python
get_random_hex(8)  # возвращает, например, "a1b2c3d4"
```

### `filter_none`

```python
def filter_none(**kwargs) -> dict:
    """
    Фильтрует словарь, удаляя элементы со значением `None`.

    Args:
        **kwargs: Произвольный набор именованных аргументов.

    Returns:
        dict: Новый словарь, содержащий только элементы, значения которых не равны `None`.
    """
```

**Как работает функция:**

Функция `filter_none` принимает произвольный набор именованных аргументов и возвращает новый словарь, содержащий только те элементы, значения которых не равны `None`.

**Примеры:**

```python
filter_none(a=1, b=None, c=2)  # возвращает {"a": 1, "c": 2}
```

### `async_concat_chunks`

```python
async def async_concat_chunks(chunks: AsyncIterator) -> str:
    """
    Асинхронно объединяет чанки в строку.

    Args:
        chunks (AsyncIterator): Асинхронный итератор чанков.

    Returns:
        str: Объединенная строка.
    """
```

**Как работает функция:**
Функция `async_concat_chunks` асинхронно объединяет чанки (части данных) из асинхронного итератора в одну строку. Она вызывает `concat_chunks`, передавая ей результат асинхронного comprehension, собирающего все чанки из переданного асинхронного итератора `chunks`.

**Внутренние функции:**
- **`concat_chunks(chunks: Iterator) -> str`**: Функция объединяет все чанки из итератора в одну строку.

**Примеры:**

```python
# Пример использования требует асинхронного контекста
# async def example():
#     async def chunk_generator():
#         yield "Hello"
#         yield " "
#         yield "World"
#     result = await async_concat_chunks(chunk_generator())
#     print(result)  # Выведет "Hello World"
```

### `concat_chunks`

```python
def concat_chunks(chunks: Iterator) -> str:
    """
    Объединяет чанки в строку.

    Args:
        chunks (Iterator): Итератор чанков.

    Returns:
        str: Объединенная строка.
    """
```

**Как работает функция:**
Функция `concat_chunks` объединяет чанки (части данных) из итератора в одну строку. Она преобразует каждый чанк в строку и объединяет их, исключая пустые чанки и чанки, являющиеся экземплярами исключений.

**Примеры:**

```python
chunks = ["Hello", " ", "World"]
concat_chunks(chunks)  # возвращает "Hello World"
```

### `format_cookies`

```python
def format_cookies(cookies: Cookies) -> str:
    """
    Форматирует словарь cookies в строку для использования в HTTP-запросах.

    Args:
        cookies (Cookies): Словарь cookies.

    Returns:
        str: Отформатированная строка cookies.
    """
```

**Как работает функция:**
Функция `format_cookies` форматирует словарь cookies в строку, пригодную для использования в HTTP-запросах. Она преобразует каждый элемент словаря в строку вида "key=value" и объединяет их через "; ".

**Примеры:**

```python
cookies = {"name": "value", "name2": "value2"}
format_cookies(cookies)  # возвращает "name=value; name2=value2"