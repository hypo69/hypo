# Модуль `emil_design.py`

## Обзор

Модуль предназначен для управления и обработки изображений, а также для выполнения задач продвижения в Facebook и PrestaShop, связанных с магазином `emil-design.com`. Включает в себя описание изображений с использованием Gemini AI и загрузку описаний продуктов в PrestaShop.

## Подробнее

Модуль содержит классы для конфигурации (`Config`) и основных операций (`EmilDesign`), связанных с обработкой и продвижением контента для магазина `emil-design.com`. Он использует Gemini AI для описания изображений, а также позволяет загружать описания продуктов в PrestaShop.

## Классы

### `Config`

**Описание**:
Класс `Config` предназначен для хранения конфигурационных параметров, используемых в модуле `EmilDesign`. Он определяет параметры подключения к API PrestaShop и указывает режим работы (разработка, тестирование или продакшн).

**Принцип работы**:
Класс `Config` содержит статические атрибуты, определяющие параметры подключения к API PrestaShop, такие как доменное имя (`API_DOMAIN`) и ключ API (`API_KEY`). В зависимости от значения атрибута `MODE` (определяющего режим работы), класс выбирает соответствующие параметры из переменных окружения или из файла `gs.credentials`. Если `MODE` не определен или имеет невалидное значение, устанавливается режим разработки (`dev`).

**Атрибуты**:
- `ENDPOINT` (str): Конечная точка API (`emil`).
- `MODE` (str): Режим работы (`dev`, `dev8`, `prod`). Определяет конечную точку API PrestaShop.
- `POST_FORMAT` (str): Формат POST запросов (`XML`).
- `API_DOMAIN` (str): Доменное имя API PrestaShop.
- `API_KEY` (str): Ключ API PrestaShop.

**Методы**:
Отсутствуют.

**Примеры**:

```python
# Пример использования класса Config для получения API_DOMAIN и API_KEY
api_domain = Config.API_DOMAIN
api_key = Config.API_KEY
print(f"API Domain: {api_domain}, API Key: {api_key}")
```

### `EmilDesign`

**Описание**:
Класс `EmilDesign` предназначен для описания изображений с использованием AI (Gemini или OpenAI), продвижения контента в Facebook и загрузки информации о продуктах в PrestaShop.

**Принцип работы**:
Класс `EmilDesign` инициализируется с параметрами для подключения к AI-моделям Gemini и OpenAI, а также с путями к конфигурационным файлам и данным. Он предоставляет методы для описания изображений на разных языках, продвижения контента в Facebook и загрузки информации о продуктах в PrestaShop.

**Атрибуты**:
- `gemini` (Optional[GoogleGenerativeAI]): Экземпляр класса `GoogleGenerativeAI` для работы с Gemini AI.
- `openai` (Optional[OpenAIModel]): Экземпляр класса `OpenAIModel` для работы с OpenAI.
- `base_path` (Path): Базовый путь к файлам конфигурации и инструкциям.
- `config` (SimpleNamespace): Объект, содержащий конфигурационные параметры, загруженные из JSON-файла.
- `data_path` (Path): Путь к данным, таким как изображения и описания.
- `gemini_api` (str): Ключ API для доступа к Gemini AI.
- `presta_api` (str): Ключ API для доступа к PrestaShop.
- `presta_domain` (str): Доменное имя PrestaShop.

**Методы**:
- `describe_images`: Описывает изображения с использованием Gemini AI.
- `promote_to_facebook`: Продвигает изображения и их описания в Facebook.
- `upload_described_products_to_prestashop`: Загружает информацию о продуктах в PrestaShop.

## Функции

### `describe_images`

**Назначение**:
Описывает изображения на основе предоставленных инструкций и примеров, используя модель Gemini AI.

**Параметры**:
- `self`: Экземпляр класса `EmilDesign`.
- `lang` (str): Язык, на котором должно быть создано описание изображения.
- `models` (dict, optional): Конфигурация моделей AI. По умолчанию использует модели Gemini и OpenAI.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `FileNotFoundError`: Если файлы инструкций не найдены.
- `Exception`: При возникновении ошибок во время обработки изображений.

**Как работает функция**:

1. **Чтение файлов инструкций и категорий**: Функция считывает системные инструкции, примеры описаний и категории мебели из файлов, расположенных в директории `self.base_path`.
2. **Подготовка данных**: Формирует список изображений для обработки, исключая те, которые уже были описаны (список обработанных изображений хранится в файле `described_images.txt`).
3. **Использование моделей AI**: Инициализирует модели Gemini или OpenAI для генерации описаний изображений.
4. **Обработка изображений**: Для каждого изображения из списка:
    - Считывает бинарные данные изображения.
    - Отправляет запрос в Gemini AI для получения описания.
    - Сохраняет полученное описание в JSON-файл.
    - Добавляет путь к изображению в список обработанных изображений и сохраняет его в `described_images.txt`.
5. **Обработка ошибок**: Ловит исключения, которые могут возникнуть при чтении файлов или обработке изображений, и логирует их.

**ASCII Flowchart**:

```
A [Начало]
|
B [Чтение файлов инструкций и категорий]
|
C [Подготовка списка изображений для обработки]
|
D [Инициализация моделей AI (Gemini)]
|
E [Цикл по изображениям]
|
F [Считывание бинарных данных изображения]
|
G [Отправка запроса в Gemini AI]
|
H [Сохранение описания в JSON-файл]
|
I [Обновление списка обработанных изображений]
|
J [Задержка]
|
K [Конец цикла]
|
L [Обработка исключений]
|
M [Конец]
```

**Примеры**:

```python
emil = EmilDesign()
emil.describe_images('he')
```

### `promote_to_facebook`

**Назначение**:
Продвигает изображения и их описания в Facebook.

**Параметры**:
- `self`: Экземпляр класса `EmilDesign`.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `Exception`: При возникновении ошибок во время продвижения в Facebook.

**Как работает функция**:

1. **Инициализация драйвера**: Создает экземпляр драйвера Chrome для управления браузером.
2. **Открытие страницы Facebook**: Открывает указанную группу в Facebook.
3. **Чтение сообщений**: Загружает сообщения с описаниями изображений из JSON-файла.
4. **Публикация сообщений**: Для каждого сообщения:
    - Формирует объект `SimpleNamespace` с заголовком, описанием и путем к изображению.
    - Вызывает функцию `post_message` для публикации сообщения в Facebook.
5. **Обработка ошибок**: Ловит исключения, которые могут возникнуть во время работы с Facebook, и логирует их.

**ASCII Flowchart**:

```
A [Начало]
|
B [Инициализация драйвера Chrome]
|
C [Открытие страницы Facebook]
|
D [Чтение сообщений из JSON]
|
E [Цикл по сообщениям]
|
F [Формирование объекта SimpleNamespace]
|
G [Публикация сообщения в Facebook]
|
H [Конец цикла]
|
I [Обработка исключений]
|
J [Конец]
```

**Примеры**:

```python
emil = EmilDesign()
asyncio.run(emil.promote_to_facebook())
```

### `upload_described_products_to_prestashop`

**Назначение**:
Загружает информацию о продуктах в PrestaShop.

**Параметры**:
- `self`: Экземпляр класса `EmilDesign`.
- `products_list` (Optional[List[SimpleNamespace]], optional): Список объектов `SimpleNamespace` с информацией о продуктах. По умолчанию `None`.
- `id_lang` (Optional[int | str], optional): Идентификатор языка для PrestaShop. По умолчанию `2` (иврит).

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в противном случае.

**Вызывает исключения**:
- `FileNotFoundError`: Если файл локалей не найден.
- `Exception`: При возникновении ошибок во время загрузки в PrestaShop.

**Как работает функция**:

1. **Подготовка данных**:
   - Получает список JSON-файлов с информацией о продуктах из директории `self.data_path`.
   - Загружает данные из этих файлов в список объектов `SimpleNamespace`.
2. **Инициализация класса PrestaProduct**: Создает экземпляр класса `PrestaProduct` для взаимодействия с API PrestaShop.
3. **Определение идентификатора языка**:
   - Загружает файл локалей (`locales.json`) для получения соответствия между кодами языков и их идентификаторами в PrestaShop.
   - Если `id_lang` является строкой (`'en'`, `'he'`, `'ru'`), преобразует её в соответствующий числовой идентификатор.
   - Если `id_lang` является числом, проверяет его корректность.
4. **Загрузка продуктов**:
   - Для каждого продукта в списке `products_list`:
     - Создает экземпляр класса `ProductFields` с указанным идентификатором языка.
     - Заполняет поля объекта `ProductFields` данными из объекта `product_ns` (название, описание, цена, категории и т.д.).
     - Вызывает метод `add_new_product` класса `PrestaProduct` для добавления продукта в PrestaShop.
5. **Обработка ошибок**:
   - Ловит исключения, которые могут возникнуть при чтении файлов, работе с API PrestaShop, и логирует их.

**ASCII Flowchart**:

```
A [Начало]
|
B [Получение списка JSON-файлов с информацией о продуктах]
|
C [Загрузка данных о продуктах из JSON-файлов]
|
D [Инициализация класса PrestaProduct]
|
E [Загрузка файла локалей]
|
F [Определение идентификатора языка]
|
G [Цикл по продуктам]
|
H [Создание экземпляра класса ProductFields]
|
I [Заполнение полей объекта ProductFields данными о продукте]
|
J [Добавление продукта в PrestaShop]
|
K [Конец цикла]
|
L [Обработка исключений]
|
M [Конец]
```

**Примеры**:

```python
emil = EmilDesign()
emil.upload_described_products_to_prestashop(id_lang=2)
```
```python
emil = EmilDesign()
emil.upload_described_products_to_prestashop(id_lang='he')