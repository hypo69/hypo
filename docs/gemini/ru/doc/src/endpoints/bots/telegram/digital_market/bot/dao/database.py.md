# Модуль для работы с базой данных

## Обзор

Этот модуль содержит базовые классы и функции для работы с базой данных, используя SQLAlchemy. Он включает в себя настройку подключения к базе данных, определение базового класса для моделей и вспомогательные функции.

## Подробней

Модуль предназначен для упрощения взаимодействия с базой данных в проекте. Он предоставляет готовые инструменты для создания и управления таблицами, а также для преобразования объектов моделей в словари. Этот код обеспечивает надежный и удобный способ работы с базой данных, абстрагируя множество деталей реализации.

## Классы

### `Base`

**Описание**: Базовый класс для моделей SQLAlchemy, предоставляющий общие атрибуты и методы.

**Наследует**:
- `AsyncAttrs`: Добавляет поддержку асинхронных атрибутов.
- `DeclarativeBase`: Базовый класс для декларативного определения моделей.

**Атрибуты**:
- `id` (int): Первичный ключ, автоматически увеличивающийся.
- `created_at` (datetime): Дата и время создания записи, устанавливается автоматически при создании.
- `updated_at` (datetime): Дата и время последнего обновления записи, автоматически обновляется при каждом изменении.

**Методы**:
- `__tablename__`: Возвращает имя таблицы, формируемое из имени класса.
- `to_dict()`: Преобразует объект модели в словарь.

#### `__tablename__`

```python
    @classmethod
    @property
    def __tablename__(cls) -> str:
        return cls.__name__.lower() + 's'
```

**Назначение**: Возвращает имя таблицы в нижнем регистре с добавлением 's' в конце.

**Параметры**:
- `cls` (class): Ссылка на класс.

**Возвращает**:
- `str`: Имя таблицы.

**Как работает функция**:
1. Получает имя класса.
2. Преобразует имя класса в нижний регистр.
3. Добавляет символ `s` в конец имени класса.
4. Возвращает полученное имя.

```ascii
Получение имени класса --> Преобразование в нижний регистр --> Добавление 's' --> Возврат имени таблицы
```

**Примеры**:

```python
class User(Base):
    pass

print(User.__tablename__)  # Вывод: users
```

#### `to_dict`

```python
    def to_dict(self) -> dict:
        # Метод для преобразования объекта в словарь
        return {c.name: getattr(self, c.name) for c in self.__table__.columns}
```

**Назначение**: Преобразует объект модели в словарь, где ключами являются имена столбцов, а значениями - значения атрибутов.

**Параметры**:
- Нет

**Возвращает**:
- `dict`: Словарь, представляющий объект модели.

**Как работает функция**:

1. Итерируется по всем столбцам таблицы (`self.__table__.columns`).
2. Для каждого столбца извлекает имя столбца (`c.name`) и значение атрибута (`getattr(self, c.name)`).
3. Собирает словарь, где ключи - имена столбцов, а значения - значения атрибутов.

```ascii
Итерация по столбцам таблицы --> Извлечение имени и значения каждого столбца --> Сборка словаря --> Возврат словаря
```

**Примеры**:

```python
from sqlalchemy import Column, Integer, String
from sqlalchemy.orm import declarative_base

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True)
    name = Column(String)
    email = Column(String)

    def __init__(self, name, email):
        self.name = name
        self.email = email

user = User(name='John Doe', email='john.doe@example.com')
user_dict = user.to_dict()
print(user_dict)
# Вывод: {'id': None, 'name': 'John Doe', 'email': 'john.doe@example.com'}
```

## Функции

Здесь нет отдельных функций, но есть настройки для работы с базой данных:

### `engine`

```python
engine = create_async_engine(url=database_url)
```

**Назначение**: Создает асинхронный движок SQLAlchemy для подключения к базе данных.

**Как работает**:
1. Использует функцию `create_async_engine` из SQLAlchemy.
2. Передает URL базы данных (`database_url`) в качестве параметра.

### `async_session_maker`

```python
async_session_maker = async_sessionmaker(engine, class_=AsyncSession)
```

**Назначение**: Создает фабрику сессий для асинхронной работы с базой данных.

**Как работает**:
1. Использует функцию `async_sessionmaker` из SQLAlchemy.
2. Передает созданный движок (`engine`) и класс асинхронной сессии (`AsyncSession`) в качестве параметров.