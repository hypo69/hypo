# Модуль `try_xpath_background.js`

## Обзор

Данный JavaScript-модуль (`try_xpath_background.js`) отвечает за обработку сообщений, полученных от вкладок, связанных с расширением `try_xpath`. Он реализует функционал для передачи стилей, сохранения состояния всплывающего окна, отображения результатов поиска и управления стилями в контексте вкладок.  Модуль использует `browser.runtime.onMessage.addListener` для прослушивания сообщений, а также взаимодействует с хранилищем данных браузера (`browser.storage`) для сохранения и получения настроек.


## Функции

### `loadDefaultCss`

**Описание**: Загружает CSS-стили из файла `try_xpath_insert.css` при помощи `XMLHttpRequest`.

**Возвращает**:
- `Promise<string>`: Обещание, содержащее текст загруженного CSS.


### `genericListener`

**Описание**: Обрабатывает сообщения, отправленные вкладами.


**Параметры**:
- `message` (object):  Объект сообщения.
- `sender` (object): Объект, описывающий отправителя сообщения.
- `sendResponse` (function): Функция для ответа на сообщение.


**Возвращает**:
- Возвращает результат обработки.

**Вызывает исключения**:


### `genericListener.listeners.storePopupState`

**Описание**: Сохраняет состояние всплывающего окна.

**Параметры**:
- `message` (object): Объект сообщения, содержащий состояние всплывающего окна.

**Возвращает**:
- `undefined`


### `genericListener.listeners.requestRestorePopupState`

**Описание**: Отправляет сообщение в runtime для восстановления состояния всплывающего окна.

**Параметры**:
- `message` (object): Объект сообщения, содержащий состояние всплывающего окна.

**Возвращает**:
- `undefined`


### `genericListener.listeners.requestInsertStyleToPopup`

**Описание**: Отправляет сообщение в runtime для вставки стилей во всплывающее окно.

**Параметры**:
- `undefined`

**Возвращает**:
- `undefined`


### `genericListener.listeners.showAllResults`

**Описание**: Создаёт новую вкладку для отображения результатов поиска.

**Параметры**:
- `message` (object):  Объект сообщения, содержащий результаты поиска.
- `sender` (object): Объект, описывающий отправителя сообщения.

**Возвращает**:
- `undefined`


### `genericListener.listeners.loadResults`

**Описание**: Отправляет результаты поиска в ответ на сообщение.

**Параметры**:
- `message` (object): Объект сообщения.
- `sender` (object): Объект, описывающий отправителя сообщения.
- `sendResponse` (function): Функция для отправки ответа.

**Возвращает**:
- `boolean`: `true` для подтверждения успеха.



### `genericListener.listeners.updateCss`

**Описание**: Вставляет или удаляет CSS-код в вкладке.

**Параметры**:
- `message` (object): Объект сообщения, содержащий CSS-код для добавления и удаления.
- `sender` (object): Объект, описывающий отправителя сообщения.

**Возвращает**:
- `undefined`

**Вызывает исключения**:
- `fu.onError`: Обработка ошибок, связанных с взаимодействием с вкладками.

### `genericListener.listeners.loadOptions`

**Описание**: Возвращает настройки, связанные с CSS и атрибутами.

**Параметры**:
- `message` (object): Объект сообщения.
- `sender` (object): Объект, описывающий отправителя сообщения.
- `sendResponse` (function): Функция для отправки ответа.

**Возвращает**:
- `boolean`: `true` для подтверждения успеха.

### `genericListener.listeners.requestSetContentInfo`

**Описание**: Отправляет сообщение вкладке для установки информации о содержании.

**Параметры**:
- `message` (object): Объект сообщения, содержащий данные для установки.
- `sender` (object): Объект, описывающий отправителя сообщения.

**Возвращает**:
- `undefined`

## Переменные

- `tx`, `fu`: псевдонимы для объектов `tryxpath` и `tryxpath.functions`.
- `popupState`: Сохраняет состояние всплывающего окна.
- `popupCss`: CSS-стили для всплывающего окна.
- `results`: Результаты поиска.
- `css`: CSS-код.
- `attributes`: Объект с атрибутами для поиска.


## Обработка событий `browser.storage.onChanged`

Модуль реагирует на изменения в хранилище данных браузера, обновляя значения `attributes`, `css` и `popupCss` при необходимости.


## Инициализация

Модуль инициализируется с помощью получения настроек из `browser.storage.sync` и, при необходимости, загрузки стилей по умолчанию.

```