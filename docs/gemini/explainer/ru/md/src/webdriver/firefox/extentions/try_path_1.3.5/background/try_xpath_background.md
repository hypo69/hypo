# Объяснение кода try_xpath_background.js

Этот JavaScript-код отвечает за обработку сообщений, полученных от вкладок, и за взаимодействие с расширением TryXPath. Он реализует различные функции, включая сохранение состояния всплывающего окна, вставку стилей в страницы, загрузку и отображение результатов.

**Основные функции и переменные:**

* **`tryxpath` и `tryxpath.functions`:**  Скорее всего, это объекты или модули, предоставляющие функции для работы с TryXPath.
* **`popupState`:** Содержит состояние всплывающего окна TryXPath.
* **`popupCss`:** CSS-стили для всплывающего окна.
* **`results`:** Объект, хранящий результаты поиска, полученные от вкладок.
* **`css`:** Хранит CSS-код, который должен быть вставлен в страницы.
* **`attributes`:** Объект, содержащий атрибуты для идентификации элементов на странице.
* **`loadDefaultCss()`:** Функция, которая загружает CSS-стили из файла `try_xpath_insert.css`. Использует `XMLHttpRequest` для асинхронной загрузки.
* **`genericListener`:** Функция-обработчик сообщений, поступивших от различных вкладок.  Использует `genericListener.listeners` для перенаправления сообщений на соответствующие обработчики.
* **`browser.runtime.onMessage.addListener(genericListener)`:**  Подписывается на события `onMessage` для получения сообщений от других частей расширения.
* **Разные `genericListener.listeners.*`:**  Обработчики конкретных событий, например `storePopupState`, `requestRestorePopupState`, `requestInsertStyleToPopup`, `showAllResults`, `loadResults`, `updateCss`, `loadOptions`, `requestSetContentInfo`.  Эти функции реализуют логику обработки сообщений, связанную с всплывающими окнами, результатами поиска, стилями и данными из настроек.
* **`browser.storage.onChanged.addListener`:**  Слушает изменения в хранилище расширения (например, изменения в CSS, атрибутах). Перезагружает данные при изменениях.
* **`browser.storage.sync.get`:**  Получает данные из синхронизированного хранилища (хранилища настроек). Загружает значения атрибутов и CSS.  Если CSS не загружен по умолчанию, вызывается `loadDefaultCss()` для загрузки из файла.


**Работа расширения:**

Код устанавливает обработчики сообщений, которые позволяют разным частям расширения (например, всплывающему окну и страницам с результатами) обмениваться данными.

* **Получение стилей:** Функция `loadDefaultCss` загружает необходимые CSS-стили.
* **Запрос стилей и данных:** Разные функции слушают запросы от вкладок о предоставлении CSS, атрибутов и состояния всплывающего окна.
* **Обновление стилей:**  Функция `updateCss` удаляет устаревшие CSS стили и добавляет новые. Важно, что она использует `browser.tabs.removeCSS` и `browser.tabs.insertCSS` для манипуляций со стилями на уровне отдельных вкладок.
* **Обновление данных из хранилища:** При изменениях данных в хранилище (настройки), расширение автоматически обновляет свои переменные.


**Как это работает:**

Код использует API браузера для взаимодействия с отдельными вкладками. Он асинхронно загружает CSS, обрабатывает запросы, обновляет состояние.  Важно, что он использует `Promise`, чтобы правильно обработать асинхронные операции, связанные с взаимодействием с вкладками.  Функция `fu.onError` предполагает обработку ошибок, с которыми можно столкнуться при работе с API браузера.

**В целом:**  Код представляет собой структуру для расширения браузера, обрабатывающего запросы, стили и состояние всплывающего окна.  Он использует  асинхронные операции, чтобы не блокировать работу браузера.  `genericListener` является ключевым элементом, связывающим различные части расширения.