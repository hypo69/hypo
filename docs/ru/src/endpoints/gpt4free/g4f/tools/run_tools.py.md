# Модуль для запуска инструментов

## Обзор

Модуль `run_tools.py` предназначен для организации и выполнения различных инструментов, таких как веб-поиск, доступ к хранилищу данных (bucket) и продолжение генерации текста. Он содержит классы и функции для обработки запросов к инструментам, управления ключами API и обработки промежуточных результатов генерации текста.

## Подробней

Этот модуль играет важную роль в системе, поскольку он обеспечивает интеграцию различных инструментов и сервисов, позволяя модели взаимодействовать с внешним миром и использовать дополнительные ресурсы для улучшения качества генерируемого контента. Он отвечает за координацию работы инструментов, обработку их результатов и предоставление этих результатов модели в удобном формате.

## Классы

### `ToolHandler`

**Описание**: Класс `ToolHandler` предназначен для обработки различных типов инструментов. Он содержит статические методы для валидации аргументов инструментов, обработки запросов к инструментам поиска, продолжения и доступа к хранилищу данных.

**Принцип работы**:
Класс `ToolHandler` предоставляет статические методы, которые используются для обработки различных типов инструментов. Методы класса выполняют следующие действия:
- Валидация аргументов инструментов, чтобы убедиться, что они соответствуют ожидаемому формату.
- Обработка запросов к инструментам поиска, чтобы получить информацию из интернета и предоставить ее модели.
- Обработка запросов к инструментам продолжения, чтобы позволить модели продолжить генерацию текста с определенной точки.
- Обработка запросов к инструментам доступа к хранилищу данных, чтобы получить информацию из хранилища и предоставить ее модели.

**Методы**:

- `validate_arguments(data: dict) -> dict`
    - **Назначение**: Проверяет и разбирает аргументы инструмента.
    - **Параметры**:
        - `data` (dict): Словарь, содержащий данные инструмента, включая аргументы.
    - **Возвращает**:
        - `dict`: Словарь с отфильтрованными аргументами инструмента.
    - **Как работает функция**:
        1. Проверяет, есть ли ключ `"arguments"` в словаре `data`.
        2. Если аргументы представлены в виде строки, пытается преобразовать их в словарь JSON.
        3. Проверяет, является ли результат словарем. Если нет, вызывает исключение `ValueError`.
        4. Фильтрует аргументы с помощью функции `filter_none`, удаляя элементы со значением `None`.
        5. Возвращает отфильтрованный словарь аргументов.

- `process_search_tool(messages: Messages, tool: dict) -> Messages`
    - **Назначение**: Обрабатывает запросы к инструменту поиска.
    - **Параметры**:
        - `messages` (Messages): Список сообщений, содержащий контекст диалога.
        - `tool` (dict): Словарь, содержащий информацию об инструменте поиска.
    - **Возвращает**:
        - `Messages`: Обновленный список сообщений с результатами поиска.
        - `Sources`: Источники, найденные в результате поиска.
    - **Как работает функция**:
        1. Создает копию списка сообщений.
        2. Валидирует и извлекает аргументы инструмента поиска.
        3. Выполняет поиск с использованием функции `do_search` с учетом контекста и аргументов.
        4. Обновляет последнее сообщение в списке сообщений результатами поиска.
        5. Возвращает обновленный список сообщений и источники.

- `process_continue_tool(messages: Messages, tool: dict, provider: Any) -> Tuple[Messages, Dict[str, Any]]`
    - **Назначение**: Обрабатывает запросы к инструменту продолжения.
    - **Параметры**:
        - `messages` (Messages): Список сообщений, содержащий контекст диалога.
        - `tool` (dict): Словарь, содержащий информацию об инструменте продолжения.
        - `provider` (Any): Провайдер, используемый для генерации текста.
    - **Возвращает**:
        - `Tuple[Messages, Dict[str, Any]]`: Обновленный список сообщений и дополнительные аргументы для провайдера.
    - **Как работает функция**:
        1. Проверяет, является ли провайдер одним из `OpenaiAccount` или `HuggingFaceAPI`.
        2. Если провайдер не является одним из указанных, создает копию списка сообщений и добавляет в конец новое сообщение с запросом на продолжение генерации текста.
        3. Если провайдер является одним из указанных, устанавливает аргумент `"action"` в значение `"continue"` для активации встроенной функции продолжения провайдера.
        4. Возвращает обновленный список сообщений и дополнительные аргументы.

- `process_bucket_tool(messages: Messages, tool: dict) -> Messages`
    - **Назначение**: Обрабатывает запросы к инструменту доступа к хранилищу данных (bucket).
    - **Параметры**:
        - `messages` (Messages): Список сообщений, содержащий контекст диалога.
        - `tool` (dict): Словарь, содержащий информацию об инструменте доступа к хранилищу данных.
    - **Возвращает**:
        - `Messages`: Обновленный список сообщений с содержимым хранилища данных.
    - **Как работает функция**:
        1. Создает копию списка сообщений.
        2. Определяет функцию `on_bucket`, которая считывает содержимое хранилища данных по его идентификатору.
        3. Проходит по всем сообщениям в списке и заменяет в содержимом сообщений все вхождения шаблона `{"bucket_id":"<bucket_id>"}` на содержимое соответствующего хранилища данных.
        4. Если в процессе обработки было обнаружено хотя бы одно хранилище данных, добавляет в конец последнего сообщения инструкцию о необходимости добавления источников в формате `[[domain]](Url)`.
        5. Возвращает обновленный список сообщений.

        - `on_bucket(match)`
            - **Назначение**: Внутренняя функция для чтения содержимого хранилища данных.
            - **Параметры**:
                - `match`: Объект соответствия регулярного выражения, содержащий идентификатор хранилища данных.
            - **Возвращает**:
                - Строка: Содержимое хранилища данных.
            - **Как работает функция**:
                1. Извлекает идентификатор хранилища данных из объекта соответствия.
                2. Формирует путь к хранилищу данных с использованием функции `get_bucket_dir`.
                3. Считывает содержимое хранилища данных с использованием функции `read_bucket`.
                4. Объединяет содержимое всех файлов в хранилище в одну строку и возвращает ее.

- `process_tools(messages: Messages, tool_calls: List[dict], provider: Any) -> Tuple[Messages, Dict[str, Any]]`
    - **Назначение**: Обрабатывает все вызовы инструментов и возвращает обновленные сообщения и kwargs.
    - **Параметры**:
        - `messages` (Messages): Список сообщений, содержащий контекст диалога.
        - `tool_calls` (List[dict]): Список словарей, содержащих информацию о вызовах инструментов.
        - `provider` (Any): Провайдер, используемый для генерации текста.
    - **Возвращает**:
        - `Tuple[Messages, Dict[str, Any]]`: Обновленный список сообщений, источники и дополнительные аргументы.
    - **Как работает функция**:
        1. Проверяет, есть ли вызовы инструментов. Если нет, возвращает исходный список сообщений и пустой словарь.
        2. Создает копию списка сообщений.
        3. Проходит по всем вызовам инструментов.
        4. Для каждого вызова определяет тип инструмента и вызывает соответствующий метод для обработки.
        5. Обновляет список сообщений и словарь дополнительных аргументов в соответствии с результатами обработки.
        6. Возвращает обновленный список сообщений, источники и словарь дополнительных аргументов.

### `AuthManager`

**Описание**: Класс `AuthManager` предназначен для управления ключами API. Он содержит статические методы для получения пути к файлу с ключом API и загрузки ключа API из файла конфигурации.

**Принцип работы**:
Класс `AuthManager` предоставляет статические методы для управления ключами API, которые используются для аутентификации при взаимодействии с различными сервисами. Методы класса выполняют следующие действия:
- Получение пути к файлу, в котором хранится ключ API для определенного провайдера.
- Загрузка ключа API из файла конфигурации, если это необходимо.

**Методы**:

- `get_api_key_file(cls) -> Path`
    - **Назначение**: Получает путь к файлу ключа API для провайдера.
    - **Параметры**:
        - `cls`: Класс провайдера.
    - **Возвращает**:
        - `Path`: Путь к файлу ключа API.
    - **Как работает функция**:
        1. Определяет имя файла ключа API на основе имени класса провайдера.
        2. Формирует путь к файлу ключа API в директории cookies.
        3. Возвращает путь к файлу.

- `load_api_key(provider: Any) -> Optional[str]`
    - **Назначение**: Загружает ключ API из файла конфигурации, если это необходимо.
    - **Параметры**:
        - `provider` (Any): Провайдер, для которого требуется загрузить ключ API.
    - **Возвращает**:
        - `Optional[str]`: Ключ API или `None`, если ключ не требуется или не найден.
    - **Как работает функция**:
        1. Проверяет, требуется ли провайдеру аутентификация с использованием ключа API.
        2. Если аутентификация требуется, получает путь к файлу ключа API.
        3. Пытается загрузить ключ API из файла.
        4. В случае успеха возвращает ключ API.
        5. В случае ошибки логирует сообщение об ошибке и возвращает `None`.

### `ThinkingProcessor`

**Описание**: Класс `ThinkingProcessor` предназначен для обработки "размышляющих" фрагментов текста.

**Принцип работы**:
Класс `ThinkingProcessor` обрабатывает текстовые фрагменты, содержащие специальные теги `<think>` и `</think>`, которые указывают на начало и конец процесса "размышления" модели. Класс извлекает информацию о времени начала и продолжительности "размышления", а также формирует структурированные результаты, содержащие текст до, во время и после "размышления".

**Методы**:

- `process_thinking_chunk(chunk: str, start_time: float = 0) -> Tuple[float, List[Union[str, Reasoning]]]`
    - **Назначение**: Обрабатывает фрагмент текста, содержащий информацию о процессе "размышления" модели.
    - **Параметры**:
        - `chunk` (str): Фрагмент текста для обработки.
        - `start_time` (float, optional): Время начала "размышления". По умолчанию равен 0.
    - **Возвращает**:
        - `Tuple[float, List[Union[str, Reasoning]]]`: Кортеж, содержащий время начала "размышления" (0, если "размышление" закончилось) и список результатов обработки.
    - **Как работает функция**:
        1. Обрабатывает различные случаи:
            - Если фрагмент не содержит тегов `<think>` и `</think>`, возвращает исходный фрагмент без изменений.
            - Если фрагмент содержит тег `<think>`, извлекает текст до тега и добавляет его в список результатов. Добавляет в список результатов объект `Reasoning`, указывающий на начало процесса "размышления".
            - Если фрагмент содержит тег `</think>`, извлекает текст до тега и добавляет его в список результатов. Вычисляет продолжительность "размышления" и добавляет в список результатов объект `Reasoning`, указывающий на окончание процесса "размышления".
            - Если "размышление" продолжается, возвращает время начала "размышления" и объект `Reasoning`, содержащий текущий фрагмент текста.
        2. Возвращает время начала "размышления" (0, если "размышление" закончилось) и список результатов обработки.

## Функции

### `perform_web_search(messages: Messages, web_search_param: Any) -> Tuple[Messages, Optional[Sources]]`

- **Назначение**: Выполняет веб-поиск и возвращает обновленные сообщения и источники.
- **Параметры**:
    - `messages` (Messages): Список сообщений, содержащий контекст диалога.
    - `web_search_param` (Any): Параметр для веб-поиска. Может быть строкой поискового запроса или `None`.
- **Возвращает**:
    - `Tuple[Messages, Optional[Sources]]`: Кортеж, содержащий обновленный список сообщений и источники.
- **Как работает функция**:
    1. Копирует список сообщений.
    2. Проверяет, передан ли параметр для веб-поиска. Если нет, возвращает исходный список сообщений и `None`.
    3. Пытается выполнить веб-поиск с использованием функции `do_search`.
    4. В случае успеха обновляет последнее сообщение в списке сообщений результатами поиска и возвращает обновленный список сообщений и источники.
    5. В случае ошибки логирует сообщение об ошибке и возвращает исходный список сообщений и `None`.

### `async_iter_run_tools(provider: ProviderType, model: str, messages: Messages, tool_calls: Optional[List[dict]] = None, **kwargs) -> AsyncIterator`

- **Назначение**: Асинхронно запускает инструменты и возвращает результаты.
- **Параметры**:
    - `provider` (ProviderType): Провайдер, используемый для генерации текста.
    - `model` (str): Имя модели, используемой для генерации текста.
    - `messages` (Messages): Список сообщений, содержащий контекст диалога.
    - `tool_calls` (Optional[List[dict]], optional): Список словарей, содержащих информацию о вызовах инструментов. По умолчанию равен `None`.
    - `**kwargs`: Дополнительные аргументы, передаваемые в функцию создания ответа провайдера.
- **Возвращает**:
    - `AsyncIterator`: Асинхронный итератор, возвращающий результаты работы инструментов.
- **Как работает функция**:
    1. Выполняет веб-поиск, если параметр `web_search` установлен в `kwargs`.
    2. Загружает ключ API, если провайдеру требуется аутентификация.
    3. Обрабатывает вызовы инструментов, если они переданы в параметре `tool_calls`.
    4. Генерирует ответ с использованием функции `create_function` провайдера.
    5. Возвращает асинхронный итератор, который возвращает фрагменты ответа, а также источники, если они доступны.

### `iter_run_tools(iter_callback: Callable, model: str, messages: Messages, provider: Optional[str] = None, tool_calls: Optional[List[dict]] = None, **kwargs) -> Iterator`

- **Назначение**: Синхронно запускает инструменты и возвращает результаты.
- **Параметры**:
    - `iter_callback` (Callable): Функция обратного вызова, которая генерирует ответ.
    - `model` (str): Имя модели, используемой для генерации текста.
    - `messages` (Messages): Список сообщений, содержащий контекст диалога.
    - `provider` (Optional[str], optional): Провайдер, используемый для генерации текста. По умолчанию равен `None`.
    - `tool_calls` (Optional[List[dict]], optional): Список словарей, содержащих информацию о вызовах инструментов. По умолчанию равен `None`.
    - `**kwargs`: Дополнительные аргументы, передаваемые в функцию обратного вызова.
- **Возвращает**:
    - `Iterator`: Итератор, возвращающий результаты работы инструментов.
- **Как работает функция**:
    1. Выполняет веб-поиск, если параметр `web_search` установлен в `kwargs`.
    2. Загружает ключ API, если провайдеру требуется аутентификация.
    3. Обрабатывает вызовы инструментов, если они переданы в параметре `tool_calls`.
    4. Вызывает функцию обратного вызова `iter_callback` для генерации ответа.
    5. Обрабатывает фрагменты ответа, извлекая информацию о процессе "размышления" модели.
    6. Возвращает итератор, который возвращает фрагменты ответа, а также источники, если они доступны.