# Модуль для работы с ARTA API
==========================================

Модуль предоставляет класс `ARTA`, который используется для взаимодействия с API ARTA для генерации изображений.
Он включает в себя методы для аутентификации, обновления токена и создания изображений на основе текстового запроса.

## Обзор

Модуль `ARTA` предназначен для асинхронного взаимодействия с API ARTA, предоставляя возможности для генерации изображений на основе текстовых запросов.
Он включает в себя механизмы для аутентификации, обновления токенов и обработки ответов от API.

## Подробнее

Модуль `ARTA` является частью проекта `hypotez` и обеспечивает интеграцию с сервисом генерации изображений ARTA.
Он использует асинхронные запросы для взаимодействия с API и предоставляет удобный интерфейс для создания изображений на основе текстовых описаний.

## Классы

### `ARTA`

**Описание**: Класс `ARTA` предоставляет методы для аутентификации, обновления токена и создания изображений с использованием API ARTA.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL для доступа к сервису ARTA.
- `auth_url` (str): URL для аутентификации.
- `token_refresh_url` (str): URL для обновления токена.
- `image_generation_url` (str): URL для генерации изображений.
- `status_check_url` (str): URL для проверки статуса генерации изображений.
- `working` (bool): Указывает, работает ли провайдер.
- `default_model` (str): Модель, используемая по умолчанию.
- `default_image_model` (str): Модель для генерации изображений по умолчанию.
- `model_aliases` (dict): Словарь с псевдонимами моделей.
- `image_models` (list): Список доступных моделей для генерации изображений.
- `models` (list): Список доступных моделей.

**Методы**:
- `get_auth_file()`: Возвращает путь к файлу аутентификации.
- `create_token()`: Создает токен аутентификации.
- `refresh_token()`: Обновляет токен аутентификации.
- `read_and_refresh_token()`: Читает и обновляет токен аутентификации.
- `create_async_generator()`: Создает асинхронный генератор для создания изображений.

### `get_auth_file`

```python
    @classmethod
    def get_auth_file(cls):
        """
        Возвращает путь к файлу, где хранится информация об аутентификации.

        Returns:
            Path: Путь к файлу аутентификации.
        """
```

**Назначение**:
Метод `get_auth_file` определяет местоположение файла, в котором хранится информация об аутентификации для класса `ARTA`. Он создает директорию для хранения куки, если она не существует, и возвращает путь к файлу с именем `auth_{ClassName}.json`, где `ClassName` - имя текущего класса.

**Как работает функция**:
1. **Определение директории**: Определяет директорию для хранения файлов cookie, используя функцию `get_cookies_dir()`.
2. **Создание директории**: Если директория не существует, она создается с помощью `path.mkdir(exist_ok=True)`, где `exist_ok=True` предотвращает возникновение ошибки, если директория уже существует.
3. **Формирование имени файла**: Формирует имя файла, используя имя класса `cls.__name__` для создания уникального имени файла аутентификации.
4. **Возврат пути к файлу**: Возвращает объект `Path`, представляющий полный путь к файлу аутентификации.

**Примеры**:

```python
file_path = ARTA.get_auth_file()
print(file_path)  # Вывод: /путь/к/директории/auth_ARTA.json
```

### `create_token`

```python
    @classmethod
    async def create_token(cls, path: Path, proxy: str | None = None):
        """
        Создает токен аутентификации, используя API Google Identity Toolkit.

        Args:
            path (Path): Путь для сохранения данных аутентификации.
            proxy (str | None): Прокси-сервер для использования (если требуется).

        Returns:
            dict: Данные аутентификации, включая токен.

        Raises:
            ResponseError: Если не удается получить токен аутентификации.
        """
```

**Назначение**:
Метод `create_token` генерирует токен аутентификации, необходимый для доступа к API ARTA. Он выполняет POST-запрос к `auth_url` с данными `auth_payload` и сохраняет полученные данные аутентификации в указанный файл.

**Параметры**:
- `path` (Path): Путь к файлу, в котором будут сохранены данные аутентификации.
- `proxy` (str | None): URL прокси-сервера, который будет использоваться для запроса (если необходимо).

**Возвращает**:
- `dict`: Данные аутентификации, содержащие токен (`idToken`).

**Вызывает исключения**:
- `ResponseError`: Если не удается получить токен аутентификации от API.

**Как работает функция**:
1. **Создание сессии**: Использует `ClientSession` для выполнения асинхронных HTTP-запросов.
2. **Формирование запроса**: Создает словарь `auth_payload` с типом клиента (`CLIENT_TYPE_ANDROID`).
3. **Выполнение POST-запроса**: Отправляет POST-запрос на `cls.auth_url` с `auth_payload` в формате JSON, используя указанный прокси-сервер (если он предоставлен).
4. **Обработка ответа**: Извлекает данные из JSON-ответа, в частности `idToken` (токен аутентификации).
5. **Проверка токена**: Проверяет, получен ли токен. Если токен отсутствует, вызывает исключение `ResponseError`.
6. **Сохранение данных**: Сохраняет все данные аутентификации в файл, указанный в параметре `path`.
7. **Возврат данных**: Возвращает словарь `auth_data` с данными аутентификации.

**Примеры**:

```python
from pathlib import Path
import asyncio

async def main():
    path = Path("auth_data.json")
    token_data = await ARTA.create_token(path)
    print(token_data)

if __name__ == "__main__":
    asyncio.run(main())
```

### `refresh_token`

```python
    @classmethod
    async def refresh_token(cls, refresh_token: str, proxy: str | None = None) -> tuple[str, str]:
        """
        Обновляет токен аутентификации, используя refresh token.

        Args:
            refresh_token (str): Refresh token для обновления.
            proxy (str | None): Прокси-сервер для использования (если требуется).

        Returns:
            tuple[str, str]: Новый токен и новый refresh token.
        """
```

**Назначение**:
Метод `refresh_token` используется для обновления существующего токена аутентификации с помощью refresh token. Это необходимо для поддержания доступа к API ARTA без повторной аутентификации пользователя.

**Параметры**:
- `refresh_token` (str): Refresh token, используемый для получения нового токена.
- `proxy` (str | None): URL прокси-сервера, который будет использоваться для запроса (если необходимо).

**Возвращает**:
- `tuple[str, str]`: Кортеж, содержащий новый токен (`id_token`) и новый refresh token.

**Как работает функция**:
1. **Создание сессии**: Использует `ClientSession` для выполнения асинхронных HTTP-запросов.
2. **Формирование запроса**: Создает словарь `payload` с параметрами `grant_type` (установлен в "refresh_token") и `refresh_token` (переданный refresh token).
3. **Выполнение POST-запроса**: Отправляет POST-запрос на `cls.token_refresh_url` с `payload` в формате данных, используя указанный прокси-сервер (если он предоставлен).
4. **Обработка ответа**: Извлекает данные из JSON-ответа, в частности `id_token` (новый токен) и `refresh_token` (новый refresh token).
5. **Возврат данных**: Возвращает кортеж с новым токеном и refresh token.

**Примеры**:

```python
import asyncio

async def main():
    refresh_token = "old_refresh_token"
    new_token, new_refresh_token = await ARTA.refresh_token(refresh_token)
    print(f"New token: {new_token}, New refresh token: {new_refresh_token}")

if __name__ == "__main__":
    asyncio.run(main())
```

### `read_and_refresh_token`

```python
    @classmethod
    async def read_and_refresh_token(cls, proxy: str | None = None) -> str:
        """
        Читает токен из файла и обновляет его, если он устарел.

        Args:
            proxy (str | None): Прокси-сервер для использования (если требуется).

        Returns:
            str: Данные аутентификации.
        """
```

**Назначение**:
Метод `read_and_refresh_token` предназначен для получения актуального токена аутентификации. Он пытается прочитать данные аутентификации из файла, и если файл существует и токен в нем не устарел, возвращает эти данные. Если токен устарел или файл не существует, он обновляет токен с использованием `refresh_token` (если доступен) или создает новый токен.

**Параметры**:
- `proxy` (str | None): URL прокси-сервера, который будет использоваться для запроса (если необходимо).

**Возвращает**:
- `dict`: Данные аутентификации, содержащие актуальный токен.

**Как работает функция**:
1. **Определение пути к файлу**: Получает путь к файлу аутентификации с помощью `cls.get_auth_file()`.
2. **Проверка существования файла**: Проверяет, существует ли файл аутентификации.
3. **Чтение данных из файла**: Если файл существует, читает данные аутентификации из файла.
4. **Проверка срока действия токена**: Вычисляет разницу между текущим временем и временем последнего изменения файла, и сравнивает её с `expiresIn` (срок действия токена).
5. **Обновление токена**: Если срок действия токена истекает (или уже истек), пытается обновить токен с помощью `cls.refresh_token()`. Если обновление успешно, сохраняет новые данные аутентификации в файл.
6. **Создание нового токена**: Если файл не существует или обновление токена невозможно, создает новый токен с помощью `cls.create_token()`.
7. **Возврат данных**: Возвращает данные аутентификации (из файла или новые).

**Примеры**:

```python
import asyncio

async def main():
    token_data = await ARTA.read_and_refresh_token()
    print(token_data)

if __name__ == "__main__":
    asyncio.run(main())
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        prompt: str = None,
        negative_prompt: str = "blurry, deformed hands, ugly",
        n: int = 1,
        guidance_scale: int = 7,
        num_inference_steps: int = 30,
        aspect_ratio: str = "1:1",
        seed: int = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для создания изображений на основе текстового запроса.

        Args:
            model (str): Модель для генерации изображений.
            messages (Messages): Сообщения для формирования запроса.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию None.
            prompt (str, optional): Текстовый запрос для генерации изображения. По умолчанию None.
            negative_prompt (str, optional): Негативный запрос для генерации изображения. По умолчанию "blurry, deformed hands, ugly".
            n (int, optional): Количество изображений для генерации. По умолчанию 1.
            guidance_scale (int, optional): Масштаб соответствия запросу. По умолчанию 7.
            num_inference_steps (int, optional): Количество шагов для генерации изображения. По умолчанию 30.
            aspect_ratio (str, optional): Соотношение сторон изображения. По умолчанию "1:1".
            seed (int, optional): Зерно для генерации случайных чисел. По умолчанию None.
            **kwargs: Дополнительные параметры.

        Yields:
            AsyncResult: Результаты генерации изображения.

        Raises:
            ResponseError: Если не удается инициировать генерацию изображения или возникает ошибка в процессе генерации.
        """
```

**Назначение**:
Метод `create_async_generator` создает асинхронный генератор, который взаимодействует с API ARTA для генерации изображений на основе заданных параметров. Он выполняет последовательность действий, включающую получение токена аутентификации, отправку запроса на генерацию изображения и проверку статуса генерации до завершения.

**Параметры**:
- `model` (str): Модель для генерации изображений.
- `messages` (Messages): Сообщения для формирования запроса.
- `proxy` (str | None): URL прокси-сервера, который будет использоваться для запроса (если необходимо).
- `prompt` (str | None): Текстовый запрос для генерации изображения.
- `negative_prompt` (str): Негативный запрос, описывающий что не должно быть на изображении.
- `n` (int): Количество изображений для генерации.
- `guidance_scale` (int): Масштаб соответствия запросу.
- `num_inference_steps` (int): Количество шагов для генерации изображения.
- `aspect_ratio` (str): Соотношение сторон изображения.
- `seed` (int | None): Зерно для генерации случайных чисел.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который выдает результаты генерации изображения.

**Вызывает исключения**:
- `ResponseError`: Если не удается инициировать генерацию изображения или возникает ошибка в процессе генерации.

**Как работает функция**:
1. **Выбор модели**: Определяет модель для генерации изображений с использованием `cls.get_model(model)`.
2. **Форматирование запроса**: Форматирует текстовый запрос для генерации изображения с использованием `format_image_prompt(messages, prompt)`.
3. **Генерация случайного зерна**: Если `seed` не указано, генерирует случайное зерно для генерации изображений.
4. **Получение токена аутентификации**: Получает токен аутентификации с использованием `cls.read_and_refresh_token(proxy)`.
5. **Создание сессии**: Использует `ClientSession` для выполнения асинхронных HTTP-запросов.
6. **Формирование запроса**: Создает словарь `image_payload` с параметрами запроса для генерации изображения, включая `prompt`, `negative_prompt`, `style`, `images_num`, `cfg_scale`, `steps`, `aspect_ratio` и `seed`.
7. **Выполнение POST-запроса**: Отправляет POST-запрос на `cls.image_generation_url` с `image_payload` в формате данных и заголовком `Authorization` с токеном аутентификации.
8. **Обработка ответа**: Извлекает `record_id` из JSON-ответа, который идентифицирует задачу генерации изображения.
9. **Проверка статуса генерации**: Выполняет цикл проверки статуса генерации изображения, отправляя GET-запросы на `cls.status_check_url` с `record_id`.
10. **Обработка статусов**:
    - Если статус `"DONE"`, извлекает URL-адреса сгенерированных изображений из ответа и выдает результаты с помощью `yield`.
    - Если статус `"IN_QUEUE"` или `"IN_PROGRESS"`, выдает промежуточные результаты с помощью `yield` и ожидает несколько секунд перед следующей проверкой.
    - Если статус не распознан, вызывает исключение `ResponseError`.

A
|
B
|
C
|
D
|
E
|
F

Где:

A - Выбор модели и форматирование запроса.
B - Получение данных аутентификации.
C - Инициализация сессии и формирование запроса к API.
D - Отправка запроса на генерацию изображения.
E - Проверка статуса генерации изображения.
F - Обработка результатов или ошибок генерации.

**Примеры**:

```python
import asyncio
from typing import AsyncGenerator, Any, Dict

async def generate_images(model: str, prompt: str) -> AsyncGenerator[Dict[str, Any], None]:
    async for result in ARTA.create_async_generator(model=model, messages=[{"role": "user", "content": prompt}]):
        yield result

async def main():
    async for item in generate_images(model="flux", prompt="A cat in space"):
        print(item)

if __name__ == "__main__":
    asyncio.run(main())
```