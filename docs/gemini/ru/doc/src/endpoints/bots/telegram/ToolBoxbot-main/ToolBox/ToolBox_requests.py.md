# Модуль `ToolBox_requests.py`

## Обзор

Модуль `ToolBox_requests.py` содержит класс `ToolBox`, который наследует функциональность от классов `keyboards` и `neural_networks`. Этот класс управляет основными запросами и обработкой данных для Telegram-бота, включая текстовые и графические запросы, обработку тарифов и взаимодействие с нейронными сетями.

## Подробнее

Модуль обеспечивает взаимодействие пользователя с ботом через Telegram API, обрабатывает различные типы запросов (текстовые, графические, тарифные), использует PromptsCompressor для управления промптами и интегрирует нейронные сети для генерации контента.

## Классы

### `ToolBox`

**Описание**:
Класс `ToolBox` является основным классом для обработки запросов в Telegram-боте. Он инициализирует основные параметры, загружает текстовые промпты, настраивает Telegram-бота и определяет обработчики различных типов запросов.

**Наследует**:
- `keyboards`: Предоставляет функциональность для создания различных типов клавиатур (inline и markup).
- `neural_networks`: Предоставляет методы для взаимодействия с нейронными сетями.

**Атрибуты**:
- `name` (list): Список названий кнопок для главного меню.
- `data` (list): Список данных, связанных с кнопками главного меню.
- `prompts_text` (dict): Словарь с текстовыми промптами, загружаемыми из файла `prompts.json`.
- `bot` (telebot.TeleBot): Экземпляр Telegram-бота.
- `keyboard_blank` (lambda): Лямбда-функция для создания inline-клавиатуры.
- `reply_keyboard` (lambda): Лямбда-функция для создания markup-клавиатуры.
- `__delay` (lambda): Лямбда-функция для отправки сообщения о задержке.
- `start_request` (lambda): Лямбда-функция для отправки стартового сообщения.
- `restart` (lambda): Лямбда-функция для отправки сообщения о перезапуске.
- `restart_markup` (lambda): Лямбда-функция для редактирования сообщения о перезапуске.
- `OneTextArea` (lambda): Лямбда-функция для отправки одного текстового запроса.
- `SomeTextsArea` (lambda): Лямбда-функция для отправки нескольких текстовых запросов.
- `ImageSize` (lambda): Лямбда-функция для отправки запроса на выбор размера изображения.
- `ImageArea` (lambda): Лямбда-функция для отправки запроса на ввод текста для генерации изображения.
- `ImageChange` (lambda): Лямбда-функция для отправки сообщения с вариантами действий после генерации изображения.
- `BeforeUpscale` (lambda): Лямбда-функция для отправки сообщения перед улучшением качества изображения.
- `FreeArea` (lambda): Лямбда-функция для отправки запроса в свободном режиме.
- `TariffArea` (lambda): Лямбда-функция для отправки информации о тарифах.
- `TariffExit` (lambda): Лямбда-функция для выхода из раздела тарифов.
- `TarrifEnd` (lambda): Лямбда-функция для отправки сообщения об окончании тарифа.
- `FreeTariffEnd` (lambda): Лямбда-функция для отправки сообщения об окончании бесплатного тарифа.
- `SomeTexts` (lambda): Лямбда-функция для выбора типа текстового запроса (один или несколько).

**Методы**:
- `__init__`: Инициализирует класс `ToolBox`, настраивает кнопки, загружает промпты и инициализирует Telegram-бота.

### `__gpt_4o_mini`
```python
def __gpt_4o_mini(self, prompt: list[dict], message) -> tuple[dict[str, str], int, int]:
    """
    Отправляет запрос к GPT-4o mini и возвращает ответ.

    Args:
        prompt (list[dict]): Список словарей с промптами для GPT-4o mini.
        message: Объект сообщения Telegram.

    Returns:
        tuple[dict[str, str], int, int]: Кортеж, содержащий ответ от GPT-4o mini, количество входящих и исходящих токенов.
    """
    ...
```
**Описание**:
Приватный метод `__gpt_4o_mini` отправляет запрос к модели GPT-4o mini и возвращает ответ, а также количество входящих и исходящих токенов.

**Параметры**:
- `prompt` (list[dict]): Список словарей, содержащих промпты для GPT-4o mini.
- `message`: Объект сообщения Telegram.

**Возвращает**:
- `tuple[dict[str, str], int, int]`: Кортеж, содержащий ответ от GPT-4o mini (в виде словаря), количество входящих токенов и количество исходящих токенов.

**Как работает функция**:
1. Отправляет сообщение о задержке пользователю, чтобы показать, что запрос обрабатывается.
2. Вызывает метод `_free_gpt_4o_mini` из класса `neural_networks` для отправки запроса к GPT-4o mini.
3. Редактирует сообщение о задержке, заменяя его ответом от GPT-4o mini.
4. Возвращает ответ и количество токенов.

```
A: Отправка сообщения о задержке
|
B: Отправка запроса к GPT-4o mini (_free_gpt_4o_mini)
|
C: Редактирование сообщения с ответом от GPT-4o mini
|
D: Возврат ответа и количества токенов
```

**Примеры**:
```python
# Пример вызова функции
prompt = [{"role": "user", "content": "Напиши короткий рассказ"}]
message = ...  # Объект сообщения Telegram
response, incoming_tokens, outgoing_tokens = self.__gpt_4o_mini(prompt, message)
print(f"Ответ: {response['content']}")
print(f"Входящие токены: {incoming_tokens}")
print(f"Исходящие токены: {outgoing_tokens}")
```

### `__FLUX_schnell`
```python
def __FLUX_schnell(self, prompt: str, size: list[int], message, seed: int, num_inference_steps: int)-> None:
    """
    Генерирует изображение с использованием FLUX schnell и отправляет его пользователю.

    Args:
        prompt (str): Текст запроса для генерации изображения.
        size (list[int]): Размеры изображения [ширина, высота].
        message: Объект сообщения Telegram.
        seed (int): Зерно для генерации случайных чисел.
        num_inference_steps (int): Количество шагов для генерации изображения.
    """
    ...
```

**Описание**:
Приватный метод `__FLUX_schnell` генерирует изображение на основе заданного промпта, размера и зерна, используя FLUX schnell, и отправляет его пользователю.

**Параметры**:
- `prompt` (str): Текст запроса для генерации изображения.
- `size` (list[int]): Размеры изображения в виде списка [ширина, высота].
- `message`: Объект сообщения Telegram.
- `seed` (int): Зерно для генерации случайных чисел.
- `num_inference_steps` (int): Количество шагов для генерации изображения.

**Как работает функция**:
1. Отправляет сообщение о задержке пользователю.
2. В цикле пытается сгенерировать изображение с помощью метода `_FLUX_schnell` из класса `neural_networks`.
3. Если генерация прошла успешно, отправляет изображение пользователю и удаляет сообщение о задержке.
4. Если произошла ошибка, отправляет сообщение об ошибке генерации.

```
A: Отправка сообщения о задержке
|
B: Попытка генерации изображения (_FLUX_schnell)
|
C: Отправка изображения пользователю
|
D: Удаление сообщения о задержке
|
E: Отправка сообщения об ошибке (если генерация не удалась)
```

**Примеры**:
```python
# Пример вызова функции
prompt = "Закат на Марсе"
size = [1024, 1024]
message = ...  # Объект сообщения Telegram
seed = 12345
num_inference_steps = 4
self.__FLUX_schnell(prompt, size, message, seed, num_inference_steps)
```

### `Text_types`
```python
def Text_types(self, message):
    """
    Отправляет пользователю меню с типами текстов для выбора.

    Args:
        message: Объект сообщения Telegram.

    Returns:
        None
    """
    ...
```

**Описание**:
Метод `Text_types` отправляет пользователю меню с различными типами текстов, которые можно выбрать для дальнейшей обработки.

**Параметры**:
- `message`: Объект сообщения Telegram.

**Возвращает**:
- `None`

**Как работает функция**:
1. Определяет названия и данные для кнопок меню типов текстов.
2. Редактирует сообщение пользователя, заменяя его меню с типами текстов.

```
A: Определение названий и данных для кнопок меню
|
B: Редактирование сообщения с меню типов текстов
```

**Примеры**:
```python
# Пример вызова функции
message = ...  # Объект сообщения Telegram
self.Text_types(message)
```

### `Basic_tariff`
```python
def Basic_tariff(self, message):
    """
    Предлагает пользователю подключить BASIC тариф.

    Args:
        message: Объект сообщения Telegram.

    Returns:
        None
    """
    ...
```

**Описание**:
Метод `Basic_tariff` предлагает пользователю подключить BASIC тариф, отправляя инвойс (счет) для оплаты.

**Параметры**:
- `message`: Объект сообщения Telegram.

**Возвращает**:
- `None`

**Как работает функция**:
1. Создает inline-клавиатуру с кнопками "Подключить тариф BASIC" и "К тарифам".
2. Определяет цену для BASIC тарифа.
3. Удаляет текущее сообщение пользователя.
4. Отправляет инвойс пользователю с информацией о BASIC тарифе.

```
A: Создание inline-клавиатуры
|
B: Определение цены тарифа
|
C: Удаление текущего сообщения
|
D: Отправка инвойса пользователю
```

**Примеры**:
```python
# Пример вызова функции
message = ...  # Объект сообщения Telegram
self.Basic_tariff(message)
```

### `Pro_tariff`
```python
def Pro_tariff(self, message):
    """
    Предлагает пользователю подключить PRO тариф.

    Args:
        message: Объект сообщения Telegram.

    Returns:
        None
    """
    ...
```

**Описание**:
Метод `Pro_tariff` предлагает пользователю подключить PRO тариф, отправляя инвойс для оплаты.

**Параметры**:
- `message`: Объект сообщения Telegram.

**Возвращает**:
- `None`

**Как работает функция**:
1. Создает inline-клавиатуру с кнопками "Подключить тариф PRO" и "К тарифам".
2. Определяет цену для PRO тарифа.
3. Удаляет текущее сообщение пользователя.
4. Отправляет инвойс пользователю с информацией о PRO тарифе.

```
A: Создание inline-клавиатуры
|
B: Определение цены тарифа
|
C: Удаление текущего сообщения
|
D: Отправка инвойса пользователю
```

**Примеры**:
```python
# Пример вызова функции
message = ...  # Объект сообщения Telegram
self.Pro_tariff(message)
```

### `TextCommands`
```python
def TextCommands(self, message, ind: int):
    """
    Обрабатывает текстовые команды пользователя.

    Args:
        message: Объект сообщения Telegram.
        ind (int): Индекс команды.

    Returns:
        tuple[int, int, int]: Кортеж, содержащий количество входящих и исходящих токенов, и 1.
    """
    ...
```

**Описание**:
Метод `TextCommands` обрабатывает текстовые команды пользователя, получая необходимую информацию и отправляя запрос к GPT-4o mini.

**Параметры**:
- `message`: Объект сообщения Telegram.
- `ind` (int): Индекс команды.

**Возвращает**:
- `tuple[int, int, int]`: Кортеж, содержащий количество входящих и исходящих токенов, и 1.

**Как работает функция**:
1. Проверяет, содержит ли команда "TEXT" в списке `pc.commands_size[ind]`.
2. Если содержит, запрашивает дополнительную информацию у пользователя, регистрируя следующий шаг обработки.
3. Если не содержит, сразу формирует промпт и отправляет запрос к GPT-4o mini.
4. Возвращает количество входящих и исходящих токенов.

```
A: Проверка наличия "TEXT" в команде
|
B: Запрос дополнительной информации (если "TEXT" есть)
|
C: Формирование промпта
|
D: Отправка запроса к GPT-4o mini
|
E: Возврат количества токенов
```

**Примеры**:
```python
# Пример вызова функции
message = ...  # Объект сообщения Telegram
ind = 0
incoming_tokens, outgoing_tokens, _ = self.TextCommands(message, ind)
print(f"Входящие токены: {incoming_tokens}")
print(f"Исходящие токены: {outgoing_tokens}")
```

Внутренняя функция `Text_next_step`:
```python
def Text_next_step(message):
    """
    Дополнительный шаг для обработки текстовых команд пользователя.

    Args:
        message: Объект сообщения Telegram.

    Returns:
        None
    """
    ...
```
**Описание**:
Внутренняя функция `Text_next_step` является дополнительным шагом для обработки текстовых команд пользователя. Она получает дополнительную информацию от пользователя, формирует промпт и отправляет запрос к GPT-4o mini.

**Параметры**:
- `message`: Объект сообщения Telegram.

**Как работает функция**:
1. Получает текст сообщения от пользователя.
2. Разделяет текст на параметры.
3. Если параметров не хватает, добавляет "Параметр отсутствует".
4. Формирует промпт и отправляет запрос к GPT-4o mini.
5. Перезапускает бота.

```
A: Получение текста сообщения
|
B: Разделение текста на параметры
|
C: Добавление "Параметр отсутствует", если не хватает параметров
|
D: Формирование промпта
|
E: Отправка запроса к GPT-4o mini
|
F: Перезапуск бота
```
### `SomeTextsCommand`
```python
def SomeTextsCommand(self, message, ind: int, tokens: dict[str, int]):
    """
    Обрабатывает команды для генерации нескольких текстов.

    Args:
        message: Объект сообщения Telegram.
        ind (int): Индекс команды.
        tokens (dict[str, int]): Словарь с количеством доступных токенов.

    Returns:
        tuple[int, int, int]: Кортеж, содержащий количество входящих и исходящих токенов, и количество сгенерированных текстов.
    """
    ...
```

**Описание**:
Метод `SomeTextsCommand` обрабатывает команды для генерации нескольких текстов на основе запроса пользователя.

**Параметры**:
- `message`: Объект сообщения Telegram.
- `ind` (int): Индекс команды.
- `tokens` (dict[str, int]): Словарь с количеством доступных токенов.

**Возвращает**:
- `tuple[int, int, int]`: Кортеж, содержащий количество входящих и исходящих токенов, и количество сгенерированных текстов.

**Как работает функция**:
1. Запрашивает у пользователя количество текстов для генерации.
2. Запрашивает текст источника для каждого текста.
3. Запрашивает дополнительные параметры для каждого текста.
4. Формирует промпты и отправляет запросы к GPT-4o mini в многопоточном режиме.
5. Возвращает общее количество входящих и исходящих токенов.

```
A: Запрос количества текстов
|
B: Запрос текста источника для каждого текста
|
C: Запрос дополнительных параметров для каждого текста
|
D: Формирование промптов
|
E: Отправка запросов к GPT-4o mini в многопоточном режиме
|
F: Возврат общего количества токенов
```

**Внутренние функции**:
- `Text_next_step`: Внутренняя функция для получения текста источника.
- `Params_addition`: Внутренняя функция для получения дополнительных параметров.
- `process_prompt`: Внутренняя функция для обработки промпта и отправки запроса к GPT-4o mini.

Внутренняя функция `Text_next_step`:
```python
def Text_next_step(message):
    """
    Получает текст источника для генерации текста.

    Args:
        message: Объект сообщения Telegram.

    Returns:
        None
    """
    ...
```
**Описание**:
Внутренняя функция `Text_next_step` получает текст источника для генерации текста.

**Параметры**:
- `message`: Объект сообщения Telegram.

**Как работает функция**:
1. Получает текст сообщения от пользователя.
2. Сохраняет текст в списке `ans`.

```
A: Получение текста сообщения
|
B: Сохранение текста в списке `ans`
```

Внутренняя функция `Params_addition`:
```python
def Params_addition(message):
    """
    Получает дополнительные параметры для генерации текста.

    Args:
        message: Объект сообщения Telegram.

    Returns:
        None
    """
    ...
```
**Описание**:
Внутренняя функция `Params_addition` получает дополнительные параметры для генерации текста.

**Параметры**:
- `message`: Объект сообщения Telegram.

**Как работает функция**:
1. Получает текст сообщения от пользователя.
2. Разделяет текст на параметры.
3. Если параметров не хватает, добавляет `None`.
4. Сохраняет параметры в списке `ans`.

```
A: Получение текста сообщения
|
B: Разделение текста на параметры
|
C: Добавление `None`, если не хватает параметров
|
D: Сохранение параметров в списке `ans`
```

Внутренняя функция `process_prompt`:
```python
def process_prompt(i):
    """
    Обрабатывает промпт и отправляет запрос к GPT-4o mini.

    Args:
        i (int): Индекс текста для генерации.

    Returns:
        tuple[int, int]: Кортеж, содержащий количество входящих и исходящих токенов.
    """
    ...
```
**Описание**:
Внутренняя функция `process_prompt` обрабатывает промпт и отправляет запрос к GPT-4o mini для генерации текста.

**Параметры**:
- `i` (int): Индекс текста для генерации.

**Как работает функция**:
1. Формирует промпт на основе текста источника и параметров.
2. Проверяет, достаточно ли токенов для генерации.
3. Отправляет запрос к GPT-4o mini.
4. Возвращает количество входящих и исходящих токенов.

```
A: Формирование промпта
|
B: Проверка доступности токенов
|
C: Отправка запроса к GPT-4o mini
|
D: Возврат количества токенов
```

**Примеры**:
```python
# Пример вызова функции
message = ...  # Объект сообщения Telegram
ind = 1
tokens = {"incoming_tokens": 1000, "outgoing_tokens": 1000, "free_requests": 10}
incoming_tokens, outgoing_tokens, n = self.SomeTextsCommand(message, ind, tokens)
print(f"Входящие токены: {incoming_tokens}")
print(f"Исходящие токены: {outgoing_tokens}")
print(f"Количество текстов: {n}")
```

### `ImageCommand`
```python
def ImageCommand(self, message, prompt: str, size: list[int]):
    """
    Обрабатывает команду для генерации изображения.

    Args:
        message: Объект сообщения Telegram.
        prompt (str): Текст запроса для генерации изображения.
        size (list[int]): Размеры изображения [ширина, высота].

    Returns:
        int: Зерно для генерации случайных чисел.
    """
    ...
```

**Описание**:
Метод `ImageCommand` обрабатывает команду для генерации изображения на основе заданного промпта и размера.

**Параметры**:
- `message`: Объект сообщения Telegram.
- `prompt` (str): Текст запроса для генерации изображения.
- `size` (list[int]): Размеры изображения в виде списка [ширина, высота].

**Возвращает**:
- `int`: Зерно для генерации случайных чисел.

**Как работает функция**:
1. Генерирует случайное число (зерно) для генерации изображения.
2. Вызывает приватный метод `__FLUX_schnell` для генерации изображения.
3. Вызывает метод `ImageChange` для предоставления пользователю вариантов действий с изображением.
4. Возвращает зерно.

```
A: Генерация случайного числа (зерна)
|
B: Генерация изображения (__FLUX_schnell)
|
C: Предоставление вариантов действий с изображением (ImageChange)
|
D: Возврат зерна
```

**Примеры**:
```python
# Пример вызова функции
message = ...  # Объект сообщения Telegram
prompt = "Космический корабль в космосе"
size = [1024, 1024]
seed = self.ImageCommand(message, prompt, size)
print(f"Зерно: {seed}")
```

### `Image_Regen_And_Upscale`
```python
def Image_Regen_And_Upscale(self, message, prompt: str, size: list[int], seed, num_inference_steps=4):
    """
    Генерирует изображение повторно или улучшает его качество.

    Args:
        message: Объект сообщения Telegram.
        prompt (str): Текст запроса для генерации изображения.
        size (list[int]): Размеры изображения [ширина, высота].
        seed: Зерно для генерации случайных чисел.
        num_inference_steps (int, optional): Количество шагов для генерации изображения. По умолчанию 4.

    Returns:
        None
    """
    ...
```

**Описание**:
Метод `Image_Regen_And_Upscale` генерирует изображение повторно с тем же зерном или улучшает его качество.

**Параметры**:
- `message`: Объект сообщения Telegram.
- `prompt` (str): Текст запроса для генерации изображения.
- `size` (list[int]): Размеры изображения в виде списка [ширина, высота].
- `seed`: Зерно для генерации случайных чисел.
- `num_inference_steps` (int, optional): Количество шагов для генерации изображения. По умолчанию 4.

**Возвращает**:
- `None`

**Как работает функция**:
1. Вызывает приватный метод `__FLUX_schnell` для генерации или улучшения изображения.

```
A: Генерация или улучшение изображения (__FLUX_schnell)
```

**Примеры**:
```python
# Пример вызова функции
message = ...  # Объект сообщения Telegram
prompt = "Космический корабль в космосе"
size = [1024, 1024]
seed = 12345
self.Image_Regen_And_Upscale(message, prompt, size, seed)
```

### `FreeCommand`
```python
def FreeCommand(self, message, prompts: list[str]):
    """
    Обрабатывает команды в свободном режиме.

    Args:
        message: Объект сообщения Telegram.
        prompts (list[str]): Список промптов.

    Returns:
        tuple[int, int, list[str]]: Кортеж, содержащий количество входящих и исходящих токенов, и обновленный список промптов.
    """
    ...
```

**Описание**:
Метод `FreeCommand` обрабатывает команды в свободном режиме, отправляя запрос к GPT-4o mini и обновляя список промптов.

**Параметры**:
- `message`: Объект сообщения Telegram.
- `prompts (list[str]): Список промптов.

**Возвращает**:
- `tuple[int, int, list[str]]`: Кортеж, содержащий количество входящих и исходящих токенов, и обновленный список промптов.

**Как работает функция**:
1. Добавляет текст сообщения пользователя в список промптов.
2. Вызывает приватный метод `__gpt_4o_mini` для отправки запроса к GPT-4o mini.
3. Добавляет ответ от GPT-4o mini в список промптов.
4. Возвращает количество входящих и исходящих токенов и обновленный список промптов.

```
A: Добавление текста сообщения в список промптов
|
B: Отправка запроса к GPT-4o mini (__gpt_4o_mini)
|
C: Добавление ответа в список промптов
|
D: Возврат количества токенов и обновленного списка промптов
```

**Примеры**:
```python
# Пример вызова функции
message = ...  # Объект сообщения Telegram
prompts = []
incoming_tokens, outgoing_tokens, prompts = self.FreeCommand(message, prompts)
print(f"Входящие токены: {incoming_tokens}")
print(f"Исходящие токены: {outgoing_tokens}")
print(f"Промпты: {prompts}")
```

## Функции

В данном модуле нет отдельных функций, все основные действия выполняются методами класса `ToolBox`.