# Модуль для работы с изображениями

## Обзор

Модуль предоставляет набор функций для обработки изображений, включая конвертацию в различные форматы, изменение размеров, проверку форматов и извлечение данных из URI. Он использует библиотеку PIL (Pillow) для обработки изображений и поддерживает различные форматы, такие как PNG, JPEG, GIF и WEBP.

## Подробнее

Этот модуль предоставляет функции для работы с изображениями, такие как преобразование изображений из различных форматов в объекты PIL Image, проверку допустимых расширений файлов, проверку допустимых форматов изображений, извлечение двоичных данных из URI данных, получение ориентации изображений, обработку изображений путем корректировки их ориентации и изменения их размеров, преобразование изображений в байты и преобразование изображений в URI данных.

## Классы

### `ImageDataResponse`

**Описание**: Класс, представляющий ответ с данными об изображении.

**Принцип работы**:
Класс `ImageDataResponse` используется для хранения информации об изображении, включая список изображений и альтернативный текст. Он предоставляет метод `get_list` для получения списка изображений.

**Методы**:

- `__init__(self, images: Union[str, list], alt: str)`
    - **Назначение**: Инициализирует объект `ImageDataResponse`.
    - **Параметры**:
        - `images` (Union[str, list]): Список изображений или строка с одним изображением.
        - `alt` (str): Альтернативный текст для изображения.
    - **Возвращает**: Ничего.
    - **Как работает функция**: Функция сохраняет переданные значения `images` и `alt` в атрибуты объекта.
    - **Примеры**:
        ```python
        image_data = ImageDataResponse(images=['image1.jpg', 'image2.png'], alt='Пример изображения')
        ```

- `get_list(self) -> list[str]`
    - **Назначение**: Возвращает список изображений.
    - **Параметры**: None
    - **Возвращает**: `list[str]`: Список строк, представляющих изображения. Если `self.images` является строкой, возвращает список, содержащий эту строку.
    - **Как работает функция**: Функция проверяет, является ли атрибут `self.images` списком. Если да, то возвращает его. Если нет, то возвращает список, содержащий `self.images` как единственный элемент.
    - **Примеры**:
        ```python
        image_data = ImageDataResponse(images='image1.jpg', alt='Пример изображения')
        image_list = image_data.get_list()  # Возвращает ['image1.jpg']
        ```

### `ImageRequest`

**Описание**: Класс, представляющий запрос изображения.

**Принцип работы**:
Класс `ImageRequest` используется для хранения опций запроса изображения. Он предоставляет метод `get` для получения значения опции по ключу.

**Методы**:

- `__init__(self, options: dict = {})`
    - **Назначение**: Инициализирует объект `ImageRequest`.
    - **Параметры**:
        - `options` (dict, optional): Словарь опций запроса. По умолчанию пустой словарь.
    - **Возвращает**: Ничего.
    - **Как работает функция**: Функция сохраняет переданные значения `options` в атрибуты объекта.
    - **Примеры**:
        ```python
        image_request = ImageRequest(options={'width': 100, 'height': 200})
        ```

- `get(self, key: str)`
    - **Назначение**: Возвращает значение опции по ключу.
    - **Параметры**:
        - `key` (str): Ключ опции.
    - **Возвращает**: Значение опции или `None`, если опция не найдена.
    - **Как работает функция**: Функция пытается получить значение из словаря `self.options` по ключу `key`. Если ключ не найден, возвращается `None`.
    - **Примеры**:
        ```python
        image_request = ImageRequest(options={'width': 100, 'height': 200})
        width = image_request.get('width')  # Возвращает 100
        ```

## Функции

### `to_image(image: ImageType, is_svg: bool = False) -> Image`

**Назначение**: Преобразует входное изображение в объект PIL Image.

**Параметры**:
- `image` (ImageType): Входное изображение (строка, байты или объект Image).
- `is_svg` (bool, optional): Указывает, является ли изображение SVG. По умолчанию `False`.

**Возвращает**:
- `Image`: Преобразованный объект PIL Image.

**Вызывает исключения**:
- `MissingRequirementsError`: Если не установлены необходимые пакеты (`pillow` для обычных изображений, `cairosvg` для SVG).
- `ValueError`: Если URI данных изображения недействителен или формат изображения не поддерживается.

**Как работает функция**:

1.  Проверяет, установлены ли необходимые библиотеки (`pillow`). Если нет, вызывает исключение `MissingRequirementsError`.
2.  Если входное изображение является строкой и начинается с "data:", проверяет, является ли URI данных изображением, и извлекает данные из URI.
3.  Если изображение является SVG, пытается импортировать `cairosvg`. Если `cairosvg` не установлен, вызывает исключение `MissingRequirementsError`. Преобразует SVG в PNG, используя `cairosvg`, и открывает полученный буфер с помощью PIL.
4.  Если изображение является байтами, проверяет, является ли формат изображения допустимым, и открывает изображение из байтов с помощью PIL.
5.  Если изображение уже является объектом PIL Image, возвращает его без изменений.

**Примеры**:

```python
from pathlib import Path
from PIL import Image

# Преобразование изображения из файла
image_path = Path('example.jpg')
image = to_image(image_path)

# Преобразование изображения из байтов
with open('example.png', 'rb') as f:
    image_bytes = f.read()
image = to_image(image_bytes)

# Преобразование SVG изображения
image_svg = to_image('<svg width="100" height="100"></svg>', is_svg=True)
```

### `is_allowed_extension(filename: str) -> bool`

**Назначение**: Проверяет, имеет ли заданное имя файла допустимое расширение.

**Параметры**:
- `filename` (str): Имя файла для проверки.

**Возвращает**:
- `bool`: `True`, если расширение допустимо, `False` в противном случае.

**Как работает функция**:

1.  Проверяет, содержит ли имя файла точку (`.`).
2.  Разделяет имя файла по точке и получает расширение.
3.  Приводит расширение к нижнему регистру и проверяет, входит ли оно в список допустимых расширений (`ALLOWED_EXTENSIONS`).

**Примеры**:

```python
is_allowed_extension('image.png')  # Возвращает True
is_allowed_extension('document.txt')  # Возвращает False
```

### `is_data_uri_an_image(data_uri: str) -> bool`

**Назначение**: Проверяет, представляет ли заданный URI данных изображение.

**Параметры**:
- `data_uri` (str): URI данных для проверки.

**Вызывает исключения**:
- `ValueError`: Если URI данных недействителен или формат изображения не поддерживается.

**Как работает функция**:

1.  Проверяет, начинается ли URI данных с "data:image/" и содержит ли формат изображения (например, jpeg, png, gif).
2.  Извлекает формат изображения из URI данных.
3.  Проверяет, входит ли формат изображения в список допустимых форматов (`ALLOWED_EXTENSIONS`) или является "svg+xml".

**Примеры**:

```python
is_data_uri_an_image('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w+n/f2cgALVlOg...')  # Не выдает исключение
```

### `is_accepted_format(binary_data: bytes) -> str`

**Назначение**: Проверяет, представляет ли заданные двоичные данные изображение с допустимым форматом.

**Параметры**:
- `binary_data` (bytes): Двоичные данные для проверки.

**Возвращает**:
- `str`: MIME-тип изображения (например, "image/jpeg", "image/png").

**Вызывает исключения**:
- `ValueError`: Если формат изображения не поддерживается.

**Как работает функция**:

1.  Проверяет сигнатуры (магические числа) в начале двоичных данных, чтобы определить формат изображения.
2.  Возвращает соответствующий MIME-тип, если формат распознан.

**Примеры**:

```python
with open('example.jpg', 'rb') as f:
    image_bytes = f.read()
is_accepted_format(image_bytes)  # Возвращает "image/jpeg"
```

### `extract_data_uri(data_uri: str) -> bytes`

**Назначение**: Извлекает двоичные данные из заданного URI данных.

**Параметры**:
- `data_uri` (str): URI данных.

**Возвращает**:
- `bytes`: Извлеченные двоичные данные.

**Как работает функция**:

1.  Разделяет URI данных по запятой и получает часть, содержащую данные в кодировке Base64.
2.  Декодирует данные из Base64.

**Примеры**:

```python
data_uri = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w+n/f2cgALVlOg...'
image_bytes = extract_data_uri(data_uri)
```

### `get_orientation(image: Image) -> int`

**Назначение**: Получает ориентацию заданного изображения из EXIF-данных.

**Параметры**:
- `image` (Image): Изображение.

**Возвращает**:
- `int`: Значение ориентации.

**Как работает функция**:

1.  Пытается получить EXIF-данные из изображения.
2.  Если EXIF-данные существуют, получает значение тега ориентации (274).

**Примеры**:

```python
from PIL import Image
image = Image.open('example.jpg')
orientation = get_orientation(image)
```

### `process_image(image: Image, new_width: int, new_height: int) -> Image`

**Назначение**: Обрабатывает заданное изображение, корректируя его ориентацию и изменяя размер.

**Параметры**:
- `image` (Image): Изображение для обработки.
- `new_width` (int): Новая ширина изображения.
- `new_height` (int): Новая высота изображения.

**Возвращает**:
- `Image`: Обработанное изображение.

**Как работает функция**:

1.  Получает ориентацию изображения с помощью `get_orientation`.
2.  Корректирует ориентацию изображения, используя `transpose`, если необходимо.
3.  Изменяет размер изображения с помощью `thumbnail`.
4.  Удаляет прозрачность, если изображение в режиме RGBA.
5.  Преобразует изображение в режим RGB, если оно не в этом режиме.

**Примеры**:

```python
from PIL import Image
image = Image.open('example.png')
processed_image = process_image(image, 100, 100)
```

### `to_bytes(image: ImageType) -> bytes`

**Назначение**: Преобразует заданное изображение в байты.

**Параметры**:
- `image` (ImageType): Изображение для преобразования.

**Возвращает**:
- `bytes`: Изображение в виде байтов.

**Как работает функция**:

1.  Проверяет тип изображения и преобразует его в байты в зависимости от типа:
    *   Если это байты, возвращает их.
    *   Если это строка, начинающаяся с "data:", извлекает байты из URI данных.
    *   Если это объект PIL Image, сохраняет его в BytesIO и возвращает содержимое.
    *   Если это путь к файлу, читает файл и возвращает байты.

**Примеры**:

```python
from PIL import Image
image = Image.open('example.png')
image_bytes = to_bytes(image)
```

### `to_data_uri(image: ImageType) -> str`

**Назначение**: Преобразует заданное изображение в URI данных.

**Параметры**:
- `image` (ImageType): Изображение для преобразования.

**Возвращает**:
- `str`: URI данных изображения.

**Как работает функция**:

1.  Если изображение не является строкой, преобразует его в байты с помощью `to_bytes`.
2.  Кодирует байты в Base64 и формирует URI данных.

**Примеры**:

```python
from PIL import Image
image = Image.open('example.png')
data_uri = to_data_uri(image)
```