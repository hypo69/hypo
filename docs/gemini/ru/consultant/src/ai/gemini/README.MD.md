# Анализ кода модуля `src.ai.gemini`

**Качество кода**
10
-  Плюсы
    - Документация в формате reStructuredText (RST), что соответствует требованиям.
    - Подробное описание класса и его функций, что способствует пониманию кода.
    -  Приведены примеры использования.
    -  Четкая структура документации.
-  Минусы
    -   Отсутствуют конкретные примеры кода в формате RST, которые можно было бы использовать непосредственно в Python файлах.
    -   Не все разделы документации имеют одинаковую детализацию.
    -   Нет явного указания на необходимость использования `j_loads` или `j_loads_ns`.

**Рекомендации по улучшению**
- Добавить конкретные примеры docstring в формате RST для функций, методов и классов в самом файле `README.MD`.
- Включить информацию о том, что в Python файлах используется `j_loads` или `j_loads_ns`.
- В секцию "Error Handling" добавить более подробное описание каждой ошибки.
- Добавить секцию "Конфигурация" с подробностями о структуре и использовании файла `generative_ai.json`.
- Уточнить в "Dependencies" какие версии библиотек являются рекомендованными.

**Оптимизированный код**
```markdown
# Анализ кода модуля `src.ai.gemini`

**Качество кода**
10
-  Плюсы
    - Документация в формате reStructuredText (RST), что соответствует требованиям.
    - Подробное описание класса и его функций, что способствует пониманию кода.
    -  Приведены примеры использования.
    -  Четкая структура документации.
-  Минусы
    -   Отсутствуют конкретные примеры кода в формате RST, которые можно было бы использовать непосредственно в Python файлах.
    -   Не все разделы документации имеют одинаковую детализацию.
    -   Нет явного указания на необходимость использования `j_loads` или `j_loads_ns`.

**Рекомендации по улучшению**
- Добавить конкретные примеры docstring в формате RST для функций, методов и классов в самом файле `README.MD`.
- Включить информацию о том, что в Python файлах используется `j_loads` или `j_loads_ns`.
- В секцию "Error Handling" добавить более подробное описание каждой ошибки.
- Добавить секцию "Конфигурация" с подробностями о структуре и использовании файла `generative_ai.json`.
- Уточнить в "Dependencies" какие версии библиотек являются рекомендованными.

**Оптимизированный код**
```rst
.. module:: src.ai.gemini

=====================================================================

[Русский](https://github.com/hypo69/hypo/tree/master/src/ai/gemini/readme.ru.md)

# Google Generative AI Integration Module

=====================================================================

Модуль для интеграции с Google Generative AI
---------------------------------------------------------------------

Этот модуль предоставляет класс :class:`GoogleGenerativeAI`, который используется для взаимодействия с моделями Google Generative AI.
Он включает методы для отправки запросов, обработки ответов, управления диалогами и интеграции с различными функциями ИИ.
Модуль также содержит надежную обработку ошибок, логирование и опции конфигурации для обеспечения бесперебойной работы.

## Обзор

Класс `GoogleGenerativeAI` разработан для облегчения взаимодействия с моделями Google Generative AI.
Этот класс предоставляет методы для отправки запросов, обработки ответов, управления диалогами и интеграции с различными функциями ИИ.
Он включает надежную обработку ошибок, логирование и параметры конфигурации для обеспечения бесперебойной работы.

## Основные функции

### `__init__(self, api_key: str, model_name: Optional[str] = None, generation_config: Optional[Dict] = None, system_instruction: Optional[str] = None, **kwargs)`

**Назначение**: Инициализирует класс `GoogleGenerativeAI` с необходимыми конфигурациями.

**Детали**:
- Устанавливает ключ API, имя модели, конфигурацию генерации и системные инструкции.
- Определяет пути для логирования диалогов и хранения истории.
- Инициализирует модель Google Generative AI.

Пример использования:

.. code-block:: python

    ai = GoogleGenerativeAI(api_key="your_api_key", system_instruction="Instruction")

### `config()`

**Назначение**: Извлекает конфигурацию из файла настроек.

**Детали**:
- Читает и анализирует файл конфигурации, расположенный по адресу `gs.path.src / 'ai' / 'gemini' / 'generative_ai.json'`.
- Использует `j_loads` или `j_loads_ns` для загрузки JSON-файла.

### `_start_chat(self)`

**Назначение**: Начинает сессию чата с моделью ИИ.

**Детали**:
- Инициализирует сессию чата с пустой историей.

### `_save_dialogue(self, dialogue: list)`

**Назначение**: Сохраняет диалог в текстовые и JSON файлы.

**Детали**:
- Добавляет каждое сообщение из диалога в текстовый файл.
- Добавляет каждое сообщение в формате JSON в JSON файл.

### `ask(self, q: str, attempts: int = 15) -> Optional[str]`

**Назначение**: Отправляет текстовый запрос модели ИИ и получает ответ.

**Детали**:
- Обрабатывает несколько попыток в случае сетевых ошибок или недоступности сервиса.
- Логирует ошибки и повторно отправляет запрос с экспоненциальной задержкой.
- Сохраняет диалог в файлы истории.

Пример использования:

.. code-block:: python

    response = ai.ask("Как дела?")
    print(response)

### `chat(self, q: str) -> str`

**Назначение**: Отправляет сообщение чата модели ИИ и получает ответ.

**Детали**:
- Использует сессию чата, инициализированную `_start_chat`.
- Логирует ошибки и возвращает текст ответа.

### `describe_image(self, image_path: Path) -> Optional[str]`

**Назначение**: Генерирует текстовое описание изображения.

**Детали**:
- Кодирует изображение в base64 и отправляет его модели ИИ.
- Возвращает сгенерированное описание или логирует ошибку в случае неудачи.

### `upload_file(self, file: str | Path | IOBase, file_name: Optional[str] = None) -> bool`

**Назначение**: Загружает файл в модель ИИ.

**Детали**:
- Обрабатывает загрузку файла и логирует успех или неудачу.
- Обеспечивает логику повторной попытки в случае ошибок.

## Обработка ошибок

Класс включает в себя комплексную обработку ошибок для различных сценариев:
- **Сетевые ошибки**: Повторяет попытки с экспоненциальной задержкой.
- **Недоступность сервиса**: Логирует ошибки и повторяет попытки.
- **Лимиты квоты**: Логирует и ждет перед повторной попыткой.
- **Ошибки аутентификации**: Логирует и останавливает дальнейшие попытки.
- **Неверный ввод**: Логирует и повторяет попытки с тайм-аутом.
- **Ошибки API**: Логирует и останавливает дальнейшие попытки.

## Логирование и история

Все взаимодействия с моделями ИИ логируются, а диалоги сохраняются в текстовом и JSON форматах для будущего анализа. Это гарантирует, что все операции отслеживаются и могут быть просмотрены для отладки или аудита.

## Конфигурация

Конфигурация загружается из файла `generative_ai.json`, расположенного в директории `src/ai/gemini`. Этот файл должен содержать следующие параметры:

.. code-block:: json

  {
    "api_key": "YOUR_API_KEY",
    "model_name": "gemini-pro",
    "generation_config": {
        "temperature": 0.9,
        "top_p": 1,
        "top_k": 1,
        "max_output_tokens": 8192
     }
  }

`api_key` - Ваш ключ API для доступа к Google Generative AI.
`model_name` - Имя используемой модели.
`generation_config` - Параметры генерации текста (температура, top_p, top_k, max_output_tokens).

## Зависимости

- `google.generativeai`
- `requests`
- `grpc`
- `google.api_core.exceptions`
- `google.auth.exceptions`
- `src.logger`
- `src.utils.printer`
- `src.utils.file`
- `src.utils.date_time`
- `src.utils.convertors.unicode`
- `src.utils.jjson`

## Пример использования

```python
ai = GoogleGenerativeAI(api_key="your_api_key", system_instruction="Instruction")
response = ai.ask("Как дела?")
print(response)
```

Этот пример инициализирует класс `GoogleGenerativeAI` и отправляет запрос модели ИИ, выводя ответ.

---

Для получения более подробной информации обратитесь к исходному коду и комментариям в классе `GoogleGenerativeAI`.
```