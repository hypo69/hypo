# Модуль `Reka`

## Обзор

Модуль `Reka` предназначен для взаимодействия с сервисом Reka AI, предоставляя функциональность для создания завершений текста и загрузки изображений. Этот модуль требует аутентификации и поддерживает потоковую передачу данных.

## Подробнее

Модуль является частью проекта `hypotez` и предоставляет интерфейс для работы с Reka AI API. Он включает в себя методы для получения токена доступа, загрузки изображений и создания текстовых завершений на основе предоставленных сообщений и изображений. Модуль использует библиотеку `requests` для выполнения HTTP-запросов и `json` для обработки данных в формате JSON.

## Классы

### `Reka(AbstractProvider)`

**Описание**: Класс `Reka` предоставляет методы для взаимодействия с API Reka AI.

**Наследует**: `AbstractProvider` - базовый класс для провайдеров, реализующих различные API для генерации текста.

**Атрибуты**:
- `domain` (str): Доменное имя сервиса Reka AI (`space.reka.ai`).
- `url` (str): URL сервиса Reka AI (`https://space.reka.ai`).
- `working` (bool): Указывает, работает ли провайдер (True).
- `needs_auth` (bool): Указывает, требуется ли аутентификация (True).
- `supports_stream` (bool): Указывает, поддерживает ли потоковую передачу данных (True).
- `default_vision_model` (str): Название модели для работы с изображениями (`reka`).
- `cookies` (dict): Словарь с куки для аутентификации.

**Методы**:
- `create_completion`: Создает текстовое завершение на основе предоставленных сообщений и изображения.
- `upload_image`: Загружает изображение на сервер Reka AI.
- `get_access_token`: Получает токен доступа для аутентификации.

## Функции

### `create_completion`

```python
@classmethod
def create_completion(
    cls,
    model: str,
    messages: Messages,
    stream: bool,
    proxy: str = None,
    api_key: str = None,
    image: ImageType = None,
    **kwargs
) -> CreateResult:
    """
    Создает текстовое завершение на основе предоставленных сообщений и изображения.

    Args:
        cls (type[Reka]): Класс Reka.
        model (str): Название используемой модели.
        messages (Messages): Список сообщений для создания завершения.
        stream (bool): Указывает, использовать ли потоковую передачу данных.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        api_key (str, optional): API ключ для аутентификации. По умолчанию `None`.
        image (ImageType, optional): Изображение для анализа. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        CreateResult: Результат создания завершения.

    Raises:
        ValueError: Если не найдены куки или отсутствует `appSession` в куках.

    """
```

**Назначение**: Создает текстовое завершение, используя API Reka AI, на основе предоставленных сообщений и, при необходимости, изображения.

**Параметры**:
- `cls` (type[Reka]): Класс Reka.
- `model` (str): Название используемой модели.
- `messages` (Messages): Список сообщений для создания завершения.
- `stream` (bool): Указывает, использовать ли потоковую передачу данных.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `api_key` (str, optional): API ключ для аутентификации. По умолчанию `None`.
- `image` (ImageType, optional): Изображение для анализа. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `CreateResult`: Результат создания завершения.

**Вызывает исключения**:
- `ValueError`: Если не найдены куки или отсутствует `appSession` в куках, а также если не удалось получить токен доступа.

**Как работает функция**:

1. **Инициализация**:
   - Устанавливает прокси-сервер, если он предоставлен.

2. **Аутентификация**:
   - Если `api_key` не предоставлен, пытается получить куки для домена `cls.domain`.
   - Проверяет наличие кук и наличие ключа `appSession` в куках. Если куки отсутствуют или `appSession` отсутствует, вызывает исключение `ValueError`.
   - Получает токен доступа, используя метод `cls.get_access_token(cls)`, если `api_key` не был предоставлен.

3. **Формирование данных для запроса**:
   - Преобразует список сообщений в формат, ожидаемый API Reka AI.
   - Если предоставлено изображение, загружает его на сервер с помощью `cls.upload_image(cls, api_key, image)` и добавляет URL изображения в данные запроса.

4. **Выполнение запроса и обработка ответа**:
   - Формирует заголовки запроса, включая токен авторизации.
   - Отправляет POST-запрос к API Reka AI (`f'{cls.url}/api/chat'`) с использованием `requests.post`.
   - Обрабатывает ответ в потоковом режиме, извлекая текстовые токены из JSON-ответов и генерируя их.

```
     Начало
     │
     ├── Установка прокси (proxy)
     │
     ├── Проверка api_key
     │   └── Если api_key отсутствует:
     │       ├── Получение куки (get_cookies)
     │       │   └── Проверка куки и appSession
     │       │       └── Если куки или appSession отсутствуют:
     │       │           └── Выброс исключения ValueError
     │       └── Получение токена доступа (get_access_token)
     │
     ├── Формирование conversation_history
     │   └── Добавление текста сообщений
     │
     ├── Проверка image
     │   └── Если image присутствует:
     │       ├── Загрузка изображения (upload_image)
     │       └── Добавление URL изображения в conversation_history
     │
     ├── Формирование заголовков (headers)
     │   └── Включение токена доступа
     │
     ├── Отправка POST-запроса к API Reka (requests.post)
     │   └── Обработка потокового ответа
     │       └── Извлечение текстовых токенов из JSON
     │           └── Генерация токенов
     │
     └── Конец
```

**Примеры**:

```python
# Пример использования с предоставлением api_key
result = Reka.create_completion(
    model='reka-core',
    messages=[{'role': 'user', 'content': 'Hello, Reka!'}],
    stream=True,
    api_key='your_api_key'
)

# Пример использования без api_key (требуется наличие кук)
result = Reka.create_completion(
    model='reka-core',
    messages=[{'role': 'user', 'content': 'Hello, Reka!'}],
    stream=True
)

# Пример использования с изображением и прокси
result = Reka.create_completion(
    model='reka-core',
    messages=[{'role': 'user', 'content': 'Describe this image.'}],
    stream=True,
    image=b'...',  # Замените на реальные данные изображения
    proxy='http://your_proxy:8080'
)
```

### `upload_image`

```python
def upload_image(cls, access_token: str, image: ImageType) -> str:
    """
    Загружает изображение на сервер Reka AI.

    Args:
        cls (type[Reka]): Класс Reka.
        access_token (str): Токен доступа для аутентификации.
        image (ImageType): Изображение для загрузки.

    Returns:
        str: URL загруженного изображения.
    """
```

**Назначение**: Загружает изображение на сервер Reka AI и возвращает URL загруженного изображения.

**Параметры**:
- `cls` (type[Reka]): Класс Reka.
- `access_token` (str): Токен доступа для аутентификации.
- `image` (ImageType): Изображение для загрузки.

**Возвращает**:
- `str`: URL загруженного изображения.

**Как работает функция**:

1. **Генерация случайного токена**:
   - Генерирует случайный токен `boundary_token` для разделения частей тела запроса.

2. **Формирование заголовков запроса**:
   - Создает словарь `headers` с необходимыми заголовками, включая токен авторизации и `Content-Type` с использованием сгенерированного токена `boundary_token`.

3. **Подготовка данных изображения**:
   - Преобразует изображение в байты с помощью функции `to_bytes(image)`.

4. **Формирование тела запроса**:
   - Создает тело запроса в формате `multipart/form-data`, включая данные изображения.

5. **Отправка POST-запроса**:
   - Отправляет POST-запрос к API Reka AI (`f'{cls.url}/api/upload-image'`) с использованием библиотеки `requests`.
   - Включает куки, заголовки и тело запроса.

6. **Обработка ответа**:
   - Извлекает URL загруженного изображения из JSON-ответа и возвращает его.

```
     Начало
     │
     ├── Генерация случайного токена (boundary_token)
     │
     ├── Формирование заголовков (headers)
     │   └── Включение токена доступа и boundary_token
     │
     ├── Преобразование изображения в байты (to_bytes)
     │
     ├── Формирование тела запроса (data)
     │   └── Включение данных изображения
     │
     ├── Отправка POST-запроса к API Reka (requests.post)
     │   └── Включение куки, заголовков и тела запроса
     │
     ├── Извлечение URL изображения из JSON-ответа
     │
     └── Возврат URL изображения
     │
     Конец
```

**Примеры**:

```python
# Пример использования функции upload_image
access_token = 'your_access_token'
image_data = b'...'  # Замените на реальные данные изображения
image_url = Reka.upload_image(Reka, access_token, image_data)
print(f'Image URL: {image_url}')
```

### `get_access_token`

```python
def get_access_token(cls) -> str:
    """
    Получает токен доступа для аутентификации.

    Args:
        cls (type[Reka]): Класс Reka.

    Returns:
        str: Токен доступа.

    Raises:
        ValueError: Если не удалось получить токен доступа.
    """
```

**Назначение**: Получает токен доступа для аутентификации в API Reka AI.

**Параметры**:
- `cls` (type[Reka]): Класс Reka.

**Возвращает**:
- `str`: Токен доступа.

**Вызывает исключения**:
- `ValueError`: Если не удалось получить токен доступа.

**Как работает функция**:

1. **Формирование заголовков запроса**:
   - Создает словарь `headers` с необходимыми заголовками.

2. **Выполнение GET-запроса**:
   - Отправляет GET-запрос к API Reka AI (`f'{cls.url}/bff/auth/access_token'`) с использованием библиотеки `requests`.
   - Включает куки и заголовки запроса.

3. **Обработка ответа**:
   - Извлекает токен доступа из JSON-ответа и возвращает его.
   - Если запрос не удался или токен доступа не найден, вызывает исключение `ValueError`.

```
     Начало
     │
     ├── Формирование заголовков (headers)
     │
     ├── Отправка GET-запроса к API Reka (requests.get)
     │   └── Включение куки и заголовков запроса
     │
     ├── Извлечение токена доступа из JSON-ответа
     │   └── Если токен доступа не найден:
     │       └── Выброс исключения ValueError
     │
     └── Возврат токена доступа
     │
     Конец
```

**Примеры**:

```python
# Пример использования функции get_access_token
try:
    access_token = Reka.get_access_token(Reka)
    print(f'Access Token: {access_token}')
except ValueError as ex:
    print(f'Failed to get access token: {ex}')