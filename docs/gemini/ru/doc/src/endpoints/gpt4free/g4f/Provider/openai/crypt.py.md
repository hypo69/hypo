# Модуль для шифрования и дешифрования данных

## Обзор

Этот модуль предоставляет функции для шифрования и дешифрования данных с использованием алгоритма AES. Он включает в себя функции для добавления и удаления отступов (padding) для обеспечения соответствия размера блока, а также использует соль для повышения безопасности процесса шифрования. Модуль предназначен для защиты конфиденциальной информации, передаваемой или хранящейся в проекте `hypotez`.

## Подробнее

Модуль содержит функции `pad`, `encrypt`, `unpad` и `decrypt`, которые вместе обеспечивают полный цикл шифрования и дешифрования данных. Он использует библиотеку `Crypto.Cipher.AES` для фактического выполнения операций шифрования и дешифрования. Соль генерируется случайным образом и используется вместе с ключом для создания производного ключа и вектора инициализации (IV), что усложняет взлом зашифрованных данных.

## Функции

### `pad`

```python
def pad(data: str) -> bytes:
    """
    Дополняет входную строку до размера, кратного 16 байтам, для соответствия требованиям блочного шифра AES.

    Args:
        data (str): Строка, которую необходимо дополнить.

    Returns:
        bytes: Дополненная строка в виде байтов.

    Как работает функция:
    1. Преобразует входную строку в байты.
    2. Вычисляет необходимое количество байтов для дополнения, чтобы длина данных была кратна 16.
    3. Добавляет байты дополнения, значение каждого байта равно количеству добавленных байтов.

    Пример:
    >>> pad("example")
    b'example\\t\\t\\t\\t\\t\\t\\t\\t\\t'
    """
```

**Как работает функция**:

1.  **Преобразование в байты (Convert to bytes)**:
    - Входная строка `data` кодируется в байты с использованием `data.encode()`.
2.  **Вычисление дополнения (Calculate padding)**:
    - Вычисляется необходимое количество байтов для дополнения, чтобы длина байтовой строки была кратна 16. Это делается с помощью операции `16 - (len(data_bytes) % 16)`.
3.  **Добавление байтов дополнения (Append padding bytes)**:
    - К байтовой строке добавляются байты дополнения, где значение каждого байта равно количеству добавленных байтов. Это делается с помощью `bytes([padding] * padding)`.

```
  Входные данные (data)
  │
  Преобразование строки в байты
  │
  Вычисление количества байтов для дополнения
  │
  Добавление байтов дополнения к данным
  │
  Вывод: Дополненные данные
```

### `encrypt`

```python
def encrypt(data: str, key: str) -> str:
    """
    Шифрует входные данные с использованием алгоритма AES.

    Args:
        data (str): Данные для шифрования.
        key (str): Ключ шифрования.

    Returns:
        str: Зашифрованные данные в формате JSON.

    Как работает функция:
    1. Генерирует случайную соль (8 символов).
    2. Создает производный ключ и вектор инициализации (IV) путем повторного хеширования ключа и соли.
    3. Дополняет данные с помощью функции `pad`.
    4. Шифрует дополненные данные с использованием AES в режиме CBC.
    5. Форматирует зашифрованные данные, IV и соль в JSON.
    """
```

**Как работает функция**:

1.  **Генерация соли (Generate Salt)**:
    - Генерируется случайная соль длиной 8 символов, состоящая из строчных букв английского алфавита.
2.  **Создание производного ключа и IV (Derive Key and IV)**:
    - Ключ и соль многократно хешируются с использованием MD5 для создания производного ключа и вектора инициализации (IV). Этот процесс выполняется трижды.
3.  **Дополнение данных (Padding Data)**:
    - Входные данные дополняются с использованием функции `pad`, чтобы их длина была кратна 16 байтам, что необходимо для AES.
4.  **Шифрование данных (Encrypt Data)**:
    - Создается объект AES с использованием производного ключа и IV, затем данные шифруются в режиме CBC.
5.  **Форматирование результата (Format Result)**:
    - Зашифрованные данные, IV и соль форматируются в JSON и кодируются в base64.

```
  Входные данные (data, key)
  │
  Генерация случайной соли
  │
  Создание производного ключа и IV (многократное хеширование)
  │
  Дополнение данных (pad)
  │
  Шифрование данных (AES)
  │
  Форматирование результата в JSON
  │
  Вывод: Зашифрованные данные в формате JSON
```

### `unpad`

```python
def unpad(data: bytes) -> bytes:
    """
    Удаляет дополнение из входных данных.

    Args:
        data (bytes): Данные с дополнением.

    Returns:
        bytes: Данные без дополнения.

    Как работает функция:
    1. Извлекает значение дополнения из последнего байта данных.
    2. Удаляет байты дополнения на основе извлеченного значения.

    Пример:
    >>> unpad(b'example\\t\\t\\t\\t\\t\\t\\t\\t\\t')
    b'example'
    """
```

**Как работает функция**:

1.  **Извлечение значения дополнения (Extract Padding Value)**:
    - Извлекается значение дополнения из последнего байта данных с помощью `data[-1]`.
2.  **Удаление байтов дополнения (Remove Padding Bytes)**:
    - Удаляются байты дополнения на основе извлеченного значения с помощью `data[:-padding_value]`.

```
  Входные данные (data)
  │
  Извлечение значения дополнения из последнего байта
  │
  Удаление байтов дополнения
  │
  Вывод: Данные без дополнения
```

### `decrypt`

```python
def decrypt(data: str, key: str) -> str:
    """
    Дешифрует входные данные с использованием алгоритма AES.

    Args:
        data (str): Зашифрованные данные в формате JSON.
        key (str): Ключ шифрования.

    Returns:
        str: Дешифрованные данные.

    Как работает функция:
    1. Декодирует JSON данные из base64.
    2. Извлекает зашифрованный текст, IV и соль из JSON.
    3. Создает производный ключ путем повторного хеширования ключа и соли.
    4. Дешифрует данные с использованием AES в режиме CBC.
    5. Удаляет дополнение с помощью функции `unpad`.
    """
```

**Как работает функция**:

1.  **Декодирование JSON (Decode JSON Data)**:
    - Декодирует входную строку `data` из формата base64 и преобразует её в JSON.
2.  **Извлечение данных (Extract Data)**:
    - Извлекает зашифрованный текст (`ct`), вектор инициализации (`iv`) и соль (`salt`) из JSON.
3.  **Создание производного ключа (Derive Key)**:
    - Создает производный ключ путем многократного хеширования ключа и соли с использованием MD5.
4.  **Дешифрование данных (Decrypt Data)**:
    - Создает объект AES с использованием производного ключа и IV, затем дешифрует зашифрованный текст.
5.  **Удаление дополнения (Unpad Data)**:
    - Удаляет дополнение из дешифрованных данных с помощью функции `unpad`.

```
  Входные данные (data, key)
  │
  Декодирование JSON из base64
  │
  Извлечение зашифрованного текста, IV и соли
  │
  Создание производного ключа (многократное хеширование)
  │
  Дешифрование данных (AES)
  │
  Удаление дополнения (unpad)
  │
  Вывод: Дешифрованные данные