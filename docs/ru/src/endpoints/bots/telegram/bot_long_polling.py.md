# Модуль для работы с Telegram ботом (Long Polling)

## Обзор

Модуль `bot_long_polling.py` предназначен для создания и управления Telegram ботом с использованием библиотеки `python-telegram-bot`. Он включает в себя классы для инициализации бота, регистрации обработчиков команд и сообщений, а также для обработки различных типов входящих данных, таких как текст, голосовые сообщения и документы. Модуль использует long polling для получения обновлений от Telegram API.

## Подробней

Данный модуль является частью проекта `hypotez` и обеспечивает интеграцию с Telegram через создание и управление ботом. Модуль содержит класс `TelegramBot`, который отвечает за создание экземпляра бота, регистрацию обработчиков команд и сообщений, а также за обработку различных типов входящих данных, таких как текст, голосовые сообщения и документы.

## Классы

### `TelegramBot`

**Описание**:
Класс `TelegramBot` представляет собой интерфейс для взаимодействия с Telegram ботом. Он инициализирует бота с использованием предоставленного токена, регистрирует обработчики команд и сообщений, а также обеспечивает возможность замены обработчика текстовых сообщений.

**Принцип работы**:
1.  При инициализации класса создается экземпляр `Application` из библиотеки `python-telegram-bot` с использованием предоставленного токена.
2.  Создается экземпляр класса `BotHandler`, который содержит методы для обработки различных типов входящих данных и команд.
3.  Регистрируются обработчики команд `/start`, `/help` и `/sendpdf`, а также обработчики текстовых сообщений, голосовых сообщений и документов.
4.  Предоставляется метод `replace_message_handler` для замены обработчика текстовых сообщений во время работы бота.

**Атрибуты**:

*   `application` (Application): Объект `Application` из библиотеки `python-telegram-bot`, представляющий собой экземпляр бота.
*   `handler` (BotHandler): Объект класса `BotHandler`, содержащий методы для обработки различных типов входящих данных и команд.
*   `_original_message_handler` (MessageHandler): Объект `MessageHandler`, представляющий собой оригинальный обработчик текстовых сообщений.

**Методы**:

*   `__init__(self, token: str)`: Инициализирует Telegram бота.
*   `register_handlers(self) -> None`: Регистрирует обработчики команд и сообщений бота.
*   `replace_message_handler(self, new_handler: Callable) -> None`: Заменяет текущий обработчик текстовых сообщений на новый.
*   `start(self, update: Update, context: CallbackContext) -> None`: Обрабатывает команду `/start`.

## Функции

### `__init__`

```python
def __init__(self, token: str):
    """Initialize the Telegram bot.

    Args:
        token (str): Telegram bot token, e.g., `gs.credentials.telegram.bot.kazarinov`.
    """
    ...
```

**Назначение**:
Инициализация класса `TelegramBot`.

**Параметры**:

*   `token` (str): Токен Telegram бота.

**Как работает функция**:

1.  Создается экземпляр `Application` с использованием предоставленного токена.
2.  Инициализируется обработчик `BotHandler`.
3.  Регистрируются обработчики.

```
A: Получение токена Telegram бота
|
B: Создание экземпляра Application
|
C: Инициализация BotHandler
|
D: Регистрация обработчиков
```

**Примеры**:

```python
bot = TelegramBot(token='YOUR_TELEGRAM_BOT_TOKEN')
```

### `register_handlers`

```python
def register_handlers(self) -> None:
    """Register bot commands and message handlers."""
    ...
```

**Назначение**:
Регистрация обработчиков команд и сообщений бота.

**Как работает функция**:

1.  Добавляются обработчики для команд `/start`, `/help` и `/sendpdf`.
2.  Сохраняется ссылка на обработчик текстовых сообщений.
3.  Добавляются обработчики для голосовых сообщений и документов.

```
A: Добавление обработчика команды /start
|
B: Добавление обработчика команды /help
|
C: Добавление обработчика команды /sendpdf
|
D: Сохранение ссылки на обработчик текстовых сообщений
|
E: Добавление обработчика голосовых сообщений
|
F: Добавление обработчика документов
```

### `replace_message_handler`

```python
def replace_message_handler(self, new_handler: Callable) -> None:
    """
    Заменяет текущий обработчик текстовых сообщений на новый.

    Args:
        new_handler (Callable): Новая функция для обработки сообщений.
    """
    ...
```

**Назначение**:
Замена текущего обработчика текстовых сообщений на новый.

**Параметры**:

*   `new_handler` (Callable): Новая функция для обработки сообщений.

**Как работает функция**:

1.  Удаляется старый обработчик текстовых сообщений.
2.  Создается новый обработчик текстовых сообщений с использованием предоставленной функции.
3.  Регистрируется новый обработчик текстовых сообщений.

```
A: Удаление старого обработчика текстовых сообщений
|
B: Создание нового обработчика текстовых сообщений
|
C: Регистрация нового обработчика текстовых сообщений
```

**Примеры**:

```python
def my_new_handler(update: Update, context: CallbackContext) -> None:
    """
    Новая функция для обработки текстовых сообщений.
    """
    ...

bot = TelegramBot(token='YOUR_TELEGRAM_BOT_TOKEN')
bot.replace_message_handler(my_new_handler)
```

### `start`

```python
async def start(self, update: Update, context: CallbackContext) -> None:
    """Handle the /start command."""
    ...
```

**Назначение**:
Обработка команды `/start`.

**Параметры**:

*   `update` (Update): Объект `Update` из библиотеки `python-telegram-bot`, представляющий собой входящее обновление.
*   `context` (CallbackContext): Объект `CallbackContext` из библиотеки `python-telegram-bot`, представляющий собой контекст выполнения обработчика.

**Как работает функция**:

1.  Логируется информация о том, кто запустил бота.
2.  Отправляется приветственное сообщение пользователю.

```
A: Логирование информации о запуске бота
|
B: Отправка приветственного сообщения пользователю
```

**Примеры**:

```python
# Пример использования внутри класса TelegramBot
bot = TelegramBot(token='YOUR_TELEGRAM_BOT_TOKEN')
# Для запуска необходимо зарегистрировать обработчик команды /start