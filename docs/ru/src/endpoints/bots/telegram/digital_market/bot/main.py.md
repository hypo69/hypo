# Модуль запуска Telegram-бота для Digital Market
## Обзор

Модуль `main.py` является точкой входа для Telegram-бота, предназначенного для использования в Digital Market. Он включает в себя настройку webhook, установку команд бота, регистрацию middleware и routers, а также запуск aiohttp-приложения для обработки входящих запросов.

## Подробнее

Этот модуль координирует основные компоненты бота, такие как обработчики webhook, роутеры для различных типов запросов (пользовательские, административные, каталога), а также middleware для работы с базой данных. Он также отвечает за установку и удаление webhook при запуске и остановке приложения, соответственно.

## Функции

### `set_default_commands`

```python
async def set_default_commands():
    """
    Устанавливает команды по умолчанию для бота.
    """
    ...
```

**Назначение**:
Устанавливает стандартные команды для Telegram-бота, которые будут отображаться в интерфейсе бота для пользователей.

**Как работает функция**:
1. Определяет список команд (`commands`), где каждая команда представлена объектом `BotCommand` с указанием команды (`command`) и её описания (`description`). В данном случае, устанавливается команда `/start` для запуска бота.
2. Использует метод `bot.set_my_commands` для установки этих команд для бота. `BotCommandScopeDefault()` указывает, что команды будут установлены для всех пользователей бота.

     Установка дефолтных команд
     ↓
     Передача команд боту
     ↓
     Установка завершена

**Примеры**:
```python
await set_default_commands()
```

### `on_startup`

```python
async def on_startup(app):
    """
    Выполняется при запуске приложения.
    """
    ...
```

**Назначение**:
Выполняет необходимые действия при запуске aiohttp-приложения, включая установку webhook, отправку уведомлений администраторам и логирование запуска бота.

**Параметры**:
- `app`: Aiohttp-приложение.

**Как работает функция**:
1. Вызывает функцию `set_default_commands` для установки команд по умолчанию для бота.
2. Устанавливает webhook для бота, используя `settings.get_webhook_url` для получения URL webhook.
3. Отправляет уведомления администраторам о запуске бота, перебирая список `admins` и отправляя каждому сообщение через `bot.send_message`.
4. Логирует успешный запуск бота с использованием `logger.info`.
5. Обрабатывает исключения, которые могут возникнуть при отправке сообщений администраторам, логируя ошибки с помощью `logger.error`.

     Установка дефолтных команд
     ↓
     Установка вебхука для бота
     ↓
     Отправка сообщения администраторам
     ↓
     Логирование запуска бота

**Примеры**:
```python
app.on_startup.append(on_startup)
```

### `on_shutdown`

```python
async def on_shutdown(app):
    """
    Выполняется при остановке приложения.
    """
    ...
```

**Назначение**:
Выполняет необходимые действия при остановке aiohttp-приложения, включая отправку уведомлений администраторам, удаление webhook и закрытие сессии бота.

**Параметры**:
- `app`: Aiohttp-приложение.

**Как работает функция**:
1. Отправляет уведомления администраторам об остановке бота, перебирая список `admins` и отправляя каждому сообщение через `bot.send_message`.
2. Удаляет webhook бота с помощью `bot.delete_webhook`, `drop_pending_updates=True` указывает на необходимость отбросить все ожидающие обновления.
3. Закрывает сессию бота с помощью `bot.session.close()`.
4. Логирует остановку бота с использованием `logger.error`.
5. Обрабатывает исключения, которые могут возникнуть при отправке сообщений администраторам, логируя ошибки с помощью `logger.error`.

     Отправка сообщения администраторам
     ↓
     Удаление вебхука
     ↓
     Закрытие сессии бота
     ↓
     Логирование остановки бота

**Примеры**:
```python
app.on_shutdown.append(on_shutdown)
```

### `register_middlewares`

```python
def register_middlewares():
    """
    Регистрирует мидлвари для диспетчера.
    """
    ...
```

**Назначение**:
Регистрирует middleware для диспетчера (dispatcher) aiogram, которые позволяют обрабатывать обновления до того, как они попадут в обработчики.

**Как работает функция**:
1. Регистрирует `DatabaseMiddlewareWithoutCommit` для обработки обновлений без автоматической фиксации изменений в базе данных.
2. Регистрирует `DatabaseMiddlewareWithCommit` для обработки обновлений с автоматической фиксацией изменений в базе данных.

     Регистрация middleware без фиксации
     ↓
     Регистрация middleware с фиксацией

**Примеры**:
```python
register_middlewares()
```

### `register_routers`

```python
def register_routers():
    """
    Регистрирует маршруты для диспетчера.
    """
    ...
```

**Назначение**:
Регистрирует маршруты (routers) для диспетчера aiogram, которые определяют, как обрабатывать различные типы входящих запросов.

**Как работает функция**:
1. Включает `catalog_router` для обработки запросов, связанных с каталогом товаров.
2. Включает `user_router` для обработки пользовательских запросов.
3. Включает `admin_router` для обработки административных запросов.

     Регистрация роутера каталога
     ↓
     Регистрация роутера пользователя
     ↓
     Регистрация роутера администратора

**Примеры**:
```python
register_routers()
```

### `create_app`

```python
def create_app():
    """
    Создает и настраивает приложение aiohttp.
    """
    ...
```

**Назначение**:
Создает и настраивает aiohttp-приложение, включая регистрацию обработчиков маршрутов, настройку приложения с диспетчером и ботом, а также регистрацию функций запуска и остановки.

**Как работает функция**:
1. Создает экземпляр `web.Application()`.
2. Регистрирует обработчики маршрутов:
   - `handle_webhook` для обработки POST-запросов от Telegram по адресу `/{settings.BOT_TOKEN}`.
   - `robokassa_result` для обработки POST-запросов от Robokassa по адресу `/robokassa/result/`.
   - `robokassa_fail` для обработки GET-запросов от Robokassa по адресу `/robokassa/fail/`.
   - `home_page` для обработки GET-запросов по корневому адресу `/`.
3. Настраивает приложение с диспетчером и ботом с помощью `setup_application(app, dp, bot=bot)`.
4. Регистрирует функции `on_startup` и `on_shutdown` для выполнения при запуске и остановке приложения, соответственно.

     Создание aiohttp-приложения
     ↓
     Регистрация обработчиков маршрутов
     ↓
     Настройка приложения с диспетчером и ботом
     ↓
     Регистрация функций запуска и остановки

**Примеры**:
```python
app = create_app()
```

### `main`

```python
def main():
    """
    Главная функция для запуска приложения.
    """
    ...
```

**Назначение**:
Главная функция, которая запускает все компоненты приложения: регистрирует middleware и routers, создает и запускает aiohttp-приложение.

**Как работает функция**:
1. Регистрирует middleware с помощью `register_middlewares()`.
2. Регистрирует routers с помощью `register_routers()`.
3. Создает aiohttp-приложение с помощью `create_app()`.
4. Запускает aiohttp-приложение с помощью `web.run_app`, указывая хост и порт из настроек (`settings.SITE_HOST` и `settings.SITE_PORT`).

     Регистрация middleware
     ↓
     Регистрация роутеров
     ↓
     Создание aiohttp-приложения
     ↓
     Запуск aiohttp-приложения

**Примеры**:
```python
if __name__ == "__main__":
    main()