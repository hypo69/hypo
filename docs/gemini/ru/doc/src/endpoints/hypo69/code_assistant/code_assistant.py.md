# Модуль code_assistant

## Обзор

Модуль `code_assistant` предназначен для обучения моделей машинного обучения на кодовой базе, создания документации к проекту, примеров кода и тестов. Он включает в себя класс `CodeAssistant`, который читает файлы кода, передает их в модель, получает обработанный код и сохраняет результат в директории `docs/gemini` в зависимости от заданной роли.

## Подробнее

Этот модуль является ключевым компонентом проекта `hypotez`, обеспечивающим автоматизацию процесса документирования и анализа кода. Он позволяет использовать модели ИИ для генерации документации, проверки качества кода и создания примеров использования. Класс `CodeAssistant` является центральным элементом, который управляет взаимодействием с моделями ИИ и файловой системой.

## Классы

### `Config`

**Описание**: Класс, содержащий конфигурационные параметры для `CodeAssistant`.

**Параметры**:
- `base_path` (Path): Базовый путь к каталогу `code_assistant`.
- `config` (SimpleNamespace): Объект, содержащий конфигурацию из файла `code_assistant.json`.
- `role` (str): Роль ассистента по умолчанию (`doc_writer_md`).
- `lang` (str): Язык по умолчанию (`ru`).
- `system_instruction` (str): Системная инструкция по умолчанию (пустая строка).
- `gemini` (SimpleNamespace): Объект, содержащий параметры для модели Gemini, такие как `model_name`, `api_key` и `response_mime_type`.

### `CodeAssistant`

**Описание**: Класс для работы ассистента программиста с моделями ИИ.

**Методы**:
- `__init__`: Инициализация ассистента с заданными параметрами.
- `_initialize_models`: Инициализация моделей на основе заданных параметров.
- `code_instruction`: Чтение инструкции для кода.
- `translations`: Загрузка переводов для ролей и языков.
- `send_file`: Отправка файла в модель.
- `process_files`: Компиляция, отправка запроса и сохранение результата.
- `_create_request`: Создание запроса с учетом роли и языка.
- `_yield_files_content`: Генерация путей файлов и их содержимого по указанным шаблонам.
- `_save_response`: Сохранение ответа модели в файл с добавлением суффикса.
- `_remove_outer_quotes`: Удаление внешних кавычек в начале и в конце строки, если они присутствуют.
- `run`: Запуск процесса обработки файлов.
- `_signal_handler`: Обработка прерывания выполнения.

#### `__init__`

```python
def __init__(self, 
             role:Optional[str] = 'doc_writer_md', 
             lang: Optional[str] = 'en', 
             models_list: Optional[list[str,str] | str] = ["gemini"],
             system_instruction:Optional[str | Path] = None,
             **kwards):
    """Инициализация ассистента с заданными параметрами.
    Args:
        role (str): Роль для выполнения задачи.
        lang (str): Язык выполнения.
        models_list (list[str]): Список моделей для инициализации.
        system_instruction (str|Path): Инструкция для системы. Можно отправить текст или путь к файлу.
        **kwards: Дополнительные аргументы для инициализации моделей.
    """
```

**Описание**: Инициализирует экземпляр класса `CodeAssistant` с заданными параметрами, такими как роль, язык, список моделей и системная инструкция.

**Параметры**:
- `role` (Optional[str], optional): Роль для выполнения задачи. По умолчанию `'doc_writer_md'`.
- `lang` (Optional[str], optional): Язык выполнения. По умолчанию `'en'`.
- `models_list` (Optional[list[str, str] | str], optional): Список моделей для инициализации. По умолчанию `["gemini"]`.
- `system_instruction` (Optional[str | Path], optional): Инструкция для системы. Может быть текстом или путем к файлу. По умолчанию `None`.
- `**kwards`: Дополнительные аргументы для инициализации моделей.

**Примеры**:
```python
assistant = CodeAssistant(role='code_checker', lang='ru', models_list=['gemini'])
```

#### `_initialize_models`

```python
def _initialize_models(self, models_list:list, **kwards) -> bool:
    """Инициализация моделей на основе заданных параметров.
    Args:
        models_list (list[str]): Список моделей для инициализации.
        **kwards: Дополнительные аргументы для инициализации моделей.
    Returns:
        bool: Успешность инициализации моделей.
    Raises: 
        Exception: Если произошла ошибка при инициализации моделей.
    """
```

**Описание**: Инициализирует модели ИИ на основе заданных параметров. В настоящее время поддерживается только модель Gemini.

**Параметры**:
- `models_list` (list[str]): Список моделей для инициализации.
- `**kwards`: Дополнительные аргументы для инициализации моделей.

**Возвращает**:
- `bool`: `True`, если инициализация прошла успешно, `False` в противном случае.

**Вызывает исключения**:
- `Exception`: Если произошла ошибка при инициализации модели.

**Примеры**:
```python
assistant._initialize_models(models_list=['gemini'], model_name='gemini-1.5-pro')
```

#### `send_file`

```python
def send_file(self, file_path: Path) -> bool:
    """
    Отправка файла в модель.

    Args:
        file_path (Path): Абсолютный путь к файлу, который нужно отправить.
        file_name (Optional[str]): Имя файла для отправки. Если не указано и 'src' отсутствует, используется имя файла без изменений.

    Returns:
        bool: Успешность выполнения операции.
    """
```

**Описание**: Отправляет содержимое файла в модель Gemini для обработки.

**Параметры**:
- `file_path` (Path): Абсолютный путь к файлу, который нужно отправить.

**Возвращает**:
- `bool`: `True`, если отправка прошла успешно, `False` в противном случае.

**Вызывает исключения**:
- `Exception`: Если произошла ошибка при отправке файла.

**Примеры**:
```python
file_path = Path('example.py')
assistant.send_file(file_path)
```

#### `process_files`

```python
async def process_files(self, start_dirs:str|Path|list[str,str]|list[Path,Path] = None, start_file_number: Optional[int] = 1 ) -> bool:
    """компиляция, отправка запроса и сохранение результата.
   
    """
```

**Описание**: Выполняет компиляцию, отправку запроса в модель и сохранение результата для файлов в указанных директориях.

**Параметры**:
- `start_dirs` (str | Path | list[str, str] | list[Path, Path], optional): Список директорий для начала обработки. По умолчанию `None`.
- `start_file_number` (Optional[int], optional): Номер файла, с которого начать обработку. По умолчанию `1`.

**Возвращает**:
- `bool`: `True`, если обработка прошла успешно, `False` в противном случае.

**Примеры**:
```python
await assistant.process_files(start_dirs=['/path/to/code'])
```

#### `_create_request`

```python
def _create_request(self, file_path: str, content: str) -> str:
    """Создание запроса с учетом роли и языка."""
```

**Описание**: Создает запрос для модели с учетом заданной роли, языка и содержимого файла.

**Параметры**:
- `file_path` (str): Путь к файлу.
- `content` (str): Содержимое файла.

**Возвращает**:
- `str`: Сформированный запрос.

**Примеры**:
```python
request = assistant._create_request(file_path='example.py', content='print("Hello")')
```

#### `_yield_files_content`

```python
def _yield_files_content(
    self,
    process_driectory: str| Path,
) -> Iterator[tuple[Path, str]]:
    """
    Генерирует пути файлов и их содержимое по указанным шаблонам.

    Args:
        process_driectory (Path | str): Абсолютный путь к стартовой директории
      
    Returns:
        bool: Iterator

    """
```

**Описание**: Генерирует пути к файлам и их содержимое на основе указанной директории и шаблонов включения/исключения.

**Параметры**:
- `process_driectory` (str | Path): Путь к директории, в которой нужно искать файлы.

**Возвращает**:
- `Iterator[tuple[Path, str]]`: Итератор, возвращающий кортежи, содержащие путь к файлу и его содержимое.

**Примеры**:
```python
for file_path, content in assistant._yield_files_content(process_driectory='/path/to/code'):
    print(f"File: {file_path}, Content: {content[:100]}...")
```

#### `_save_response`

```python
async def _save_response(self, file_path: Path, response: str, model_name: str) -> bool:
    """Сохранение ответа модели в файл с добавлением суффикса.

    Метод сохраняет ответ модели в файл, добавляя к текущему расширению файла
    дополнительный суффикс, определяемый ролью. 
    Args:
        file_path (Path): Исходный путь к файлу, в который будет записан ответ.
        response (str): Ответ модели, который необходимо сохранить.
        model_name (str): Имя модели, использованной для генерации ответа.

    Raises:
        OSError: Если не удаётся создать директорию или записать в файл.
    """
```

**Описание**: Сохраняет ответ, полученный от модели, в файл с добавлением суффикса, соответствующего заданной роли.

**Параметры**:
- `file_path` (Path): Путь к исходному файлу.
- `response` (str): Ответ от модели.
- `model_name` (str): Название модели, сгенерировавшей ответ.

**Возвращает**:
- `bool`: `True`, если сохранение прошло успешно, `False` в противном случае.

**Вызывает исключения**:
- `OSError`: Если не удалось создать директорию или записать файл.

**Примеры**:
```python
await assistant._save_response(file_path='example.py', response='Documentation for example.py', model_name='gemini')
```

#### `_remove_outer_quotes`

```python
def _remove_outer_quotes(self, response: str) -> str:
    """
    Удаляет внешние кавычки в начале и в конце строки, если они присутствуют.

    :param response: Ответ модели, который необходимо обработать.
    :type response: str
    :return: Очищенный контент как строка.
    :rtype: str

    :example:
        Если строка '```md some content ```' будет передана в функцию,
        результат будет ' some content '.

    """
```

**Описание**: Удаляет внешние кавычки из строки ответа модели.

**Параметры**:
- `response` (str): Строка ответа модели.

**Возвращает**:
- `str`: Строка без внешних кавычек.

**Примеры**:
```python
response = assistant._remove_outer_quotes(response='```md Some text ```')
print(response)  # Вывод: Some text
```

## Функции

### `parse_args`

```python
def parse_args():
    """Разбор аргументов командной строки."""
```

**Описание**: Разбирает аргументы командной строки, переданные при запуске скрипта.

**Возвращает**:
- `dict`: Словарь с аргументами командной строки.

**Примеры**:
```python
args = parse_args()
print(args['role'])
```

### `main`

```python
def main():
    """
    Функция запускает бесконечный цикл, в котором выполняется обработка файлов с учетом ролей и языков, указанных в конфигурации.
    Конфигурация обновляется в каждом цикле, что позволяет динамически изменять настройки в файле `code_assistant.json` во время работы программы.\n
    Для каждой комбинации языка и роли создается экземпляр класса :class:`CodeAssistant`, который обрабатывает файлы, используя заданную модель ИИ.\n
    """
```

**Описание**: Основная функция, запускающая бесконечный цикл обработки файлов на основе конфигурации.

**Примеры**:
```python
main()