# Модуль `GPTalk`

## Обзор

Модуль `GPTalk` предоставляет асинхронный класс `GPTalk`, предназначенный для взаимодействия с сервисом gptalk.net. Он позволяет генерировать ответы на основе предоставленных сообщений, используя модель GPT-3.5 Turbo. Модуль поддерживает работу через прокси и автоматически обновляет токен авторизации при необходимости.

## Подробней

Этот модуль является частью проекта `hypotez` и отвечает за интеграцию с сервисом GPTalk для генерации текста на основе предоставленных сообщений. Он использует асинхронные запросы для взаимодействия с API GPTalk и предоставляет результаты в виде асинхронного генератора.

## Классы

### `GPTalk`

**Описание**: Класс `GPTalk` является асинхронным провайдером, который реализует взаимодействие с сервисом gptalk.net. Он наследуется от `AsyncGeneratorProvider` и предоставляет функциональность для генерации текста на основе модели GPT-3.5 Turbo.

**Наследует**:
- `AsyncGeneratorProvider`: Базовый класс для асинхронных провайдеров, генерирующих результаты.

**Атрибуты**:
- `url` (str): URL сервиса gptalk.net.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели GPT-3.5 Turbo.
- `_auth` (Optional[dict]): Словарь, содержащий данные авторизации.
- `used_times` (int): Количество использований текущего токена авторизации.

**Методы**:
- `create_async_generator()`: Создает асинхронный генератор для получения ответов от GPTalk.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от GPTalk.

    Args:
        cls (GPTalk): Ссылка на класс.
        model (str): Имя модели для использования (по умолчанию "gpt-3.5-turbo").
        messages (Messages): Список сообщений для отправки в GPTalk.
        proxy (Optional[str]): URL прокси-сервера для использования. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий ответы от GPTalk.

    Raises:
        aiohttp.ClientResponseError: Если возникает ошибка при выполнении HTTP-запроса.

    """
```

**Назначение**: Создает асинхронный генератор для получения ответов от GPTalk.

**Параметры**:
- `cls` (GPTalk): Ссылка на класс.
- `model` (str): Имя модели для использования (по умолчанию "gpt-3.5-turbo").
- `messages` (Messages): Список сообщений для отправки в GPTalk.
- `proxy` (Optional[str]): URL прокси-сервера для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий ответы от GPTalk.

**Вызывает исключения**:
- `aiohttp.ClientResponseError`: Если возникает ошибка при выполнении HTTP-запроса.

**Как работает функция**:
1. **Инициализация параметров**:
   - Устанавливает модель по умолчанию, если она не предоставлена.
   - Вычисляет текущий timestamp.
   - Определяет заголовки запроса, включая User-Agent, timestamp и другие необходимые параметры.
2. **Авторизация**:
   - Проверяет необходимость обновления токена авторизации. Это необходимо, если токен отсутствует, истек или был использован 5 раз.
   - Если требуется обновление, отправляет запрос на получение нового токена, используя fingerprint и platform.
   - Обновляет атрибут `_auth` класса и сбрасывает счетчик использований `used_times`.
3. **Формирование данных запроса**:
   - Формирует данные запроса, включая отформатированные сообщения, параметры модели, температуру и другие необходимые параметры.
4. **Отправка запроса на генерацию текста**:
   - Отправляет POST-запрос на API GPTalk для генерации текста, используя полученный токен авторизации.
   - Получает токен для стриминга.
   - Увеличивает счетчик использований токена `used_times`.
5. **Получение стриминговых данных**:
   - Отправляет GET-запрос на API GPTalk для получения стриминговых данных.
   - Асинхронно итерируется по строкам ответа.
   - Извлекает содержимое сообщения из каждой строки, если строка начинается с "data: ".
   - Исключает дублирование контента, сравнивая с предыдущим сообщением `last_message`.
   - Возвращает новые фрагменты сообщения через `yield`.

**Внутренние функции**: Нет.

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from typing import List, Dict

async def main():
    model = "gpt-3.5-turbo"
    messages: List[Dict[str, str]] = [
        {"role": "user", "content": "Привет, как дела?"}
    ]
    proxy = None  # Замените на свой прокси, если необходимо

    generator = GPTalk.create_async_generator(model=model, messages=messages, proxy=proxy)

    async for message in generator:
        print(message, end="")

if __name__ == "__main__":
    asyncio.run(main())