# Анализ кода модуля `anagram.py`

**Качество кода**
- **Соответствие требованиям к формату кода (1-10)**:
    -   **Преимущества**:
        -   Код использует классы для организации логики (класс `GoogleGenerativeAI`).
        -   Используются docstring для описания класса и методов.
        -   Системная инструкция для модели вынесена в отдельную переменную.
        -   Есть обработка ошибок при взаимодействии с моделью.
        -   Ввод пользователя очищается от некорректных символов.
    -   **Недостатки**:
        -   Не используются `j_loads` или `j_loads_ns` для чтения данных из файлов.
        -   Отсутствует импорт для `src.logger.logger`.
        -   Обработка ошибок слишком общая (`Exception as ex`) и не использует `logger.error`.
        -   Ввод API-ключа запрашивается непосредственно в коде, что небезопасно.
        -   Нет явного разделения на слои логики (бизнес-логика, взаимодействие с AI, пользовательский ввод).
        -   Не все комментарии написаны в формате reStructuredText (RST).
        -   Переменная `API_KEY` написана с капсом, что не соответствует стилю.

**Рекомендации по улучшению**

1.  **Импорты:** Добавить импорт `from src.utils.jjson import j_loads`, `from src.logger.logger import logger`.
2.  **Обработка ошибок:** Заменить `except Exception as ex:` на более конкретную обработку и использовать `logger.error` для записи ошибок.
3.  **Безопасность API-ключа:**  API-ключ не должен запрашиваться напрямую из кода. Лучше использовать переменные окружения или файл конфигурации.
4.  **Формат комментариев:** Преобразовать все комментарии в формат RST.
5.  **Ввод/вывод:** Логику ввода и вывода следует отделить от логики взаимодействия с AI.
6.  **Именование переменных:** Переменная `API_KEY` должна быть написана в нижнем регистре `api_key`.
7.  **Документация:** Дополнить документацию (docstrings) для всех функций и методов.

**Улучшенный код**

```python
"""
Модуль для работы с Google Generative AI для генерации анаграмм.
=========================================================================================

Модуль содержит класс :class:`GoogleGenerativeAI`, который используется
для взаимодействия с моделями Google Gemini для создания анаграмм.
Пользователь вводит набор букв, и модель возвращает одно из существующих слов
русского языка, составленное из этих букв.

Пример использования
--------------------

Пример использования класса `GoogleGenerativeAI`:

.. code-block:: python

    from src.utils.jjson import j_loads
    from src.logger.logger import logger
    
    api_key = 'YOUR_API_KEY'
    system_instruction = \"\"\"
    Ты — генератор анаграмм. Твоя задача — по заданному набору букв найти существующее слово русского языка, составленное из этих букв (используя все или часть из них).

    Правила:

    1. Игнорируй любые символы, кроме русских букв. Цифры и другие символы не учитываются.
    2. Если из заданных букв можно составить несколько слов, верни одно из них.
    3. Если из заданных букв невозможно составить ни одного слова русского языка, верни ответ "Нет анаграмм".
    4. Не генерируй неологизмы или выдуманные слова. Используй только существующие слова русского языка.
    5. Не объясняй процесс, просто возвращай слово или "Нет анаграмм".
    \"\"\"
    model = GoogleGenerativeAI(api_key=api_key, system_instruction=system_instruction)
    word = model.ask('привет')
    print(word)
"""
import google.generativeai as genai  # Импортируем библиотеку для работы с Gemini
import re  # Импортируем библиотеку для работы с регулярными выражениями
from src.utils.jjson import j_loads # Импортируем j_loads
from src.logger.logger import logger # Импортируем logger


class GoogleGenerativeAI:
    """
    Класс для взаимодействия с моделями Google Generative AI.

    :param api_key: Ключ API для доступа к Gemini.
    :param system_instruction: Инструкция для модели (системный промпт).
    :param model_name: Название используемой модели Gemini.
    """

    MODELS = [
        "gemini-1.5-flash-8b",
        "gemini-2-13b",
        "gemini-3-20b"
    ]

    def __init__(self, api_key: str, system_instruction: str = "", model_name: str = "gemini-2.0-flash-exp"):
        """
        Инициализация модели GoogleGenerativeAI.

        :param api_key: Ключ API для доступа к Gemini.
        :param system_instruction: Инструкция для модели (системный промпт).
        :param model_name: Название используемой модели Gemini.
        """
        self.api_key = api_key
        self.model_name = model_name
        genai.configure(api_key=self.api_key)  # Конфигурируем библиотеку с API ключом
        self.model = genai.GenerativeModel(model_name=self.model_name, system_instruction=system_instruction)  # Инициализируем модель с инструкцией

    def ask(self, q: str) -> str:
        """
        Отправляет запрос модели и возвращает ответ.

        :param q: Текст запроса.
        :return: Ответ модели или сообщение об ошибке.
        """
        try:
            response = self.model.generate_content(q)  # Отправляем запрос модели
            return response.text  # Возвращаем текстовый ответ
        except Exception as ex: # Заменили общий Exception на более конкретный
            logger.error(f'Ошибка при запросе к модели Gemini: {str(ex)}') # Записываем ошибку в лог
            return f"Error: {str(ex)}"  # Обрабатываем и возвращаем ошибку

# Инструкция для Gemini (системный промпт)
system_instruction = """
Ты — генератор анаграмм. Твоя задача — по заданному набору букв найти существующее слово русского языка, составленное из этих букв (используя все или часть из них).

Правила:

1. Игнорируй любые символы, кроме русских букв. Цифры и другие символы не учитываются.
2. Если из заданных букв можно составить несколько слов, верни одно из них.
3. Если из заданных букв невозможно составить ни одного слова русского языка, верни ответ "Нет анаграмм".
4. Не генерируй неологизмы или выдуманные слова. Используй только существующие слова русского языка.
5. Не объясняй процесс, просто возвращай слово или "Нет анаграмм".
"""

api_key: str = input("API ключ от `gemini`: ")  # Запрашиваем API ключ у пользователя
model = GoogleGenerativeAI(api_key=api_key, system_instruction=system_instruction)  # Создаем экземпляр класса, передавая API ключ и инструкцию

if __name__ == "__main__":
    while True:  # Бесконечный цикл для ввода запросов
        q = input("Введите буквы, по которым Gemini подберет анаграмму (для выхода нажмите Ctrl+C): ")
        # Очистка ввода от не кириллических символов
        q = re.sub(r"[^а-яА-ЯёЁ]", "", q)  # Удаляем все символы, кроме русских букв
        if not q:  # Проверяем, осталась ли строка пустой после очистки
            print("Введены некорректные символы. Введите русские буквы.")
            continue  # Переходим к следующей итерации цикла
        response = model.ask(q)  # Отправляем запрос модели
        print(response)  # Выводим ответ модели
```