# Модуль middleware для работы с базой данных в Telegram боте

## Обзор

Этот модуль предоставляет middleware для интеграции базы данных в обработчики Telegram бота. Он содержит базовый класс `BaseDatabaseMiddleware` и два его подкласса: `DatabaseMiddlewareWithoutCommit` и `DatabaseMiddlewareWithCommit`. Middleware управляет сессиями базы данных, обеспечивая их открытие, передачу в обработчики и закрытие.

## Подробней

Модуль обеспечивает удобный способ работы с базой данных в контексте обработчиков Telegram бота. `BaseDatabaseMiddleware` является абстрактным классом, который определяет основную структуру работы с сессиями базы данных. Подклассы `DatabaseMiddlewareWithoutCommit` и `DatabaseMiddlewareWithCommit` реализуют специфическую логику для работы с сессиями без коммита и с коммитом соответственно.

## Классы

### `BaseDatabaseMiddleware`

**Описание**:
Базовый класс middleware для управления сессиями базы данных.

**Методы**:
- `__call__`: Выполняет middleware, открывает сессию, передает ее в обработчик, обрабатывает результат и закрывает сессию.
- `set_session`: Устанавливает сессию в словарь данных. Должен быть реализован в подклассах.
- `after_handler`: Выполняет действия после вызова обработчика (например, коммит).

**Параметры**:
- Нет

**Примеры**
```python
# Пример использования BaseDatabaseMiddleware (непосредственное использование невозможно, так как это абстрактный класс)
# Этот класс предназначен для наследования.
```

### `DatabaseMiddlewareWithoutCommit`

**Описание**:
Middleware для работы с базой данных без автоматического коммита изменений.

**Методы**:
- `set_session`: Устанавливает сессию в словарь данных под ключом `'session_without_commit'`.

**Параметры**:
- Нет

**Примеры**
```python
# Пример использования DatabaseMiddlewareWithoutCommit
# Создание экземпляра middleware и добавление его в dispatcher
# dp.middleware.setup(DatabaseMiddlewareWithoutCommit())
```

### `DatabaseMiddlewareWithCommit`

**Описание**:
Middleware для работы с базой данных с автоматическим коммитом изменений после обработки.

**Методы**:
- `set_session`: Устанавливает сессию в словарь данных под ключом `'session_with_commit'`.
- `after_handler`: Выполняет коммит сессии после вызова обработчика.

**Параметры**:
- Нет

**Примеры**
```python
# Пример использования DatabaseMiddlewareWithCommit
# Создание экземпляра middleware и добавление его в dispatcher
# dp.middleware.setup(DatabaseMiddlewareWithCommit())
```

## Функции

### `__call__`

```python
    async def __call__(
            self,
            handler: Callable[[Message | CallbackQuery, Dict[str, Any]], Awaitable[Any]],
            event: Message | CallbackQuery,
            data: Dict[str, Any]
    ) -> Any:
        """
        Args:
            handler (Callable[[Message | CallbackQuery, Dict[str, Any]], Awaitable[Any]]): Обработчик события.
            event (Message | CallbackQuery): Объект события (сообщение или callback-запрос).
            data (Dict[str, Any]): Словарь данных, передаваемый в обработчик.

        Returns:
            Any: Результат выполнения обработчика.

        Raises:
            Exception: Если в процессе обработки возникает исключение, выполняется откат транзакции.
        """
```

**Описание**:
Выполняет middleware, открывает сессию, передает ее в обработчик, обрабатывает результат и закрывает сессию.

**Параметры**:
- `handler` (Callable[[Message | CallbackQuery, Dict[str, Any]], Awaitable[Any]]): Обработчик события.
- `event` (Message | CallbackQuery): Объект события (сообщение или callback-запрос).
- `data` (Dict[str, Any]): Словарь данных, передаваемый в обработчик.

**Возвращает**:
- `Any`: Результат выполнения обработчика.

**Вызывает исключения**:
- `Exception`: Если в процессе обработки возникает исключение, выполняется откат транзакции.

**Примеры**:
```python
# Пример использования __call__
# Этот метод вызывается автоматически при обработке события.
```

### `set_session`

```python
    def set_session(self, data: Dict[str, Any], session) -> None:
        """Метод для установки сессии в словарь данных."""
```

**Описание**:
Устанавливает сессию в словарь данных. Должен быть реализован в подклассах.

**Параметры**:
- `data` (Dict[str, Any]): Словарь данных, в который нужно установить сессию.
- `session`: Объект сессии базы данных.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `NotImplementedError`: Если метод не реализован в подклассе.

**Примеры**:
```python
# Пример использования set_session
# Этот метод должен быть переопределен в подклассах для установки сессии в словарь данных.
```

### `after_handler`

```python
    async def after_handler(self, session) -> None:
        """Метод для выполнения действий после вызова хендлера (например, коммит)."""
```

**Описание**:
Выполняет действия после вызова обработчика (например, коммит).

**Параметры**:
- `session`: Объект сессии базы данных.

**Возвращает**:
- `None`

**Вызывает исключения**:
- Нет

**Примеры**:
```python
# Пример использования after_handler
# Этот метод может быть переопределен в подклассах для выполнения действий после обработки события.
```