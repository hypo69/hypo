# Модуль crypt.py

## Обзор

Модуль `crypt.py` предназначен для реализации криптографических функций, используемых в контексте взаимодействия с API mini_max. Он содержит функции для генерации хешей, формирования заголовков и обработки данных, необходимых для безопасного обмена информацией.

## Подробней

Этот модуль обеспечивает криптографическую защиту данных при взаимодействии с API mini_max. Он включает в себя функции хеширования, генерации заголовков и подготовки данных для отправки. Основные функции модуля включают имитацию хеш-функции MD5, генерацию YY-заголовка, получение тела запроса в формате YY и формирование JSON тела запроса. Также модуль содержит асинхронную функцию для получения callback-функции браузера, которая используется для авторизации и получения необходимых параметров для запросов к API.

## Классы

### `CallbackResults`

**Описание**: Класс `CallbackResults` предназначен для хранения результатов обратного вызова (callback) браузера, необходимых для авторизации и выполнения запросов к API.

**Атрибуты**:

- `token` (str): Токен авторизации. Изначально установлен в `None`.
- `path_and_query` (str): Путь и параметры запроса. Изначально установлен в `None`.
- `timestamp` (int): Временная метка. Изначально установлен в `None`.

## Функции

### `hash_function`

```python
def hash_function(base_string: str) -> str:
    """
    Mimics the hashFunction using MD5.
    Args:
        base_string (str): The string to be hashed.

    Returns:
        str: The MD5 hash of the input string in hexadecimal format.
    """
```

**Назначение**: Функция `hash_function` имитирует хеш-функцию, используя алгоритм MD5 для создания хеша из входной строки.

**Параметры**:

- `base_string` (str): Строка, которую необходимо хешировать.

**Возвращает**:

- `str`: MD5 хеш входной строки в шестнадцатеричном формате.

**Как работает функция**:

1. Кодирует входную строку `base_string` в байты, используя кодировку UTF-8.
2. Вычисляет MD5 хеш закодированной строки.
3. Возвращает шестнадцатеричное представление вычисленного хеша.

```
base_string --> encode("utf-8") --> hashlib.md5() --> hexdigest()
```

**Примеры**:

```python
result1 = hash_function("test_string")
print(result1)  # Вывод: 8756312dd2ec430909981169568e94bc

result2 = hash_function("another_string")
print(result2)  # Вывод: 748c5a10b31c67f07ca66f9d9448990b
```

### `generate_yy_header`

```python
def generate_yy_header(has_search_params_path: str, body_to_yy: dict, time: int) -> str:
    """
    Python equivalent of the generateYYHeader function.
    Args:
        has_search_params_path (str): The path with search parameters.
        body_to_yy (dict): The body to be included in the header generation.
        time (int): The timestamp.

    Returns:
        str: The generated YY header.
    """
```

**Назначение**: Функция `generate_yy_header` генерирует заголовок YY, который используется для аутентификации и защиты запросов к API.

**Параметры**:

- `has_search_params_path` (str): Путь с параметрами поиска.
- `body_to_yy` (dict): Тело запроса для включения в генерацию заголовка.
- `time` (int): Временная метка (timestamp).

**Возвращает**:

- `str`: Сгенерированный YY заголовок.

**Как работает функция**:

1. Кодирует `has_search_params_path` с помощью `urllib.parse.quote`.
2. Вычисляет хеш от временной метки `time`.
3. Объединяет закодированный путь, тело запроса и хеш временной метки в одну строку.
4. Вычисляет хеш от объединенной строки и возвращает его.

```
has_search_params_path --> quote()
time --> hash_function()
--> combined_string --> hash_function()
```

**Примеры**:

```python
has_search_params_path = "/v4/api/chat/msg"
body_to_yy = {"key": "value"}
time = 1678886400

result = generate_yy_header(has_search_params_path, body_to_yy, time)
print(result)  # Вывод: 53c6588d25c387bb039899883b389578
```

### `get_body_to_yy`

```python
def get_body_to_yy(l):
    """
    Args:
        l (dict): Input dictionary containing 'msgContent', 'characterID', and 'chatID'.

    Returns:
        str: A string generated by hashing specific elements from the input dictionary.
    """
```

**Назначение**: Функция `get_body_to_yy` формирует строку, которая используется для создания тела запроса YY.

**Параметры**:

- `l` (dict): Словарь, содержащий ключи `'msgContent'`, `'characterID'` и `'chatID'`.

**Возвращает**:

- `str`: Строка, сгенерированная путем хеширования определенных элементов из входного словаря.

**Как работает функция**:

1. Извлекает и очищает значение `'msgContent'` от символов новой строки и возврата каретки.
2. Вычисляет хеш от `'characterID'`, очищенного `'msgContent'` и `'chatID'`.
3. Добавляет хеш пустой строки.
4. Объединяет все хеши в одну строку и возвращает её.

```
l["msgContent"] --> replace() --> hash_function()
l["characterID"] --> hash_function()
l["chatID"] --> hash_function()
"" --> hash_function()
--> combined_string
```

**Примеры**:

```python
data = {"msgContent": "Hello\\nWorld", "characterID": "char123", "chatID": "chat456"}
result = get_body_to_yy(data)
print(result)  # Вывод: 37c22a94f9282e18c7a836e86121a963918b8d20316956f12a0495011838d452d4164f37003d39a5e0d04380ad7f06291d0c2005e098ecf8427e

```

### `get_body_json`

```python
def get_body_json(s):
    """
    Args:
        s (dict): Input dictionary to be converted to JSON.

    Returns:
        str: JSON string representation of the input dictionary, ensuring ASCII characters and sorted keys.
    """
```

**Назначение**: Функция `get_body_json` преобразует словарь в JSON строку.

**Параметры**:

- `s` (dict): Словарь, который нужно преобразовать в JSON.

**Возвращает**:

- `str`: JSON строка, представляющая входной словарь, с обеспечением использования ASCII символов и сортировкой ключей.

**Как работает функция**:

1. Преобразует словарь `s` в JSON строку с использованием `json.dumps`.
2. Обеспечивает, что все символы в JSON строке являются ASCII.
3. Сортирует ключи в JSON строке.

```
s --> json.dumps(ensure_ascii=True, sort_keys=True)
```

**Примеры**:

```python
data = {"key1": "value1", "key2": "value2"}
result = get_body_json(data)
print(result)  # Вывод: {"key1": "value1", "key2": "value2"}
```

### `get_browser_callback`

```python
async def get_browser_callback(auth_result: CallbackResults):
    """
    Args:
        auth_result (CallbackResults): An instance of CallbackResults to store authentication results.

    Returns:
        callable: An asynchronous callback function that retrieves authentication tokens and parameters from the browser page.
    """
```

**Назначение**: Функция `get_browser_callback` возвращает асинхронную callback-функцию, которая извлекает токены авторизации и параметры из браузера.

**Параметры**:

- `auth_result` (CallbackResults): Экземпляр класса `CallbackResults` для хранения результатов авторизации.

**Возвращает**:

- `callable`: Асинхронная callback-функция, которая получает токены авторизации и параметры из страницы браузера.

**Внутренние функции**:

#### `callback`
```python
async def callback(page: Tab):
    """
    Args:
        page (Tab): A tab object representing the browser page.
    """
```
**Параметры**:
- `page` (Tab): Объект вкладки, представляющий страницу браузера.

**Как работает callback**:
1. В цикле ожидает, пока токен авторизации (`auth_result.token`) не будет получен из `localStorage` страницы.
2. После получения токена извлекает параметры запроса и временную метку из `localStorage` и `navigator` страницы.
3. Формирует полный путь запроса, объединяя `API_PATH` с полученными параметрами запроса.

```
while not auth_result.token: --> localStorage.getItem('_token')
--> localStorage.getItem("USER_HARD_WARE_INFO")
--> localStorage.getItem("UNIQUE_USER_ID")
--> navigator.userAgentData?.platform
--> navigator.platform
--> navigator.userAgent.toLowerCase()
--> navigator.hardwareConcurrency
--> navigator.language
--> navigator.platform
--> window.screen.width
--> window.screen.height
--> Date.now()
--> API_PATH + path_and_query
```

**Примеры**:

```python
auth_result = CallbackResults()
callback_func = await get_browser_callback(auth_result)
# callback_func будет асинхронной функцией, которую можно передать в браузер для выполнения
```
```python