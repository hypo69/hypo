# Модуль `DeepInfra`

## Обзор

Модуль `DeepInfra` предназначен для взаимодействия с сервисом DeepInfra для генерации текста и изображений. Он предоставляет классы и методы для аутентификации, запроса моделей и выполнения асинхронных запросов к API DeepInfra. Модуль поддерживает как текстовые, так и графические модели, и использует шаблоны OpenAI для совместимости.

## Подробнее

Модуль `DeepInfra` интегрируется с API DeepInfra для предоставления доступа к различным моделям машинного обучения, включая модели генерации текста и изображения. Он включает в себя функциональность для получения списка доступных моделей, создания асинхронных запросов к API и обработки ответов. Модуль требует аутентификации через API-ключ DeepInfra и предназначен для использования в асинхронных приложениях.

## Классы

### `DeepInfra`

**Описание**: Класс `DeepInfra` является подклассом `OpenaiTemplate` и представляет собой интерфейс для взаимодействия с API DeepInfra.

**Наследует**:
- `OpenaiTemplate`: Предоставляет общую структуру и функциональность для взаимодействия с API, совместимыми с OpenAI.

**Атрибуты**:
- `url` (str): URL главной страницы DeepInfra.
- `login_url` (str): URL страницы для получения API-ключей DeepInfra.
- `api_base` (str): Базовый URL API DeepInfra.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `needs_auth` (bool): Флаг, указывающий, требуется ли аутентификация.
- `default_model` (str): Модель, используемая по умолчанию для генерации текста.
- `default_image_model` (str): Модель, используемая по умолчанию для генерации изображений.
- `models` (List[str]): Список доступных текстовых моделей.
- `image_models` (List[str]): Список доступных графических моделей.

**Методы**:
- `get_models()`: Получает список доступных моделей.
- `get_image_models()`: Получает список доступных моделей изображений.
- `create_async_generator()`: Создает асинхронный генератор для выполнения запросов к API.
- `create_async_image()`: Создает асинхронный запрос для генерации изображений.

## Функции

### `get_models`

```python
    @classmethod
    def get_models(cls, **kwargs) -> list[str]:
        """
        Получает список доступных моделей из API DeepInfra.

        Args:
            **kwargs: Дополнительные аргументы.

        Returns:
            list[str]: Список доступных моделей.

        Как работает функция:
        1. Проверяет, был ли уже получен список моделей. Если да, возвращает существующий список.
        2. Если список моделей еще не был получен, отправляет GET-запрос к API DeepInfra для получения списка моделей.
        3. Извлекает имена моделей из JSON-ответа и разделяет их на текстовые и графические модели.
        4. Расширяет список текстовых моделей списком графических моделей.
        5. Возвращает общий список моделей.

        ASCII flowchart:
        A: Проверка наличия списка моделей
        |
        -- B: Если список есть, вернуть его
        |
        C: Если списка нет, выполнить GET-запрос к API DeepInfra
        |
        D: Извлечение имен моделей из JSON-ответа
        |
        E: Разделение моделей на текстовые и графические
        |
        F: Расширение списка текстовых моделей списком графических
        |
        G: Возврат общего списка моделей

        Примеры:
            >>> DeepInfra.get_models()
            ['meta-llama/Meta-Llama-3.1-70B-Instruct', 'stabilityai/sd3.5', ...]
        """
        ...
```

### `get_image_models`

```python
    @classmethod
    def get_image_models(cls, **kwargs) -> list[str]:
        """
        Получает список доступных моделей изображений из API DeepInfra.

        Args:
            **kwargs: Дополнительные аргументы.

        Returns:
            list[str]: Список доступных моделей изображений.

        Как работает функция:
        1. Проверяет, был ли уже получен список моделей изображений. Если да, возвращает существующий список.
        2. Если список моделей изображений еще не был получен, вызывает метод `get_models()` для получения общего списка моделей.
        3. Возвращает список моделей изображений.

        ASCII flowchart:
        A: Проверка наличия списка моделей изображений
        |
        -- B: Если список есть, вернуть его
        |
        C: Если списка нет, вызвать get_models()
        |
        D: Возврат списка моделей изображений

        Примеры:
            >>> DeepInfra.get_image_models()
            ['stabilityai/sd3.5', ...]
        """
        ...
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        stream: bool,
        prompt: str = None,
        temperature: float = 0.7,
        max_tokens: int = 1028,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для выполнения запросов к API DeepInfra.

        Args:
            model (str): Имя модели для использования.
            messages (Messages): Список сообщений для отправки.
            stream (bool): Флаг, указывающий, использовать ли потоковую передачу.
            prompt (str, optional): Текст запроса. По умолчанию `None`.
            temperature (float, optional): Температура для генерации текста. По умолчанию 0.7.
            max_tokens (int, optional): Максимальное количество токенов в ответе. По умолчанию 1028.
            **kwargs: Дополнительные аргументы.

        Yields:
            AsyncResult: Части ответа от API.

        Как работает функция:
        1. Проверяет, является ли выбранная модель моделью изображения. Если да, вызывает метод `create_async_image()` для генерации изображения.
        2. Если модель не является моделью изображения, устанавливает заголовки запроса.
        3. Вызывает метод `create_async_generator()` родительского класса `OpenaiTemplate` для выполнения запроса к API.
        4. Передает полученные чанки ответа.

        ASCII flowchart:
        A: Проверка, является ли модель моделью изображения
        |
        -- B: Если да, вызвать create_async_image()
        |
        C: Если нет, установить заголовки запроса
        |
        D: Вызвать create_async_generator() родительского класса
        |
        E: Передача полученных чанков ответа

        Примеры:
            >>> async for chunk in DeepInfra.create_async_generator(model='meta-llama/Meta-Llama-3.1-70B-Instruct', messages=[{'role': 'user', 'content': 'Hello'}]):
            ...     print(chunk)
        """
        ...
```

### `create_async_image`

```python
    @classmethod
    async def create_async_image(
        cls,
        prompt: str,
        model: str,
        api_key: str = None,
        api_base: str = "https://api.deepinfra.com/v1/inference",
        proxy: str = None,
        timeout: int = 180,
        extra_data: dict = {},\
        **kwargs
    ) -> ImageResponse:
        """
        Создает асинхронный запрос для генерации изображений через API DeepInfra.

        Args:
            prompt (str): Текст запроса для генерации изображения.
            model (str): Имя модели для использования.
            api_key (str, optional): API-ключ для аутентификации. По умолчанию `None`.
            api_base (str, optional): Базовый URL API. По умолчанию "https://api.deepinfra.com/v1/inference".
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            timeout (int, optional): Время ожидания запроса в секундах. По умолчанию 180.
            extra_data (dict, optional): Дополнительные данные для отправки в запросе. По умолчанию `{}`.
            **kwargs: Дополнительные аргументы.

        Returns:
            ImageResponse: Объект `ImageResponse`, содержащий сгенерированное изображение.

        Raises:
            RuntimeError: Если API возвращает ошибку или не содержит изображений в ответе.

        Как работает функция:
        1. Устанавливает заголовки запроса, включая API-ключ, если он предоставлен.
        2. Создает асинхронную сессию с использованием `StreamSession` для отправки запроса.
        3. Получает имя модели, если необходимо.
        4. Формирует данные запроса, включая текст запроса и дополнительные данные.
        5. Отправляет POST-запрос к API DeepInfra для генерации изображения.
        6. Обрабатывает ответ API, извлекая URL изображения или список URL изображений.
        7. Возвращает объект `ImageResponse`, содержащий URL изображения и текст запроса.

        ASCII flowchart:
        A: Установка заголовков запроса
        |
        B: Создание асинхронной сессии
        |
        C: Получение имени модели
        |
        D: Формирование данных запроса
        |
        E: Отправка POST-запроса к API
        |
        F: Обработка ответа API
        |
        G: Возврат объекта ImageResponse

        Примеры:
            >>> image = await DeepInfra.create_async_image(prompt='A cat', model='stabilityai/sd3.5', api_key='YOUR_API_KEY')
            >>> print(image.image_url)
            'https://example.com/image.png'
        """
        ...