# Модуль `Qwen_Qwen_2_72B`

## Обзор

Модуль `Qwen_Qwen_2_72B` предоставляет асинхронный генератор для взаимодействия с моделью Qwen Qwen-2.72B, размещенной на платформе Hugging Face Space. Он позволяет отправлять запросы к модели и получать ответы в потоковом режиме.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для интеграции с другими компонентами, использующими асинхронные генераторы для обработки данных. Модуль поддерживает потоковую передачу данных, системные сообщения и предоставляет псевдонимы моделей для упрощения конфигурации.

## Классы

### `Qwen_Qwen_2_72B`

**Описание**: Класс `Qwen_Qwen_2_72B` является поставщиком асинхронного генератора и предоставляет методы для взаимодействия с моделью Qwen Qwen-2.72B.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет общие методы для работы с моделями.

**Атрибуты**:
- `label` (str): Метка поставщика (Qwen Qwen-2.72B).
- `url` (str): URL платформы Hugging Face Space, на которой размещена модель.
- `api_endpoint` (str): URL API для присоединения к очереди запросов.
- `working` (bool): Флаг, указывающий на работоспособность поставщика.
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных.
- `supports_system_message` (bool): Флаг, указывающий на поддержку системных сообщений.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений.
- `default_model` (str): Модель по умолчанию (qwen-qwen2-72b-instruct).
- `model_aliases` (dict): Псевдонимы моделей.
- `models` (list): Список поддерживаемых моделей.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от модели.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для получения ответов от модели Qwen Qwen-2.72B.

        Args:
            model (str): Имя модели для использования.
            messages (Messages): Список сообщений для отправки модели.
            proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий текстовые фрагменты ответа модели.
        
        Raises:
            aiohttp.ClientError: Если возникает ошибка при выполнении HTTP-запроса.
            json.JSONDecodeError: Если не удается декодировать JSON-ответ.

        **Внутренние функции**:
        - `generate_session_hash`: Генерирует уникальный хеш сессии.

        """
```

#### Как работает функция:

1.  **Генерация уникального хеша сессии**:
    *   Вызывается функция `generate_session_hash` для создания уникального идентификатора сессии.
2.  **Подготовка заголовков и полезной нагрузки для запроса**:
    *   Формируются HTTP-заголовки, включающие `accept`, `accept-language`, `content-type`, `origin`, `referer` и `user-agent`.
    *   Из списка сообщений извлекается системный промт (если есть).
    *   Формируется полезная нагрузка `payload_join`, включающая промт, системный промт, индекс функции и хеш сессии.
3.  **Отправка запроса на присоединение к очереди**:
    *   Используется `aiohttp.ClientSession` для отправки POST-запроса к `api_endpoint` с заголовками и полезной нагрузкой.
    *   Полученный `event_id` из JSON-ответа используется для последующих запросов.
4.  **Подготовка к потоковой передаче данных**:
    *   Формируются URL и заголовки для запроса потоковых данных.
    *   Определяются параметры запроса, включающие хеш сессии.
5.  **Получение и обработка потоковых данных**:
    *   Отправляется GET-запрос к `url_data` с заголовками и параметрами.
    *   Построчно считывается содержимое ответа.
    *   Декодируется каждая строка в UTF-8.
    *   Если строка начинается с `data: `, извлекается JSON-данные.
6.  **Анализ JSON-данных и извлечение фрагментов текста**:
    *   Проверяется наличие ключа `msg` в JSON-данных.
    *   Если `msg` равно `process_generating`, извлекаются фрагменты текста из `output_data`.
    *   Фрагменты текста добавляются к полной строке ответа (`full_response`) и возвращаются через `yield`.
    *   Если `msg` равно `process_completed`, извлекается окончательный ответ из `output_data`.
    *   Окончательный ответ очищается от уже полученных фрагментов и возвращается через `yield`.
7.  **Обработка ошибок**:
    *   Если не удается декодировать JSON-данные, регистрируется ошибка с использованием `debug.log`.

#### Flowchart

```
    +-----------------------------------------------------+
    | A: Генерация уникального хеша сессии                |
    +-----------------------------------------------------+
    |                                                     |
    V                                                     |
    +-----------------------------------------------------+
    | B: Подготовка заголовков и полезной нагрузки для запроса |
    +-----------------------------------------------------+
    |                                                     |
    V                                                     |
    +-----------------------------------------------------+
    | C: Отправка запроса на присоединение к очереди      |
    +-----------------------------------------------------+
    |                                                     |
    V                                                     |
    +-----------------------------------------------------+
    | D: Подготовка к потоковой передаче данных           |
    +-----------------------------------------------------+
    |                                                     |
    V                                                     |
    +-----------------------------------------------------+
    | E: Получение и обработка потоковых данных           |
    +-----------------------------------------------------+
    |                                                     |
    V                                                     |
    +-----------------------------------------------------+
    | F: Анализ JSON-данных и извлечение фрагментов текста |
    +-----------------------------------------------------+
    |                                                     |
    V                                                     |
    +-----------------------------------------------------+
    | G: Обработка ошибок                                 |
    +-----------------------------------------------------+
```

#### Примеры:

```python
# Пример использования create_async_generator
import asyncio
from src.endpoints.gpt4free.g4f.typing import Messages

async def main():
    model = "qwen-qwen2-72b-instruct"
    messages: Messages = [
        {"role": "system", "content": "You are a helpful assistant."},
        {"role": "user", "content": "What is the capital of France?"}
    ]

    generator = Qwen_Qwen_2_72B.create_async_generator(model=model, messages=messages)
    
    async for fragment in await generator:
        print(fragment, end="")

if __name__ == "__main__":
    asyncio.run(main())
```

### `generate_session_hash`

```python
        def generate_session_hash():
            """Generate a unique session hash."""
            return str(uuid.uuid4()).replace(\'-\', \'\')[:12]
```

Внутренняя функция генерирует уникальный хеш сессии, используемый для идентификации сессии при взаимодействии с API. Хеш генерируется на основе UUID (Universally Unique Identifier) и обрезается до первых 12 символов.

**Как работает функция**:

1.  Генерирует UUID с помощью `uuid.uuid4()`.
2.  Преобразует UUID в строку с помощью `str()`.
3.  Удаляет дефисы из строки с помощью `replace('-', '')`.
4.  Обрезает строку до первых 12 символов с помощью `[:12]`.
5.  Возвращает полученный хеш сессии.

##