# Анализ кода модуля 

## Качество кода
**Соответствие требованиям к формату кода (1-10):**

-   **Преимущества:**
    *   Код содержит достаточно подробные комментарии, объясняющие основные моменты реализации.
    *   Присутствует описание игр и их правил, что делает код понятным для использования в образовательных целях.
    *   Используется класс `GoogleGenerativeAI` для инкапсуляции логики взаимодействия с моделями Gemini.
    *   Системные инструкции разделены для разных игр, что способствует более четкому разделению ответственности.
    *   Примеры использования демонстрируют, как можно взаимодействовать с моделями, используя предоставленный код.

-   **Недостатки:**
    *   Не используется reStructuredText (RST) для комментариев и docstring, как требуется.
    *   Отсутствуют импорты необходимых библиотек, которые используются в коде, например, `src.utils.jjson`.
    *   В коде присутствуют стандартные блоки `try-except`, но не используется `logger.error` для обработки ошибок.
    *   Используется прямой `json.load`, а не `j_loads` или `j_loads_ns`.
    *   Необходимо переписать docstring в соответствии с форматом RST.
    *   Не используются константы для системных инструкций, что снижает читаемость.
    *   Отсутствует logging для отладки и мониторинга.
    *   Не соблюдена последовательность операций с кодом (чтение файла, обработка, запись).
    *   Отсутствуют проверки типов и параметров функций.

## Рекомендации по улучшению
1.  **Переписать комментарии и docstring:** Использовать reStructuredText (RST) для всех комментариев и docstring, включая описания модулей, функций, методов и переменных.
2.  **Импорт необходимых библиотек:** Добавить импорты для всех необходимых модулей, включая `src.utils.jjson` и `src.logger.logger`.
3.  **Обработка ошибок:** Заменить стандартные блоки `try-except` на использование `logger.error` для обработки ошибок.
4.  **Чтение файлов:** Использовать `j_loads` или `j_loads_ns` из `src.utils.jjson` вместо `json.load`.
5.  **Константы:** Определить константы для системных инструкций, чтобы сделать код более читаемым.
6.  **Логирование:** Добавить логирование для отладки и мониторинга.
7.  **Типизация:** Добавить аннотации типов для параметров функций и возвращаемых значений.
8.  **Обработка ввода:** Добавить валидацию ввода для API ключа и запросов к модели.
9.  **Разделение логики:** Разделить код на более мелкие функции для улучшения читаемости и переиспользования.
10. **Удалить лишнее:** Убрать комментарии, которые не добавляют смысловой нагрузки (например, `Замените "YOUR_API_KEY" на свой API-ключ`).

## Улучшенный код
```python
"""
Модуль для реализации интерактивных обучающих математических игр с использованием Google Gemini.
=========================================================================================

Модуль предоставляет классы и функции для создания и взаимодействия с моделями Google Gemini,
а также реализует две математические игры: "Ввод-Вывод" и "10-центовый компьютер".

Примеры использования:
----------------------

Пример использования класса `GoogleGenerativeAI` и игр:

.. code-block:: python

    api_key = "YOUR_API_KEY" # Замените на свой API-ключ
    input_output_game = GoogleGenerativeAI(api_key=api_key, system_instruction=SYSTEM_INSTRUCTION_INPUT_OUTPUT)
    binary_computer = GoogleGenerativeAI(api_key=api_key, system_instruction=SYSTEM_INSTRUCTION_BINARY)
    print("Игра Ввод-Вывод:")
    print(input_output_game.ask("Ввод: 7"))
    print(binary_computer.ask("Десятичное: 6"))
"""

import google.generativeai as genai # Импорт библиотеки для работы с Google Gemini
from typing import Any # Импорт для аннотации типов
from src.logger.logger import logger # Импорт логгера для обработки ошибок
# from src.utils.jjson import j_loads, j_loads_ns # TODO: не используется, но если в дальнейшем понадобится - раскомментировать

# Константы для системных инструкций
SYSTEM_INSTRUCTION_INPUT_OUTPUT = """
Вы - игровой движок для математической игры "Ввод-Вывод". Ваша задача - преобразовать число, которое поступает в "Ввод" в соответствии с заданным правилом (скрытой "машиной") и выдать результат в "Вывод".

Вы должны придерживаться следующих правил:
-   Начинайте с простых правил (например, сложение или вычитание с целым числом).
-   По мере того, как пользователь справляется, вы можете постепенно переходить к более сложным правилам (умножение, деление, корень, комбинации операций и т.д).
-   Если пользователь запрашивает конкретное правило, вы должны его использовать.
-   В конце каждого ответа вы должны кратко указывать тип операции, которую вы использовали (например "машина +3" или "машина 2x+1").

**Формат ввода/вывода:**
-   Пользователь: `Ввод: <число>`
-   Вы: `Вывод: <результат>, машина:<описание операции>`

**Примеры:**

Пользователь: `Ввод: 5`
Вы: `Вывод: 8, машина +3`

Пользователь: `Ввод: 10`
Вы: `Вывод: 21, машина 2x+1`

Пользователь: `Ввод: 9`
Вы: `Вывод: 3, машина квадратный корень`

Пользователь: `Задайте машину x * 2`
Вы: `Окей, машина: x*2`

**Начните игру с любым простым правилом.**
""" # Системная инструкция для игры "Ввод-Вывод"

SYSTEM_INSTRUCTION_BINARY = """
Вы - симулятор "10-центового компьютера" для обучения детей двоичной системе счисления. Ваша задача - представлять числа в двоичной форме с помощью 4 "лампочек" (0 - лампа выключена, 1 - лампа включена). 

Ваши лампочки обозначают 1, 2, 4 и 8 в двоичной системе (справа налево).

Вы должны следовать следующим правилам:
-   Когда пользователь указывает десятичное число, вы показываете, какие "лампочки" нужно включить (1) и выключить (0), чтобы это число отобразить.
-   Когда пользователь указывает, какие "лампочки" включены, вы говорите, какое десятичное число они представляют.
-   Вы должны использовать формат `0000` для двоичного представления, где крайний правый бит - 1, затем 2, 4 и 8 соответственно.
-   Если пользователь просит объяснить, что вы сделали - объясните.

**Формат ввода/вывода:**
-   Пользователь: `Десятичное: <число>`
-   Вы: `Двоичное: <двоичное представление>, объяснение:<что вы сделали>`
-   Пользователь: `Лампочки: <двоичное представление>`
-   Вы: `Десятичное: <число>, объяснение:<что вы сделали>`

**Примеры:**
Пользователь: `Десятичное: 5`
Вы: `Двоичное: 0101, объяснение: Включены лампочки 1 и 4, 1+4=5`

Пользователь: `Лампочки: 1010`
Вы: `Десятичное: 10, объяснение: Включены лампочки 2 и 8, 2+8=10`

Пользователь: `Объясните как 7`
Вы: `Двоичное: 1110, объяснение: Включены лампочки 1,2 и 4. 1+2+4 = 7`

**Начните симуляцию с любого простого числа.**
""" # Системная инструкция для игры "10-центовый компьютер"

class GoogleGenerativeAI:
    """
    Класс для взаимодействия с моделями Google Generative AI.

    :param api_key: Ключ API для доступа к Gemini.
    :type api_key: str
    :param system_instruction: Инструкция для модели (системный промпт).
    :type system_instruction: str
    :param model_name: Название используемой модели Gemini. По умолчанию 'gemini-2-13b'.
    :type model_name: str
    """
    MODELS = [
        'gemini-1.5-flash-8b',
        'gemini-2-13b',
        'gemini-3-20b'
    ] # Список доступных моделей

    def __init__(self, api_key: str, system_instruction: str, model_name: str = 'gemini-2-13b'):
        """
        Инициализация модели GoogleGenerativeAI.

        :param api_key: Ключ API для доступа к Gemini.
        :type api_key: str
        :param system_instruction: Инструкция для модели (системный промпт).
        :type system_instruction: str
        :param model_name: Название используемой модели Gemini. По умолчанию 'gemini-2-13b'.
        :type model_name: str
        """
        try:
            if not api_key:
               raise ValueError('API ключ не может быть пустым') # Проверка наличия API ключа
            self.api_key = api_key
            self.model_name = model_name
            genai.configure(api_key=self.api_key) # Конфигурация библиотеки с API ключом
            self.model = genai.GenerativeModel(model_name=self.model_name, system_instruction=system_instruction) # Инициализация модели с инструкцией
        except Exception as ex: # Обработка ошибок при инициализации
            logger.error(f'Ошибка при инициализации GoogleGenerativeAI: {ex}') # Логирование ошибки
            raise # Проброс исключения
    
    def ask(self, q: str) -> str:
        """
        Отправка запроса модели и получение ответа.

        :param q: Текст запроса.
        :type q: str
        :return: Ответ модели или сообщение об ошибке.
        :rtype: str
        """
        try:
            if not q:
                raise ValueError('Запрос не может быть пустым') # Проверка наличия запроса
            response = self.model.generate_content(q) # Отправка запроса модели
            return response.text # Получение текстового ответа
        except Exception as ex: # Обработка ошибок при выполнении запроса
            logger.error(f'Ошибка при выполнении запроса к модели: {ex}') # Логирование ошибки
            return f'Error: {str(ex)}' # Возврат сообщения об ошибке

# Замените "YOUR_API_KEY" на свой API-ключ
api_key = "YOUR_API_KEY"

# Инициализация игры "Ввод-Вывод"
input_output_game = GoogleGenerativeAI(api_key=api_key, system_instruction=SYSTEM_INSTRUCTION_INPUT_OUTPUT)

# Инициализация "10-центового компьютера"
binary_computer = GoogleGenerativeAI(api_key=api_key, system_instruction=SYSTEM_INSTRUCTION_BINARY)

# Примеры использования:
print("Игра Ввод-Вывод:") # Вывод заголовка игры "Ввод-Вывод"
print(input_output_game.ask("Ввод: 7")) # Запрос к модели для игры "Ввод-Вывод"
print(input_output_game.ask("Ввод: 12")) # Запрос к модели для игры "Ввод-Вывод"
print(input_output_game.ask("Задайте машину x / 2")) # Запрос к модели для игры "Ввод-Вывод"
print(input_output_game.ask("Ввод: 12")) # Запрос к модели для игры "Ввод-Вывод"

print("\n10-центовый компьютер:") # Вывод заголовка игры "10-центовый компьютер"
print(binary_computer.ask("Десятичное: 6")) # Запрос к модели для игры "10-центовый компьютер"
print(binary_computer.ask("Лампочки: 0111")) # Запрос к модели для игры "10-центовый компьютер"
print(binary_computer.ask("Объясните как 13")) # Запрос к модели для игры "10-центовый компьютер"