# Модуль crypto

## Обзор

Модуль `crypto.py` предоставляет набор функций для шифрования и дешифрования данных, используемых в Mega. Он включает функции для AES-CBC шифрования, хеширования строк и подготовки ключей.

## Подробней

Этот модуль содержит функции, необходимые для обеспечения безопасности данных при работе с сервисом Mega. Он использует криптографические методы, такие как AES (Advanced Encryption Standard) в режиме CBC (Cipher Block Chaining), для защиты конфиденциальности и целостности данных.

## Функции

### `aes_cbc_encrypt`

```python
def aes_cbc_encrypt(data, key):
    """
    Шифрует данные с использованием алгоритма AES в режиме CBC.

    Args:
        data (bytes): Данные для шифрования.
        key (bytes): Ключ шифрования.

    Returns:
        bytes: Зашифрованные данные.

    Raises:
        Не вызывает исключений.

    Example:
        >>> key = b'\\x00' * 16
        >>> data = b'This is a test'
        >>> encrypted_data = aes_cbc_encrypt(data, key)
        >>> print(encrypted_data)
        b'\\x08\\xb1\\xc7\\xa7\\xbc\\x8b\\x90\\x94\\x0e\\xe2\\x9c\\x0e\\xaa\\xba\\xaf\\xcd'
    """
```

**Как работает функция**:
1. Функция инициализирует объект шифрования AES с использованием предоставленного ключа и режима CBC, с вектором инициализации (IV), установленным в `\0 * 16`.
2. Функция шифрует входные данные с использованием созданного объекта шифрования.

### `aes_cbc_decrypt`

```python
def aes_cbc_decrypt(data, key):
    """
    Дешифрует данные, зашифрованные алгоритмом AES в режиме CBC.

    Args:
        data (bytes): Зашифрованные данные.
        key (bytes): Ключ дешифрования.

    Returns:
        bytes: Дешифрованные данные.

    Raises:
        Не вызывает исключений.

    Example:
        >>> key = b'\\x00' * 16
        >>> encrypted_data = b'\\x08\\xb1\\xc7\\xa7\\xbc\\x8b\\x90\\x94\\x0e\\xe2\\x9c\\x0e\\xaa\\xba\\xaf\\xcd'
        >>> decrypted_data = aes_cbc_decrypt(encrypted_data, key)
        >>> print(decrypted_data)
        b'This is a test'
    """
```

**Как работает функция**:
1. Функция инициализирует объект дешифрования AES с использованием предоставленного ключа и режима CBC, с вектором инициализации (IV), установленным в `\0 * 16`.
2. Функция дешифрует входные данные с использованием созданного объекта дешифрования.

### `aes_cbc_encrypt_a32`

```python
def aes_cbc_encrypt_a32(data, key):
    """
    Шифрует данные, представленные в формате a32, с использованием алгоритма AES в режиме CBC.

    Args:
        data (list[int]): Данные для шифрования в формате a32 (список 32-битных целых чисел).
        key (list[int]): Ключ шифрования в формате a32.

    Returns:
        list[int]: Зашифрованные данные в формате a32.

    Raises:
        Не вызывает исключений.

    Example:
        >>> data = [1, 2, 3, 4]
        >>> key = [5, 6, 7, 8]
        >>> encrypted_data = aes_cbc_encrypt_a32(data, key)
        >>> print(encrypted_data)
        [1477272918, 3523888213, 276682381, 3271789593]
    """
```

**Как работает функция**:
1. Функция преобразует входные данные и ключ из формата a32 в строковый формат.
2. Функция вызывает функцию `aes_cbc_encrypt` для шифрования строковых данных с использованием строкового ключа.
3. Функция преобразует зашифрованные строковые данные обратно в формат a32.

### `aes_cbc_decrypt_a32`

```python
def aes_cbc_decrypt_a32(data, key):
    """
    Дешифрует данные, представленные в формате a32, с использованием алгоритма AES в режиме CBC.

    Args:
        data (list[int]): Зашифрованные данные в формате a32 (список 32-битных целых чисел).
        key (list[int]): Ключ дешифрования в формате a32.

    Returns:
        list[int]: Дешифрованные данные в формате a32.

    Raises:
        Не вызывает исключений.

    Example:
        >>> data = [1477272918, 3523888213, 276682381, 3271789593]
        >>> key = [5, 6, 7, 8]
        >>> decrypted_data = aes_cbc_decrypt_a32(data, key)
        >>> print(decrypted_data)
        [1, 2, 3, 4]
    """
```

**Как работает функция**:
1. Функция преобразует входные данные и ключ из формата a32 в строковый формат.
2. Функция вызывает функцию `aes_cbc_decrypt` для дешифрования строковых данных с использованием строкового ключа.
3. Функция преобразует дешифрованные строковые данные обратно в формат a32.

### `stringhash`

```python
def stringhash(s, aeskey):
    """
    Вычисляет хеш строки с использованием AES-CBC.

    Args:
        s (str): Входная строка для хеширования.
        aeskey (list[int]): Ключ AES в формате a32.

    Returns:
        str: Хеш строки в формате base64.

    Raises:
        Не вызывает исключений.

    Example:
        >>> aeskey = [1, 2, 3, 4]
        >>> s = 'example'
        >>> hash_value = stringhash(s, aeskey)
        >>> print(hash_value)
        'gPIPOJbdlE7zKIVjJqEzuQ'
    """
```

**Как работает функция**:
1. Функция преобразует входную строку в формат a32.
2. Функция инициализирует хеш-значение как список из четырех 32-битных целых чисел (все нули).
3. Функция выполняет XOR-операцию каждого 32-битного слова входной строки с хеш-значением.
4. Функция выполняет 0x4000 итераций AES-CBC шифрования хеш-значения с использованием предоставленного ключа AES.
5. Функция преобразует хеш-значение в формат base64 и возвращает его.

### `prepare_key`

```python
def prepare_key(a):
    """
    Подготавливает ключ для шифрования.

    Args:
        a (list[int]): Входные данные для подготовки ключа в формате a32.

    Returns:
        list[int]: Подготовленный ключ в формате a32.

    Raises:
        Не вызывает исключений.

    Example:
        >>> a = [1, 2, 3, 4, 5, 6, 7, 8]
        >>> prepared_key = prepare_key(a)
        >>> print(prepared_key)
        [222366119, 1808943148, 3120459699, 2536744464]
    """
```

**Как работает функция**:
1. Функция инициализирует pkey как список из четырех 32-битных целых чисел (константы).
2. Функция выполняет 0x10000 итераций AES-CBC шифрования pkey с использованием частей входных данных в качестве ключей.
3. Функция возвращает подготовленный ключ pkey.

### `encrypt_key`

```python
def encrypt_key(a, key):
    """
    Шифрует ключ.

    Args:
        a (list[int]): Ключ для шифрования в формате a32.
        key (list[int]): Ключ шифрования в формате a32.

    Returns:
        tuple[int]: Зашифрованный ключ в формате a32.

    Raises:
        Не вызывает исключений.

    Example:
        >>> a = [1, 2, 3, 4, 5, 6, 7, 8]
        >>> key = [9, 10, 11, 12]
        >>> encrypted_key = encrypt_key(a, key)
        >>> print(encrypted_key)
        (3278992105, 4000631848)
    """
```

**Как работает функция**:
1. Функция шифрует части входного ключа `a` размером 4 элемента с использованием AES-CBC с ключом `key`.
2. Функция объединяет зашифрованные части в один кортеж и возвращает его.

### `decrypt_key`

```python
def decrypt_key(a, key):
    """
    Дешифрует ключ.

    Args:
        a (list[int]): Ключ для дешифрования в формате a32.
        key (list[int]): Ключ дешифрования в формате a32.

    Returns:
        tuple[int]: Дешифрованный ключ в формате a32.

    Raises:
        Не вызывает исключений.

    Example:
        >>> a = [3278992105, 4000631848]
        >>> key = [9, 10, 11, 12]
        >>> decrypted_key = decrypt_key(a, key)
        >>> print(decrypted_key)
        (1, 2, 3, 4, 5, 6, 7, 8)
    """
```

**Как работает функция**:
1. Функция дешифрует части входного ключа `a` размером 4 элемента с использованием AES-CBC с ключом `key`.
2. Функция объединяет дешифрованные части в один кортеж и возвращает его.

### `enc_attr`

```python
def enc_attr(attr, key):
    """
    Шифрует атрибуты с использованием AES-CBC.

    Args:
        attr (dict): Атрибуты для шифрования.
        key (list[int]): Ключ шифрования в формате a32.

    Returns:
        bytes: Зашифрованные атрибуты.

    Raises:
        Не вызывает исключений.

    Example:
        >>> attr = {'name': 'example', 'size': 1024}
        >>> key = [1, 2, 3, 4]
        >>> encrypted_attr = enc_attr(attr, key)
        >>> print(encrypted_attr)
        b'MEGA{"name": "example", "size": 1024}\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b'
    """
```

**Как работает функция**:
1. Функция преобразует входные атрибуты в JSON-строку и добавляет префикс 'MEGA'.
2. Функция дополняет строку нулями до кратной 16 байтам.
3. Функция шифрует полученную строку с использованием AES-CBC с предоставленным ключом.

### `dec_attr`

```python
def dec_attr(attr, key):
    """
    Дешифрует атрибуты, зашифрованные с использованием AES-CBC.

    Args:
        attr (bytes): Зашифрованные атрибуты.
        key (list[int]): Ключ дешифрования в формате a32.

    Returns:
        dict: Дешифрованные атрибуты.

    Raises:
        Не вызывает исключений.

    Example:
        >>> attr = b'MEGA{"name": "example", "size": 1024}\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b\\x0b'
        >>> key = [1, 2, 3, 4]
        >>> decrypted_attr = dec_attr(attr, key)
        >>> print(decrypted_attr)
        {'name': 'example', 'size': 1024}
    """
```

**Как работает функция**:
1. Функция дешифрует входные данные с использованием AES-CBC с предоставленным ключом.
2. Функция удаляет завершающие нули и префикс 'MEGA'.
3. Функция преобразует полученную строку JSON в словарь и возвращает его.