# Модуль `minibot`

## Обзор

Модуль `minibot` предназначен для обработки запросов на создание прайс-листов для Казаринова через Telegram-бота. Он включает в себя обработку текстовых и голосовых сообщений, URL-адресов, а также взаимодействие с AI-моделью Google Gemini для генерации ответов.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для автоматизации процесса создания прайс-листов. Он использует Telegram Bot API для взаимодействия с пользователем, а также интеграцию с Google Gemini для обработки текстовых запросов. Основная задача модуля - предоставить удобный интерфейс для получения необходимой информации и генерации прайс-листов на основе предоставленных данных.

## Классы

### `Config`

**Описание**: Класс `Config` содержит настройки для бота, такие как токен, идентификатор канала, пути к файлам и сообщения.

**Принцип работы**:
Класс `Config` определяет параметры работы бота в зависимости от режима работы (`PRODUCTION` или `DEV`). В зависимости от режима выбирается токен бота из переменных окружения или из `gs.credentials.telegram`.

**Атрибуты**:

-   `ENDPOINT` (str): Конечная точка (endpoint) для данного модуля, значение `'kazarinov'`.
-   `MODE` (str): Режим работы бота (`'PRODUCTION'` или `'DEV'`). Определяет, какой токен будет использоваться.
-   `BOT_TOKEN` (str): Токен Telegram-бота, полученный из переменных окружения или `gs.credentials.telegram`.
-   `CHANNEL_ID` (str): Идентификатор канала Telegram для отправки сообщений.
-   `PHOTO_DIR` (Path): Путь к директории с фотографиями, используемыми ботом.
-   `COMMAND_INFO` (str): Информация о боте, отображаемая по команде `/info`.
-   `UNKNOWN_COMMAND_MESSAGE` (str): Сообщение, отправляемое в ответ на неизвестную команду.
-   `START_MESSAGE` (str): Сообщение, отправляемое при старте бота.
-   `HELP_MESSAGE` (str): Справочное сообщение, отображаемое по команде `/help`.

### `BotHandler`

**Описание**: Класс `BotHandler` обрабатывает команды, полученные от Telegram-бота.

**Принцип работы**:
Класс `BotHandler` инициализируется списком вопросов и AI-моделью Google Gemini. Он обрабатывает текстовые сообщения, URL-адреса, команды и голосовые сообщения, взаимодействуя с пользователем и AI-моделью для предоставления ответов и выполнения задач.

**Атрибуты**:

-   `base_dir` (Path): Базовая директория для модуля, содержащая путь к ресурсам.
-   `questions_list` (List[str]): Список вопросов, используемых для взаимодействия с пользователем.
-   `model` (GoogleGenerativeAI): Инстанс AI-модели Google Gemini для обработки текстовых запросов.

**Методы**:

-   `__init__`: Инициализация обработчика событий телеграм-бота.
-   `handle_message`: Обработка текстовых сообщений.
-   `_send_user_flowchart`: Отправка схемы user_flowchart.
-   `_handle_url`: Обработка URL, присланного пользователем.
-   `_handle_next_command`: Обработка команды `--next` и её аналогов.
-   `help_command`: Обработка команды `/help`.
-   `send_pdf`: Обработка команды `/sendpdf` для отправки PDF.
-   `handle_voice`: Обработка голосовых сообщений.
-   `_transcribe_voice`: Транскрибирование голосового сообщения (заглушка).
-   `handle_document`: Обработка полученных документов.

## Функции

### `main`

```python
def main(restarts: int = 5) -> None:
    """Запуск и перезапуск Telegram-бота.

    Args:
        restarts (int, optional): Количество попыток перезапуска бота в случае ошибки. Defaults to 5.

    Raises:
        Exception: Если происходит ошибка во время работы бота и превышено количество попыток перезапуска.

    Как работает функция:
     1.  Запускается Telegram-бот в режиме опроса (polling).
     2.  В случае возникновения ошибки, логируется информация об ошибке.
     3.  Бот останавливается.
     4.  Если количество попыток перезапуска больше 1, то происходит ожидание в течение 10 секунд и повторный запуск бота.
     5.  Если количество попыток перезапуска исчерпано, то логируется информация о превышении количества переподключений.

     ASCII flowchart:

     Запуск бота
     │
     ├───> Бот работает (polling)
     │     │
     │     └───> Произошла ошибка?
     │           │
     │           ├───> Да
     │           │     │
     │           │     └───> Логирование ошибки
     │           │     │
     │           │     └───> Остановка бота
     │           │     │
     │           │     └───> Попытки перезапуска > 0?
     │           │           │
     │           │           ├───> Да
     │           │           │     │
     │           │           │     └───> Ожидание 10 секунд
     │           │           │     │
     │           │           │     └───> Повторный запуск main()
     │           │           │
     │           │           └───> Нет
     │           │                 │
     │           │                 └───> Логирование превышения попыток
     │           │
     │           └───> Нет
     │                 │
     │                 └───> Бот продолжает работу
     │
     └───> Конец

    Примеры:
        >>> main(restarts=3)  # Запуск бота с 3 попытками перезапуска
    """
```

### `command_start`

```python
@bot.message_handler(commands=['start'])
def command_start(message: telebot.types.Message) -> None:
    """Обработка команды /start.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Как работает функция:
        1. Логирует информацию об отправке команды `/start` пользователем.
        2. Отправляет приветственное сообщение пользователю.

    ASCII flowchart:
    Пользователь -> /start -> Логирование -> Отправка приветственного сообщения -> Конец

    Примеры:
        Пользователь отправляет команду /start боту.
    """
```

### `command_help`

```python
@bot.message_handler(commands=['help'])
def command_help(message: telebot.types.Message) -> None:
    """Обработка команды /help.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Как работает функция:
        1. Логирует информацию об отправке команды `/help` пользователем.
        2. Вызывает метод `help_command` у объекта `handler` для отправки справочного сообщения пользователю.

    ASCII flowchart:
    Пользователь -> /help -> Логирование -> handler.help_command -> Отправка справочного сообщения -> Конец

    Примеры:
        Пользователь отправляет команду /help боту.
    """
```

### `command_info`

```python
@bot.message_handler(commands=['info'])
def command_info(message: telebot.types.Message) -> None:
    """Обработка команды /info.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Как работает функция:
        1. Логирует информацию об отправке команды `/info` пользователем.
        2. Отправляет информационное сообщение о боте пользователю.

    ASCII flowchart:
    Пользователь -> /info -> Логирование -> Отправка информационного сообщения -> Конец

    Примеры:
        Пользователь отправляет команду /info боту.
    """
```

### `command_time`

```python
@bot.message_handler(commands=['time'])
def command_time(message: telebot.types.Message) -> None:
    """Обработка команды /time.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Как работает функция:
        1. Логирует информацию об отправке команды `/time` пользователем.
        2. Получает текущее время.
        3. Форматирует текущее время в строку.
        4. Отправляет текущее время пользователю.

    ASCII flowchart:
    Пользователь -> /time -> Логирование -> Получение текущего времени -> Форматирование времени -> Отправка времени -> Конец

    Примеры:
        Пользователь отправляет команду /time боту.
    """
```

### `command_photo`

```python
@bot.message_handler(commands=['photo'])
def command_photo(message: telebot.types.Message) -> None:
    """Обработка команды /photo.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Как работает функция:
        1. Логирует информацию об отправке команды `/photo` пользователем.
        2. Пытается отправить случайную фотографию из директории `config.PHOTO_DIR`.
        3. Если директория не найдена или в ней нет фотографий, отправляет соответствующее сообщение об ошибке.

    ASCII flowchart:
    Пользователь -> /photo -> Логирование -> Получение списка файлов в директории -> Выбор случайной фотографии -> Отправка фотографии -> Конец

    Примеры:
        Пользователь отправляет команду /photo боту.
    """
```

### `handle_voice_message`

```python
@bot.message_handler(content_types=['voice'])
def handle_voice_message(message: telebot.types.Message) -> None:
    """Обработка голосовых сообщений.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Как работает функция:
        1. Логирует информацию об отправке голосового сообщения пользователем.
        2. Вызывает метод `handle_voice` у объекта `handler` для обработки голосового сообщения.

    ASCII flowchart:
    Пользователь -> Голосовое сообщение -> Логирование -> handler.handle_voice -> Обработка голосового сообщения -> Конец

    Примеры:
        Пользователь отправляет голосовое сообщение боту.
    """
```

### `handle_document_message`

```python
@bot.message_handler(content_types=['document'])
def handle_document_message(message: telebot.types.Message) -> None:
    """Обработка сообщений с документами.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Как работает функция:
        1. Логирует информацию об отправке документа пользователем.
        2. Вызывает метод `handle_document` у объекта `handler` для обработки документа.

    ASCII flowchart:
    Пользователь -> Документ -> Логирование -> handler.handle_document -> Обработка документа -> Конец

    Примеры:
        Пользователь отправляет документ боту.
    """
```

### `handle_text_message`

```python
@bot.message_handler(func=lambda message: message.text and not message.text.startswith('/'))
def handle_text_message(message: telebot.types.Message) -> None:
    """Обработка текстовых сообщений, не являющихся командами.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Как работает функция:
        1. Логирует информацию об отправке текстового сообщения пользователем.
        2. Вызывает метод `handle_message` у объекта `handler` для обработки текстового сообщения.

    ASCII flowchart:
    Пользователь -> Текст -> Логирование -> handler.handle_message -> Обработка текстового сообщения -> Конец

    Примеры:
        Пользователь отправляет текстовое сообщение боту.
    """
```

### `handle_unknown_command`

```python
@bot.message_handler(func=lambda message: message.text and message.text.startswith('/'))
def handle_unknown_command(message: telebot.types.Message) -> None:
    """Обработка неизвестных команд.

    Args:
        message (telebot.types.Message): Объект сообщения от Telegram.

    Как работает функция:
        1. Логирует информацию об отправке неизвестной команды пользователем.
        2. Отправляет сообщение о неизвестной команде пользователю.

    ASCII flowchart:
    Пользователь -> Неизвестная команда -> Логирование -> Отправка сообщения о неизвестной команде -> Конец

    Примеры:
        Пользователь отправляет неизвестную команду боту.
    """