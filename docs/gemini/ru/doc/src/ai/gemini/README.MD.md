# Google Generative AI Integration Module

## Обзор

Модуль `GoogleGenerativeAI` предназначен для облегчения взаимодействия с генеративными моделями Google AI. Этот класс предоставляет методы для отправки запросов, обработки ответов, управления диалогами и интеграции с различными функциями AI. Он включает в себя надежную обработку ошибок, ведение журнала и параметры конфигурации для обеспечения бесперебойной работы.

## Содержание

- [Обзор](#обзор)
- [Основные функции](#основные-функции)
  - [`__init__`](#__init__)
  - [`config`](#config)
  - [`_start_chat`](#_start_chat)
  - [`_save_dialogue`](#_save_dialogue)
  - [`ask`](#ask)
  - [`chat`](#chat)
  - [`describe_image`](#describe_image)
  - [`upload_file`](#upload_file)
- [Обработка ошибок](#обработка-ошибок)
- [Логирование и история](#логирование-и-история)
- [Зависимости](#зависимости)
- [Пример использования](#пример-использования)

## Основные функции

### `__init__`

**Описание**: Инициализирует класс `GoogleGenerativeAI` с необходимыми конфигурациями.

**Параметры**:
- `api_key` (str): Ключ API для доступа к Google Generative AI.
- `model_name` (Optional[str], optional): Название используемой модели. По умолчанию `None`.
- `generation_config` (Optional[Dict], optional): Конфигурация генерации. По умолчанию `None`.
- `system_instruction` (Optional[str], optional): Системная инструкция для модели. По умолчанию `None`.
- `**kwargs`: Дополнительные именованные аргументы.

**Детали**:
- Устанавливает ключ API, название модели, конфигурацию генерации и системную инструкцию.
- Определяет пути для логирования диалогов и хранения истории.
- Инициализирует модель Google Generative AI.

### `config`

**Описание**: Извлекает конфигурацию из файла настроек.

**Возвращает**:
- `dict`: Конфигурация из файла `generative_ai.json`.

**Детали**:
- Читает и анализирует файл конфигурации, расположенный по пути `gs.path.src / 'ai' / 'gemini' / 'generative_ai.json'`.

### `_start_chat`

**Описание**: Запускает сессию чата с моделью AI.

**Детали**:
- Инициализирует сессию чата с пустой историей.

### `_save_dialogue`

**Описание**: Сохраняет диалог в текстовый и JSON-файлы.

**Параметры**:
- `dialogue` (list): Список сообщений диалога.

**Детали**:
- Добавляет каждое сообщение в диалоге в текстовый файл.
- Добавляет каждое сообщение в формате JSON в JSON-файл.

### `ask`

**Описание**: Отправляет текстовый запрос модели AI и получает ответ.

**Параметры**:
- `q` (str): Текстовый запрос.
- `attempts` (int, optional): Максимальное количество попыток. По умолчанию 15.

**Возвращает**:
- `Optional[str]`: Ответ модели или `None` в случае ошибки.

**Детали**:
- Обрабатывает несколько попыток в случае сетевых ошибок или недоступности сервиса.
- Логирует ошибки и повторяет попытки с экспоненциальной задержкой.
- Сохраняет диалог в файлы истории.

### `chat`

**Описание**: Отправляет сообщение в чат модели AI и получает ответ.

**Параметры**:
- `q` (str): Сообщение чата.

**Возвращает**:
- `str`: Ответ модели.

**Детали**:
- Использует сессию чата, инициализированную с помощью `_start_chat`.
- Логирует ошибки и возвращает текст ответа.

### `describe_image`

**Описание**: Генерирует текстовое описание изображения.

**Параметры**:
- `image_path` (Path): Путь к изображению.

**Возвращает**:
- `Optional[str]`: Текстовое описание изображения или `None` в случае ошибки.

**Детали**:
- Кодирует изображение в base64 и отправляет его модели AI.
- Возвращает сгенерированное описание или логирует ошибку, если операция не удалась.

### `upload_file`

**Описание**: Загружает файл в модель AI.

**Параметры**:
- `file` (str | Path | IOBase): Путь к файлу или объект файла.
- `file_name` (Optional[str], optional): Имя файла. По умолчанию `None`.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в противном случае.

**Детали**:
- Обрабатывает загрузку файла и логирует успех или неудачу.
- Обеспечивает логику повторных попыток в случае ошибок.

## Обработка ошибок

Класс включает в себя комплексную обработку ошибок для различных сценариев:

- **Сетевые ошибки**: Повторные попытки с экспоненциальной задержкой.
- **Недоступность сервиса**: Логирование ошибок и повторные попытки.
- **Ограничения квоты**: Логирование и ожидание перед повторной попыткой.
- **Ошибки аутентификации**: Логирование и остановка дальнейших попыток.
- **Неверный ввод**: Логирование и повторные попытки с таймаутом.
- **Ошибки API**: Логирование и остановка дальнейших попыток.

## Логирование и история

Все взаимодействия с моделями AI логируются, а диалоги сохраняются в текстовом и JSON форматах для будущего анализа. Это гарантирует, что все операции отслеживаемы и могут быть просмотрены для отладки или аудита.

## Зависимости

- `google.generativeai`
- `requests`
- `grpc`
- `google.api_core.exceptions`
- `google.auth.exceptions`
- `src.logger`
- `src.utils.printer`
- `src.utils.file`
- `src.utils.date_time`
- `src.utils.convertors.unicode`
- `src.utils.jjson`

## Пример использования

```python
ai = GoogleGenerativeAI(api_key="your_api_key", system_instruction="Instruction")
response = ai.ask("Как дела?")
print(response)
```

Этот пример инициализирует класс `GoogleGenerativeAI` и отправляет запрос модели AI, выводя ответ.

---

Для получения более подробной информации обратитесь к исходному коду и комментариям в классе `GoogleGenerativeAI`.