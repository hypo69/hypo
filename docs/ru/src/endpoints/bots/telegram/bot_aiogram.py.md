# Модуль для работы с Telegram ботом через FastAPI и RPC
====================================================

Модуль содержит класс `TelegramBot`, который обеспечивает интеграцию Telegram бота с FastAPI сервером через RPC.

## Обзор

Данный модуль предоставляет функциональность для создания и управления Telegram ботом, включая регистрацию обработчиков, настройку вебхуков и взаимодействие с сервером FastAPI через RPC.

## Подробней

Этот модуль является ключевым компонентом для реализации Telegram бота, управляемого через FastAPI сервер. Он использует библиотеку `aiogram` для работы с Telegram API и `xmlrpc.client` для взаимодействия с RPC сервером. Модуль также включает поддержку для обработки различных типов сообщений, включая текст, голос и документы.

## Классы

### `TelegramBot`

**Описание**: Класс для управления Telegram ботом.

**Принцип работы**:
Класс `TelegramBot` инициализирует бота с использованием токена, настраивает диспетчер `aiogram`, регистрирует обработчики сообщений и управляет вебхуками для приема обновлений от Telegram. Он также отвечает за установление соединения с RPC сервером для выполнения задач на стороне сервера.

**Аттрибуты**:
- `token` (str): Токен Telegram бота.
- `port` (int): Порт для вебхука.
- `route` (str): Маршрут для вебхука FastAPI. По умолчанию `/telegram_webhook`.
- `config` (SimpleNamespace): Конфигурация бота, загруженная из JSON файла.
- `bot` (Bot): Экземпляр бота aiogram.
- `dp` (Dispatcher): Диспетчер aiogram для обработки обновлений.
- `bot_handler` (BotHandler): Экземпляр обработчика бота для логики обработки сообщений.
- `app` (Optional[web.Application]): Веб-приложение aiohttp для обработки вебхуков.
- `rpc_client` (Optional[ServerProxy]): Клиент RPC для взаимодействия с сервером.

**Методы**:
- `__init__`: Инициализирует экземпляр класса `TelegramBot`.
- `run`: Запускает бота, инициализирует RPC и вебхук.
- `_register_default_handlers`: Регистрирует обработчики по умолчанию.
- `_handle_message`: Обрабатывает текстовые сообщения.
- `initialize_bot_webhook`: Инициализирует вебхук бота.
- `_register_route_via_rpc`: Регистрирует маршрут вебхука Telegram через RPC.
- `stop`: Останавливает бота и удаляет вебхук.

## Функции

### `__init__`

```python
 def __init__(self, token: str, route: str = 'telegram_webhook'):
        """
        Initialize the TelegramBot instance.

        Args:
            token (str): Telegram bot token.
            route (str): Webhook route for FastAPI. Defaults to '/telegram_webhook'.
        """
```

**Назначение**: Инициализирует экземпляр класса `TelegramBot`.

**Параметры**:
- `token` (str): Токен Telegram бота.
- `route` (str): Маршрут для вебхука FastAPI. По умолчанию `telegram_webhook`.

**Как работает функция**:

1.  **Инициализация атрибутов**: Функция инициализирует атрибуты экземпляра класса `TelegramBot`, такие как токен бота, порт, маршрут вебхука и загружает конфигурацию из JSON файла.
2.  **Создание экземпляров `Bot` и `Dispatcher`**: Создаются экземпляры `Bot` и `Dispatcher` из библиотеки `aiogram`, которые используются для взаимодействия с Telegram API и обработки входящих обновлений.
3.  **Регистрация обработчиков**: Вызывается метод `_register_default_handlers` для регистрации обработчиков сообщений по умолчанию.

**Примеры**:

```python
bot = TelegramBot(token='YOUR_TELEGRAM_BOT_TOKEN', route='/custom_webhook')
```

### `run`

```python
    def run(self):
        """Run the bot and initialize RPC and webhook."""
```

**Назначение**: Запускает бота, инициализирует RPC и вебхук.

**Как работает функция**:

1.  **Инициализация RPC клиента**: Пытается установить соединение с RPC сервером, используя параметры хоста и порта из конфигурации.
2.  **Запуск RPC сервера**: Вызывает RPC метод `start_server` для запуска сервера на указанном порту и хосте.
3.  **Регистрация маршрута через RPC**: Регистрирует маршрут вебхука Telegram через RPC, вызывая метод `_register_route_via_rpc`.
4.  **Инициализация вебхука Telegram**: Вызывает метод `initialize_bot_webhook` для установки вебхука Telegram и получения URL вебхука.
5.  **Запуск веб-приложения**: Если URL вебхука успешно получен, запускает веб-приложение `aiohttp` для обработки входящих запросов вебхука.
6.  **Запуск опроса (polling)**: Если не удалось установить вебхук, запускает режим опроса (polling) для получения обновлений от Telegram.
7.  **Обработка исключений**: В случае возникновения ошибок при инициализации RPC, установке вебхука или запуске приложения, регистрирует ошибки с использованием `logger.error` и завершает работу программы.

```
Инициализация RPC клиента --> Запуск RPC сервера --> Регистрация маршрута через RPC
    |
    V
Инициализация вебхука Telegram --> Запуск веб-приложения
    |
    V
Запуск режима опроса (polling)
```

**Примеры**:

```python
bot = TelegramBot(token='YOUR_TELEGRAM_BOT_TOKEN')
bot.run()
```

### `_register_default_handlers`

```python
    def _register_default_handlers(self):
        """Register the default handlers using the BotHandler instance."""
```

**Назначение**: Регистрирует обработчики по умолчанию, используя экземпляр `BotHandler`.

**Как работает функция**:

1.  **Регистрация обработчиков сообщений**: Функция регистрирует различные обработчики сообщений с использованием метода `dp.message.register` из библиотеки `aiogram`. Каждый обработчик связывается с определенной командой или условием, и при получении соответствующего сообщения вызывается соответствующая функция-обработчик.
    *   `self.bot_handler.start`: Обработчик команды `/start`.
    *   `self.bot_handler.help_command`: Обработчик команды `/help`.
    *   `self.bot_handler.send_pdf`: Обработчик команды `/sendpdf`.
    *   `self._handle_message`: Обработчик для любых текстовых сообщений.
    *   `self.bot_handler.handle_voice`: Обработчик голосовых сообщений.
    *   `self.bot_handler.handle_document`: Обработчик документов.
    *   `self.bot_handler.handle_log`: Обработчик текстовых сообщений для обработки логов.

**Примеры**:

```python
bot = TelegramBot(token='YOUR_TELEGRAM_BOT_TOKEN')
bot._register_default_handlers()
```

### `_handle_message`

```python
    async def _handle_message(self, message: types.Message):
        """Handle any text message."""
```

**Назначение**: Обрабатывает любое текстовое сообщение.

**Параметры**:
- `message` (types.Message): Объект сообщения `aiogram`.

**Как работает функция**:

1.  **Вызов обработчика сообщений**: Функция вызывает метод `handle_message` из экземпляра `BotHandler` для обработки текстового сообщения.

**Примеры**:

```python
bot = TelegramBot(token='YOUR_TELEGRAM_BOT_TOKEN')
asyncio.run(bot._handle_message(message))
```

### `initialize_bot_webhook`

```python
    def initialize_bot_webhook(self, route: str):
        """Initialize the bot webhook."""
```

**Назначение**: Инициализирует вебхук бота.

**Параметры**:
- `route` (str): Маршрут для вебхука.

**Как работает функция**:

1.  **Формирование URL вебхука**: Функция формирует URL вебхука на основе предоставленного маршрута и хоста. Если хост указывает на локальную машину (`127.0.0.1` или `localhost`), используется `ngrok` для создания публичного URL.
2.  **Установка вебхука**: Пытается установить вебхук для бота с использованием сформированного URL.
3.  **Обработка исключений**: В случае возникновения ошибок при установке вебхука, регистрирует ошибку с использованием `logger.error` и возвращает `False`.

```
Формирование URL вебхука --> Установка вебхука
    |
    V
Обработка исключений
```

**Примеры**:

```python
bot = TelegramBot(token='YOUR_TELEGRAM_BOT_TOKEN')
webhook_url = bot.initialize_bot_webhook(route='/telegram_webhook')
```

### `_register_route_via_rpc`

```python
    def _register_route_via_rpc(self, rpc_client: ServerProxy):
        """Register the Telegram webhook route via RPC."""
```

**Назначение**: Регистрирует маршрут вебхука Telegram через RPC.

**Параметры**:
- `rpc_client` (ServerProxy): Клиент RPC для взаимодействия с сервером.

**Как работает функция**:

1.  **Регистрация маршрута**: Функция вызывает RPC метод `add_new_route` для регистрации маршрута вебхука Telegram на сервере.
2.  **Обработка исключений**: В случае возникновения ошибок при регистрации маршрута, регистрирует ошибку с использованием `logger.error`.

**Примеры**:

```python
bot = TelegramBot(token='YOUR_TELEGRAM_BOT_TOKEN')
bot._register_route_via_rpc(rpc_client)
```

### `stop`

```python
    def stop(self):
         """Stop the bot and delete the webhook."""
```

**Назначение**: Останавливает бота и удаляет вебхук.

**Как работает функция**:

1.  **Остановка веб-приложения**: Если веб-приложение `aiohttp` запущено, останавливает его и выполняет очистку ресурсов.
2.  **Удаление вебхука**: Пытается удалить вебхук бота с использованием метода `bot.delete_webhook`.
3.  **Обработка исключений**: В случае возникновения ошибок при удалении вебхука, регистрирует ошибку с использованием `logger.error`.

```
Остановка веб-приложения --> Удаление вебхука
    |
    V
Обработка исключений
```

**Примеры**:

```python
bot = TelegramBot(token='YOUR_TELEGRAM_BOT_TOKEN')
bot.stop()