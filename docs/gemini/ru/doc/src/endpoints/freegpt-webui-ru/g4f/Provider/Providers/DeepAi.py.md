# Модуль DeepAi

## Обзор

Модуль `DeepAi.py` предоставляет интерфейс для взаимодействия с сервисом DeepAI, в частности, с моделью `gpt-3.5-turbo`. Он включает в себя функции для создания запросов к API DeepAI и обработки ответов. Модуль поддерживает потоковую передачу данных и не требует аутентификации.

## Подробней

Этот модуль предназначен для интеграции с DeepAI для генерации текста на основе предоставленных сообщений. Он использует requests для отправки POST-запросов к API DeepAI и обрабатывает потоковые ответы. Ключевой особенностью является динамическое создание API-ключа на основе user-agent, что позволяет обходить ограничения аутентификации.

## Функции

### `_create_completion`

```python
def _create_completion(model: str, messages: list, stream: bool, **kwargs):
    """
    Создает запрос к API DeepAI и возвращает ответ.

    Args:
        model (str): Название модели для использования.
        messages (list): Список сообщений для отправки.
        stream (bool): Флаг, указывающий на необходимость потоковой передачи данных.
        **kwargs: Дополнительные аргументы.

    Returns:
        Generator[str, None, None]: Генератор строк, представляющих собой чанки ответа от API.

    Raises:
        requests.exceptions.HTTPError: Если возникает HTTP ошибка при запросе к API.

    """
    ...
```

**Назначение**: Функция `_create_completion` отвечает за отправку запроса к API DeepAI и получение ответа. Она генерирует API-ключ, формирует заголовки и данные для запроса, а затем отправляет POST-запрос к API.

**Параметры**:
- `model` (str): Указывает, какую модель использовать для генерации текста. В данном случае, ожидается `'gpt-3.5-turbo'`.
- `messages` (list): Список сообщений, которые передаются модели для генерации ответа. Обычно это история разговора.
- `stream` (bool): Определяет, будет ли ответ получен в потоковом режиме. Если `True`, ответ будет возвращаться частями, что полезно для больших объемов данных.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API запрос.

**Возвращает**:
- `Generator[str, None, None]`: Генератор, который выдает чанки текста по мере их получения от API DeepAI.

**Вызывает исключения**:
- `requests.exceptions.HTTPError`: Вызывается, если HTTP запрос завершается с ошибкой (например, код состояния 400 или 500).

**Как работает функция**:

1.  **Определение внутренних функций**:
    -   Определяются вспомогательные функции `md5` для вычисления MD5-хеша и `get_api_key` для генерации API-ключа.
2.  **Генерация API-ключа**:
    -   Используется `get_api_key` для создания API-ключа на основе User-Agent.
3.  **Формирование заголовков**:
    -   Создаются заголовки запроса, включающие API-ключ и User-Agent.
4.  **Формирование данных запроса**:
    -   Создается словарь `files`, содержащий стиль чата и историю сообщений в формате JSON.
5.  **Отправка POST-запроса**:
    -   Используется библиотека `requests` для отправки POST-запроса к API DeepAI.
6.  **Обработка потокового ответа**:
    -   Функция итерирует по содержимому ответа, декодирует каждый чанк и выдает его через генератор.
7.  **Обработка ошибок**:
    -   Проверяется статус ответа и вызывается исключение `HTTPError` в случае ошибки.

**Внутренние функции**:

### `md5`

```python
def md5(text: str) -> str:
    """
    Вычисляет MD5-хеш строки.

    Args:
        text (str): Строка для вычисления хеша.

    Returns:
        str: MD5-хеш строки.
    """
    ...
```

**Назначение**: Функция `md5` вычисляет MD5-хеш переданной строки и возвращает его в виде строки.

**Параметры**:
- `text` (str): Строка, для которой необходимо вычислить MD5-хеш.

**Возвращает**:
- `str`: MD5-хеш строки в шестнадцатеричном формате.

**Как работает функция**:
1. Кодирует входную строку `text` в байты, используя кодировку UTF-8.
2. Вычисляет MD5-хеш полученных байтов.
3. Преобразует хеш в строку шестнадцатеричных цифр.
4. Инвертирует строку (меняет порядок символов на обратный).

### `get_api_key`

```python
def get_api_key(user_agent: str) -> str:
    """
    Генерирует API-ключ на основе User-Agent.

    Args:
        user_agent (str): Строка User-Agent.

    Returns:
        str: Сгенерированный API-ключ.
    """
    ...
```

**Назначение**: Функция `get_api_key` генерирует API-ключ на основе User-Agent.

**Параметры**:
- `user_agent` (str): Строка User-Agent, используемая для генерации ключа.

**Возвращает**:
- `str`: Сгенерированный API-ключ.

**Как работает функция**:
1. Генерирует случайное число `part1` в диапазоне от 0 до 10^11.
2. Вычисляет MD5-хеш строки, составленной из User-Agent и нескольких MD5-хешей User-Agent и `part1`.
3. Формирует API-ключ в формате `"tryit-{part1}-{part2}"`, где `part2` - вычисленный MD5-хеш.

**ASCII Flowchart для `_create_completion`**:

```
A [Начало]
|
B [Определение md5 и get_api_key]
|
C [Получение User-Agent]
|
D [Генерация API-ключа]
|
E [Формирование заголовков]
|
F [Формирование данных запроса]
|
G [Отправка POST-запроса к API DeepAI]
|
H [Обработка потокового ответа]
|
I [Конец]
```

**Примеры**:

```python
messages = [{"role": "user", "content": "Hello, how are you?"}]
for chunk in _create_completion(model='gpt-3.5-turbo', messages=messages, stream=True):
    print(chunk, end="")
```

## Переменные

### `url`

```python
url = 'https://deepai.org'
```

URL адрес сервиса DeepAI.

### `model`

```python
model = ['gpt-3.5-turbo']
```

Список поддерживаемых моделей.

### `supports_stream`

```python
supports_stream = True
```

Указывает, поддерживает ли провайдер потоковую передачу данных.

### `needs_auth`

```python
needs_auth = False
```

Указывает, требуется ли аутентификация для доступа к API.

### `params`

```python
params = f'g4f.Providers.{os.path.basename(__file__)[:-3]} supports: ' + \
    ' (%s)' % ', '.join(
        [f"{name}: {get_type_hints(_create_completion)[name].__name__}" for name in _create_completion.__code__.co_varnames[:_create_completion.__code__.co_argcount]])
```

Строка, содержащая информацию о поддерживаемых типах данных для функции `_create_completion`.