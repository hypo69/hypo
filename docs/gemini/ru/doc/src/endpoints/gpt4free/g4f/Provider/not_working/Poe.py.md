# Модуль `Poe.py`

## Обзор

Модуль `Poe.py` предназначен для взаимодействия с платформой Poe (poe.com) для генерации текста с использованием различных AI-моделей. Он предоставляет класс `Poe`, который является наследником абстрактного класса `AbstractProvider` и реализует метод `create_completion` для создания запросов к моделям Poe.

## Подробнее

Этот модуль позволяет использовать различные модели, такие как Llama-2, CodeLlama, GPT-3.5 и GPT-4, доступные на платформе Poe. Он использует Selenium WebDriver для автоматизации взаимодействия с веб-интерфейсом Poe, включая ввод запросов и получение ответов.

## Классы

### `Poe`

**Описание**: Класс `Poe` предоставляет интерфейс для взаимодействия с платформой Poe.

**Наследует**:

- `AbstractProvider`: Абстрактный класс, определяющий общие методы для взаимодействия с провайдерами AI-моделей.

**Атрибуты**:

- `url` (str): URL платформы Poe (`"https://poe.com"`).
- `working` (bool): Указывает, работает ли провайдер (по умолчанию `False`).
- `needs_auth` (bool): Указывает, требуется ли аутентификация для работы с провайдером (по умолчанию `True`).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных (по умолчанию `True`).
- `models` (dict): Словарь, содержащий доступные модели и их имена.

**Методы**:

- `create_completion`: Создает запрос к модели Poe и возвращает результат.

## Функции

### `create_completion`

```python
@classmethod
def create_completion(
    cls,
    model: str,
    messages: Messages,
    stream: bool,
    proxy: str = None,
    webdriver: WebDriver = None,
    user_data_dir: str = None,
    headless: bool = True,
    **kwargs
) -> CreateResult:
    """Создает запрос к модели Poe и возвращает результат.

    Args:
        cls (type): Класс, к которому принадлежит метод.
        model (str): Имя модели для использования.
        messages (Messages): Список сообщений для отправки модели.
        stream (bool): Указывает, использовать ли потоковую передачу данных.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        webdriver (WebDriver, optional): Экземпляр WebDriver для управления браузером. По умолчанию `None`.
        user_data_dir (str, optional): Путь к каталогу пользовательских данных браузера. По умолчанию `None`.
        headless (bool, optional): Указывает, запускать ли браузер в headless-режиме. По умолчанию `True`.
        **kwargs: Дополнительные аргументы.

    Returns:
        CreateResult: Результат запроса к модели.

    Raises:
        ValueError: Если указанная модель не поддерживается.
        RuntimeError: Если не удается найти текстовое поле для ввода запроса.
    """
```

**Назначение**: Создает запрос к указанной модели на платформе Poe и возвращает результат в потоковом режиме, используя Selenium WebDriver для взаимодействия с веб-интерфейсом.

**Параметры**:

- `cls` (type): Класс, к которому принадлежит метод.
- `model` (str): Имя модели для использования. Если не указано, используется `"gpt-3.5-turbo"`.
- `messages` (Messages): Список сообщений для отправки модели.
- `stream` (bool): Указывает, использовать ли потоковую передачу данных.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `webdriver` (WebDriver, optional): Экземпляр WebDriver для управления браузером. По умолчанию `None`.
- `user_data_dir` (str, optional): Путь к каталогу пользовательских данных браузера. Используется для сохранения состояния сессии. По умолчанию `None`.
- `headless` (bool, optional): Указывает, запускать ли браузер в headless-режиме (без графического интерфейса). По умолчанию `True`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:

- `CreateResult`: Результат запроса к модели. В данном случае, генератор, выдающий части ответа модели.

**Вызывает исключения**:

- `ValueError`: Если указанная модель не поддерживается.
- `RuntimeError`: Если не удается найти текстовое поле для ввода запроса на странице Poe. Это может указывать на проблемы с аутентификацией или изменением структуры страницы.

**Как работает функция**:

1. **Проверка и выбор модели**:
   - Если `model` не указана, используется модель `"gpt-3.5-turbo"`.
   - Проверяется, поддерживается ли указанная модель. Если нет, вызывается исключение `ValueError`.
2. **Форматирование запроса**:
   - Форматирует список сообщений `messages` в строку запроса `prompt`.
3. **Создание и управление сессией WebDriver**:
   - Создается экземпляр класса `WebDriverSession` для управления сессией браузера. Этот класс обеспечивает открытие, закрытие и переоткрытие браузера при необходимости.
   - Используется конструкция `with session as driver:` для автоматического управления ресурсами сессии.
4. **Инициализация перехвата WebSocket**:
   - Внедряет JavaScript-код в браузер для перехвата сообщений WebSocket, чтобы получить ответы от Poe.
   - Этот код создает прокси-класс `ProxiedWebSocket`, который перехватывает сообщения, анализирует JSON и извлекает текст ответа модели.
5. **Навигация и ожидание загрузки страницы**:
   - Открывает страницу Poe для указанной модели.
   - Ожидает появления текстового поля для ввода запроса, используя `WebDriverWait` и `expected_conditions`.
   - Если текстовое поле не найдено, пытается переоткрыть браузер для повторной аутентификации или выбрасывает исключение `RuntimeError`.
6. **Ввод запроса и отправка сообщения**:
   - Вводит отформатированный запрос `prompt` в текстовое поле.
   - Нажимает кнопку отправки сообщения.
7. **Получение ответа в потоковом режиме**:
   - Использует JavaScript-код для извлечения частей ответа из перехваченных сообщений WebSocket.
   - В цикле опрашивает браузер на наличие новых частей ответа.
   - Возвращает каждую часть ответа с помощью `yield`, обеспечивая потоковую передачу данных.
   - Завершает цикл, когда ответ завершен (chunk != “”).
8. **Обработка ошибок**:
   - Если в процессе выполнения возникают исключения, они перехватываются и логируются с использованием `logger.error`.

```
    Проверка модели -> Форматирование запроса
          ↓
    Создание сессии WebDriver
          ↓
    Инициализация перехвата WebSocket
          ↓
    Навигация и ожидание загрузки страницы
          ↓
    Ввод запроса и отправка сообщения
          ↓
    Получение ответа в потоковом режиме
          ↓
    Завершение
```

**Примеры**:

```python
# Пример использования create_completion с минимальными параметрами
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Напиши короткий рассказ."}]
stream = True

result = Poe.create_completion(model=model, messages=messages, stream=stream)
for chunk in result:
    print(chunk, end="")

# Пример использования create_completion с указанием прокси и headless-режима
model = "gpt-4"
messages = [{"role": "user", "content": "Переведи на английский: 'Привет, мир!'."}]
stream = True
proxy = "http://your_proxy:8080"
headless = False

result = Poe.create_completion(model=model, messages=messages, stream=stream, proxy=proxy, headless=headless)
for chunk in result:
    print(chunk, end="")