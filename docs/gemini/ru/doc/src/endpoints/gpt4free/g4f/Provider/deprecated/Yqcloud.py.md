# Модуль Yqcloud

## Обзор

Модуль предоставляет асинхронный генератор для взаимодействия с сервисом Yqcloud (chat9.yqcloud.top), который предоставляет доступ к моделям, аналогичным GPT-3.5 Turbo. Модуль предназначен для генерации текста на основе предоставленных сообщений.

## Подробней

Этот модуль является провайдером для проекта `hypotez`, позволяя использовать Yqcloud в качестве одного из источников для генерации текста. Он использует асинхронные запросы для взаимодействия с API Yqcloud и предоставляет результаты в виде асинхронного генератора. Yqcloud используется для <получения ответов от gpt модели>.

## Классы

### `Yqcloud`

**Описание**: Класс `Yqcloud` предоставляет асинхронный генератор для взаимодействия с сервисом Yqcloud.

**Наследует**:
- `AsyncGeneratorProvider`: Наследует функциональность асинхронного генератора от базового класса `AsyncGeneratorProvider`.

**Атрибуты**:
- `url` (str): URL сервиса Yqcloud (`https://chat9.yqcloud.top/`).
- `working` (bool): Флаг, указывающий на работоспособность провайдера (по умолчанию `False`).
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели GPT-3.5 Turbo (по умолчанию `True`).

**Методы**:
- `create_async_generator`: Статический асинхронный метод, создающий асинхронный генератор для получения ответов от Yqcloud.

## Функции

### `create_async_generator`

```python
@staticmethod
async def create_async_generator(
    model: str,
    messages: Messages,
    proxy: str = None,
    timeout: int = 120,
    **kwargs,
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от Yqcloud.

    Args:
        model (str): Название используемой модели.
        messages (Messages): Список сообщений для отправки в Yqcloud.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        timeout (int, optional): Максимальное время ожидания ответа в секундах. По умолчанию `120`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий чанки текста от Yqcloud.

    Raises:
        RuntimeError: Если IP-адрес заблокирован из-за обнаружения злоупотреблений.

    Example:
        Примеры вызовов со всем спектром параметров. которы можно передать в функцию

    """
```

**Назначение**: Создает асинхронный генератор для получения ответов от Yqcloud.

**Параметры**:
- `model` (str): Название используемой модели.
- `messages` (Messages): Список сообщений для отправки в Yqcloud.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `timeout` (int, optional): Максимальное время ожидания ответа в секундах. По умолчанию `120`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий чанки текста от Yqcloud.

**Вызывает исключения**:
- `RuntimeError`: Если IP-адрес заблокирован из-за обнаружения злоупотреблений.

**Как работает функция**:

1. **Создание сессии**: Функция создает асинхронную сессию с использованием `StreamSession` для отправки запросов к API Yqcloud.
2. **Формирование полезной нагрузки**: Подготавливает данные (`payload`) для отправки, используя функцию `_create_payload`.
3. **Отправка запроса**: Отправляет POST-запрос к API Yqcloud (`https://api.aichatos.cloud/api/generateStream`) с сформированной полезной нагрузкой.
4. **Обработка ответа**: Получает ответ в виде асинхронного генератора чанков текста.
5. **Проверка на блокировку**: Проверяет каждый чанк на наличие сообщения о блокировке IP-адреса. Если такое сообщение обнаружено, выбрасывается исключение `RuntimeError`.
6. **Генерация чанков**: Выдает чанки текста, полученные от Yqcloud.

**Внутренние функции**: Нет

**Примеры**:
```python
# Пример использования create_async_generator
# Предположим, что у вас есть переменные model и messages
# async for chunk in Yqcloud.create_async_generator(model="gpt-3.5-turbo", messages=messages):
#     print(chunk, end="")
```

### `_create_header`

```python
def _create_header():
    """
    Создает словарь с заголовками для HTTP-запроса.

    Args:
        Нет

    Returns:
        dict: Словарь с заголовками.

    Raises:
        Нет

    Example:
        Примеры вызовов со всем спектром параметров. которы можно передать в функцию

    """
```

**Назначение**: Создает словарь с заголовками для HTTP-запроса.

**Параметры**:
- Нет

**Возвращает**:
- `dict`: Словарь с заголовками.

**Вызывает исключения**:
- Нет

**Как работает функция**:

1. **Определение заголовков**: Функция определяет необходимые заголовки для HTTP-запроса, такие как `accept`, `content-type`, `origin` и `referer`.
2. **Создание и возврат словаря**: Функция создает словарь с этими заголовками и возвращает его.

**Внутренние функции**: Нет

**Примеры**:
```python
# Пример использования _create_header
# headers = _create_header()
# print(headers)
```

### `_create_payload`

```python
def _create_payload(
    messages: Messages,
    system_message: str = "",
    user_id: int = None,
    **kwargs
):
    """
    Создает полезную нагрузку (payload) для запроса к API Yqcloud.

    Args:
        messages (Messages): Список сообщений для отправки.
        system_message (str, optional): Системное сообщение для установки контекста. По умолчанию "".
        user_id (int, optional): ID пользователя. Если не указан, генерируется случайный.
        **kwargs: Дополнительные параметры.

    Returns:
        dict: Словарь с полезной нагрузкой.

    Raises:
        Нет

    Example:
        Примеры вызовов со всем спектром параметров. которы можно передать в функцию

    """
```

**Назначение**: Создает полезную нагрузку (payload) для запроса к API Yqcloud.

**Параметры**:
- `messages` (Messages): Список сообщений для отправки.
- `system_message` (str, optional): Системное сообщение для установки контекста. По умолчанию "".
- `user_id` (int, optional): ID пользователя. Если не указан, генерируется случайный.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `dict`: Словарь с полезной нагрузкой.

**Вызывает исключения**:
- Нет

**Как работает функция**:

1. **Генерация User ID**: Если `user_id` не предоставлен, генерируется случайный `user_id` в диапазоне от 1690000544336 до 2093025544336.
2. **Форматирование prompt**: Форматирует сообщения, используя функцию `format_prompt(messages)`.
3. **Создание payload**: Создает словарь `payload` с параметрами `prompt`, `network`, `system`, `withoutContext`, `stream` и `userId`.
4. **Возврат payload**: Возвращает словарь `payload`.

**Внутренние функции**: Нет

**Примеры**:
```python
# Пример использования _create_payload
# messages = [...]  # предполагаемый список сообщений
# payload = _create_payload(messages=messages, system_message="You are a helpful assistant.")
# print(payload)
```

```
A (messages, system_message, user_id)
│
├─── Если user_id не указан:
│    │
│    └─── Генерация случайного user_id
│
│
└─── Форматирование prompt с использованием format_prompt(messages)
│
└─── Создание payload словаря с параметрами:
│    │
│    ├─── prompt: отформатированный prompt
│    │
│    ├─── network: True
│    │
│    ├─── system: system_message
│    │
│    ├─── withoutContext: False
│    │
│    ├─── stream: True
│    │
│    └─── userId: f"#/chat/{user_id}"
│
│
└─── Возврат payload словаря
```