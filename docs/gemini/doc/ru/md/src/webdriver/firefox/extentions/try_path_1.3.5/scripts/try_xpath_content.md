# Модуль try_xpath_content.js

## Обзор

Этот JavaScript-модуль (`try_xpath_content.js`) отвечает за обработку запросов на выполнение XPath-выражений в контексте текущей страницы. Он взаимодействует с расширением браузера (вероятно, через `browser.runtime.sendMessage`) для получения данных и отправки результатов. Модуль поддерживает поиск элементов на текущей странице и вложенных фреймах, а также обновляет стиль страницы.

## Переменные

### `tx`

**Описание**: псевдоним для объекта `tryxpath`.

### `fu`

**Описание**: псевдоним для объекта `tryxpath.functions`.

### `tx.isContentLoaded`

**Описание**: Флаг, предотвращающий многократное выполнение кода скрипта.

### `dummyItem`, `dummyItems`

**Описание**: Пустые значения, используемые в качестве заглушек.

### `invalidExecutionId`

**Описание**: Значение `NaN`, используемое для обозначения недействительного идентификатора выполнения.

### `styleElementHeader`

**Описание**: Строка, содержащая комментарии для элемента `<style>`, вставляемого расширением.

### `attributes`

**Описание**: Объект, содержащий атрибуты, используемые для маркировки элементов.

### `prevMsg`

**Описание**:  Предыдущее сообщение, отправленное в поп-ап.

### `executionCount`

**Описание**: Счетчик выполнений запросов.

### `inBlankWindow`

**Описание**: Флаг, указывающий, выполняется ли запрос в фрейме.

### `currentDocument`

**Описание**: Текущий документ.

### `contextItem`, `currentItems`, `focusedItem`, `focusedAncestorItems`

**Описание**:  Представляют собой текущий элемент контекста, список найденных элементов, выбранный элемент и его предки.

### `currentCss`

**Описание**: Текущий CSS-код.

### `insertedStyleElements`

**Описание**: Map, хранящая элементы `<style>`, вставленные в документ.

### `expiredCssSet`

**Описание**: Объект, содержащий устаревшие CSS-стили.

### `originalAttributes`

**Описание**: Map, хранящий оригинальные значения атрибутов.


## Функции

### `setAttr(attr, value, item)`

**Описание**: Устанавливает значение атрибута `attr` для элемента `item`. Сохраняет исходное значение атрибута.

**Параметры**:
- `attr` (string): Имя атрибута.
- `value` (string): Значение атрибута.
- `item` (object): Элемент, для которого устанавливается атрибут.

**Возвращает**:
- void

### `setIndex(attr, items)`

**Описание**: Устанавливает индексы атрибута `attr` для элементов `items`. Сохраняет исходные индексы.

**Параметры**:
- `attr` (string): Имя атрибута.
- `items` (array): Массив элементов, для которых устанавливаются индексы.


**Возвращает**:
- void

### `isFocusable(item)`

**Описание**: Проверяет, является ли элемент `item` фокусируемым.

**Параметры**:
- `item` (object): Элемент для проверки.

**Возвращает**:
- boolean: `true`, если элемент фокусируемый, иначе `false`.


### `focusItem(item)`

**Описание**: Фокусирует элемент `item`.

**Параметры**:
- `item` (object): Элемент для фокусировки.


**Возвращает**:
- void


### `setMainAttrs()`

**Описание**: Устанавливает атрибуты `context` и `element` для найденных элементов.


**Возвращает**:
- void


### `restoreAttrs()`

**Описание**: Восстанавливает оригинальные значения атрибутов элементов.


**Возвращает**:
- void


### `resetPrev()`

**Описание**: Сбрасывает состояние предыдущего запроса.


**Возвращает**:
- void


### `makeTypeStr(resultType)`

**Описание**: Преобразует тип результата в строку.


**Параметры**:
- `resultType` (number): Тип результата.

**Возвращает**:
- string: Строковое представление типа результата.


### `updateCss()`

**Описание**: Отправляет уведомление о необходимости обновления CSS стилей.


**Возвращает**:
- void


### `getFrames(spec)`

**Описание**: Извлекает массив индексов фреймов.


**Параметры**:
- `spec` (string): JSON-строка, содержащая индексы фреймов.


**Возвращает**:
- array: Массив индексов фреймов.


**Возможные исключения**:
- `Error`: При некорректном формате входных данных.


### `parseFrameDesignation(frameDesi)`

**Описание**: Парсит JSON-строку, содержащую индексы фреймов.

**Параметры**:
- `frameDesi` (string): JSON-строка, содержащая индексы фреймов.

**Возвращает**:
- array: Массив индексов фреймов.

**Возможные исключения**:
- `Error`: При некорректном формате входных данных.


### `traceBlankWindows(desi, win)`

**Описание**: Проверяет, являются ли вложенные фреймы пустыми.

**Параметры**:
- `desi` (array): Массив индексов фреймов.
- `win` (object, optional): Текущий фрейм.

**Возвращает**:
- object: Объект с информацией о фреймах, включающий `success` (успех) и `windows` (массив фреймов).

**Возможные исключения**:
- `Error`: Если фрейм не существует.


### `handleCssChange(newCss)`

**Описание**: Обрабатывает изменения CSS.

**Параметры**:
- `newCss` (string): Новый CSS-код.

**Возвращает**:
- void


### `findFrameByMessage(event, win)`

**Описание**: Ищет элемент фрейма по сообщению.


**Параметры**:
- `event` (object): Объект события.
- `win` (object): Текущий фрейм.

**Возвращает**:
- object: Найденный элемент фрейма, или `null`.


### `setFocusFrameListener(win, isBlankWindow)`

**Описание**: Устанавливает обработчик сообщений для фрейма.

**Параметры**:
- `win` (object): Фрейм.
- `isBlankWindow` (boolean): Является ли фрейм пустым.


**Возвращает**:
- void


### `initBlankWindow(win)`

**Описание**: Инициализирует работу в пустом фрейме.

**Параметры**:
- `win` (object): Фрейм.

**Возвращает**:
- void


### `findStyleParent(doc)`

**Описание**: Находит родительский элемент для вставки CSS.


**Параметры**:
- `doc` (object): Документ.

**Возвращает**:
- object: Родительский элемент.


### `updateStyleElement(doc)`

**Описание**: Обновляет стиль элемента.

**Параметры**:
- `doc` (object): Документ.

**Возвращает**:
- void


### `updateAllStyleElements()`

**Описание**: Обновляет все стили.

**Возвращает**:
- void


### `removeStyleElement(doc)`

**Описание**: Удаляет элемент стиля из документа.


**Параметры**:
- `doc` (object): Документ.

**Возвращает**:
- void


### `removeAllStyleElements()`

**Описание**: Удаляет все стили.

**Возвращает**:
- void


### `createResultMessage()`

**Описание**: Создает сообщение об ошибке.


**Возвращает**:
- object: Объект с сообщением об ошибке.


### `genericListener(message, sender, sendResponse)`

**Описание**: Универсальный обработчик сообщений.


**Параметры**:
- `message` (object): Сообщение.
- `sender` (object): Отправитель сообщения.
- `sendResponse` (function): Функция для ответа на сообщение.

**Возвращает**:
- void

## Обработка сообщений (genericListener.listeners)


(Список обработчиков сообщений, таких как `execute`, `focusItem`, `focusContextItem` и т.д. - слишком обширный для полного перечисления здесь.  Обратите внимание на обработку ошибок, обработку случаев работы с фреймами, вызов функций `execExpr`, `getItemDetail`, `getItemDetails`)


## Заключение

Этот модуль является сложным и многофункциональным. Он предоставляет множество функций для работы с XPath-выражениями, фреймами, обработкой ошибок и обновлением CSS стилей.  Подробная документация для каждой отдельной функции необходима для полного понимания ее функциональности.