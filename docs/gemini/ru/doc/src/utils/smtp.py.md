# Модуль для работы с SMTP
=================================================

Модуль предоставляет интерфейс для отправки и получения электронных писем, используя протоколы SMTP и IMAP.
Он включает функции для отправки электронных писем через SMTP и получения электронных писем через IMAP.

Пример использования
----------------------

```python
from src.utils.smtp import send, receive

# Отправка электронного письма
success = send(subject='Тестовое письмо', body='Это тело тестового письма.', to='recipient@example.com')
if success:
    print('Письмо успешно отправлено!')
else:
    print('Ошибка при отправке письма.')

# Получение электронных писем
emails = receive(imap_server='imap.example.com', user='username', password='password', folder='INBOX')
if emails:
    for email in emails:
        print(f"Тема: {email['subject']}")
        print(f"От: {email['from']}")
        print(f"Содержание: {email['body']}")
else:
    print('Ошибка при получении писем.')
```

## Оглавление
- [Обзор](#обзор)
- [Подробнее](#подробнее)
- [Функции](#функции)
    - [`send`](#send)
    - [`receive`](#receive)

## Обзор

Модуль `smtp.py` предоставляет функциональность для работы с электронной почтой, позволяя отправлять и получать сообщения. Он использует протоколы SMTP для отправки и IMAP для получения электронных писем. Модуль включает функции для отправки электронных писем с указанием темы, тела и получателя, а также для получения электронных писем из указанного почтового ящика.

## Подробнее

Модуль предназначен для упрощения работы с электронной почтой в проекте `hypotez`. Он содержит функции для отправки электронных писем через SMTP и получения электронных писем через IMAP. Важно отметить, что параметры подключения к серверам SMTP и IMAP, такие как имя сервера, порт, имя пользователя и пароль, должны быть заданы через переменные окружения, а не жестко закодированы в файле, чтобы обеспечить безопасность и гибкость конфигурации.

## Функции

### `send`

```python
def send(subject: str = '', body: str = '', to: str = 'one.last.bit@gmail.com') -> bool:
    """Отправляет электронное письмо. Возвращает True в случае успеха, False в противном случае. Регистрирует ошибки."""
```

**Назначение**:
Функция `send` отправляет электронное письмо на указанный адрес электронной почты с заданным темой и телом сообщения.

**Параметры**:
- `subject` (str, optional): Тема электронного письма. По умолчанию ''.
- `body` (str, optional): Тело электронного письма. По умолчанию ''.
- `to` (str, optional): Адрес электронной почты получателя. По умолчанию 'one.last.bit@gmail.com'.

**Возвращает**:
- `bool`: Возвращает `True`, если электронное письмо успешно отправлено, и `False` в противном случае.

**Вызывает исключения**:
- `smtplib.SMTPException`: В случае ошибок, связанных с SMTP-сервером.
- `Exception`: В случае любых других ошибок при отправке электронного письма.

**Как работает функция**:

1.  **Установка соединения**: Функция создает SMTP-соединение с использованием параметров из словаря `_connection`, который должен содержать имя сервера, порт, имя пользователя и пароль.
2.  **Начало TLS**: Устанавливает защищенное TLS-соединение с сервером.
3.  **Авторизация**: Выполняет вход на SMTP-сервер с использованием предоставленных учетных данных.
4.  **Создание сообщения**: Создает MIME-сообщение с указанной темой, телом и адресом отправителя и получателя.
5.  **Отправка сообщения**: Отправляет сообщение на указанный адрес электронной почты.
6.  **Завершение соединения**: Закрывает соединение с SMTP-сервером.
7.  **Обработка ошибок**: В случае возникновения ошибки, функция регистрирует информацию об ошибке с использованием модуля `logger` и возвращает `False`.

**ASCII flowchart**:

```
    Начало
    |
    Создание SMTP-соединения
    |
    Установка TLS-соединения
    |
    Авторизация на SMTP-сервере
    |
    Создание MIME-сообщения
    |
    Отправка сообщения
    |
    Завершение соединения
    |
    Конец (True)
    |
    Ошибка
    |
    Логирование ошибки
    |
    Конец (False)
```

**Примеры**:

```python
from src.utils.smtp import send

# Отправка простого электронного письма
success = send(subject='Тест', body='Это тестовое письмо.', to='test@example.com')
if success:
    print('Письмо успешно отправлено!')
else:
    print('Ошибка при отправке письма.')

# Отправка электронного письма с пустым телом
success = send(subject='Уведомление', to='user@example.com')
if success:
    print('Уведомление успешно отправлено!')
else:
    print('Ошибка при отправке уведомления.')
```

### `receive`

```python
def receive(imap_server: str, user: str, password: str, folder: str = 'inbox') -> Optional[List[Dict[str, str]]]:
    """Извлекает электронные письма. Возвращает список словарей электронных писем в случае успеха, None в противном случае. Регистрирует ошибки."""
```

**Назначение**:
Функция `receive` получает электронные письма из указанного почтового ящика IMAP-сервера и возвращает их в виде списка словарей.

**Параметры**:
- `imap_server` (str): Адрес IMAP-сервера.
- `user` (str): Имя пользователя для входа на IMAP-сервер.
- `password` (str): Пароль для входа на IMAP-сервер.
- `folder` (str, optional): Название почтового ящика для получения электронных писем. По умолчанию 'inbox'.

**Возвращает**:
- `Optional[List[Dict[str, str]]]`: Возвращает список словарей, где каждый словарь представляет собой электронное письмо с ключами 'subject', 'from' и 'body'. Возвращает `None` в случае ошибки.

**Вызывает исключения**:
- `imaplib.IMAP4.error`: В случае ошибок, связанных с IMAP-сервером.
- `Exception`: В случае любых других ошибок при получении электронных писем.

**Как работает функция**:

1.  **Установка соединения**: Функция создает IMAP-соединение с использованием предоставленных параметров сервера, имени пользователя и пароля.
2.  **Авторизация**: Выполняет вход на IMAP-сервер с использованием предоставленных учетных данных.
3.  **Выбор почтового ящика**: Выбирает указанный почтовый ящик для получения электронных писем.
4.  **Поиск электронных писем**: Выполняет поиск всех электронных писем в выбранном почтовом ящике.
5.  **Извлечение данных**: Извлекает данные каждого электронного письма, включая тему, отправителя и тело сообщения.
6.  **Декодирование тела сообщения**: Декодирует тело сообщения, обрабатывая потенциальные ошибки кодировки.
7.  **Создание списка электронных писем**: Создает список словарей, где каждый словарь представляет собой электронное письмо с ключами 'subject', 'from' и 'body'.
8.  **Завершение соединения**: Закрывает соединение с IMAP-сервером и выполняет выход.
9.  **Обработка ошибок**: В случае возникновения ошибки, функция регистрирует информацию об ошибке с использованием модуля `logger` и возвращает `None`.

**ASCII flowchart**:

```
    Начало
    |
    Создание IMAP-соединения
    |
    Авторизация на IMAP-сервере
    |
    Выбор почтового ящика
    |
    Поиск электронных писем
    |
    Извлечение данных электронных писем
    |
    Декодирование тела сообщения
    |
    Создание списка электронных писем
    |
    Завершение соединения
    |
    Конец (emails)
    |
    Ошибка
    |
    Логирование ошибки
    |
    Конец (None)
```

**Примеры**:

```python
from src.utils.smtp import receive

# Получение электронных писем из почтового ящика
emails = receive(imap_server='imap.example.com', user='user@example.com', password='password', folder='INBOX')
if emails:
    for email in emails:
        print(f"Тема: {email['subject']}")
        print(f"От: {email['from']}")
        print(f"Содержание: {email['body']}")
else:
    print('Ошибка при получении писем.')

# Получение электронных писем из другого почтового ящика
emails = receive(imap_server='imap.example.com', user='user@example.com', password='password', folder='Spam')
if emails:
    print('Электронные письма из почтового ящика "Spam" успешно получены.')
else:
    print('Ошибка при получении писем из почтового ящика "Spam".')