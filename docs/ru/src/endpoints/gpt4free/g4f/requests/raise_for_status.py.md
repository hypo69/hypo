# Модуль для обработки статусов ответов и вызова исключений
=================================================================

Модуль содержит функции для проверки статуса ответа от сервера и вызова соответствующих исключений в случае ошибки.
В частности, обрабатываются ошибки, связанные с Cloudflare, OpenAI, лимитами запросов и другими проблемами.

## Обзор

Модуль предоставляет функции `raise_for_status_async` и `raise_for_status`, которые анализируют HTTP-ответы и вызывают исключения в случае возникновения ошибок. Он также содержит функции `is_cloudflare` и `is_openai` для определения, связаны ли ошибки с Cloudflare или OpenAI.

## Подробнее

Этот модуль играет важную роль в обработке ответов от различных сервисов, используемых в проекте `hypotez`. Он позволяет унифицировать обработку ошибок и предоставляет более информативные сообщения об ошибках для отладки и обработки исключительных ситуаций.

## Функции

### `is_cloudflare`

```python
def is_cloudflare(text: str) -> bool:
    """
    Определяет, является ли текст ответа страницей Cloudflare.

    Args:
        text (str): Текст ответа от сервера.

    Returns:
        bool: `True`, если текст содержит признаки страницы Cloudflare, иначе `False`.

    Как работает функция:
    1. Функция проверяет наличие определенных строк в тексте ответа, которые характерны для страниц Cloudflare.
    2. Если одна из этих строк найдена, функция возвращает `True`.
    3. Если ни одна из строк не найдена, функция возвращает `False`.
    """
```

**Примеры**:

```python
is_cloudflare("Generated by cloudfront")  # Возвращает True
is_cloudflare('<p id="cf-spinner-please-wait">')  # Возвращает True
is_cloudflare("<title>Attention Required! | Cloudflare</title>")  # Возвращает True
is_cloudflare('id="cf-cloudflare-status"')  # Возвращает True
is_cloudflare('<div id="cf-please-wait">')  # Возвращает True
is_cloudflare("<title>Just a moment...</title>")  # Возвращает True
is_cloudflare("Example text")  # Возвращает False
```

### `is_openai`

```python
def is_openai(text: str) -> bool:
    """
    Определяет, является ли текст ответа страницей OpenAI.

    Args:
        text (str): Текст ответа от сервера.

    Returns:
        bool: `True`, если текст содержит признаки страницы OpenAI, иначе `False`.
    """
```

**Примеры**:

```python
is_openai("<p>Unable to load site</p>")  # Возвращает True
is_openai('id="challenge-error-text"')  # Возвращает True
is_openai("Example text")  # Возвращает False
```

### `raise_for_status_async`

```python
async def raise_for_status_async(response: Union[StreamResponse, ClientResponse], message: str = None):
    """
    Асинхронно проверяет статус ответа и вызывает исключение, если статус не OK.

    Args:
        response (Union[StreamResponse, ClientResponse]): Объект ответа.
        message (str, optional): Сообщение об ошибке. Defaults to None.

    Raises:
        MissingAuthError: Если статус ответа 401.
        CloudflareError: Если статус ответа 403 и обнаружен Cloudflare.
        ResponseStatusError: Если статус ответа 403 и обнаружен OpenAI, или если статус 502, или в других случаях неуспешного ответа.
        RateLimitError: Если статус ответа 504.
    """
```

**Как работает функция**:

1.  **Проверка успешности**: Проверяет, является ли статус ответа успешным (`response.ok`). Если да, функция завершается.
2.  **Обработка контента**: Если сообщение об ошибке не предоставлено, функция пытается извлечь его из тела ответа.
    *   Если `content-type` начинается с `application/json`, пытается извлечь сообщение из JSON-структуры (`response.json().get("error", message).get("message", message)`).
    *   Иначе пытается получить текст ответа (`response.text()`).
3.  **Проверка на Cloudflare/OpenAI**: Если статус ответа 403, проверяет, связан ли он с Cloudflare или OpenAI, используя функции `is_cloudflare` и `is_openai`.
4.  **Вызов исключений**: В зависимости от статуса ответа и типа ошибки, функция вызывает соответствующее исключение:
    *   `MissingAuthError` для статуса 401.
    *   `CloudflareError` для статуса 403 и обнаруженного Cloudflare.
    *   `ResponseStatusError` для статуса 403 и обнаруженного OpenAI, статуса 502 или других ошибок.
    *   `RateLimitError` для статуса 504.

**Примеры**:

```python
#Предположим, у нас есть асинхронный клиентский сеанс и ответ
#Ниже приведены примеры вызовов с разными параметрами, которые передаются в функцию

async def example():
    import aiohttp
    async with aiohttp.ClientSession() as session:
        #Пример успешного ответа
        async with session.get('https://example.com') as response:
            await raise_for_status_async(response)  # Не вызовет исключение
```

### `raise_for_status`

```python
def raise_for_status(response: Union[Response, StreamResponse, ClientResponse, RequestsResponse], message: str = None):
    """
    Проверяет статус ответа и вызывает исключение, если статус не OK.

    Args:
        response (Union[Response, StreamResponse, ClientResponse, RequestsResponse]): Объект ответа.
        message (str, optional): Сообщение об ошибке. Defaults to None.

    Raises:
        MissingAuthError: Если статус ответа 401.
        CloudflareError: Если статус ответа 403 и обнаружен Cloudflare.
        ResponseStatusError: Если статус ответа 403 и обнаружен OpenAI, или если статус 502, или в других случаях неуспешного ответа.
        RateLimitError: Если статус ответа 504 или 429/402.
    """
```

**Как работает функция**:

1.  **Проверка типа ответа**: Проверяет, является ли ответ асинхронным (`hasattr(response, "status")`). Если да, вызывает `raise_for_status_async`.
2.  **Проверка успешности**: Проверяет, является ли статус ответа успешным (`response.ok`). Если да, функция завершается.
3.  **Обработка контента**: Если сообщение об ошибке не предоставлено, функция пытается извлечь его из тела ответа.
    *   Определяет, является ли контент HTML, проверяя `content-type` или начало текста ответа.
    *   Получает текст ответа (`response.text`).
4.  **Проверка на Cloudflare/OpenAI**: Если статус ответа 403, проверяет, связан ли он с Cloudflare или OpenAI, используя функции `is_cloudflare` и `is_openai`.
5.  **Вызов исключений**: В зависимости от статуса ответа и типа ошибки, функция вызывает соответствующее исключение:
    *   `MissingAuthError` для статуса 401.
    *   `CloudflareError` для статуса 403 и обнаруженного Cloudflare.
    *   `ResponseStatusError` для статуса 403 и обнаруженного OpenAI, статуса 502 или других ошибок.
    *   `RateLimitError` для статуса 504.

**Примеры**:

```python
#Предположим, у нас есть клиентский сеанс и ответ
#Ниже приведены примеры вызовов с разными параметрами, которые передаются в функцию

import requests

#Пример успешного ответа
response = requests.get('https://example.com')
raise_for_status(response)  # Не вызовет исключение
```