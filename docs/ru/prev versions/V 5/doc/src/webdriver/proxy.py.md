# Модуль для работы с прокси

## Обзор

Модуль определяет функции для загрузки и парсинга списка прокси. Загружается текстовый файл с прокси-адресами и распределяется по категориям.

## Подробнее

Этот модуль предоставляет функциональность для работы с прокси-серверами. Он позволяет загружать список прокси-серверов из внешнего источника, парсить его и проверять работоспособность прокси. Модуль включает в себя функции для загрузки списка прокси из URL, парсинга списка прокси из файла и проверки работоспособности прокси-сервера. Этот модуль может быть использован для автоматической настройки прокси в веб-драйверах и других приложениях, требующих анонимности или обхода географических ограничений.

## Классы

В данном модуле классы отсутствуют.

## Функции

### `download_proxies_list`

```python
def download_proxies_list(url: str = url, save_path: Path = proxies_list_path) -> bool:
    """
    Загружает файл по указанному URL и сохраняет его в заданный путь.

    :param url: URL файла для загрузки.
    :param save_path: Путь для сохранения загруженного файла.
    :return: Успешность выполнения операции.
    """
```

**Описание**: Загружает файл по указанному URL и сохраняет его в заданный путь.

**Как работает функция**:
1. Отправляет GET-запрос по указанному URL для загрузки файла.
2. Проверяет статус ответа HTTP, генерируя исключение `HTTPError`, если статус указывает на ошибку.
3. Открывает файл по указанному пути для записи в бинарном режиме.
4. Итерирует содержимое ответа чанками (размером 8192 байта) и записывает каждый чанк в файл.
5. Логирует сообщение об успешной загрузке и сохранении файла.
6. В случае возникновения исключений, логирует сообщение об ошибке и возвращает `False`.

**Параметры**:
- `url` (str, optional): URL файла для загрузки. По умолчанию используется глобальная переменная `url`.
- `save_path` (Path, optional): Путь для сохранения загруженного файла. По умолчанию используется глобальная переменная `proxies_list_path`.

**Возвращает**:
- `bool`: `True`, если файл успешно загружен и сохранен, `False` в случае ошибки.

**Вызывает исключения**:
- `requests.exceptions.RequestException`: Возникает при проблемах с HTTP-запросом.
- `OSError`: Возникает при ошибках работы с файловой системой.

**Примеры**:

```python
from pathlib import Path
from src.webdriver.proxy import download_proxies_list

url = 'https://raw.githubusercontent.com/example/proxies/main/proxies.txt'
save_path = Path('./proxies.txt')

if download_proxies_list(url, save_path):
    print('Список прокси успешно загружен.')
else:
    print('Ошибка при загрузке списка прокси.')
```

### `get_proxies_dict`

```python
def get_proxies_dict(file_path: Path = proxies_list_path) -> Dict[str, List[Dict[str, Any]]]:
    """
    Парсит файл с прокси-адресами и распределяет их по категориям.

    :param file_path: Путь к файлу с прокси.
    :return: Словарь с распределёнными по типам прокси.
    """
```

**Описание**: Парсит файл с прокси-адресами и распределяет их по категориям (http, socks4, socks5).

**Как работает функция**:
1. Вызывает функцию `download_proxies_list()` для загрузки актуального списка прокси.
2. Инициализирует словарь `proxies` с ключами `http`, `socks4` и `socks5`, каждый из которых содержит пустой список.
3. Открывает файл, указанный в `file_path`, для чтения.
4. Читает файл построчно и пытается сопоставить каждую строку с регулярным выражением, определяющим протокол, хост и порт прокси.
5. Если строка соответствует регулярному выражению, извлекает протокол, хост и порт и добавляет их в соответствующий список в словаре `proxies`.
6. В случае возникновения исключения `FileNotFoundError`, логирует сообщение об ошибке.
7. В случае возникновения любого другого исключения, логирует сообщение об ошибке парсинга прокси.
8. Возвращает словарь `proxies`.

**Параметры**:
- `file_path` (Path, optional): Путь к файлу с прокси. По умолчанию используется глобальная переменная `proxies_list_path`.

**Возвращает**:
- `Dict[str, List[Dict[str, Any]]]`: Словарь, где ключи - это типы прокси (`http`, `socks4`, `socks5`), а значения - списки словарей, каждый из которых содержит информацию о прокси (`protocol`, `host`, `port`).

**Вызывает исключения**:
- `FileNotFoundError`: Возникает, если файл, указанный в `file_path`, не найден.
- `Exception`: Возникает при ошибках парсинга прокси.

**Примеры**:

```python
from pathlib import Path
from src.webdriver.proxy import get_proxies_dict

file_path = Path('./proxies.txt')
proxies = get_proxies_dict(file_path)

if proxies:
    print('Список прокси успешно спарсен:')
    for protocol, proxy_list in proxies.items():
        print(f'  {protocol}: {len(proxy_list)} прокси')
else:
    print('Ошибка при парсинге списка прокси.')
```

### `check_proxy`

```python
def check_proxy(proxy: dict) -> bool:
    """
    Проверяет работоспособность прокси-сервера.
    
    :param proxy: Словарь с данными прокси (host, port, protocol).
    :return: True, если прокси работает, иначе False.
    """
```

**Описание**: Проверяет работоспособность прокси-сервера, отправляя HTTP-запрос через указанный прокси.

**Как работает функция**:
1. Формирует URL прокси-сервера на основе данных из словаря `proxy`.
2. Отправляет GET-запрос на `https://httpbin.org/ip` через указанный прокси с таймаутом 5 секунд.
3. Проверяет код ответа HTTP:
   - Если код ответа равен 200, логирует сообщение об успешной проверке прокси и возвращает `True`.
   - Если код ответа не равен 200, логирует сообщение о неработающем прокси и возвращает `False`.
4. В случае возникновения исключений `ProxyError` или `RequestException`, логирует сообщение об ошибке подключения через прокси и возвращает `False`.

**Параметры**:
- `proxy` (dict): Словарь с данными прокси, содержащий ключи `host`, `port` и `protocol`.

**Возвращает**:
- `bool`: `True`, если прокси работает, `False` в противном случае.

**Вызывает исключения**:
- `requests.exceptions.ProxyError`: Возникает при проблемах с прокси-сервером.
- `requests.exceptions.RequestException`: Возникает при проблемах с HTTP-запросом.

**Примеры**:

```python
from src.webdriver.proxy import check_proxy

proxy = {'protocol': 'http', 'host': '127.0.0.1', 'port': '8080'}

if check_proxy(proxy):
    print('Прокси работает.')
else:
    print('Прокси не работает.')