# Модуль для работы с сервисом Mega
====================================

Модуль предоставляет класс `Mega` для взаимодействия с сервисом Mega.co.nz, включая аутентификацию, загрузку и скачивание файлов.

## Обзор

Этот модуль предоставляет интерфейс для работы с сервисом Mega, позволяя пользователям выполнять различные операции, такие как вход в систему, загрузка и скачивание файлов. Он включает в себя методы для обработки ключей шифрования, аутентификации и выполнения API-запросов к серверам Mega.

## Подробнее

Модуль `mega.py` содержит класс `Mega`, который инкапсулирует логику взаимодействия с сервисом Mega. Он включает в себя методы для аутентификации пользователя, получения списка файлов, скачивания и загрузки файлов, а также для работы с ключами шифрования. Модуль использует библиотеки `requests`, `urlobject` и `Crypto` для выполнения HTTP-запросов, обработки URL и выполнения криптографических операций.

## Классы

### `Mega`

**Описание**:
Класс для взаимодействия с сервисом Mega. Предоставляет методы для аутентификации, скачивания и загрузки файлов.

**Принцип работы**:
Класс `Mega` инициализируется с помощью конструктора `__init__`, который устанавливает начальные значения для атрибутов `seqno` (порядковый номер запроса) и `sid` (идентификатор сессии). Класс также предоставляет альтернативные конструкторы `from_credentials` и `from_ephemeral` для аутентификации пользователя с использованием email/пароля или временной сессии соответственно.

**Атрибуты**:
- `seqno` (int): Порядковый номер запроса. Используется для отслеживания запросов к API.
- `sid` (str): Идентификатор сессии. Используется для аутентификации пользователя.
- `master_key` (list): Главный ключ шифрования. Используется для шифрования и дешифрования файлов.
- `rsa_priv_key` (list): Приватный RSA-ключ. Используется для аутентификации сессии.
- `root_id` (str): Идентификатор корневой папки ("Cloud Drive").
- `inbox_id` (str): Идентификатор папки "Inbox".
- `trashbin_id` (str): Идентификатор корзины.

**Методы**:
- `__init__`: Инициализирует экземпляр класса `Mega`.
- `from_credentials`: Создает экземпляр класса `Mega` и выполняет вход в систему с использованием email и пароля.
- `from_ephemeral`: Создает экземпляр класса `Mega` и выполняет вход в систему с использованием временной сессии.
- `api_req`: Выполняет API-запрос к серверам Mega.
- `login_user`: Выполняет вход в систему с использованием email и пароля.
- `login_ephemeral`: Выполняет вход в систему с использованием временной сессии.
- `_login_common`: Общая логика для входа в систему.
- `get_files`: Получает список файлов и папок из хранилища Mega.
- `download_from_url`: Скачивает файл по публичной ссылке.
- `download_file`: Скачивает файл из хранилища Mega.
- `get_public_url`: Возвращает публичную ссылку на файл.
- `uploadfile`: Загружает файл в хранилище Mega.

## Функции

### `__init__`

```python
def __init__(self):
    """
    Инициализирует экземпляр класса Mega.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        None

    """
```

**Назначение**:
Инициализирует экземпляр класса `Mega`, устанавливая начальные значения для атрибутов `seqno` и `sid`.

**Как работает функция**:

1. Инициализирует атрибут `seqno` случайным целым числом в диапазоне от 0 до 0xFFFFFFFF.
2. Устанавливает атрибут `sid` в значение `None`.

### `from_credentials`

```python
@classmethod
def from_credentials(cls, email: str, password: str) -> 'Mega':
    """
    Создает экземпляр класса Mega и выполняет вход в систему с использованием email и пароля.

    Args:
        cls (Mega): Класс Mega.
        email (str): Email пользователя.
        password (str): Пароль пользователя.

    Returns:
        Mega: Экземпляр класса Mega, аутентифицированный с использованием email и пароля.

    """
```

**Назначение**:
Создает экземпляр класса `Mega` и выполняет вход в систему с использованием предоставленных учетных данных (email и пароль).

**Параметры**:
- `cls` (Mega): Ссылка на класс `Mega`.
- `email` (str): Email пользователя для входа в систему.
- `password` (str): Пароль пользователя для входа в систему.

**Возвращает**:
- `Mega`: Новый экземпляр класса `Mega`, аутентифицированный с использованием email и пароля.

**Как работает функция**:

1. Создает новый экземпляр класса `Mega`.
2. Вызывает метод `login_user` для аутентификации пользователя с использованием email и пароля.
3. Возвращает созданный экземпляр класса `Mega`.

**Примеры**:

```python
mega = Mega.from_credentials('user@example.com', 'password')
```

### `from_ephemeral`

```python
@classmethod
def from_ephemeral(cls) -> 'Mega':
    """
    Создает экземпляр класса Mega и выполняет вход в систему с использованием временной сессии.

    Args:
        cls (Mega): Класс Mega.

    Returns:
        Mega: Экземпляр класса Mega, аутентифицированный с использованием временной сессии.

    """
```

**Назначение**:
Создает экземпляр класса `Mega` и выполняет вход в систему с использованием временной (эфемеральной) сессии.

**Параметры**:
- `cls` (Mega): Ссылка на класс `Mega`.

**Возвращает**:
- `Mega`: Новый экземпляр класса `Mega`, аутентифицированный с использованием временной сессии.

**Как работает функция**:

1. Создает новый экземпляр класса `Mega`.
2. Вызывает метод `login_ephemeral` для аутентификации пользователя с использованием временной сессии.
3. Возвращает созданный экземпляр класса `Mega`.

**Примеры**:

```python
mega = Mega.from_ephemeral()
```

### `api_req`

```python
def api_req(self, data: dict) -> dict:
    """
    Выполняет API-запрос к серверам Mega.

    Args:
        self (Mega): Экземпляр класса Mega.
        data (dict): Словарь с данными запроса.

    Returns:
        dict: Словарь с данными ответа от сервера.

    Raises:
        MegaRequestException: Если сервер возвращает код ошибки.

    """
```

**Назначение**:
Выполняет API-запрос к серверам Mega с использованием предоставленных данных и возвращает ответ сервера.

**Параметры**:
- `self` (Mega): Экземпляр класса `Mega`.
- `data` (dict): Словарь, содержащий данные для отправки в API-запросе.

**Возвращает**:
- `dict`: Словарь, содержащий данные, возвращенные сервером в ответ на API-запрос.

**Вызывает исключения**:
- `MegaRequestException`: Если сервер возвращает код ошибки, который указывает на неудачное выполнение запроса.

**Как работает функция**:

```ascii
    Начало
    │
    └───> Формирование параметров запроса (params)
         │  Включает 'id' (порядковый номер запроса)
         │  Если есть 'sid' (идентификатор сессии), добавляет его
         │
    └───> Преобразование данных запроса в JSON (data)
         │
    └───> Отправка POST-запроса к API Mega (req)
         │  URL: 'https://g.api.mega.co.nz/cs'
         │  Параметры: params
         │  Данные: data
         │
    └───> Обработка ответа (json_data)
         │  Преобразование JSON-ответа в Python-объект
         │  Проверка на код ошибки в ответе
         │  Если код ошибки присутствует, вызывает MegaRequestException
         │
    └───> Возврат данных ответа
         │
    Конец
```

**Примеры**:

```python
data = {'a': 'us', 'user': 'user@example.com', 'uh': 'somehash'}
response = self.api_req(data)
```

### `login_user`

```python
def login_user(self, email: str, password: str) -> None:
    """
    Выполняет вход в систему с использованием email и пароля.

    Args:
        self (Mega): Экземпляр класса Mega.
        email (str): Email пользователя.
        password (str): Пароль пользователя.

    Returns:
        None

    """
```

**Назначение**:
Выполняет аутентификацию пользователя в сервисе Mega с использованием предоставленного email и пароля.

**Параметры**:
- `self` (Mega): Экземпляр класса `Mega`.
- `email` (str): Email пользователя для входа в систему.
- `password` (str): Пароль пользователя для входа в систему.

**Возвращает**:
- `None`

**Как работает функция**:

1. Подготавливает ключ шифрования пароля с помощью функции `prepare_key`.
2. Вычисляет хеш email и пароля с помощью функции `stringhash`.
3. Выполняет API-запрос к серверу Mega для аутентификации пользователя.
4. Вызывает метод `_login_common` для обработки ответа сервера и установки параметров сессии.

**Примеры**:

```python
mega = Mega()
mega.login_user('user@example.com', 'password')
```

### `login_ephemeral`

```python
def login_ephemeral(self) -> None:
    """
    Выполняет вход в систему с использованием временной сессии.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        None

    """
```

**Назначение**:
Выполняет вход в систему Mega с использованием временной (эфемеральной) сессии.

**Параметры**:
- `self` (Mega): Экземпляр класса `Mega`.

**Возвращает**:
- `None`

**Как работает функция**:

1. Генерирует случайные ключи и параметры для временной сессии.
2. Выполняет API-запрос к серверу Mega для получения user handle.
3. Выполняет API-запрос к серверу Mega для аутентификации пользователя с использованием user handle.
4. Вызывает метод `_login_common` для обработки ответа сервера и установки параметров сессии.

**Примеры**:

```python
mega = Mega()
mega.login_ephemeral()
```

### `_login_common`

```python
def _login_common(self, res: dict, password: list) -> None:
    """
    Общая логика для входа в систему.

    Args:
        self (Mega): Экземпляр класса Mega.
        res (dict): Ответ от сервера Mega.
        password (list): Ключ шифрования пароля.

    Returns:
        None

    Raises:
        MegaIncorrectPasswordExcetion: Если email и/или пароль неверны.

    """
```

**Назначение**:
Содержит общую логику для обработки ответа сервера после попытки входа в систему и устанавливает параметры сессии.

**Параметры**:
- `self` (Mega): Экземпляр класса `Mega`.
- `res` (dict): Ответ от сервера Mega после попытки входа в систему.
- `password` (list): Ключ шифрования пароля.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `MegaIncorrectPasswordExcetion`: Если сервер возвращает код ошибки, указывающий на неверный email и/или пароль.

**Как работает функция**:

```ascii
    Начало
    │
    └───> Проверка кода ошибки (res)
         │  Если код ошибки -2 или -9, вызывается MegaIncorrectPasswordExcetion
         │
    └───> Расшифровка master key (enc_master_key)
         │  Извлекается из ответа сервера
         │  Расшифровывается с использованием password
         │
    └───> Установка master_key
         │
    └───> Проверка наличия tsid или csid в ответе
         │  Если есть tsid:
         │    Извлекается и расшифровывается tsid для получения sid
         │  Если есть csid:
         │    Извлекается и расшифровывается rsa_priv_key для получения приватного RSA-ключа
         │    Дешифруется csid с использованием приватного RSA-ключа для получения sid
         │
    └───> Установка sid
         │
    Конец
```

**Примеры**:

```python
response = {'k': 'encrypted_master_key', 'tsid': 'encrypted_session_id'}
mega = Mega()
mega._login_common(response, password_key)
```

### `get_files`

```python
def get_files(self) -> dict:
    """
    Получает список файлов и папок из хранилища Mega.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        dict: Словарь с данными о файлах и папках в хранилище.

    """
```

**Назначение**:
Получает список файлов и папок из облачного хранилища Mega, выполняя API-запрос и обрабатывая полученные данные.

**Параметры**:
- `self` (Mega): Экземпляр класса `Mega`.

**Возвращает**:
- `dict`: Словарь, содержащий информацию о файлах и папках в хранилище Mega.

**Как работает функция**:

```ascii
    Начало
    │
    └───> Выполнение API-запроса для получения списка файлов (files_data)
         │  Параметры запроса: {'a': 'f', 'c': 1}
         │
    └───> Обработка каждого файла в списке (file)
         │  Если тип файла (file['t']) 0 или 1 (файл или папка):
         │    Извлечение и расшифровка ключа файла (key)
         │    Расшифровка атрибутов файла (attributes)
         │  Если тип файла 2 (Root/"Cloud Drive"):
         │    Сохранение идентификатора корневой папки (root_id)
         │  Если тип файла 3 (Inbox):
         │    Сохранение идентификатора папки "Inbox" (inbox_id)
         │  Если тип файла 4 (Trash Bin):
         │    Сохранение идентификатора корзины (trashbin_id)
         │
    └───> Возврат данных о файлах
         │
    Конец
```

**Примеры**:

```python
mega = Mega.from_credentials('user@example.com', 'password')
files = mega.get_files()
```

### `download_from_url`

```python
def download_from_url(self, url: str) -> str:
    """
    Скачивает файл по публичной ссылке.

    Args:
        self (Mega): Экземпляр класса Mega.
        url (str): Публичная ссылка на файл.

    Returns:
        str: Имя скаченного файла.

    """
```

**Назначение**:
Скачивает файл из Mega по предоставленной публичной ссылке (URL).

**Параметры**:
- `self` (Mega): Экземпляр класса `Mega`.
- `url` (str): URL файла, который нужно скачать.

**Возвращает**:
- `str`: Имя скаченного файла.

**Как работает функция**:

1.  Разбирает URL, чтобы извлечь `file_id` и `file_key`.
2.  Вызывает функцию `self.download_file` с `file_id` и `file_key`, чтобы выполнить скачивание файла.
3.  Возвращает имя скаченного файла.

**Примеры**:

```python
mega = Mega()
file_name = mega.download_from_url('https://mega.nz/#!file_id!file_key')
```

### `download_file`

```python
def download_file(self, file_id: str, file_key: list, public: bool = False, store_path: str | None = None) -> str:
    """
    Скачивает файл из хранилища Mega.

    Args:
        self (Mega): Экземпляр класса Mega.
        file_id (str): Идентификатор файла.
        file_key (list): Ключ шифрования файла.
        public (bool): Флаг, указывающий, является ли файл публичным.
        store_path (str | None): Путь для сохранения файла.

    Returns:
        str: Имя скаченного файла.

    Raises:
        ValueError: Если MAC не совпадает.

    """
```

**Назначение**:
Скачивает файл из сервиса Mega с использованием предоставленного идентификатора файла и ключа шифрования.

**Параметры**:
- `self` (Mega): Экземпляр класса `Mega`.
- `file_id` (str): Идентификатор файла, который нужно скачать.
- `file_key` (list): Ключ шифрования файла.
- `public` (bool, optional): Указывает, является ли файл публичным. По умолчанию `False`.
- `store_path` (str | None, optional): Путь к директории, в которой нужно сохранить скачанный файл. Если `None`, файл сохраняется в текущей директории. По умолчанию `None`.

**Возвращает**:
- `str`: Имя скачанного файла.

**Вызывает исключения**:
- `ValueError`: Если MAC (Message Authentication Code) не совпадает, что указывает на повреждение файла при скачивании.

**Как работает функция**:

```ascii
    Начало
    │
    └───> Определение параметров API-запроса
         │  В зависимости от значения `public` формируется запрос на скачивание публичного или приватного файла
         │
    └───> Выполнение API-запроса для получения информации о файле (file_data)
         │
    └───> Извлечение ключей и параметров шифрования из `file_key`
         │
    └───> Получение URL файла и размера файла из `file_data`
         │
    └───> Декодирование атрибутов файла (имя файла)
         │
    └───> Определение имени выходного файла
         │  Если указан `store_path`, файл сохраняется в указанной директории
         │
    └───> Создание объектов для скачивания и расшифровки файла
         │  `infile`: Объект для скачивания файла по URL
         │  `outfile`: Объект для записи расшифрованного файла на диск
         │  `decryptor`: Объект для расшифровки файла с использованием AES в режиме CTR
         │
    └───> Скачивание и расшифровка файла по частям (chunks)
         │  Для каждой части файла:
         │    - Скачивание части файла
         │    - Расшифровка части файла
         │    - Запись расшифрованной части файла на диск
         │    - Вычисление MAC для проверки целостности данных
         │
    └───> Проверка целостности файла
         │  Сравнение вычисленного MAC с MAC, полученным из метаданных файла
         │  Если MAC не совпадает, вызывается исключение `ValueError`
         │
    └───> Закрытие выходного файла
         │
    └───> Возврат имени скачанного файла
         │
    Конец
```

**Примеры**:

```python
mega = Mega()
file_id = 'xxxxxxxx'
file_key = [1, 2, 3, 4, 5, 6, 7, 8]
file_name = mega.download_file(file_id, file_key)
```

### `get_public_url`

```python
def get_public_url(self, file_id: str, file_key: list) -> str:
    """
    Возвращает публичную ссылку на файл.

    Args:
        self (Mega): Экземпляр класса Mega.
        file_id (str): Идентификатор файла.
        file_key (list): Ключ шифрования файла.

    Returns:
        str: Публичная ссылка на файл.

    """
```

**Назначение**:
Создает и возвращает публичный URL для заданного файла в сервисе Mega.

**Параметры**:
- `self` (Mega): Экземпляр класса `Mega`.
- `file_id` (str): Идентификатор файла, для которого нужно получить публичный URL.
- `file_key` (list): Ключ шифрования файла.

**Возвращает**:
- `str`: Публичный URL для заданного файла.

**Как работает функция**:

1.  Делает API-запрос, чтобы получить публичный handle для файла.
2.  Кодирует ключ файла в base64.
3.  Формирует публичный URL, используя полученные значения.
4.  Возвращает публичный URL.

**Примеры**:

```python
mega = Mega()
file_id = 'xxxxxxxx'
file_key = [1, 2, 3, 4, 5, 6, 7, 8]
public_url = mega.get_public_url(file_id, file_key)
```

### `uploadfile`

```python
def uploadfile(self, filename: str, dst: str | None = None) -> dict:
    """
    Загружает файл в хранилище Mega.

    Args:
        self (Mega): Экземпляр класса Mega.
        filename (str): Путь к файлу для загрузки.
        dst (str | None): Идентификатор папки назначения.

    Returns:
        dict: Данные об загруженном файле.

    """
```

**Назначение**:
Загружает указанный файл в хранилище Mega.

**Параметры**:
- `self` (Mega): Экземпляр класса `Mega`.
- `filename` (str): Путь к файлу, который нужно загрузить.
- `dst` (str | None, optional): Идентификатор папки назначения в хранилище Mega. Если не указан, файл загружается в корневую папку. По умолчанию `None`.

**Возвращает**:
- `dict`: Словарь с данными о загруженном файле.

**Как работает функция**:

```ascii
    Начало
    │
    └───> Определение папки назначения (dst)
         │  Если `dst` не указан, определяется корневая папка
         │
    └───> Открытие файла для чтения (infile)
         │
    └───> Получение размера файла (size)
         │
    └───> Выполнение API-запроса для получения URL загрузки (ul_url)
         │
    └───> Генерация ключей шифрования (ul_key)
         │
    └───> Создание объектов для шифрования и загрузки файла
         │  `encryptor`: Объект для шифрования файла с использованием AES в режиме CTR
         │
    └───> Шифрование и загрузка файла по частям (chunks)
         │  Для каждой части файла:
         │    - Шифрование части файла
         │    - Выполнение POST-запроса для загрузки части файла по URL
         │
    └───> Вычисление MAC для проверки целостности данных
         │
    └───> Формирование метаданных файла (имя файла, атрибуты)
         │
    └───> Шифрование метаданных и ключей файла
         │
    └───> Выполнение API-запроса для завершения загрузки файла
         │
    └───> Возврат данных об загруженном файле
         │
    Конец
```

**Примеры**:

```python
mega = Mega.from_credentials('user@example.com', 'password')
file_path = '/path/to/file.txt'
destination_folder_id = 'xxxxxxxx'
upload_data = mega.uploadfile(file_path, destination_folder_id)