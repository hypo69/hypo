# Модуль `ChatgptLogin.py`

## Обзор

Модуль предоставляет функциональность для взаимодействия с сервисом ChatGPTLogin через их веб-интерфейс. Он содержит функции для создания запросов к ChatGPTLogin, получения nonce, преобразования сообщений и отправки запросов.

## Подробнее

Этот модуль используется для обхода авторизации и получения ответов от модели gpt-3.5-turbo через веб-сайт chatgptlogin.ac. Он выполняет запросы к API сайта, обрабатывает полученные данные и возвращает ответ.

## Функции

### `_create_completion`

```python
def _create_completion(model: str, messages: list, stream: bool, **kwargs):
    """
    Создает завершение (completion) для заданных параметров, имитируя запрос к ChatGPTLogin.

    Args:
        model (str): Имя модели.
        messages (list): Список сообщений для отправки.
        stream (bool): Флаг стриминга (не используется).
        **kwargs: Дополнительные аргументы.

    Returns:
        str: Ответ от ChatGPTLogin.
    """
```

**Как работает функция**:

1.  **Получение `nonce`**: Вызывает внутреннюю функцию `get_nonce` для получения уникального идентификатора nonce, необходимого для выполнения запроса.
2.  **Преобразование сообщений**: Вызывает внутреннюю функцию `transform` для преобразования списка сообщений в формат, ожидаемый API.
3.  **Формирование заголовков**: Создает заголовки HTTP-запроса, включая полученный `nonce`.
4.  **Формирование данных JSON**: Создает JSON-данные для отправки в теле запроса, включая преобразованные сообщения, параметры модели и прочую метаинформацию.
5.  **Отправка запроса**: Отправляет POST-запрос к API `chatgptlogin.ac` с сформированными заголовками и данными.
6.  **Обработка ответа**: Извлекает текст ответа из JSON-ответа и возвращает его.

**Внутренние функции**:

#### `get_nonce`

```python
def get_nonce():
    """
    Получает nonce с веб-сайта chatgptlogin.ac.

    Returns:
        str: Значение nonce.
    """
```

**Как работает функция**:

1.  **Выполнение GET-запроса**: Отправляет GET-запрос к странице `https://chatgptlogin.ac/use-chatgpt-free/` для получения HTML-содержимого.
2.  **Извлечение URL скрипта**: Использует регулярное выражение для поиска URL скрипта, содержащего nonce.
3.  **Декодирование URL**: Декодирует часть URL, закодированную в base64.
4.  **Извлечение nonce**: Извлекает значение nonce из декодированной строки с помощью регулярного выражения.
5.  **Возврат nonce**: Возвращает полученное значение nonce.

#### `transform`

```python
def transform(messages: list) -> list:
    """
    Преобразует список сообщений в формат, ожидаемый API chatgptlogin.ac.

    Args:
        messages (list): Список сообщений для преобразования.

    Returns:
        list: Преобразованный список сообщений.
    """
```

**Как работает функция**:

1.  **HTML-кодирование**: Определяет внутреннюю функцию `html_encode` для кодирования специальных символов в HTML-сущности.
2.  **Преобразование каждого сообщения**: Проходит по каждому сообщению в списке `messages` и создает новый словарь для каждого сообщения.
3.  **Добавление информации в словарь**: Добавляет идентификатор сообщения (`id`), роль (`role`), содержимое (`content`), информацию об авторе (`who`) и HTML-кодированное содержимое (`html`) в словарь.
4.  **Возврат преобразованного списка**: Возвращает новый список, содержащий преобразованные словари сообщений.

##### `html_encode`

```python
def html_encode(string: str) -> str:
    """
    Кодирует специальные символы в HTML-сущности.

    Args:
        string (str): Строка для кодирования.

    Returns:
        str: Кодированная строка.
    """
```

**Как работает функция**:

1.  **Определение таблицы замен**: Создает словарь `table`, содержащий соответствия между специальными символами и их HTML-сущностями.
2.  **Замена символов**: Проходит по каждому ключу в словаре `table` и заменяет все вхождения этого ключа в строке на соответствующее значение из словаря.
3.  **Возврат кодированной строки**: Возвращает строку с замененными символами.

**ASCII flowchart функции `_create_completion`**:

```
Получение сообщений
     ↓
Преобразование сообщений (transform)
     ↓
Получение nonce (get_nonce)
     ↓
Формирование заголовков HTTP-запроса
     ↓
Формирование JSON-данных
     ↓
Отправка POST-запроса к API chatgptlogin.ac
     ↓
Получение ответа
     ↓
Извлечение текста ответа из JSON
     ↓
Возврат текста ответа
```

**Примеры**:

```python
# Пример вызова функции _create_completion
response = _create_completion(
    model='gpt-3.5-turbo',
    messages=[
        {'role': 'user', 'content': 'Hello, how are you?'}
    ],
    stream=False
)
print(response)
```

```python
# Пример вызова функции _create_completion с дополнительными аргументами
response = _create_completion(
    model='gpt-3.5-turbo',
    messages=[
        {'role': 'user', 'content': 'Tell me a joke.'}
    ],
    stream=False,
    temperature=0.9
)
print(response)
```

### `params`

```python
params = f'g4f.Providers.{os.path.basename(__file__)[:-3]} supports: ' + \
    '(%s)' % ', '.join(
        [f"{name}: {get_type_hints(_create_completion)[name].__name__}" for name in _create_completion.__code__.co_varnames[:_create_completion.__code__.co_argcount]])
```

**Описание**:

Строка `params` формируется для предоставления информации о поддержке параметров функцией `_create_completion`. Она включает имя модуля и список поддерживаемых параметров с их типами.