# Модуль `emil_design.py`

## Обзор

Модуль `emil_design.py` предназначен для управления и обработки изображений, а также для продвижения товаров магазина `emil-design.com` на платформах Facebook и PrestaShop. Модуль включает в себя функции для описания изображений с использованием AI (Gemini), загрузки описаний продуктов в PrestaShop и продвижения контента в Facebook.

## Подробней

Этот модуль является ключевым компонентом системы автоматизации маркетинга для `emil-design.com`. Он использует AI для генерации описаний продуктов, автоматизирует процесс загрузки этих описаний в PrestaShop и упрощает публикацию контента в Facebook. Анализ кода позволяет понять, что основная цель - автоматизировать и улучшить процессы, связанные с продвижением продукции магазина.

## Классы

### `Config`

**Описание**: Класс `Config` предназначен для хранения и управления конфигурационными параметрами, необходимыми для работы с API PrestaShop.

**Принцип работы**:
Класс `Config` определяет различные параметры конфигурации, такие как `ENDPOINT`, `MODE`, `API_DOMAIN` и `API_KEY`. В зависимости от значения переменной окружения `USE_ENV` или параметра `MODE`, класс загружает значения параметров из переменных окружения или из `gs.credentials`. Это позволяет легко переключаться между различными окружениями (dev, dev8, prod) и использовать разные API-ключи и домены.

**Атрибуты**:
- `ENDPOINT` (str): Строковое значение, определяющее конечную точку API (`'emil'`).
- `MODE` (str): Строковое значение, определяющее режим работы (`'dev'`, `'dev8'` или `'prod'`).
- `POST_FORMAT` (str): Строковое значение, определяющее формат POST-запросов (`'XML'`).
- `API_DOMAIN` (str): Строковое значение, содержащее доменное имя API PrestaShop.
- `API_KEY` (str): Строковое значение, содержащее ключ API для доступа к PrestaShop.

### `EmilDesign`

**Описание**: Класс `EmilDesign` предназначен для проектирования и продвижения изображений через различные платформы, такие как PrestaShop и Facebook.

**Принцип работы**:
Класс `EmilDesign` содержит методы для описания изображений с использованием Gemini AI, продвижения этих изображений в Facebook и загрузки информации о продуктах в PrestaShop. Он использует другие классы, такие как `GoogleGenerativeAI`, `OpenAIModel`, `PrestaProduct`, `PrestaLanguage` и `ProductFields`, для выполнения этих задач.

**Атрибуты**:
- `gemini` (Optional[GoogleGenerativeAI]): Экземпляр класса `GoogleGenerativeAI` для генерации описаний изображений. Может быть `None`.
- `openai` (Optional[OpenAIModel]): Экземпляр класса `OpenAIModel` для генерации описаний изображений. Может быть `None`.
- `base_path` (Path): Объект `Path`, указывающий на базовый путь к файлам конфигурации и инструкциям (`gs.path.endpoints / Config.ENDPOINT`).
- `config` (SimpleNamespace): Объект `SimpleNamespace`, содержащий конфигурационные параметры, загруженные из JSON-файла (`emil.json`).
- `data_path` (Path): Объект `Path`, указывающий на путь к данным изображений и описаний (`getattr(gs.path, config.storage, 'external_storage') / Config.ENDPOINT`).
- `gemini_api` (str): Строковое значение, содержащее ключ API для доступа к Gemini AI.
- `presta_api` (str): Строковое значение, содержащее ключ API для доступа к PrestaShop.
- `presta_domain` (str): Строковое значение, содержащее доменное имя API PrestaShop.

**Методы**:
- `describe_images`: Описывает изображения на основе предоставленных инструкций и примеров.
- `promote_to_facebook`: Продвигает изображения и их описания в Facebook.
- `upload_described_products_to_prestashop`: Загружает информацию о продуктах в PrestaShop.

## Функции

### `describe_images`

```python
def describe_images(
    self,
    lang: str,
    models: dict = {
        'gemini': {'model_name': 'gemini-1.5-flash'},
        'openai': {'model_name': 'gpt-4o-mini', 'assistant_id': 'asst_uDr5aVY3qRByRwt5qFiMDk43'},
    },
) -> None:
    """Описывает изображения на основе предоставленных инструкций и примеров.

    Args:
        lang (str): Язык для описания.
        models (dict, optional): Конфигурация моделей. По умолчанию используются модели Gemini и OpenAI.

    Returns:
        None

    Raises:
        FileNotFoundError: Если файлы инструкций не найдены.
        Exception: Если возникает ошибка при обработке изображений.

    Example:
        >>> emil = EmilDesign()
        >>> emil.describe_images('he')
    """
    ...
```

**Назначение**: Метод `describe_images` предназначен для автоматического создания текстовых описаний изображений с использованием моделей машинного обучения, таких как Gemini и OpenAI. Он считывает изображения из указанной директории, генерирует описания на заданном языке и сохраняет результаты в JSON-файлы.

**Параметры**:
- `lang` (str): Язык, на котором должно быть сгенерировано описание изображения.
- `models` (dict, optional): Словарь, содержащий конфигурации моделей AI. По умолчанию включает конфигурации для Gemini и OpenAI.

**Возвращает**:
- `None`: Функция ничего не возвращает.

**Вызывает исключения**:
- `FileNotFoundError`: Возникает, если не удается найти файлы инструкций, необходимые для генерации описаний.
- `Exception`: Возникает при любых других ошибках во время обработки изображений, таких как проблемы с API или обработкой данных.

**Как работает функция**:

1. **Инициализация**: Функция начинается с определения путей к необходимым файлам инструкций и конфигураций, включая системные инструкции, примеры описаний и категории мебели.

2. **Подготовка данных**: Считываются системные инструкции и примеры описаний с использованием метода `read_text_file`. Также извлекается список уже обработанных изображений, чтобы избежать повторной обработки.

3. **Настройка моделей AI**: В зависимости от конфигурации, функция инициализирует модели Gemini или OpenAI для генерации описаний.

4. **Обработка изображений**: Функция итерируется по списку изображений для обработки. Для каждого изображения выполняется следующее:
   - Считываются необработанные данные изображения.
   - Вызывается метод `describe_image` у соответствующей модели AI для генерации описания.
   - Если описание успешно сгенерировано, оно сохраняется в JSON-файл.
   - Путь к обработанному изображению добавляется в список обработанных изображений.

5. **Обработка ошибок**: Если в процессе обработки возникают ошибки, они логируются с использованием `logger.error`.

6. **Завершение**: После обработки всех изображений функция завершает свою работу.

**Внутренние функции**:

Внутри функции `describe_images` не определены внутренние функции.

**ASCII flowchart**:

```
A[Подготовка инструкций и данных]
|
B[Инициализация моделей AI (Gemini/OpenAI)]
|
C[Цикл по изображениям для обработки]
|
D[Получение необработанных данных изображения]
|
E[Генерация описания изображения с использованием AI]
|
F[Сохранение описания в JSON-файл]
|
G[Обновление списка обработанных изображений]
|
H[Задержка между запросами]
|
I[Обработка ошибок]
|
J[Завершение]
```

**Примеры**:

```python
emil = EmilDesign()
emil.describe_images('he')
emil.describe_images(lang='en', models={'gemini': {'model_name': 'gemini-1.5-pro'}})
```

### `promote_to_facebook`

```python
async def promote_to_facebook(self) -> None:
    """Продвигает изображения и их описания в Facebook.

    Args:
        None

    Returns:
        None

    Raises:
        Exception: Если возникает ошибка во время продвижения в Facebook.
    """
    ...
```

**Назначение**: Метод `promote_to_facebook` предназначен для автоматической публикации изображений и их описаний в Facebook. Он использует веб-драйвер для авторизации в Facebook и отправки сообщений в указанную группу.

**Параметры**:
- `None`: Функция не принимает параметров.

**Возвращает**:
- `None`: Функция ничего не возвращает.

**Вызывает исключения**:
- `Exception`: Возникает при любых ошибках во время продвижения в Facebook, таких как проблемы с авторизацией или отправкой сообщений.

**Как работает функция**:

1. **Инициализация**: Функция начинается с инициализации веб-драйвера (Chrome) и открытия URL страницы Facebook.

2. **Загрузка сообщений**: Считываются сообщения, которые будут опубликованы в Facebook, из JSON-файла.

3. **Публикация сообщений**: Функция итерируется по списку сообщений и для каждого сообщения выполняет следующее:
   - Создается объект `SimpleNamespace` с информацией о сообщении, включая заголовок, описание и путь к изображению.
   - Вызывается функция `post_message` для отправки сообщения в Facebook.

4. **Обработка ошибок**: Если в процессе публикации возникают ошибки, они логируются с использованием `logger.error`.

5. **Завершение**: После публикации всех сообщений функция завершает свою работу.

**Внутренние функции**:

Внутри функции `promote_to_facebook` не определены внутренние функции.

**ASCII flowchart**:

```
A[Инициализация веб-драйвера (Chrome)]
|
B[Открытие URL страницы Facebook]
|
C[Загрузка сообщений из JSON-файла]
|
D[Цикл по сообщениям для публикации]
|
E[Создание объекта SimpleNamespace с информацией о сообщении]
|
F[Отправка сообщения в Facebook с использованием post_message]
|
G[Обработка ошибок]
|
H[Завершение]
```

**Примеры**:

```python
emil = EmilDesign()
asyncio.run(emil.promote_to_facebook())
```

### `upload_described_products_to_prestashop`

```python
def upload_described_products_to_prestashop(
    self, products_list: Optional[List[SimpleNamespace]] = None, id_lang: Optional[int | str] = 2, *args, **kwards
) -> bool:
    """Загружает информацию о продуктах в PrestaShop.

    Args:
        products_list (Optional[List[SimpleNamespace]], optional): Список информации о продуктах. По умолчанию None.
        id_lang (Optional[str], optional): Идентификатор языка для баз данных PrestaShop.
        Обычно я назначаю языки в таком порядке 1 - en;2 - he; 3 - ru.
        Важно проверить порядок языков в целевой базе данных.
        Вот образец кода для получения словаря языков из конкретной базы данных
        >>import language
        >>lang_class = PrestaLanguage()
        >>print(lang_class.get_languages_schema())

    Returns:
        bool: True, если загрузка прошла успешно, False в противном случае.

    Raises:
        FileNotFoundError: Если файл locales не найден.
        Exception: Если возникает ошибка во время загрузки в PrestaShop.
    """
    ...
```

**Назначение**: Метод `upload_described_products_to_prestashop` предназначен для загрузки информации о продуктах, включая их описания и изображения, в базу данных PrestaShop.

**Параметры**:
- `products_list` (Optional[List[SimpleNamespace]], optional): Список объектов `SimpleNamespace`, содержащих информацию о продуктах. Если не указан, функция попытается загрузить информацию из JSON-файлов в директории данных. По умолчанию `None`.
- `id_lang` (Optional[int | str], optional): Идентификатор языка, на котором будет загружена информация о продуктах. Обычно `1` для английского, `2` для иврита и `3` для русского. Важно проверить соответствие идентификаторов языкам в базе данных PrestaShop. По умолчанию `2`.

**Возвращает**:
- `bool`: `True`, если загрузка прошла успешно, `False` в противном случае.

**Вызывает исключения**:
- `FileNotFoundError`: Возникает, если не удается найти файл `locales.json`, содержащий соответствия между кодами языков и их идентификаторами.
- `Exception`: Возникает при любых других ошибках во время загрузки данных в PrestaShop, таких как проблемы с подключением к API или обработкой данных.

**Как работает функция**:

1. **Подготовка данных**:
   - Если `products_list` не предоставлен, функция пытается получить список JSON-файлов из директории `self.data_path` и загрузить данные продуктов из этих файлов.
   - Инициализируется объект `PrestaProduct` с использованием API-ключа и домена, полученных из конфигурации.

2. **Определение языка**:
   - Функция пытается определить идентификатор языка на основе параметра `id_lang`. Если `id_lang` является строкой (`'en'`, `'he'`, `'ru'`), она пытается получить соответствующий идентификатор из файла `locales.json`. Если `id_lang` является числом, оно используется напрямую.

3. **Загрузка продуктов**:
   - Функция итерируется по списку продуктов и для каждого продукта выполняет следующие действия:
     - Создается объект `ProductFields` и заполняются его поля на основе данных продукта.
     - Вызывается метод `add_new_product` объекта `PrestaProduct` для добавления продукта в PrestaShop.

4. **Обработка ошибок**:
   - Если возникает ошибка `FileNotFoundError` при загрузке файла `locales.json`, функция логирует ошибку и возвращает `False`.
   - Если возникает любая другая ошибка, функция логирует ошибку и возвращает `False`.

5. **Завершение**:
   - Если все продукты успешно загружены, функция возвращает `True`.

**Внутренние функции**:

Внутри функции `upload_described_products_to_prestashop` не определены внутренние функции.

**ASCII flowchart**:

```
A[Проверка products_list: загрузка данных из JSON, если не предоставлен]
|
B[Инициализация PrestaProduct]
|
C[Определение id_lang: из строки или числа]
|
D[Цикл по products_list]
|
E[Создание и заполнение ProductFields]
|
F[Добавление продукта в PrestaShop через p.add_new_product(f)]
|
G[Обработка FileNotFoundError (locales.json)]
|
H[Обработка общих ошибок]
|
I[Завершение: возврат True при успехе, False при ошибке]
```

**Примеры**:

```python
emil = EmilDesign()
emil.upload_described_products_to_prestashop(id_lang=2)
emil.upload_described_products_to_prestashop(id_lang='en')