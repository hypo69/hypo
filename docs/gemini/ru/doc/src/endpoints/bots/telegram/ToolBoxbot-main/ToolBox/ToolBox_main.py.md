# Модуль ToolBox_main

## Обзор

Модуль `ToolBox_main.py` является основным модулем для управления Telegram-ботом `ToolBoxbot`. Он содержит обработчики команд и событий, логику взаимодействия с базой данных пользователей, а также функциональность для обработки текстовых и графических запросов.

## Подробней

Этот модуль отвечает за прием и обработку сообщений от пользователей Telegram, управление их подписками, предоставление доступа к различным функциям бота (генерация текста и изображений), а также обработку платежей и промокодов. Он использует библиотеки `telebot`, `dotenv`, `dateutil`, `threading` и другие для обеспечения необходимой функциональности. Расположение файла в проекте `hypotez/src/endpoints/bots/telegram/ToolBoxbot-main/ToolBox/ToolBox_main.py` указывает на его роль как основного компонента Telegram-бота.

## Классы

В данном модуле классы отсутствуют.

## Функции

### `process_pre_checkout_query`

```python
def process_pre_checkout_query(pre_checkout_query):
    """
    Обрабатывает предварительный запрос на оплату от пользователя.

    Args:
        pre_checkout_query: Объект запроса на оплату.

    Returns:
        None

    Raises:
        None

    Example:
        # Пример использования внутри обработчика
        process_pre_checkout_query(pre_checkout_query)
    """
```

**Описание**: Подтверждает возможность проведения платежа, отправляя ответ `ok=True`.

**Параметры**:
- `pre_checkout_query`: Объект запроса на предварительную проверку оплаты.

**Возвращает**: Ничего.

**Вызывает исключения**: Отсутствуют.

**Примеры**:

```python
# Пример использования
@bot.pre_checkout_query_handler(func=lambda query: True)
def process_pre_checkout_query(pre_checkout_query):
    bot.answer_pre_checkout_query(pre_checkout_query.id, ok=True)
```

### `successful_payment`

```python
def successful_payment(message):
    """
    Обрабатывает успешный платеж от пользователя, обновляя его данные в базе данных.

    Args:
        message: Объект сообщения об успешном платеже.

    Returns:
        None

    Raises:
        None

    Example:
        # Пример использования внутри обработчика
        successful_payment(message)
    """
```

**Описание**: Обрабатывает успешный платеж, определяет тип подписки (basic или pro), начисляет токены и устанавливает дату окончания подписки.

**Параметры**:
- `message`: Объект сообщения об успешном платеже.

**Возвращает**: Ничего.

**Вызывает исключения**: Отсутствуют.

**Примеры**:

```python
# Пример использования
@bot.message_handler(content_types=['successful_payment'])
def successful_payment(message):
    # Обработка успешного платежа
    ...
```

### `StartProcessing`

```python
def StartProcessing(message):
    """
    Обрабатывает команду `/start`, инициализирует или обновляет данные пользователя в базе данных.

    Args:
        message: Объект сообщения с командой `/start`.

    Returns:
        None

    Raises:
        None

    Example:
        # Пример использования внутри обработчика
        StartProcessing(message)
    """
```

**Описание**: Обрабатывает команду `/start`, создает или обновляет запись о пользователе в базе данных, используя шаблон `DATA_PATTERN`.

**Параметры**:
- `message`: Объект сообщения, содержащий команду `/start`.

**Возвращает**: Ничего.

**Вызывает исключения**: Отсутствуют.

**Примеры**:

```python
# Пример использования
@bot.message_handler(commands=['start'])
def StartProcessing(message):
    # Обработка команды /start
    ...
```

### `personal_account`

```python
def personal_account(message):
    """
    Обрабатывает команду `/profile`, отображает информацию о подписке пользователя.

    Args:
        message: Объект сообщения с командой `/profile`.

    Returns:
        None

    Raises:
        None

    Example:
        # Пример использования внутри обработчика
        personal_account(message)
    """
```

**Описание**: Отображает информацию о текущей подписке пользователя (BASIC или PRO) или сообщает об отсутствии подписки.

**Параметры**:
- `message`: Объект сообщения, содержащий команду `/profile`.

**Возвращает**: Ничего.

**Вызывает исключения**: Отсутствуют.

**Примеры**:

```python
# Пример использования
@bot.message_handler(commands=['profile'])
def personal_account(message):
    # Отображение информации о подписке пользователя
    ...
```

### `show_stat`

```python
def show_stat(message):
    """
    Отображает статистику бота (количество пользователей и пользователей с промокодом) для администраторов.

    Args:
        message: Объект сообщения с командой `/stat`.

    Returns:
        None

    Raises:
        None

    Example:
        # Пример использования внутри обработчика
        show_stat(message)
    """
```

**Описание**: Показывает статистику бота, такую как общее количество пользователей и количество пользователей, использовавших промокод. Доступно только для определенных ID пользователей.

**Параметры**:
- `message`: Объект сообщения с командой `/stat`.

**Возвращает**: Ничего.

**Вызывает исключения**: Отсутствуют.

**Примеры**:

```python
# Пример использования
@bot.message_handler(commands=['stat'])
def show_stat(message):
    # Отображение статистики бота
    ...
```

### `generate_promo_code`

```python
def generate_promo_code(length):
    """
    Генерирует случайный промокод заданной длины.

    Args:
        length: Длина промокода.

    Returns:
        str: Сгенерированный промокод.

    Raises:
        None

    Example:
        # Пример использования
        promo_code = generate_promo_code(10)
        print(f"Сгенерированный промокод: {promo_code}")
    """
```

**Описание**: Генерирует промокод заданной длины, используя случайные буквы и цифры.

**Параметры**:
- `length`: Длина генерируемого промокода.

**Возвращает**:
- `str`: Сгенерированный промокод.

**Вызывает исключения**: Отсутствуют.

**Примеры**:

```python
# Пример использования
promo_code = generate_promo_code(10)
print(f"Сгенерированный промокод: {promo_code}")
```

### `CallsProcessing`

```python
def CallsProcessing(call):
    """
    Обрабатывает callback-запросы от нажатия на кнопки в боте.

    Args:
        call: Объект callback-запроса.

    Returns:
        None

    Raises:
        None

    Example:
        # Пример использования внутри обработчика
        CallsProcessing(call)
    """
```

**Описание**: Обрабатывает callback-запросы от нажатия на кнопки в боте, управляет различными сценариями, такими как выбор типа текста, размера изображения, тарифа и т.д.

**Параметры**:
- `call`: Объект callback-запроса.

**Возвращает**: Ничего.

**Вызывает исключения**: Отсутствуют.

**Примеры**:

```python
# Пример использования
@bot.callback_query_handler(func=lambda call: True)
def CallsProcessing(call):
    # Обработка callback-запросов
    ...
```

### `TokensCancelletionPattern`

```python
def TokensCancelletionPattern(user_id: str, func, message, i: int = None) -> None:
    """
    Проверяет наличие токенов у пользователя и выполняет функцию генерации контента, списывая токены.

    Args:
        user_id (str): ID пользователя.
        func: Функция для генерации контента.
        message: Объект сообщения пользователя.
        i (int, optional): Индекс для текстовых команд. Defaults to None.

    Returns:
        None

    Raises:
        None

    Example:
        # Пример использования
        TokensCancelletionPattern(user_id, tb.TextCommands, message, i=0)
    """
```

**Описание**: Проверяет наличие токенов или бесплатных запросов у пользователя и выполняет функцию генерации контента, списывая токены или уменьшая количество бесплатных запросов.

**Параметры**:
- `user_id` (str): ID пользователя.
- `func`: Функция для генерации контента.
- `message`: Объект сообщения пользователя.
- `i` (int, optional): Индекс для текстовых команд. По умолчанию `None`.

**Возвращает**: Ничего.

**Вызывает исключения**: Отсутствуют.

**Примеры**:

```python
# Пример использования
TokensCancelletionPattern(user_id, tb.TextCommands, message, i=0)
```

### `TasksProcessing`

```python
def TasksProcessing(message):
    """
    Обрабатывает текстовые сообщения и фотографии, выполняет задачи генерации текста и изображений.

    Args:
        message: Объект сообщения пользователя.

    Returns:
        None

    Raises:
        None

    Example:
        # Пример использования внутри обработчика
        TasksProcessing(message)
    """
```

**Описание**: Обрабатывает текстовые сообщения и фотографии, выполняет задачи генерации текста и изображений в зависимости от состояния пользователя и его запросов.

**Параметры**:
- `message`: Объект сообщения пользователя.

**Возвращает**: Ничего.

**Вызывает исключения**: Отсутствуют.

**Примеры**:

```python
# Пример использования
@bot.message_handler(func=lambda message: True, content_types=['text', 'photo'])
def TasksProcessing(message):
    # Обработка текстовых сообщений и фотографий
    ...
```

### `end_check_tariff_time`

```python
async def end_check_tariff_time():
    """
    Проверяет время окончания действия тарифа у пользователей и сбрасывает их статус, если время истекло.

    Args:
        None

    Returns:
        None

    Raises:
        None

    Example:
        # Пример использования
        asyncio.run(end_check_tariff_time())
    """
```

**Описание**: Асинхронная функция, которая периодически проверяет время окончания действия тарифа у пользователей и сбрасывает их статус, если время истекло.

**Параметры**: Отсутствуют.

**Возвращает**: Ничего.

**Вызывает исключения**: Отсутствуют.

**Примеры**:

```python
# Пример использования
asyncio.run(end_check_tariff_time())
```