# Модуль `tinytroupe.control`

## Обзор

Данный модуль предоставляет инструменты для управления симуляцией, включая инициализацию, завершение, сохранение состояния (через чекпоинты), добавление агентов, сред и фабрик.  Реализована система кэширования состояния симуляции для повышения производительности при повторном выполнении.  Также модуль поддерживает транзакционный контроль.

## Классы

### `Simulation`

**Описание**: Класс `Simulation` представляет собой контроллер для управления симуляцией. Он отвечает за инициализацию, завершение, кэширование и транзакционный контроль.

**Атрибуты**:

- `id` (str): Идентификатор симуляции.
- `agents` (list): Список агентов в симуляции.
- `name_to_agent` (dict): Словарь, сопоставляющий имя агента его объекту.
- `environments` (list): Список сред в симуляции.
- `name_to_environment` (dict): Словарь, сопоставляющий имя среды ее объекту.
- `factories` (list): Список фабрик в симуляции.
- `name_to_factory` (dict): Словарь, сопоставляющий имя фабрики ее объекту.
- `status` (str): Текущий статус симуляции ("stopped" или "started").
- `cache_path` (str): Путь к файлу кэша.
- `auto_checkpoint` (bool): Автоматически ли сохранять состояние после каждой транзакции.
- `has_unsaved_cache_changes` (bool): Есть ли несохраненные изменения в кэше.
- `cached_trace` (list): История состояний симуляции, кэшированная для повторного воспроизведения.
- `execution_trace` (list): Текущая история состояний симуляции.
- `_under_transaction` (bool): Флаг, указывающий, находится ли симуляция в транзакции.

**Методы**:

- `__init__(self, id="default", cached_trace: list = None)`: Инициализирует объект `Simulation`.
- `begin(self, cache_path: str = None, auto_checkpoint: bool = False)`: Инициализирует симуляцию.
- `end(self)`: Завершает симуляцию и сохраняет состояние.
- `checkpoint(self)`: Сохраняет текущее состояние симуляции в файл кэша.
- `add_agent(self, agent)`: Добавляет агента в симуляцию.
- `add_environment(self, environment)`: Добавляет среду в симуляцию.
- `add_factory(self, factory)`: Добавляет фабрику в симуляцию.
- `_execution_trace_position(self) -> int`: Возвращает текущую позицию в истории выполнения.
- `_function_call_hash(self, function_name, *args, **kwargs) -> int`: Вычисляет хеш для вызова функции.
- `_skip_execution_with_cache(self)`: Пропускает выполнение текущей операции, если она уже кэширована.
- `_is_transaction_event_cached(self, event_hash) -> bool`: Проверяет, кэширована ли заданная операция.
- `_drop_cached_trace_suffix(self)`: Обрезает кэшированную историю выполнения.
- `_add_to_execution_trace(self, state: dict, event_hash: int, event_output)`: Добавляет состояние в историю выполнения.
- `_add_to_cache_trace(self, state: dict, event_hash: int, event_output)`: Добавляет состояние в кэшированную историю.
- `_load_cache_file(self, cache_path: str)`: Загружает кэшированную историю из файла.
- `_save_cache_file(self, cache_path: str)`: Сохраняет кэшированную историю в файл.
- `begin_transaction(self)`: Начинает транзакцию.
- `end_transaction(self)`: Завершает транзакцию.
- `is_under_transaction(self)`: Проверяет, находится ли симуляция в транзакции.
- `_clear_communications_buffers(self)`: Очищает буферы сообщений агентов и сред.
- `_encode_simulation_state(self) -> dict`: Кодирует текущее состояние симуляции.
- `_decode_simulation_state(self, state: dict)`: Декодирует полученное состояние симуляции.


### `Transaction`

**Описание**: Класс `Transaction` управляет транзакциями в симуляции, поддерживая кэширование и выполнение операций.

**Методы**:

- `__init__(self, obj_under_transaction, simulation, function, *args, **kwargs)`: Инициализирует объект `Transaction`.
- `execute(self)`: Выполняет заданную функцию в транзакционном контексте.
- `_encode_function_output(self, output) -> dict`: Кодирует выходные данные функции для кэширования.
- `_decode_function_output(self, encoded_output: dict)`: Декодирует выходные данные функции из кэша.

###  `SkipTransaction`, `CacheOutOfSync`, `ExecutionCached`

**Описание**: Исключения, используемые для управления ситуациями, когда операция пропущена из-за кэширования или из-за ошибки синхронизации.


## Функции

### `reset()`

**Описание**: Сбрасывает состояние всего управления симуляцией.


### `_simulation(id="default")`

**Описание**: Возвращает объект `Simulation` по заданному идентификатору или создает новый, если его нет.


### `begin(cache_path=None, id="default", auto_checkpoint=False)`

**Описание**: Начинает управление симуляцией.


### `end(id="default")`

**Описание**: Завершает управление симуляцией.


### `checkpoint(id="default")`

**Описание**: Сохраняет текущее состояние симуляции.


### `current_simulation()`

**Описание**: Возвращает текущую симуляцию.


### `transactional(func)`

**Описание**: Декоратор, который делает функцию транзакционной, используя механизмы кэширования и контроля.

##  Дополнительные заметки

Модуль использует декоратор `@transactional` для обеспечения транзакционного управления.  При добавлении агентов, сред и фабрик в симуляцию, они автоматически добавляются в соответствующие списки и словари.  Внутри `Simulation` реализованы методы для кодирования и декодирования состояний симуляции, агентов, сред и фабрик. Этот механизм используется для кэширования и восстановления состояний во время транзакций.