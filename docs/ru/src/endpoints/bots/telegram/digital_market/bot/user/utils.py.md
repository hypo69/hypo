# Модуль с логикой успешной оплаты

## Обзор

Модуль `utils.py` содержит функцию `successful_payment_logic`, которая обрабатывает логику после успешной оплаты товара пользователем.  Функция добавляет информацию о покупке в базу данных, отправляет уведомления администраторам и предоставляет пользователю информацию о приобретенном товаре. Этот модуль важен для обеспечения функциональности покупок в Telegram-боте.

## Подробней

Этот модуль содержит логику, выполняемую после успешной оплаты.  Он отвечает за регистрацию покупки в базе данных, уведомление администраторов о новой покупке и предоставление пользователю информации о приобретенном товаре.  Функция использует данные о платеже, информацию о продукте и настройки бота для выполнения этих задач.

## Функции

### `successful_payment_logic`

```python
async def successful_payment_logic(session: AsyncSession, payment_data, currency, user_tg_id, bot: Bot):
    """
    Обрабатывает логику после успешной оплаты товара пользователем.

    Args:
        session (AsyncSession): Сессия базы данных SQLAlchemy.
        payment_data (dict): Словарь с данными о платеже.
        currency (str): Валюта платежа.
        user_tg_id (int): Telegram ID пользователя.
        bot (Bot): Экземпляр бота aiogram.

    Returns:
        None

    Raises:
        Exception: Если возникает ошибка при отправке уведомления администраторам.

    Example:
        Пример вызова функции
    """
```

**Как работает функция**:
1.  Извлекает данные о продукте, цене, типе платежа, ID платежа и ID пользователя из `payment_data`.
2.  Добавляет информацию о покупке в базу данных с использованием `PurchaseDao.add`.
3.  Получает данные о продукте из базы данных с использованием `ProductDao.find_one_or_none_by_id`.
4.  Отправляет уведомления администраторам о новой покупке, используя `bot.send_message`.  В случае ошибки логирует её с помощью `logger.error`.
5.  Формирует текст сообщения для пользователя с информацией о приобретенном товаре.
6.  Отправляет пользователю информацию о товаре, либо в виде документа (если товар включает файл), либо в виде текстового сообщения, используя `bot.send_document` или `bot.send_message` соответственно.  В обоих случаях прикрепляется основная клавиатура пользователя.
7.  Если тип платежа - `stars`, инициирует возврат звезд за покупку с помощью `bot.refund_star_payment`.

**Параметры**:

*   `session` (AsyncSession):  Сессия базы данных SQLAlchemy для выполнения операций с базой данных.
*   `payment_data` (dict):  Словарь, содержащий информацию о платеже, такую как ID продукта, цена, тип платежа, ID платежа и ID пользователя.
*   `currency` (str):  Строка, представляющая валюту, в которой был произведен платеж.
*   `user_tg_id` (int):  Целочисленный ID пользователя в Telegram.
*   `bot` (Bot):  Экземпляр бота aiogram, используемый для отправки сообщений и документов пользователю и администраторам.

**Возвращает**:

*   `None`:  Функция ничего не возвращает явно.

**Вызывает исключения**:

*   `Exception`:  Может возникнуть при отправке уведомления администраторам. Ошибка логируется с использованием `logger.error`.