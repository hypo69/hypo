# Модуль для работы с каталогом товаров в Telegram боте
======================================================

Модуль содержит роутер `catalog_router`, который обрабатывает запросы, связанные с каталогом товаров в Telegram боте.
Он включает в себя обработку выбора категорий, отображение товаров, а также организацию процесса покупки через различные платежные системы.

## Обзор

Этот модуль является частью Telegram-бота и отвечает за отображение каталога товаров, обработку выбора категорий и организацию процесса покупки.

## Подробней

Модуль `catalog_router.py` отвечает за обработку запросов пользователей, связанных с просмотром каталога товаров, выбором конкретного товара и его покупкой. Он использует библиотеку `aiogram` для работы с Telegram API и взаимодействует с базой данных через DAO (Data Access Object) для получения информации о категориях и товарах.
Модуль также включает в себя интеграцию с различными платежными системами, такими как ЮKassa, Robokassa и оплата звездами (внутренняя валюта).
Расположение этого файла в проекте `hypotez` указывает на его роль в обработке пользовательских запросов, связанных с каталогом цифрового магазина в Telegram.

## Классы

В данном модуле классы отсутствуют.

## Функции

### `page_catalog`

```python
async def page_catalog(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Отображает каталог товаров в Telegram боте.

    Args:
        call (CallbackQuery): Объект CallbackQuery, содержащий информацию о нажатой кнопке.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных без коммита.

    Returns:
        None

    Raises:
        Exception: Если не удается удалить предыдущее сообщение.

    Как работает функция:
    1. Отвечает на callback запрос с текстом "Загрузка каталога...".
    2. Пытается удалить предыдущее сообщение пользователя.
    3. Получает список всех категорий товаров из базы данных.
    4. Отправляет пользователю сообщение со списком категорий, используя клавиатуру `catalog_kb`.

    ASCII Flowchart:
    A[Получение CallbackQuery] --> B[Ответ "Загрузка каталога..."]
    B --> C{Удаление предыдущего сообщения}
    C -- Да --> D[Получение категорий из БД]
    C -- Нет --> D
    D --> E[Отправка сообщения с категориями и клавиатурой]
    """
```

**Параметры**:
- `call` (CallbackQuery): Объект, содержащий информацию о callback-запросе от пользователя.
- `session_without_commit` (AsyncSession): Асинхронная сессия для работы с базой данных (без сохранения изменений).

**Возвращает**:
- `None`

**Вызывает исключения**:
- `Exception`: Возникает, если не удается удалить предыдущее сообщение пользователя.

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически при нажатии кнопки в Telegram)
# await page_catalog(call, session_without_commit)
```

### `page_catalog_products`

```python
async def page_catalog_products(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Отображает товары выбранной категории.

    Args:
        call (CallbackQuery): Объект CallbackQuery, содержащий информацию о нажатой кнопке.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных без коммита.

    Returns:
        None

    Как работает функция:
    1. Извлекает ID категории из данных callback запроса.
    2. Получает список товаров, принадлежащих к этой категории, из базы данных.
    3. Подсчитывает количество товаров в категории.
    4. Если товары есть, отвечает на callback запрос с количеством товаров и отправляет сообщение для каждого товара, содержащее информацию о товаре и клавиатуру `product_kb`.
    5. Если товаров нет, отвечает на callback запрос сообщением "В данной категории нет товаров."

    ASCII Flowchart:
    A[Получение CallbackQuery] --> B[Извлечение ID категории]
    B --> C[Получение товаров из БД по ID категории]
    C --> D[Подсчет количества товаров]
    D -- Товары есть --> E[Ответ с количеством товаров]
    E --> F[Цикл по товарам]
    F --> G[Формирование текста сообщения о товаре]
    G --> H[Отправка сообщения о товаре с клавиатурой]
    F -- Конец цикла --> I
    D -- Товаров нет --> J[Ответ "В данной категории нет товаров."]
    """
```

**Параметры**:
- `call` (CallbackQuery): Объект, содержащий информацию о callback-запросе от пользователя.
- `session_without_commit` (AsyncSession): Асинхронная сессия для работы с базой данных (без сохранения изменений).

**Возвращает**:
- `None`

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически при нажатии кнопки в Telegram)
# await page_catalog_products(call, session_without_commit)
```

### `process_about`

```python
async def process_about(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обрабатывает запрос на покупку товара.

    Args:
        call (CallbackQuery): Объект CallbackQuery, содержащий информацию о нажатой кнопке.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных без коммита.

    Returns:
        None

    Как работает функция:
    1. Получает информацию о пользователе из базы данных.
    2. Извлекает тип платежа, ID продукта и цену из данных callback запроса.
    3. В зависимости от типа платежа вызывает соответствующую функцию для отправки инвойса (счета) на оплату.
       - `yukassa`: `send_yukassa_invoice`
       - `stars`: `send_stars_invoice`
       - `robocassa`: `send_robocassa_invoice`
    4. Удаляет сообщение пользователя.

    ASCII Flowchart:
    A[Получение CallbackQuery] --> B[Получение информации о пользователе из БД]
    B --> C[Извлечение типа платежа, ID продукта и цены]
    C --> D{Выбор типа платежа}
    D -- yukassa --> E[Отправка инвойса ЮKassa]
    D -- stars --> F[Отправка инвойса stars]
    D -- robocassa --> G[Отправка инвойса Robocassa]
    E, F, G --> H[Удаление сообщения пользователя]
    """
```

**Параметры**:
- `call` (CallbackQuery): Объект, содержащий информацию о callback-запросе от пользователя.
- `session_without_commit` (AsyncSession): Асинхронная сессия для работы с базой данных (без сохранения изменений).

**Возвращает**:
- `None`

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически при нажатии кнопки в Telegram)
# await process_about(call, session_without_commit)
```

### `send_yukassa_invoice`

```python
async def send_yukassa_invoice(call, user_info, product_id, price):
    """
    Отправляет инвойс для оплаты через ЮKassa.

    Args:
        call (CallbackQuery): Объект CallbackQuery, содержащий информацию о нажатой кнопке.
        user_info: Информация о пользователе.
        product_id: ID продукта.
        price: Цена товара.

    Returns:
        None

    Как работает функция:
    1. Отправляет инвойс (счет) пользователю через Telegram Bot API.
    2. Устанавливает параметры инвойса, такие как ID чата, заголовок, описание, payload (полезная нагрузка), токен провайдера, валюта и цена.
    3. Использует клавиатуру `get_product_buy_youkassa` для отображения кнопок оплаты.

    ASCII Flowchart:
    A[Получение параметров] --> B[Отправка инвойса через Telegram Bot API]
    B --> C[Установка параметров инвойса]
    C --> D[Использование клавиатуры get_product_buy_youkassa]
    """
```

**Параметры**:
- `call` (CallbackQuery): Объект, содержащий информацию о callback-запросе от пользователя.
- `user_info`: Информация о пользователе.
- `product_id`: ID продукта.
- `price`: Цена товара.

**Возвращает**:
- `None`

**Примеры**:
```python
# Пример вызова функции
# await send_yukassa_invoice(call, user_info, product_id, price)
```

### `send_robocassa_invoice`

```python
async def send_robocassa_invoice(call, user_info, product_id, price, session: AsyncSession):
    """
    Отправляет ссылку для оплаты через Robokassa.

    Args:
        call (CallbackQuery): Объект CallbackQuery, содержащий информацию о нажатой кнопке.
        user_info: Информация о пользователе.
        product_id: ID продукта.
        price: Цена товара.
        session (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных.

    Returns:
        None

    Как работает функция:
    1. Получает следующий доступный ID для покупки из базы данных.
    2. Формирует текст и описание для платежа.
    3. Генерирует ссылку для оплаты через Robokassa с использованием функции `generate_payment_link`.
    4. Использует клавиатуру `get_product_buy_robocassa` для отображения кнопки оплаты со ссылкой.
    5. Отправляет пользователю сообщение с текстом и клавиатурой.

    ASCII Flowchart:
    A[Получение параметров] --> B[Получение следующего ID для покупки из БД]
    B --> C[Формирование текста и описания платежа]
    C --> D[Генерация ссылки для оплаты через Robokassa]
    D --> E[Использование клавиатуры get_product_buy_robocassa]
    E --> F[Отправка сообщения с текстом и клавиатурой]
    """
```

**Параметры**:
- `call` (CallbackQuery): Объект, содержащий информацию о callback-запросе от пользователя.
- `user_info`: Информация о пользователе.
- `product_id`: ID продукта.
- `price`: Цена товара.
- `session` (AsyncSession): Асинхронная сессия для работы с базой данных.

**Возвращает**:
- `None`

**Примеры**:
```python
# Пример вызова функции
# await send_robocassa_invoice(call, user_info, product_id, price, session)
```

### `send_stars_invoice`

```python
async def send_stars_invoice(call, user_info, product_id, stars_price):
    """
    Отправляет инвойс для оплаты звездами (внутренняя валюта).

    Args:
        call (CallbackQuery): Объект CallbackQuery, содержащий информацию о нажатой кнопке.
        user_info: Информация о пользователе.
        product_id: ID продукта.
        stars_price: Цена товара в звездах.

    Returns:
        None

    Как работает функция:
    1. Отправляет инвойс (счет) пользователю через Telegram Bot API.
    2. Устанавливает параметры инвойса, такие как ID чата, заголовок, описание, payload (полезная нагрузка), токен провайдера (пустой), валюта (XTR) и цена.
    3. Использует клавиатуру `get_product_buy_stars` для отображения кнопок оплаты звездами.

    ASCII Flowchart:
    A[Получение параметров] --> B[Отправка инвойса через Telegram Bot API]
    B --> C[Установка параметров инвойса]
    C --> D[Использование клавиатуры get_product_buy_stars]
    """
```

**Параметры**:
- `call` (CallbackQuery): Объект, содержащий информацию о callback-запросе от пользователя.
- `user_info`: Информация о пользователе.
- `product_id`: ID продукта.
- `stars_price`: Цена товара в звездах.

**Возвращает**:
- `None`

**Примеры**:
```python
# Пример вызова функции
# await send_stars_invoice(call, user_info, product_id, stars_price)
```

### `pre_checkout_query`

```python
async def pre_checkout_query(pre_checkout_q: PreCheckoutQuery):
    """
    Обрабатывает предварительный запрос перед оплатой.

    Args:
        pre_checkout_q (PreCheckoutQuery): Объект PreCheckoutQuery, содержащий информацию о предварительном запросе.

    Returns:
        None

    Как работает функция:
    1. Отвечает на предварительный запрос перед оплатой, подтверждая возможность проведения платежа.
    2. Всегда возвращает `ok=True`.

    ASCII Flowchart:
    A[Получение PreCheckoutQuery] --> B[Ответ на запрос с ok=True]
    """
```

**Параметры**:
- `pre_checkout_q` (PreCheckoutQuery): Объект, содержащий информацию о предварительном запросе перед оплатой.

**Возвращает**:
- `None`

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически при запросе на оплату в Telegram)
# await pre_checkout_query(pre_checkout_q)
```

### `successful_payment`

```python
async def successful_payment(message: Message, session_with_commit: AsyncSession):
    """
    Обрабатывает успешную оплату.

    Args:
        message (Message): Объект Message, содержащий информацию об успешной оплате.
        session_with_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных с возможностью коммита.

    Returns:
        None

    Как работает функция:
    1. Получает информацию об оплате из сообщения.
    2. Извлекает тип платежа, ID пользователя и ID продукта из `invoice_payload`.
    3. Определяет цену и валюту в зависимости от типа платежа (`stars` или другая валюта).
    4. Формирует словарь с данными об оплате.
    5. Вызывает функцию `successful_payment_logic` для обработки логики успешной оплаты.

    ASCII Flowchart:
    A[Получение Message] --> B[Получение информации об оплате]
    B --> C[Извлечение типа платежа, ID пользователя и ID продукта]
    C --> D{Выбор типа платежа}
    D -- stars --> E[Установка цены и валюты для stars]
    D -- другая --> F[Установка цены и валюты для другой валюты]
    E, F --> G[Формирование словаря с данными об оплате]
    G --> H[Вызов successful_payment_logic]
    """
```

**Параметры**:
- `message` (Message): Объект, содержащий информацию об успешной оплате.
- `session_with_commit` (AsyncSession): Асинхронная сессия для работы с базой данных (с сохранением изменений).

**Возвращает**:
- `None`

**Примеры**:
```python
# Пример вызова функции (обычно вызывается автоматически при получении сообщения об успешной оплате)
# await successful_payment(message, session_with_commit)