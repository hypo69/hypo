# Модуль `FreeGpt`

## Обзор

Модуль `FreeGpt` предоставляет асинхронный генератор для взаимодействия с API `freegptsnav.aifree.site`. Он поддерживает историю сообщений и системные сообщения, а также предоставляет возможность выбора модели, такой как `gemini-1.5-pro` или `gemini-1.5-flash`.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для интеграции с различными AI-моделями через API `freegptsnav.aifree.site`. Он использует асинхронные запросы для генерации текста на основе предоставленных сообщений. Модуль обрабатывает возможные ошибки, такие как достижение лимита запросов, и предоставляет гибкие настройки для работы с прокси и таймаутами.

## Классы

### `FreeGpt`

**Описание**: Класс `FreeGpt` предоставляет методы для взаимодействия с API `freegptsnav.aifree.site` и генерации текста на основе предоставленных сообщений.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных генераторов.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями.

**Атрибуты**:
- `url` (str): URL для доступа к API `freegptsnav.aifree.site`.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений.
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения.
- `default_model` (str): Модель, используемая по умолчанию (`gemini-1.5-pro`).
- `models` (List[str]): Список поддерживаемых моделей (`gemini-1.5-pro`, `gemini-1.5-flash`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для генерации текста на основе предоставленных сообщений.
- `_build_request_data`: Создает словарь с данными запроса для API.

#### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: Optional[str] = None,
    timeout: int = 120,
    **kwargs: Any
) -> AsyncGenerator[str, None]:
    """Создает асинхронный генератор для генерации текста на основе предоставленных сообщений.

    Args:
        model (str): Название используемой модели.
        messages (Messages): Список сообщений для генерации текста.
        proxy (Optional[str], optional): Прокси-сервер для использования. По умолчанию `None`.
        timeout (int, optional): Время ожидания запроса в секундах. По умолчанию `120`.
        **kwargs (Any): Дополнительные аргументы.

    Returns:
        AsyncGenerator[str, None]: Асинхронный генератор, возвращающий сгенерированный текст.

    Raises:
        RateLimitError: Если достигнут лимит запросов.
        Exception: Если возникает ошибка при выполнении запроса.
    """
```

**Назначение**: Метод `create_async_generator` создает и возвращает асинхронный генератор, который отправляет запросы к API `freegptsnav.aifree.site` и выдает сгенерированный текст по частям.

**Параметры**:
- `model` (str): Название модели, используемой для генерации текста.
- `messages` (Messages): Список сообщений, используемых для генерации текста.
- `proxy` (Optional[str], optional): Прокси-сервер для использования при отправке запросов. По умолчанию `None`.
- `timeout` (int, optional): Максимальное время ожидания ответа от сервера в секундах. По умолчанию `120`.
- `**kwargs` (Any): Дополнительные параметры, которые могут быть переданы в функцию.

**Возвращает**:
- `AsyncGenerator[str, None]`: Асинхронный генератор, который выдает сгенерированный текст по частям.

**Вызывает исключения**:
- `RateLimitError`: Вызывается, если достигнут лимит запросов к API.
- `Exception`: Вызывается при возникновении других ошибок во время выполнения запроса.

**Как работает функция**:
1. **Извлечение данных**: Извлекает последнее сообщение из списка сообщений для использования в запросе.
2. **Получение временной метки**: Генерирует текущую временную метку, которая используется для подписи запроса.
3. **Создание данных запроса**: Вызывает метод `_build_request_data` для создания словаря с данными запроса, включая сообщения, временную метку и подпись.
4. **Выбор домена**: Случайно выбирает домен из списка доступных доменов.
5. **Создание асинхронной сессии**: Создает асинхронную сессию с использованием `StreamSession` для выполнения запросов.
6. **Отправка POST-запроса**: Отправляет POST-запрос к API с использованием выбранного домена и данных запроса.
7. **Обработка ответа**: Итерируется по содержимому ответа, декодирует его и выдает по частям через генератор.
8. **Обработка ошибок**: Проверяет наличие сообщения об ошибке, связанной с лимитом запросов, и вызывает исключение `RateLimitError` в случае необходимости.

```
A: Извлечение данных и получение временной метки
|
-- B: Создание данных запроса
|
C: Выбор домена
|
D: Создание асинхронной сессии
|
E: Отправка POST-запроса
|
F: Обработка ответа и выдача сгенерированного текста
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from typing import List, Dict

async def main():
    model = "gemini-1.5-pro"
    messages: List[Dict[str, str]] = [{"role": "user", "content": "Привет, как дела?"}]
    proxy = None
    timeout = 120

    generator = FreeGpt.create_async_generator(model=model, messages=messages, proxy=proxy, timeout=timeout)

    async for chunk in await generator:
        print(chunk, end="")

if __name__ == "__main__":
    asyncio.run(main())
```

#### `_build_request_data`

```python
@staticmethod
def _build_request_data(messages: Messages, prompt: str, timestamp: int, secret: str = "") -> Dict[str, Any]:
    """Создает словарь с данными запроса для API.

    Args:
        messages (Messages): Список сообщений для генерации текста.
        prompt (str): Последнее сообщение пользователя.
        timestamp (int): Временная метка для подписи запроса.
        secret (str, optional): Секретный ключ для подписи запроса. По умолчанию "".

    Returns:
        Dict[str, Any]: Словарь с данными запроса.
    """
```

**Назначение**: Метод `_build_request_data` создает словарь с данными запроса, который включает сообщения, временную метку, и подпись, сгенерированную на основе временной метки, сообщения и секретного ключа.

**Параметры**:
- `messages` (Messages): Список сообщений, используемых для генерации текста.
- `prompt` (str): Последнее сообщение пользователя.
- `timestamp` (int): Временная метка, используемая для подписи запроса.
- `secret` (str, optional): Секретный ключ, используемый для подписи запроса. По умолчанию "".

**Возвращает**:
- `Dict[str, Any]`: Словарь с данными запроса, включающий сообщения, временную метку и подпись.

**Как работает функция**:
1. **Создание данных**: Формирует словарь, содержащий сообщения, временную метку, `pass` (установлен в `None`) и подпись.
2. **Генерация подписи**: Вызывает функцию `generate_signature` для создания подписи на основе временной метки, сообщения и секретного ключа.
3. **Возврат данных**: Возвращает словарь с данными запроса, включая сгенерированную подпись.

```
A: Формирование данных запроса
|
-- B: Генерация подписи
|
C: Возврат данных запроса
```

**Примеры**:

```python
# Пример использования _build_request_data
from typing import List, Dict

messages: List[Dict[str, str]] = [{"role": "user", "content": "Привет, как дела?"}]
prompt = messages[-1]["content"]
timestamp = int(time.time())
secret = "secret_key"

data = FreeGpt._build_request_data(messages=messages, prompt=prompt, timestamp=timestamp, secret=secret)
print(data)
```

## Функции

### `generate_signature`

```python
def generate_signature(timestamp: int, message: str, secret: str = "") -> str:
    """Генерирует подпись для запроса на основе временной метки, сообщения и секретного ключа.

    Args:
        timestamp (int): Временная метка.
        message (str): Сообщение.
        secret (str, optional): Секретный ключ. По умолчанию "".

    Returns:
        str: Сгенерированная подпись.
    """
```

**Назначение**: Функция `generate_signature` генерирует подпись для запроса, используя алгоритм SHA256.

**Параметры**:
- `timestamp` (int): Временная метка, используемая для генерации подписи.
- `message` (str): Сообщение, используемое для генерации подписи.
- `secret` (str, optional): Секретный ключ, используемый для генерации подписи. По умолчанию "".

**Возвращает**:
- `str`: Сгенерированная подпись в виде шестнадцатеричной строки.

**Как работает функция**:
1. **Формирование данных**: Формирует строку данных, объединяя временную метку, сообщение и секретный ключ через двоеточие.
2. **Кодирование данных**: Кодирует строку данных в байты, используя кодировку UTF-8.
3. **Генерация хеша**: Генерирует SHA256 хеш из закодированных данных.
4. **Форматирование хеша**: Преобразует хеш в шестнадцатеричную строку и возвращает её.

```
A: Формирование данных
|
-- B: Кодирование данных
|
C: Генерация хеша
|
D: Форматирование хеша
```

**Примеры**:

```python
# Пример использования generate_signature
timestamp = int(time.time())
message = "Hello, world!"
secret = "secret_key"

signature = generate_signature(timestamp=timestamp, message=message, secret=secret)
print(signature)