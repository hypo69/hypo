# Модуль `try_xpath_content.js`

## Обзор

Этот скрипт отвечает за обработку запросов от всплывающего окна расширения Try XPath. Он осуществляет поиск элементов на веб-странице, используя XPath-выражения, а также устанавливает фокус на найденных элементах. Скрипт взаимодействует с браузером и хранилищем данных расширения для получения и обновления необходимых настроек.

## Переменные

### `tx`

**Описание**: алиас для объекта `tryxpath`.

### `fu`

**Описание**: алиас для объекта функций `tryxpath.functions`.

### `tx.isContentLoaded`

**Описание**: Флаг, указывающий, загружен ли контент страницы.  Служит для предотвращения повторного исполнения скрипта.

### `dummyItem`, `dummyItems`

**Описание**:  Пустые значения для инициализации переменных, хранящих информацию об элементах.

### `invalidExecutionId`

**Описание**: Значение `NaN`, используемое для обозначения недействительного идентификатора выполнения.

### `styleElementHeader`

**Описание**: Строка, содержащая комментарий, вставляемый в элемент `<style>`.

### `attributes`

**Описание**: Объект, содержащий имена атрибутов для хранения информации об элементах.


## Функции

### `setAttr`

**Описание**: Устанавливает атрибут для элемента. Сохраняет оригинальное значение атрибута для последующего восстановления.

**Параметры**:

- `attr` (строка): Название атрибута.
- `value` (любой тип): Значение атрибута.
- `item` (любой тип): Элемент, для которого устанавливается атрибут.


### `setIndex`

**Описание**: Устанавливает индекс для коллекции элементов. Сохраняет оригинальное значение атрибута для последующего восстановления.

**Параметры**:

- `attr` (строка): Название атрибута.
- `items` (массив): Коллекция элементов, для которых устанавливается индекс.


### `isFocusable`

**Описание**: Проверяет, можно ли установить фокус на элемент.

**Параметры**:

- `item` (любой тип): Элемент, на который проверяется фокус.

**Возвращает**:

- `boolean`: `true`, если фокус устанавливается, `false` - иначе.


### `focusItem`

**Описание**: Устанавливает фокус на указанный элемент.

**Параметры**:

- `item` (любой тип): Элемент, на который устанавливается фокус.


### `setMainAttrs`

**Описание**: Устанавливает основные атрибуты для текущего контекста.

### `restoreAttrs`

**Описание**: Восстанавливает оригинальные значения атрибутов элементов.

### `resetPrev`

**Описание**: Сбрасывает предыдущие результаты и переменные.

### `makeTypeStr`

**Описание**: Преобразует значение типа результата в строку.

**Параметры**:

- `resultType` (число): Значение типа результата.

**Возвращает**:

- `строка`: Строковое представление типа результата.


### `updateCss`

**Описание**: Обновляет CSS стили.


### `getFrames`

**Описание**: Возвращает массив индексов фреймов.

**Параметры**:

- `spec` (строка): Спецификация фреймов в формате JSON.


### `parseFrameDesignation`

**Описание**: Парсит строку спецификации фреймов, возвращая массив индексов фреймов.

**Параметры**:

- `frameDesi` (строка): Строка, содержащая JSON-представление спецификации фреймов.

**Возвращает**:

- `массив целых чисел`: Индексы фреймов.

**Исключения**:

- `Error`: При некорректном формате входной строки.


### `traceBlankWindows`

**Описание**: Проверяет и возвращает текущее окно или фрейм.

**Параметры**:

- `desi` (массив): Список индексов фреймов.
- `win` (объект Window, необязательно): Текущее окно.


### `handleCssChange`

**Описание**: Обрабатывает изменения в CSS.

**Параметры**:

- `newCss` (строка): Новый CSS.


### `findFrameByMessage`

**Описание**: Находит фрейм по сообщению.

**Параметры**:

- `event` (объект события): Событие, содержащее данные фрейма.
- `win` (объект Window): Текущее окно.

**Возвращает**:

- `объект HTMLFrameElement`: Фрейм или `null` в случае ошибки.


### `setFocusFrameListener`

**Описание**: Устанавливает обработчик событий для фреймов.

**Параметры**:

- `win` (объект Window): Окно, в котором устанавливается слушатель.
- `isBlankWindow` (логическое значение): Признак пустого окна.


### `initBlankWindow`

**Описание**: Инициализирует обработчики событий для пустых окон.

**Параметры**:

- `win` (объект Window): Пустое окно.


### `findStyleParent`

**Описание**: Находит родительский элемент для вставки CSS стилей.

**Параметры**:

- `doc` (объект Document): Объект документа.


### `updateStyleElement`

**Описание**: Обновляет элемент стиля.

**Параметры**:

- `doc` (объект Document): Объект документа.


### `updateAllStyleElements`

**Описание**: Обновляет все элементы стиля.


### `removeStyleElement`

**Описание**: Удаляет элемент стиля.

**Параметры**:

- `doc` (объект Document): Объект документа.


### `removeAllStyleElements`

**Описание**: Удаляет все элементы стиля.


### `createResultMessage`

**Описание**: Создает сообщение результата, содержащее данные об ошибках, ссылки, заголовки.


### `genericListener`

**Описание**: Общий обработчик сообщений.

**Параметры**:

- `message` (объект): Данные сообщения.
- `sender` (объект): Отправитель сообщения.
- `sendResponse` (функция): Функция для отправки ответа.

### ... (и другие функции)

**Описание**: Скрипт содержит большое количество других функций, отвечающих за различные аспекты взаимодействия с расширением и браузером.  Они обрабатывают различные сообщения, выполняют XPath-выражения, управляют стилями, а также обрабатывают исключения и ошибки.


## Взаимодействие с браузером

Скрипт использует методы `browser.runtime.sendMessage`, `window.postMessage` для обмена сообщениями с браузером, всплывающим окном, другими фреймами.  Взаимодействие реализовано через обширный набор функций для обработки разных событий и типов данных, в том числе фреймов.