# Модуль dao.py

## Обзор

Модуль `dao.py` содержит классы для доступа к данным (DAO) для работы с моделями базы данных, такими как `User`, `Purchase`, `Category` и `Product`.
Он предоставляет методы для выполнения операций с базой данных, таких как получение статистики покупок пользователей, информации о приобретенных продуктах, общей статистики, статистики платежей и т.д.

## Подробней

Модуль предназначен для упрощения взаимодействия с базой данных и абстрагирования логики доступа к данным от остальной части приложения.
Он использует SQLAlchemy для взаимодействия с базой данных и предоставляет асинхронные методы для выполнения запросов.
Расположение файла в структуре проекта указывает на его роль в качестве компонента доступа к данным для функциональности Telegram-бота, связанной с цифровым рынком.

## Классы

### `UserDAO`

**Описание**:
Класс `UserDAO` предоставляет методы для работы с данными пользователей в базе данных.
Он наследуется от `BaseDAO` и переопределяет атрибут `model`, указывая на модель `User`.

**Как работает класс**:
Класс предоставляет методы для получения статистики покупок пользователей, информации о приобретенных продуктах и общей статистики пользователей.
Он использует SQLAlchemy для выполнения запросов к базе данных и возвращает результаты в виде словарей или списков объектов.

**Методы**:

- `get_purchase_statistics(session: AsyncSession, telegram_id: int) -> Optional[Dict[str, int]]`
- `get_purchased_products(session: AsyncSession, telegram_id: int) -> Optional[List[Purchase]]`
- `get_statistics(session: AsyncSession) -> Dict[str, int]`

#### `get_purchase_statistics`

```python
    @classmethod
    async def get_purchase_statistics(cls, session: AsyncSession, telegram_id: int) -> Optional[Dict[str, int]]:
        """
        Получает статистику покупок пользователя, включая общее число покупок и общую сумму потраченных средств.

        Args:
            session (AsyncSession): Асинхронная сессия базы данных.
            telegram_id (int): Идентификатор пользователя в Telegram.

        Returns:
            Optional[Dict[str, int]]: Словарь со статистикой покупок пользователя.
            Ключи:
                'total_purchases' (int): Общее количество покупок.
                'total_amount' (int): Общая сумма потраченных средств.
            Возвращает `None`, если пользователь не найден или произошла ошибка при выполнении запроса.

        Raises:
            SQLAlchemyError: Если возникает ошибка при работе с базой данных.

        Example:
            >>> session = AsyncSession()
            >>> telegram_id = 123456789
            >>> stats = await UserDAO.get_purchase_statistics(session, telegram_id)
            >>> if stats:
            ...     print(f"Total purchases: {stats['total_purchases']}, Total amount: {stats['total_amount']}")
        """
        ...
```

**Как работает функция**:

1.  **Инициализация**: Функция принимает асинхронную сессию базы данных `session` и идентификатор пользователя `telegram_id`.
2.  **Запрос статистики**: Выполняется запрос к базе данных для подсчета общего числа покупок (`total_purchases`) и общей суммы потраченных средств (`total_amount`) для заданного `telegram_id`.
3.  **Обработка результата**:
    *   Если запрос возвращает результат, извлекаются значения `total_purchases` и `total_amount`.
    *   Если `total_amount` равен `None`, он заменяется на 0.
    *   Формируется словарь со статистикой и возвращается.
4.  **Обработка ошибок**: Если во время выполнения запроса возникает ошибка `SQLAlchemyError`, она логируется, и возвращается `None`.

#### `get_purchased_products`

```python
    @classmethod
    async def get_purchased_products(cls, session: AsyncSession, telegram_id: int) -> Optional[List[Purchase]]:
        """
        Получает список приобретенных продуктов пользователем.

        Args:
            session (AsyncSession): Асинхронная сессия базы данных.
            telegram_id (int): Идентификатор пользователя в Telegram.

        Returns:
            Optional[List[Purchase]]: Список объектов `Purchase`, представляющих покупки пользователя.
            Возвращает `None`, если пользователь не найден или у пользователя нет покупок.

        Raises:
            SQLAlchemyError: Если возникает ошибка при работе с базой данных.

        Example:
            >>> session = AsyncSession()
            >>> telegram_id = 123456789
            >>> purchases = await UserDAO.get_purchased_products(session, telegram_id)
            >>> if purchases:
            ...     for purchase in purchases:
            ...         print(f"Product: {purchase.product.name}, Price: {purchase.price}")
        """
        ...
```

**Как работает функция**:

1.  **Инициализация**: Функция принимает асинхронную сессию базы данных `session` и идентификатор пользователя `telegram_id`.
2.  **Запрос пользователя с покупками**: Выполняется запрос к базе данных для получения пользователя с его покупками, используя `selectinload` для оптимизации загрузки связанных данных (продуктов).
3.  **Обработка результата**:
    *   Если пользователь найден, извлекается список его покупок (`user.purchases`) и возвращается.
    *   Если пользователь не найден, возвращается `None`.
4.  **Обработка ошибок**: Если во время выполнения запроса возникает ошибка `SQLAlchemyError`, она логируется, и возвращается `None`.

#### `get_statistics`

```python
    @classmethod
    async def get_statistics(cls, session: AsyncSession):
        """
        Получает общую статистику по пользователям, включая общее количество пользователей,
        количество новых пользователей за сегодня, за неделю и за месяц.

        Args:
            session (AsyncSession): Асинхронная сессия базы данных.

        Returns:
            Dict[str, int]: Словарь со статистикой пользователей.
            Ключи:
                'total_users' (int): Общее количество пользователей.
                'new_today' (int): Количество новых пользователей за сегодня.
                'new_week' (int): Количество новых пользователей за неделю.
                'new_month' (int): Количество новых пользователей за месяц.

        Raises:
            SQLAlchemyError: Если возникает ошибка при работе с базой данных.

        Example:
            >>> session = AsyncSession()
            >>> stats = await UserDAO.get_statistics(session)
            >>> print(f"Total users: {stats['total_users']}, New today: {stats['new_today']}")
        """
        ...
```

**Как работает функция**:

1.  **Инициализация**: Функция принимает асинхронную сессию базы данных `session`.
2.  **Определение текущего времени**: Определяется текущее время в UTC.
3.  **Запрос статистики**: Выполняется запрос к базе данных для подсчета:
    *   Общего количества пользователей (`total_users`).
    *   Количества новых пользователей, зарегистрированных сегодня (`new_today`).
    *   Количества новых пользователей, зарегистрированных за последнюю неделю (`new_week`).
    *   Количества новых пользователей, зарегистрированных за последний месяц (`new_month`).
    Для подсчета новых пользователей используется `case` для условного подсчета.
4.  **Обработка результата**:
    *   Извлекаются результаты запроса и формируется словарь со статистикой.
    *   Словарь логируется и возвращается.
5.  **Обработка ошибок**: Если во время выполнения запроса возникает ошибка `SQLAlchemyError`, она логируется, и вызывается исключение.

### `PurchaseDao`

**Описание**:
Класс `PurchaseDao` предоставляет методы для работы с данными о покупках в базе данных.
Он наследуется от `BaseDAO` и переопределяет атрибут `model`, указывая на модель `Purchase`.

**Как работает класс**:
Класс предоставляет методы для получения статистики платежей, общей суммы покупок и следующего свободного ID для новой записи.
Он использует SQLAlchemy для выполнения запросов к базе данных и возвращает результаты в виде строк или чисел.

**Методы**:

- `get_payment_stats(session: AsyncSession) -> str`
- `get_full_summ(session: AsyncSession) -> int`
- `get_next_id(session: AsyncSession) -> int`

#### `get_payment_stats`

```python
    @classmethod
    async def get_payment_stats(cls, session: AsyncSession) -> str:
        """
        Получает статистику платежей по типам платежных систем.

        Args:
            session (AsyncSession): Асинхронная сессия базы данных.

        Returns:
            str: Строка, содержащая статистику платежей по типам платежных систем.

        Raises:
            SQLAlchemyError: Если возникает ошибка при работе с базой данных.

        Example:
            >>> session = AsyncSession()
            >>> stats = await PurchaseDao.get_payment_stats(session)
            >>> print(stats)
        """
        ...
```

**Как работает функция**:

1.  **Инициализация**: Функция принимает асинхронную сессию базы данных `session`.
2.  **Запрос статистики платежей**: Выполняется запрос к базе данных для получения статистики платежей по типам платежных систем (`payment_type`) и общей сумме для каждого типа.
3.  **Обработка результата**:
    *   Результаты запроса сохраняются в словаре `totals`, где ключами являются типы платежных систем, а значениями - общие суммы.
    *   Словарь заполняется значениями из результата запроса. Если для какого-то типа платежной системы нет данных, то устанавливается значение 0.
    *   Формируется строка со статистикой платежей и возвращается.

#### `get_full_summ`

```python
    @classmethod
    async def get_full_summ(cls, session: AsyncSession) -> int:
        """
        Получает общую сумму всех покупок.

        Args:
            session (AsyncSession): Асинхронная сессия базы данных.

        Returns:
            int: Общая сумма всех покупок.

        Raises:
            SQLAlchemyError: Если возникает ошибка при работе с базой данных.

        Example:
            >>> session = AsyncSession()
            >>> total_sum = await PurchaseDao.get_full_summ(session)
            >>> print(total_sum)
        """
        ...
```

**Как работает функция**:

1.  **Инициализация**: Функция принимает асинхронную сессию базы данных `session`.
2.  **Запрос общей суммы**: Выполняется запрос к базе данных для получения общей суммы всех покупок.
3.  **Обработка результата**:
    *   Извлекается результат запроса.
    *   Если результат не `None`, он возвращается. В противном случае возвращается 0.

#### `get_next_id`

```python
    @classmethod
    async def get_next_id(cls, session: AsyncSession) -> int:
        """
        Возвращает следующий свободный ID для новой записи.

        Args:
            session (AsyncSession): Асинхронная сессия базы данных

        Returns:
            int: Следующий свободный ID

        Raises:
            SQLAlchemyError: Если возникает ошибка при работе с базой данных.

        Example:
            >>> session = AsyncSession()
            >>> next_id = await PurchaseDao.get_next_id(session)
            >>> print(next_id)
        """
        ...
```

**Как работает функция**:

1.  **Инициализация**: Функция принимает асинхронную сессию базы данных `session`.
2.  **Запрос следующего ID**: Выполняется запрос к базе данных для получения максимального значения `id` в таблице `Purchase` и добавления к нему 1. Если таблица пуста, возвращается 1.
3.  **Обработка результата**: Извлекается результат запроса и возвращается.

### `CategoryDao`

**Описание**:
Класс `CategoryDao` предоставляет методы для работы с данными о категориях в базе данных.
Он наследуется от `BaseDAO` и переопределяет атрибут `model`, указывая на модель `Category`.

**Как работает класс**:
Класс не содержит дополнительных методов, кроме тех, что унаследованы от `BaseDAO`.

### `ProductDao`

**Описание**:
Класс `ProductDao` предоставляет методы для работы с данными о продуктах в базе данных.
Он наследуется от `BaseDAO` и переопределяет атрибут `model`, указывая на модель `Product`.

**Как работает класс**:
Класс не содержит дополнительных методов, кроме тех, что унаследованы от `BaseDAO`.

## Функции

В данном модуле функции отсутствуют.