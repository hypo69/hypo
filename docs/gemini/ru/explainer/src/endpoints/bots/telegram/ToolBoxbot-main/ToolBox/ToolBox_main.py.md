## <алгоритм>

1.  **Инициализация**:
    *   Импортируются необходимые библиотеки: `asyncio`, `base64`, `string`, `random`, `telebot`, `dotenv`, `datetime`, `threading`, `dateutil.relativedelta`, `ToolBox_requests`, `ToolBox_DataBase`.
    *   Загружаются переменные окружения из файла `.env`.
    *   Создаются экземпляры классов `ToolBox` и `DataBase`.
    *   Инициализируется база данных, загружаются данные.
    *   Устанавливается значение `N=8` - количество типов текстовых запросов.
    *   Определяется `DATA_PATTERN` - шаблон для инициализации данных пользователя.

2.  **Обработка пред-оплаты**:
    *   `process_pre_checkout_query`: обрабатывает запросы перед оплатой, подтверждая их.

3.  **Обработка успешной оплаты**:
    *   `successful_payment`: обрабатывает успешные платежи.
        *   Определяет, какой тариф оплатил пользователь (basic или pro) по `invoice_payload`.
        *   Устанавливает соответствующие значения `True` в полях 'basic' и 'pro' в данных пользователя.
        *   Зачисляет пользователю токены (incoming и outgoing) и устанавливает время окончания подписки +1 месяц.
        *   Сохраняет обновленные данные в базу данных.
        *   Отправляет сообщение об успешной активации подписки.
        *   Вызывает `tb.restart(message)` для возврата в главное меню.
    
4.  **Обработка команды /start**:
    *   `StartProcessing`: обрабатывает команду `/start`.
        *   Инициализирует данные пользователя, если их нет в базе данных, или загружает существующие.
        *   Сохраняет или обновляет данные пользователя в базе данных.
        *   Вызывает `tb.start_request(message)` для отображения начального интерфейса.

5. **Обработка команды /profile**:
    *   `personal_account`: обрабатывает команду `/profile`.
    *   Отправляет пользователю информацию о его текущей подписке и статусе.

6. **Обработка команды /stat**:
    *   `show_stat`: обрабатывает команду `/stat`.
        *   Отправляет админам статистику по боту (общее количество пользователей и кол-во пользователей с промокодом)
    
7.  **Генерация промокода**:
    *   `generate_promo_code`: генерирует случайный промокод заданной длины.

8.  **Обработка callback-запросов**:
    *   `CallsProcessing`: обрабатывает callback-запросы (нажатия на кнопки).
    *   Создает данные пользователя, если их нет в базе данных.
        *   Разветвление логики в зависимости от `call.data`:
            *   **Кнопки главного меню** (`text`, `images`, `free`, `tariff`): вызов соответствующих функций `tb`.
                *  При выборе  `images`  проверяет наличие подписки `pro`
                *  При выборе `free` устанавливает пользователю бесплатный режим.
            *   **Кнопки размеров изображения** (`576x1024`, `1024x1024`, `1024x576`): сохраняет размер изображения в данных пользователя.
            *  **Кнопки обработки изображений** (`upscale`, `regenerate`): выполняет операции с изображением в отдельном потоке.
            *   **Кнопки выбора тарифа** (`basic`, `pro`, `promo`, `ref`): вызов соответствующих функций `tb` или обработка ввода промокода или генерации реф. ссылки.
            *   **Кнопки типов текста**: выбирает тип текста и вызывает соответствующие функции из `tb`.
            *   **Кнопки отмены** (`exit`, `text_exit`, `tariff_exit`): вызов соответствующих функций для возврата в главное меню, отмены ввода текста или выхода из выбора тарифа.
            *   **Кнопки для генерации текста** (`one_ind`, `some_ind`): устанавливает соответствующие флаги в данных пользователя и вызывает функции `tb` для генерации.

9.  **Шаблон обработки токенов**:
    *   `TokensCancelletionPattern`: функция-шаблон для обработки токенов пользователя при генерации текста.
        *   Проверяет наличие токенов (или бесплатных запросов) у пользователя.
        *   Вызывает функцию генерации текста из `tb`.
        *   Уменьшает количество токенов или бесплатных запросов у пользователя.
        *   Если токены и бесплатные запросы закончились, то уведомляет пользователя и обнуляет токены.
    
10. **Обработка входящих сообщений**:
    *   `TasksProcessing`: обрабатывает все текстовые и фото сообщения от пользователей.
    *   Обрабатывает запросы на генерацию изображений.
    *   Обрабатывает выход из бесплатного режима.
    *   Обрабатывает сообщения в бесплатном режиме.
    *   Обрабатывает запросы на генерацию текста.
    *   Сохраняет обновленные данные в базу данных.

11. **Проверка окончания подписки**:
    *   `end_check_tariff_time`: асинхронная функция для проверки окончания подписки.
    *   Проверяет время окончания подписки для каждого пользователя.
    *   Если время подписки истекло, сбрасывает тарифные данные пользователя.

12. **Запуск бота**:
    *   Запускается бот в отдельном потоке.
    *   Запускается асинхронная функция проверки окончания подписки.

## <mermaid>
```mermaid
flowchart TD
    subgraph ToolBox_main.py
        Start(Start) --> Init[Инициализация: <br>Импорт библиотек, <br>Загрузка переменных окружения, <br>Создание экземпляров классов ToolBox и DataBase, <br>Инициализация БД]
        Init --> PreCheckout[<code>@bot.pre_checkout_query_handler</code><br>Обработка pre-checkout запроса]
        PreCheckout --> SuccessPayment[<code>@bot.message_handler</code><br>Обработка успешной оплаты]
        SuccessPayment --> StartCommand[<code>@bot.message_handler</code><br>Обработка команды /start]
        StartCommand --> ProfileCommand[<code>@bot.message_handler</code><br>Обработка команды /profile]
        ProfileCommand --> StatCommand[<code>@bot.message_handler</code><br>Обработка команды /stat]
        StatCommand --> GeneratePromo[<code>generate_promo_code</code><br>Генерация промокода]
        GeneratePromo --> CallProcessing[<code>@bot.callback_query_handler</code><br>Обработка callback запросов]
        CallProcessing --> TokenPattern[<code>TokensCancelletionPattern</code><br>Обработка токенов]
        TokenPattern --> TasksProcessing[<code>@bot.message_handler</code><br>Обработка входящих сообщений]
        TasksProcessing --> EndCheck[<code>end_check_tariff_time</code><br>Проверка окончания подписки]
        EndCheck --> BotStart[Запуск бота: <br><code>bot.infinity_polling</code>, <code>asyncio.run</code>]
        BotStart --> End(End)
        
        style Init fill:#f9f,stroke:#333,stroke-width:2px
        style PreCheckout fill:#ccf,stroke:#333,stroke-width:1px
        style SuccessPayment fill:#ccf,stroke:#333,stroke-width:1px
        style StartCommand fill:#ccf,stroke:#333,stroke-width:1px
        style ProfileCommand fill:#ccf,stroke:#333,stroke-width:1px
        style StatCommand fill:#ccf,stroke:#333,stroke-width:1px
        style GeneratePromo fill:#ccf,stroke:#333,stroke-width:1px
        style CallProcessing fill:#ccf,stroke:#333,stroke-width:1px
        style TokenPattern fill:#ccf,stroke:#333,stroke-width:1px
        style TasksProcessing fill:#ccf,stroke:#333,stroke-width:1px
        style EndCheck fill:#ccf,stroke:#333,stroke-width:1px
        style BotStart fill:#ccf,stroke:#333,stroke-width:1px
    end

    subgraph ToolBox_requests.py
        TS[ToolBox Class<br>Methods: <br><code>start_request</code>, <code>Text_types</code>, <code>ImageSize</code>, <code>ImageArea</code>, <code>FreeArea</code>,<br><code>TariffArea</code>, <code>Basic_tariff</code>, <code>Pro_tariff</code>, <code>Image_Regen_And_Upscale</code>, <code>BeforeUpscale</code>,<br><code>ImageChange</code>, <code>SomeTexts</code>, <code>OneTextArea</code>, <code>FreeCommand</code>, <code>TextCommands</code>,<br><code>SomeTextsCommand</code>, <code>TarrifEnd</code>, <code>FreeTariffEnd</code>, <code>restart</code>, <code>restart_markup</code>, <code>TariffExit</code>, <code>ImageCommand</code>]
    end

    subgraph ToolBox_DataBase.py
        DB[DataBase Class<br>Methods: <br><code>create</code>, <code>load_data_from_db</code>, <code>insert_or_update_data</code>]
    end

    Start --> Init
    Init --> TS
    Init --> DB
    SuccessPayment --> TS
    StartCommand --> TS
    CallProcessing --> TS
    CallProcessing --> DB
    TokenPattern --> TS
    TasksProcessing --> TS
    TasksProcessing --> DB
    EndCheck --> DB
    GeneratePromo --> CallProcessing
```

**Описание зависимостей `mermaid`:**

*   **ToolBox_main.py**: Основной скрипт, управляющий ботом, обрабатывает входящие запросы и команды.
*   **ToolBox_requests.py**: Содержит класс `ToolBox` с методами для обработки запросов от пользователя, генерации текста, изображений, управления тарифами и т.д.
*   **ToolBox_DataBase.py**: Содержит класс `DataBase`,  методы для работы с базой данных (создание, загрузка, обновление).

**Импорт зависимостей:**

*   **`ToolBox_main.py` импортирует**:
    *   `asyncio`, `base64`, `string`, `random` - стандартные библиотеки для асинхронных операций, кодирования, генерации случайных строк и чисел.
    *   `telebot` - библиотека для работы с Telegram Bot API.
    *   `dotenv` - библиотека для загрузки переменных окружения из файла `.env`.
    *   `datetime`, `threading`, `dateutil.relativedelta` - стандартные библиотеки для работы с датами, многопоточностью, относительными датами.
    *   `ToolBox_requests` - кастомный модуль для реализации логики запросов.
    *   `ToolBox_DataBase` - кастомный модуль для работы с базой данных.

**Связи:**

1.  `ToolBox_main.py` инициализирует объекты классов `ToolBox` и `DataBase`.
2.  `ToolBox_main.py` использует методы `ToolBox` для обработки запросов и команд пользователей (текстовые запросы, изображения, управление тарифами и т.д.).
3.  `ToolBox_main.py` использует методы `DataBase` для сохранения и загрузки данных пользователей.
4.  `ToolBox_requests.py` не импортирует другие модули из данного проекта, но используются методы и переменные внутри `ToolBox_main.py`.
5.  `ToolBox_DataBase.py` не импортирует другие модули из данного проекта, и используется для работы с базой данных внутри `ToolBox_main.py`.

## <объяснение>

**Импорты:**

*   `asyncio`: Библиотека для асинхронного программирования, используется для параллельного выполнения задач, например, для проверки срока окончания подписки.
*   `base64`: Библиотека для кодирования и декодирования данных в формат Base64, используется для обработки изображений.
*   `string`: Библиотека для работы со строками, используется для генерации промокодов.
*   `random`: Библиотека для генерации случайных чисел и выборок, используется для генерации промокодов и seed для изображений.
*   `telebot`: Библиотека для создания Telegram-ботов.
*   `dotenv`: Библиотека для загрузки переменных окружения из файла `.env`.
*   `datetime`: Библиотека для работы с датами и временем, используется для определения срока подписки.
*   `threading`: Библиотека для создания и управления потоками, используется для выполнения ресурсоемких операций (генерации текста, изображений) в отдельных потоках.
*   `dateutil.relativedelta`: Библиотека для работы с относительными датами, используется для добавления месяца к сроку подписки.
*   `ToolBox_requests`: Модуль, содержащий класс `ToolBox`, который управляет логикой обработки запросов (генерация текста, изображений, управление тарифами).
*   `ToolBox_DataBase`: Модуль, содержащий класс `DataBase`, который управляет взаимодействием с базой данных.

**Классы:**

*   `ToolBox`: Класс, инкапсулирующий логику взаимодействия с пользователем. Содержит методы для обработки различных запросов, включая генерацию текста, изображений, управление тарифами, отправку сообщений и так далее.
*   `DataBase`: Класс, инкапсулирующий логику работы с базой данных. Содержит методы для создания базы данных, загрузки данных, вставки или обновления данных.

**Функции:**

*   `process_pre_checkout_query(pre_checkout_query)`: Обрабатывает запросы перед оплатой, подтверждая их.
    *   **Аргументы**: `pre_checkout_query` - объект запроса перед оплатой.
    *   **Возвращаемое значение**: Нет.
*   `successful_payment(message)`: Обрабатывает успешные платежи.
    *   **Аргументы**: `message` - объект сообщения об успешной оплате.
    *   **Возвращаемое значение**: Нет.
    *   **Пример**: При получении сообщения об успешной оплате с `invoice_payload == 'basic_invoice_payload'` устанавливает `db[user_id]['basic'] = True` и т.д.
*   `StartProcessing(message)`: Обрабатывает команду `/start`.
    *   **Аргументы**: `message` - объект сообщения с командой `/start`.
    *   **Возвращаемое значение**: Нет.
    *    **Пример**: При получении команды `/start` от пользователя с id `123456789` создается запись в `db` со значением по умолчанию или обновляется существующая.
*   `personal_account(message)`: Обрабатывает команду `/profile`.
    *   **Аргументы**: `message` - объект сообщения с командой `/profile`.
    *   **Возвращаемое значение**: Нет.
    *    **Пример**: Отправляет пользователю с id `123456789` сообщение о его подписке в зависимости от его данных из `db`.
*   `show_stat(message)`: Обрабатывает команду `/stat`.
    *   **Аргументы**: `message` - объект сообщения с командой `/stat`.
    *   **Возвращаемое значение**: Нет.
    *    **Пример**: Отправляет пользователям с id `2004851715` или `206635551` статистику по боту.
*   `generate_promo_code(length)`: Генерирует случайный промокод заданной длины.
    *   **Аргументы**: `length` - длина промокода.
    *   **Возвращаемое значение**: `promo_code` - строка, содержащая сгенерированный промокод.
    *   **Пример**: `generate_promo_code(10)` возвращает строку "aB2cD3eF4g".
*   `CallsProcessing(call)`: Обрабатывает callback-запросы (нажатия на кнопки).
    *   **Аргументы**: `call` - объект callback-запроса.
    *   **Возвращаемое значение**: Нет.
    *    **Пример**: При нажатии на кнопку "text" вызовет метод `tb.Text_types(call.message)`.
*   `TokensCancelletionPattern(user_id, func, message, i=None)`: Функция-шаблон для обработки токенов пользователя при генерации текста.
    *   **Аргументы**: `user_id`, `func` - функция из класса `ToolBox`, `message` - объект сообщения, `i` - индекс типа текста (опционально).
    *   **Возвращаемое значение**: Нет.
    *    **Пример**: `TokensCancelletionPattern('123456789', tb.TextCommands, message, 0)`
        *   Проверяет токены пользователя.
        *   Вызывает метод `tb.TextCommands` для генерации текста.
        *   Уменьшает количество токенов у пользователя.
*   `TasksProcessing(message)`: Обрабатывает все текстовые и фото сообщения от пользователей.
    *   **Аргументы**: `message` - объект входящего сообщения.
    *   **Возвращаемое значение**: Нет.
    *   **Пример**: Если `db[user_id]['images'] != ""` и длина `split` = 1, значит обрабатывается запрос на генерацию изображения.
*    `end_check_tariff_time()`: Асинхронная функция для проверки окончания подписки.
    *   **Аргументы**: Нет.
    *   **Возвращаемое значение**: Нет.
    *    **Пример**: Раз в 10 секунд проверяет наличие просроченных подписок, и обновляет данные в `db`

**Переменные:**

*   `N`: Количество типов текстовых запросов (8).
*   `DATA_PATTERN`: Шаблон для инициализации данных пользователя.
*   `photo_array`: Массив для хранения фотографий, используется в коде но не заполняется.
*   `tb`: Экземпляр класса `ToolBox`, который предоставляет методы для обработки запросов.
*   `base`: Экземпляр класса `DataBase`, который управляет доступом к базе данных.
*   `db`: Словарь, хранящий данные пользователей, загруженные из базы данных.

**Потенциальные ошибки и области для улучшения:**

1.  **Обработка ошибок**: В коде отсутствует обработка исключений, что может привести к сбою приложения при возникновении ошибок. Необходимо добавить блоки `try-except` для обработки возможных ошибок, например, при работе с базой данных, сетью или при парсинге данных.
2.  **Безопасность**: Прямая проверка промокода (`if message.text.lower() == "free24"`) может быть уязвима для атаки. Желательно хранить промокоды в базе данных и проверять их на стороне сервера.
3.  **Масштабируемость**: Обработка запросов в основном происходит в отдельных потоках, что может привести к проблемам с масштабируемостью при большом количестве пользователей. Возможно, следует использовать асинхронные задачи и очереди для обработки запросов.
4.  **Логирование**: Отсутствует логирование действий, что затрудняет отладку и мониторинг работы приложения. Необходимо добавить логирование для регистрации важных событий, ошибок и действий пользователей.
5.  **Использование глобальных переменных**: Использование `global db` внутри функций может привести к проблемам с управлением состоянием. Желательно инкапсулировать состояние бота в класс или использовать другие методы управления состоянием.
6.  **Обработка ошибок при работе с изображениями**: При обработке изображений в бесплатном режиме используется `base64` кодирование, которое может привести к большим нагрузкам на память и неоптимальному хранению данных. Следует рассмотреть другие способы обработки изображений, например, сохранение их в облачном хранилище.
7.  **Дублирование кода**: В коде есть дублирование логики, например, при обработке успешной оплаты и при обработке промокода (зачисление токенов, установка даты подписки). Следует вынести дублирующиеся куски кода в отдельные функции.
8.  **Улучшение структуры**: Код можно разделить на более мелкие и переиспользуемые функции для улучшения читаемости.

**Взаимосвязи с другими частями проекта:**

*   Данный код является основным модулем для обработки запросов от пользователей и управления их данными. Он тесно связан с модулями `ToolBox_requests` (логика запросов) и `ToolBox_DataBase` (база данных).
*   При внесении изменений в данном коде необходимо учитывать его взаимодействие с `ToolBox_requests` и `ToolBox_DataBase`.