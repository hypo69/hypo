# Модуль генерации прайс-листов для "Казаринова"

## Обзор

Модуль `pricelist_generator.py` предназначен для генерации HTML и PDF прайс-листов на основе JSON-данных. Он использует шаблоны Jinja2 для создания HTML и библиотеку `pdfkit` или `PDFUtils` для конвертации HTML в PDF. Модуль поддерживает мультиязычность.

## Подробнее

Модуль содержит класс `ReportGenerator`, который отвечает за генерацию отчетов. Основная логика работы заключается в загрузке данных из JSON, генерации HTML на основе этих данных и последующей конвертации HTML в PDF.
В проекте `hypotez` этот модуль может использоваться для автоматического создания и обновления прайс-листов для клиентов "Казаринова" на разных языках.

## Классы

### `ReportGenerator`

**Описание**: Класс для генерации HTML- и PDF-отчётов на основе данных из JSON.

**Как работает класс**:
1.  Класс инициализируется с использованием `dataclass`, что упрощает создание экземпляров класса.
2.  При инициализации создается объект `Environment` из библиотеки `jinja2` для работы с шаблонами.
3.  Метод `generate_html` генерирует HTML-контент на основе предоставленных данных и выбранного шаблона. Шаблон выбирается в зависимости от языка (`lang`).
4.  Метод `create_report` выполняет полный цикл генерации отчёта: добавляет информацию об услугах, генерирует HTML, сохраняет его в файл и конвертирует в PDF.
5.  Для генерации PDF используется класс `PDFUtils`, который предоставляет методы для конвертации HTML в PDF.

**Поля**:

*   `env` (Environment): Объект окружения Jinja2, используемый для загрузки и рендеринга шаблонов. Инициализируется с помощью `FileSystemLoader`, который указывает на текущую директорию (`.`) в качестве места поиска шаблонов.

**Методы**:

*   `generate_html`: генерирует HTML-контент на основе шаблона и данных.
*   `create_report`: выполняет полный цикл генерации отчёта.

## Функции

### `generate_html`

```python
    async def generate_html(self, data:dict, lang:str ) -> str:
        """
        Генерирует HTML-контент на основе шаблона и данных.

        Args:
            lang (str): Язык отчёта.

        Returns:
            str: HTML-контент.
        """
```

**Как работает функция**:

1.  Определяет шаблон в зависимости от языка `lang`: если язык "he" (иврит), то используется шаблон `'template_table_he.html'`, иначе используется шаблон `'template_table_ru.html'`.
2.  Формирует путь к файлу шаблона, объединяя базовый путь (`gs.path.endpoints / 'kazarinov' / 'pricelist_generator' / 'templates'`) с именем шаблона.
3.  Читает содержимое файла шаблона в виде текста с кодировкой UTF-8.
4.  Создает шаблон Jinja2 из прочитанной строки с использованием `self.env.from_string(template_string)`.
5.  Рендерит шаблон с использованием переданных данных `data` и возвращает полученный HTML-контент.

**Параметры**:

*   `data` (dict): Словарь с данными для заполнения шаблона.
*   `lang` (str): Язык отчёта, определяющий, какой шаблон использовать.

**Возвращает**:

*   `str`: HTML-контент, сгенерированный на основе шаблона и данных.

### `create_report`

```python
    async def create_report(self, data: dict, lang:str, html_file:str| Path, pdf_file:str |Path) -> bool:
        """
        Полный цикл генерации отчёта.

        Args:
            lang (str): Язык отчёта.
        """
```

**Как работает функция**:

1.  Создает словарь `service_dict` с информацией об услуге. Заголовок услуги ("Сервис" или "שירות") зависит от языка `lang`. Описание услуги читается из HTML-файла (`service_as_product_{lang}.html`) и добавляется в словарь. Также добавляется случайное изображение из указанной директории.
2.  Добавляет словарь `service_dict` в список продуктов (`data['products']`).
3.  Генерирует HTML-контент с использованием метода `self.generate_html(data, lang)`.
4.  Сохраняет HTML-контент в файл с именем `html_file` и кодировкой UTF-8.
5.  Инициализирует объект класса `PDFUtils`, который используется для конвертации HTML в PDF.
6.  Вызывает метод `pdf.save_pdf_pdfkit(html_content, pdf_file)` для конвертации HTML-контента в PDF и сохранения в файл `pdf_file`. Если конвертация не удалась, логируется ошибка.

**Параметры**:

*   `data` (dict): Словарь с данными для отчёта.
*   `lang` (str): Язык отчёта.
*   `html_file` (str | Path): Путь к файлу для сохранения HTML-контента.
*   `pdf_file` (str | Path): Путь к файлу для сохранения PDF-отчёта.

**Возвращает**:

*   `bool`: `True`, если отчёт успешно сгенерирован и сохранен, `False` в случае ошибки.

### `main`

```python
def main(mexiron:str,lang:str) ->bool:
    """

    Args:
        mexiron:
        lang:

    Returns:
        bool:
    """
```

**Как работает функция**:

1.  Формирует базовый путь к директории с данными, объединяя `gs.path.external_storage / 'kazarinov' / 'mexironim'` с названием мехирона (`mexiron`).
2.  Загружает данные из JSON-файла, используя функцию `j_loads`. Имя файла формируется как `{lang}.json` и располагается в директории `base_path`.
3.  Формирует пути к файлам HTML и PDF, используя `base_path`, название мехирона (`mexiron`) и язык (`lang`).
4.  Создает экземпляр класса `ReportGenerator`.
5.  Запускает асинхронную операцию `r.create_report(data, lang, html_file, pdf_file)` с использованием `asyncio.run()`.

**Параметры**:

*   `mexiron` (str): Название мехирона.
*   `lang` (str): Язык отчёта.

**Возвращает**:

*   `bool`: Возвращает `True`, если отчёт успешно сгенерирован и сохранен, `False` в случае ошибки.

```python
if __name__ == "__main__":
    mexiron:str = '24_12_01_03_18_24_269'
    lang:str = 'ru'
    main(mexiron,lang)
```

**Описание**:

Данный блок кода выполняется только при запуске скрипта напрямую (не при импорте как модуля). Он определяет значения переменных `mexiron` и `lang` и вызывает функцию `main` с этими значениями. Это позволяет запускать генерацию отчёта с предопределёнными параметрами для тестирования или демонстрации работы модуля.