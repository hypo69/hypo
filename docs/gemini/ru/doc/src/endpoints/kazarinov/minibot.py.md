# Модуль `minibot.py`

## Обзор

Модуль `minibot.py` представляет собой реализацию мини-бота для обслуживания запросов от пользователя Kazarinov. Он использует библиотеку `telebot` для взаимодействия с Telegram API и включает функциональность для обработки текстовых сообщений, URL-адресов, голосовых сообщений и документов. Также, в зависимости от конфигурации, бот может использовать Google Gemini AI для генерации ответов на текстовые запросы.

## Подробней

Модуль предназначен для работы в двух режимах: `PRODUCTION` и `DEV`. В зависимости от режима, бот использует разные токены для подключения к Telegram API. Ключи для доступа к API могут браться как из переменных окружения, так и из базы данных с паролями.
Основная задача бота - обработка сообщений пользователя, выполнение сценариев на основе полученных данных (например, URL-адресов) и предоставление ответов с использованием AI.
Модуль включает в себя классы `BotHandler` и `Config`, а также основные обработчики команд и сообщений для Telegram бота.

## Классы

### `BotHandler`

**Описание**:
Класс `BotHandler` предназначен для обработки сообщений, получаемых от Telegram бота. Он включает в себя методы для обработки текста, URL, голосовых сообщений, документов и команды `--next`.

**Методы**:
- `__init__`: Инициализирует обработчик, настраивает список вопросов и AI модель.
- `handle_message`: Обрабатывает входящие текстовые сообщения, определяет тип сообщения (URL, команда или текст) и вызывает соответствующие обработчики.
- `_send_user_flowchart`: Отправляет пользователю схему user_flowchart.
- `_handle_url`: Обрабатывает URL, полученный от пользователя, извлекает данные и запускает сценарий.
- `_handle_next_command`: Обрабатывает команду `--next` и отправляет пользователю случайный вопрос и ответ от AI.
- `help_command`: Отправляет пользователю сообщение со списком доступных команд.
- `send_pdf`: Отправляет пользователю PDF-файл.
- `handle_voice`: Обрабатывает голосовые сообщения, распознает текст и отправляет его пользователю.
- `_transcribe_voice`: Заглушка для транскрибирования голосового сообщения.
- `handle_document`: Обрабатывает полученные документы, сохраняет их и отправляет пользователю сообщение с путем к файлу.

#### `__init__`

```python
def __init__(self):
    """Инициализация обработчика событий телеграм-бота."""
    ...
```

**Описание**:
Инициализирует экземпляр класса `BotHandler`.

**Параметры**:
- Отсутствуют.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
handler = BotHandler()
```

#### `handle_message`

```python
def handle_message(self, bot: telebot, message: 'message'):
    """Обработка текстовых сообщений."""
    ...
```

**Описание**:
Обрабатывает текстовые сообщения, полученные от пользователя.

**Параметры**:
- `bot` (telebot): Экземпляр телеграм-бота.
- `message` (message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
handler.handle_message(bot, message)
```

#### `_send_user_flowchart`

```python
def _send_user_flowchart(self, bot, chat_id):
    """Отправка схемы user_flowchart."""
    ...
```

**Описание**:
Отправляет пользователю схему user_flowchart в виде изображения.

**Параметры**:
- `bot` (telebot): Экземпляр телеграм-бота.
- `chat_id` (int): Идентификатор чата пользователя.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
handler._send_user_flowchart(bot, message.chat.id)
```

#### `_handle_url`

```python
def _handle_url(self, bot, message: 'message'):
    """Обработка URL, присланного пользователем."""
    ...
```

**Описание**:
Обрабатывает URL, полученный от пользователя, извлекает данные и запускает сценарий.

**Параметры**:
- `bot` (telebot): Экземпляр телеграм-бота.
- `message` (message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
handler._handle_url(bot, message)
```

#### `_handle_next_command`

```python
def _handle_next_command(self, bot, message):
    """Обработка команды '--next' и её аналогов."""
    ...
```

**Описание**:
Обрабатывает команду `--next` и отправляет пользователю случайный вопрос и ответ от AI.

**Параметры**:
- `bot` (telebot): Экземпляр телеграм-бота.
- `message` (message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
handler._handle_next_command(bot, message)
```

#### `help_command`

```python
def help_command(self, bot, message):
    """Обработка команды /help."""
    ...
```

**Описание**:
Отправляет пользователю сообщение со списком доступных команд.

**Параметры**:
- `bot` (telebot): Экземпляр телеграм-бота.
- `message` (message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
handler.help_command(bot, message)
```

#### `send_pdf`

```python
def send_pdf(self, bot, message, pdf_file):
    """Обработка команды /sendpdf для отправки PDF."""
    ...
```

**Описание**:
Отправляет пользователю PDF-файл.

**Параметры**:
- `bot` (telebot): Экземпляр телеграм-бота.
- `message` (message): Объект сообщения от пользователя.
- `pdf_file` (str): Путь к PDF-файлу.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
handler.send_pdf(bot, message, 'example.pdf')
```

#### `handle_voice`

```python
def handle_voice(self, bot, message):
    """Обработка голосовых сообщений."""
    ...
```

**Описание**:
Обрабатывает голосовые сообщения, распознает текст и отправляет его пользователю.

**Параметры**:
- `bot` (telebot): Экземпляр телеграм-бота.
- `message` (message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
handler.handle_voice(bot, message)
```

#### `_transcribe_voice`

```python
def _transcribe_voice(self, file_path):
    """Транскрибирование голосового сообщения (заглушка)."""
    ...
```

**Описание**:
Транскрибирует голосовое сообщение (заглушка).

**Параметры**:
- `file_path` (str): Путь к файлу голосового сообщения.

**Возвращает**:
- `str`: Распознанный текст.

**Примеры**:
```python
text = handler._transcribe_voice('voice.ogg')
```

#### `handle_document`

```python
def handle_document(self, bot, message):
    """Обработка полученных документов."""
    ...
```

**Описание**:
Обрабатывает полученные документы, сохраняет их и отправляет пользователю сообщение с путем к файлу.

**Параметры**:
- `bot` (telebot): Экземпляр телеграм-бота.
- `message` (message): Объект сообщения от пользователя.

**Возвращает**:
- `bool`: `True`, если обработка прошла успешно, `False` в случае ошибки.

**Примеры**:
```python
success = handler.handle_document(bot, message)
```

### `Config`

**Описание**:
Класс `Config` предназначен для хранения конфигурационных параметров бота.

**Параметры**:
- `BOT_TOKEN` (str): Токен бота, который зависит от режима работы (`PRODUCTION` или `DEV`) и источника ключей (переменные окружения или база данных).
- `CHANNEL_ID` (str): Идентификатор канала.
- `PHOTO_DIR` (Path): Путь к директории с фотографиями.
- `COMMAND_INFO` (str): Информация о боте, отображаемая по команде `/info`.
- `UNKNOWN_COMMAND_MESSAGE` (str): Сообщение об неизвестной команде.
- `START_MESSAGE` (str): Приветственное сообщение при старте бота.
- `HELP_MESSAGE` (str): Справочное сообщение, отображаемое по команде `/help`.

**Примеры**:
```python
config = Config()
print(config.BOT_TOKEN)
```

## Функции

### `command_start`

```python
@bot.message_handler(commands=['start'])
def command_start(message):
    """Обработка команды /start."""
    ...
```

**Описание**:
Обрабатывает команду `/start`, отправляя приветственное сообщение пользователю.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
# Пример использования обрабатывается непосредственно библиотекой telebot при получении команды /start
```

### `command_help`

```python
@bot.message_handler(commands=['help'])
def command_help(message):
    """Обработка команды /help."""
    ...
```

**Описание**:
Обрабатывает команду `/help`, вызывая метод `help_command` класса `BotHandler` для отправки справочного сообщения.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
# Пример использования обрабатывается непосредственно библиотекой telebot при получении команды /help
```

### `command_info`

```python
@bot.message_handler(commands=['info'])
def command_info(message):
    """Обработка команды /info."""
    ...
```

**Описание**:
Обрабатывает команду `/info`, отправляя информацию о боте.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
# Пример использования обрабатывается непосредственно библиотекой telebot при получении команды /info
```

### `command_time`

```python
@bot.message_handler(commands=['time'])
def command_time(message):
    """Обработка команды /time."""
    ...
```

**Описание**:
Обрабатывает команду `/time`, отправляя текущее время.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
# Пример использования обрабатывается непосредственно библиотекой telebot при получении команды /time
```

### `command_photo`

```python
@bot.message_handler(commands=['photo'])
def command_photo(message):
    """Обработка команды /photo."""
    ...
```

**Описание**:
Обрабатывает команду `/photo`, отправляя случайную фотографию из указанной директории.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
# Пример использования обрабатывается непосредственно библиотекой telebot при получении команды /photo
```

### `handle_voice_message`

```python
@bot.message_handler(content_types=['voice'])
def handle_voice_message(message):
    """Обработка голосовых сообщений."""
    ...
```

**Описание**:
Обрабатывает голосовые сообщения, перенаправляя их в метод `handle_voice` класса `BotHandler`.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
# Пример использования обрабатывается непосредственно библиотекой telebot при получении голосового сообщения
```

### `handle_document_message`

```python
@bot.message_handler(content_types=['document'])
def handle_document_message(message):
    """Обработка полученных документов."""
    ...
```

**Описание**:
Обрабатывает полученные документы, перенаправляя их в метод `handle_document` класса `BotHandler`.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
# Пример использования обрабатывается непосредственно библиотекой telebot при получении документа
```

### `handle_text_message`

```python
@bot.message_handler(func=lambda message: message.text and not message.text.startswith('/'))
def handle_text_message(message):
    """Обработка текстовых сообщений."""
    ...
```

**Описание**:
Обрабатывает текстовые сообщения, перенаправляя их в метод `handle_message` класса `BotHandler`.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
# Пример использования обрабатывается непосредственно библиотекой telebot при получении текстового сообщения
```

### `handle_unknown_command`

```python
@bot.message_handler(func=lambda message: message.text and message.text.startswith('/'))
def handle_unknown_command(message):
    """Обработка неизвестных команд."""
    ...
```

**Описание**:
Обрабатывает неизвестные команды, отправляя сообщение об этом пользователю.

**Параметры**:
- `message` (telebot.types.Message): Объект сообщения от пользователя.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
# Пример использования обрабатывается непосредственно библиотекой telebot при получении неизвестной команды
```

### `main`

```python
def main():
    """Основная функция для запуска бота."""
    ...
```

**Описание**:
Основная функция для запуска бота. Инициализирует и запускает бота в режиме polling.

**Параметры**:
- Отсутствуют.

**Возвращает**:
- Отсутствует.

**Примеры**:
```python
if __name__ == '__main__':
    main()