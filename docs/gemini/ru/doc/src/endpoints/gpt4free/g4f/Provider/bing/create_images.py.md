# Модуль для создания изображений с использованием Bing Image Creator

## Обзор

Модуль предназначен для создания изображений на основе текстового запроса с использованием сервиса Bing Image Creator. Он включает в себя функции для установления сессии с Bing, отправки запроса на генерацию изображений, опроса состояния генерации и извлечения URL-адресов созданных изображений.

## Подробней

Этот модуль является частью проекта `hypotez` и отвечает за взаимодействие с Bing Image Creator для генерации изображений на основе текстовых запросов. Он использует библиотеки `aiohttp` для асинхронных HTTP-запросов и `Beautiful Soup` для парсинга HTML-контента. Модуль обрабатывает различные сценарии, включая ошибки, связанные с ограничениями скорости, блокировкой запросов и другими проблемами, возникающими в процессе создания изображений.

## Функции

### `create_session`

```python
def create_session(cookies: Dict[str, str], proxy: str = None, connector: BaseConnector = None) -> ClientSession:
    """
    Создает новый клиентский сеанс с указанными куки и заголовками.

    Args:
        cookies (Dict[str, str]): Куки, которые будут использованы для сеанса.
        proxy (str, optional): Конфигурация прокси-сервера.
        connector (BaseConnector, optional): Кастомный коннектор для сессии. По умолчанию `None`.

    Returns:
        ClientSession: Созданный клиентский сеанс.
    """
```

**Назначение**: Создание асинхронной клиентской сессии с заданными заголовками и куки для выполнения HTTP-запросов.

**Параметры**:
- `cookies` (Dict[str, str]): Словарь с куками, которые будут добавлены в заголовки сессии.
- `proxy` (str, optional): URL прокси-сервера для использования в сессии. По умолчанию `None`.
- `connector` (BaseConnector, optional):  Позволяет передать готовый коннектор, если необходимо его кастомизировать. По умолчанию `None`.

**Возвращает**:
- `ClientSession`: Объект асинхронной клиентской сессии с настроенными заголовками и куками.

**Как работает функция**:
1. Определяются заголовки HTTP-запроса, включая `User-Agent`, `Accept-Language` и другие необходимые параметры.
2. Если переданы куки (`cookies`), они форматируются и добавляются в заголовок `Cookie`.
3. Создается и возвращается объект `ClientSession` с заданными заголовками и, при необходимости, прокси-сервером.

**Примеры**:

```python
import asyncio
from aiohttp import ClientSession

async def main():
    cookies = {'some_cookie': 'some_value'}
    session = create_session(cookies=cookies)
    async with session:
        # Выполнение запросов с использованием сессии
        pass

asyncio.run(main())
```

### `create_images`

```python
async def create_images(session: ClientSession, prompt: str, timeout: int = TIMEOUT_IMAGE_CREATION) -> List[str]:
    """
    Создает изображения на основе заданного запроса, используя сервис Bing.

    Args:
        session (ClientSession): Активная клиентская сессия.
        prompt (str): Запрос для генерации изображений.
        timeout (int): Таймаут для запроса в секундах.

    Returns:
        List[str]: Список URL-адресов созданных изображений.

    Raises:
        RuntimeError: Если создание изображения не удалось или истекло время ожидания.
    """
```

**Назначение**: Асинхронная функция для генерации изображений на основе заданного текстового запроса с использованием сервиса Bing Image Creator.

**Параметры**:
- `session` (ClientSession): Активная клиентская сессия для выполнения HTTP-запросов.
- `prompt` (str): Текстовый запрос для генерации изображений.
- `timeout` (int, optional): Максимальное время ожидания завершения процесса генерации изображений в секундах. По умолчанию `TIMEOUT_IMAGE_CREATION`.

**Возвращает**:
- `List[str]`: Список URL-адресов сгенерированных изображений.

**Вызывает исключения**:
- `MissingRequirementsError`: Если отсутствует библиотека `beautifulsoup4`.
- `RateLimitError`: Если превышен лимит запросов (нет доступных "монет").
- `RuntimeError`: Если в процессе генерации произошла ошибка (например, запрос заблокирован, таймаут и т.д.).

**Как работает функция**:

1.  **Проверка зависимостей**: Убеждается, что установлена библиотека `beautifulsoup4`. Если нет, вызывает исключение `MissingRequirementsError`.
2.  **Кодирование запроса**: Кодирует текстовый запрос (`prompt`) для использования в URL.
3.  **Отправка запроса**: Отправляет POST-запрос к Bing Image Creator с закодированным запросом.
4.  **Обработка ответов**:
    *   Проверяет наличие ошибок в ответе, таких как "нет доступных монет" (превышен лимит) или блокировка запроса. Если обнаружена ошибка, вызывает исключение `RateLimitError` или `RuntimeError` соответственно.
    *   Если ответ имеет статус 302 (перенаправление), извлекает URL перенаправления и отправляет GET-запрос по этому URL.
    *   Если ответ не является перенаправлением, отправляет повторный POST-запрос с другим значением параметра `rt`.
5.  **Опрос состояния**: Опрашивает сервис Bing Image Creator до тех пор, пока не получит результат или не истечет время ожидания (`timeout`).
6.  **Извлечение изображений**: Когда изображения сгенерированы, извлекает URL-адреса изображений из полученного HTML-кода с помощью функции `read_images`.
7.  **Обработка ошибок**: Проверяет наличие ошибок в процессе опроса и вызывает исключение `RuntimeError` в случае их обнаружения.

```
    Начало
    │
    ├── Проверка зависимостей (beautifulsoup4)
    │   └── Если отсутствует: MissingRequirementsError
    │
    ├── Кодирование запроса (prompt)
    │
    ├── Отправка POST-запроса к Bing Image Creator
    │
    ├── Обработка ответа
    │   ├── Проверка на ошибки (лимит, блокировка)
    │   │   └── Если ошибка: RateLimitError или RuntimeError
    │   ├── Если перенаправление (302):
    │   │   └── Отправка GET-запроса по URL перенаправления
    │   └── Иначе:
    │       └── Отправка повторного POST-запроса с другим значением параметра rt
    │
    ├── Опрос состояния (polling) до получения результата или таймаута
    │   ├── Если таймаут: RuntimeError
    │   └── Если ошибка в процессе опроса: RuntimeError
    │
    └── Извлечение URL-адресов изображений (read_images)
        │
        └── Возврат списка URL-адресов
```

**Примеры**:

```python
import asyncio
from aiohttp import ClientSession

async def main():
    async with ClientSession() as session:
        prompt = "A futuristic cityscape"
        try:
            image_urls = await create_images(session, prompt)
            print("Image URLs:", image_urls)
        except Exception as ex:
            print(f"Error creating images: {ex}")

asyncio.run(main())
```

### `read_images`

```python
def read_images(html_content: str) -> List[str]:
    """
    Извлекает URL-адреса изображений из HTML-контента.

    Args:
        html_content (str): HTML-контент, содержащий URL-адреса изображений.

    Returns:
        List[str]: Список URL-адресов изображений.

    Raises:
        RuntimeError: Если не удалось найти изображения или найдены плохие изображения.
    """
```

**Назначение**: Извлечение URL-адресов изображений из HTML-контента, полученного от Bing Image Creator.

**Параметры**:
- `html_content` (str): HTML-контент, содержащий URL-адреса изображений.

**Возвращает**:
- `List[str]`: Список URL-адресов изображений, извлеченных из HTML-контента.

**Вызывает исключения**:
- `RuntimeError`: Если не удалось найти изображения или найдены изображения, содержащиеся в списке `BAD_IMAGES`.

**Как работает функция**:

1.  **Парсинг HTML**: Использует `Beautiful Soup` для парсинга HTML-контента.
2.  **Поиск тегов**: Ищет все теги `img` с классами `mimg` или `gir_mmimg`, которые содержат URL-адреса изображений.
3.  **Извлечение URL-адресов**: Извлекает атрибут `src` из каждого найденного тега `img` и удаляет параметры запроса после `?w=`.
4.  **Проверка изображений**: Проверяет, не содержатся ли URL-адреса изображений в списке `BAD_IMAGES`. Если содержатся, вызывает исключение `RuntimeError`.
5.  **Проверка наличия изображений**: Проверяет, был ли найден хотя бы один URL-адрес изображения. Если нет, вызывает исключение `RuntimeError`.

```
    Начало
    │
    ├── Парсинг HTML (Beautiful Soup)
    │
    ├── Поиск тегов <img> с классами mimg или gir_mmimg
    │
    ├── Извлечение атрибута src из тегов <img>
    │   └── Удаление параметров запроса после ?w=
    │
    ├── Проверка URL-адресов на наличие в списке BAD_IMAGES
    │   └── Если найдены: RuntimeError
    │
    ├── Проверка наличия URL-адресов
    │   └── Если не найдены: RuntimeError
    │
    └── Возврат списка URL-адресов
```

**Примеры**:

```python
html_content = """
<img class="mimg" src="https://example.com/image1.jpg?w=300">
<img class="gir_mmimg" src="https://example.com/image2.jpg?w=300">
"""
image_urls = read_images(html_content)
print("Image URLs:", image_urls)  # Вывод: ['https://example.com/image1.jpg', 'https://example.com/image2.jpg']