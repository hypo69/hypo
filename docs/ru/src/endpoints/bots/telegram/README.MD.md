# Документация модуля `src.endpoints.bots.telegram`

## Обзор

Этот модуль содержит код для создания и управления Telegram-ботом. Бот выполняет несколько функций, связанных с обработкой команд, голосовых сообщений и взаимодействием с пользователями в Telegram.

## Подробней

Модуль `src.endpoints.bots.telegram` предоставляет функциональность для создания Telegram-бота, способного обрабатывать команды, голосовые сообщения и документы. Он использует библиотеку `python-telegram-bot` для взаимодействия с Telegram API и включает функции для транскрибирования голосовых сообщений и чтения содержимого текстовых документов.

## Содержание

- [Основные функции и команды бота](#основные-функции-и-команды-бота)
- [Основные модули и библиотеки](#основные-модули-и-библиотеки)
- [Классы и методы](#классы-и-методы)
- [Основная функция](#основная-функция)

## Основные функции и команды бота:

1. **Инициализация бота:**
   - Бот инициализируется с токеном, который используется для аутентификации бота в Telegram API.

2. **Команды:**
   - `/start`: Отправляет приветственное сообщение пользователю.
   - `/help`: Предоставляет список доступных команд.
   - `/sendpdf`: Отправляет PDF-файл пользователю.

3. **Обработка сообщений:**
   - Бот обрабатывает входящие текстовые сообщения, голосовые сообщения и файлы документов.
   - Для голосовых сообщений бот транскрибирует аудио (в настоящее время это функция-заполнитель).
   - Для файлов документов бот считывает содержимое текстового документа.

4. **Обработка голосовых сообщений:**
   - Бот загружает файл голосового сообщения, сохраняет его локально и пытается транскрибировать его с использованием службы распознавания речи (в настоящее время это функция-заполнитель).

5. **Обработка документов:**
   - Бот загружает файл документа, сохраняет его локально и считывает содержимое текстового документа.

6. **Обработка текстовых сообщений:**
   - Бот просто возвращает текст, полученный от пользователя.

## Основные модули и библиотеки:

- `python-telegram-bot`: Основная библиотека для создания Telegram-ботов.
- `pathlib`: Для работы с путями к файлам.
- `tempfile`: Для создания временных файлов.
- `asyncio`: Для асинхронного выполнения задач.
- `requests`: Для загрузки файлов.
- `src.utils.convertors.tts`: Для распознавания речи и преобразования текста в речь.
- `src.utils.file`: Для чтения текстовых файлов.

## Классы и методы:

### `TelegramBot Class`

Описание класса TelegramBot.

**Принцип работы:**
Класс `TelegramBot` предназначен для управления Telegram-ботом. Он инициализируется с помощью токена, регистрирует обработчики команд и сообщений, а также предоставляет методы для обработки различных типов входящих данных, таких как текстовые сообщения, голосовые сообщения и документы.

- `__init__(self, token: str)`: Инициализирует бота с токеном и регистрирует обработчики.
    - **Параметры**:
        - `token` (str): Токен бота, полученный от BotFather в Telegram.
    - **Как работает**:
        1. Сохраняет токен бота в атрибуте `token`.
        2. Создает экземпляр `Application` из библиотеки `python-telegram-bot`.
        3. Вызывает метод `register_handlers` для регистрации обработчиков команд и сообщений.
        4. Сохраняет экземпляр `Application` в атрибуте `application`.

```
Инициализация токеном
↓
Создание Application
↓
Регистрация обработчиков
↓
Сохранение Application
```

- `register_handlers(self)`: Регистрирует обработчики команд и сообщений.
    - **Как работает**:
        1. Добавляет обработчик команды `/start` с помощью `CommandHandler`.
        2. Добавляет обработчик команды `/help` с помощью `CommandHandler`.
        3. Добавляет обработчик команды `/sendpdf` с помощью `CommandHandler`.
        4. Добавляет обработчик текстовых сообщений с помощью `MessageHandler`.
        5. Добавляет обработчик голосовых сообщений с помощью `MessageHandler`.
        6. Добавляет обработчик документов с помощью `MessageHandler`.

```
Добавление обработчика /start
↓
Добавление обработчика /help
↓
Добавление обработчика /sendpdf
↓
Добавление обработчика текстовых сообщений
↓
Добавление обработчика голосовых сообщений
↓
Добавление обработчика документов
```

- `start(self, update: Update, context: CallbackContext)`: Обрабатывает команду `/start`.
    - **Параметры**:
        - `update` (Update): Объект, представляющий входящее обновление от Telegram.
        - `context` (CallbackContext): Объект, содержащий информацию о контексте команды.
    - **Как работает**:
        1. Отправляет приветственное сообщение пользователю с использованием `update.message.reply_text`.

```
Получение update и context
↓
Отправка приветственного сообщения
```

- `help_command(self, update: Update, context: CallbackContext)`: Обрабатывает команду `/help`.
    - **Параметры**:
        - `update` (Update): Объект, представляющий входящее обновление от Telegram.
        - `context` (CallbackContext): Объект, содержащий информацию о контексте команды.
    - **Как работает**:
        1. Отправляет сообщение со списком доступных команд с использованием `update.message.reply_text`.

```
Получение update и context
↓
Отправка списка команд
```

- `send_pdf(self, pdf_file: str | Path)`: Обрабатывает команду `/sendpdf` для отправки PDF-файла.
    - **Параметры**:
        - `pdf_file` (str | Path): Путь к PDF-файлу.
    - **Как работает**:
        1. Отправляет PDF-файл пользователю.

```
Получение пути к PDF-файлу
↓
Отправка PDF-файла
```

- `handle_voice(self, update: Update, context: CallbackContext)`: Обрабатывает голосовые сообщения и транскрибирует аудио.
    - **Параметры**:
        - `update` (Update): Объект, представляющий входящее обновление от Telegram.
        - `context` (CallbackContext): Объект, содержащий информацию о контексте команды.
    - **Как работает**:
        1. Извлекает файл голосового сообщения из `update.message.voice`.
        2. Загружает файл голосового сообщения.
        3. Сохраняет файл локально во временном файле.
        4. Транскрибирует голосовое сообщение с использованием `self.transcribe_voice`.
        5. Отправляет транскрибированный текст пользователю.

```
Извлечение файла голосового сообщения
↓
Загрузка файла
↓
Сохранение файла локально
↓
Транскрибирование голосового сообщения
↓
Отправка транскрибированного текста
```

- `transcribe_voice(self, file_path: Path) -> str`: Транскрибирует голосовые сообщения (функция-заполнитель).
    - **Параметры**:
        - `file_path` (Path): Путь к файлу голосового сообщения.
    - **Возвращает**:
        - `str`: Транскрибированный текст (в настоящее время возвращает "Транскрипция недоступна").
    - **Как работает**:
        1. Возвращает строку "Транскрипция недоступна".

```
Получение пути к файлу
↓
Возврат "Транскрипция недоступна"
```

- `handle_document(self, update: Update, context: CallbackContext) -> str`: Обрабатывает файлы документов и считывает их содержимое.
    - **Параметры**:
        - `update` (Update): Объект, представляющий входящее обновление от Telegram.
        - `context` (CallbackContext): Объект, содержащий информацию о контексте команды.
    - **Возвращает**:
        - `str`: Содержимое текстового документа.
    - **Как работает**:
        1. Извлекает файл документа из `update.message.document`.
        2. Загружает файл документа.
        3. Сохраняет файл локально во временном файле.
        4. Читает содержимое текстового документа.
        5. Отправляет содержимое документа пользователю.

```
Извлечение файла документа
↓
Загрузка файла
↓
Сохранение файла локально
↓
Чтение содержимого документа
↓
Отправка содержимого документа
```

- `handle_message(self, update: Update, context: CallbackContext) -> str`: Обрабатывает текстовые сообщения и возвращает полученный текст.
    - **Параметры**:
        - `update` (Update): Объект, представляющий входящее обновление от Telegram.
        - `context` (CallbackContext): Объект, содержащий информацию о контексте команды.
    - **Возвращает**:
        - `str`: Текст полученного сообщения.
    - **Как работает**:
        1. Извлекает текст сообщения из `update.message.text`.
        2. Отправляет текст обратно пользователю.

```
Извлечение текста сообщения
↓
Отправка текста обратно пользователю
```

**Примеры**:

```python
# Пример инициализации Telegram-бота
from telegram.ext import Application

# Укажите ваш токен бота
TOKEN = "YOUR_TELEGRAM_BOT_TOKEN"

# Создание экземпляра приложения
application = Application.builder().token(TOKEN).build()
```

## Основная функция:

### `main()`

Инициализирует бота, регистрирует обработчики команд и сообщений и запускает бота с использованием `run_polling()`.

**Как работает**:
1. Получает токен бота из переменной окружения `TELEGRAM_BOT_TOKEN`.
2. Создает экземпляр класса `TelegramBot`.
3. Запускает бота с использованием `bot.application.run_polling()`.

```
Получение токена
↓
Создание экземпляра TelegramBot
↓
Запуск бота
```
```python
# Входная точка для запуска Telegram-бота
if __name__ == '__main__':
    main()