# Модуль `Theb`

## Обзор

Модуль `Theb` предоставляет интерфейс для взаимодействия с сервисом `TheB.AI` для генерации текста на основе предоставленных сообщений. Он использует веб-драйвер для автоматизации взаимодействия с веб-интерфейсом `TheB.AI`.

## Подробней

Этот модуль является провайдером для проекта `hypotez`, позволяя использовать модели, предоставляемые `TheB.AI`, для создания завершений текста. Модуль поддерживает потоковую передачу ответов и использует `selenium` для взаимодействия с веб-сайтом.

## Классы

### `Theb(AbstractProvider)`

**Описание**: Класс `Theb` наследуется от `AbstractProvider` и предоставляет методы для взаимодействия с сервисом `TheB.AI`.

**Наследует**:
- `AbstractProvider`: Абстрактный класс, определяющий интерфейс для провайдеров.

**Атрибуты**:
- `label` (str): Метка провайдера, в данном случае `"TheB.AI"`.
- `url` (str): URL веб-сайта `TheB.AI` - `"https://beta.theb.ai"`.
- `working` (bool): Указывает, работает ли провайдер в данный момент. По умолчанию `False`.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу ответов. Установлено в `True`.
- `models` (dict): Словарь, содержащий доступные модели.

**Методы**:
- `create_completion`: Создает завершение текста на основе предоставленных сообщений.

## Функции

### `create_completion`

```python
@classmethod
def create_completion(
    cls,
    model: str,
    messages: Messages,
    stream: bool,
    proxy: str = None,
    webdriver: WebDriver = None,
    virtual_display: bool = True,
    **kwargs
) -> CreateResult:
    """
    Создает завершение текста на основе предоставленных сообщений, используя веб-интерфейс TheB.AI.

    Args:
        cls: Класс, для которого вызывается метод.
        model (str): Название модели для использования.
        messages (Messages): Список сообщений для отправки модели.
        stream (bool): Указывает, следует ли использовать потоковую передачу ответов.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        webdriver (WebDriver, optional): Инстанс веб-драйвера для управления браузером. По умолчанию `None`.
        virtual_display (bool, optional): Указывает, следует ли использовать виртуальный дисплей. По умолчанию `True`.
        **kwargs: Дополнительные параметры.

    Returns:
        CreateResult: Результат создания завершения текста.

    Raises:
        Exception: Если возникает ошибка при взаимодействии с веб-сайтом.
    """
```

**Назначение**:
Функция `create_completion` отвечает за создание запроса к сервису `TheB.AI` для генерации текста. Она использует веб-драйвер `selenium` для автоматизации взаимодействия с веб-интерфейсом, отправляет промпт и получает ответ, который может быть передан в потоковом режиме.

**Параметры**:
- `cls`: Ссылка на класс.
- `model` (str): Имя используемой модели. Если `model` находится в словаре `models`, то происходит замена на соответствующее значение.
- `messages` (Messages): Список сообщений, используемых для формирования запроса.
- `stream` (bool): Флаг, указывающий на использование потоковой передачи данных.
- `proxy` (str, optional): Адрес прокси-сервера. По умолчанию `None`.
- `webdriver` (WebDriver, optional): Экземпляр веб-драйвера. По умолчанию `None`.
- `virtual_display` (bool, optional): Флаг использования виртуального дисплея. По умолчанию `True`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `CreateResult`: Результат создания, который является генератором, выдающим части ответа.

**Вызывает исключения**:
- `Exception`: В случае возникновения ошибок при взаимодействии с веб-сайтом.

**Как работает функция**:

1. **Преобразование модели**: Если имя модели есть в словаре `models`, оно заменяется на соответствующее значение.
2. **Форматирование промпта**: Форматирует входные сообщения (`messages`) в строку промпта с помощью функции `format_prompt`.
3. **Создание веб-сессии**: Инициализирует сессию веб-драйвера с использованием класса `WebDriverSession`, который управляет веб-драйвером и виртуальным дисплеем.
4. **Настройка перехвата fetch**: Внедряет JavaScript-код для перехвата запросов `fetch`, чтобы получить ответ от сервера. Скрипт перехватывает ответ только для URL, начинающихся с `/api/conversation`.
5. **Навигация и ожидание загрузки**: Открывает веб-страницу `TheB.AI`, используя `driver.get`, и ожидает появления элемента с `ID` "textareaAutosize". Если возникает исключение, пытается повторно открыть сессию и повторно внедрить JavaScript-код.
6. **Отправка промпта**: Находит поле ввода с `ID` "textareaAutosize" и отправляет в него отформатированный промпт с помощью функции `element_send_text`.
7. **Чтение ответа**: Использует JavaScript-код для чтения ответа от сервера по частям и возвращает их как генератор.
8. **Потоковая передача**: Возвращает ответ в виде потока, если `stream = True`.

**Внутренние функции**:
- Отсутствуют.

**ASCII Flowchart**:

```
A [Преобразование модели и форматирование промпта]
|
B [Создание веб-сессии]
|
C [Настройка перехвата fetch через JavaScript]
|
D [Навигация на веб-страницу и ожидание загрузки]
|
E [Отправка промпта в поле ввода]
|
F [Чтение ответа с использованием JavaScript]
|
G [Потоковая передача ответа]
```

**Примеры**:

```python
# Пример 1: Создание завершения с использованием потоковой передачи
model_name = "gpt-3.5-turbo"
messages_example = [{"role": "user", "content": "Напиши короткий рассказ о космосе."}]
stream_enabled = True
result = Theb.create_completion(model=model_name, messages=messages_example, stream=stream_enabled)
for chunk in result:
    print(chunk, end="")

# Пример 2: Создание завершения без потоковой передачи
model_name = "gpt-4"
messages_example = [{"role": "user", "content": "Перечисли 5 самых высоких гор в мире."}]
stream_enabled = False
result = Theb.create_completion(model=model_name, messages=messages_example, stream=stream_enabled)
print("".join(result))