# Модуль для работы с видео
=================================================

Модуль предоставляет асинхронные функции для загрузки и сохранения видеофайлов, а также для получения видеоданных. Он включает в себя обработку ошибок и логирование для обеспечения надежной работы.

Пример использования
----------------------

```python
>>> import asyncio
>>> asyncio.run(save_video_from_url("https://example.com/video.mp4", "local_video.mp4"))
PosixPath('local_video.mp4')  # or None if failed

>>> data = get_video_data("local_video.mp4")
>>> if data:
...     print(data[:10])  # Print first 10 bytes to check
b'\x00\x00\x00...'
```

## Оглавление

- [Обзор](#обзор)
- [Подробнее](#подробнее)
- [Функции](#функции)
    - [`save_video_from_url`](#save_video_from_url)
    - [`get_video_data`](#get_video_data)
    - [`main`](#main)

## Обзор

Модуль `src.utils.video` предоставляет утилиты для асинхронной загрузки и сохранения видеофайлов, а также для получения данных видео. Он разработан для работы с сетевыми запросами и файловой системой, обеспечивая логирование и обработку исключений.

## Подробнее

Данный модуль содержит функции для асинхронной загрузки видеофайлов из сети и сохранения их локально, а также для чтения данных видеофайлов. Он использует библиотеки `aiohttp` для асинхронных HTTP-запросов, `aiofiles` для асинхронной работы с файлами, `pathlib` для работы с путями и `src.logger.logger` для логирования. Модуль предназначен для использования в проектах, где требуется эффективная работа с видеоконтентом, минимизация блокирующих операций и надежная обработка ошибок.

## Функции

### `save_video_from_url`

```python
async def save_video_from_url(
    url: str,
    save_path: str
) -> Optional[Path]:
    """Download a video from a URL and save it locally asynchronously.

    Args:
        url (str): The URL from which to download the video.
        save_path (str): The path to save the downloaded video.

    Returns:
        Optional[Path]: The path to the saved file, or `None` if the operation failed.  Returns None on errors and if file is 0 bytes.

    Raises:
        aiohttp.ClientError: on network issues during the download.
    """
```

**Назначение**: Асинхронно загружает видеофайл из указанного URL и сохраняет его локально по указанному пути.

**Параметры**:
- `url` (str): URL-адрес, из которого нужно загрузить видео.
- `save_path` (str): Путь для сохранения загруженного видео.

**Возвращает**:
- `Optional[Path]`: Путь к сохраненному файлу в виде объекта `Path`, или `None`, если операция не удалась. Возвращает `None` при ошибках и если размер файла равен 0 байт.

**Вызывает исключения**:
- `aiohttp.ClientError`: Возникает при сетевых проблемах во время загрузки.

**Как работает функция**:

1.  **Инициализация**: Функция принимает URL-адрес видео и путь для сохранения.
2.  **Создание пути**: Преобразует путь сохранения в объект `Path`.
3.  **Асинхронный HTTP-запрос**:
    *   Создает асинхронную сессию клиента с помощью `aiohttp.ClientSession`.
    *   Выполняет `GET` запрос к указанному URL.
    *   Проверяет статус ответа на наличие HTTP-ошибок.
4.  **Создание директорий**: Создает родительские директории для пути сохранения, если они не существуют.
5.  **Асинхронная запись файла**:
    *   Открывает файл для записи в бинарном режиме с использованием `aiofiles.open`.
    *   Читает содержимое ответа чанками размером 8192 байта.
    *   Записывает каждый чанк в файл до тех пор, пока не будет достигнут конец потока.
6.  **Проверки после сохранения**:
    *   Проверяет, был ли файл успешно сохранен.
    *   Проверяет, не является ли сохраненный файл пустым.
7.  **Обработка ошибок**:
    *   Ловит исключения `aiohttp.ClientError` при сетевых проблемах.
    *   Ловит общие исключения `Exception` при других ошибках.
8.  **Логирование**: В случае ошибок записывает сообщения об ошибках в лог.
9.  **Возврат значения**: Возвращает путь к сохраненному файлу или `None` в случае ошибки.

```
    Начало
    ↓
    Создание HTTP сессии
    ↓
    GET запрос к URL
    ↓
    Проверка HTTP статуса
    ↓
    Создание директорий
    ↓
    Открытие файла для записи
    ↓
    Чтение и запись чанков
    ↓
    Проверка сохранения файла
    ↓
    Проверка размера файла
    ↓
    Конец (успех или ошибка)
```

**Примеры**:

```python
import asyncio
from pathlib import Path

# Пример успешного сохранения видео
url = "https://example.com/video.mp4"  # Замените на реальный URL
save_path = "local_video.mp4"
result = asyncio.run(save_video_from_url(url, save_path))
if result:
    print(f"Видео сохранено в {result}")

# Пример обработки ошибки при загрузке видео
url = "https://example.com/nonexistent_video.mp4"  # Несуществующий URL
save_path = "local_video.mp4"
result = asyncio.run(save_video_from_url(url, save_path))
if result is None:
    print("Не удалось сохранить видео")

# Пример с указанием пути сохранения в подкаталог
url = "https://example.com/video.mp4"
save_path = "videos/local_video.mp4"  # Сохранение в подкаталог "videos"
result = asyncio.run(save_video_from_url(url, save_path))
if result:
    print(f"Видео сохранено в {result}")
```

### `get_video_data`

```python
def get_video_data(file_name: str) -> Optional[bytes]:
    """Retrieve binary data of a video file if it exists.

    Args:
        file_name (str): The path to the video file to read.

    Returns:
        Optional[bytes]: The binary data of the file if it exists, or `None` if the file is not found or an error occurred.
    """
```

**Назначение**: Извлекает бинарные данные видеофайла, если он существует.

**Параметры**:
- `file_name` (str): Путь к видеофайлу, который нужно прочитать.

**Возвращает**:
- `Optional[bytes]`: Бинарные данные файла, если он существует, или `None`, если файл не найден или произошла ошибка.

**Как работает функция**:

1.  **Инициализация**: Функция принимает имя файла видео.
2.  **Создание пути**: Преобразует имя файла в объект `Path`.
3.  **Проверка существования файла**: Проверяет, существует ли файл по указанному пути.
4.  **Чтение файла**:
    *   Открывает файл для чтения в бинарном режиме.
    *   Читает все содержимое файла.
5.  **Обработка ошибок**:
    *   Ловит исключения `Exception` при ошибках чтения файла.
6.  **Логирование**: В случае ошибок записывает сообщения об ошибках в лог.
7.  **Возврат значения**: Возвращает бинарные данные файла или `None` в случае ошибки или отсутствия файла.

```
    Начало
    ↓
    Проверка существования файла
    ↓
    Открытие файла для чтения
    ↓
    Чтение данных из файла
    ↓
    Конец (успех или ошибка)
```

**Примеры**:

```python
# Пример успешного чтения данных видео
file_name = "local_video.mp4"
data = get_video_data(file_name)
if data:
    print(f"Размер видео: {len(data)} байт")

# Пример обработки ошибки, если файл не найден
file_name = "nonexistent_video.mp4"
data = get_video_data(file_name)
if data is None:
    print("Файл не найден")
```

### `main`

```python
def main():
    url = "https://example.com/video.mp4"  # Replace with a valid URL!
    save_path = "local_video.mp4"
    result = asyncio.run(save_video_from_url(url, save_path))
    if result:
        print(f"Video saved to {result}")
```

**Назначение**: Главная функция для демонстрации работы `save_video_from_url`.

**Как работает функция**:

1.  **Определение URL и пути сохранения**: Устанавливает URL видео и путь для сохранения.
2.  **Запуск асинхронной загрузки**: Вызывает функцию `save_video_from_url` для асинхронной загрузки и сохранения видео.
3.  **Вывод результата**: Выводит сообщение об успешном сохранении видео, если операция прошла успешно.

**Примеры**:

```python
# Пример запуска main
if __name__ == "__main__":
    main()