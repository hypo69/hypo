## <алгоритм>

**1. `ResultsExtractor` Класс:**

   - **Инициализация (`__init__`)**:
     - Загружает шаблон запроса для извлечения результатов из файла `interaction_results_extractor.mustache`.
     - Инициализирует пустые словари `agent_extraction` и `world_extraction` для кэширования результатов извлечения.
   - **`extract_results_from_agent`**:
     - Принимает экземпляр `TinyPerson`, цель извлечения (`extraction_objective`), контекст (`situation`), список полей для извлечения (`fields`), подсказки к полям `fields_hints` и флаг `verbose`.
     - Формирует системное сообщение для LLM, используя шаблон `interaction_results_extractor.mustache` и переданные поля и подсказки.
     - Получает историю взаимодействий агента с помощью `tinyperson.pretty_current_interactions()`.
     - Формирует запрос пользователю, включающий цель извлечения, контекст и историю взаимодействий.
     - Отправляет запрос в LLM через `openai_utils.client().send_message()`.
     - Извлекает JSON из ответа LLM с помощью `utils.extract_json()`.
     - Кэширует результат в `agent_extraction` по имени агента.
     - Возвращает извлеченный результат.

    **Пример:**
      Представим, что у нас есть агент по имени `Alice` с историей взаимодействий. Вызов `extract_results_from_agent(tinyperson=Alice, extraction_objective="Основные моменты", fields=["действие", "время"])` выполнит шаги, описанные выше, для извлечения основных моментов из истории взаимодействий агента `Alice`,  ограничив извлечение полями `действие` и `время`. Результат будет сохранен в `self.agent_extraction["Alice"]`.

   - **`extract_results_from_world`**:
     - Принимает экземпляр `TinyWorld`, цель извлечения, контекст, список полей для извлечения и флаг `verbose`.
     - Аналогичен `extract_results_from_agent`, но работает с историей взаимодействий мира (`tinyworld.pretty_current_interactions()`) и сохраняет результат в `world_extraction` по имени мира.

    **Пример:**
      У нас есть мир `World1` с историей взаимодействий между его агентами. Вызов `extract_results_from_world(tinyworld=World1, extraction_objective="Основные темы", fields=["агент", "сообщение"])` выполнит аналогичные шаги, но для мира `World1`, извлекая основные темы по полям `агент` и `сообщение`. Результат будет сохранен в `self.world_extraction["World1"]`.

   - **`save_as_json`**:
     - Сохраняет кэшированные результаты извлечения (`agent_extraction`, `world_extraction`) в JSON-файл.
    **Пример:**
      Вызов `save_as_json("output.json")` сохранит все извлеченные данные агентов и миров в файл `output.json`.

**2. `ResultsReducer` Класс:**

   - **Инициализация (`__init__`)**:
     - Инициализирует пустые словари `results` и `rules`.
   - **`add_reduction_rule`**:
     - Добавляет правило сокращения (функцию) в словарь `rules` по ключу `trigger` (тип сообщения).
    **Пример:**
        `add_reduction_rule("chat", function)` добавит функцию сокращения `function` в качестве правила для сообщений типа "chat".
   - **`reduce_agent`**:
     - Принимает экземпляр `TinyPerson`.
     - Проходит по всем сообщениям в эпизодической памяти агента.
     - Если сообщение системное, пропускает.
     - Если сообщение от пользователя (`'role' == 'user'`):
       - Извлекает тип стимула, контент и источник стимула, а так же время стимула.
       - Если есть правило для типа стимула, применяет его (вызывает функцию из `self.rules`) и добавляет результат в список `reduction`.
     - Если сообщение от ассистента (`'role' == 'assistant'`):
       - Извлекает тип действия, контент и цель действия, а так же время действия.
       - Если есть правило для типа действия, применяет его и добавляет результат в список `reduction`.
     - Возвращает список сокращенных результатов.

    **Пример:**
       Вызов `reduce_agent(agent=Alice)` для агента `Alice` приведет к обработке всей истории взаимодействий агента, применению заданных правил (если они есть) и возвращению списка сокращенных данных.
   - **`reduce_agent_to_dataframe`**:
      - Принимает экземпляр `TinyPerson` и список имен колонок.
      - Вызывает `reduce_agent` для получения списка сокращенных результатов.
      - Создает и возвращает `pandas.DataFrame` из списка, используя `column_names` как имена столбцов.
      **Пример:**
        Вызов `reduce_agent_to_dataframe(agent=Alice, column_names=["type", "event", "content"])` вернет `pandas.DataFrame` с сокращенными данными для агента `Alice` и заголовками колонок `type`, `event`, `content`.

**3. `ArtifactExporter` Класс:**

   - **Инициализация (`__init__`)**:
     - Принимает путь к базовой папке вывода (`base_output_folder`).
   - **`export`**:
     - Принимает имя артефакта, данные артефакта (словарь или строка), тип контента, формат контента, целевой формат и флаг `verbose`.
     - Очищает имя артефакта от недопустимых символов.
     - Составляет путь к файлу с помощью `_compose_filepath`.
     - В зависимости от `target_format`, вызывает соответствующие методы для сохранения (`_export_as_json`, `_export_as_txt`, `_export_as_docx`).
    **Пример:**
      Вызов `export(artifact_name="report", artifact_data={"content": "Some text"}, content_type="report", target_format="json")` создаст файл `report.json` в соответствующей папке.
   - **`_export_as_txt`**:
     - Сохраняет данные в текстовый файл.
   - **`_export_as_json`**:
     - Сохраняет данные в JSON-файл.
   - **`_export_as_docx`**:
     - Преобразует данные (сначала в HTML) и сохраняет их в DOCX-файл, используя `pypandoc`.
   - **`_compose_filepath`**:
     - Составляет полный путь к файлу, включая имя, расширение и путь к папке.

**4. `Normalizer` Класс:**

   - **Инициализация (`__init__`)**:
     - Принимает список элементов для нормализации (`elements`), количество нормализованных элементов (`n`) и флаг `verbose`.
     - Отправляет запрос в LLM для получения нормализованных элементов.
     - Сохраняет результат в `self.normalized_elements`.
   - **`normalize`**:
     - Принимает один элемент или список элементов для нормализации.
     - Использует кэш `self.normalizing_map` для ускорения работы.
     - Если элемент не в кэше, отправляет запрос в LLM и добавляет нормализованные элементы в кэш.
     - Возвращает нормализованный элемент или список элементов, сохраняя их порядок.
    **Пример:**
       После инициализации `normalizer = Normalizer(elements=["cat", "dog", "bird"], n=2)` вызов `normalizer.normalize(["dog", "mouse", "bird"])` вернет список из 2 нормализованных элементов, например `["pet", "unknown", "bird"]`.

**5. `default_extractor`:**
   - Создает экземпляр класса `ResultsExtractor`.

## <mermaid>

```mermaid
graph LR
    A[ResultsExtractor] --> B(extract_results_from_agent);
    A --> C(extract_results_from_world);
    A --> D(save_as_json);
    B --> E[openai_utils.client().send_message()];
    C --> E;
    E --> F(utils.extract_json);
    F --> B;
    F --> C;
    G[TinyPerson] --> B;
    H[TinyWorld] --> C;
    
    I[ResultsReducer] --> J(add_reduction_rule);
    I --> K(reduce_agent);
    I --> L(reduce_agent_to_dataframe);
    K --> M[agent.episodic_memory.retrieve_all()];
    M --> K;
    G --> K;
    K --> N{rules[stimulus_type]};
    K --> O{rules[action_type]};
    N --> K;
    O --> K;
    K --> L;

    P[ArtifactExporter] --> Q(export);
    Q --> R(_compose_filepath);
    Q --> S(_export_as_json);
    Q --> T(_export_as_txt);
    Q --> U(_export_as_docx);
    R --> Q;
    S --> Q;
    T --> Q;
    U --> Q;

    V[Normalizer] --> W(normalize);
    V --> X(openai_utils.client().send_message);
    X --> Y(utils.extract_json);
    Y --> V;
    W --> Z{element in self.normalizing_map};
    Z -- Yes --> W
    Z -- No --> AA[openai_utils.client().send_message];
    AA --> AB(utils.extract_json);
    AB --> W;
    
    
    
    subgraph Results Extraction
    B
    C
    D
    E
    F
    end
    subgraph Results Reduction
    J
    K
    L
    M
    N
    O
    end
    subgraph Artifact Export
    Q
    R
    S
    T
    U
    end
    subgraph Normalization
    W
    X
    Y
    AA
    AB
    end
```

**Описание `mermaid` диаграммы:**

- **`ResultsExtractor`**:
    - `extract_results_from_agent`: Извлекает данные из объекта `TinyPerson` с использованием LLM.
    - `extract_results_from_world`: Извлекает данные из объекта `TinyWorld` с использованием LLM.
    - `save_as_json`: Сохраняет извлеченные данные в JSON-файл.
- **`TinyPerson` и `TinyWorld`**:
    - Представляют собой входные данные для `ResultsExtractor`.
- **`openai_utils.client().send_message()`**:
    - Отправляет запросы к LLM для извлечения данных.
- **`utils.extract_json()`**:
    - Извлекает JSON из ответа LLM.
- **`ResultsReducer`**:
    - `add_reduction_rule`: Добавляет правило для сокращения данных.
    - `reduce_agent`: Сокращает данные из памяти агента, применяя правила.
    - `reduce_agent_to_dataframe`: Преобразует сокращенные данные в `pandas.DataFrame`.
- **`agent.episodic_memory.retrieve_all()`**:
    - Получает все сообщения из эпизодической памяти агента.
- **`ArtifactExporter`**:
    - `export`: Экспортирует данные в файл в зависимости от формата.
    - `_compose_filepath`: Создает путь к файлу.
    - `_export_as_json`: Сохраняет данные в JSON-файл.
    - `_export_as_txt`: Сохраняет данные в текстовый файл.
    - `_export_as_docx`: Сохраняет данные в DOCX-файл.
- **`Normalizer`**:
    - `normalize`: Нормализует текстовые элементы с использованием LLM и кэширования.
- **`default_extractor`**:
    - Экземпляр класса `ResultsExtractor`, используемый по умолчанию.

**Импортированные зависимости `mermaid`:**

- `openai_utils` - отправка запросов к LLM.
- `utils` - утилиты для извлечения JSON и других операций.
- `pandas` - работа с DataFrame.
- `markdown` - конвертация markdown в html.
- `pypandoc` - конвертация в docx.

## <объяснение>

**Импорты:**

-   `os`: Для работы с путями к файлам и директориями.
-   `json`: Для работы с данными в формате JSON.
-   `chevron`: Для рендеринга шаблонов.
-   `logging`: Для логирования событий и отладочных сообщений.
-   `pandas`: Для работы с данными в формате `DataFrame`.
-   `pypandoc`: Для конвертации форматов документов, например, из markdown в docx.
-   `markdown`: Для конвертации markdown в HTML.
-   `typing.Union`, `typing.List`: Для аннотации типов.
-   `tinytroupe.agent.TinyPerson`: Класс агента.
-   `tinytroupe.environment.TinyWorld`: Класс мира.
-   `tinytroupe.factory.TinyPersonFactory`: Фабрика для создания агентов.
-   `tinytroupe.utils.JsonSerializableRegistry`: Базовый класс для реестра сериализуемых объектов.
-    `tinytroupe.openai_utils`: Модуль для взаимодействия с OpenAI API.
-   `tinytroupe.utils`: Модуль с общими утилитами.

**Классы:**

1.  **`ResultsExtractor`**:
    -   **Роль**: Извлекает данные из агентов (`TinyPerson`) и миров (`TinyWorld`).
    -   **Атрибуты**:
        -   `_extraction_prompt_template_path`: Путь к файлу шаблона для запроса LLM.
        -   `agent_extraction`: Словарь для кэширования результатов извлечения данных из агентов.
        -   `world_extraction`: Словарь для кэширования результатов извлечения данных из миров.
    -   **Методы**:
        -   `__init__`: Инициализирует класс, загружая шаблон и создавая словари кэширования.
        -   `extract_results_from_agent`: Извлекает результаты из агента, используя LLM.
        -   `extract_results_from_world`: Извлекает результаты из мира, используя LLM.
        -   `save_as_json`: Сохраняет результаты в JSON файл.
    -   **Взаимодействие**:
        - Использует `openai_utils` для запросов к LLM.
        - Использует `utils.extract_json` для обработки результатов.
        - Использует `chevron` для рендеринга шаблонов.

2.  **`ResultsReducer`**:
    -   **Роль**: Сокращает данные на основе заданных правил.
    -   **Атрибуты**:
        -   `results`: Словарь для хранения результатов.
        -   `rules`: Словарь для хранения правил сокращения.
    -   **Методы**:
        -   `__init__`: Инициализирует класс, создавая пустые словари.
        -   `add_reduction_rule`: Добавляет правило сокращения, связывая тип сообщения с функцией.
        -   `reduce_agent`: Применяет правила сокращения к истории агента.
        -   `reduce_agent_to_dataframe`: Преобразует сокращенные результаты в `pandas.DataFrame`.
    -   **Взаимодействие**:
        -   Работает с эпизодической памятью агента (`agent.episodic_memory`).

3.  **`ArtifactExporter`**:
    -   **Роль**: Экспортирует артефакты (данные) в различные форматы.
    -   **Атрибуты**:
        -   `base_output_folder`: Базовая папка для сохранения артефактов.
    -   **Методы**:
        -   `__init__`: Инициализирует класс с базовой папкой.
        -   `export`: Экспортирует данные в файл.
        -   `_export_as_txt`: Сохраняет данные в текстовый файл.
        -   `_export_as_json`: Сохраняет данные в JSON-файл.
        -   `_export_as_docx`: Сохраняет данные в DOCX-файл.
        -   `_compose_filepath`: Составляет путь к файлу.
    -   **Взаимодействие**:
         -  Использует `pypandoc` для конвертации в DOCX.
         -  Использует `os` для работы с файлами.

4.  **`Normalizer`**:
    -   **Роль**: Нормализует текстовые элементы с помощью LLM.
    -   **Атрибуты**:
        -   `elements`: Список элементов для нормализации.
        -   `n`: Количество нормализованных элементов для вывода.
        -   `verbose`: Флаг для включения отладочных сообщений.
        -   `normalized_elements`: Структура JSON, где ключи – нормализованные элементы, а значения – списки исходных элементов.
        -   `normalizing_map`: Словарь для кэширования результатов нормализации.
    -   **Методы**:
        -   `__init__`: Инициализирует класс, отправляет запрос LLM и сохраняет результат нормализации.
        -   `normalize`: Нормализует элементы, используя кэш и, при необходимости, LLM.
    -   **Взаимодействие**:
        -   Использует `openai_utils` для запросов к LLM.
        -   Использует `utils.extract_json` для извлечения результатов.

**Функции:**

-   **`default_extractor`**:
    -   Создает экземпляр `ResultsExtractor`.
    -   Используется как `default_extractor` для извлечения данных по умолчанию.

**Переменные:**

-   Переменные внутри классов (атрибуты) описаны выше.
-   Переменные внутри методов: используются локально для обработки данных и запросов.

**Потенциальные ошибки и области для улучшения:**

-   Обработка ошибок при отправке запросов к LLM.
-   Улучшение механизма кэширования, например, добавление инвалидации кэша.
-   Более гибкая настройка параметров запроса к LLM (температура и т.д.).
-   Улучшенная обработка ошибок при конвертации файлов (например, в DOCX).
-   Возможны проблемы с большими историями взаимодействий, нужно рассмотреть возможность разделения их на части или суммирования.
-   В `_compose_filepath` нужно добавить проверку на недопустимые символы для `subfolder`.

**Взаимосвязи с другими частями проекта:**

-   Используется для извлечения и обработки данных из агентов и миров, созданных в `tinytroupe.agent` и `tinytroupe.environment`.
-   Использует `openai_utils` для взаимодействия с LLM.
-   Использует `tinytroupe.utils` для общих утилитных функций.
-   Результаты извлечения можно использовать для обучения моделей или анализа данных.

Этот анализ обеспечивает подробное понимание кода, его функциональности, структуры и взаимосвязей с другими компонентами проекта.