# Модуль `AiChats`

## Обзор

Модуль `AiChats` предоставляет асинхронный интерфейс для взаимодействия с сервисом ai-chats.org. Он поддерживает как текстовые запросы, так и генерацию изображений с использованием модели `dalle`. Модуль реализует функциональность асинхронного генератора для обработки ответов от сервера.

## Подробней

Модуль предназначен для интеграции с другими частями проекта `hypotez`, обеспечивая возможность использования AI-моделей для генерации текста и изображений. Он использует библиотеку `aiohttp` для выполнения асинхронных HTTP-запросов и предоставляет удобные методы для отправки запросов и обработки ответов.

## Классы

### `AiChats`

**Описание**: Класс `AiChats` является асинхронным провайдером, который взаимодействует с API ai-chats.org для генерации текста и изображений.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных генераторов.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями провайдера.

**Атрибуты**:
- `url` (str): URL сервиса ai-chats.org.
- `api_endpoint` (str): URL API для отправки запросов.
- `working` (bool): Указывает, работает ли провайдер (в данном случае `False`).
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений (`True`).
- `default_model` (str): Модель, используемая по умолчанию (`'gpt-4'`).
- `models` (List[str]): Список поддерживаемых моделей (`['gpt-4', 'dalle']`).

**Методы**:
- `create_async_generator()`: Создает асинхронный генератор для обработки запросов к API.
- `create_async()`: Отправляет запрос к API и возвращает результат в виде строки или изображения.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для отправки запросов к API ai-chats.org.

    Args:
        model (str): Модель для использования (`'gpt-4'` или `'dalle'`).
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий результаты от API.

    Raises:
        Exception: В случае ошибки при выполнении запроса.
    """
```

**Назначение**: Создание асинхронного генератора для взаимодействия с API `ai-chats.org`. Функция отвечает за формирование запроса, отправку его на сервер и обработку потоковых ответов.

**Параметры**:
- `cls`: Ссылка на класс `AiChats`.
- `model` (str): Определяет, какую модель использовать: `'gpt-4'` для текстовых ответов или `'dalle'` для генерации изображений.
- `messages` (Messages): Список сообщений, отправляемых в запросе. Для текстовых запросов используется форматирование `messages`, для запросов изображений берется последнее сообщение.
- `proxy` (str, optional): Адрес прокси-сервера для использования при отправке запроса. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в функцию.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который выдает результаты от API. Если `model` это `'dalle'`, генератор выдает `ImageResponse` объекты с base64 представлением изображения.

**Вызывает исключения**:
- `aiohttp.ClientError`: Возникает при ошибках HTTP-запроса.
- `json.JSONDecodeError`: Возникает при ошибках декодирования JSON-ответа.
- `Exception`: Может возникнуть при других неожиданных ошибках в процессе выполнения запроса.

**Как работает функция**:

1. **Формирование заголовков**: Функция создает заголовки HTTP-запроса, включая `Content-Type`, `Origin`, `Referer` и `User-Agent`. Заголовки эмулируют запрос от браузера.
2. **Определение типа запроса**: В зависимости от значения `model` (либо `'dalle'`, либо `'gpt-4'`) формируется либо запрос на генерацию изображения, либо текстовый запрос.
3. **Формирование данных запроса**: Для текстовых запросов используется функция `format_prompt` для форматирования сообщений. Для запросов изображений берется последнее сообщение из списка `messages`.
4. **Отправка запроса**: Используется `aiohttp.ClientSession` для отправки асинхронного POST-запроса на `cls.api_endpoint` с соответствующими заголовками, данными и прокси (если указан).
5. **Обработка ответа**:
   - Для модели `'dalle'`:
     - Полученный JSON-ответ проверяется на наличие ключа `'data'` и URL изображения.
     - Если URL найден, изображение скачивается, кодируется в base64 и возвращается в виде объекта `ImageResponse`.
     - Если URL не найден или формат ответа неожиданный, возвращается сообщение об ошибке.
   - Для модели `'gpt-4'`:
     - Читается полный текст ответа.
     - Каждая строка, начинающаяся с `'data: '`, добавляется к результату.
     - Результат возвращается как строка.
6. **Обработка ошибок**: Если в процессе выполнения запроса возникает исключение, возвращается сообщение об ошибке.

```
Формирование заголовков и данных запроса --> Отправка POST-запроса в API
    ↓                                            ↓
  model == 'dalle'?                                  Обработка ответа: JSON для изображений / text для текста
    ↓                                            ↓
  Да: Извлечение URL изображения и кодирование в Base64 --→ Генерация ImageResponse
    ↓                                            ↓
  Нет: Форматирование prompt-а для текстового ответа → Извлечение текста из data: строк
    ↓                                            ↓
      Возврат результата (ImageResponse или текст)
```

**Примеры**:

```python
# Пример использования для генерации текста
async for response in AiChats.create_async_generator(model='gpt-4', messages=[{'role': 'user', 'content': 'Hello'}]):
    print(response)

# Пример использования для генерации изображения
async for response in AiChats.create_async_generator(model='dalle', messages=[{'role': 'user', 'content': 'A cat'}]):
    print(response)
```

### `create_async`

```python
@classmethod
async def create_async(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> str:
    """
    Отправляет запрос к API ai-chats.org и возвращает результат в виде строки или изображения.

    Args:
        model (str): Модель для использования ('gpt-4' или 'dalle').
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        str: Результат от API в виде строки или base64-encoded изображения.

    """
```

**Назначение**: Отправка запроса к API `ai-chats.org` и возвращение результата. Эта функция упрощает использование `create_async_generator`, возвращая готовый результат вместо генератора.

**Параметры**:
- `cls`: Ссылка на класс `AiChats`.
- `model` (str): Определяет, какую модель использовать: `'gpt-4'` для текстовых ответов или `'dalle'` для генерации изображений.
- `messages` (Messages): Список сообщений, отправляемых в запросе.
- `proxy` (str, optional): Адрес прокси-сервера для использования при отправке запроса. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `str`: Результат от API. Если `model` это `'dalle'`, возвращается base64 представление изображения. Если `model` это `'gpt-4'`, возвращается текст ответа.

**Как работает функция**:

1. **Вызов асинхронного генератора**: Функция вызывает `cls.create_async_generator` с переданными параметрами для получения асинхронного генератора.
2. **Итерация по ответам**: Функция итерируется по ответам, выдаваемым генератором.
3. **Обработка ответа**:
   - Если ответ является экземпляром `ImageResponse`, возвращается первый URL изображения из `response.images`.
   - В противном случае возвращается сам ответ.

```
Вызов create_async_generator --> Получение ответа от генератора
        ↓                       ↓
   instanceof ImageResponse?     Возврат результата: URL изображения или текст
        ↓                       ↓
     Да: Извлечение URL          
        ↓
    Возврат URL
```

**Примеры**:

```python
# Пример использования для генерации текста
response = await AiChats.create_async(model='gpt-4', messages=[{'role': 'user', 'content': 'Hello'}])
print(response)

# Пример использования для генерации изображения
response = await AiChats.create_async(model='dalle', messages=[{'role': 'user', 'content': 'A cat'}])
print(response)