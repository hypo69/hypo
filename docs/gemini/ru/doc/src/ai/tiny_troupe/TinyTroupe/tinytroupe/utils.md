# Модуль `tinytroupe.utils`

## Обзор

Данный модуль содержит общие служебные функции и функции для удобства работы, включая обработку ввода/вывода данных моделей, управление конфигурацией, валидацию, создание запросов и многое другое.

## Функции

### `compose_initial_LLM_messages_with_templates`

**Описание**: Создает начальные сообщения для вызова модели LLM, предполагая, что они всегда включают системное сообщение (общее описание задачи) и необязательное пользовательское сообщение (конкретное описание задачи). Сообщения создаются с помощью указанных шаблонов и конфигураций рендеринга.

**Параметры**:
- `system_template_name` (str): Имя шаблона для системного сообщения.
- `user_template_name` (Optional[str], optional): Имя шаблона для пользовательского сообщения. По умолчанию `None`.
- `rendering_configs` (dict, optional): Словарь с конфигурациями для рендеринга шаблонов. По умолчанию `{}`.

**Возвращает**:
- `list`: Список словарей, представляющих сообщения. Каждый словарь имеет ключи "role" (значение "system" или "user") и "content" (строку с содержанием сообщения).

### `extract_json`

**Описание**: Извлекает JSON-объект из строки, игнорируя текст до первой открывающей фигурной скобки и теги Markdown (```json```).

**Параметры**:
- `text` (str): Строка, содержащая JSON-объект.

**Возвращает**:
- `dict`: JSON-объект, извлеченный из строки. Если JSON-объект не найден или произошла ошибка при его парсинге, возвращается пустой словарь `{}`.

### `extract_code_block`

**Описание**: Извлекает код из строки, игнорируя текст до первых трёх обратных кавычек и после последних трёх обратных кавычек.

**Параметры**:
- `text` (str): Строка, содержащая код.

**Возвращает**:
- `str`: Извлеченный код. Если код не найден, возвращается пустая строка `""`.

### `repeat_on_error`

**Описание**: Декоратор, который повторяет указанную функцию в случае возникновения исключения из переданного списка, до указанного числа попыток. Если количество попыток исчерпано, исключение поднимается.

**Параметры**:
- `retries` (int): Максимальное количество попыток повтора.
- `exceptions` (list): Список исключений, которые нужно перехватывать.

**Возвращает**:
- `function`: Декорированная функция.

### `check_valid_fields`

**Описание**: Проверяет, что все поля в словаре соответствуют списку допустимых полей. Если поле не найдено, выбрасывается исключение `ValueError`.

**Параметры**:
- `obj` (dict): Словарь для проверки.
- `valid_fields` (list): Список допустимых полей.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `ValueError`: Если в словаре присутствует недопустимое поле.

### `sanitize_raw_string`

**Описание**: Саннитизирует строку, удаляя недопустимые символы и гарантируя, что она не превышает максимальную длину строки Python.

**Параметры**:
- `value` (str): Строка для саннитизации.

**Возвращает**:
- `str`: Саннитизированная строка.

### `sanitize_dict`

**Описание**: Саннитизирует словарь, удаляя недопустимые символы и проверяя глубину вложенности.

**Параметры**:
- `value` (dict): Словарь для саннитизации.

**Возвращает**:
- `dict`: Саннитизированный словарь.

### `add_rai_template_variables_if_enabled`

**Описание**: Добавляет переменные шаблона RAI в указанный словарь, если опция RAI включена в файле конфигурации.

**Параметры**:
- `template_variables` (dict): Словарь шаблона.


**Возвращает**:
- `dict`: Обновленный словарь с переменными шаблона.


### `inject_html_css_style_prefix`

**Описание**: Вставляет префикс CSS в атрибуты style в строке HTML.

**Параметры**:
- `html` (str): Строка HTML.
- `style_prefix_attributes` (str): Префикс CSS.

**Возвращает**:
- `str`: HTML строка с вставленным префиксом.

### `break_text_at_length`

**Описание**: Разбивает текст (или JSON) на указанную длину, вставляя "(...)" в точке разрыва.

**Параметры**:
- `text` (Union[str, dict]): Текст или JSON.
- `max_length` (int, optional): Максимальная длина. По умолчанию `None`.

**Возвращает**:
- `str`: Разбитый текст.

### `pretty_datetime`

**Описание**: Возвращает удобочитаемое представление даты и времени.

**Параметры**:
- `dt` (datetime): Объект datetime.

**Возвращает**:
- `str`: Удобочитаемое представление даты и времени.

### `dedent`

**Описание**: Удаляет отступы из строки.

**Параметры**:
- `text` (str): Строка.

**Возвращает**:
- `str`: Строка без отступов.

### `read_config_file`

**Описание**: Читает файл конфигурации `config.ini`.

**Параметры**:
- `use_cache` (bool, optional): Использовать кэш конфигурации. По умолчанию `True`.
- `verbose` (bool, optional): Выводить дополнительные сообщения. По умолчанию `True`.

**Возвращает**:
- `configparser.ConfigParser`: Объект конфигурации.

**Вызывает исключения**:
- `ValueError`: Если файл конфигурации не найден.

### `pretty_print_config`

**Описание**: Выводит конфигурацию в удобочитаемом формате.

**Параметры**:
- `config` (configparser.ConfigParser): Объект конфигурации.


**Возвращает**:
- `None`

### `start_logger`

**Описание**: Инициализирует логгер.

**Параметры**:
- `config` (configparser.ConfigParser): Объект конфигурации.


**Возвращает**:
- `None`


### `JsonSerializableRegistry`

**Описание**: Класс-миксин для сериализации и десериализации в JSON и регистрации подклассов.

**Методы**:

- `to_json`: Сериализует объект в JSON.
- `from_json`: Десериализует объект из JSON.
- `__init_subclass__`: Регистрирует подклассы.
- `_post_deserialization_init`: Метод пост-инициализации после десериализации.


### `post_init`

**Описание**: Декоратор для вызова метода `_post_init` после инициализации класса.

**Параметры**:
- `cls`: Класс, которому нужно добавить пост-инициализацию.


**Возвращает**:
- `cls`: Декорированный класс.


### `name_or_empty`

**Описание**: Возвращает имя агента или среды, или пустую строку, если агент равен None.

**Параметры**:
- `named_entity` (AgentOrWorld): Агент или среда.

**Возвращает**:
- `str`: Имя агента или среды.

### `custom_hash`

**Описание**: Возвращает детерминированный хэш для объекта.

**Параметры**:
- `obj`: Объект.

**Возвращает**:
- `str`: Хэш объекта.

### `fresh_id`

**Описание**: Возвращает уникальный ID.

**Возвращает**:
- `int`: Уникальный ID.