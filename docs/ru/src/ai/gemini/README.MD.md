# Документация модуля Google Generative AI Integration

## Обзор

Этот модуль предназначен для интеграции и взаимодействия с моделями Generative AI от Google. Он предоставляет класс `GoogleGenerativeAI`, который упрощает отправку запросов, обработку ответов, управление диалогами и интеграцию с различными функциями искусственного интеллекта. Включает надежную обработку ошибок, ведение журналов и параметры конфигурации для обеспечения бесперебойной работы.

## Подробнее

Модуль обеспечивает удобный интерфейс для работы с API Google Generative AI, позволяя разработчикам легко интегрировать возможности генеративного ИИ в свои приложения. Класс `GoogleGenerativeAI` предоставляет методы для отправки текстовых запросов, генерации описаний изображений и управления историей диалогов.

## Классы

### `GoogleGenerativeAI`

**Описание**: Класс для взаимодействия с моделями Generative AI от Google.

**Принцип работы**:
Класс инициализируется с использованием ключа API, имени модели, конфигурации генерации и системной инструкции. Он предоставляет методы для отправки запросов к модели, сохранения диалогов и обработки ошибок.

**Атрибуты**:
- `api_key` (str): Ключ API для доступа к сервисам Google Generative AI.
- `model_name` (Optional[str]): Название используемой модели. По умолчанию `None`.
- `generation_config` (Optional[Dict]): Конфигурация генерации. По умолчанию `None`.
- `system_instruction` (Optional[str]): Системная инструкция для модели. По умолчанию `None`.

**Методы**:
- `__init__`: Инициализирует класс `GoogleGenerativeAI`.
- `config`: Извлекает конфигурацию из файла настроек.
- `_start_chat`: Запускает сессию чата с моделью AI.
- `_save_dialogue`: Сохраняет диалог в текстовом и JSON форматах.
- `ask`: Отправляет текстовый запрос к модели AI и получает ответ.
- `chat`: Отправляет сообщение в чат к модели AI и получает ответ.
- `describe_image`: Генерирует текстовое описание изображения.
- `upload_file`: Загружает файл в модель AI.

## Функции

### `__init__(self, api_key: str, model_name: Optional[str] = None, generation_config: Optional[Dict] = None, system_instruction: Optional[str] = None, **kwargs)`

**Назначение**: Инициализирует класс `GoogleGenerativeAI` с необходимыми конфигурациями.

**Параметры**:
- `api_key` (str): Ключ API для доступа к сервисам Google Generative AI.
- `model_name` (Optional[str], optional): Название используемой модели. По умолчанию `None`.
- `generation_config` (Optional[Dict], optional): Конфигурация генерации. По умолчанию `None`.
- `system_instruction` (Optional[str], optional): Системная инструкция для модели. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `None`

**Как работает функция**:
1.  Инициализация класса `GoogleGenerativeAI` с использованием предоставленных параметров.
2.  Настройка ключа API, имени модели, конфигурации генерации и системной инструкции.
3.  Определение путей для сохранения журналов диалогов и истории.
4.  Инициализация модели Google Generative AI.

```
Инициализация класса GoogleGenerativeAI
│
├─── Настройка параметров (api_key, model_name, generation_config, system_instruction)
│
├─── Определение путей для журналов и истории
│
└─── Инициализация модели Google Generative AI
```

**Примеры**:

```python
ai = GoogleGenerativeAI(api_key="your_api_key", system_instruction="Instruction")
```

### `config()`

**Назначение**: Извлекает конфигурацию из файла настроек.

**Параметры**:
- `None`

**Возвращает**:
- `None`

**Как работает функция**:
1.  Чтение и разбор файла конфигурации, расположенного по пути `gs.path.src / 'ai' / 'gemini' / 'gemini.json'`.
2.  Возвращение конфигурации для дальнейшего использования.

```
Чтение файла конфигурации
│
└─── Разбор файла конфигурации
```

**Примеры**:

```python
config = GoogleGenerativeAI.config()
```

### `_start_chat(self)`

**Назначение**: Запускает сессию чата с моделью AI.

**Параметры**:
- `None`

**Возвращает**:
- `None`

**Как работает функция**:
1.  Инициализация сессии чата с пустой историей.
2.  Подготовка к обмену сообщениями с моделью AI в контексте чата.

```
Инициализация сессии чата
│
└─── Установка пустой истории
```

**Примеры**:

```python
ai._start_chat()
```

### `_save_dialogue(self, dialogue: list)`

**Назначение**: Сохраняет диалог в текстовом и JSON форматах.

**Параметры**:
- `dialogue` (list): Список сообщений в диалоге.

**Возвращает**:
- `None`

**Как работает функция**:
1.  Добавление каждого сообщения из диалога в текстовый файл.
2.  Добавление каждого сообщения в формате JSON в JSON файл.
3.  Обеспечение сохранения истории диалогов для анализа и отладки.

```
Сохранение диалога
│
├─── Запись в текстовый файл
│
└─── Запись в JSON файл
```

**Примеры**:

```python
ai._save_dialogue(dialogue=[{"role": "user", "content": "Hello"}, {"role": "model", "content": "Hi"}])
```

### `ask(self, q: str, attempts: int = 15) -> Optional[str]`

**Назначение**: Отправляет текстовый запрос к модели AI и получает ответ.

**Параметры**:
- `q` (str): Текстовый запрос.
- `attempts` (int, optional): Количество попыток в случае ошибок. По умолчанию `15`.

**Возвращает**:
- `Optional[str]`: Ответ от модели AI или `None` в случае ошибки.

**Как работает функция**:
1.  Отправка текстового запроса к модели AI.
2.  Обработка нескольких попыток в случае сетевых ошибок или недоступности сервиса.
3.  Логирование ошибок и повторные попытки с экспоненциальной задержкой.
4.  Сохранение диалога в файлы истории.

```
Отправка запроса к модели AI
│
├─── Обработка попыток
│
├─── Логирование ошибок
│
└─── Сохранение диалога в файлы истории
```

**Примеры**:

```python
response = ai.ask("Как дела?")
print(response)
```

### `chat(self, q: str) -> str`

**Назначение**: Отправляет сообщение в чат к модели AI и получает ответ.

**Параметры**:
- `q` (str): Текстовое сообщение для чата.

**Возвращает**:
- `str`: Ответ от модели AI.

**Как работает функция**:
1.  Использование сессии чата, инициализированной с помощью `_start_chat`.
2.  Логирование ошибок и возвращение текста ответа.

```
Отправка сообщения в чат
│
├─── Использование сессии чата
│
└─── Логирование ошибок и возврат ответа
```

**Примеры**:

```python
response = ai.chat("Hello")
print(response)
```

### `describe_image(self, image_path: Path) -> Optional[str]`

**Назначение**: Генерирует текстовое описание изображения.

**Параметры**:
- `image_path` (Path): Путь к файлу изображения.

**Возвращает**:
- `Optional[str]`: Текстовое описание изображения или `None` в случае ошибки.

**Как работает функция**:
1.  Кодирование изображения в base64.
2.  Отправка закодированного изображения в модель AI.
3.  Возвращение сгенерированного описания или логирование ошибки, если операция не удалась.

```
Генерация текстового описания изображения
│
├─── Кодирование изображения в base64
│
└─── Отправка закодированного изображения в модель AI
```

**Примеры**:

```python
image_description = ai.describe_image(image_path=Path("image.jpg"))
print(image_description)
```

### `upload_file(self, file: str | Path | IOBase, file_name: Optional[str] = None) -> bool`

**Назначение**: Загружает файл в модель AI.

**Параметры**:
- `file` (str | Path | IOBase): Путь к файлу или файловый объект.
- `file_name` (Optional[str], optional): Имя файла. По умолчанию `None`.

**Возвращает**:
- `bool`: `True`, если файл успешно загружен, `False` в противном случае.

**Как работает функция**:
1.  Обработка загрузки файла.
2.  Логирование успеха или неудачи.
3.  Предоставление логики повторных попыток в случае ошибок.

```
Загрузка файла в модель AI
│
├─── Обработка загрузки файла
│
├─── Логирование результата
│
└─── Логика повторных попыток
```

**Примеры**:

```python
success = ai.upload_file(file="data.txt")
print(success)
```

## Обработка ошибок

Класс включает в себя всестороннюю обработку ошибок для различных сценариев:

- **Сетевые ошибки**: Повторные попытки с экспоненциальной задержкой.
- **Недоступность сервиса**: Логирование ошибок и повторные попытки.
- **Ограничения квоты**: Логирование и ожидание перед повторной попыткой.
- **Ошибки аутентификации**: Логирование и прекращение дальнейших попыток.
- **Недопустимый ввод**: Логирование и повторные попытки с таймаутом.
- **Ошибки API**: Логирование и прекращение дальнейших попыток.

## Логирование и история

Все взаимодействия с моделями AI логируются, а диалоги сохраняются в текстовом и JSON форматах для будущего анализа. Это гарантирует, что все операции отслеживаются и могут быть проверены для отладки или аудита.

## Зависимости

- `google.generativeai`
- `requests`
- `grpc`
- `google.api_core.exceptions`
- `google.auth.exceptions`
- `src.logger`
- `src.utils.printer`
- `src.utils.file`
- `src.utils.date_time`
- `src.utils.convertors.unicode`
- `src.utils.jjson`

## Пример использования

```python
ai = GoogleGenerativeAI(api_key="your_api_key", system_instruction="Instruction")
response = ai.ask("Как дела?")
print(response)
```

Этот пример инициализирует класс `GoogleGenerativeAI` и отправляет запрос к модели AI, выводя ответ.

---

Для получения более подробной информации обратитесь к исходному коду и комментариям внутри класса `GoogleGenerativeAI`.