# –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ –∏ API-–∫–ª—é—á–∞–º–∏
## –û–±–∑–æ—Ä

–ú–æ–¥—É–ª—å `run_tools.py` –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –≤ AI-–º–æ–¥–µ–ª—è—Ö, —Ç–∞–∫–∏—Ö –∫–∞–∫ –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ, –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∏ —Ä–∞–±–æ—Ç–∞ —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –¥–∞–Ω–Ω—ã—Ö (bucket). –û–Ω —Ç–∞–∫–∂–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç API-–∫–ª—é—á–∞–º–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞—Ö AI-–º–æ–¥–µ–ª–µ–π. –ú–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª–∞—Å—Å—ã –∏ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –∞ —Ç–∞–∫–∂–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (thinking chunks).

## –ü–æ–¥—Ä–æ–±–Ω–µ–π

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –∏–≥—Ä–∞–µ—Ç –≤–∞–∂–Ω—É—é —Ä–æ–ª—å –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π AI-–º–æ–¥–µ–ª–µ–π, –ø–æ–∑–≤–æ–ª—è—è –∏–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Ä–µ—Å—É—Ä—Å–∞–º–∏ –∏ –≤—ã–ø–æ–ª–Ω—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏. –û–Ω –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≥–∏–±–∫–æ—Å—Ç—å –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã, –ø–æ–∑–≤–æ–ª—è—è –ø–æ–¥–∫–ª—é—á–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã AI-–º–æ–¥–µ–ª–µ–π.

## –ö–ª–∞—Å—Å—ã

### `ToolHandler`

**–û–ø–∏—Å–∞–Ω–∏–µ**: –ö–ª–∞—Å—Å `ToolHandler` –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –≤ AI-–º–æ–¥–µ–ª—è—Ö.

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã**:
–ö–ª–∞—Å—Å `ToolHandler` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –∞ —Ç–∞–∫–∂–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, —Ç–∞–∫–∏—Ö –∫–∞–∫ –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ, –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞ –∏ —Ä–∞–±–æ—Ç–∞ —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –¥–∞–Ω–Ω—ã—Ö (bucket).

**–ú–µ—Ç–æ–¥—ã**:

- `validate_arguments(data: dict) -> dict`: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ —Ä–∞–∑–±–∏—Ä–∞–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞.
- `process_search_tool(messages: Messages, tool: dict) -> Messages`: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø–æ–∏—Å–∫–∞.
- `process_continue_tool(messages: Messages, tool: dict, provider: Any) -> Tuple[Messages, Dict[str, Any]]`: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞.
- `process_bucket_tool(messages: Messages, tool: dict) -> Messages`: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Ä–∞–±–æ—Ç—ã —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –¥–∞–Ω–Ω—ã—Ö (bucket).
- `process_tools(messages: Messages, tool_calls: List[dict], provider: Any) -> Tuple[Messages, Dict[str, Any]]`: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã.

#### `validate_arguments`

```python
    @staticmethod
    def validate_arguments(data: dict) -> dict:
        """Validate and parse tool arguments"""
        if "arguments" in data:
            if isinstance(data["arguments"], str):\
                data["arguments"] = json.loads(data["arguments"])\
            if not isinstance(data["arguments"], dict):\
                raise ValueError("Tool function arguments must be a dictionary or a json string")\
            else:\
                return filter_none(**data["arguments"])\
        else:\
            return {}
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ —Ä–∞–∑–±–∏—Ä–∞–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–µ –≤ –≤–∏–¥–µ —Å–ª–æ–≤–∞—Ä—è –∏–ª–∏ JSON-—Å—Ç—Ä–æ–∫–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `data` (dict): –°–ª–æ–≤–∞—Ä—å, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `dict`: –°–ª–æ–≤–∞—Ä—å —Å –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–º–∏ –∏ —Ä–∞–∑–æ–±—Ä–∞–Ω–Ω—ã–º–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:

1.  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–∞ `"arguments"` –≤ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–º —Å–ª–æ–≤–∞—Ä–µ `data`.
2.  –ï—Å–ª–∏ –∫–ª—é—á `"arguments"` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —ç—Ç–æ–º—É –∫–ª—é—á—É —Å—Ç—Ä–æ–∫–æ–π. –ï—Å–ª–∏ –¥–∞, –ø—ã—Ç–∞–µ—Ç—Å—è —Ä–∞–∑–æ–±—Ä–∞—Ç—å JSON-—Å—Ç—Ä–æ–∫—É –≤ —Å–ª–æ–≤–∞—Ä—å.
3.  –ó–∞—Ç–µ–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–ª—é—á—É `"arguments"` —Å–ª–æ–≤–∞—Ä—ë–º. –ï—Å–ª–∏ –Ω–µ—Ç, –≤—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ `ValueError`.
4.  –ï—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ —è–≤–ª—è–µ—Ç—Å—è —Å–ª–æ–≤–∞—Ä—ë–º, –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é `filter_none` –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å–æ –∑–Ω–∞—á–µ–Ω–∏–µ–º `None` –∏–∑ —Å–ª–æ–≤–∞—Ä—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
5.  –ï—Å–ª–∏ –∫–ª—é—á–∞ `"arguments"` –Ω–µ—Ç –≤ —Å–ª–æ–≤–∞—Ä–µ `data`, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å.

**–ü—Ä–∏–º–µ—Ä**:

```python
data1 = {"arguments": '{"param1": "value1", "param2": null}'}
result1 = ToolHandler.validate_arguments(data1)
# result1 –±—É–¥–µ—Ç {"param1": "value1"}

data2 = {"arguments": {"param1": "value1", "param2": "value2"}}
result2 = ToolHandler.validate_arguments(data2)
# result2 –±—É–¥–µ—Ç {"param1": "value1", "param2": "value2"}

data3 = {}
result3 = ToolHandler.validate_arguments(data3)
# result3 –±—É–¥–µ—Ç {}
```

#### `process_search_tool`

```python
    @staticmethod
    async def process_search_tool(messages: Messages, tool: dict) -> Messages:
        """Process search tool requests"""
        messages = messages.copy()
        args = ToolHandler.validate_arguments(tool["function"])
        messages[-1]["content"], sources = await do_search(\
            messages[-1]["content"],\
            **args
        )\
        return messages, sources
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø–æ–∏—Å–∫–∞, –≤—ã–ø–æ–ª–Ω—è—è –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –∏ –æ–±–Ω–æ–≤–ª—è—è —Å–æ–æ–±—â–µ–Ω–∏—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `messages` (Messages): –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π.
- `tool` (dict): –°–ª–æ–≤–∞—Ä—å, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ –ø–æ–∏—Å–∫–∞.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `Messages`: –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:

1.  –°–æ–∑–¥–∞–µ—Ç –∫–æ–ø–∏—é —Å–ø–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π `messages`.
2.  –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø–æ–∏—Å–∫–∞, –∏—Å–ø–æ–ª—å–∑—É—è –º–µ—Ç–æ–¥ `ToolHandler.validate_arguments`.
3.  –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ—É–Ω–∫—Ü–∏—é `do_search`, –ø–µ—Ä–µ–¥–∞–≤–∞—è –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞.
4.  –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ `messages` —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞.
5.  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ–∏—Å–∫–∞.

**–ü—Ä–∏–º–µ—Ä**:

```python
messages = [{"role": "user", "content": "search for latest news"}]
tool = {"function": {"arguments": {}}}
updated_messages = await ToolHandler.process_search_tool(messages, tool)
# updated_messages –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
```

#### `process_continue_tool`

```python
    @staticmethod
    def process_continue_tool(messages: Messages, tool: dict, provider: Any) -> Tuple[Messages, Dict[str, Any]]:
        """Process continue tool requests"""
        kwargs = {}
        if provider not in ("OpenaiAccount", "HuggingFaceAPI"):\
            messages = messages.copy()
            last_line = messages[-1]["content"].strip().splitlines()[-1]\
            content = f"Carry on from this point:\\n{last_line}"
            messages.append({"role": "user", "content": content})\
        else:\
            # Enable provider native continue
            kwargs["action"] = "continue"\
        return messages, kwargs
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞, –¥–æ–±–∞–≤–ª—è—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `messages` (Messages): –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π.
- `tool` (dict): –°–ª–æ–≤–∞—Ä—å, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è.
- `provider` (Any): –ü—Ä–æ–≤–∞–π–¥–µ—Ä AI-–º–æ–¥–µ–ª–∏.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `Tuple[Messages, Dict[str, Any]]`: –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:

1.  –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å `kwargs`.
2.  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –æ–¥–Ω–∏–º –∏–∑ `("OpenaiAccount", "HuggingFaceAPI")`.
3.  –ï—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ —Å–ø–∏—Å–æ–∫, —Å–æ–∑–¥–∞–µ—Ç –∫–æ–ø–∏—é —Å–ø–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π `messages`.
4.  –ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É –∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.
5.  –§–æ—Ä–º–∏—Ä—É–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ä–æ–ª—å—é "user", —Å–æ–¥–µ—Ä–∂–∞—â–µ–µ –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏.
6.  –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫ `messages`.
7.  –ï—Å–ª–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –≤—Ö–æ–¥–∏—Ç –≤ —Å–ø–∏—Å–æ–∫, –¥–æ–±–∞–≤–ª—è–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç `"action": "continue"` –≤ —Å–ª–æ–≤–∞—Ä—å `kwargs`.
8.  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Å–ª–æ–≤–∞—Ä—å `kwargs`.

**–ü—Ä–∏–º–µ—Ä**:

```python
messages = [{"role": "user", "content": "This is the beginning of a story."}]
tool = {}
provider = "SomeOtherProvider"
updated_messages, kwargs = ToolHandler.process_continue_tool(messages, tool, provider)
# updated_messages –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∑–∞–ø—Ä–æ—Å–æ–º –Ω–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ
# kwargs –±—É–¥–µ—Ç –ø—É—Å—Ç—ã–º —Å–ª–æ–≤–∞—Ä–µ–º

messages = [{"role": "user", "content": "This is the beginning of a story."}]
tool = {}
provider = "OpenaiAccount"
updated_messages, kwargs = ToolHandler.process_continue_tool(messages, tool, provider)
# updated_messages –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
# kwargs –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å {"action": "continue"}
```

#### `process_bucket_tool`

```python
    @staticmethod
    def process_bucket_tool(messages: Messages, tool: dict) -> Messages:
        """Process bucket tool requests"""
        messages = messages.copy()
        
        def on_bucket(match):\
            return "".join(read_bucket(get_bucket_dir(match.group(1))))
            
        has_bucket = False
        for message in messages:\
            if "content" in message and isinstance(message["content"], str):\
                new_message_content = re.sub(r'{"bucket_id":"([^"]*)"}\', on_bucket, message["content"])\
                if new_message_content != message["content"]:\
                    has_bucket = True\
                    message["content"] = new_message_content\

        last_message_content = messages[-1]["content"]      
        if has_bucket and isinstance(last_message_content, str):\
            if "\\nSource: " in last_message_content:\
                messages[-1]["content"] = last_message_content + BUCKET_INSTRUCTIONS
                    
        return messages
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Ä–∞–±–æ—Ç—ã —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º –¥–∞–Ω–Ω—ã—Ö (bucket), –∑–∞–º–µ–Ω—è—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã —Ö—Ä–∞–Ω–∏–ª–∏—â –∏—Ö —Å–æ–¥–µ—Ä–∂–∏–º—ã–º.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `messages` (Messages): –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π.
- `tool` (dict): –°–ª–æ–≤–∞—Ä—å, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–µ —Ä–∞–±–æ—Ç—ã —Å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ–º.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `Messages`: –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —Å –∑–∞–º–µ–Ω–µ–Ω–Ω—ã–º–∏ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞–º–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:

1.  –°–æ–∑–¥–∞–µ—Ç –∫–æ–ø–∏—é —Å–ø–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π `messages`.
2.  –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Ñ—É–Ω–∫—Ü–∏—é `on_bucket`, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É –≤ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏.
3.  –ò—Ç–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ –∫–∞–∂–¥–æ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é –≤ —Å–ø–∏—Å–∫–µ `messages`.
4.  –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏, –≤—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –≤—Å–µ—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ —Ö—Ä–∞–Ω–∏–ª–∏—â –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –≤—ã—Ä–∞–∂–µ–Ω–∏—è.
5.  –ó–∞–º–µ–Ω—è–µ—Ç –∫–∞–∂–¥—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º—ã–º, –ø–æ–ª—É—á–µ–Ω–Ω—ã–º —Å –ø–æ–º–æ—â—å—é —Ñ—É–Ω–∫—Ü–∏–∏ `on_bucket`.
6.  –ï—Å–ª–∏ –±—ã–ª–∏ –Ω–∞–π–¥–µ–Ω—ã –∏ –∑–∞–º–µ–Ω–µ–Ω—ã –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã —Ö—Ä–∞–Ω–∏–ª–∏—â, –¥–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –µ—Å–ª–∏ –≤ –Ω–µ–º —É–∂–µ –µ—Å—Ç—å —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫.
7.  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π.

**–ü—Ä–∏–º–µ—Ä**:

```python
messages = [{"role": "user", "content": "Please read this: {\"bucket_id\":\"123\"}"}]
tool = {}
updated_messages = ToolHandler.process_bucket_tool(messages, tool)
# updated_messages –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –≤–º–µ—Å—Ç–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞
```

#### `process_tools`

```python
    @staticmethod
    async def process_tools(messages: Messages, tool_calls: List[dict], provider: Any) -> Tuple[Messages, Dict[str, Any]]:
        """Process all tool calls and return updated messages and kwargs"""
        if not tool_calls:\
            return messages, {}\
            
        extra_kwargs = {}\
        messages = messages.copy()
        sources = None
        
        for tool in tool_calls:\
            if tool.get("type") != "function":\
                continue\
                
            function_name = tool.get("function", {}).get("name")\
            
            if function_name == TOOL_NAMES["SEARCH"]:\
                messages, sources = await ToolHandler.process_search_tool(messages, tool)\
                
            elif function_name == TOOL_NAMES["CONTINUE"]:\
                messages, kwargs = ToolHandler.process_continue_tool(messages, tool, provider)\
                extra_kwargs.update(kwargs)\
                
            elif function_name == TOOL_NAMES["BUCKET"]:\
                messages = ToolHandler.process_bucket_tool(messages, tool)\
                
        return messages, sources, extra_kwargs
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –≤ —Å–ø–∏—Å–∫–µ `tool_calls` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `messages` (Messages): –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π.
- `tool_calls` (List[dict]): –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—ã–∑–æ–≤–∞—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.
- `provider` (Any): –ü—Ä–æ–≤–∞–π–¥–µ—Ä AI-–º–æ–¥–µ–ª–∏.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `Tuple[Messages, Dict[str, Any]]`: –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π, –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ —Å–ª–æ–≤–∞—Ä—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:

1.  –ï—Å–ª–∏ —Å–ø–∏—Å–æ–∫ `tool_calls` –ø—É—Å—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å.
2.  –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å `extra_kwargs` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤.
3.  –°–æ–∑–¥–∞–µ—Ç –∫–æ–ø–∏—é —Å–ø–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π `messages`.
4.  –ò—Ç–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ –∫–∞–∂–¥–æ–º—É –≤—ã–∑–æ–≤—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –≤ —Å–ø–∏—Å–∫–µ `tool_calls`.
5.  –ï—Å–ª–∏ —Ç–∏–ø –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –Ω–µ "function", –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –µ–≥–æ.
6.  –ò–∑–≤–ª–µ–∫–∞–µ—Ç –∏–º—è —Ñ—É–Ω–∫—Ü–∏–∏ –∏–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≤—ã–∑–æ–≤–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞.
7.  –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–º–µ–Ω–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–∑—ã–≤–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞:
    - `TOOL_NAMES["SEARCH"]`: –≤—ã–∑—ã–≤–∞–µ—Ç `ToolHandler.process_search_tool`.
    - `TOOL_NAMES["CONTINUE"]`: –≤—ã–∑—ã–≤–∞–µ—Ç `ToolHandler.process_continue_tool` –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–ª–æ–≤–∞—Ä—å `extra_kwargs`.
    - `TOOL_NAMES["BUCKET"]`: –≤—ã–∑—ã–≤–∞–µ—Ç `ToolHandler.process_bucket_tool`.
8.  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π, –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏ —Å–ª–æ–≤–∞—Ä—å `extra_kwargs`.

**–ü—Ä–∏–º–µ—Ä**:

```python
messages = [{"role": "user", "content": "Please search for something."}]
tool_calls = [{"type": "function", "function": {"name": "search_tool", "arguments": {}}}]
provider = "SomeProvider"
updated_messages, sources, extra_kwargs = await ToolHandler.process_tools(messages, tool_calls, provider)
# updated_messages –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
# extra_kwargs –±—É–¥–µ—Ç –ø—É—Å—Ç—ã–º —Å–ª–æ–≤–∞—Ä–µ–º
```

### `AuthManager`

**–û–ø–∏—Å–∞–Ω–∏–µ**: –ö–ª–∞—Å—Å `AuthManager` –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è API-–∫–ª—é—á–∞–º–∏.

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã**:
–ö–ª–∞—Å—Å `AuthManager` –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É —Å API-–∫–ª—é—á–æ–º –∏ –∑–∞–≥—Ä—É–∑–∫–∏ API-–∫–ª—é—á–∞ –∏–∑ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

**–ú–µ—Ç–æ–¥—ã**:

- `get_api_key_file(cls) -> Path`: –ü–æ–ª—É—á–∞–µ—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É API-–∫–ª—é—á–∞ –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.
- `load_api_key(provider: Any) -> Optional[str]`: –ó–∞–≥—Ä—É–∂–∞–µ—Ç API-–∫–ª—é—á –∏–∑ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.

#### `get_api_key_file`

```python
    @staticmethod
    def get_api_key_file(cls) -> Path:\
        """Get the path to the API key file for a provider"""
        return Path(get_cookies_dir()) / f"api_key_{cls.parent if hasattr(cls, 'parent') else cls.__name__}.json"
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É, –≤ –∫–æ—Ç–æ—Ä–æ–º —Ö—Ä–∞–Ω–∏—Ç—Å—è API-–∫–ª—é—á –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:

*   `cls`: –ö–ª–∞—Å—Å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É API-–∫–ª—é—á–∞.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:

*   `Path`: –û–±—ä–µ–∫—Ç `Path`, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É API-–∫–ª—é—á–∞.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:

1.  –ü–æ–ª—É—á–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è cookie-—Ñ–∞–π–ª–æ–≤ —Å –ø–æ–º–æ—â—å—é —Ñ—É–Ω–∫—Ü–∏–∏ `get_cookies_dir()`.
2.  –§–æ—Ä–º–∏—Ä—É–µ—Ç –∏–º—è —Ñ–∞–π–ª–∞ API-–∫–ª—é—á–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–µ–Ω–∏ –∫–ª–∞—Å—Å–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–∏–ª–∏ –∏–º–µ–Ω–∏ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–ª–∞—Å—Å–∞, –µ—Å–ª–∏ —É –∫–ª–∞—Å—Å–∞ –µ—Å—Ç—å –∞—Ç—Ä–∏–±—É—Ç `parent`).
3.  –°–æ–µ–¥–∏–Ω—è–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é cookie-—Ñ–∞–π–ª–æ–≤ –∏ –∏–º—è —Ñ–∞–π–ª–∞ API-–∫–ª—é—á–∞ –≤ –æ–±—ä–µ–∫—Ç `Path` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ.

**–ü—Ä–∏–º–µ—Ä**:

```python
class MyProvider:
    pass

api_key_file_path = AuthManager.get_api_key_file(MyProvider)
# api_key_file_path –±—É–¥–µ—Ç Path('/path/to/cookies/api_key_MyProvider.json')
```

#### `load_api_key`

```python
    @staticmethod
    def load_api_key(provider: Any) -> Optional[str]:
        """Load API key from config file if needed"""
        if not getattr(provider, "needs_auth", False):\
            return None\
            
        auth_file = AuthManager.get_api_key_file(provider)\
        try:\
            if auth_file.exists():\
                with auth_file.open("r") as f:\
                    auth_result = json.load(f)\
                return auth_result.get("api_key")\
        except (json.JSONDecodeError, PermissionError, FileNotFoundError) as e:\
            debug.error(f"Failed to load API key: {e.__class__.__name__}: {e}")\
        return None
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ó–∞–≥—Ä—É–∂–∞–µ—Ç API-–∫–ª—é—á –∏–∑ —Ñ–∞–π–ª–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:

*   `provider`: –ü—Ä–æ–≤–∞–π–¥–µ—Ä, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å API-–∫–ª—é—á.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:

*   `Optional[str]`: API-–∫–ª—é—á –≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏, –µ—Å–ª–∏ –æ–Ω –Ω–∞–π–¥–µ–Ω –∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞; –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ - `None`.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:

1.  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ—É–Ω–∫—Ü–∏—é `getattr(provider, "needs_auth", False)`. –ï—Å–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None`.
2.  –ü–æ–ª—É—á–∞–µ—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É API-–∫–ª—é—á–∞ –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ —Å –ø–æ–º–æ—â—å—é —Ñ—É–Ω–∫—Ü–∏–∏ `AuthManager.get_api_key_file(provider)`.
3.  –ü—ã—Ç–∞–µ—Ç—Å—è –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª API-–∫–ª—é—á–∞ –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –Ω–µ–≥–æ JSON-–¥–∞–Ω–Ω—ã–µ.
4.  –ï—Å–ª–∏ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ JSON-–¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –∏–∑–≤–ª–µ–∫–∞–µ—Ç API-–∫–ª—é—á –∏–∑ JSON-–¥–∞–Ω–Ω—ã—Ö –ø–æ –∫–ª—é—á—É `"api_key"` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –µ–≥–æ.
5.  –ï—Å–ª–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏–ª–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞ –≤–æ–∑–Ω–∏–∫–∞—é—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è (`json.JSONDecodeError`, `PermissionError`, `FileNotFoundError`), –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∏—Ö, –ª–æ–≥–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `debug.error()` –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
6.  –ï—Å–ª–∏ API-–∫–ª—é—á –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `None`.

**–ü—Ä–∏–º–µ—Ä**:

```python
class MyProvider:
    needs_auth = True

    def __init__(self):
        # –°–æ–∑–¥–∞–µ–º —Ñ–µ–π–∫–æ–≤—ã–π —Ñ–∞–π–ª API-–∫–ª—é—á–∞ –¥–ª—è —Ç–µ—Å—Ç–∞
        api_key_file = AuthManager.get_api_key_file(self)
        api_key_file.write_text('{"api_key": "test_api_key"}')

provider = MyProvider()
api_key = AuthManager.load_api_key(provider)
# api_key –±—É–¥–µ—Ç "test_api_key"
```

### `ThinkingProcessor`

**–û–ø–∏—Å–∞–Ω–∏–µ**: –ö–ª–∞—Å—Å `ThinkingProcessor` –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ "—Ä–∞–∑–º—ã—à–ª—è—é—â–∏—Ö" —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ —Ç–µ–∫—Å—Ç–∞, –≤—ã–¥–µ–ª—è—è —ç—Ç–∞–ø—ã –º—ã—à–ª–µ–Ω–∏—è –∏ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç.

**–ü—Ä–∏–Ω—Ü–∏–ø —Ä–∞–±–æ—Ç—ã**: –ö–ª–∞—Å—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –º–µ—Ç–æ–¥ `process_thinking_chunk` –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ç–µ–≥–æ–≤ `<think>` –∏ `</think>`, –∫–æ—Ç–æ—Ä—ã–µ –æ–±–æ–∑–Ω–∞—á–∞—é—Ç –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü —ç—Ç–∞–ø–∞ "—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è". –ù–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–∏—Ö —Ç–µ–≥–æ–≤ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Ç–µ–∫—Å—Ç–∞ —Ä–∞–∑–¥–µ–ª—è—é—Ç—Å—è –Ω–∞ —á–∞—Å—Ç–∏, –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—é—â–∏–µ –æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç, –Ω–∞—á–∞–ª–æ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è, –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —ç—Ç–∞–ø–∞ —Å–æ–∑–¥–∞—é—Ç—Å—è –æ–±—ä–µ–∫—Ç—ã `Reasoning`, –∫–æ—Ç–æ—Ä—ã–µ —Å–æ–¥–µ—Ä–∂–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

**–ú–µ—Ç–æ–¥—ã**:

- `process_thinking_chunk(chunk: str, start_time: float = 0) -> Tuple[float, List[Union[str, Reasoning]]]`: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Ä–µ–º—è –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏.

#### `process_thinking_chunk`

```python
    @staticmethod
    def process_thinking_chunk(chunk: str, start_time: float = 0) -> Tuple[float, List[Union[str, Reasoning]]]:
        """Process a thinking chunk and return timing and results."""
        results = []
        
        # Handle non-thinking chunk
        if not start_time and "<think>" not in chunk and "</think>" not in chunk:\
            return 0, [chunk]
            
        # Handle thinking start
        if "<think>" in chunk and "`<think>`" not in chunk:\
            before_think, *after = chunk.split("<think>", 1)\
            
            if before_think:\
                results.append(before_think)\
                
            results.append(Reasoning(status="ü§î Is thinking...", is_thinking="<think>"))\
            
            if after:\
                if "</think>" in after[0]:\
                    after, *after_end = after[0].split("</think>", 1)\
                    results.append(Reasoning(after))\
                    results.append(Reasoning(status="Finished", is_thinking="</think>"))\
                    if after_end:\
                        results.append(after_end[0])\
                    return 0, results\
                else:\
                    results.append(Reasoning(after[0]))\
                
            return time.time(), results\
            
        # Handle thinking end
        if "</think>" in chunk:\
            before_end, *after = chunk.split("</think>", 1)\
            
            if before_end:\
                results.append(Reasoning(before_end))\
                
            thinking_duration = time.time() - start_time if start_time > 0 else 0\
            
            status = f"Thought for {thinking_duration:.2f}s" if thinking_duration > 1 else "Finished"\
            results.append(Reasoning(status=status, is_thinking="</think>"))\
            
            # Make sure to handle text after the closing tag
            if after and after[0].strip():\
                results.append(after[0])\
                
            return 0, results\
            
        # Handle ongoing thinking
        if start_time:\
            return start_time, [Reasoning(chunk)]\
            
        return start_time, [chunk]
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π —ç—Ç–∞–ø—ã "—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è", –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:

*   `chunk` (str): –§—Ä–∞–≥–º–µ–Ω—Ç —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.
*   `start_time` (float, optional): –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —ç—Ç–∞–ø–∞ "—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è". –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–≤–Ω–æ 0.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:

*   `Tuple[float, List[Union[str, Reasoning]]]`: –ö–æ—Ä—Ç–µ–∂, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π:

    *   –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ —ç—Ç–∞–ø–∞ "—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è" (float).
    *   –°–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏, –∫–∞–∂–¥—ã–π —ç–ª–µ–º–µ–Ω—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π (–æ–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç) –∏–ª–∏ –æ–±—ä–µ–∫—Ç–æ–º `Reasoning` (—ç—Ç–∞–ø "—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è").

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:

1.  –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ `results` –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –æ–±—Ä–∞–±–æ—Ç–∫–∏.
2.  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –æ–±—ã—á–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º (–Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–≥–æ–≤ `<think>` –∏ `</think>`). –ï—Å–ª–∏ `start_time` —Ä–∞–≤–Ω–æ 0 –∏ —Ç–µ–≥–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0 –∏ —Å–ø–∏—Å–æ–∫, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç.
3.  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ —ç—Ç–∞–ø "—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è" (—Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–≥ `<think>`).
    *   –ï—Å–ª–∏ —Ç–µ–≥ `<think>` –Ω–∞–π–¥–µ–Ω –∏ –Ω–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω (—Ç.–µ. –Ω–µ —è–≤–ª—è–µ—Ç—Å—è `` `<think>` ``), —Ä–∞–∑–¥–µ–ª—è–µ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç –Ω–∞ —á–∞—Å—Ç–∏ –¥–æ –∏ –ø–æ—Å–ª–µ —Ç–µ–≥–∞.
    *   –î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –¥–æ —Ç–µ–≥–∞ (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å) –≤ —Å–ø–∏—Å–æ–∫ `results`.
    *   –î–æ–±–∞–≤–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç `Reasoning` —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –Ω–∞—á–∞–ª–µ —ç—Ç–∞–ø–∞ "—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è" –≤ —Å–ø–∏—Å–æ–∫ `results`.
    *   –ï—Å–ª–∏ –ø–æ—Å–ª–µ —Ç–µ–≥–∞ –µ—Å—Ç—å —Ç–µ–∫—Å—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ –æ–Ω –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ `</think>`.
        *   –ï—Å–ª–∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ –Ω–∞–π–¥–µ–Ω, —Ä–∞–∑–¥–µ–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ `<think>` –Ω–∞ —á–∞—Å—Ç–∏ –¥–æ –∏ –ø–æ—Å–ª–µ `</think>`.
        *   –î–æ–±–∞–≤–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç `Reasoning` —Å —Ç–µ–∫—Å—Ç–æ–º –º–µ–∂–¥—É —Ç–µ–≥–∞–º–∏ –≤ —Å–ø–∏—Å–æ–∫ `results`.
        *   –î–æ–±–∞–≤–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç `Reasoning` —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —ç—Ç–∞–ø–∞ "—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è" –≤ —Å–ø–∏—Å–æ–∫ `results`.
        *   –î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ `</think>` (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å) –≤ —Å–ø–∏—Å–æ–∫ `results`.
        *   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0 –∏ —Å–ø–∏—Å–æ–∫ `results`.
        *   –ï—Å–ª–∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–∏–π —Ç–µ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç `Reasoning` —Å —Ç–µ–∫—Å—Ç–æ–º –ø–æ—Å–ª–µ `<think>` –≤ —Å–ø–∏—Å–æ–∫ `results`.
        *   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –∏ —Å–ø–∏—Å–æ–∫ `results`.
4.  –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ª–∏ —ç—Ç–∞–ø "—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è" (—Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–µ–≥ `</think>`).
    *   –ï—Å–ª–∏ —Ç–µ–≥ `</think>` –Ω–∞–π–¥–µ–Ω, —Ä–∞–∑–¥–µ–ª—è–µ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç –Ω–∞ —á–∞—Å—Ç–∏ –¥–æ –∏ –ø–æ—Å–ª–µ —Ç–µ–≥–∞.
    *   –î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –¥–æ —Ç–µ–≥–∞ (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å) –≤ —Å–ø–∏—Å–æ–∫ `results`.
    *   –í—ã—á–∏—Å–ª—è–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —ç—Ç–∞–ø–∞ "—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è" –Ω–∞ –æ—Å–Ω–æ–≤–µ `start_time`.
    *   –î–æ–±–∞–≤–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç `Reasoning` —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —ç—Ç–∞–ø–∞ "—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è` –≤ —Å–ø–∏—Å–æ–∫ `results`.
    *   –î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ—Å–ª–µ `</think>` (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å) –≤ —Å–ø–∏—Å–æ–∫ `results`.
    *   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç 0 –∏ —Å–ø–∏—Å–æ–∫ `results`.
5.  –ï—Å–ª–∏ `start_time` –Ω–µ —Ä–∞–≤–Ω–æ 0, –¥–æ–±–∞–≤–ª—è–µ—Ç –æ–±—ä–µ–∫—Ç `Reasoning` —Å —Ç–µ–∫—É—â–∏–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–º –≤ —Å–ø–∏—Å–æ–∫ `results` –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `start_time` –∏ —Å–ø–∏—Å–æ–∫ `results`.
6.  –ï—Å–ª–∏ –Ω–∏ –æ–¥–Ω–æ –∏–∑ —É—Å–ª–æ–≤–∏–π –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `start_time` –∏ —Å–ø–∏—Å–æ–∫, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç.

**–ü—Ä–∏–º–µ—Ä—ã**:

```python
# –ü—Ä–∏–º–µ—Ä 1: –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
chunk = "This is a simple text."
start_time = 0
start_time, results = ThinkingProcessor.process_thinking_chunk(chunk, start_time)
# start_time = 0
# results = ["This is a simple text."]

# –ü—Ä–∏–º–µ—Ä 2: –ù–∞—á–∞–ª–æ —ç—Ç–∞–ø–∞ "—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è"
chunk = "Some text before <think> the thinking part"
start_time = 0
start_time, results = ThinkingProcessor.process_thinking_chunk(chunk, start_time)
# start_time = <current_time>
# results = ["Some text before ", Reasoning(status="ü§î Is thinking...", is_thinking="<think>"), Reasoning(after=' the thinking part')]

# –ü—Ä–∏–º–µ—Ä 3: –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —ç—Ç–∞–ø–∞ "—Ä–∞–∑–º—ã—à–ª–µ–Ω–∏—è"
chunk = "the thinking part</think> and some text after"
start_time = <some_time>
start_time, results = ThinkingProcessor.process_thinking_chunk(chunk, start_time)
# start_time = 0
# results = [Reasoning(before_end='the thinking part'), Reasoning(status="Finished", is_thinking="</think>"), ' and some text after']
```

## –§—É–Ω–∫—Ü–∏–∏

### `perform_web_search`

```python
async def perform_web_search(messages: Messages, web_search_param: Any) -> Tuple[Messages, Optional[Sources]]:
    """Perform web search and return updated messages and sources"""
    messages = messages.copy()
    sources = None
    
    if not web_search_param:\
        return messages, sources\
        
    try:\
        search_query = web_search_param if isinstance(web_search_param, str) and web_search_param != "true" else None
        messages[-1]["content"], sources = await do_search(messages[-1]["content"], search_query)\
    except Exception as e:\
        debug.error(f"Couldn\'t do web search: {e.__class__.__name__}: {e}")\
        
    return messages, sources
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `messages` (Messages): –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π.
- `web_search_param` (Any): –ü–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `Tuple[Messages, Optional[Sources]]`: –ö–æ—Ä—Ç–µ–∂, —Å–æ–¥–µ—Ä–∂–∞—â–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ–∏—Å–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å).

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:

1.  –°–æ–∑–¥–∞–µ—Ç –∫–æ–ø–∏—é —Å–ø–∏—Å–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π `messages`.
2.  –ï—Å–ª–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä `web_search_param` –Ω–µ –∑–∞–¥–∞–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ `None`.
3.  –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å: –µ—Å–ª–∏ `web_search_param` —è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π –∏ –Ω–µ —Ä–∞–≤–µ–Ω `"true"`, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–≥–æ –≤ –∫–∞—á–µ—Å—Ç–≤–µ –∑–∞–ø—Ä–æ—Å–∞; –≤ –ø—Ä–æ—Ç–∏–≤–Ω–æ–º —Å–ª—É—á–∞–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ `None`.
4.  –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É—è —Ñ—É–Ω–∫—Ü–∏—é `do_search`, –ø–µ—Ä–µ–¥–∞–≤–∞—è –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.
5.  –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —Å–ø–∏—Å–∫–µ `messages` —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø–æ–∏—Å–∫–∞.
6.  –ï—Å–ª–∏ –≤–æ –≤—Ä–µ–º—è –ø–æ–∏—Å–∫–∞ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ, –ª–æ–≥–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `debug.error()`.
7.  –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ–∏—Å–∫–∞.

**–ü—Ä–∏–º–µ—Ä**:

```python
messages = [{"role": "user", "content": "Tell me about the weather in London"}]
web_search_param = "weather in London"
updated_messages, sources = await perform_web_search(messages, web_search_param)
# updated_messages –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–≥–æ–¥–µ –≤ –õ–æ–Ω–¥–æ–Ω–µ
# sources –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
```

### `async_iter_run_tools`

```python
async def async_iter_run_tools(\
    provider: ProviderType, \
    model: str, \
    messages: Messages, \
    tool_calls: Optional[List[dict]] = None, \
    **kwargs\
) -> AsyncIterator:\
    """Asynchronously run tools and yield results"""
    # Process web search
    sources = None
    web_search = kwargs.get('web_search')\
    if web_search:\
        messages, sources = await perform_web_search(messages, web_search)\
    
    # Get API key if needed
    api_key = AuthManager.load_api_key(provider)\
    if api_key and "api_key" not in kwargs:\
        kwargs["api_key"] = api_key\
    
    # Process tool calls
    if tool_calls:\
        messages, sources, extra_kwargs = await ToolHandler.process_tools(messages, tool_calls, provider)\
        kwargs.update(extra_kwargs)\
    
    # Generate response
    create_function = provider.get_async_create_function()\
    response = to_async_iterator(create_function(model=model, messages=messages, **kwargs))\
    
    async for chunk in response:\
        yield chunk\
        
    # Yield sources if available
    if sources:\
        yield sources
```

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –≤–∏–¥–µ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –∏—Ç–µ—Ä–∞—Ç–æ—Ä–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:

*   `provider` (`ProviderType`): –ü—Ä–æ–≤–∞–π–¥–µ—Ä AI-–º–æ–¥–µ–ª–∏.
*   `model` (`str`): –ò–º—è –º–æ–¥–µ–ª–∏ AI.
*   `messages` (`Messages`): –°–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏.
*   `tool_calls` (`Optional[List[dict]]`, optional): –°–ø–∏—Å–æ–∫ –≤—ã–∑–æ–≤–æ–≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é `None`.
*   `**kwargs`: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:

*   `AsyncIterator`: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤.

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—è**:

1.  –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ, –µ—Å–ª–∏ –∑–∞–¥–∞–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `web_search` –≤ `kwargs`.
2.  –ó–∞–≥—Ä—É–∂–∞–µ—Ç API-–∫–ª—é—á –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ.
3.  –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—ã–∑–æ–≤—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –∏—Å–ø–æ–ª—å–∑—É—è `ToolHandler.process_tools`.
4.  –ü–æ–ª—É—á–∞–µ—Ç —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –µ–µ –≤ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∏—Ç–µ—Ä–∞—Ç–æ—Ä.
5.  –ò—Ç–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ –æ—Ç–≤–µ—Ç–∞–º, –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –æ—Ç –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞, –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ö.
6.  –ï—Å–ª–∏ –µ—Å—Ç—å –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –ø–æ–∏—Å–∫–∞, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Ö.

**–ü—Ä–∏–º–µ—Ä—ã**:

```python
provider = MyProvider()
model = "my_model"
messages = [{"role": "user", "content": "Tell me a joke"}]
tool_calls = None
kwargs = {"web_search": "joke"}

async for chunk in async_iter_run_tools(provider, model, messages, tool_calls, **kwargs):
    print(chunk)
```

```ascii
  web_search = kwargs.get('web_search')
  ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ> web_search is not None:
  ‚îÇ     ‚îÇ
  ‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ> perform_web_search(messages, web_search)
  ‚îÇ           ‚îÇ
  ‚îÇ           ‚îú‚îÄ‚îÄ‚îÄ> messages = messages.copy()
  ‚îÇ           ‚îÇ
  ‚îÇ           ‚îú‚îÄ‚îÄ‚îÄ> perform do_search(...)
  ‚îÇ           ‚îÇ
  ‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ> messages[-1]["content"], sources = ...
  ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ> web_search is None:
        ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ> pass

  api_key = AuthManager.load_api_key(provider)
  ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ> api_key is not None and "api_key" not in kwargs:
  ‚îÇ     ‚îÇ
  ‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ> kwargs["api_key"] = api_key
  ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ> not (api_key is not None and "api_key" not in kwargs):
        ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ> pass

  tool_calls is not None
  ‚îÇ
  ‚îú‚îÄ‚îÄ‚îÄ> tool_calls is not None:
  ‚îÇ     ‚îÇ
  ‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ> ToolHandler.process_tools(messages, tool_calls, provider)
  ‚îÇ           ‚îÇ
  ‚îÇ           ‚îú‚îÄ‚îÄ‚îÄ> tool_calls is empty:
  ‚îÇ           ‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ> return messages, {}
  ‚îÇ           ‚îÇ
  ‚îÇ           ‚îî‚îÄ‚îÄ‚îÄ> tool_calls is not empty:
  ‚îÇ                 ‚îÇ
  ‚îÇ                 ‚îî‚îÄ‚îÄ‚îÄ> iterate tool_calls and process each tool
  ‚îÇ                       ‚îÇ
  ‚îÇ                       ‚îî‚îÄ‚îÄ‚îÄ> messages, sources, extra_kwargs = ...
  ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ> tool_calls is None:
        ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ> pass

  create_function = provider.get_async_create_function()

  response = to_async_iterator(create_function(model=model, messages=messages, **kwargs))

  iterate response and yield each chunk

  sources is not None
  ‚îÇ
  ‚îî‚îÄ‚îÄ‚îÄ> yield sources
```

### `iter_run_tools`

```python
def iter_run_tools(\
    iter_callback: Callable,\
    model: str,\
    messages: Messages,\
    provider: Optional[str] = None,\
    tool_calls: Optional[List[dict]] = None,\
    **kwargs\
) -> Iterator:\
    """Run tools synchronously and yield results"""
    # Process web search
    web_search = kwargs.get('web_search