# Модуль `retry_provider.py`

## Обзор

Модуль содержит тесты для проверки функциональности провайдера `IterListProvider`, который позволяет перебирать список провайдеров, пока один из них не вернет успешный результат. В тестах используются моки провайдеров, имитирующие различные сценарии, такие как генерация исключений, возвращение `None` и успешное возвращение результата. Модуль предназначен для проверки устойчивости и корректности работы `IterListProvider` в различных ситуациях.

## Подробней

Модуль `retry_provider.py` расположен в директории `hypotez/src/endpoints/gpt4free/etc/unittest/`. Это указывает на то, что он является частью набора модульных тестов для проекта `hypotez`. В частности, он тестирует функциональность, связанную с обработкой нескольких провайдеров, где при неудаче одного провайдера происходит переключение на другой. Это важно для обеспечения отказоустойчивости и надежности системы.

## Классы

### `TestIterListProvider`

**Описание**: Класс `TestIterListProvider` содержит набор асинхронных тестов, предназначенных для проверки поведения `IterListProvider`.

**Наследует**:

- `unittest.IsolatedAsyncioTestCase`: Этот класс обеспечивает основу для написания асинхронных тестов, гарантируя, что каждый тест выполняется в изолированной среде.

**Атрибуты**:

- `DEFAULT_MESSAGES (List[Dict[str, str]])`: Список сообщений по умолчанию, используемый в тестах. Содержит одно сообщение с ролью `user` и содержанием `Hello`.

**Методы**:

- `test_skip_provider()`: Тестирует случай, когда первый провайдер генерирует исключение, и `IterListProvider` переходит ко второму провайдеру, который успешно возвращает результат.
- `test_only_one_result()`: Тестирует случай, когда `IterListProvider` использует только первый провайдер из списка, даже если в списке есть другие провайдеры.
- `test_stream_skip_provider()`: Тестирует случай с потоковой передачей данных, когда первый провайдер генерирует исключение, и `IterListProvider` переходит ко второму провайдеру, который успешно возвращает результат.
- `test_stream_only_one_result()`: Тестирует случай с потоковой передачей данных, когда `IterListProvider` использует только первый провайдер из списка, даже если в списке есть другие провайдеры.
- `test_skip_none()`: Тестирует случай, когда первый провайдер возвращает `None`, и `IterListProvider` переходит ко второму провайдеру, который успешно возвращает результат.
- `test_stream_skip_none()`: Тестирует случай с потоковой передачей данных, когда первый провайдер возвращает `None`, и `IterListProvider` переходит ко второму провайдеру, который успешно возвращает результат.

## Функции

### `test_skip_provider`

```python
    async def test_skip_provider(self):
        """
        Тестирует случай, когда первый провайдер генерирует исключение, и IterListProvider переходит ко второму провайдеру,
        который успешно возвращает результат.
        """
```

**Назначение**:

Проверяет, что `IterListProvider` корректно обрабатывает ситуацию, когда первый провайдер в списке вызывает исключение, и переключается на следующего провайдера, который возвращает успешный результат.

**Параметры**:

- Отсутствуют

**Возвращает**:

- Отсутствует

**Вызывает исключения**:

- Не вызывает

**Как работает функция**:

1.  Создается экземпляр `AsyncClient` с `IterListProvider`, который настроен на использование `RaiseExceptionProviderMock` (генерирует исключение) и `YieldProviderMock` (возвращает успешный результат).
2.  Вызывается метод `client.chat.completions.create` с предопределенными сообщениями и пустой строкой.
3.  Проверяется, что возвращенный объект является экземпляром `ChatCompletion`.
4.  Проверяется, что содержимое сообщения в возвращенном объекте соответствует ожидаемому значению "Hello", что указывает на то, что был использован второй провайдер (`YieldProviderMock`).

**Примеры**:

```python
await TestIterListProvider().test_skip_provider()
```

### `test_only_one_result`

```python
    async def test_only_one_result(self):
        """
        Тестирует случай, когда IterListProvider использует только первый провайдер из списка,
        даже если в списке есть другие провайдеры.
        """
```

**Назначение**:

Проверяет, что `IterListProvider` использует только первый доступный провайдер и не пытается использовать другие провайдеры в списке, если первый провайдер успешно вернул результат.

**Параметры**:

- Отсутствуют

**Возвращает**:

- Отсутствует

**Вызывает исключения**:

- Не вызывает

**Как работает функция**:

1.  Создается экземпляр `AsyncClient` с `IterListProvider`, который настроен на использование двух экземпляров `YieldProviderMock` (оба возвращают успешный результат).
2.  Вызывается метод `client.chat.completions.create` с предопределенными сообщениями и пустой строкой.
3.  Проверяется, что возвращенный объект является экземпляром `ChatCompletion`.
4.  Проверяется, что содержимое сообщения в возвращенном объекте соответствует ожидаемому значению "Hello", что указывает на то, что был использован первый провайдер (`YieldProviderMock`).

**Примеры**:

```python
await TestIterListProvider().test_only_one_result()
```

### `test_stream_skip_provider`

```python
    async def test_stream_skip_provider(self):
        """
        Тестирует случай с потоковой передачей данных, когда первый провайдер генерирует исключение,
        и IterListProvider переходит ко второму провайдеру, который успешно возвращает результат.
        """
```

**Назначение**:

Проверяет, что `IterListProvider` корректно обрабатывает ситуацию потоковой передачи данных, когда первый провайдер в списке вызывает исключение, и переключается на следующего провайдера, который возвращает успешный результат.

**Параметры**:

- Отсутствуют

**Возвращает**:

- Отсутствует

**Вызывает исключения**:

- Не вызывает

**Как работает функция**:

1.  Создается экземпляр `AsyncClient` с `IterListProvider`, который настроен на использование `AsyncRaiseExceptionProviderMock` (генерирует исключение асинхронно) и `YieldProviderMock` (возвращает успешный результат).
2.  Создается список сообщений для потоковой передачи, где каждое сообщение содержит часть текста.
3.  Вызывается метод `client.chat.completions.create` с потоковой передачей (`stream=True`).
4.  Асинхронно перебираются чанки ответа и проверяется, что каждый чанк является экземпляром `ChatCompletionChunk`.
5.  Проверяется, что содержимое каждого чанка (если оно не `None`) является строкой.

**Примеры**:

```python
await TestIterListProvider().test_stream_skip_provider()
```

### `test_stream_only_one_result`

```python
    async def test_stream_only_one_result(self):
        """
        Тестирует случай с потоковой передачей данных, когда IterListProvider использует только первый провайдер из списка,
        даже если в списке есть другие провайдеры.
        """
```

**Назначение**:

Проверяет, что при потоковой передаче данных `IterListProvider` использует только первый доступный провайдер и не пытается использовать другие провайдеры в списке, если первый провайдер успешно вернул результат.

**Параметры**:

- Отсутствуют

**Возвращает**:

- Отсутствует

**Вызывает исключения**:

- Не вызывает

**Как работает функция**:

1.  Создается экземпляр `AsyncClient` с `IterListProvider`, который настроен на использование двух экземпляров `YieldProviderMock` (оба возвращают успешный результат).
2.  Создается список сообщений для потоковой передачи, где каждое сообщение содержит часть текста.
3.  Вызывается метод `client.chat.completions.create` с потоковой передачей (`stream=True`) и ограничением на максимальное количество токенов (`max_tokens=2`).
4.  Асинхронно перебираются чанки ответа и добавляются в список `response_list`.
5.  Проверяется, что количество чанков в `response_list` равно 3.
6.  Проверяется, что содержимое каждого чанка (если оно не `None`) соответствует ожидаемому значению "You ".

**Примеры**:

```python
await TestIterListProvider().test_stream_only_one_result()
```

### `test_skip_none`

```python
    async def test_skip_none(self):
        """
        Тестирует случай, когда первый провайдер возвращает None, и IterListProvider переходит ко второму провайдеру,
        который успешно возвращает результат.
        """
```

**Назначение**:

Проверяет, что `IterListProvider` корректно обрабатывает ситуацию, когда первый провайдер в списке возвращает `None`, и переключается на следующего провайдера, который возвращает успешный результат.

**Параметры**:

- Отсутствуют

**Возвращает**:

- Отсутствует

**Вызывает исключения**:

- Не вызывает

**Как работает функция**:

1.  Создается экземпляр `AsyncClient` с `IterListProvider`, который настроен на использование `YieldNoneProviderMock` (возвращает `None`) и `YieldProviderMock` (возвращает успешный результат).
2.  Вызывается метод `client.chat.completions.create` с предопределенными сообщениями и пустой строкой.
3.  Проверяется, что возвращенный объект является экземпляром `ChatCompletion`.
4.  Проверяется, что содержимое сообщения в возвращенном объекте соответствует ожидаемому значению "Hello", что указывает на то, что был использован второй провайдер (`YieldProviderMock`).

**Примеры**:

```python
await TestIterListProvider().test_skip_none()
```

### `test_stream_skip_none`

```python
    async def test_stream_skip_none(self):
        """
        Тестирует случай с потоковой передачей данных, когда первый провайдер возвращает None, и IterListProvider переходит ко второму провайдеру,
        который успешно возвращает результат.
        """
```

**Назначение**:

Проверяет, что `IterListProvider` корректно обрабатывает ситуацию потоковой передачи данных, когда первый провайдер в списке возвращает `None`, и переключается на следующего провайдера, который возвращает успешный результат.

**Параметры**:

- Отсутствуют

**Возвращает**:

- Отсутствует

**Вызывает исключения**:

- Не вызывает

**Как работает функция**:

1.  Создается экземпляр `AsyncClient` с `IterListProvider`, который настроен на использование `YieldNoneProviderMock` (возвращает `None`) и `YieldProviderMock` (возвращает успешный результат).
2.  Вызывается метод `client.chat.completions.create` с предопределенными сообщениями и пустой строкой и потоковой передачей (`stream=True`).
3.  Асинхронно перебираются чанки ответа и добавляются в список `response_list`.
4.  Проверяется, что количество чанков в `response_list` равно 2.
5.  Проверяется, что содержимое каждого чанка (если оно не `None`) соответствует ожидаемому значению "Hello".

**Примеры**:

```python
await TestIterListProvider().test_stream_skip_none()
```