## <алгоритм>

1. **Инициализация**:
   - Программа запускается, устанавливаются глобальные переменные и импортируются необходимые модули.
   - Определяются константы, такие как `UNICODE_SNOB`, `LINKS_EACH_PARAGRAPH`, `BODY_WIDTH` и т.д., которые задают поведение конвертера.
   - Определяется класс `Storage` для хранения настроек, а также задаются начальные значения для `options`.

2. **Разбор аргументов командной строки**:
   - Используется `optparse.OptionParser` для разбора аргументов командной строки.
   - Аргументы могут включать имя файла или URL для конвертации, кодировку, настройки Google Docs и другие параметры.
   - Значения параметров сохраняются в объекте `options`.

3. **Чтение входных данных**:
   - Если указан файл или URL, то программа считывает содержимое этого файла или URL.
     - Для URL используется `urllib.request.urlopen` для загрузки и `feedparser` или `chardet` для определения кодировки.
     - Для локального файла используется `open` для чтения содержимого и `chardet` для определения кодировки.
   - Если аргументы не указаны, то программа читает входные данные из `sys.stdin`.
   - Входные данные декодируются с использованием определенной кодировки.

4. **Преобразование HTML в текст**:
   - Создается экземпляр класса `_html2text`, который является наследником `HTMLParser.HTMLParser`.
   - Метод `feed` класса `_html2text` обрабатывает HTML-код, по мере его поступления.
   - HTML-код проходит через следующие этапы:
        - `handle_starttag`: обрабатывает открытие тегов HTML.
        - `handle_endtag`: обрабатывает закрытие тегов HTML.
        - `handle_data`: обрабатывает текстовые данные между тегами.
        - `handle_charref`: обрабатывает символьные ссылки типа `&#number;`.
        - `handle_entityref`: обрабатывает именованные ссылки типа `&name;`.
    - Во время обработки тегов и данных, происходит преобразование HTML-элементов в Markdown-эквиваленты:
      - Заголовки (`h1`-`h6`) преобразуются в `#` заголовки.
      - Параграфы (`p`, `div`) добавляют разрывы строк.
      - Списки (`ol`, `ul`, `li`) преобразуются в Markdown-списки.
      - Жирный текст (`b`, `strong`) преобразуется в `**текст**`.
      - Курсив (`i`, `em`) преобразуется в `_текст_`.
      - Ссылки (`a`) преобразуются в `[текст](url)` или `[текст][номер]` в зависимости от параметра `INLINE_LINKS`.
      - Изображения (`img`) преобразуются в `![alt](src)` или `![alt][номер]` в зависимости от параметра `INLINE_LINKS`.
      - Блоки кода (`code`) преобразуются в `` `текст` ``.
      - Цитаты (`blockquote`) преобразуются в `> текст`.
      - Аббревиатуры (`abbr`) сохраняются в `abbr_list`, а потом выводятся в конце.
      - Применяются стили (например, для Google Docs).
    - Метод `o` добавляет преобразованный текст в буфер вывода, учитывая настройки форматирования.

5. **Завершение и вывод**:
   - После обработки всего HTML-кода вызывается метод `close`, который завершает обработку и возвращает преобразованный текст.
   - Метод `close` выводит ссылки и аббревиатуры, сохраненные во время обработки.
   - Полученный текст обрезается от лишних пробельных символов и опционально переносится на новые строки, если задана `BODY_WIDTH`.
   - Результат выводится в `sys.stdout`.

**Примеры для каждого логического блока:**

- **Инициализация:** `UNICODE_SNOB = 0`, `BODY_WIDTH = 78`, `options.google_doc = False`
- **Разбор аргументов командной строки:** `python html2text.py -g -b 100 input.html`
  - `options.google_doc` становится `True`, `options.body_width` устанавливается в `100`.
- **Чтение входных данных:**
  - Чтение из файла `input.html`: `data = open("input.html", "rb").read().decode("utf-8")`
  - Чтение из URL: `data = urllib.request.urlopen("http://example.com").read().decode("utf-8")`
  - Чтение из `stdin`: `data = sys.stdin.read()`
- **Преобразование HTML в текст:**
    - Входной HTML: `<h1>Заголовок</h1><p>Это <b>жирный</b> текст.</p><a href="https://example.com">Ссылка</a>`
    - Результат:
      ```
      # Заголовок

      Это **жирный** текст.

      [Ссылка](https://example.com)
      ```
- **Завершение и вывод:**
    - После обработки всего HTML, преобразованный текст выводится в `sys.stdout`.
    - Если `BODY_WIDTH` установлен, текст переносится на новые строки.

## <mermaid>

```mermaid
flowchart TD
    Start(Start) --> ParseArgs[Parse Command Line Arguments];
    ParseArgs --> ReadInput[Read Input (File, URL or stdin)];
    ReadInput --> CreateHtml2Text[Create _html2text Instance];
    CreateHtml2Text --> FeedHtml[Feed HTML to Parser];
    FeedHtml --> HandleStartTag[handle_starttag (Tag, Attrs, Start=True)];
    FeedHtml --> HandleEndTag[handle_endtag (Tag, Attrs, Start=False)];
    FeedHtml --> HandleData[handle_data (Text Data)];
    FeedHtml --> HandleCharref[handle_charref (&#number;)];
    FeedHtml --> HandleEntityref[handle_entityref (&name;)];
    
    HandleStartTag --> ProcessTagStart[Process HTML Tag Start];
    HandleEndTag --> ProcessTagEnd[Process HTML Tag End];
        
    ProcessTagStart --> ConvertToMarkdown[Convert HTML to Markdown];
    ProcessTagEnd --> ConvertToMarkdown;
    
    HandleData --> ConvertToMarkdown
    HandleCharref --> ConvertToMarkdown
    HandleEntityref --> ConvertToMarkdown
    
    
    ConvertToMarkdown --> OutputBuffer[Append Markdown to Output Buffer];

    OutputBuffer --> FeedHtml
    
    FeedHtml --> CloseParser[Close Parser];
    CloseParser --> OutputLinksAbbr[Output Links and Abbreviations];
    OutputLinksAbbr --> ApplyTextWrapping[Apply Text Wrapping];
    ApplyTextWrapping --> PrintOutput[Print Output to stdout];
    PrintOutput --> End(End);
    
    
    
    
    
    style Start fill:#f9f,stroke:#333,stroke-width:2px
    style End fill:#ccf,stroke:#333,stroke-width:2px
```

**Описание зависимостей `mermaid`:**

-   **Start**: Начало выполнения программы.
-   **ParseArgs**: Разбор аргументов командной строки с использованием `optparse`. Результатом является объект `options`, содержащий настройки.
-   **ReadInput**: Чтение входных данных. Данные могут быть прочитаны из файла, URL или стандартного ввода.
-   **CreateHtml2Text**: Создание экземпляра класса `_html2text`, который отвечает за преобразование HTML в Markdown.
-   **FeedHtml**: Подача HTML-кода в парсер `_html2text` для обработки.
-   **HandleStartTag**: Обработчик открывающего HTML-тега.  Вызывается для каждого открывающего тега в HTML.
-   **HandleEndTag**: Обработчик закрывающего HTML-тега. Вызывается для каждого закрывающего тега в HTML.
-   **HandleData**: Обработчик текстовых данных. Вызывается для текстовых данных между HTML-тегами.
-   **HandleCharref**: Обработчик символьных ссылок (например, `&#123;`).
-   **HandleEntityref**: Обработчик именованных ссылок (например, `&nbsp;`).
-   **ProcessTagStart**: Обработка открывающего тега.  Извлекает информацию из тега и его атрибутов, сохраняет состояние.
-    **ProcessTagEnd**: Обработка закрывающего тега. Восстанавливает состояние.
-   **ConvertToMarkdown**: Преобразование HTML-элементов в эквивалентный Markdown.
-   **OutputBuffer**: Добавление преобразованного Markdown в буфер вывода.
-  **CloseParser**: Закрытие парсера, завершение обработки HTML.
-   **OutputLinksAbbr**: Вывод накопленных ссылок и аббревиатур.
-   **ApplyTextWrapping**: Применение переноса строк, если установлен параметр `BODY_WIDTH`.
-   **PrintOutput**: Вывод результата преобразования в `sys.stdout`.
-   **End**: Конец выполнения программы.

## <объяснение>

### Импорты:

-   **`html.entities as htmlentitydefs`**: Этот модуль предоставляет определения HTML-сущностей (например, `&nbsp;`, `&amp;`). Используется для преобразования сущностей в их Unicode-эквиваленты.
-   **`urllib.parse as urlparse`**: Используется для работы с URL, например, для объединения базового URL и относительных путей.
-   **`html.parser as HTMLParser`**: Модуль для разбора HTML-кода. Класс `_html2text` наследуется от `HTMLParser.HTMLParser` для реализации парсера.
-   **`urllib.request as urllib`**: Модуль для открытия URL-адресов и чтения их содержимого.
-   **`optparse`**: Модуль для разбора аргументов командной строки.
-   **`re`**: Модуль для работы с регулярными выражениями. Используется для поиска и замены строк.
-   **`sys`**: Модуль для работы с системными параметрами и функциями, например, для вывода в `stdout`.
-   **`codecs`**: Модуль для работы с кодировками символов.
-   **`textwrap.wrap`**:  Используется для переноса длинных строк.
-   **`types`**:  Используется для проверки типов.
-   Импорт `feedparser` и `chardet`  происходит только в случае необходимости, и они не являются обязательными зависимостями.

### Классы:

-   **`_html2text(HTMLParser.HTMLParser)`**:
    -   **Роль**: Основной класс для преобразования HTML в текст. Наследуется от `HTMLParser.HTMLParser` для разбора HTML.
    -   **Атрибуты**:
        -   `out`: Функция для вывода преобразованного текста.
        -   `outtextlist`: Список для хранения промежуточного результата преобразования.
        -   `outtext`: Строка для хранения финального результата.
        -   `quiet`: Флаг для управления выводом.
        -   `p_p`: Количество переводов строк для добавления.
        -   `outcount`: Счетчик для элементов вывода.
        -   `start`: Флаг начала строки.
        -   `space`: Флаг для добавления пробелов.
        -   `a`: Список для хранения ссылок.
        -   `astack`: Стек для обработки ссылок.
        -   `acount`: Счетчик для ссылок.
        -   `list`: Список для отслеживания вложенных списков.
        -   `blockquote`: Счетчик для блоков цитат.
        -   `pre`: Флаг для тегов `<pre>`.
        -   `startpre`: Флаг начала тега `<pre>`.
        -   `code`: Флаг для тегов `<code>`.
        -   `br_toggle`: Флаг для тега `<br>`.
        -   `lastWasNL`: Флаг для последнего символа перевода строки.
        -   `lastWasList`: Флаг для последнего списка.
        -   `style`: Флаг для тега `<style>`.
        -    `style_def`: Словарь для определения CSS стилей.
        -   `tag_stack`: Стек для отслеживания тегов.
        -   `emphasis`: Счетчик выделения текста.
        -   `drop_white_space`: Флаг для отбрасывания пробелов.
        -   `inheader`: Флаг для заголовков.
        -   `abbr_title`: Временное хранилище для заголовка аббревиатуры.
        -   `abbr_data`: Временное хранилище для данных аббревиатуры.
        -   `abbr_list`: Список для хранения аббревиатур.
        -   `baseurl`: Базовый URL для ссылок.
    -   **Методы**:
        -   `__init__`: Инициализация объекта.
        -   `feed`: Обработка HTML-кода.
        -   `outtextf`: Добавление текста в буфер вывода.
        -   `close`: Завершение обработки и возврат результата.
        -   `handle_charref`: Обработка символьных ссылок.
        -   `handle_entityref`: Обработка именованных ссылок.
        -   `handle_starttag`: Обработка открывающих тегов.
        -   `handle_endtag`: Обработка закрывающих тегов.
        -   `previousIndex`: Получение индекса ссылки.
        -   `drop_last`: Удаление последних символов.
        -   `handle_emphasis`: Обработка выделения текста.
        -   `handle_tag`: Обработка тегов HTML.
        -   `pbr`: Добавление перевода строки.
        -   `p`: Добавление двойного перевода строки.
        -   `soft_br`: Добавление мягкого перевода строки.
        -   `o`: Вывод текста, форматированного под Markdown.
        -   `handle_data`: Обработка текстовых данных.
        -   `unknown_decl`: Обработчик неизвестных объявлений.
-   **`Storage`**: Пустой класс для хранения настроек. Используется как простой объект для хранения атрибутов.

### Функции:

-   **`has_key(x, y)`**: Проверка наличия ключа в словаре или атрибута в объекте.
-   **`name2cp(k)`**: Преобразование имени HTML-сущности в кодовую точку.
-   **`charref(name)`**: Преобразование символьной ссылки в символ.
-   **`entityref(c)`**: Преобразование именованной ссылки в символ.
-   **`replaceEntities(s)`**:  Функция обратного вызова для `re.sub` для преобразования HTML сущностей
-   **`unescape(s)`**: Удаление HTML сущностей из строки.
-   **`onlywhite(line)`**: Проверяет, состоит ли строка только из пробельных символов.
-   **`optwrap(text)`**: Оборачивает текст в соответствии с `BODY_WIDTH`.
-   **`hn(tag)`**: Проверяет, является ли тег заголовком (`h1`-`h6`).
-   **`dumb_property_dict(style)`**: Парсер CSS стилей.
-   **`dumb_css_parser(data)`**: Парсер CSS селекторов.
-  **`element_style(attrs, style_def, parent_style)`**: Возвращает окончательный стиль элемента
-   **`google_list_style(style)`**: Определяет, является ли список упорядоченным или нет.
-   **`google_nest_count(style)`**: Возвращает уровень вложенности для Google Docs.
-   **`google_has_height(style)`**: Проверка атрибута высоты в стиле.
-  **`google_text_emphasis(style)`**: Возвращает список атрибутов, определяющих начертание текста
-   **`google_fixed_width_font(style)`**: Проверяет, используется ли шрифт с фиксированной шириной.
-   **`list_numbering_start(attrs)`**: Извлечение начального номера списка.
-   **`wrapwrite(text)`**: Выводит текст в `stdout` с учетом кодировки.
-   **`html2text_file(html, out=wrapwrite, baseurl='')`**: Основная функция для преобразования HTML в текст.
-   **`html2text(html, baseurl='')`**: Функция для преобразования HTML в текст с переносом строк.

### Переменные:

-   `UNICODE_SNOB`: Флаг для использования Unicode символов.
-   `LINKS_EACH_PARAGRAPH`: Флаг для вывода ссылок после каждого параграфа.
-   `BODY_WIDTH`: Ширина строки для переноса.
-   `SKIP_INTERNAL_LINKS`: Флаг для пропуска внутренних ссылок.
-   `INLINE_LINKS`: Флаг для использования inline-форматирования для ссылок и изображений.
-   `GOOGLE_LIST_INDENT`: Размер отступа для списков Google Docs.
-   `IGNORE_ANCHORS`: Флаг для пропуска ссылок.
-   `IGNORE_IMAGES`: Флаг для пропуска изображений.
-   `unifiable`: Словарь для преобразования имен HTML-сущностей в Unicode-символы.
-   `unifiable_n`: Словарь для преобразования кодовых точек в Unicode-символы.
-    `options`: Объект для хранения настроек командной строки.

### Потенциальные ошибки и области для улучшения:

1.  **Обработка вложенных стилей**:
    -   Стили обрабатываются с использованием простого парсера, что может не учитывать сложные случаи CSS (например, селекторы с более высокой специфичностью).
    -   Не обрабатываются `@media` и другие сложные конструкции CSS.

2.  **Сложная логика `handle_emphasis`**:
    -   Функция `handle_emphasis` достаточно сложна и требует хорошего понимания ее работы.
    -   Необходимо учесть, что вложенные теги с выделением могут влиять на результат.

3.  **Ограниченная поддержка HTML**:
    -   Не все HTML-теги поддерживаются. Некоторые теги игнорируются или обрабатываются не полностью.
    -   Могут возникнуть проблемы с некорректным HTML.

4.  **Обработка пробелов**:
    -   Обработка пробелов в разных ситуациях сложная. Могут возникать лишние или отсутствующие пробелы.

5.  **Сложность поддержки Google Docs**:
    -   Код специфичен для Google Docs и может не работать с другими HTML-источниками.

6.  **Расширяемость**:
    -   Код не очень модульный, что может затруднять его расширение и поддержку.

### Взаимосвязи с другими частями проекта:

-   Этот файл является частью утилиты для преобразования HTML в текст, которая может использоваться в разных частях проекта.
-   Он не зависит от других частей проекта, кроме стандартных библиотек Python.
-  Он может быть использован для обработки HTML-контента, извлеченного из различных источников (файлов, веб-страниц, баз данных) в проекте `hypotez`.
-  Результат преобразования HTML в Markdown может быть использован для отображения контента, создания документации или в других целях в проекте `hypotez`.