# Модуль для работы с Vercel API
## Обзор

Модуль предоставляет класс `Client` для взаимодействия с API Vercel для генерации текста с использованием различных моделей машинного обучения. Он включает в себя функциональность для получения токена авторизации, установки параметров модели и отправки запросов на генерацию текста.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для обеспечения доступа к моделям, размещенным на платформе Vercel. Он использует библиотеку `curl_cffi` для выполнения HTTP-запросов и `execjs` для выполнения JavaScript-кода, необходимого для получения токена авторизации.

## Содержание

- [Классы](#классы)
    - [Client](#client)
        - [Методы](#методы-client)
            - [`__init__`](#__init__)
            - [`get_token`](#get_token)
            - [`get_default_params`](#get_default_params)
            - [`generate`](#generate)
- [Функции](#функции)
    - [`_create_completion`](#_create_completion)

## Классы

### `Client`

Описание: Класс для взаимодействия с API Vercel.

**Принцип работы**:
1.  Создает сессию `requests.Session()` для выполнения HTTP-запросов.
2.  Инициализирует заголовки запросов, которые будут использоваться при взаимодействии с API Vercel.
3.  Предоставляет методы для получения токена авторизации (`get_token`), получения параметров модели по умолчанию (`get_default_params`) и генерации текста (`generate`).

#### Методы `Client`

#### `__init__`

```python
def __init__(self):
    """
    Инициализирует сессию и устанавливает заголовки для запросов.
    """
```

**Назначение**: Инициализирует экземпляр класса `Client`.

**Как работает функция**:

1.  Создает HTTP сессию с помощью `requests.Session()`.
2.  Определяет заголовки HTTP запросов, включая `User-Agent`, `Accept`, `Accept-Encoding`, `Accept-Language`, `Te`, `Upgrade-Insecure-Requests`.
3.  Обновляет заголовки сессии, добавляя заданные заголовки.

#### `get_token`

```python
def get_token(self) -> str:
    """
    Получает токен авторизации с использованием JavaScript-кода.

    Returns:
        str: Токен авторизации.
    """
```

**Назначение**: Получает токен авторизации, необходимый для доступа к API Vercel.

**Как работает функция**:

1.  Получает данные в формате Base64 с URL `'https://sdk.vercel.ai/openai.jpeg'`.
2.  Декодирует полученные данные из Base64 в JSON.
3.  Формирует JavaScript-код на основе полученных данных.
4.  Выполняет JavaScript-код с использованием `execjs.compile(code).call('token')` для получения токена.
5.  Кодирует полученный токен в Base64 и возвращает его.

```
A [Получение b64]
|
B [Декодирование b64 в JSON]
|
C [Формирование JavaScript-кода]
|
D [Выполнение JavaScript-кода и получение токена]
|
E [Кодирование токена в Base64]
|
F [Возврат токена]
```

#### `get_default_params`

```python
def get_default_params(self, model_id: str) -> Dict:
    """
    Получает параметры модели по умолчанию.

    Args:
        model_id (str): Идентификатор модели.

    Returns:
        Dict: Словарь параметров модели по умолчанию.
    """
```

**Назначение**: Извлекает параметры по умолчанию для указанной модели из словаря `vercel_models`.

**Параметры**:

*   `model_id` (str): Идентификатор модели, для которой требуется получить параметры.

**Возвращает**:

*   `Dict`: Словарь, содержащий параметры модели по умолчанию.

**Как работает функция**:

1.  Получает словарь параметров модели из `vercel_models[model_id]['parameters']`.
2.  Преобразует словарь параметров в формат `{key: param['value']}`.

```
A [Получение параметров модели из vercel_models]
|
B [Преобразование параметров в формат {key: param['value']}]
|
C [Возврат параметров]
```

#### `generate`

```python
def generate(self, model_id: str, prompt: str, params: dict = {}) -> Generator[str, None, None]:
    """
    Генерирует текст на основе указанной модели и промпта.

    Args:
        model_id (str): Идентификатор модели.
        prompt (str): Входной промпт.
        params (dict, optional): Дополнительные параметры. По умолчанию {}.

    Yields:
        Generator[str, None, None]: Генератор токенов сгенерированного текста.
    """
```

**Назначение**: Генерирует текст с использованием указанной модели и входного промпта, возвращая токены сгенерированного текста через генератор.

**Параметры**:

*   `model_id` (str): Идентификатор модели для генерации текста.
*   `prompt` (str): Входной текст (промпт) для модели.
*   `params` (dict, optional): Дополнительные параметры, которые будут переданы модели. По умолчанию `{}`.

**Yields**:

*   `Generator[str, None, None]`: Генератор, выдающий токены сгенерированного текста.

**Как работает функция**:

1.  Проверяет, содержит ли `model_id` символ `:`. Если нет, заменяет `model_id` на соответствующий из словаря `models`.
2.  Получает параметры модели по умолчанию с помощью `self.get_default_params(model_id)`.
3.  Объединяет параметры по умолчанию, переданные параметры и промпт в один словарь `payload`.
4.  Формирует заголовки запроса, включая токен авторизации, полученный с помощью `self.get_token()`.
5.  Создает очередь `chunks_queue` для хранения чанков сгенерированного текста.
6.  Определяет функцию `callback(data)`, которая помещает декодированные чанки данных в очередь `chunks_queue`.
7.  Определяет функцию `request_thread()`, которая отправляет POST-запрос к API Vercel и обрабатывает ответ, используя `callback` для получения чанков данных.
8.  Запускает `request_thread()` в отдельном потоке.
9.  Итерирует по чанкам, полученным из очереди `chunks_queue`, и извлекает токены из JSON-строк, разделенных символом новой строки `\n`.
10. Возвращает токены сгенерированного текста через генератор.

```
A [Проверка и замена model_id при необходимости]
|
B [Получение параметров модели по умолчанию]
|
C [Формирование payload]
|
D [Формирование заголовков запроса]
|
E [Создание очереди для чанков]
|
F [Определение callback-функции]
|
G [Определение request_thread-функции]
|
H [Запуск request_thread в отдельном потоке]
|
I [Получение чанков из очереди и извлечение токенов]
|
J [Возврат токенов через генератор]
```

## Функции

### `_create_completion`

```python
def _create_completion(model: str, messages: list, stream: bool, **kwargs) -> Generator[str, None, None]:
    """
    Создает завершение текста на основе указанной модели и истории сообщений.

    Args:
        model (str): Идентификатор модели.
        messages (list): Список сообщений в формате [{"role": "user" | "assistant", "content": "message text"}].
        stream (bool): Флаг, указывающий, следует ли возвращать результат в виде потока.
        **kwargs: Дополнительные параметры.

    Yields:
        Generator[str, None, None]: Генератор токенов сгенерированного текста.
    """
```

**Назначение**: Генерирует завершение текста на основе указанной модели и истории сообщений.

**Параметры**:

*   `model` (str): Идентификатор модели, используемой для генерации текста.
*   `messages` (list): Список сообщений, представляющих историю разговора. Каждое сообщение должно быть в формате `{"role": "user" | "assistant", "content": "message text"}`.
*   `stream` (bool): Флаг, указывающий, следует ли возвращать результат в виде потока. Если `True`, функция будет генерировать токены по мере их генерации моделью.
*   `**kwargs`: Дополнительные параметры, которые могут быть переданы модели.

**Yields**:

*   `Generator[str, None, None]`: Генератор токенов сгенерированного текста.

**Как работает функция**:

1.  Возвращает `'Vercel is currently not working.'` (В данный момент Vercel не работает.)
2.  Формирует строку `conversation` из истории сообщений, объединяя роль и содержимое каждого сообщения.
3.  Добавляет к строке `conversation` префикс `'assistant: '`.
4.  Использует `Client().generate(model, conversation)` для генерации текста на основе сформированной строки `conversation`.
5.  Итерирует по токенам, возвращаемым `Client().generate(model, conversation)`, и возвращает их через генератор.

```
A [Возврат "Vercel is currently not working."]
|
B [Формирование строки conversation из истории сообщений]
|
C [Добавление префикса "assistant: "]
|
D [Использование Client().generate() для генерации текста]
|
E [Итерирование по токенам и возврат их через генератор]