# Модуль для работы с Hailuo AI
=================================

Модуль предоставляет асинхронную поддержку для взаимодействия с Hailuo AI, включая аутентификацию и создание бесед.

## Обзор

Этот модуль предназначен для асинхронного взаимодействия с провайдером Hailuo AI. Он включает в себя функциональность для аутентификации, создания бесед и получения ответов от модели MiniMax. Модуль использует `aiohttp` для асинхронных запросов и `FormData` для передачи данных.

## Подробней

Модуль содержит класс `HailuoAI`, который наследуется от `AsyncAuthedProvider` и `ProviderModelMixin`. Он реализует методы для аутентификации и создания бесед с использованием API Hailuo AI.

## Классы

### `Conversation`

**Описание**: Представляет собой класс для хранения информации о беседе.

**Атрибуты**:
- `token` (str): Токен аутентификации.
- `chatID` (str): Идентификатор чата.
- `characterID` (str, optional): Идентификатор персонажа. По умолчанию равен 1.

### `HailuoAI`

**Описание**: Класс для взаимодействия с Hailuo AI.

**Наследует**:
- `AsyncAuthedProvider`: Предоставляет базовую функциональность для асинхронной аутентификации.
- `ProviderModelMixin`: Добавляет поддержку выбора модели.

**Атрибуты**:
- `label` (str): Метка провайдера ("Hailuo AI").
- `url` (str): URL API Hailuo AI ("https://www.hailuo.ai").
- `working` (bool): Указывает, работает ли провайдер (True).
- `use_nodriver` (bool): Указывает, используется ли бездрайверный режим (True).
- `supports_stream` (bool): Указывает, поддерживает ли потоковую передачу данных (True).
- `default_model` (str): Модель по умолчанию ("MiniMax").

**Методы**:
- `on_auth_async()`: Асинхронный метод для аутентификации.
- `create_authed()`: Асинхронный метод для создания аутентифицированного запроса.

## Функции

### `on_auth_async`

```python
@classmethod
async def on_auth_async(cls, proxy: str = None, **kwargs) -> AsyncIterator:
    """Асинхронно аутентифицируется на Hailuo AI.

    Args:
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncIterator: Асинхронный итератор, возвращающий результаты аутентификации.
    """
    ...
```

**Назначение**:
Асинхронно аутентифицируется на Hailuo AI.

**Параметры**:
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncIterator`: Асинхронный итератор, возвращающий результаты аутентификации. Может возвращать объекты `RequestLogin` и `AuthResult`.

**Как работает функция**:

1.  **Получение URL для логина**: Функция пытается получить URL для логина из переменной окружения `G4F_LOGIN_URL`. Если URL найден, она возвращает `RequestLogin` с этим URL.
2.  **Получение результатов Callback**: Функция вызывает `get_browser_callback` для получения обратного вызова из браузера, а затем вызывает `get_args_from_nodriver` для получения аргументов из бездрайверного режима.
3.  **Возвращение результата аутентификации**: Функция возвращает `AuthResult` с результатами аутентификации, включая аргументы, полученные из бездрайверного режима, и результаты обратного вызова.

```
      Получение URL из env vars
      │
      ├───► Если URL получен: Возвращаем RequestLogin
      │
      └───► Если URL не получен:
             │
             ├───► Получение CallbackResults
             │    │
             │    └───► Получение аргументов из nodriver
             │         │
             │         └───► Объединение результатов и возвращение AuthResult
             │
             └───► Завершение
```

### `create_authed`

```python
@classmethod
async def create_authed(
    cls,
    model: str,
    messages: Messages,
    auth_result: AuthResult,
    return_conversation: bool = False,
    conversation: Conversation = None,
    **kwargs
) -> AsyncResult:
    """Создает аутентифицированный запрос к Hailuo AI.

    Args:
        model (str): Модель для использования.
        messages (Messages): Список сообщений для отправки.
        auth_result (AuthResult): Результат аутентификации.
        return_conversation (bool, optional): Указывает, следует ли возвращать объект `Conversation`. По умолчанию `False`.
        conversation (Conversation, optional): Объект `Conversation` для продолжения беседы. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный итератор, возвращающий результаты запроса.
    """
    ...
```

**Назначение**:
Создает аутентифицированный запрос к Hailuo AI.

**Параметры**:
- `model` (str): Модель для использования.
- `messages` (Messages): Список сообщений для отправки.
- `auth_result` (AuthResult): Результат аутентификации.
- `return_conversation` (bool, optional): Указывает, следует ли возвращать объект `Conversation`. По умолчанию `False`.
- `conversation` (Conversation, optional): Объект `Conversation` для продолжения беседы. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный итератор, возвращающий результаты запроса. Может возвращать объекты `TitleGeneration`, `Conversation` и строковые данные.

**Как работает функция**:

1.  **Извлечение данных аутентификации**: Извлекает данные аутентификации из `auth_result` и удаляет некоторые ключи.
2.  **Создание сессии**: Создает асинхронную сессию `ClientSession` с аргументами аутентификации.
3.  **Определение данных формы**: Определяет данные формы в зависимости от наличия объекта `Conversation`. Если `Conversation` существует, используются его данные; в противном случае используются значения по умолчанию.
4.  **Формирование данных для запроса**: Преобразует данные формы в формат `FormData` и добавляет их в тело запроса.
5.  **Формирование заголовков**: Создает заголовки запроса, включая токен и `yy` (сгенерированный заголовок).
6.  **Отправка запроса**: Отправляет POST-запрос к API Hailuo AI с данными формы и заголовками.
7.  **Обработка ответа**: Асинхронно обрабатывает ответ от API, извлекая данные из каждой строки ответа. Если строка начинается с "event:", извлекается событие. Если строка начинается с "data:", извлекаются данные JSON.
8.  **Генерация результатов**: В зависимости от события генерируются различные результаты:
    -   `send_result`: генерируется `TitleGeneration` (если есть `chatTitle`) и `Conversation` (если `return_conversation` равен `True` и есть `chatID`).
    -   `message_result`: генерируется контент сообщения.

```
      Извлечение данных аутентификации
      │
      ├───► Создание асинхронной сессии
      │    │
      │    ├───► Проверка наличия conversation
      │    │    │
      │    │    ├───► Если conversation существует:
      │    │    │    │
      │    │    │    └───► Формирование данных формы на основе conversation
      │    │    │
      │    │    └───► Если conversation не существует:
      │    │         │
      │    │         └───► Формирование данных формы с значениями по умолчанию
      │    │
      │    ├───► Формирование данных для запроса (FormData)
      │    │
      │    ├───► Формирование заголовков запроса
      │    │
      │    ├───► Отправка POST-запроса к API Hailuo AI
      │    │
      │    └───► Обработка ответа от API (построчно)
      │         │
      │         ├───► Если строка начинается с "event:":
      │         │    │
      │         │    └───► Извлечение события
      │         │         │
      │         │         ├───► Если событие "send_result":
      │         │         │    │
      │         │         │    └───► Генерация TitleGeneration и Conversation
      │         │         │
      │         │         └───► Если событие "message_result":
      │         │              │
      │         │              └───► Генерация контента сообщения
      │         │
      │         └───► Завершение
      │
      └───► Завершение
```