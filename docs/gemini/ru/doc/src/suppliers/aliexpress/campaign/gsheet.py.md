# Модуль для работы с Google Sheets для управления рекламными кампаниями AliExpress
=========================================================================================

Модуль `gsheet.py` предоставляет класс `AliCampaignGoogleSheet`, который расширяет функциональность класса `SpreadSheet` для работы с Google Sheets в контексте управления рекламными кампаниями на платформе AliExpress. Он включает методы для записи данных о кампаниях, категориях и продуктах, а также для форматирования листов Google Sheets.

## Обзор

Модуль предназначен для автоматизации процесса обновления и управления данными, связанными с рекламными кампаниями AliExpress, посредством Google Sheets. Он обеспечивает удобный интерфейс для записи и форматирования данных, а также для удаления и очистки листов.

## Подробнее

Модуль `AliCampaignGoogleSheet` использует Google Sheets API для взаимодействия с таблицами. Он позволяет создавать, обновлять и удалять листы, а также записывать данные о кампаниях, категориях и продуктах. Модуль также включает функциональность для форматирования листов, что делает их более читаемыми и удобными для работы.

## Классы

### `AliCampaignGoogleSheet`

**Описание**: Класс для работы с Google Sheets в рамках кампаний AliExpress.

**Наследует**: `SpreadSheet`

**Принцип работы**:
Класс `AliCampaignGoogleSheet` наследует функциональность класса `SpreadSheet` и добавляет методы для работы с данными, специфичными для рекламных кампаний AliExpress. Он использует идентификатор Google Sheets для доступа к таблице и предоставляет методы для управления листами, записи данных и форматирования листов.

**Аттрибуты**:
- `spreadsheet_id` (str): Идентификатор Google Sheets таблицы.
- `spreadsheet` (SpreadSheet): Объект `SpreadSheet` для работы с Google Sheets API.
- `worksheet` (Worksheet): Объект `Worksheet` для работы с конкретным листом Google Sheets.

**Методы**:
- `__init__(campaign_name: str, language: str | dict = None, currency: str = None)`: Инициализирует экземпляр класса `AliCampaignGoogleSheet`.
- `clear()`: Очищает содержимое таблицы Google Sheets.
- `delete_products_worksheets()`: Удаляет все листы продуктов из Google Sheets, кроме листов 'categories', 'product', 'category', 'campaign'.
- `set_campaign_worksheet(campaign: SimpleNamespace)`: Записывает данные о кампании в лист Google Sheets.
- `set_products_worksheet(category_name: str)`: Записывает данные о продуктах категории в лист Google Sheets.
- `set_categories_worksheet(categories: SimpleNamespace)`: Записывает данные о категориях в лист Google Sheets.
- `get_categories()`: Получает данные о категориях из листа Google Sheets.
- `set_category_products(category_name: str, products: dict)`: Записывает данные о продуктах категории в новый лист Google Sheets.
- `_format_categories_worksheet(ws: Worksheet)`: Форматирует лист 'categories' в Google Sheets.
- `_format_category_products_worksheet(ws: Worksheet)`: Форматирует лист с продуктами категории в Google Sheets.

## Функции

### `__init__`

```python
def __init__(self, campaign_name: str, language: str | dict = None, currency: str = None):
```

**Назначение**: Инициализация экземпляра класса `AliCampaignGoogleSheet`.

**Параметры**:
- `campaign_name` (str): Название кампании.
- `language` (str | dict, optional): Язык кампании. По умолчанию `None`.
- `currency` (str, optional): Валюта кампании. По умолчанию `None`.

**Возвращает**: `None`

**Вызывает исключения**:
- Отсутствуют явные исключения, но могут быть исключения, связанные с базовым классом `SpreadSheet`.

**Как работает функция**:
1. Инициализирует класс `AliCampaignGoogleSheet`, вызывая конструктор базового класса `SpreadSheet` с предопределенным `spreadsheet_id`.
2. Инициализирует атрибуты `campaign_name`, `language` и `currency` для дальнейшего использования в методах класса.

```
A: Инициализация класса AliCampaignGoogleSheet
|
B: Вызов конструктора базового класса SpreadSheet
|
C: Инициализация атрибутов campaign_name, language, currency
```

**Примеры**:

```python
campaign_gsheet = AliCampaignGoogleSheet(campaign_name='test_campaign', language='ru', currency='USD')
```

### `clear`

```python
def clear(self):
```

**Назначение**: Очистка содержимого Google Sheets.

**Параметры**: Отсутствуют.

**Возвращает**: `None`

**Вызывает исключения**:
- `Exception` as `ex`: Логирует ошибку очистки, если она возникает.

**Как работает функция**:
1. Пытается удалить все листы продуктов, вызывая метод `delete_products_worksheets`.
2. В случае возникновения ошибки, логирует сообщение об ошибке с использованием `logger.error`.

```
A: Попытка удаления листов продуктов
|
B: Обработка исключения (если возникло)
```

**Примеры**:

```python
campaign_gsheet.clear()
```

### `delete_products_worksheets`

```python
def delete_products_worksheets(self):
```

**Назначение**: Удаление всех листов продуктов из Google Sheets, кроме листов 'categories', 'product', 'category', 'campaign'.

**Параметры**: Отсутствуют.

**Возвращает**: `None`

**Вызывает исключения**:
- `Exception` as `ex`: Логирует ошибку при удалении листов и поднимает исключение.

**Как работает функция**:
1. Определяет список исключенных названий листов (`excluded_titles`).
2. Получает список всех листов в Google Sheets.
3. Итерируется по листам и удаляет те, названия которых нет в списке исключенных.
4. Логирует успешное удаление каждого листа с помощью `logger.success`.
5. В случае возникновения ошибки, логирует сообщение об ошибке с использованием `logger.error` и поднимает исключение.

```
A: Определение списка исключенных названий листов
|
B: Получение списка всех листов в Google Sheets
|
C: Итерация по листам
|
D: Проверка названия листа на исключение
|
E: Удаление листа (если не исключен)
|
F: Логирование успешного удаления
|
G: Обработка исключения (если возникло)
```

**Примеры**:

```python
campaign_gsheet.delete_products_worksheets()
```

### `set_campaign_worksheet`

```python
def set_campaign_worksheet(self, campaign: SimpleNamespace):
```

**Назначение**: Запись данных о кампании в лист Google Sheets.

**Параметры**:
- `campaign` (SimpleNamespace): Объект `SimpleNamespace` с данными о кампании.

**Возвращает**: `None`

**Вызывает исключения**:
- `Exception` as `ex`: Логирует ошибку при записи данных в лист и поднимает исключение.

**Как работает функция**:
1. Получает лист Google Sheets с названием 'campaign'.
2. Подготавливает данные для вертикальной записи, используя список кортежей `vertical_data`.
3. Итерируется по данным и добавляет операции обновления в список `updates`.
4. Выполняет пакетное обновление листа, используя метод `batch_update`.
5. Логирует успешную запись данных с помощью `logger.info`.
6. В случае возникновения ошибки, логирует сообщение об ошибке с использованием `logger.error` и поднимает исключение.

```
A: Получение листа 'campaign'
|
B: Подготовка данных для записи
|
C: Итерация по данным
|
D: Добавление операций обновления в список
|
E: Выполнение пакетного обновления
|
F: Логирование успешной записи
|
G: Обработка исключения (если возникло)
```

**Примеры**:

```python
from types import SimpleNamespace
campaign_data = SimpleNamespace(campaign_name='test_campaign', title='Test Campaign', language='ru', currency='USD', description='Test Description')
campaign_gsheet.set_campaign_worksheet(campaign_data)
```

### `set_products_worksheet`

```python
def set_products_worksheet(self, category_name: str):
```

**Назначение**: Запись данных о продуктах категории в лист Google Sheets.

**Параметры**:
- `category_name` (str): Название категории.

**Возвращает**: `None`

**Вызывает исключения**:
- `Exception` as `ex`: Логирует ошибку при записи данных в лист и поднимает исключение.

**Как работает функция**:
1. Проверяет наличие имени категории. Если имя категории не указано, функция логирует предупреждение и завершается.
2. Получает данные о категории и продуктах из атрибута `editor`.
3. Копирует лист 'product' и переименовывает его в название категории.
4. Итерируется по продуктам и подготавливает данные для записи в лист.
5. Обновляет лист данными о продуктах.
6. Форматирует лист с помощью метода `_format_category_products_worksheet`.
7. Логирует успешную запись данных с помощью `logger.info`.
8. В случае возникновения ошибки, логирует сообщение об ошибке с использованием `logger.error` и поднимает исключение.

```
A: Проверка наличия имени категории
|
B: Получение данных о категории и продуктах
|
C: Копирование листа 'product'
|
D: Итерация по продуктам
|
E: Подготовка данных для записи
|
F: Обновление листа данными о продуктах
|
G: Форматирование листа
|
H: Логирование успешной записи
|
I: Обработка исключения (если возникло)
```

**Примеры**:

```python
campaign_gsheet.set_products_worksheet(category_name='test_category')
```

### `set_categories_worksheet`

```python
def set_categories_worksheet(self, categories: SimpleNamespace):
```

**Назначение**: Запись данных о категориях в лист Google Sheets.

**Параметры**:
- `categories` (SimpleNamespace): Объект `SimpleNamespace` с данными о категориях.

**Возвращает**: `None`

**Вызывает исключения**:
- `Exception` as `ex`: Логирует ошибку при записи данных в лист и поднимает исключение.

**Как работает функция**:
1. Получает лист Google Sheets с названием 'categories'.
2. Очищает лист.
3. Получает данные о категориях из объекта `SimpleNamespace`.
4. Проверяет наличие необходимых атрибутов в каждом объекте категории.
5. Подготавливает заголовки для таблицы.
6. Итерируется по категориям и подготавливает данные для записи в лист.
7. Обновляет лист данными о категориях.
8. Форматирует лист с помощью метода `_format_categories_worksheet`.
9. Логирует успешную запись данных с помощью `logger.info`.
10. В случае возникновения ошибки, логирует сообщение об ошибке с использованием `logger.error` и поднимает исключение.

```
A: Получение листа 'categories'
|
B: Очистка листа
|
C: Получение данных о категориях
|
D: Проверка наличия необходимых атрибутов
|
E: Подготовка заголовков
|
F: Итерация по категориям
|
G: Подготовка данных для записи
|
H: Обновление листа данными о категориях
|
I: Форматирование листа
|
J: Логирование успешной записи
|
K: Обработка исключения (если возникло)
```

**Примеры**:

```python
from types import SimpleNamespace
category1 = SimpleNamespace(name='cat1', title='Category 1', description='Description 1', tags=['tag1', 'tag2'], products_count=10)
category2 = SimpleNamespace(name='cat2', title='Category 2', description='Description 2', tags=['tag3', 'tag4'], products_count=20)
categories_data = SimpleNamespace(cat1=category1, cat2=category2)
campaign_gsheet.set_categories_worksheet(categories_data)
```

### `get_categories`

```python
def get_categories(self):
```

**Назначение**: Получение данных о категориях из листа Google Sheets.

**Параметры**: Отсутствуют.

**Возвращает**:
- `data` (list[dict]): Данные о категориях в виде списка словарей.

**Вызывает исключения**: Отсутствуют явные исключения.

**Как работает функция**:
1. Получает лист Google Sheets с названием 'categories'.
2. Получает все записи из листа с помощью метода `get_all_records`.
3. Логирует успешное получение данных с помощью `logger.info`.
4. Возвращает данные.

```
A: Получение листа 'categories'
|
B: Получение всех записей из листа
|
C: Логирование успешного получения данных
|
D: Возврат данных
```

**Примеры**:

```python
categories = campaign_gsheet.get_categories()
print(categories)
```

### `set_category_products`

```python
def set_category_products(self, category_name: str, products: dict):
```

**Назначение**: Запись данных о продуктах категории в новый лист Google Sheets.

**Параметры**:
- `category_name` (str): Название категории.
- `products` (dict): Словарь с данными о продуктах.

**Возвращает**: `None`

**Вызывает исключения**:
- `Exception` as `ex`: Логирует ошибку при записи данных в лист и поднимает исключение.

**Как работает функция**:
1. Проверяет наличие имени категории. Если имя категории не указано, функция логирует предупреждение и завершается.
2. Получает данные о категории и продуктах из атрибута `editor`.
3. Копирует лист 'product' и переименовывает его в название категории.
4. Подготавливает заголовки для таблицы.
5. Итерируется по продуктам и подготавливает данные для записи в лист.
6. Обновляет лист данными о продуктах.
7. Форматирует лист с помощью метода `_format_category_products_worksheet`.
8. Логирует успешную запись данных с помощью `logger.info`.
9. В случае возникновения ошибки, логирует сообщение об ошибке с использованием `logger.error` и поднимает исключение.

```
A: Проверка наличия имени категории
|
B: Получение данных о категории и продуктах
|
C: Копирование листа 'product'
|
D: Подготовка заголовков
|
E: Итерация по продуктам
|
F: Подготовка данных для записи
|
G: Обновление листа данными о продуктах
|
H: Форматирование листа
|
I: Логирование успешной записи
|
J: Обработка исключения (если возникло)
```

**Примеры**:

```python
products_data = [{'product_id': 1, 'app_sale_price': 10.0, 'original_price': 15.0, 'sale_price': 12.0, 'discount': 0.2},
                 {'product_id': 2, 'app_sale_price': 20.0, 'original_price': 25.0, 'sale_price': 22.0, 'discount': 0.1}]
campaign_gsheet.set_category_products(category_name='test_category', products=products_data)
```

### `_format_categories_worksheet`

```python
def _format_categories_worksheet(self, ws: Worksheet):
```

**Назначение**: Форматирование листа 'categories' в Google Sheets.

**Параметры**:
- `ws` (Worksheet): Лист Google Sheets для форматирования.

**Возвращает**: `None`

**Вызывает исключения**:
- `Exception` as `ex`: Логирует ошибку при форматировании листа и поднимает исключение.

**Как работает функция**:
1. Устанавливает ширину столбцов.
2. Устанавливает высоту строк.
3. Форматирует заголовки, используя стили, такие как жирный шрифт, размер шрифта, выравнивание и цвет фона.
4. Применяет форматирование к диапазону ячеек заголовков.
5. Логирует успешное форматирование листа с помощью `logger.info`.
6. В случае возникновения ошибки, логирует сообщение об ошибке с использованием `logger.error` и поднимает исключение.

```
A: Установка ширины столбцов
|
B: Установка высоты строк
|
C: Форматирование заголовков
|
D: Применение форматирования к диапазону ячеек
|
E: Логирование успешного форматирования
|
F: Обработка исключения (если возникло)
```

**Примеры**:

```python
ws = campaign_gsheet.get_worksheet('categories')
campaign_gsheet._format_categories_worksheet(ws)
```

### `_format_category_products_worksheet`

```python
def _format_category_products_worksheet(self, ws: Worksheet):
```

**Назначение**: Форматирование листа с продуктами категории в Google Sheets.

**Параметры**:
- `ws` (Worksheet): Лист Google Sheets для форматирования.

**Возвращает**: `None`

**Вызывает исключения**:
- `Exception` as `ex`: Логирует ошибку при форматировании листа и поднимает исключение.

**Как работает функция**:
1. Устанавливает ширину столбцов.
2. Устанавливает высоту строк.
3. Форматирует заголовки, используя стили, такие как жирный шрифт, размер шрифта, выравнивание и цвет фона.
4. Применяет форматирование к диапазону ячеек заголовков.
5. Логирует успешное форматирование листа с помощью `logger.info`.
6. В случае возникновения ошибки, логирует сообщение об ошибке с использованием `logger.error` и поднимает исключение.

```
A: Установка ширины столбцов
|
B: Установка высоты строк
|
C: Форматирование заголовков
|
D: Применение форматирования к диапазону ячеек
|
E: Логирование успешного форматирования
|
F: Обработка исключения (если возникло)
```

**Примеры**:

```python
ws = campaign_gsheet.get_worksheet('test_category')
campaign_gsheet._format_category_products_worksheet(ws)
```