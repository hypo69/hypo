# Модуль `popup.js`

## Обзор

Этот файл JavaScript содержит код для всплывающего окна расширения. Он отвечает за обработку ввода данных пользователя, отправку запросов в активную вкладку, отображение результатов и управление взаимодействием с пользователем.

## Переменные

### `noneClass`, `helpClass`

Строковые константы, используемые для добавления/удаления класса `none` для элементов интерфейса.

### `invalidTabId`, `invalidExecutionId`, `invalidFrameId`

Константы, используемые для обозначения недействительных значений идентификаторов вкладок, исполнений и фреймов.

### `mainWay`, `mainExpression`, ...

Переменные, представляющие элементы DOM всплывающего окна, связанные с настройками поиска (путь, выражение, контекст и т.д.).

### `relatedTabId`, `relatedFrameId`, `executionId`

Переменные, хранящие информацию о текущей активной вкладке, фрейме и идентификаторе выполнения запроса.

### `resultedDetails`, `detailsPageSize`, `detailsPageIndex`

Переменные, связанные с результатами поиска. `resultedDetails` хранит детали результатов, `detailsPageSize` определяет размер страницы результатов, `detailsPageIndex` - текущая страница.


## Функции

### `sendToActiveTab(msg, opts)`

**Описание**: Отправляет сообщение в активную вкладку.

**Параметры**:

- `msg` (Object): Объект с сообщением для отправки.
- `opts` (Optional[Object], optional): Дополнительные параметры для отправки (например, `frameId`). По умолчанию `{}`.

**Возвращает**:

- `Promise`: Promise, который решает, когда сообщение будет отправлено.

**Вызывает исключения**:

- `browser.tabs.query` ошибки при поиске вкладок.
- `browser.tabs.sendMessage` ошибки при отправке сообщения.


### `sendToSpecifiedFrame(msg)`

**Описание**: Отправляет сообщение в указанный фрейм активной вкладки.

**Параметры**:

- `msg` (Object): Объект с сообщением для отправки.

**Возвращает**:

- `Promise`: Promise, который решает, когда сообщение будет отправлено.

**Вызывает исключения**:

- `Promise.reject` при ошибке при взаимодействии с фреймом.
- `showError` при возникновении ошибки (например, неправильный `frameId`).


### `collectPopupState()`

**Описание**: Собрать состояние всплывающего окна.

**Возвращает**:

- `Object`: Объект, содержащий состояние элементов интерфейса (чекбоксы, индексы, значения).

**Вызывает исключения**:

- Нет


### `changeContextVisible()`, `changeResolverVisible()`, `changeFrameIdVisible()`, `changeFrameDesignationVisible()`, `changeHelpVisible()`

**Описание**: Изменяют видимость соответствующих блоков на основе состояния чекбоксов.

**Параметры**:

- Нет

**Возвращает**:

- Нет

**Вызывает исключения**:

- Нет



### `makeExecuteMessage()`

**Описание**: Создает сообщение для выполнения запроса.

**Возвращает**:

- `Object`: Объект, содержащий данные запроса.

**Вызывает исключения**:

- Нет



### `getSpecifiedFrameId()`

**Описание**: Возвращает идентификатор выбранного фрейма.

**Возвращает**:

- `Number`: Идентификатор фрейма.

**Вызывает исключения**:

- Нет



### `execContentScript()`

**Описание**: Выполняет скрипты в активной вкладке.

**Возвращает**:

- `Promise`: Promise, который решает после выполнения скриптов.

**Вызывает исключения**:

- `browser.tabs.executeScript` ошибки при выполнении скриптов.



### `sendExecute()`

**Описание**: Отправляет сообщение для выполнения запроса в активную вкладку через указанный фрейм.


**Параметры**:

- Нет

**Возвращает**:

- Нет

**Вызывает исключения**:

- `sendToSpecifiedFrame` ошибки при отправке сообщения.



### `handleExprEnter(event)`

**Описание**: Обрабатывает нажатие Enter в поле ввода выражения.

**Параметры**:

- `event` (Event): Событие нажатия.

**Возвращает**:

- Нет

**Вызывает исключения**:

- Нет


### `showDetailsPage(index)`

**Описание**: Показывает определенную страницу результатов.

**Параметры**:

- `index` (Number): Индекс страницы результатов.

**Возвращает**:

- Нет

**Вызывает исключения**:

- `fu.onError` ошибки при обновлении таблицы результатов.


### `showError(message, frameId)`

**Описание**: Показывает сообщение об ошибке в всплывающем окне.

**Параметры**:

- `message` (string): Сообщение об ошибке.
- `frameId` (string): Идентификатор фрейма, связанный с ошибкой.

**Возвращает**:

- Нет

**Вызывает исключения**:

- `fu.onError` ошибки при обновлении таблицы результатов.


### `genericListener(message, sender, sendResponse)`

**Описание**: Обработчик событий, отправленных из содержимого страницы.

**Параметры**:

- `message` (Object): Объект с сообщением.
- `sender` (Object): Объект, от которого получено сообщение.
- `sendResponse` (function): Функция для отправки ответа.


**Возвращает**:

- `Boolean`: `true`, если обработчик продолжает обработку, `false` - если нет.

**Вызывает исключения**:

- Нет


### Другие функции (менее подробные):

Остальные функции (например, `genericListener.listeners.*`) описывают обработчики конкретных сообщений. Их поведение аналогично обработчикам сообщений.  В целом они обеспечивают взаимодействие между расширением и активной вкладкой.


## События

Функции реагируют на различные события, такие как нажатия кнопок, ввод текста и загрузки.  Эти события вызывают функции для обновления состояния и отправки сообщений в активную вкладку.


## Заключение

Этот модуль обеспечивает сложную функциональность для обработки запросов XPath, отображения результатов в всплывающем окне и взаимодействия с активной вкладкой.