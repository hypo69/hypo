# Модуль для экспериментов с OpenAI

## Обзор

Модуль предназначен для экспериментов с моделью AI OpenAI. Он обрабатывает исходный код или документацию, отправляет его в модель для анализа и получения ответов. Основная цель - автоматическое создание документации для проектов.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для автоматизации процесса создания документации с использованием модели OpenAI GPT-4. Модуль позволяет обрабатывать исходный код и генерировать документацию в формате Markdown, что упрощает поддержку и понимание проекта. Внутри модуля определены функции для чтения файлов, взаимодействия с моделью OpenAI и сохранения сгенерированной документации.

## Функции

### `main`

```python
def main() -> None:
    """ Main function to process files and interact with the model.

    This function reads a comment file, iterates over specified files in the source directory,
    and sends the file content to a model for analysis. It then processes the model's response.
    """
```

**Как работает функция**:

Функция `main` является основной точкой входа для обработки файлов и взаимодействия с моделью OpenAI. Она выполняет следующие шаги:

1.  Определяет роль выполнения, установленную внутри кода (по умолчанию `doc_writer`).
2.  Читает комментарий для модели и системные инструкции из файлов Markdown.
3.  Инициализирует модель OpenAI с использованием системных инструкций, имени модели и ID ассистента.
4.  Итерируется по файлам в исходной директории, соответствующим указанным шаблонам (`*.py`, `README.MD`).
5.  Для каждого файла формирует входной контент для модели, включающий комментарий, расположение файла, роль выполнения и содержимое файла.
6.  Отправляет контент в модель OpenAI и получает ответ.
7.  Сохраняет ответ модели в файл Markdown с использованием функции `save_response`.
8.  Обрабатывает возможные исключения, логируя их с использованием `logger.error`.
9.  Приостанавливает выполнение на 20 секунд для предотвращения превышения лимитов API.

**Параметры**:

-   Нет параметров.

**Возвращает**:

-   `None`

**Вызывает исключения**:

-   `Exception`: В случае ошибки при взаимодействии с моделью OpenAI или сохранении ответа.

### `save_response`

```python
def save_response(file_path: Path, response: str, from_model: str) -> None:
    """ Save the model's response to a markdown file with updated path based on role.

    Args:
        file_path (Path): The original file path being processed.
        response (str): The response from the model to be saved.
    """
```

**Как работает функция**:

Функция `save_response` сохраняет ответ модели в файл Markdown с обновленным путем, основанным на роли выполнения. Она выполняет следующие шаги:

1.  Определяет директорию для сохранения файла на основе роли (например, `docs/openai/raw_rst_from_ai` для роли `doc_writer`).
2.  Формирует новый путь к файлу, заменяя часть пути `src` на директорию, соответствующую роли.
3.  Изменяет суффикс файла на `.md`.
4.  Создает директорию для сохранения файла, если она не существует.
5.  Сохраняет ответ модели в новый файл с кодировкой UTF-8.
6.  Выводит сообщение в консоль с путем к сохраненному файлу.

**Параметры**:

-   `file_path` (Path): Исходный путь к обрабатываемому файлу.
-   `response` (str): Ответ от модели, который нужно сохранить.
-   `from_model` (str): Имя модели, от которой получен ответ (например, 'openai').

**Возвращает**:

-   `None`

**Вызывает исключения**:

-   `OSError`: В случае ошибки при создании директории или сохранении файла.

### `yield_files_content`

```python
def yield_files_content(
    src_path: Path, patterns: list[str]
) -> Iterator[tuple[Path, str]]:
    """ Yield file content based on patterns from the source directory, excluding certain patterns and directories.

    Args:
        src_path (Path): The base directory to search for files.
        patterns (list[str]): List of file patterns to include (e.g., [\'*.py\', \'*.txt\']).

    Yields:
        Iterator[tuple[Path, str]]: A tuple of file path and its content as a string.
    """
```

**Как работает функция**:

Функция `yield_files_content` генерирует содержимое файлов, соответствующих указанным шаблонам, из исходной директории, исключая определенные шаблоны и директории. Она выполняет следующие шаги:

1.  Определяет регулярные выражения для исключаемых файлов и директорий (например, файлы и директории, содержащие круглые скобки, или начинающиеся с трех и более подчеркиваний).
2.  Определяет список служебных директорий, которые необходимо исключить (например, `.ipynb_checkpoints`, `_experiments`, `__pycache__`, `.git`, `.venv`).
3.  Итерируется по шаблонам файлов.
4.  Для каждого шаблона итерируется по файлам в исходной директории, соответствующим шаблону.
5.  Пропускает файлы, находящиеся в исключаемых директориях.
6.  Пропускает файлы, соответствующие исключаемым шаблонам.
7.  Читает содержимое файла с кодировкой UTF-8.
8.  Генерирует кортеж, содержащий путь к файлу и его содержимое.

**Параметры**:

-   `src_path` (Path): Базовая директория для поиска файлов.
-   `patterns` (list[str]): Список шаблонов файлов для включения (например, `['*.py', '*.txt']`).

**Возвращает**:

-   `Iterator[tuple[Path, str]]`: Итератор, генерирующий кортежи, содержащие путь к файлу и его содержимое в виде строки.

## Переменные

-   `role` (str): Глобальная переменная, определяющая роль выполнения (по умолчанию `'doc_writer'`).
-   `openai_model_name` (str): Имя используемой модели OpenAI (по умолчанию `'gpt-4o-mini'`).
-   `openai_assistant_id` (str): ID ассистента OpenAI, используемого для обработки кода (берется из `gs.credentials.openai.assistant_id.code_assistant`).
-   `openai_model` (OpenAIModel): Экземпляр класса `OpenAIModel`, используемый для взаимодействия с моделью OpenAI.

## Использование

Пример использования модуля:

```python
if __name__ == "__main__":
    print("Starting training ...")
    main()
```

В данном примере функция `main` вызывается при запуске скрипта, что инициирует процесс обработки файлов и генерации документации с использованием модели OpenAI.