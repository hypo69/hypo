# Модуль `web_search`

## Обзор

Модуль `web_search` предназначен для выполнения веб-поиска и извлечения информации из результатов поиска. Он использует библиотеку `duckduckgo-search` для выполнения поисковых запросов и `BeautifulSoup4` для извлечения текста из HTML-страниц. Модуль предоставляет функции для поиска, сбора и форматирования результатов, а также для кэширования результатов поиска.

## Подробнее

Модуль предоставляет функциональность для интеграции веб-поиска в другие части проекта `hypotez`. Он позволяет выполнять поисковые запросы, извлекать текст из веб-страниц и форматировать результаты для дальнейшего использования. Модуль также включает в себя механизмы кэширования для повышения производительности и снижения нагрузки на поисковые системы.

## Содержание

- [Классы](#классы)
  - [SearchResults](#searchresults)
  - [SearchResultEntry](#searchresultentry)
- [Функции](#функции)
  - [scrape_text](#scrape_text)
  - [fetch_and_scrape](#fetch_and_scrape)
  - [search](#search)
  - [do_search](#do_search)
  - [get_search_message](#get_search_message)
  - [spacy_get_keywords](#spacy_get_keywords)

## Классы

### `SearchResults`

**Описание**: Класс `SearchResults` представляет собой контейнер для хранения результатов веб-поиска.

**Атрибуты**:

- `results` (list): Список объектов `SearchResultEntry`, представляющих отдельные результаты поиска.
- `used_words` (int): Количество слов, использованных в результатах поиска.

**Методы**:

- `from_dict(cls, data: dict)`: Создает экземпляр класса `SearchResults` из словаря.
- `__iter__(self)`: Возвращает итератор по результатам поиска.
- `__str__(self)`: Возвращает строковое представление результатов поиска.
- `__len__(self) -> int`: Возвращает количество результатов поиска.
- `get_sources(self) -> Sources`: Возвращает объект `Sources`, содержащий URL-адреса и заголовки результатов поиска.
- `get_dict(self)`: Возвращает словарь, представляющий объект `SearchResults`.

### `SearchResultEntry`

**Описание**: Класс `SearchResultEntry` представляет собой отдельный результат веб-поиска.

**Атрибуты**:

- `title` (str): Заголовок результата поиска.
- `url` (str): URL-адрес результата поиска.
- `snippet` (str): Краткое описание результата поиска (сниппет).
- `text` (str, optional): Полный текст, извлеченный из веб-страницы (по умолчанию `None`).

**Методы**:

- `set_text(self, text: str)`: Устанавливает полный текст результата поиска.
- `get_dict(self)`: Возвращает словарь, представляющий объект `SearchResultEntry`.

## Функции

### `scrape_text`

```python
def scrape_text(html: str, max_words: int = None, add_source=True, count_images: int = 2) -> Iterator[str]:
    """
    Извлекает текст из HTML-кода, удаляя лишние элементы и форматируя результат.

    Args:
        html (str): HTML-код для извлечения текста.
        max_words (int, optional): Максимальное количество слов для извлечения. По умолчанию `None` (без ограничений).
        add_source (bool, optional): Добавлять ли информацию об источнике в конце извлеченного текста. По умолчанию `True`.
        count_images (int, optional): Максимальное количество изображений для включения в результат. По умолчанию `2`.

    Returns:
        Iterator[str]: Итератор по извлеченным текстовым фрагментам.
    """
    ...
```

**Назначение**: Извлекает текст из HTML-кода, удаляя лишние элементы и форматируя результат.

**Параметры**:

- `html` (str): HTML-код для извлечения текста.
- `max_words` (int, optional): Максимальное количество слов для извлечения. По умолчанию `None` (без ограничений).
- `add_source (bool, optional): Добавлять ли информацию об источнике в конце извлеченного текста. По умолчанию `True`.
- `count_images (int, optional): Максимальное количество изображений для включения в результат. По умолчанию `2`.

**Возвращает**:

- `Iterator[str]`: Итератор по извлеченным текстовым фрагментам.

**Как работает функция**:

1.  **Инициализация**: Функция принимает HTML-код, максимальное количество слов для извлечения, флаг для добавления источника и максимальное количество изображений для включения.
2.  **Разбор HTML**: Использует `BeautifulSoup` для разбора HTML-кода.
3.  **Удаление лишних элементов**: Пытается найти и удалить определенные селекторы, такие как ".c-globalDisclosure" (Zdnet).
4.  **Извлечение текста**: Извлекает текст из различных элементов HTML, таких как заголовки, параграфы, таблицы и списки.
5.  **Обработка изображений**: Если `count_images` больше 0, функция ищет изображения с атрибутом `alt` и включает их в результат.
6.  **Форматирование текста**: Разделяет текст на строки и удаляет пустые строки.
7.  **Ограничение по количеству слов**: Если `max_words` указан, функция ограничивает количество извлеченных слов.
8.  **Добавление источника**: Если `add_source` равен `True`, функция добавляет информацию об источнике в конце извлеченного текста.

**ASCII flowchart**:

```
A: Разбор HTML
|
B: Удаление лишних элементов
|
C: Извлечение текста из элементов
|
D: Обработка изображений
|
E: Форматирование текста
|
F: Ограничение по количеству слов
|
G: Добавление источника
```

**Примеры**:

```python
html = "<html><body><h1>Заголовок</h1><p>Текст параграфа.</p></body></html>"
text_fragments = scrape_text(html, max_words=10)
for fragment in text_fragments:
    print(fragment)
```

### `fetch_and_scrape`

```python
async def fetch_and_scrape(session: ClientSession, url: str, max_words: int = None, add_source: bool = False) -> str:
    """
    Асинхронно получает HTML-код по URL и извлекает из него текст.

    Args:
        session (ClientSession): Асинхронная HTTP-сессия.
        url (str): URL-адрес для получения HTML-кода.
        max_words (int, optional): Максимальное количество слов для извлечения. По умолчанию `None` (без ограничений).
        add_source (bool, optional): Добавлять ли информацию об источнике в конце извлеченного текста. По умолчанию `False`.

    Returns:
        str: Извлеченный текст или `None` в случае ошибки.
    """
    ...
```

**Назначение**: Асинхронно получает HTML-код по URL и извлекает из него текст.

**Параметры**:

- `session` (ClientSession): Асинхронная HTTP-сессия.
- `url` (str): URL-адрес для получения HTML-кода.
- `max_words` (int, optional): Максимальное количество слов для извлечения. По умолчанию `None` (без ограничений).
- `add_source (bool, optional): Добавлять ли информацию об источнике в конце извлеченного текста. По умолчанию `False`.

**Возвращает**:

- `str`: Извлеченный текст или `None` в случае ошибки.

**Как работает функция**:

1.  **Кэширование**: Функция проверяет наличие кэшированного файла для данного URL-адреса. Если файл существует, функция возвращает его содержимое.
2.  **Получение HTML**: Если кэшированный файл не существует, функция выполняет HTTP-запрос для получения HTML-кода по указанному URL-адресу.
3.  **Извлечение текста**: Использует функцию `scrape_text` для извлечения текста из HTML-кода.
4.  **Кэширование результата**: Сохраняет извлеченный текст в кэш-файл.
5.  **Обработка ошибок**: В случае возникновения ошибок (например, `ClientError`, `asyncio.TimeoutError`), функция возвращает `None`.

**ASCII flowchart**:

```
A: Проверка кэша
|
B: HTTP-запрос
|
C: Извлечение текста (scrape_text)
|
D: Кэширование результата
|
E: Обработка ошибок
```

**Примеры**:

```python
import asyncio
from aiohttp import ClientSession

async def main():
    async with ClientSession() as session:
        url = "https://www.example.com"
        text = await fetch_and_scrape(session, url, max_words=100)
        if text:
            print(text)

asyncio.run(main())
```

### `search`

```python
async def search(query: str, max_results: int = 5, max_words: int = 2500, backend: str = "auto", add_text: bool = True, timeout: int = 5, region: str = "wt-wt") -> SearchResults:
    """
    Выполняет поиск в DuckDuckGo и возвращает результаты.

    Args:
        query (str): Поисковый запрос.
        max_results (int, optional): Максимальное количество результатов для возврата. По умолчанию `5`.
        max_words (int, optional): Максимальное количество слов для извлечения из каждой страницы. По умолчанию `2500`.
        backend (str, optional): Бэкенд для использования в DuckDuckGo Search. По умолчанию `"auto"`.
        add_text (bool, optional): Извлекать ли полный текст из каждой страницы. По умолчанию `True`.
        timeout (int, optional): Время ожидания HTTP-запроса в секундах. По умолчанию `5`.
        region (str, optional): Регион поиска. По умолчанию `"wt-wt"`.

    Returns:
        SearchResults: Объект `SearchResults`, содержащий результаты поиска.

    Raises:
        MissingRequirementsError: Если не установлены необходимые библиотеки (`duckduckgo-search`, `beautifulsoup4`).
    """
    ...
```

**Назначение**: Выполняет поиск в DuckDuckGo и возвращает результаты.

**Параметры**:

- `query` (str): Поисковый запрос.
- `max_results` (int, optional): Максимальное количество результатов для возврата. По умолчанию `5`.
- `max_words` (int, optional): Максимальное количество слов для извлечения из каждой страницы. По умолчанию `2500`.
- `backend (str, optional): Бэкенд для использования в DuckDuckGo Search. По умолчанию `"auto"`.
- `add_text (bool, optional): Извлекать ли полный текст из каждой страницы. По умолчанию `True`.
- `timeout (int, optional): Время ожидания HTTP-запроса в секундах. По умолчанию `5`.
- `region (str, optional): Регион поиска. По умолчанию `"wt-wt"`.

**Возвращает**:

- `SearchResults`: Объект `SearchResults`, содержащий результаты поиска.

**Вызывает исключения**:

- `MissingRequirementsError`: Если не установлены необходимые библиотеки (`duckduckgo-search`, `beautifulsoup4`).

**Как работает функция**:

1.  **Проверка зависимостей**: Функция проверяет, установлены ли необходимые библиотеки (`duckduckgo-search`, `beautifulsoup4`). Если библиотеки не установлены, функция вызывает исключение `MissingRequirementsError`.
2.  **Выполнение поиска**: Использует библиотеку `duckduckgo-search` для выполнения поискового запроса.
3.  **Формирование результатов**: Создает список объектов `SearchResultEntry` на основе результатов поиска.
4.  **Извлечение текста**: Если `add_text` равен `True`, функция использует `aiohttp` для асинхронного извлечения текста из каждой страницы.
5.  **Форматирование результатов**: Форматирует результаты поиска и ограничивает количество слов, использованных в результатах.
6.  **Возврат результатов**: Возвращает объект `SearchResults`, содержащий отформатированные результаты поиска.

**ASCII flowchart**:

```
A: Проверка зависимостей
|
B: Выполнение поиска (duckduckgo-search)
|
C: Формирование результатов (SearchResultEntry)
|
D: Извлечение текста (aiohttp, fetch_and_scrape)
|
E: Форматирование результатов
|
F: Возврат результатов (SearchResults)
```

**Примеры**:

```python
import asyncio

async def main():
    results = await search("python programming", max_results=3, max_words=500)
    for result in results:
        print(f"Title: {result.title}")
        print(f"URL: {result.url}")
        print(f"Snippet: {result.snippet}")
        if result.text:
            print(f"Text: {result.text[:100]}...")

asyncio.run(main())
```

### `do_search`

```python
async def do_search(prompt: str, query: str = None, instructions: str = DEFAULT_INSTRUCTIONS, **kwargs) -> tuple[str, Sources]:
    """
    Выполняет поиск и форматирует результаты для использования в запросах к языковой модели.

    Args:
        prompt (str): Исходный запрос пользователя.
        query (str, optional): Поисковый запрос. Если не указан, используется первая строка `prompt`. По умолчанию `None`.
        instructions (str, optional): Инструкции для форматирования результатов поиска. По умолчанию `DEFAULT_INSTRUCTIONS`.
        **kwargs: Дополнительные параметры для функции `search`.

    Returns:
        tuple[str, Sources]: Кортеж, содержащий отформатированный запрос и объект `Sources` с информацией об источниках.
    """
    ...
```

**Назначение**: Выполняет поиск и форматирует результаты для использования в запросах к языковой модели.

**Параметры**:

- `prompt` (str): Исходный запрос пользователя.
- `query` (str, optional): Поисковый запрос. Если не указан, используется первая строка `prompt`. По умолчанию `None`.
- `instructions (str, optional): Инструкции для форматирования результатов поиска. По умолчанию `DEFAULT_INSTRUCTIONS`.
- `**kwargs`: Дополнительные параметры для функции `search`.

**Возвращает**:

- `tuple[str, Sources]`: Кортеж, содержащий отформатированный запрос и объект `Sources` с информацией об источниках.

**Как работает функция**:

1.  **Проверка наличия инструкций**: Если инструкции уже добавлены в запрос, функция возвращает исходный запрос.
2.  **Определение поискового запроса**: Если поисковый запрос не указан, функция использует первую строку `prompt` в качестве запроса.
3.  **Кэширование**: Функция проверяет наличие кэшированного файла для данного запроса. Если файл существует, функция возвращает его содержимое.
4.  **Выполнение поиска**: Если кэшированный файл не существует, функция выполняет поиск с использованием функции `search`.
5.  **Форматирование результатов**: Форматирует результаты поиска в соответствии с инструкциями.
6.  **Кэширование результата**: Сохраняет отформатированные результаты в кэш-файл.
7.  **Возврат результатов**: Возвращает кортеж, содержащий отформатированный запрос и объект `Sources` с информацией об источниках.

**ASCII flowchart**:

```
A: Проверка наличия инструкций
|
B: Определение поискового запроса
|
C: Проверка кэша
|
D: Выполнение поиска (search)
|
E: Форматирование результатов
|
F: Кэширование результата
|
G: Возврат результатов
```

**Примеры**:

```python
import asyncio

async def main():
    prompt = "What is python programming?"
    formatted_prompt, sources = await do_search(prompt, max_results=3, max_words=500)
    print(formatted_prompt)
    if sources:
        for source in sources:
            print(f"Source: {source['url']}")

asyncio.run(main())
```

### `get_search_message`

```python
def get_search_message(prompt: str, raise_search_exceptions=False, **kwargs) -> str:
    """
    Выполняет поиск и возвращает отформатированный запрос.

    Args:
        prompt (str): Исходный запрос пользователя.
        raise_search_exceptions (bool, optional): Вызывать ли исключения, возникающие во время поиска. По умолчанию `False`.
        **kwargs: Дополнительные параметры для функции `do_search`.

    Returns:
        str: Отформатированный запрос.
    """
    ...
```

**Назначение**: Выполняет поиск и возвращает отформатированный запрос.

**Параметры**:

- `prompt` (str): Исходный запрос пользователя.
- `raise_search_exceptions (bool, optional): Вызывать ли исключения, возникающие во время поиска. По умолчанию `False`.
- `**kwargs`: Дополнительные параметры для функции `do_search`.

**Возвращает**:

- `str`: Отформатированный запрос.

**Как работает функция**:

1.  **Выполнение поиска**: Функция вызывает функцию `do_search` для выполнения поиска и форматирования результатов.
2.  **Обработка ошибок**: В случае возникновения исключений (`DuckDuckGoSearchException`, `MissingRequirementsError`), функция перехватывает их и возвращает исходный запрос.
3.  **Возврат результата**: Возвращает отформатированный запрос.

**ASCII flowchart**:

```
A: Выполнение поиска (do_search)
|
B: Обработка ошибок
|
C: Возврат результата
```

**Примеры**:

```python
prompt = "What is python programming?"
formatted_prompt = get_search_message(prompt, max_results=3, max_words=500)
print(formatted_prompt)
```

### `spacy_get_keywords`

```python
def spacy_get_keywords(text: str):
    """
    Извлекает ключевые слова из текста с использованием библиотеки spaCy.

    Args:
        text (str): Текст для извлечения ключевых слов.

    Returns:
        list: Список ключевых слов.
    """
    ...
```

**Назначение**: Извлекает ключевые слова из текста с использованием библиотеки spaCy.

**Параметры**:

-   `text` (str): Текст для извлечения ключевых слов.

**Возвращает**:

*   `list`: Список ключевых слов.

**Как работает функция**:

1.  **Проверка наличия spaCy**: Функция проверяет, установлена ли библиотека `spaCy`. Если библиотека не установлена, функция возвращает исходный текст.
2.  **Загрузка языковой модели**: Загружает языковую модель `en_core_web_sm` из библиотеки `spaCy`.
3.  **Обработка текста**: Использует загруженную языковую модель для обработки текста.
4.  **Извлечение ключевых слов**: Извлекает ключевые слова на основе частей речи (существительные, прилагательные) и именованных сущностей.
5.  **Удаление дубликатов**: Удаляет дубликаты из списка ключевых слов.
6.  **Возврат результата**: Возвращает список ключевых слов.

**ASCII flowchart**:

```
A: Проверка наличия spaCy
|
B: Загрузка языковой модели
|
C: Обработка текста
|
D: Извлечение ключевых слов
|
E: Удаление дубликатов
|
F: Возврат результата
```

**Примеры**:

```python
text = "Python is a high-level, general-purpose programming language."
keywords = spacy_get_keywords(text)
print(keywords)