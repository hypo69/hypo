# Модуль `GPTalk`

## Обзор

Модуль `GPTalk` предоставляет асинхронный интерфейс для взаимодействия с сервисом GPTalk для генерации текста. Он использует `aiohttp` для асинхронных HTTP-запросов и поддерживает прокси. Модуль предназначен для работы с моделью `gpt-3.5-turbo` и может быть использован как асинхронный генератор.

## Подробней

Модуль `GPTalk` является устаревшим провайдером (deprecated) в рамках проекта `hypotez`, что означает, что его поддержка может быть прекращена в будущем. Он реализует взаимодействие с API GPTalk, требующее авторизации пользователя. Авторизационные данные хранятся в классе и обновляются при необходимости. Для отправки запросов используется асинхронный клиент `aiohttp.ClientSession`.

## Классы

### `GPTalk`

**Описание**: Класс `GPTalk` предоставляет функциональность для генерации текста с использованием сервиса GPTalk.
   **Принцип работы**:
    Класс `GPTalk` является подклассом `AsyncGeneratorProvider` и предназначен для взаимодействия с API GPTalk. Он реализует механизм авторизации, который обновляется при истечении срока действия или после определенного количества использований. Основной метод `create_async_generator` отправляет запросы к API GPTalk и возвращает асинхронный генератор, который выдает сгенерированный текст по частям.

**Наследует**:
- `AsyncGeneratorProvider`: Этот класс, вероятно, предоставляет базовую функциональность для асинхронных провайдеров, таких как управление сессиями и обработка ошибок.

**Атрибуты**:
- `url` (str): URL сервиса GPTalk (`https://gptalk.net`).
- `working` (bool): Флаг, указывающий, работает ли провайдер (по умолчанию `False`).
- `supports_gpt_35_turbo` (bool): Флаг, указывающий, поддерживает ли провайдер модель `gpt-3.5-turbo` (по умолчанию `True`).
- `_auth` (Optional[dict]): Словарь, содержащий данные авторизации (токен и время истечения срока действия).
- `used_times` (int): Счетчик использований авторизационных данных.

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения текстовых ответов от GPTalk.

    Args:
        model (str): Имя модели для использования (по умолчанию "gpt-3.5-turbo").
        messages (Messages): Список сообщений для отправки в GPTalk.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий текстовые ответы от GPTalk.

    Raises:
        Exception: Если возникает ошибка при выполнении запроса к GPTalk.
    """
```

**Назначение**: Метод `create_async_generator` создает и возвращает асинхронный генератор, который позволяет получать текстовые ответы от API GPTalk в асинхронном режиме.

**Параметры**:
- `cls` (class): Ссылка на класс `GPTalk`.
- `model` (str): Имя модели, которую следует использовать для генерации текста. Если не указана, используется модель `"gpt-3.5-turbo"`.
- `messages` (Messages): Список сообщений, которые будут отправлены в API GPTalk для получения ответа.
- `proxy` (str, optional): URL прокси-сервера, который будет использоваться для подключения к API GPTalk. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API GPTalk.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который при итерации выдает текстовые фрагменты ответа от API GPTalk.

**Вызывает исключения**:
- `aiohttp.ClientResponseError`: Если HTTP-ответ содержит код ошибки.
- `Exception`: В случае других ошибок при взаимодействии с API GPTalk.

**Как работает функция**:

1. **Инициализация**:
   - Определяется модель, если она не была передана.
   - Формируются заголовки запроса, включающие timestamp.

2. **Авторизация**:
   - Проверяется, требуется ли обновление токена авторизации. Это необходимо, если токен отсутствует, истек или превышено количество использований.
   - Если требуется обновление, выполняется запрос к `/api/chatgpt/user/login` для получения нового токена.

3. **Формирование данных запроса**:
   - Формируется JSON-payload с сообщением, моделью и другими параметрами.
   - Обновляются заголовки запроса, добавляется токен авторизации.

4. **Отправка запроса и получение ответа**:
   - Отправляется POST-запрос к `/api/chatgpt/chatapi/text` для запуска генерации текста.
   - Получается токен для стриминга.

5. **Получение стримингового ответа**:
   - Отправляется GET-запрос к `/api/chatgpt/chatapi/stream` для получения стримингового ответа.
   - Полученные данные обрабатываются построчно, извлекается содержимое сообщения и передается в генератор.

6. **Завершение**:
   - Генератор завершается при получении сообщения `data: [DONE]`.

**Внутренние функции**:
- Внутри этой функции нет внутренних функций.

**Примеры**:

```python
import asyncio
from typing import List, Dict, AsyncGenerator

from src.endpoints.gpt4free.g4f.Provider.deprecated.GPTalk import GPTalk

async def main():
    messages: List[Dict[str, str]] = [{"role": "user", "content": "Hello, how are you?"}]
    model: str = "gpt-3.5-turbo"

    generator: AsyncGenerator[str, None] = GPTalk.create_async_generator(model=model, messages=messages)

    async for message in generator:
        print(message, end="")

if __name__ == "__main__":
    asyncio.run(main())
```

**ASCII flowchart**:

```
+-------------------------+
|      Начало             |
+-------------------------+
|       Определение       |
|       параметров        |
+-------------------------+
|  Проверка необходимости |
|    обновления токена    |
+-------------------------+
|       Обновление        |
|       авторизации       |
+-------------------------+
|   Формирование данных   |
|       запроса           |
+-------------------------+
|    Отправка запроса     |
|  /api/chatgpt/chatapi/text|
+-------------------------+
|  Получение токена для   |
|       стриминга         |
+-------------------------+
|    Отправка запроса     |
| /api/chatgpt/chatapi/stream|
+-------------------------+
|   Обработка стриминга   |
|       ответа            |
+-------------------------+
|      Завершение         |
+-------------------------+