# Модуль `Myshell`

## Обзор

Модуль предоставляет асинхронный класс `Myshell`, который используется для взаимодействия с API Myshell AI. Он позволяет генерировать ответы от различных моделей, включая "samantha", "gpt-3.5-turbo" и "gpt-4". Модуль использует вебсокеты для асинхронной связи с сервером Myshell AI.

## Подробней

Этот модуль является частью устаревшего кода `gpt4free` и, вероятно, требует пересмотра и обновления для соответствия текущим стандартам проекта `hypotez`. Он обеспечивает интеграцию с API Myshell AI, используя вебсокеты для отправки запросов и получения ответов в режиме реального времени.

## Классы

### `Myshell`

**Описание**:
Асинхронный провайдер для взаимодействия с API Myshell AI.

**Принцип работы**:
Класс `Myshell` наследует `AsyncGeneratorProvider` и реализует метод `create_async_generator`, который устанавливает соединение через вебсокет с сервером Myshell AI, отправляет запросы и асинхронно генерирует ответы. Он поддерживает модели "samantha", "gpt-3.5-turbo" и "gpt-4".

**Атрибуты**:
- `url` (str): URL для чата Myshell AI.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель "gpt-3.5-turbo".
- `supports_gpt_4` (bool): Указывает, поддерживает ли провайдер модель "gpt-4".

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для взаимодействия с API Myshell AI.

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        timeout: int = 90,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для взаимодействия с API Myshell AI.

        Args:
            model (str): Название модели для использования ("samantha", "gpt-3.5-turbo", "gpt-4").
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            timeout (int, optional): Время ожидания соединения в секундах. По умолчанию `90`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, выдающий ответы от API.

        Raises:
            ValueError: Если указанная модель не поддерживается.
            RuntimeError: Если получен неожиданный тип сообщения от сервера.
        """
```

**Назначение**:
Метод `create_async_generator` создает и возвращает асинхронный генератор, который взаимодействует с API Myshell AI для получения ответов на основе предоставленных сообщений.

**Параметры**:
- `model` (str): Название модели, которую нужно использовать. Допустимые значения: "samantha", "gpt-3.5-turbo", "gpt-4".
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): URL прокси-сервера, если необходимо использовать прокси. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания для установки соединения и получения ответов в секундах. По умолчанию `90`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который выдает ответы от API Myshell AI.

**Вызывает исключения**:
- `ValueError`: Вызывается, если указанная модель не поддерживается (т.е. отсутствует в словаре `models`).
- `RuntimeError`: Вызывается, если получен неожиданный тип сообщения от сервера (например, "message_replied" или "need_verify_captcha").

**Как работает функция**:

1. **Выбор bot_id**: Определяет `bot_id` на основе указанной модели. Если модель не указана, используется "samantha". Если модель не поддерживается, вызывается исключение `ValueError`.
2. **Генерация идентификатора посетителя**: Генерирует `visitor_id` с использованием функции `generate_visitor_id`.
3. **Установка соединения через вебсокет**:
   - Создается асинхронная сессия с использованием `aiohttp.ClientSession`.
   - Устанавливается вебсокет-соединение с сервером Myshell AI.
   - Отправляется и принимается приветственное сообщение.
   - Отправляется сообщение с идентификатором посетителя.
   - Ожидается 5 секунд для решения проблемы с "need_verify_captcha".
4. **Формирование и отправка сообщения**:
   - Форматируется текст сообщения с использованием `format_prompt(messages)`.
   - Создается JSON-представление данных чата, включая текст сообщения, `botUid`, `reqId` и сгенерированную подпись.
   - Отправляется сообщение чата на сервер.
5. **Прием и обработка сообщений**:
   - Цикл `async for message in wss`: Получает сообщения от сервера через вебсокет.
   - Если тип сообщения не `WSMsgType.TEXT`, сообщение игнорируется.
   - Если сообщение является пингом ("2"), отправляется ответ ("3").
   - Если сообщение не начинается с `chat_start`, оно игнорируется.
   - Извлекается тип данных и данные из сообщения.
   - Если тип данных `text_stream`, извлекается текст и выдается через `yield`. Если `isFinal` установлен в `True`, цикл завершается.
   - Если тип данных `message_replied` или `need_verify_captcha`, вызывается исключение `RuntimeError`.

**ASCII flowchart**:

```
    [Начало]
        ↓
    [Определение bot_id]
        ↓
    [Генерация visitor_id]
        ↓
    [Установка WebSocket соединения]
        ↓
    [Отправка приветственного сообщения]
        ↓
    [Отправка сообщения с visitor_id]
        ↓
    [Формирование сообщения чата]
        ↓
    [Отправка сообщения чата]
        ↓
    [Прием сообщений из WebSocket]
        │
        ├──→ [Проверка типа сообщения]
        │     │
        │     └──→ [Обработка пинга]
        │     │
        │     └──→ [Обработка text_stream]
        │           │
        │           └──→ [Выдача текста через yield]
        │           │
        │           └──→ [Проверка isFinal]
        │                 ↓
        │                 [Завершение цикла]
        │
        └──→ [Обработка ошибок (message_replied, need_verify_captcha)]
              ↓
              [Вызов исключения RuntimeError]
```

**Примеры**:

```python
# Пример использования с моделью gpt-3.5-turbo
async def main():
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    async for message in Myshell.create_async_generator(model="gpt-3.5-turbo", messages=messages):
        print(message, end="")

import asyncio
asyncio.run(main())

# Пример использования с прокси-сервером
async def main():
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    async for message in Myshell.create_async_generator(model="gpt-3.5-turbo", messages=messages, proxy="http://your_proxy:8080"):
        print(message, end="")

import asyncio
asyncio.run(main())
```

## Функции

### `generate_timestamp`

```python
def generate_timestamp() -> str:
    """
    Генерирует временную метку в определенном формате.

    Returns:
        str: Сгенерированная временная метка.
    """
```

**Назначение**:
Функция `generate_timestamp` генерирует временную метку, которая используется для подписи запросов к API Myshell AI.

**Возвращает**:
- `str`: Временная метка в виде строки.

**Как работает функция**:

1. **Получение текущего времени**: Получает текущее время в миллисекундах с помощью `time.time() * 1000` и преобразует его в целое число.
2. **Удаление последней цифры**: Преобразует время в строку и удаляет последнюю цифру.
3. **Вычисление контрольной суммы**: Вычисляет контрольную сумму на основе цифр временной метки. Каждая четная цифра умножается на 2, каждая нечетная - на 3. Результаты суммируются, и берется остаток от деления на 10.
4. **Формирование итоговой строки**: Объединяет строку времени без последней цифры и контрольную сумму в одну строку.

**ASCII flowchart**:

```
    [Начало]
        ↓
    [Получение времени (мс)]
        ↓
    [Удаление последней цифры]
        ↓
    [Вычисление контрольной суммы]
        ↓
    [Формирование итоговой строки]
        ↓
    [Возврат строки]
```

**Примеры**:

```python
# Пример вызова функции
timestamp = generate_timestamp()
print(timestamp)
```

### `generate_signature`

```python
def generate_signature(text: str):
    """
    Генерирует подпись для запроса к API Myshell AI.

    Args:
        text (str): Текст сообщения, для которого генерируется подпись.

    Returns:
        dict: Словарь, содержащий подпись, временную метку и версию.
    """
```

**Назначение**:
Функция `generate_signature` генерирует подпись для запроса к API Myshell AI, используя текст сообщения, временную метку и секретный ключ.

**Параметры**:
- `text` (str): Текст сообщения, для которого генерируется подпись.

**Возвращает**:
- `dict`: Словарь, содержащий подпись, временную метку и версию.

**Как работает функция**:

1. **Генерация временной метки**: Вызывает функцию `generate_timestamp` для получения временной метки.
2. **Определение версии и секрета**: Определяет версию API и секретный ключ.
3. **Формирование данных для подписи**: Объединяет версию, текст сообщения, временную метку и секретный ключ в одну строку.
4. **Вычисление MD5-хэша**: Вычисляет MD5-хэш от полученной строки.
5. **Инвертирование хэша**: Инвертирует полученный хэш.
6. **Формирование словаря**: Создает словарь, содержащий подпись, временную метку и версию.

**ASCII flowchart**:

```
    [Начало]
        ↓
    [Генерация временной метки]
        ↓
    [Определение версии и секрета]
        ↓
    [Формирование данных для подписи]
        ↓
    [Вычисление MD5-хэша]
        ↓
    [Инвертирование хэша]
        ↓
    [Формирование словаря]
        ↓
    [Возврат словаря]
```

**Примеры**:

```python
# Пример вызова функции
text = "Hello, how are you?"
signature_data = generate_signature(text)
print(signature_data)
```

### `xor_hash`

```python
def xor_hash(B: str):
    """
    Вычисляет XOR-хэш строки.

    Args:
        B (str): Входная строка.

    Returns:
        str: XOR-хэш в шестнадцатеричном формате.
    """
```

**Назначение**:
Функция `xor_hash` вычисляет XOR-хэш входной строки.

**Параметры**:
- `B` (str): Входная строка.

**Возвращает**:
- `str`: XOR-хэш в шестнадцатеричном формате.

**Как работает функция**:

1. **Инициализация**: Инициализирует пустой список `r` и переменную `i` значением 0.
2. **Внутренняя функция `o`**:
   - Принимает два аргумента: `e` и `t`.
   - Вычисляет XOR между `e` и значением, полученным из списка `r`.
   - Значение из списка `r` вычисляется путем сдвига каждого элемента `r[i]` на `8 * i` бит влево и объединения результатов с помощью побитового ИЛИ.
   - Возвращает результат XOR.
3. **Цикл по строке `B`**:
   - Для каждого символа в строке `B`:
     - Получает ASCII-код символа и выполняет побитовое И с 255, чтобы получить байт.
     - Вставляет байт в начало списка `r`.
     - Если длина списка `r` достигает 4:
       - Вызывает функцию `o` с аргументами `i` и `r`.
       - Присваивает результат вызова переменной `i`.
       - Очищает список `r`.
4. **Обработка оставшихся байтов**:
   - Если после завершения цикла в списке `r` остались байты:
     - Вызывает функцию `o` с аргументами `i` и `r`.
     - Присваивает результат вызова переменной `i`.
5. **Возврат результата**:
   - Преобразует значение `i` в шестнадцатеричный формат и возвращает строку без префикса "0x".

**ASCII flowchart**:

```
    [Начало]
        ↓
    [Инициализация r и i]
        ↓
    [Цикл по строке B]
        │
        ├──→ [Получение ASCII-кода]
        │     ↓
        │     [Вставка в r]
        │     ↓
        │     [Проверка длины r]
        │     │
        │     └──→ [Вызов функции o]
        │           ↓
        │           [Очистка r]
        │
        └──→ [Обработка оставшихся байтов в r]
              ↓
              [Вызов функции o]
              ↓
              [Возврат шестнадцатеричного представления i]
```

**Примеры**:

```python
# Пример вызова функции
input_string = "example"
hash_value = xor_hash(input_string)
print(hash_value)
```

### `performance`

```python
def performance() -> str:
    """
    Генерирует строку производительности на основе текущего времени.

    Returns:
        str: Строка производительности в шестнадцатеричном формате.
    """
```

**Назначение**:
Функция `performance` генерирует строку, связанную с производительностью, на основе текущего времени.

**Возвращает**:
- `str`: Строка производительности в шестнадцатеричном формате.

**Как работает функция**:

1. **Получение начального времени**: Получает текущее время в миллисекундах с помощью `time.time() * 1000` и преобразует его в целое число.
2. **Цикл ожидания**: Входит в цикл `while`, который продолжается до тех пор, пока текущее время не изменится. Внутри цикла увеличивает счетчик `e`.
3. **Преобразование в шестнадцатеричный формат**: Преобразует начальное время и счетчик `e` в шестнадцатеричный формат.
4. **Объединение строк**: Объединяет две шестнадцатеричные строки в одну.

**ASCII flowchart**:

```
    [Начало]
        ↓
    [Получение начального времени]
        ↓
    [Цикл ожидания]
        │
        ├──→ [Проверка изменения времени]
        │     │
        │     └──→ [Увеличение счетчика e]
        │
        └──→ [Преобразование в шестнадцатеричный формат]
              ↓
              [Объединение строк]
              ↓
              [Возврат строки]
```

**Примеры**:

```python
# Пример вызова функции
performance_string = performance()
print(performance_string)
```

### `generate_visitor_id`

```python
def generate_visitor_id(user_agent: str) -> str:
    """
    Генерирует идентификатор посетителя на основе User-Agent.

    Args:
        user_agent (str): User-Agent строка.

    Returns:
        str: Сгенерированный идентификатор посетителя.
    """
```

**Назначение**:
Функция `generate_visitor_id` генерирует идентификатор посетителя на основе строки User-Agent.

**Параметры**:
- `user_agent` (str): User-Agent строка.

**Возвращает**:
- `str`: Сгенерированный идентификатор посетителя.

**Как работает функция**:

1. **Генерация строки производительности**: Вызывает функцию `performance` для получения строки производительности.
2. **Генерация случайной строки**: Генерирует случайную шестнадцатеричную строку длиной 14 символов.
3. **Вычисление XOR-хэша**: Вычисляет XOR-хэш User-Agent строки с помощью функции `xor_hash`.
4. **Формирование строки разрешения экрана**: Формирует строку, представляющую разрешение экрана (1080x1920) в шестнадцатеричном формате.
5. **Объединение строк**: Объединяет все полученные строки в одну, разделяя их дефисами.

**ASCII flowchart**:

```
    [Начало]
        ↓
    [Генерация строки производительности]
        ↓
    [Генерация случайной строки]
        ↓
    [Вычисление XOR-хэша]
        ↓
    [Формирование строки разрешения экрана]
        ↓
    [Объединение строк]
        ↓
    [Возврат строки]
```

**Примеры**:

```python
# Пример вызова функции
user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"
visitor_id = generate_visitor_id(user_agent)
print(visitor_id)