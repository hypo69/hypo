# Модуль `ImageLabs`

## Обзор

Модуль `ImageLabs` предоставляет асинхронный интерфейс для генерации изображений с использованием API ImageLabs. Он включает в себя функциональность для отправки запросов на генерацию изображений на основе текстовых описаний (prompt), отслеживания прогресса генерации и получения готовых изображений. Модуль поддерживает настройку размеров изображения, негативные промпты и другие параметры генерации.

## Подробней

Этот модуль является частью системы для взаимодействия с различными поставщиками услуг генерации изображений. Он использует асинхронные запросы для неблокирующей работы и предоставляет методы для настройки и запуска генерации изображений.

## Классы

### `ImageLabs`

**Описание**:
Класс `ImageLabs` является поставщиком асинхронной генерации изображений. Он наследуется от `AsyncGeneratorProvider` и `ProviderModelMixin` и предоставляет методы для взаимодействия с API ImageLabs.

**Принцип работы**:
Класс использует `aiohttp.ClientSession` для отправки асинхронных HTTP-запросов к API ImageLabs. Он отправляет запрос на генерацию изображения с заданными параметрами, затем опрашивает API о прогрессе генерации до тех пор, пока изображение не будет сгенерировано или не произойдет ошибка. Готовое изображение возвращается в виде объекта `ImageResponse`.

**Переменные класса**:
- `url` (str): Базовый URL для ImageLabs.
- `api_endpoint` (str): URL для API генерации изображений.
- `working` (bool): Флаг, указывающий, работает ли провайдер (True).
- `supports_stream` (bool): Флаг, указывающий, поддерживает ли провайдер потоковую передачу (False).
- `supports_system_message` (bool): Флаг, указывающий, поддерживает ли провайдер системные сообщения (False).
- `supports_message_history` (bool): Флаг, указывающий, поддерживает ли провайдер историю сообщений (False).
- `default_model` (str): Модель, используемая по умолчанию для генерации изображений ('sdxl-turbo').
- `default_image_model` (str): Модель изображения по умолчанию (совпадает с `default_model`).
- `image_models` (List[str]): Список поддерживаемых моделей изображений.
- `models` (List[str]): Список поддерживаемых моделей (совпадает с `image_models`).

**Методы**:
- `create_async_generator`
- `get_model`

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    # Image
    prompt: str = None,
    negative_prompt: str = "",
    width: int = 1152,
    height: int = 896,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для генерации изображений с использованием API ImageLabs.

    Args:
        cls: Класс, для которого вызывается метод.
        model (str): Модель для генерации изображений.
        messages (Messages): Список сообщений, содержащих текстовое описание изображения.
        proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
        prompt (str, optional): Текстовое описание изображения. По умолчанию `None`.
        negative_prompt (str, optional): Негативное описание изображения. По умолчанию "".
        width (int, optional): Ширина генерируемого изображения. По умолчанию 1152.
        height (int, optional): Высота генерируемого изображения. По умолчанию 896.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий объекты `ImageResponse` с URL-адресами сгенерированных изображений.

    Raises:
        Exception: Если возникает ошибка при генерации изображения.

    Как работает функция:

    1.  **Инициализация**: Функция инициализирует заголовки HTTP-запроса, необходимые для взаимодействия с API ImageLabs.
    2.  **Подготовка данных**: Извлекает текстовое описание изображения (prompt) из списка сообщений, если prompt не был передан напрямую.
    3.  **Запрос на генерацию**: Отправляет POST-запрос к API ImageLabs для запуска генерации изображения с заданными параметрами (prompt, размеры, негативный промпт и т.д.).
    4.  **Опрос прогресса**: Запускает цикл, в котором периодически опрашивает API о прогрессе генерации изображения, используя идентификатор задачи (task_id), полученный из предыдущего ответа.
    5.  **Обработка ответа**: Анализирует ответ API о прогрессе. Если генерация завершена успешно, функция возвращает объект `ImageResponse` с URL-адресом сгенерированного изображения. Если произошла ошибка, выбрасывается исключение.
    6.  **Ожидание**: Если генерация еще не завершена, функция ожидает 1 секунду перед следующей попыткой опроса.

    Внутри функции происходят следующие действия и преобразования:

    A.  **Инициализация заголовков**: Формируются заголовки HTTP-запроса для взаимодействия с API ImageLabs.
    |
    B.  **Извлечение описания изображения**: Prompt извлекается из входных сообщений или используется переданный параметр `prompt`.
    |
    C.  **Запрос к API на генерацию**: Отправляется POST-запрос к API для запуска генерации изображения.
    |
    D.  **Цикл опроса прогресса**: Цикл, в котором происходит опрос API о статусе генерации изображения.
    |
    E.  **Обработка завершения или ошибки**: Проверяется статус генерации. При завершении возвращается `ImageResponse`, при ошибке выбрасывается исключение.
    |
    F.  **Ожидание**: Ожидание перед следующим запросом прогресса.

    """
    ...
```

### `get_model`

```python
@classmethod
def get_model(cls, model: str) -> str:
    """
    Возвращает модель по умолчанию.

    Args:
        cls: Класс, для которого вызывается метод.
        model (str): Название модели.

    Returns:
        str: Модель по умолчанию (`cls.default_model`).
    """
    ...