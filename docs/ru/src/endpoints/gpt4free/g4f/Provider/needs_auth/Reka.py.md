# Модуль Reka для взаимодействия с провайдером space.reka.ai
=============================================================

Модуль содержит класс `Reka`, который используется для взаимодействия с AI-моделью на платформе space.reka.ai.
Этот модуль отвечает за создание запросов к API, загрузку изображений и получение токенов доступа.

## Оглавление

- [Обзор](#обзор)
- [Подробнее](#подробнее)
- [Классы](#классы)
    - [Reka](#reka)
        - [Атрибуты класса](#атрибуты-класса)
        - [Методы класса](#методы-класса)
            - [create_completion](#create_completion)
            - [upload_image](#upload_image)
            - [get_access_token](#get_access_token)

## Обзор

Модуль `Reka` предоставляет интерфейс для взаимодействия с AI-моделью Reka. Он включает в себя методы для создания запросов на завершение текста, загрузки изображений и получения токенов доступа, необходимых для аутентификации.

## Подробнее

Этот модуль является частью системы для взаимодействия с различными AI-провайдерами. Он специализируется на взаимодействии с платформой Reka, предоставляя необходимые инструменты для аутентификации, отправки запросов и обработки ответов. Модуль использует библиотеку `requests` для выполнения HTTP-запросов и `json` для обработки данных в формате JSON.

## Классы

### `Reka`

**Описание**: Класс `Reka` является производным от класса `AbstractProvider` и предназначен для взаимодействия с AI-моделью Reka.

**Наследует**:
- `AbstractProvider`: Обеспечивает базовую функциональность для взаимодействия с AI-провайдерами.

#### Атрибуты класса:

- `domain` (str): Доменное имя платформы Reka ("space.reka.ai").
- `url` (str): URL платформы Reka (f"https://{domain}").
- `working` (bool): Указывает, работает ли провайдер (True).
- `needs_auth` (bool): Указывает, требуется ли аутентификация для работы с провайдером (True).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных (True).
- `default_vision_model` (str): Название модели для работы с изображениями ("reka").
- `cookies` (dict): Словарь с cookies, необходимыми для аутентификации.

#### Методы класса:

#### `create_completion`

```python
    @classmethod
    def create_completion(
        cls,
        model: str,
        messages: Messages,
        stream: bool,
        proxy: str = None,
        api_key: str = None,
        image: ImageType = None,
        **kwargs
    ) -> CreateResult:
        """Создает запрос на завершение текста к AI-модели Reka.

        Args:
            model (str): Название используемой модели.
            messages (Messages): Список сообщений для отправки в запросе.
            stream (bool): Указывает, использовать ли потоковый режим передачи данных.
            proxy (str, optional):  URL прокси-сервера для использования при отправке запроса. По умолчанию `None`.
            api_key (str, optional): API-ключ для аутентификации. По умолчанию `None`.
            image (ImageType, optional): Изображение для отправки в запросе (если поддерживается моделью). По умолчанию `None`.
            **kwargs: Дополнительные параметры для передачи в запросе.

        Returns:
            CreateResult: Результат создания запроса.

        Raises:
            ValueError: Если не найдены cookies для домена или отсутствует appSession в cookies.

        Как работает функция:
            1. Проверяет наличие `api_key`. Если он не предоставлен, пытается получить `cookies` для домена `cls.domain`.
            2. Если `cookies` не найдены или отсутствует `appSession` в `cookies`, вызывает исключение `ValueError`.
            3. Получает токен доступа с помощью метода `get_access_token`.
            4. Формирует структуру `conversation`, которая содержит историю сообщений.
            5. Если передано изображение, загружает его с помощью метода `upload_image` и добавляет URL изображения и тип медиа в структуру `conversation`.
            6. Формирует заголовки запроса, включая токен доступа.
            7. Формирует JSON-данные для отправки в запросе.
            8. Отправляет POST-запрос к API `cls.url/api/chat` с использованием `requests.post`.
            9. Итерируется по ответам из потока данных, извлекает текстовые данные из каждого ответа и возвращает их с помощью `yield`.

        Внутренние функции:
            Отсутствуют.

        ASCII flowchart:

        Проверка API-ключа и Cookies → Получение Access Token → Формирование Conversation → Загрузка изображения (если есть) → Формирование заголовков и JSON → Отправка POST-запроса → Извлечение и возврат данных из потока ответов

        Примеры:
            Пример 1: Создание запроса без изображения с использованием потоковой передачи данных.
            ```python
            Reka.create_completion(model="reka-core", messages=[{"role": "user", "content": "Hello"}], stream=True, api_key="YOUR_API_KEY")
            ```

            Пример 2: Создание запроса с изображением и прокси-сервером.
            ```python
            Reka.create_completion(model="reka-core", messages=[{"role": "user", "content": "What is on the image?"}], stream=True, api_key="YOUR_API_KEY", image=b"...", proxy="http://your_proxy:8080")
            ```
        """
```

#### `upload_image`

```python
    def upload_image(cls, access_token, image: ImageType) -> str:
        """Загружает изображение на платформу Reka и возвращает URL загруженного изображения.

        Args:
            access_token (str): Токен доступа для аутентификации.
            image (ImageType): Изображение для загрузки.

        Returns:
            str: URL загруженного изображения.

        Как работает функция:
            1. Генерирует случайный токен `boundary_token` для разделения данных в запросе multipart/form-data.
            2. Формирует заголовки запроса, включая токен доступа и тип содержимого multipart/form-data.
            3. Преобразует изображение в байты с помощью функции `to_bytes`.
            4. Формирует данные запроса в формате multipart/form-data, включая информацию об изображении (имя файла, тип содержимого).
            5. Отправляет POST-запрос к API `cls.url/api/upload-image` с использованием `requests.post`.
            6. Извлекает URL загруженного изображения из JSON-ответа и возвращает его.

        Внутренние функции:
            Отсутствуют.

        ASCII flowchart:

        Генерация boundary_token → Формирование заголовков → Преобразование изображения в байты → Формирование multipart/form-data → Отправка POST-запроса → Извлечение и возврат URL изображения

        Примеры:
            Пример 1: Загрузка изображения с использованием access_token.
            ```python
            Reka.upload_image(access_token="YOUR_ACCESS_TOKEN", image=b"...")
            ```
        """
```

#### `get_access_token`

```python
    def get_access_token(cls):
        """Получает токен доступа для аутентификации на платформе Reka.

        Args:
            cls: Ссылка на класс.

        Returns:
            str: Токен доступа.

        Raises:
            ValueError: Если не удалось получить токен доступа.

        Как работает функция:
            1. Формирует заголовки запроса.
            2. Отправляет GET-запрос к API `cls.url/bff/auth/access_token` с использованием `requests.get`.
            3. Извлекает токен доступа из JSON-ответа.
            4. Если возникает исключение при выполнении запроса или извлечении токена, вызывает исключение `ValueError`.

        Внутренние функции:
            Отсутствуют.

        ASCII flowchart:

        Формирование заголовков → Отправка GET-запроса → Извлечение токена из JSON → Обработка ошибок

        Примеры:
            Пример 1: Получение access_token.
            ```python
            Reka.get_access_token()
            ```
        """