# Модуль: Сокращение партнерских ссылок через веб-браузер

## Обзор

Модуль предназначен для сокращения партнерских ссылок AliExpress с использованием веб-браузера. Он автоматизирует процесс получения короткой ссылки через специальный интерфейс, предоставляемый AliExpress для партнеров.

## Подробней

Этот модуль автоматизирует процесс сокращения партнерских ссылок AliExpress. Он использует веб-драйвер для взаимодействия с веб-страницей, где происходит сокращение ссылок. Модуль загружает необходимые локаторы элементов страницы из JSON-файла и использует их для автоматического заполнения полей и нажатия кнопок. В случае возникновения ошибок, модуль логирует их и возвращает `None`.

## Функции

### `get_short_affiliate_link`

```python
def get_short_affiliate_link(d: Driver, url: str) -> str:
    """ Script for generating a shortened affiliate link
    @param url `str`: Full URL
    @returns `str`: Shortened URL
    """
```

**Назначение**: Получение сокращенной партнерской ссылки на основе переданного URL.

**Параметры**:

-   `d` (Driver): Инстанс веб-драйвера, используемый для взаимодействия с веб-страницей.
-   `url` (str): Полный URL партнерской ссылки, которую необходимо сократить.

**Возвращает**:

-   `str`: Сокращенный URL партнерской ссылки.

**Вызывает исключения**:

-   `ValueError`: Если не удалось получить короткий URL или если короткий URL некорректен (начинается с `https://error.taobao.com`).

**Как работает функция**:

1.  **Ввод URL в поле для ввода** (`d.execute_locator(locator.textarea_target_url, url)`):
    Вводит предоставленный URL в текстовое поле на веб-странице, предназначенное для ввода длинных ссылок.
2.  **Нажатие кнопки получения короткой ссылки** (`d.execute_locator(locator.button_get_tracking_link)`):
    Имитирует нажатие на кнопку, которая запускает процесс генерации короткой ссылки на странице.
3.  **Ожидание обновления страницы** (`d.wait(1)`):
    Приостанавливает выполнение кода на 1 секунду, чтобы дать странице время обновиться и отобразить короткую ссылку.
4.  **Получение короткой ссылки** (`short_url = d.execute_locator(locator.textarea_short_link)[0]`):
    Извлекает текст из элемента веб-страницы, содержащего сокращенную ссылку.
5.  **Сохранение идентификатора основной вкладки** (`main_tab = d.current_window_handle`):
    Сохраняет идентификатор текущей (основной) вкладки браузера, чтобы вернуться к ней после работы с новой вкладкой.
6.  **Проверка наличия короткой ссылки** (`if len(short_url) < 1:`):
    Проверяет, была ли получена короткая ссылка. Если длина полученной строки меньше 1, значит, ссылка не была получена.
7.  **Логирование ошибки, если короткий URL не получен** (`logger.error(f"Не удалось получить короткий URL от {url}")`):
    Если короткая ссылка не была получена, в лог записывается сообщение об ошибке с указанием исходного URL.
8.  **Открытие нового таба с коротким URL** (`d.execute_script(f"window.open('{short_url}');")`):
    Выполняет JavaScript-код для открытия новой вкладки в браузере с полученной короткой ссылкой.
9.  **Переключение на новый таб** (`d.switch_to.window(d.window_handles[-1])`):
    Переключает фокус веб-драйвера на новую вкладку, чтобы можно было взаимодействовать с её содержимым.
10. **Проверка, что короткий URL начинается с ожидаемой части** (`if d.current_url.startswith('https://error.taobao.com'):`):
    Проверяет, не перенаправляет ли короткая ссылка на страницу ошибки `error.taobao.com`, что свидетельствует о некорректной ссылке.
11. **Логирование ошибки, если короткий URL некорректен** (`logger.error(f"Неправильный URL: {d.current_url}")`):
    Если короткая ссылка ведет на страницу ошибки, в лог записывается сообщение об ошибке с указанием текущего URL.
12. **Закрытие вкладки с неправильным URL** (`d.close()`):
    Закрывает текущую (новую) вкладку с некорректной короткой ссылкой.
13. **Переключение обратно на основную вкладку** (`d.switch_to.window(main_tab)`):
    Возвращает фокус веб-драйвера на основную вкладку, которая была активна до открытия новой вкладки.
14. **Закрытие новой вкладки** (`d.close()`):
    Закрывает новую вкладку, которая была открыта для проверки короткой ссылки.
15. **Переключение обратно на основную вкладку** (`d.switch_to.window(main_tab)`):
    Возвращает фокус на основную вкладку, чтобы продолжить выполнение сценария.
16. **Возврат короткого URL** (`return short_url`):
    Возвращает полученную короткую ссылку.

```text
    Начало
    │
    ├── Ввод URL в поле для ввода (textarea_target_url)
    │
    ├── Нажатие кнопки "Get Tracking Link" (button_get_tracking_link)
    │
    ├── Ожидание 1 секунду
    │
    ├── Получение короткой ссылки (textarea_short_link)
    │
    ├── Сохранение идентификатора основной вкладки (main_tab)
    │
    ├── Проверка: len(short_url) < 1?
    │   ├── Да: Логирование ошибки "Не удалось получить короткий URL"
    │   └── Нет: Продолжение
    │
    ├── Открытие нового таба с коротким URL
    │
    ├── Переключение на новый таб
    │
    ├── Проверка: d.current_url.startswith('https://error.taobao.com')?
    │   ├── Да: Логирование ошибки "Неправильный URL", Закрытие текущей вкладки, Переключение на main_tab
    │   └── Нет: Продолжение
    │
    ├── Закрытие текущей вкладки
    │
    ├── Переключение на main_tab
    │
    └── Возврат short_url
```

**Примеры**:

```python
from src.webdriver.driver import Driver, Chrome
from src.suppliers.aliexpress.scenarios.affiliate_links_shortener_scenario import get_short_affiliate_link

# Пример использования функции get_short_affiliate_link
driver = Driver(Chrome)
url = "https://www.aliexpress.com/item/1005003405219582.html"
short_url = get_short_affiliate_link(driver, url)
print(f"Сокращенная ссылка: {short_url}")
# => Сокращенная ссылка: https://s.click.aliexpress.com/e/_De6vVzX
```

```python
from src.webdriver.driver import Driver, Chrome
from src.suppliers.aliexpress.scenarios.affiliate_links_shortener_scenario import get_short_affiliate_link

driver = Driver(Chrome)
# Пример с некорректным URL
url = "https://error.taobao.com/item/1005003405219582.html"
short_url = get_short_affiliate_link(driver, url)
# => None