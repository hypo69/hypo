# Модуль `main.py`

## Обзор

Модуль `main.py` является основной точкой входа для Telegram-бота, предназначенного для цифрового рынка. Он содержит функции для запуска, настройки и остановки бота, а также для регистрации необходимых компонентов, таких как промежуточное ПО и маршрутизаторы.

## Подробнее

Этот модуль отвечает за настройку вебхука для бота, регистрацию промежуточного программного обеспечения для работы с базой данных, регистрацию маршрутизаторов для обработки различных типов запросов и запуск веб-приложения на основе `aiohttp`.

## Функции

### `set_default_commands`

```python
async def set_default_commands():
    """
    Устанавливает команды по умолчанию для бота.
    """
    ...
```

**Назначение**:
Устанавливает команды по умолчанию для Telegram-бота, которые отображаются в интерфейсе бота и позволяют пользователям быстро выполнять основные действия.

**Как работает функция**:

1.  Определяет список команд, которые будут установлены для бота. В данном случае, определена команда `/start` с описанием "Запустить бота".
2.  Использует метод `bot.set_my_commands` для установки определенных команд для всех пользователей бота (определяется через `BotCommandScopeDefault`).

**Примеры**:

```python
await set_default_commands()
```

### `on_startup`

```python
async def on_startup(app):
    """
    Выполняется при запуске приложения.
    """
    ...
```

**Назначение**:
Выполняет действия при запуске приложения, такие как установка команд по умолчанию, настройка вебхука и отправка уведомлений администраторам.

**Параметры**:

*   `app`: Объект приложения `aiohttp`.

**Как работает функция**:

1.  Вызывает функцию `set_default_commands` для установки команд по умолчанию для бота.
2.  Устанавливает вебхук для бота, используя URL, полученный из настроек (`settings.get_webhook_url`).
3.  Отправляет уведомления администраторам о запуске бота. Если отправка сообщения не удалась, логируется ошибка.
4.  Логирует информацию об успешном запуске бота.

**Примеры**:

```python
app.on_startup.append(on_startup)
```

### `on_shutdown`

```python
async def on_shutdown(app):
    """
    Выполняется при остановке приложения.
    """
    ...
```

**Назначение**:
Выполняет действия при остановке приложения, такие как отправка уведомлений администраторам, удаление вебхука и закрытие сессии бота.

**Параметры**:

*   `app`: Объект приложения `aiohttp`.

**Как работает функция**:

1.  Отправляет уведомления администраторам об остановке бота. Если отправка сообщения не удалась, логируется ошибка.
2.  Удаляет вебхук, чтобы бот перестал получать обновления. Параметр `drop_pending_updates=True` отбрасывает все ожидающие обновления.
3.  Закрывает сессию бота, освобождая ресурсы.
4.  Логирует информацию об остановке бота.

**Примеры**:

```python
app.on_shutdown.append(on_shutdown)
```

### `register_middlewares`

```python
def register_middlewares():
    """
    Регистрирует мидлвари для диспетчера.
    """
    ...
```

**Назначение**:
Регистрирует промежуточное программное обеспечение (middleware) для диспетчера (`dp`), которое позволяет обрабатывать каждое обновление до того, как оно достигнет обработчиков.

**Как работает функция**:

1.  Регистрирует `DatabaseMiddlewareWithoutCommit`, который предоставляет подключение к базе данных без автоматической фиксации изменений.
2.  Регистрирует `DatabaseMiddlewareWithCommit`, который предоставляет подключение к базе данных с автоматической фиксацией изменений после обработки обновления.

**Примеры**:

```python
register_middlewares()
```

### `register_routers`

```python
def register_routers():
    """
    Регистрирует маршруты для диспетчера.
    """
    ...
```

**Назначение**:
Регистрирует маршрутизаторы для диспетчера (`dp`), которые определяют, как обрабатывать различные типы входящих запросов.

**Как работает функция**:

1.  Включает маршрутизатор `catalog_router`, который обрабатывает запросы, связанные с каталогом товаров.
2.  Включает маршрутизатор `user_router`, который обрабатывает запросы, связанные с пользователями.
3.  Включает маршрутизатор `admin_router`, который обрабатывает запросы, связанные с административными функциями.

**Примеры**:

```python
register_routers()
```

### `create_app`

```python
def create_app():
    """
    Создает и настраивает приложение aiohttp.
    """
    # Создаем приложение
    app = web.Application()

    # Регистрация обработчиков маршрутов
    app.router.add_post(f"/{settings.BOT_TOKEN}", handle_webhook)
    app.router.add_post("/robokassa/result/", robokassa_result)
    app.router.add_get("/robokassa/fail/", robokassa_fail)
    app.router.add_get("/", home_page)

    # Настройка приложения с диспетчером и ботом
    setup_application(app, dp, bot=bot)

    # Регистрация функций запуска и остановки
    app.on_startup.append(on_startup)
    app.on_shutdown.append(on_shutdown)

    return app
```

**Назначение**:
Создает и настраивает веб-приложение `aiohttp`, регистрирует обработчики маршрутов, настраивает приложение с диспетчером и ботом, а также регистрирует функции запуска и остановки.

**Как работает функция**:

1.  Создает экземпляр приложения `aiohttp`.
2.  Регистрирует обработчики маршрутов для различных запросов:
    *   `handle_webhook`: Обработчик для вебхука бота.
    *   `robokassa_result`: Обработчик для результата платежной системы Robokassa.
    *   `robokassa_fail`: Обработчик для случая неуспешной оплаты через Robokassa.
    *   `home_page`: Обработчик для главной страницы приложения.
3.  Настраивает приложение с диспетчером (`dp`) и ботом, используя функцию `setup_application`.
4.  Регистрирует функции `on_startup` и `on_shutdown` для выполнения при запуске и остановке приложения соответственно.
5.  Возвращает настроенное приложение.

**Примеры**:

```python
app = create_app()
```

### `main`

```python
def main():
    """
    Главная функция для запуска приложения.
    """
    # Регистрация мидлварей и роутеров
    register_middlewares()
    register_routers()

    # Создаем приложение и запускаем его
    app = create_app()
    web.run_app(app, host=settings.SITE_HOST, port=settings.SITE_PORT)
```

**Назначение**:
Главная функция, которая запускает приложение. Она регистрирует промежуточное программное обеспечение, маршрутизаторы, создает приложение и запускает веб-сервер.

**Как работает функция**:

1.  Регистрирует промежуточное программное обеспечение с помощью функции `register_middlewares`.
2.  Регистрирует маршрутизаторы с помощью функции `register_routers`.
3.  Создает приложение с помощью функции `create_app`.
4.  Запускает веб-сервер, используя функцию `web.run_app`, и указывает хост и порт из настроек (`settings.SITE_HOST` и `settings.SITE_PORT`).

**Примеры**:

```python
if __name__ == "__main__":
    main()
```