# Модуль обработки запросов от Telegram и Robokassa

## Обзор

Модуль `app.py` предоставляет функциональность для обработки входящих запросов от Telegram (через вебхуки) и Robokassa (для обработки платежей). Он включает в себя обработку вебхуков Telegram, отображение главной страницы с информацией о сервисе, обработку успешных платежей через Robokassa и обработку неудачных платежей.

## Подробней

Этот модуль является центральным звеном для обработки входящих запросов от внешних сервисов. Он использует библиотеку `aiohttp` для создания веб-сервера и обработки HTTP-запросов. Обработка вебхуков Telegram осуществляется через `aiogram`. Для работы с базой данных используется `async_session_maker` из модуля `bot.dao.database`.
Он включает в себя обработку вебхуков Telegram, отображение главной страницы с информацией о сервисе, обработку успешных платежей через Robokassa и обработку неудачных платежей.

## Функции

### `handle_webhook`

```python
async def handle_webhook(request: web.Request):
    """
    Обрабатывает входящий вебхук от Telegram.

    Args:
        request (web.Request): HTTP-запрос, содержащий данные от Telegram.

    Returns:
        web.Response: HTTP-ответ со статусом 200 в случае успеха, 500 в случае ошибки.
    
    Raises:
        Exception: Логируется любая возникшая ошибка при обработке вебхука.

    """
```

**Как работает функция**:

1.  Функция принимает `request` как аргумент типа `web.Request`, содержащий данные от Telegram.
2.  Извлекает `update` из JSON тела запроса, используя `await request.json()`.
3.  Передает `update` в `dp.feed_update(bot, update)` для обработки ботом.
4.  В случае успеха возвращает `web.Response` со статусом 200.
5.  Если происходит исключение, логирует ошибку с использованием `logger.error` и возвращает `web.Response` со статусом 500.

```
A: Получение запроса
|
B: Извлечение update из JSON
|
C: Обработка update ботом
|
D: Возврат ответа (200 или 500)
```

**Примеры**:
- Обработка входящего сообщения от пользователя Telegram:

```python
# Пример использования внутри aiohttp route handler
async def my_handler(request):
    return await handle_webhook(request)
```

### `home_page`

```python
async def home_page(request: web.Request) -> web.Response:
    """
    Обработчик для отображения главной страницы с информацией о сервисе.

    Args:
        request (web.Request): HTTP-запрос.

    Returns:
        web.Response: HTTP-ответ, содержащий HTML-страницу с информацией о сервисе.
    """
```

**Как работает функция**:

1.  Функция принимает `request` типа `web.Request` в качестве аргумента.
2.  Получает текущее время сервера в формате "%Y-%m-%d %H:%M:%S".
3.  Формирует HTML-контент, содержащий информацию о сервисе и текущем времени сервера.
4.  Возвращает `web.Response` с HTML-контентом и типом содержимого `text/html`.

```
A: Получение запроса
|
B: Получение текущего времени
|
C: Формирование HTML-контента
|
D: Возврат HTML-ответа
```

**Примеры**:
- Получение главной страницы сервиса:

```python
# Пример использования внутри aiohttp route handler
async def my_handler(request):
    return await home_page(request)
```

### `robokassa_result`

```python
async def robokassa_result(request: web.Request) -> web.Response:
    """
    Обрабатывает запрос от Робокассы на ResultURL.

    Args:
        request (web.Request): HTTP-запрос.

    Returns:
        web.Response: Текстовый ответ с результатами проверки.
    """
```

**Как работает функция**:

1.  Функция принимает `request` типа `web.Request` в качестве аргумента.
2.  Логирует получение ответа от Робокассы.
3.  Извлекает параметры из POST-запроса: `signature`, `out_sum`, `inv_id`, `user_id`, `user_telegram_id`, `product_id`.
4.  Проверяет подпись с использованием функции `check_signature_result`.
5.  Если подпись верна, формирует ответ `OK{inv_id}`, логирует успешную проверку, формирует `payment_data`, вызывает `successful_payment_logic` для обработки успешного платежа и коммитит изменения в базе данных.
6.  Если подпись неверна, формирует ответ `"bad sign"` и логирует предупреждение о неверной подписи.
7.  Логирует ответ и возвращает `web.Response` с текстом ответа.

```
A: Получение запроса от Robokassa
|
B: Извлечение параметров из запроса
|
C: Проверка подписи
|
D: Подпись верна?
|   +-- Да --> E: Формирование payment_data
|   |             |
|   |             F: Вызов successful_payment_logic
|   |             |
|   |             G: Коммит изменений в БД
|   |             |
|   +------------- H: Формирование ответа "OK{inv_id}"
|
I: Нет --> J: Формирование ответа "bad sign"
|
K: Логирование ответа
|
L: Возврат ответа
```

**Примеры**:

```python
# Пример использования внутри aiohttp route handler
async def my_handler(request):
    return await robokassa_result(request)
```

### `robokassa_fail`

```python
async def robokassa_fail(request):
    """
    Обрабатывает запрос при неудачном платеже через Робокассу.

    Args:
        request: HTTP-запрос с информацией о неудачном платеже.

    Returns:
        web.Response: HTTP-ответ с сообщением о неудачном платеже.
    """
```

**Как работает функция**:

1.  Функция принимает `request` типа `web.Request` в качестве аргумента.
2.  Извлекает параметры `InvId` и `OutSum` из GET-запроса.
3.  Выводит информацию о неудачном платеже в консоль.
4.  Возвращает `web.Response` с сообщением "Платеж не удался" и типом содержимого `text/html`.

```
A: Получение запроса о неудачном платеже
|
B: Извлечение параметров InvId и OutSum
|
C: Вывод информации о неудачном платеже
|
D: Возврат ответа о неудаче платежа
```

**Примеры**:

```python
# Пример использования внутри aiohttp route handler
async def my_handler(request):
    return await robokassa_fail(request)