# Модуль `control.py`

## Обзор

Модуль `control.py` предоставляет механизмы управления симуляцией, включая управление состоянием симуляции, кэширование, а также поддержку транзакций.

## Оглавление

1.  [Класс `Simulation`](#класс-simulation)
    -   [Метод `__init__`](#__init__)
    -   [Метод `begin`](#begin)
    -   [Метод `end`](#end)
    -   [Метод `checkpoint`](#checkpoint)
    -   [Метод `add_agent`](#add_agent)
    -   [Метод `add_environment`](#add_environment)
    -   [Метод `add_factory`](#add_factory)
    -   [Метод `_execution_trace_position`](#_execution_trace_position)
    -   [Метод `_function_call_hash`](#_function_call_hash)
    -   [Метод `_skip_execution_with_cache`](#_skip_execution_with_cache)
    -   [Метод `_is_transaction_event_cached`](#_is_transaction_event_cached)
    -   [Метод `_drop_cached_trace_suffix`](#_drop_cached_trace_suffix)
    -   [Метод `_add_to_execution_trace`](#_add_to_execution_trace)
    -   [Метод `_add_to_cache_trace`](#_add_to_cache_trace)
    -   [Метод `_load_cache_file`](#_load_cache_file)
    -   [Метод `_save_cache_file`](#_save_cache_file)
    -   [Метод `begin_transaction`](#begin_transaction)
    -   [Метод `end_transaction`](#end_transaction)
    -   [Метод `is_under_transaction`](#is_under_transaction)
    -   [Метод `_clear_communications_buffers`](#_clear_communications_buffers)
    -   [Метод `_encode_simulation_state`](#_encode_simulation_state)
    -   [Метод `_decode_simulation_state`](#_decode_simulation_state)
2.  [Класс `Transaction`](#класс-transaction)
    -   [Метод `__init__`](#__init__-1)
    -   [Метод `execute`](#execute)
    -   [Метод `_encode_function_output`](#_encode_function_output)
    -   [Метод `_decode_function_output`](#_decode_function_output)
3.  [Функция `transactional`](#функция-transactional)
4.  [Класс `SkipTransaction`](#класс-skiptransaction)
5.  [Класс `CacheOutOfSync`](#класс-cacheoutofsync)
6.  [Класс `ExecutionCached`](#класс-executioncached)
7.  [Функция `reset`](#функция-reset)
8.  [Функция `_simulation`](#функция-_simulation)
9.  [Функция `begin`](#функция-begin)
10. [Функция `end`](#функция-end)
11. [Функция `checkpoint`](#функция-checkpoint)
12. [Функция `current_simulation`](#функция-current_simulation)

## Класс `Simulation`

**Описание**: Класс `Simulation` управляет состоянием симуляции, включая агентов, окружения и фабрики. Он также обеспечивает механизмы кэширования и транзакционности.

### `__init__`

**Описание**: Инициализирует объект `Simulation`.

**Параметры**:
- `id` (str, optional): Идентификатор симуляции. По умолчанию `"default"`.
- `cached_trace` (list, optional): Список состояний симуляции из кэша. По умолчанию `None`.

### `begin`

**Описание**: Запускает симуляцию.

**Параметры**:
- `cache_path` (str, optional): Путь к файлу кэша. По умолчанию `None`.
- `auto_checkpoint` (bool, optional): Определяет, следует ли автоматически сохранять состояние после каждой транзакции. По умолчанию `False`.

**Вызывает исключения**:
- `ValueError`: Если симуляция уже запущена.

### `end`

**Описание**: Завершает симуляцию.

**Вызывает исключения**:
- `ValueError`: Если симуляция уже остановлена.

### `checkpoint`

**Описание**: Сохраняет текущее состояние симуляции в файл кэша.

### `add_agent`

**Описание**: Добавляет агента в симуляцию.

**Параметры**:
- `agent`: Объект агента, который нужно добавить.

**Вызывает исключения**:
- `ValueError`: Если агент с таким именем уже существует.

### `add_environment`

**Описание**: Добавляет окружение в симуляцию.

**Параметры**:
- `environment`: Объект окружения, который нужно добавить.

**Вызывает исключения**:
- `ValueError`: Если окружение с таким именем уже существует.

### `add_factory`

**Описание**: Добавляет фабрику в симуляцию.

**Параметры**:
- `factory`: Объект фабрики, который нужно добавить.

**Вызывает исключения**:
- `ValueError`: Если фабрика с таким именем уже существует.

### `_execution_trace_position`

**Описание**: Возвращает текущую позицию в цепочке выполнения.

**Возвращает**:
- `int`: Индекс текущего состояния в цепочке выполнения или `-1`, если цепочка пуста.

### `_function_call_hash`

**Описание**: Вычисляет хэш вызова функции.

**Параметры**:
- `function_name` (str): Имя вызываемой функции.
- `*args`: Позиционные аргументы функции.
- `**kwargs`: Именованные аргументы функции.

**Возвращает**:
- `int`: Хэш вызова функции.

### `_skip_execution_with_cache`

**Описание**: Пропускает выполнение, используя кэшированное состояние.

**Вызывает исключения**:
- `AssertionError`: Если нет кэшированного состояния в текущей позиции выполнения.

### `_is_transaction_event_cached`

**Описание**: Проверяет, кэшировано ли событие транзакции.

**Параметры**:
- `event_hash` (int): Хэш события.

**Возвращает**:
- `bool`: `True`, если событие кэшировано или нет кэша, `False` в противном случае.

**Вызывает исключения**:
- `ValueError`: Если позиция трассировки выполнения недопустима.

### `_drop_cached_trace_suffix`

**Описание**: Удаляет суффикс кэшированной трассировки, начиная с текущей позиции выполнения.

### `_add_to_execution_trace`

**Описание**: Добавляет состояние в трассировку выполнения.

**Параметры**:
- `state` (dict): Текущее состояние симуляции.
- `event_hash` (int): Хэш события.
- `event_output`: Выходные данные события.

### `_add_to_cache_trace`

**Описание**: Добавляет состояние в кэшированную трассировку.

**Параметры**:
- `state` (dict): Текущее состояние симуляции.
- `event_hash` (int): Хэш события.
- `event_output`: Выходные данные события.

### `_load_cache_file`

**Описание**: Загружает кэш из файла.

**Параметры**:
- `cache_path` (str): Путь к файлу кэша.

### `_save_cache_file`

**Описание**: Сохраняет кэш в файл.

**Параметры**:
- `cache_path` (str): Путь к файлу кэша.

### `begin_transaction`

**Описание**: Начинает транзакцию.

### `end_transaction`

**Описание**: Завершает транзакцию.

### `is_under_transaction`

**Описание**: Проверяет, выполняется ли транзакция.

**Возвращает**:
- `bool`: `True`, если выполняется транзакция, `False` в противном случае.

### `_clear_communications_buffers`

**Описание**: Очищает буферы коммуникаций агентов и окружений.

### `_encode_simulation_state`

**Описание**: Кодирует текущее состояние симуляции.

**Возвращает**:
- `dict`: Словарь, представляющий закодированное состояние симуляции.

### `_decode_simulation_state`

**Описание**: Декодирует состояние симуляции.

**Параметры**:
- `state` (dict): Состояние для декодирования.

**Вызывает исключения**:
- `ValueError`: Если окружение или агент не найдены в симуляции.

## Класс `Transaction`

**Описание**: Класс `Transaction` управляет выполнением транзакций в симуляции.

### `__init__`

**Описание**: Инициализирует объект `Transaction`.

**Параметры**:
- `obj_under_transaction`: Объект, выполняющий транзакцию.
- `simulation` (Simulation): Объект симуляции.
- `function`: Функция, вызываемая в транзакции.
- `*args`: Позиционные аргументы функции.
- `**kwargs`: Именованные аргументы функции.

**Вызывает исключения**:
- `ValueError`: Если объект уже захвачен другой симуляцией.
- `ValueError`: Если объект не является экземпляром `TinyPerson` или `TinyWorld`.

### `execute`

**Описание**: Выполняет транзакцию.

**Возвращает**:
- Зависит от вызываемой функции в транзакции.

**Вызывает исключения**:
- `ValueError`: Если статус симуляции недопустим.

### `_encode_function_output`

**Описание**: Кодирует вывод функции.

**Параметры**:
- `output`: Выходные данные функции.

**Возвращает**:
- `dict`: Закодированные выходные данные.

**Вызывает исключения**:
- `ValueError`: Если тип выходных данных не поддерживается.

### `_decode_function_output`

**Описание**: Декодирует вывод функции.

**Параметры**:
- `encoded_output` (dict): Закодированные выходные данные.

**Возвращает**:
- Зависит от типа закодированных данных.

**Вызывает исключения**:
- `ValueError`: Если тип закодированных выходных данных не поддерживается.

## Функция `transactional`

**Описание**: Декоратор, делающий функцию транзакционной.

**Параметры**:
- `func`: Функция, которую нужно сделать транзакционной.

**Возвращает**:
- Функция-обертка.

## Класс `SkipTransaction`

**Описание**: Исключение, используемое для обозначения пропуска транзакции.

## Класс `CacheOutOfSync`

**Описание**: Исключение, используемое для обозначения рассинхронизации кэша.

## Класс `ExecutionCached`

**Описание**: Исключение, используемое для обозначения того, что выполнение уже кэшировано.

## Функция `reset`

**Описание**: Сбрасывает состояние управления симуляцией.

## Функция `_simulation`

**Описание**: Возвращает объект симуляции.

**Параметры**:
- `id` (str, optional): Идентификатор симуляции. По умолчанию `"default"`.

**Возвращает**:
- `Simulation`: Объект симуляции.

## Функция `begin`

**Описание**: Запускает управление симуляцией.

**Параметры**:
- `cache_path` (str, optional): Путь к файлу кэша. По умолчанию `None`.
- `id` (str, optional): Идентификатор симуляции. По умолчанию `"default"`.
- `auto_checkpoint` (bool, optional): Флаг для автоматического сохранения состояния после транзакции. По умолчанию `False`.

**Вызывает исключения**:
- `ValueError`: Если симуляция уже запущена.

## Функция `end`

**Описание**: Завершает управление симуляцией.

**Параметры**:
- `id` (str, optional): Идентификатор симуляции. По умолчанию `"default"`.

## Функция `checkpoint`

**Описание**: Сохраняет текущее состояние симуляции.

**Параметры**:
- `id` (str, optional): Идентификатор симуляции. По умолчанию `"default"`.

## Функция `current_simulation`

**Описание**: Возвращает текущую активную симуляцию.

**Возвращает**:
- `Simulation | None`: Объект текущей симуляции или `None`, если нет активной симуляции.