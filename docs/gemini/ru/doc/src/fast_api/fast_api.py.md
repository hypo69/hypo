# Модуль FastAPI сервера с XML-RPC интерфейсом для удалённого управления
==================================================================

Модуль содержит FastAPI сервер с интерфейсом XML-RPC для удалённого управления.
Он предоставляет возможность запуска, остановки и управления серверами FastAPI через удалённые вызовы процедур (RPC).

## Обзор

Этот модуль реализует FastAPI сервер, который может управляться удаленно через XML-RPC. Он позволяет запускать и останавливать серверы на определенных портах, просматривать их статус, добавлять новые маршруты и останавливать все запущенные серверы. Модуль использует библиотеку `uvicorn` для асинхронного запуска серверов FastAPI и `xmlrpc.server` для предоставления XML-RPC интерфейса.

## Подробней

Модуль предоставляет класс `FastApiServer`, который является Singleton-ом и управляет экземпляром FastAPI приложения. `CommandHandler` предоставляет интерфейс XML-RPC для удаленного управления сервером. Основная функция `main` запускает цикл обработки команд, позволяющий пользователю взаимодействовать с сервером через консоль.

## Классы

### `FastApiServer`

**Описание**: Класс, реализующий FastAPI сервер с поддержкой Singleton.

**Принцип работы**:
Класс `FastApiServer` является синглтоном, что означает, что может быть создан только один экземпляр этого класса. Он инициализирует FastAPI приложение, настраивает маршруты и предоставляет методы для запуска и остановки сервера.

**Атрибуты**:
- `_instance`: Приватный атрибут класса, хранящий единственный экземпляр класса.
- `app` (FastAPI): Экземпляр FastAPI приложения.
- `host` (str): Хост, на котором будет запущен сервер (по умолчанию "127.0.0.1").
- `port` (int): Порт, на котором будет запущен сервер (по умолчанию 8000).
- `router` (APIRouter): Маршрутизатор для добавления API маршрутов.
- `server_tasks` (Dict): Словарь для хранения задач сервера.
- `servers` (Dict): Словарь для хранения запущенных серверов.

**Методы**:
- `__new__(cls, *args, **kwargs)`: Создает новый экземпляр класса, если он еще не создан.
- `__init__(self, host: str = "127.0.0.1", title: str = "FastAPI RPC Server", **kwargs)`: Инициализирует экземпляр класса, добавляет маршруты, такие как `/hello` и `/post`, и настраивает FastAPI приложение.
- `add_route(self, path: str, func: Callable, methods: List[str] = ["GET"], **kwargs)`: Добавляет маршрут к FastAPI приложению.
- `_start_server(self, port: int)`: Запускает uvicorn сервер асинхронно.
- `start(self, port: int, as_thread: bool = True)`: Запускает FastAPI сервер на указанном порту в отдельном потоке.
- `stop(self, port: int)`: Останавливает FastAPI сервер на указанном порту.
- `stop_all(self)`: Останавливает все запущенные сервера.
- `get_servers_status(self)`: Возвращает статус всех серверов.
- `get_routes(self)`: Возвращает список всех роутов.
- `get_app(self)`: Возвращает FastAPI приложение.
- `add_new_route(self, path: str, module_name: str, func_name: str, methods: List[str] = ["GET"], **kwargs)`: Добавляет новый маршрут к уже работающему приложению, импортируя модуль и функцию динамически.

### `CommandHandler`

**Описание**: Обработчик команд для FastAPI сервера через XML-RPC.

**Принцип работы**:
Класс `CommandHandler` предоставляет интерфейс XML-RPC для удаленного управления FastAPI сервером. Он регистрирует методы для запуска, остановки и получения статуса серверов, а также для добавления новых маршрутов.

**Атрибуты**:
- `rpc_port` (int): Порт для XML-RPC сервера (по умолчанию 9000).
- `rpc_server` (SimpleXMLRPCServer): Экземпляр XML-RPC сервера.

**Методы**:
- `__init__(self, rpc_port=9000)`: Инициализирует XML-RPC сервер и регистрирует методы экземпляра.
- `start_server(self, port: int, host: str)`: Запускает FastAPI сервер.
- `stop_server(self, port: int)`: Останавливает FastAPI сервер.
- `stop_all_servers(self)`: Останавливает все запущенные серверы.
- `status_servers(self)`: Возвращает статус серверов.
- `get_routes(self)`: Возвращает список маршрутов.
- `add_new_route(self, path: str, module_name: str, func_name: str, methods: List[str] = ["GET"])`: Добавляет новый маршрут.
- `shutdown(self)`: Останавливает все серверы и завершает работу RPC сервера.

## Функции

### `telegram_webhook`

```python
def telegram_webhook() -> str:
    """ """
```

**Назначение**: Функция-заглушка для telegram webhook. В текущей реализации просто возвращает строку "Hello, World!".

**Параметры**:
- Нет параметров.

**Возвращает**:
- `str`: Строка "Hello, World!".

**Как работает функция**:
1. Просто возвращает строку "Hello, World!".

**Примеры**:
```python
result = telegram_webhook()
print(result)  # Выведет: Hello, World!
```

### `test_function`

```python
def test_function() -> str:
    """ """
```

**Назначение**: Тестовая функция, возвращающая строку "It is working!!!".

**Параметры**:
- Нет параметров.

**Возвращает**:
- `str`: Строка "It is working!!!".

**Как работает функция**:
1. Просто возвращает строку "It is working!!!".

**Примеры**:
```python
result = test_function()
print(result)  # Выведет: It is working!!!
```

### `test_post`

```python
def test_post(data: Dict[str, str]) -> Dict[str, str]:
    """ """
```

**Назначение**: Тестовая функция для обработки POST запросов.

**Параметры**:
- `data` (Dict[str, str]): Словарь с данными, переданными в POST запросе.

**Возвращает**:
- `Dict[str, str]`: Словарь с результатом обработки POST запроса.

**Как работает функция**:
1. Возвращает словарь, содержащий сообщение "post ok" и переданные данные.

**Примеры**:
```python
data = {"key": "value"}
result = test_post(data)
print(result)  # Выведет: {'result': 'post ok', 'data': {'key': 'value'}}
```

### `start_server`

```python
def start_server(port: int, host: str) -> None:
    """Запускает FastAPI сервер на указанном порту."""
```

**Назначение**: Запускает FastAPI сервер на указанном порту.

**Параметры**:
- `port` (int): Порт, на котором нужно запустить сервер.
- `host` (str): Хост, на котором нужно запустить сервер.

**Как работает функция**:
1. Проверяет, инициализирован ли экземпляр `FastApiServer`. Если нет, создает его.
2. Вызывает метод `start` экземпляра `FastApiServer` для запуска сервера на указанном порту.
3. Обрабатывает возможные исключения и логирует ошибки.

```ascii
    Начало
    │
    ├── Проверка: _api_server_instance is None?
    │   └── ДА: Создать экземпляр FastApiServer
    │
    ├── Запуск сервера: _api_server_instance.start(port=port)
    │   ├── Попытка запуска
    │   └── Обработка исключений (логирование ошибок)
    │
    Конец
```

**Примеры**:
```python
start_server(port=8000, host="127.0.0.1")
```

### `stop_server`

```python
def stop_server(port: int) -> None:
    """Останавливает FastAPI сервер на указанном порту."""
```

**Назначение**: Останавливает FastAPI сервер на указанном порту.

**Параметры**:
- `port` (int): Порт, на котором нужно остановить сервер.

**Как работает функция**:
1. Проверяет, инициализирован ли экземпляр `FastApiServer`.
2. Вызывает метод `stop` экземпляра `FastApiServer` для остановки сервера на указанном порту.
3. Обрабатывает возможные исключения и логирует ошибки.

```ascii
    Начало
    │
    ├── Проверка: _api_server_instance is not None?
    │   └── ДА: Остановить сервер на порту
    │
    ├── Остановка сервера: _api_server_instance.stop(port=port)
    │   ├── Попытка остановки
    │   └── Обработка исключений (логирование ошибок)
    │
    Конец
```

**Примеры**:
```python
stop_server(port=8000)
```

### `stop_all_servers`

```python
def stop_all_servers() -> None:
    """Останавливает все запущенные FastAPI сервера."""
```

**Назначение**: Останавливает все запущенные FastAPI сервера.

**Параметры**:
- Нет параметров.

**Как работает функция**:
1. Проверяет, инициализирован ли экземпляр `FastApiServer`.
2. Вызывает метод `stop_all` экземпляра `FastApiServer` для остановки всех серверов.
3. Обрабатывает возможные исключения и логирует ошибки.

```ascii
    Начало
    │
    ├── Проверка: _api_server_instance is not None?
    │   └── ДА: Остановить все серверы
    │
    ├── Остановка всех серверов: _api_server_instance.stop_all()
    │   ├── Попытка остановки
    │   └── Обработка исключений (логирование ошибок)
    │
    Конец
```

**Примеры**:
```python
stop_all_servers()
```

### `status_servers`

```python
def status_servers() -> None:
    """Показывает статус серверов."""
```

**Назначение**: Выводит статус всех запущенных серверов.

**Как работает функция**:
1. Проверяет, инициализирован ли экземпляр `FastApiServer`.
2. Вызывает метод `get_servers_status` экземпляра `FastApiServer` для получения статуса серверов.
3. Выводит информацию о статусе каждого сервера. Если серверы не запущены, выводит соответствующее сообщение.

```ascii
    Начало
    │
    ├── Проверка: _api_server_instance is not None?
    │   └── ДА: Получить статус серверов
    │
    ├── Получение статуса: _api_server_instance.get_servers_status()
    │   ├── Если серверы есть: Вывод статуса каждого сервера
    │   └── Если серверов нет: Вывод сообщения "No servers running"
    │
    Конец
```

**Примеры**:
```python
status_servers()
```

### `get_routes`

```python
def get_routes() -> None:
    """Показывает все роуты."""
```

**Назначение**: Выводит список всех зарегистрированных маршрутов.

**Как работает функция**:
1. Проверяет, инициализирован ли экземпляр `FastApiServer`.
2. Вызывает метод `get_routes` экземпляра `FastApiServer` для получения списка маршрутов.
3. Выводит информацию о каждом маршруте. Если маршруты не определены, выводит соответствующее сообщение.

```ascii
    Начало
    │
    ├── Проверка: _api_server_instance is not None?
    │   └── ДА: Получить список маршрутов
    │
    ├── Получение маршрутов: _api_server_instance.get_routes()
    │   ├── Если маршруты есть: Вывод каждого маршрута
    │   └── Если маршрутов нет: Вывод сообщения "No routes defined"
    │
    Конец
```

**Примеры**:
```python
get_routes()
```

### `add_new_route`

```python
def add_new_route(path: str, module_name: str, func_name: str, methods: List[str] = ["GET"]) -> None:
    """Добавляет новый роут к серверу."""
```

**Назначение**: Добавляет новый маршрут к FastAPI серверу.

**Параметры**:
- `path` (str): Путь для нового маршрута.
- `module_name` (str): Имя модуля, содержащего функцию для маршрута.
- `func_name` (str): Имя функции, которая будет обрабатывать запросы к маршруту.
- `methods` (List[str]): Список HTTP методов, поддерживаемых маршрутом (по умолчанию ["GET"]).

**Как работает функция**:
1. Проверяет, инициализирован ли экземпляр `FastApiServer`.
2. Вызывает метод `add_new_route` экземпляра `FastApiServer` для добавления нового маршрута.
3. Обрабатывает возможные исключения и логирует ошибки.

```ascii
    Начало
    │
    ├── Проверка: _api_server_instance is not None?
    │   └── ДА: Добавить новый маршрут
    │
    ├── Добавление маршрута: _api_server_instance.add_new_route(...)
    │   ├── Попытка добавления
    │   └── Обработка исключений (логирование ошибок)
    │
    Конец
```

**Примеры**:
```python
add_new_route(path="/test", module_name="my_module", func_name="my_function")
```

### `parse_port_range`

```python
def parse_port_range(range_str: str) -> List[int]:
    """Разбирает строку с диапазоном портов."""
```

**Назначение**: Разбирает строку с диапазоном портов и возвращает список портов.

**Параметры**:
- `range_str` (str): Строка с диапазоном портов (например, "8000-8005" или "8000").

**Возвращает**:
- `List[int]`: Список портов. Если строка не соответствует формату, возвращает пустой список.

**Как работает функция**:
1. Проверяет, соответствует ли строка формату диапазона портов (например, "8000-8005" или "8000").
2. Если строка содержит дефис, пытается разбить строку на начало и конец диапазона и сгенерировать список портов.
3. Если строка не содержит дефис, пытается преобразовать строку в целое число и вернуть список, содержащий только этот порт.
4. Обрабатывает возможные исключения и возвращает пустой список в случае ошибки.

```ascii
    Начало
    │
    ├── Проверка: Соответствует ли строка формату диапазона портов?
    │   └── НЕТ: Вывод сообщения об ошибке и возврат пустого списка
    │
    ├── Проверка: Содержит ли строка дефис?
    │   ├── ДА: Разбить строку на начало и конец диапазона
    │   │   ├── Преобразовать начало и конец в целые числа
    │   │   ├── Сгенерировать список портов в диапазоне
    │   │   └── Обработка исключений (возврат пустого списка)
    │   └── НЕТ: Преобразовать строку в целое число
    │       ├── Вернуть список, содержащий только этот порт
    │       └── Обработка исключений (возврат пустого списка)
    │
    Конец
```

**Примеры**:
```python
ports = parse_port_range("8000-8005")
print(ports)  # Выведет: [8000, 8001, 8002, 8003, 8004, 8005]

ports = parse_port_range("8000")
print(ports)  # Выведет: [8000]

ports = parse_port_range("invalid")
print(ports)  # Выведет: []
```

### `display_menu`

```python
def display_menu() -> None:
    """Выводит меню с доступными командами."""
```

**Назначение**: Выводит меню с доступными командами для управления сервером.

**Как работает функция**:
1. Выводит список доступных команд и их описания.

**Примеры**:
```python
display_menu()
```

### `main`

```python
def main() -> None:
    """Основная функция управления сервером."""
```

**Назначение**: Основная функция управления сервером.

**Как работает функция**:
1. Создает экземпляр `CommandHandler`.
2. Входит в бесконечный цикл, в котором выводит меню доступных команд и ожидает ввода пользователя.
3. Обрабатывает введенные команды и вызывает соответствующие методы `CommandHandler`.
4. Обрабатывает возможные исключения и логирует ошибки.

```ascii
    Начало
    │
    ├── Создание экземпляра CommandHandler
    │
    ├── Бесконечный цикл
    │   ├── Вывод меню доступных команд
    │   ├── Ожидание ввода пользователя
    │   ├── Разбор введенной команды
    │   ├── Выполнение команды
    │   ├── Обработка исключений
    │
    Конец
```

**Примеры**:
Запуск программы:
```bash
python your_module_name.py
```

## Оглавление

- [Классы](#классы)
  - [`FastApiServer`](#fastapiserver)
  - [`CommandHandler`](#commandhandler)
- [Функции](#функции)
  - [`telegram_webhook`](#telegram_webhook)
  - [`test_function`](#test_function)
  - [`test_post`](#test_post)
  - [`start_server`](#start_server)
  - [`stop_server`](#stop_server)
  - [`stop_all_servers`](#stop_all_servers)
  - [`status_servers`](#status_servers)
  - [`get_routes`](#get_routes)
  - [`add_new_route`](#add_new_route)
  - [`parse_port_range`](#parse_port_range)
  - [`display_menu`](#display_menu)
  - [`main`](#main)