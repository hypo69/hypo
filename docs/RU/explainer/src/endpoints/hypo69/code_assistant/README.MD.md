## АНАЛИЗ КОДА: `README.md` для модуля `code_assistant`

### 1. <алгоритм>

**Общая структура модуля:**

Модуль `code_assistant` состоит из нескольких скриптов, которые совместно работают для анализа кода и взаимодействия с моделями ИИ.

1.  **`code_assistant.py`**
    *   **Начало**: Скрипт запускается с параметрами командной строки, определяющими роль, язык, модели и директории.
        *   Пример: `python code_assistant.py --role doc_writer --lang ru --models gemini openai --start_dirs /path/to/dir1 /path/to/dir2`
    *   **Инициализация**: Загружает параметры из JSON-файла или из аргументов командной строки.
    *   **Поиск файлов**: Рекурсивно сканирует заданные директории в поиске файлов с расширениями `.py` и `README.md`.
        *   Пример: Сканируются директории `/path/to/dir1` и `/path/to/dir2`.
    *   **Чтение файлов**: Читает содержимое найденных файлов.
        *   Пример: Читается файл `my_code.py` из `/path/to/dir1`.
    *   **Загрузка промптов**: Загружает соответствующие промпты из директории `src/ai/prompts/developer/` на основе роли и языка.
        *   Пример: Загружается промпт `doc_writer_ru.md`, если роль `doc_writer` и язык `ru`.
    *   **Взаимодействие с моделями**: Отправляет содержимое файлов и промпты в модели Gemini и/или OpenAI.
        *   Пример: Отправляется текст файла `my_code.py` с промптом `doc_writer_ru.md` в Gemini.
    *   **Сохранение результатов**: Сохраняет ответы моделей в соответствующие директории.
        *   Пример: Ответ от Gemini для `my_code.py` сохраняется в `docs/raw_rst_from_gemini/ru/`.
    *   **Завершение**: Завершает работу после обработки всех файлов и моделей.

2.  **`make_summary.py`**
    *   **Начало**: Скрипт запускается с указанием начальной директории и языка.
        *   Пример: `python make_summary.py --start_dir /path/to/docs --lang ru`
    *   **Рекурсивный поиск**: Рекурсивно обходит указанную директорию.
        *   Пример: Обход директории `/path/to/docs`.
    *   **Фильтрация файлов**: Фильтрует файлы по языку.
        *   Пример: Отбираются файлы с расширением `.ru.md` для языка `ru`.
    *   **Создание `SUMMARY.md`**: Создает файл `SUMMARY.md` с оглавлением на основе найденных файлов.
        *   Пример: Создается файл `SUMMARY.md` в `/path/to/docs`.
    *   **Завершение**: Завершает работу после создания `SUMMARY.md`.

3.  **`onela_bot.py` и `bot_handlers.py`**
    *   **`onela_bot.py`**: Запускает Telegram-бота.
    *   **`bot_handlers.py`**: Обрабатывает команды и сообщения, полученные от бота.
        *   **Обработка команд**: Вызывает соответствующие функции для обработки конкретных команд бота.
            *   Пример: Обработка команды `/doc` для генерации документации.
        *   **Взаимодействие с моделями**:  Использует функциональность `code_assistant.py` для работы с моделями и обработки кода.
        *   **Отправка ответа**: Отправляет результат работы бота пользователю Telegram.
            *   Пример: Отправляет сгенерированную документацию пользователю.
        *   **Завершение**: Продолжает работу, обрабатывая новые сообщения от пользователей.

### 2. <mermaid>

```mermaid
flowchart TD
    subgraph code_assistant.py
        Start_CA[Начало code_assistant.py]
        LoadSettings[Загрузка настроек из JSON или CLI]
        ScanDirs[Рекурсивный поиск .py и README.MD файлов]
        ReadFile[Чтение содержимого файла]
        LoadPrompt[Загрузка промпта по роли и языку]
        SendToModel[Отправка запроса в модель (Gemini/OpenAI)]
        SaveResponse[Сохранение ответа модели]
        End_CA[Конец code_assistant.py]
        Start_CA --> LoadSettings
        LoadSettings --> ScanDirs
        ScanDirs --> ReadFile
        ReadFile --> LoadPrompt
        LoadPrompt --> SendToModel
        SendToModel --> SaveResponse
        SaveResponse --> ScanDirs
        ScanDirs -- нет файлов --> End_CA
    end

    subgraph make_summary.py
        Start_MS[Начало make_summary.py]
        SetStartDir[Установка начальной директории]
        RecursiveScan[Рекурсивное сканирование директории]
        FilterFiles[Фильтрация файлов по языку]
        CreateSummary[Создание файла SUMMARY.md]
        End_MS[Конец make_summary.py]
        Start_MS --> SetStartDir
        SetStartDir --> RecursiveScan
        RecursiveScan --> FilterFiles
        FilterFiles --> CreateSummary
        CreateSummary --> End_MS
    end

    subgraph onela_bot.py
        Start_Bot[Начало onela_bot.py]
        InitBot[Инициализация Telegram-бота]
        WaitForMsg[Ожидание сообщений от пользователя]
        ProcessMsg[Обработка сообщения/команды]
         Call_code_assistant[Вызов code_assistant.py]
        SendAnswer[Отправка ответа пользователю]
        End_Bot[Конец onela_bot.py]
        Start_Bot --> InitBot
         InitBot --> WaitForMsg
        WaitForMsg --> ProcessMsg
          ProcessMsg --> Call_code_assistant
         Call_code_assistant --> SendAnswer
        SendAnswer --> WaitForMsg
    end

    ProcessMsg --> bot_handlers[<code>bot_handlers.py</code><br>Handlers for Bot Commands and Messages]

    linkStyle default stroke:#333,stroke-width:2px;
```

**Объяснение зависимостей:**

-   Диаграмма показывает три основных скрипта: `code_assistant.py`, `make_summary.py` и `onela_bot.py`.
-   `code_assistant.py`:
    -   Начинается с загрузки настроек.
    -   Сканирует указанные директории в поисках файлов `.py` и `README.md`.
    -   Читает содержимое файлов, загружает промпты на основе роли и языка.
    -   Отправляет данные в модели Gemini или OpenAI.
    -   Сохраняет результаты.
-   `make_summary.py`:
    -   Устанавливает начальную директорию и сканирует ее рекурсивно.
    -   Фильтрует файлы по языку и создает `SUMMARY.md`.
-   `onela_bot.py`:
    -   Инициализирует Telegram-бота и ожидает сообщений от пользователя.
    -   Передает обработку сообщения в `bot_handlers.py`.
    -   Может вызывать `code_assistant.py` для обработки кода.
-   `bot_handlers.py`:
    -   Обрабатывает команды бота.

### 3. <объяснение>

**Импорты:**

В тексте `README.md` не указаны конкретные импорты, но исходя из контекста можно предположить следующие:

-   **`code_assistant.py`:**
    -   `os` для работы с файловой системой.
    -   `json` для обработки JSON настроек.
    -   `argparse` для обработки аргументов командной строки.
    -   `logging` для логирования работы скрипта.
    -   API-библиотеки для работы с Gemini и OpenAI.
    -   Модули из `src`, например, `src.ai.prompts` для загрузки промптов.
    -   Вероятно, модуль для работы с исключениями.
    -   Модули для обработки данных, например, `regex`.
-   **`make_summary.py`:**
    -   `os` для работы с файловой системой.
    -   `re` для обработки регулярных выражений.
-   **`onela_bot.py` и `bot_handlers.py`:**
    -   `telebot` или другая библиотека для Telegram-ботов.
    -   Импорты из `code_assistant.py` для работы с кодом.
    -   `logging`.
    -   Вероятно, `json` для настроек.

**Классы:**

В представленном тексте `README.md` нет явного описания классов. Но на основе описания функциональности можно предположить наличие следующих классов:

-   **В `code_assistant.py`:**
    -   Классы для представления моделей (например, `GeminiModel` и `OpenAIModel`) для инкапсуляции логики взаимодействия с API.
    -   Класс для обработки файлов, который бы реализовывал чтение файлов, извлечение текста и другие необходимые действия.
    -   Класс для загрузки и обработки промптов.
    -   Класс для логирования.
-   **В `onela_bot.py` и `bot_handlers.py`:**
    -   Класс для управления Telegram-ботом.
    -   Классы-обработчики команд.

**Функции:**

-   **`code_assistant.py`:**
    -   `main()`: Основная функция, управляющая работой скрипта.
    -   Функции для чтения файлов: `read_file(path)`, `get_files(dir_path)`
    -   Функция для загрузки промптов: `load_prompt(role, lang)`.
    -   Функция для отправки запроса в модель: `send_request_to_model(model, code, prompt)`.
    -   Функция для сохранения ответа: `save_response(response, path)`.
    -   Функции для логирования.
-   **`make_summary.py`:**
    -   Функция для рекурсивного поиска файлов `recursive_scan(dir_path)`
    -   Функция для создания файла `SUMMARY.md`: `create_summary(start_dir, lang)`.
-   **`onela_bot.py`:**
    -   `main()`: Основная функция запуска бота.
    -   Функция для обработки сообщений: `handle_message(message)`.
    -   Функция для инициализации бота: `init_bot()`.
-   **`bot_handlers.py`:**
    -   Функции-обработчики команд: `handle_doc_command(message)`, `handle_review_command(message)`.

**Переменные:**

-   **`code_assistant.py`:**
    -   `settings`: Словарь с настройками.
    -   `role`: Роль для модели ИИ.
    -   `lang`: Язык для модели.
    -   `models`: Список моделей для использования.
    -   `start_dirs`: Список начальных директорий для обработки.
    -   `exclude_file_patterns`: Список регулярных выражений для исключения файлов.
    -   `exclude_dirs`: Список директорий для исключения.
    -   `exclude_files`: Список файлов для исключения.
    -   `logger`: Объект для логирования.
-    **`make_summary.py`:**
    -   `start_dir`: Путь к начальной директории.
    -   `lang`: Язык для фильтрации файлов.
-   **`onela_bot.py` и `bot_handlers.py`:**
    -   `bot`: Объект для Telegram-бота.
    -   `api_key`: API-ключ для Telegram-бота.

**Потенциальные ошибки и области для улучшения:**

-   **Обработка ошибок:** Не указано, как обрабатываются ошибки при обращении к API моделей или при чтении файлов.
-   **Асинхронность:** Не указано, используются ли асинхронные операции для параллельной работы с файлами и моделями, что могло бы ускорить работу скриптов.
-   **Конфигурирование:** Возможность динамической конфигурации параметров (например, через переменные среды).
-   **Гибкость:** Возможность расширения функциональности без изменения исходного кода.

**Взаимосвязь с другими частями проекта:**

-   **`src.ai.prompts`**: Используются для загрузки промптов для разных ролей.
-   **`src.instructions`**: Содержат инструкции для команд, используемых в боте.
-   **`src.translations`**: Содержат переводы для различных ролей и языков.
-   **API-библиотеки**: Зависят от библиотек Gemini и OpenAI для взаимодействия с моделями.
-   **`src`**: Логика работы с файлами и моделями является частью `src`, что указывает на общую структуру проекта.

В целом, модуль `code_assistant` предоставляет необходимый набор инструментов для обработки кода, взаимодействия с моделями ИИ и создания документации, а также включает Telegram-бота для удобного управления процессом.