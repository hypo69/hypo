# Модуль API для взаимодействия с GPT4Free

## Обзор

Модуль `api.py` предоставляет API для взаимодействия с различными провайдерами GPT4Free. Он содержит классы и функции для получения списка моделей, провайдеров, версий, обработки изображений, создания потоков ответов и форматирования JSON.

## Подробнее

Этот модуль является частью GUI-сервера и отвечает за обработку запросов к API. Он использует различные классы и функции из других модулей проекта, таких как `errors`, `image`, `tools`, `Provider`, `providers`, `version` и `models`.

## Классы

### `Api`

**Описание**: Класс `Api` предоставляет статические методы для получения информации о моделях и провайдерах, а также методы для обработки запросов и создания потоков ответов.

**Методы**:

- `get_models()`: Возвращает список доступных моделей.
- `get_provider_models(provider: str, api_key: str = None, api_base: str = None)`: Возвращает список моделей, поддерживаемых указанным провайдером.
- `get_providers()`: Возвращает список доступных провайдеров.
- `get_version()`: Возвращает информацию о текущей и последней версиях.
- `serve_images(name)`: Возвращает запрошенное изображение.
- `_prepare_conversation_kwargs(json_data: dict)`: Подготавливает аргументы для создания разговора.
- `_create_response_stream(kwargs: dict, conversation_id: str, provider: str, download_media: bool = True)`: Создает поток ответов.
- `_yield_logs()`: Возвращает логи.
- `_format_json(response_type: str, content = None, **kwargs)`: Форматирует данные в формат JSON.
- `handle_provider(provider_handler, model)`: Обрабатывает информацию о провайдере.

## Функции

### `get_error_message`

```python
def get_error_message(exception: Exception) -> str:
    """Возвращает сообщение об ошибке из исключения.

    Args:
        exception (Exception): Исключение, из которого нужно получить сообщение об ошибке.

    Returns:
        str: Строка с именем типа исключения и сообщением исключения.

    Как работает функция:
     1. Функция принимает объект исключения `exception`.
     2. Извлекает имя класса исключения с помощью `type(exception).__name__`.
     3. Извлекает сообщение исключения, которое содержит дополнительную информацию об ошибке.
     4. Форматирует строку, объединяя имя класса исключения и сообщение исключения через двоеточие и пробел.

    Примеры:
        >>> get_error_message(ValueError("Invalid value"))
        'ValueError: Invalid value'
        >>> get_error_message(TypeError("Incorrect type"))
        'TypeError: Incorrect type'
    """
    ...
```

**Назначение**: Форматирование сообщения об ошибке на основе перехваченного исключения.

**Параметры**:

- `exception` (Exception): Объект исключения, для которого требуется получить сообщение об ошибке.

**Возвращает**:

- `str`: Отформатированное сообщение об ошибке, включающее тип исключения и сообщение.

**Как работает функция**:

1.  **Прием исключения**: Функция принимает объект исключения в качестве аргумента.
2.  **Извлечение типа исключения**: Получает имя класса исключения с помощью `type(exception).__name__`.
3.  **Формирование сообщения**: Создает строку, объединяющую имя класса исключения и сообщение исключения, разделенные двоеточием и пробелом.

```
      Прием исключения
      │
      │ Получение имени класса исключения
      │
      │  Формирование сообщения об ошибке
      │
      │ Возврат отформатированного сообщения
```

**Примеры**:

```python
# Пример 1: Обработка исключения ValueError
try:
    value = int("abc")
except ValueError as ex:
    error_message = get_error_message(ex)
    print(error_message)

# Пример 2: Обработка исключения TypeError
try:
    result = 1 + "a"
except TypeError as ex:
    error_message = get_error_message(ex)
    print(error_message)
```

## Методы класса `Api`

### `get_models`

```python
@staticmethod
def get_models():
    """Возвращает список доступных моделей.

    Returns:
        list: Список словарей, каждый из которых содержит информацию о модели.
    """
    ...
```

**Назначение**: Получение списка доступных моделей.

**Возвращает**:

- `list`: Список словарей, каждый из которых содержит информацию о модели, включая имя, тип (изображение, зрение) и список провайдеров.

### `get_provider_models`

```python
@staticmethod
def get_provider_models(provider: str, api_key: str = None, api_base: str = None):
    """Возвращает список моделей, поддерживаемых указанным провайдером.

    Args:
        provider (str): Имя провайдера.
        api_key (str, optional): API ключ. Defaults to None.
        api_base (str, optional): Базовый URL API. Defaults to None.

    Returns:
        list: Список словарей, каждый из которых содержит информацию о модели, поддерживаемой провайдером.
    """
    ...
```

**Назначение**: Получение списка моделей, поддерживаемых указанным провайдером.

**Параметры**:

- `provider` (str): Имя провайдера.
- `api_key` (str, optional): API ключ. По умолчанию `None`.
- `api_base` (str, optional): Базовый URL API. По умолчанию `None`.

**Возвращает**:

- `list`: Список словарей, каждый из которых содержит информацию о модели, включая имя модели, является ли она моделью по умолчанию, поддерживает ли она зрение, изображение и задачу.

### `get_providers`

```python
@staticmethod
def get_providers() -> dict[str, str]:
    """Возвращает список доступных провайдеров.

    Returns:
        dict[str, str]: Список словарей, каждый из которых содержит информацию о провайдере.
    """
    ...
```

**Назначение**: Получение списка доступных провайдеров.

**Возвращает**:

- `dict[str, str]`: Список словарей, каждый из которых содержит информацию о провайдере, включая имя, метку, родительский провайдер, поддержку изображений и зрения, необходимость использования драйвера, наличие пространства HF, необходимость аутентификации и URL для входа.

### `get_version`

```python
@staticmethod
def get_version() -> dict:
    """Возвращает информацию о текущей и последней версиях.

    Returns:
        dict: Словарь, содержащий информацию о текущей и последней версиях.
    """
    ...
```

**Назначение**: Получение информации о текущей и последней версиях.

**Возвращает**:

- `dict`: Словарь, содержащий информацию о текущей и последней версиях.

### `serve_images`

```python
def serve_images(self, name):
    """Возвращает запрошенное изображение.

    Args:
        name (str): Имя файла изображения.

    Returns:
        flask.Response: Ответ Flask с изображением.
    """
    ...
```

**Назначение**: Предоставление доступа к изображениям.

**Параметры**:

- `name` (str): Имя файла изображения.

**Возвращает**:

- `flask.Response`: Ответ Flask с изображением.

### `_prepare_conversation_kwargs`

```python
def _prepare_conversation_kwargs(self, json_data: dict):
    """Подготавливает аргументы для создания разговора.

    Args:
        json_data (dict): JSON данные запроса.

    Returns:
        dict: Словарь с подготовленными аргументами для создания разговора.
    """
    ...
```

**Назначение**: Подготовка аргументов для создания разговора на основе JSON-данных.

**Параметры**:

- `json_data` (dict): JSON данные запроса.

**Возвращает**:

- `dict`: Словарь с подготовленными аргументами для создания разговора, включая модель, провайдер, сообщения, параметры потоковой передачи и информацию о разговоре.

### `_create_response_stream`

```python
def _create_response_stream(self, kwargs: dict, conversation_id: str, provider: str, download_media: bool = True) -> Iterator:
    """Создает поток ответов.

    Args:
        kwargs (dict): Аргументы для создания потока ответов.
        conversation_id (str): ID разговора.
        provider (str): Имя провайдера.
        download_media (bool, optional): Флаг для скачивания медиа. Defaults to True.

    Yields:
        Iterator: Итератор с ответами.
    """
    ...
```

**Назначение**: Создание потока ответов от модели.

**Параметры**:

- `kwargs` (dict): Аргументы для создания потока ответов, содержащие параметры модели, провайдера, сообщения и другие настройки.
- `conversation_id` (str): ID разговора.
- `provider` (str): Имя провайдера.
- `download_media` (bool, optional): Флаг, указывающий, нужно ли скачивать медиафайлы. По умолчанию `True`.

**Yields**:

- `Iterator`: Итератор, выдающий ответы в виде различных типов данных, таких как информация о провайдере, идентификатор разговора, сообщения, предварительный просмотр, медиаконтент и логи.

### `_yield_logs`

```python
def _yield_logs(self):
    """Возвращает логи.

    Yields:
        dict: Словарь с логами.
    """
    ...
```

**Назначение**: Предоставление доступа к логам.

**Yields**:

- `dict`: Словарь с логами.

### `_format_json`

```python
def _format_json(self, response_type: str, content = None, **kwargs):
    """Форматирует данные в формат JSON.

    Args:
        response_type (str): Тип ответа.
        content (Any, optional): Содержимое ответа. Defaults to None.

    Returns:
        dict: Словарь в формате JSON.
    """
    ...
```

**Назначение**: Форматирование данных в формат JSON для отправки в качестве ответа API.

**Параметры**:

- `response_type` (str): Тип ответа, например, "content", "error", "provider" и т.д.
- `content` (Any, optional): Содержимое ответа, которое будет включено в JSON. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые будут включены в JSON.

**Возвращает**:

- `dict`: Словарь, отформатированный в виде JSON, содержащий тип ответа, содержимое (если есть) и любые дополнительные параметры.

### `handle_provider`

```python
def handle_provider(self, provider_handler, model):
    """Обрабатывает информацию о провайдере.

    Args:
        provider_handler (BaseProvider): Обработчик провайдера.
        model (str): Имя модели.

    Returns:
        dict: Словарь с информацией о провайдере.
    """
    ...
```

**Назначение**: Обработка информации о провайдере и форматирование ее в JSON.

**Параметры**:

- `provider_handler` (BaseProvider): Обработчик провайдера, содержащий информацию о провайдере.
- `model` (str): Имя модели, используемой провайдером.

**Возвращает**:

- `dict`: Словарь с информацией о провайдере, включая его имя, модель и другие параметры, отформатированный в виде JSON.