# Модуль для работы с JSON и SimpleNamespace

## Обзор

Модуль `jjson` предоставляет функции для работы с данными в формате JSON, включая чтение, запись, преобразование и обработку ошибок. Он предназначен для упрощения работы с JSON-данными, особенно в контексте конфигурационных файлов и обмена данными между компонентами системы. Модуль включает функции для загрузки JSON из файлов, строк и объектов, а также для сохранения JSON в файлы. Поддерживается работа с `SimpleNamespace` для удобного доступа к данным через атрибуты.

## Подробней

Модуль содержит функции для чтения, записи и преобразования JSON-данных. Он также обрабатывает различные типы входных данных, такие как строки, пути к файлам и объекты `SimpleNamespace`. Основная цель модуля - предоставить удобный и надежный способ работы с JSON-данными в проекте `hypotez`.

Функции `j_loads` и `j_dumps` обеспечивают удобный интерфейс для загрузки и сохранения JSON-данных, автоматически обрабатывая ошибки и поддерживая различные режимы работы. Функция `j_loads_ns` дополнительно преобразует загруженные данные в объекты `SimpleNamespace`, что упрощает доступ к данным через атрибуты.

## Классы

### `Config`

**Описание**:
Класс, содержащий константы для режимов записи файлов.

**Методы**:
- `MODE_WRITE`: Режим записи "w".
- `MODE_APPEND_START`: Режим добавления в начало файла "a+".
- `MODE_APPEND_END`: Режим добавления в конец файла "+a".

**Примеры**:
```python
from src.utils.jjson import Config

print(Config.MODE_WRITE)
print(Config.MODE_APPEND_START)
print(Config.MODE_APPEND_END)
```

## Функции

### `_convert_to_dict`

```python
def _convert_to_dict(value: Any) -> Any:
    """
    Args:
        value (Any): Входное значение, которое может быть `SimpleNamespace`, словарем или списком.

    Returns:
        Any: Преобразованное значение в виде словаря или списка словарей.

    **Как работает функция**:
    Функция рекурсивно преобразует объекты `SimpleNamespace` и списки в словари, чтобы обеспечить совместимость с JSON.
    Если входное значение является `SimpleNamespace`, оно преобразуется в словарь, где ключи - это атрибуты объекта, а значения рекурсивно преобразуются.
    Если входное значение является словарем, его значения рекурсивно преобразуются.
    Если входное значение является списком, каждый элемент списка рекурсивно преобразуется.

    """
```

**Описание**: Преобразует объекты `SimpleNamespace` и списки в словари.

**Параметры**:
- `value` (Any): Входное значение, которое может быть `SimpleNamespace`, словарем или списком.

**Возвращает**:
- `Any`: Преобразованное значение в виде словаря или списка словарей.

### `_read_existing_data`

```python
def _read_existing_data(path: Path, exc_info: bool = True) -> dict:
    """
    Args:
        path (Path): Путь к файлу, из которого нужно прочитать JSON данные.
        exc_info (bool, optional): Флаг, определяющий, нужно ли логировать исключения с трассировкой. По умолчанию `True`.

    Returns:
        dict: Словарь с данными из JSON файла или пустой словарь в случае ошибки.

    Raises:
        json.JSONDecodeError: Если не удается декодировать JSON из файла.
        Exception: При возникновении любой другой ошибки при чтении файла.

    **Как работает функция**:
    Функция пытается прочитать JSON данные из файла, указанного в параметре `path`.
    Если файл не существует или содержит некорректный JSON, функция логирует ошибку и возвращает пустой словарь.
    Используется `json.loads` для преобразования содержимого файла в словарь.

    """
```

**Описание**: Читает существующие JSON данные из файла.

**Параметры**:
- `path` (Path): Путь к файлу.
- `exc_info` (bool, optional): Флаг, определяющий, нужно ли логировать исключения с трассировкой. По умолчанию `True`.

**Возвращает**:
- `dict`: Словарь с данными из JSON файла или пустой словарь в случае ошибки.

### `_merge_data`

```python
def _merge_data(
    data: Dict, existing_data: Dict, mode: str
) -> Dict:
    """
    Args:
        data (Dict): Новые данные для объединения.
        existing_data (Dict): Существующие данные, с которыми нужно объединить новые данные.
        mode (str): Режим объединения данных (`Config.MODE_APPEND_START` или `Config.MODE_APPEND_END`).

    Returns:
        Dict: Объединенные данные в виде словаря.

    Raises:
        Exception: При возникновении ошибки во время объединения данных.

    **Как работает функция**:
    Функция объединяет новые данные (`data`) с существующими данными (`existing_data`) в зависимости от указанного режима (`mode`).
    Если `mode` равен `Config.MODE_APPEND_START`, новые данные добавляются в начало существующих данных (если это списки) или обновляют существующие данные (если это словари).
    Если `mode` равен `Config.MODE_APPEND_END`, новые данные добавляются в конец существующих данных (если это списки) или существующие данные обновляют новые данные (если это словари).
    Если возникает ошибка во время объединения, функция логирует ошибку и возвращает пустой словарь.

    """
```

**Описание**: Объединяет новые данные с существующими данными на основе режима.

**Параметры**:
- `data` (Dict): Новые данные для объединения.
- `existing_data` (Dict): Существующие данные.
- `mode` (str): Режим объединения (`Config.MODE_APPEND_START` или `Config.MODE_APPEND_END`).

**Возвращает**:
- `Dict`: Объединенные данные в виде словаря.

### `j_dumps`

```python
def j_dumps(
    data: Union[Dict, SimpleNamespace, List[Dict], List[SimpleNamespace]],
    file_path: Optional[Path] = None,
    ensure_ascii: bool = False,
    mode: str = Config.MODE_WRITE,
    exc_info: bool = True,
) -> Optional[Dict]:
    """
    Args:
        data (Dict | SimpleNamespace | List[Dict] | List[SimpleNamespace]): Данные для записи в формате JSON или объекты `SimpleNamespace`.
        file_path (Optional[Path], optional): Путь к файлу для записи. Если `None`, возвращает JSON как словарь. По умолчанию `None`.
        ensure_ascii (bool, optional): Если `True`, экранирует не-ASCII символы в выводе. По умолчанию `False`.
        mode (str, optional): Режим открытия файла (`'w'`, `'a+'`, `'+a'`). По умолчанию `'w'`.
        exc_info (bool, optional): Если `True`, логирует исключения с трассировкой. По умолчанию `True`.

    Returns:
        Optional[Dict]: JSON данные в виде словаря при успехе или `None` в случае ошибки.

    Raises:
        ValueError: Если указан неподдерживаемый режим файла.

    **Как работает функция**:
    Функция записывает JSON данные в файл или возвращает их в виде словаря.
    Если `file_path` указан, данные записываются в файл в указанном режиме (`mode`).
    Если `file_path` не указан, данные возвращаются в виде словаря.
    Поддерживаются различные типы входных данных, такие как словари, объекты `SimpleNamespace` и списки.
    Функция также обрабатывает ошибки записи и логирует их.

    """
```

**Описание**: Записывает JSON данные в файл или возвращает JSON данные как словарь.

**Параметры**:
- `data` (Dict | SimpleNamespace | List[Dict] | List[SimpleNamespace]): Данные для записи.
- `file_path` (Optional[Path], optional): Путь к файлу. Если `None`, возвращает JSON как словарь. По умолчанию `None`.
- `ensure_ascii` (bool, optional): Если `True`, экранирует не-ASCII символы в выводе. По умолчанию `False`.
- `mode` (str, optional): Режим открытия файла (`'w'`, `'a+'`, `'+a'`). По умолчанию `'w'`.
- `exc_info` (bool, optional): Если `True`, логирует исключения с трассировкой. По умолчанию `True`.

**Возвращает**:
- `Optional[Dict]`: JSON данные в виде словаря при успехе или `None` в случае ошибки.

### `_decode_strings`

```python
def _decode_strings(data: Any) -> Any:
    """
    Args:
        data (Any): Входные данные, которые могут быть строкой, списком или словарем.

    Returns:
        Any: Данные с декодированными строками.

    Raises:
        Exception: Если не удается декодировать строку.

    **Как работает функция**:
    Функция рекурсивно декодирует строки в структуре данных.
    Если входные данные являются строкой, функция пытается декодировать ее с использованием кодека `unicode_escape`.
    Если входные данные являются списком, функция рекурсивно декодирует каждый элемент списка.
    Если входные данные являются словарем, функция рекурсивно декодирует каждый ключ и значение словаря.
    Если входные данные не являются строкой, списком или словарем, функция возвращает их без изменений.

    """
```

**Описание**: Рекурсивно декодирует строки в структуре данных.

**Параметры**:
- `data` (Any): Входные данные, которые могут быть строкой, списком или словарем.

**Возвращает**:
- `Any`: Данные с декодированными строками.

### `_string_to_dict`

```python
def _string_to_dict(json_string: str) -> dict:
    """
    Args:
        json_string (str): Строка в формате JSON.

    Returns:
        dict: Словарь, полученный из JSON строки.

    Raises:
        json.JSONDecodeError: Если не удается распарсить JSON строку.

    **Как работает функция**:
    Функция преобразует JSON строку в словарь.
    Сначала удаляются markdown кавычки (если они есть) из начала и конца строки.
    Затем строка парсится с помощью `json.loads`.
    Если возникает ошибка при парсинге, функция логирует ошибку и возвращает пустой словарь.

    """
```

**Описание**: Удаляет markdown кавычки и парсит JSON строку.

**Параметры**:
- `json_string` (str): Строка в формате JSON.

**Возвращает**:
- `dict`: Словарь, полученный из JSON строки.

### `j_loads`

```python
def j_loads(
    jjson: Union[dict, SimpleNamespace, str, Path, list], ordered: bool = True
) -> Union[dict, list]:
    """
    Args:
        jjson (dict | SimpleNamespace | str | Path | list): Путь к файлу/директории, JSON строка или JSON объект.
        ordered (bool, optional): Использовать `OrderedDict` для сохранения порядка элементов. По умолчанию `True`.

    Returns:
        dict | list: Обработанные данные (словарь или список словарей).

    Raises:
        FileNotFoundError: Если указанный файл не найден.
        json.JSONDecodeError: Если не удается распарсить JSON данные.

    **Как работает функция**:
    Функция загружает JSON или CSV данные из файла, директории, строки или объекта.
    Поддерживаются различные типы входных данных, такие как словари, объекты `SimpleNamespace`, строки и пути к файлам.
    Если `jjson` является путем к директории, функция загружает все JSON файлы из этой директории.
    Если `jjson` является строкой, функция пытается распарсить ее как JSON.
    Если `jjson` является объектом `SimpleNamespace`, он преобразуется в словарь.
    Функция также обрабатывает ошибки загрузки и парсинга и логирует их.

    """
```

**Описание**: Загружает JSON или CSV данные из файла, директории, строки или объекта.

**Параметры**:
- `jjson` (dict | SimpleNamespace | str | Path | list): Путь к файлу/директории, JSON строка или JSON объект.
- `ordered` (bool, optional): Использовать `OrderedDict` для сохранения порядка элементов. По умолчанию `True`.

**Возвращает**:
- `dict | list`: Обработанные данные (словарь или список словарей).

### `j_loads_ns`

```python
def j_loads_ns(
    jjson: Union[Path, SimpleNamespace, Dict, str], ordered: bool = True
) -> Union[SimpleNamespace, List[SimpleNamespace], Dict]:
    """
    Args:
        jjson (Path | SimpleNamespace | Dict | str): Путь к файлу, объект `SimpleNamespace`, словарь или строка с JSON.
        ordered (bool, optional): Использовать OrderedDict для сохранения порядка элементов. По умолчанию True.

    Returns:
        Union[SimpleNamespace, List[SimpleNamespace], Dict]: Данные в виде `SimpleNamespace`, списка `SimpleNamespace` или словаря.

    **Как работает функция**:
    Функция загружает JSON/CSV данные и преобразует их в `SimpleNamespace`.
    Сначала данные загружаются с помощью функции `j_loads`.
    Затем, если данные являются списком, каждый элемент списка преобразуется в `SimpleNamespace`.
    Если данные являются словарем, они преобразуются в `SimpleNamespace`.
    Если данные не удалось загрузить, функция возвращает пустой словарь.

    """
```

**Описание**: Загружает JSON/CSV данные и преобразует в `SimpleNamespace`.

**Параметры**:
- `jjson` (Path | SimpleNamespace | Dict | str): Путь к файлу, объект `SimpleNamespace`, словарь или строка с JSON.
- `ordered` (bool, optional): Использовать OrderedDict для сохранения порядка элементов. По умолчанию `True`.

**Возвращает**:
- `Union[SimpleNamespace, List[SimpleNamespace], Dict]`: Данные в виде `SimpleNamespace`, списка `SimpleNamespace` или словаря.