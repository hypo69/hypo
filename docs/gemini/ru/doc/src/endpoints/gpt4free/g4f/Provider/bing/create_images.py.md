# Модуль для создания изображений с использованием Bing Image Creator

## Обзор

Этот модуль содержит функции для создания изображений на основе текстового запроса с использованием сервиса Bing Image Creator. Он включает в себя функции для установления сессии с Bing, отправки запроса на создание изображений и извлечения URL-адресов сгенерированных изображений из HTML-контента.

## Подробнее

Модуль предназначен для автоматизации процесса создания изображений с использованием Bing Image Creator. Он обеспечивает взаимодействие с сервисом через HTTP-запросы, обрабатывает ответы и извлекает URL-адреса сгенерированных изображений.

## Функции

### `create_session`

```python
def create_session(cookies: Dict[str, str], proxy: str = None, connector: BaseConnector = None) -> ClientSession:
    """
    Создает новую клиентскую сессию с указанными файлами cookie и заголовками.

    Args:
        cookies (Dict[str, str]): Файлы cookie, которые будут использоваться для сеанса.
        proxy (str, optional): Адрес прокси-сервера для использования в сессии. По умолчанию `None`.
        connector (BaseConnector, optional): Коннектор для клиентской сессии. По умолчанию `None`.

    Returns:
        ClientSession: Созданная клиентская сессия.
    """
    ...
```

**Назначение**:
Функция `create_session` создает новую клиентскую сессию `aiohttp.ClientSession` с заданными параметрами, такими как cookies, proxy и headers.

**Параметры**:
- `cookies` (Dict[str, str]): Словарь, содержащий cookie для установки в заголовках сессии.
- `proxy` (str, optional): URL прокси-сервера для использования в сессии. По умолчанию `None`.
- `connector` (BaseConnector, optional): Объект коннектора `aiohttp` для управления соединениями. По умолчанию `None`.

**Возвращает**:
- `ClientSession`: Объект клиентской сессии `aiohttp` с настроенными заголовками и коннектором.

**Как работает функция**:

1. Функция определяет набор заголовков `headers`, которые будут использоваться для всех запросов в рамках сессии. Эти заголовки включают информацию о типе принимаемого контента, кодировке, языке, политике referrer, User-Agent и другие параметры, необходимые для корректного взаимодействия с сервером Bing.
2. Если переданы cookies, они добавляются к заголовкам в формате строки, где каждый cookie представлен в виде `ключ=значение`, разделенных символом `; `.
3. Функция вызывает `get_connector` для получения или создания коннектора на основе переданных параметров `connector` и `proxy`. Это позволяет использовать прокси-сервер для выполнения запросов, если это необходимо.
4. Создается и возвращается объект `ClientSession` с настроенными заголовками и коннектором. Этот объект затем используется для выполнения HTTP-запросов к сервису Bing.

**Примеры**:

```python
# Пример создания сессии без прокси и с cookies
cookies = {"cookie1": "value1", "cookie2": "value2"}
session = create_session(cookies=cookies)

# Пример создания сессии с прокси
session = create_session(cookies={}, proxy="http://user:pass@host:port")
```

### `create_images`

```python
async def create_images(session: ClientSession, prompt: str, timeout: int = TIMEOUT_IMAGE_CREATION) -> List[str]:
    """
    Создает изображения на основе заданного запроса с использованием службы Bing.

    Args:
        session (ClientSession): Активная клиентская сессия.
        prompt (str): Запрос для создания изображений.
        timeout (int): Время ожидания для запроса. По умолчанию TIMEOUT_IMAGE_CREATION.

    Returns:
        List[str]: Список URL-адресов созданных изображений.

    Raises:
        MissingRequirementsError: Если отсутствует библиотека "beautifulsoup4".
        RateLimitError: Если закончились монеты.
        RuntimeError: Если создание изображения не удалось или истекло время ожидания.
    """
    ...
```

**Назначение**:
Функция `create_images` асинхронно создает изображения на основе заданного текстового запроса, используя сервис Bing Image Creator.

**Параметры**:
- `session` (ClientSession): Активная клиентская сессия `aiohttp`.
- `prompt` (str): Текстовый запрос для генерации изображений.
- `timeout` (int, optional): Максимальное время ожидания для процесса создания изображений в секундах. По умолчанию `TIMEOUT_IMAGE_CREATION`.

**Возвращает**:
- `List[str]`: Список URL-адресов сгенерированных изображений.

**Вызывает исключения**:
- `MissingRequirementsError`: Если отсутствует библиотека `beautifulsoup4`.
- `RateLimitError`: Если у аккаунта закончились "монеты" для создания изображений.
- `RuntimeError`: Если во время создания изображений произошла ошибка, например, таймаут, блокировка запроса или другие проблемы.

**Как работает функция**:

1. **Проверка зависимостей**:
   - Функция проверяет, установлена ли библиотека `beautifulsoup4`, необходимая для обработки HTML-контента. Если библиотека отсутствует, вызывается исключение `MissingRequirementsError`.

2. **Кодирование запроса**:
   - Текстовый запрос `prompt` кодируется с использованием `urllib.parse.quote` для безопасной передачи в URL.

3. **Отправка POST-запроса**:
   - Функция отправляет POST-запрос к сервису Bing Image Creator по адресу `/images/create` с закодированным запросом в качестве параметра `q`.
   - В теле запроса передается полезная нагрузка `payload` с параметрами `q` (закодированный запрос), `rt=4` и `FORM=GENCRE`.
   - Устанавливается `allow_redirects=False`, чтобы перехватить перенаправление и обработать его самостоятельно.
   - Устанавливается таймаут для запроса.

4. **Обработка ответа**:
   - Функция проверяет статус ответа. Если статус не 302 (перенаправление), выполняется повторная попытка запроса с `rt=3`.
   - Если в тексте ответа содержится сообщение об отсутствии доступных "монет", вызывается исключение `RateLimitError`.
   - Если в тексте ответа содержатся сообщения об ошибках, связанных с блокировкой запроса или другими проблемами, вызывается исключение `RuntimeError`.

5. **Получение URL перенаправления**:
   - Из заголовка `Location` ответа извлекается URL перенаправления, который содержит идентификатор запроса.

6. **Опрос сервиса для получения результатов**:
   - Функция выполняет цикл опроса сервиса по адресу `/images/create/async/results/{request_id}` с использованием полученного идентификатора запроса.
   - Опрос выполняется до тех пор, пока не будет получен ответ, содержащий HTML-контент с URL-адресами изображений.
   - Если время ожидания превышает заданный таймаут, вызывается исключение `RuntimeError`.
   - Если статус ответа не 200, вызывается исключение `RuntimeError`.

7. **Обработка ошибок в ответе**:
   - Функция пытается извлечь сообщение об ошибке из JSON-ответа.
   - Если извлеченное сообщение об ошибке равно "Pending", вызывается исключение `RuntimeError` с сообщением о блокировке запроса.
   - Если извлечено любое другое сообщение об ошибке, вызывается исключение `RuntimeError` с этим сообщением.

8. **Извлечение URL-адресов изображений**:
   - Функция вызывает `read_images` для извлечения URL-адресов сгенерированных изображений из полученного HTML-контента.

9. **Возврат URL-адресов изображений**:
   - Функция возвращает список URL-адресов сгенерированных изображений.

**Примеры**:

```python
# Пример создания изображений с использованием активной сессии
async def main():
    async with ClientSession() as session:
        image_urls = await create_images(session, "a cat in space")
        print(image_urls)

asyncio.run(main())
```

### `read_images`

```python
def read_images(html_content: str) -> List[str]:
    """
    Извлекает URL-адреса изображений из HTML-контента.

    Args:
        html_content (str): HTML-контент, содержащий URL-адреса изображений.

    Returns:
        List[str]: Список URL-адресов изображений.

    Raises:
        RuntimeError: Если не удалось найти изображения или найдены плохие изображения.
    """
    ...
```

**Назначение**:
Функция `read_images` извлекает URL-адреса изображений из предоставленного HTML-контента, используя библиотеку `BeautifulSoup`.

**Параметры**:
- `html_content` (str): Строка, содержащая HTML-контент, из которого нужно извлечь URL-адреса изображений.

**Возвращает**:
- `List[str]`: Список URL-адресов изображений, извлеченных из HTML-контента.

**Вызывает исключения**:
- `RuntimeError`: Если в HTML-контенте не найдены изображения или если найдены URL-адреса, содержащиеся в списке `BAD_IMAGES`.

**Как работает функция**:

1. **Разбор HTML**:
   - Функция использует `BeautifulSoup` для разбора HTML-контента.

2. **Поиск тегов изображений**:
   - Функция пытается найти все теги `img` с классами `mimg` или `gir_mmimg`. Эти классы используются Bing Image Creator для обертки изображений.

3. **Извлечение URL-адресов**:
   - Для каждого найденного тега `img` функция извлекает значение атрибута `src`, который содержит URL-адрес изображения.
   - Извлеченные URL-адреса обрезаются, чтобы удалить параметры ширины (`?w=`) и получить базовый URL-адрес изображения.

4. **Проверка на "плохие" изображения**:
   - Функция проверяет, содержит ли какой-либо из извлеченных URL-адресов подстроку из списка `BAD_IMAGES`. Если "плохое" изображение найдено, вызывается исключение `RuntimeError`.

5. **Проверка наличия изображений**:
   - Функция проверяет, был ли найден хотя бы один URL-адрес изображения. Если список `images` пуст, вызывается исключение `RuntimeError`.

6. **Возврат URL-адресов**:
   - Функция возвращает список извлеченных URL-адресов изображений.

**Примеры**:

```python
# Пример извлечения URL-адресов изображений из HTML-контента
html_content = """
<div class="image-container">
    <img class="mimg" src="https://example.com/image1.jpg?w=300">
    <img class="mimg" src="https://example.com/image2.jpg?w=300">
</div>
"""
image_urls = read_images(html_content)
print(image_urls)
# Вывод: ['https://example.com/image1.jpg', 'https://example.com/image2.jpg']