# Модуль для работы с Telegram ботом через FastAPI и RPC
## Обзор

Модуль `telegram_webhooks.py` предоставляет реализацию Telegram-бота, интегрированного с сервером FastAPI через RPC (Remote Procedure Call). Он позволяет обрабатывать входящие сообщения от Telegram и взаимодействовать с другими частями системы через удаленные вызовы процедур.
В модуле реализован класс `TelegramBot`, который отвечает за управление ботом, настройку обработчиков команд и сообщений, а также за взаимодействие с FastAPI сервером через RPC.

## Подробнее

Этот модуль является частью системы, в которой Telegram-бот используется для взаимодействия с пользователем, а FastAPI сервер обрабатывает запросы и управляет маршрутизацией. RPC используется для связи между ботом и сервером, позволяя боту выполнять задачи, требующие ресурсов сервера.

## Классы

### `TelegramBot`

**Описание**:
Класс `TelegramBot` предоставляет интерфейс для управления Telegram-ботом. Он инициализирует бота, регистрирует обработчики команд и сообщений, а также запускает и останавливает бота.

**Как работает класс**:

1.  **Инициализация**:
    *   При инициализации создается экземпляр класса `Application` из библиотеки `telegram.ext`, который отвечает за управление ботом.
    *   Также создается экземпляр класса `BotHandler`, который содержит обработчики для различных команд и сообщений.
    *   Вызывается метод `_register_default_handlers` для регистрации обработчиков по умолчанию.

2.  **Запуск**:
    *   Метод `run` запускает бота. Он инициализирует RPC клиент для взаимодействия с FastAPI сервером.
    *   Через RPC вызывается метод `start_server` на сервере для запуска сервера FastAPI.
    *   Регистрируется маршрут для обработки входящих сообщений от Telegram.
    *   Бот запускается в режиме вебхука или опрашивает сервер Telegram на наличие новых сообщений.

3.  **Обработка сообщений**:
    *   Метод `_handle_message` обрабатывает входящие текстовые сообщения.
    *   Метод `_register_default_handlers` регистрирует обработчики для различных типов сообщений, таких как команды, текстовые сообщения, голосовые сообщения и документы.

4.  **Остановка**:
    *   Метод `stop` останавливает бота и удаляет вебхук.

**Методы**:

*   `__init__(self, token: str, route: str = 'telegram_webhook')`:
    Инициализирует экземпляр класса `TelegramBot`.
*   `run(self)`:
    Запускает бота и инициализирует RPC и вебхук.
*   `_register_default_handlers(self)`:
    Регистрирует обработчики по умолчанию, используя экземпляр `BotHandler`.
*   `_handle_message(self, update: Update, context: CallbackContext) -> None`:
    Обрабатывает любое текстовое сообщение.
*   `initialize_bot_webhook(self, route: str)`:
    Инициализирует вебхук бота.
*   `_register_route_via_rpc(self, rpc_client: ServerProxy)`:
    Регистрирует маршрут вебхука Telegram через RPC.
*   `stop(self)`:
    Останавливает бота и удаляет вебхук.

#### `__init__`

```python
def __init__(self, token: str, route: str = 'telegram_webhook'):
    """
    Initialize the TelegramBot instance.

    Args:
        token (str): Telegram bot token.
        route (str): Webhook route for FastAPI. Defaults to '/telegram_webhook'.
    """
    ...
```

**Назначение**:
Инициализация экземпляра класса `TelegramBot`.

**Как работает функция**:

1.  Сохраняет переданные параметры `token` (токен Telegram-бота) и `route` (маршрут вебхука FastAPI) в атрибуты экземпляра класса.
2.  Устанавливает порт для вебхука (по умолчанию 443).
3.  Загружает конфигурацию Telegram-бота из файла `telegram.json` с использованием функции `j_loads_ns` и сохраняет ее в атрибуте `config`.
4.  Создает экземпляр класса `Application` из библиотеки `telegram.ext`, используя токен бота, и сохраняет его в атрибуте `application`.
5.  Создает экземпляр класса `BotHandler` и сохраняет его в атрибуте `handler`.
6.  Вызывает метод `_register_default_handlers` для регистрации обработчиков по умолчанию.

**Параметры**:

*   `token` (str): Токен Telegram-бота.
*   `route` (str, optional): Маршрут вебхука для FastAPI. По умолчанию '/telegram\_webhook'.

#### `run`

```python
def run(self):
    """Run the bot and initialize RPC and webhook."""
    ...
```

**Назначение**:
Запуск бота, инициализация RPC и вебхука.

**Как работает функция**:

1.  Инициализирует RPC-клиент для взаимодействия с сервером FastAPI, используя адрес и порт, указанные в `gs.host` и 9000 соответственно.
2.  Вызывает RPC-метод `start_server` для запуска сервера FastAPI.
3.  Инициализирует вебхук Telegram-бота, вызывая метод `initialize_bot_webhook` и передавая маршрут вебхука.
4.  Если вебхук успешно инициализирован, регистрирует маршрут вебхука через RPC, вызывая метод `_register_route_via_rpc`.
5.  Запускает бота в режиме вебхука, используя параметры `listen`, `webhook_url` и `port`. Если возникает ошибка при установке вебхука, выводит сообщение об ошибке.
6.  Если вебхук не удалось инициализировать, запускает бота в режиме опроса (polling).

**Внутренние логические блоки функции**:

*   **Инициализация RPC-клиента**: Устанавливает соединение с сервером FastAPI через RPC.
*   **Запуск сервера FastAPI**: Запускает сервер FastAPI через RPC.
*   **Инициализация вебхука Telegram-бота**: Настраивает вебхук для получения сообщений от Telegram.
*   **Регистрация маршрута вебхука через RPC**: Регистрирует маршрут для обработки входящих сообщений от Telegram на сервере FastAPI.
*   **Запуск бота**: Запускает бота в режиме вебхука или опроса.

**Параметры**:
None

**Возвращает**:
None

**Вызывает исключения**:
*   `Exception`: В случае ошибки при инициализации RPC-клиента или запуске сервера FastAPI.

#### `_register_default_handlers`

```python
def _register_default_handlers(self):
    """Register the default handlers using the BotHandler instance."""
    ...
```

**Назначение**:
Регистрация обработчиков по умолчанию, используя экземпляр `BotHandler`.

**Как работает функция**:

1.  Добавляет обработчик для команды `/start`, используя метод `start` из экземпляра `BotHandler`.
2.  Добавляет обработчик для команды `/help`, используя метод `help_command` из экземпляра `BotHandler`.
3.  Добавляет обработчик для команды `/sendpdf`, используя метод `send_pdf` из экземпляра `BotHandler`.
4.  Добавляет обработчик для текстовых сообщений (не являющихся командами), используя метод `_handle_message`.
5.  Добавляет обработчик для голосовых сообщений, используя метод `handle_voice` из экземпляра `BotHandler`.
6.  Добавляет обработчик для документов, используя метод `handle_document` из экземпляра `BotHandler`.
7.  Добавляет обработчик для логирования текстовых сообщений (не являющихся командами), используя метод `handle_log` из экземпляра `BotHandler`.

**Параметры**:
None

**Возвращает**:
None

#### `_handle_message`

```python
async def _handle_message(self, update: Update, context: CallbackContext) -> None:
    """Handle any text message."""
    ...
```

**Назначение**:
Обработка любого текстового сообщения.

**Как работает функция**:

1.  Вызывает метод `handle_message` из экземпляра `bot_handler` для обработки текстового сообщения.
2.  Передает объекты `update` и `context` в метод `handle_message`.

**Параметры**:

*   `update` (Update): Объект, содержащий информацию об обновлении от Telegram.
*   `context` (CallbackContext): Объект, содержащий контекст обратного вызова.

**Возвращает**:
None

#### `initialize_bot_webhook`

```python
def initialize_bot_webhook(self, route: str):
    """Initialize the bot webhook."""
    ...
```

**Назначение**:
Инициализация вебхука бота.

**Как работает функция**:

1.  Формирует маршрут вебхука, добавляя префикс `/`, если он отсутствует.
2.  Определяет хост для вебхука. Если хост указан как `127.0.0.1` или `localhost`, использует `ngrok` для создания туннеля.
3.  Формирует URL вебхука, объединяя хост и маршрут.
4.  Отправляет POST-запрос на URL вебхука (только для разработки).
5.  Устанавливает вебхук для бота, используя метод `set_webhook` из экземпляра `application.bot`.
6.  Возвращает URL вебхука.

**Внутренние логические блоки функции**:

*   **Формирование маршрута**: Добавляет префикс `/` к маршруту, если он отсутствует.
*   **Определение хоста**: Определяет хост для вебхука. Если хост указан как `127.0.0.1` или `localhost`, использует `ngrok` для создания туннеля.
*   **Формирование URL**: Объединяет хост и маршрут для создания URL вебхука.
*   **Отправка POST-запроса (для разработки)**: Отправляет POST-запрос на URL вебхука (только для разработки).
*   **Установка вебхука**: Устанавливает вебхук для бота, используя метод `set_webhook`.
*   **Логирование**: Логирует URL для получения информации о вебхуке.

**Параметры**:

*   `route` (str): Маршрут вебхука.

**Возвращает**:

*   `webhook_url` (str): URL вебхука.
*   `False`: В случае ошибки при установке вебхука.

**Вызывает исключения**:

*   `Exception`: В случае ошибки при установке вебхука.

#### `_register_route_via_rpc`

```python
def _register_route_via_rpc(self, rpc_client: ServerProxy):
    """Register the Telegram webhook route via RPC."""
    ...
```

**Назначение**:
Регистрация маршрута вебхука Telegram через RPC.

**Как работает функция**:

1.  Формирует маршрут, добавляя префикс `/`, если он отсутствует.
2.  Вызывает RPC-метод `add_new_route` для регистрации маршрута на сервере FastAPI.
3.  Передает маршрут, имя обработчика (`self.bot_handler.handle_message`) и список HTTP-методов (`['POST']`) в RPC-метод.
4.  Логирует информацию об успешной регистрации маршрута.

**Внутренние логические блоки функции**:

*   **Формирование маршрута**: Добавляет префикс `/` к маршруту, если он отсутствует.
*   **Вызов RPC-метода**: Вызывает RPC-метод `add_new_route` для регистрации маршрута на сервере FastAPI.
*   **Логирование**: Логирует информацию об успешной регистрации маршрута.

**Параметры**:

*   `rpc_client` (ServerProxy): RPC-клиент для взаимодействия с сервером FastAPI.

**Возвращает**:
None

**Вызывает исключения**:

*   `Exception`: В случае ошибки при регистрации маршрута через RPC.

#### `stop`

```python
def stop(self):
    """Stop the bot and delete the webhook."""
    ...
```

**Назначение**:
Остановка бота и удаление вебхука.

**Как работает функция**:

1.  Останавливает бота, вызывая метод `stop` из экземпляра `application`.
2.  Удаляет вебхук, вызывая метод `delete_webhook` из экземпляра `application.bot`.
3.  Логирует информацию об успешной остановке бота.

**Параметры**:
None

**Возвращает**:
None

**Вызывает исключения**:

*   `Exception`: В случае ошибки при удалении вебхука.

## Функции

В данном модуле нет отдельных функций, не относящихся к классам.