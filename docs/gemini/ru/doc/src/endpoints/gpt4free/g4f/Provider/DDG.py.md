# Модуль для работы с DuckDuckGo AI Chat

## Обзор

Модуль `DDG` предоставляет асинхронный интерфейс для взаимодействия с DuckDuckGo AI Chat. Он поддерживает стриминг ответов, системные сообщения и историю сообщений. Модуль включает в себя функциональность для получения токенов VQD, управления cookies и обработки ошибок.

## Подробнее

Этот модуль позволяет интегрировать AI Chat от DuckDuckGo в проект `hypotez`. Он обрабатывает запросы к API DuckDuckGo, управляет сессиями и обеспечивает удобный интерфейс для обмена сообщениями с AI.

## Классы

### `DuckDuckGoSearchException`

**Описание**:
Базовый класс исключений для модуля `duckduckgo_search`.

### `Conversation(JsonConversation)`

**Описание**:
Класс для хранения состояния разговора с DuckDuckGo AI Chat.

**Параметры**:
- `vqd` (str): Токен VQD для текущей сессии.
- `vqd_hash_1` (str): Хэш VQD для текущей сессии.
- `message_history` (Messages): История сообщений в разговоре.
- `cookies` (dict): Cookies, используемые в сессии.
- `fe_version` (str): Версия front-end приложения DuckDuckGo AI Chat.

**Методы**:
- `__init__(self, model: str)`:
    - **Описание**: Инициализирует объект разговора.
    - **Параметры**:
        - `model` (str): Модель, используемая в разговоре.
    - **Как работает метод**:
        1. Устанавливает модель для текущего разговора.

### `DDG(AsyncGeneratorProvider, ProviderModelMixin)`

**Описание**:
Класс, реализующий асинхронный провайдер для DuckDuckGo AI Chat.

**Параметры**:
- `label` (str): Метка провайдера ("DuckDuckGo AI Chat").
- `url` (str): URL главной страницы DuckDuckGo AI Chat ("https://duckduckgo.com/aichat").
- `api_endpoint` (str): URL API для отправки сообщений ("https://duckduckgo.com/duckchat/v1/chat").
- `status_url` (str): URL для получения статуса сессии ("https://duckduckgo.com/duckchat/v1/status").
- `working` (bool): Флаг, указывающий на работоспособность провайдера (True).
- `supports_stream` (bool): Флаг, указывающий на поддержку стриминга ответов (True).
- `supports_system_message` (bool): Флаг, указывающий на поддержку системных сообщений (True).
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений (True).
- `default_model` (str): Модель, используемая по умолчанию ("gpt-4o-mini").
- `models` (List[str]): Список поддерживаемых моделей.
- `model_aliases` (Dict[str, str]): Псевдонимы моделей для удобства использования.
- `last_request_time` (float): Время последнего запроса для контроля rate limiting.
- `max_retries` (int): Максимальное количество повторных попыток при запросах к API (3).
- `base_delay` (int): Базовая задержка между повторными попытками (2 секунды).
- `_chat_xfe` (str):  версия front-end приложения DuckDuckGo AI Chat.

**Методы**:

- `sha256_base64(text: str) -> str`
    - **Описание**:
    Возвращает base64-представление SHA256 хеша текста.
    - **Параметры**:
        - `text` (str): Входная строка для хеширования.
    - **Возвращает**:
        - `str`: Base64-представление SHA256 хеша.
    - **Как работает функция**:
        1. Кодирует входной текст в UTF-8.
        2. Вычисляет SHA256 хеш закодированной строки.
        3. Кодирует полученный хеш в Base64.
        4. Декодирует Base64 представление в строку UTF-8 и возвращает её.
    - **Примеры**:
    ```python
    >>> DDG.sha256_base64("test_string")
    'rL0Y20zC6Y0i0reURSZYxg=='
    ```

- `parse_dom_fingerprint(js_text: str) -> str`
    - **Описание**:
    Извлекает отпечаток DOM из JavaScript текста. Если `BeautifulSoup` недоступен, возвращает "1000".
    - **Параметры**:
        - `js_text` (str): JavaScript текст, содержащий HTML сниппет и значение смещения.
    - **Возвращает**:
        - `str`: Отпечаток DOM в виде строки или "1000" в случае ошибки.
    - **Как работает функция**:
        1. Проверяет, установлен ли `BeautifulSoup`. Если нет, возвращает "1000".
        2. Извлекает HTML сниппет из `js_text`.
        3. Извлекает значение смещения из `js_text`.
        4. Использует `BeautifulSoup` для парсинга HTML сниппета.
        5. Вычисляет длину содержимого тега `body`.
        6. Вычисляет отпечаток как сумму значения смещения и длины содержимого тега `body`.
        7. Возвращает отпечаток в виде строки.
        8. В случае ошибки возвращает "1000".
    - **Примеры**:
    ```python
    >>> js_text = "e.innerHTML = '<body><div>test</div></body>';" \
    ...           "return String(10) "
    >>> DDG.parse_dom_fingerprint(js_text)
    '26'
    ```

- `parse_server_hashes(js_text: str) -> list`
    - **Описание**:
    Извлекает список хешей сервера из JavaScript текста. Если парсинг не удался, возвращает `["1", "2"]`.
    - **Параметры**:
        - `js_text` (str): JavaScript текст, содержащий список хешей сервера.
    - **Возвращает**:
        - `list`: Список хешей сервера или `["1", "2"]` в случае ошибки.
    - **Как работает функция**:
        1. Пытается извлечь список хешей сервера из `js_text`, используя строковые операции.
        2. Если извлечение удалось, возвращает список хешей.
        3. В случае ошибки возвращает `["1", "2"]`.

- `build_x_vqd_hash_1(cls, vqd_hash_1: str, headers: dict) -> str`
    - **Описание**:
    Строит значение заголовка `x-vqd-hash-1`.
    - **Параметры**:
        - `vqd_hash_1` (str): Base64-представление данных для построения хеша.
        - `headers` (dict): Заголовки запроса, содержащие `User-Agent` и `sec-ch-ua`.
    - **Возвращает**:
        - `str`: Значение заголовка `x-vqd-hash-1` или пустая строка в случае ошибки.
    - **Как работает функция**:
        1. Декодирует `vqd_hash_1` из Base64.
        2. Извлекает хеши сервера, используя `parse_server_hashes`.
        3. Извлекает отпечаток DOM, используя `parse_dom_fingerprint`.
        4. Формирует отпечаток User-Agent, объединяя значения `User-Agent` и `sec-ch-ua` из заголовков.
        5. Вычисляет SHA256 хеш отпечатка User-Agent и кодирует его в Base64.
        6. Вычисляет SHA256 хеш отпечатка DOM и кодирует его в Base64.
        7. Формирует словарь с хешами сервера, хешами клиента (User-Agent и DOM) и сигналами.
        8. Кодирует словарь в JSON и кодирует JSON в Base64.
        9. Возвращает полученное значение.
        10. В случае ошибки возвращает пустую строку.

- `validate_model(cls, model: str) -> str`
    - **Описание**:
    Проверяет и возвращает корректное имя модели.
    - **Параметры**:
        - `model` (str): Имя модели для валидации.
    - **Возвращает**:
        - `str`: Корректное имя модели.
    - **Вызывает исключения**:
        - `ModelNotSupportedError`: Если указанная модель не поддерживается.
    - **Как работает функция**:
        1. Если `model` не указана, возвращает `default_model`.
        2. Если `model` есть в `model_aliases`, заменяет её на соответствующий псевдоним.
        3. Если `model` отсутствует в списке поддерживаемых моделей, вызывает исключение `ModelNotSupportedError`.
        4. Возвращает имя модели.

- `sleep(cls, multiplier=1.0)`
    - **Описание**:
    Реализует ограничение скорости запросов (rate limiting) между запросами.
    - **Параметры**:
        - `multiplier` (float, optional): Множитель для задержки. По умолчанию 1.0.
    - **Как работает функция**:
        1. Получает текущее время.
        2. Если `last_request_time` больше 0, вычисляет задержку на основе разницы между текущим временем и `last_request_time`.
        3. Если задержка больше 0, приостанавливает выполнение на вычисленное время.
        4. Обновляет `last_request_time` текущим временем.
        5. Выполняет асинхронную задержку, чтобы не превышать rate limit.

- `get_default_cookies(cls, session: ClientSession) -> dict`
    - **Описание**:
    Получает cookies по умолчанию, необходимые для API запросов.
    - **Параметры**:
        - `session` (ClientSession): Асинхронная сессия клиента.
    - **Возвращает**:
        - `dict`: Словарь с cookies.
    - **Как работает функция**:
        1. Выполняет начальный запрос к `cls.url` для получения cookies.
        2. Устанавливает необходимые cookies вручную (`dcs` и `dcm`).
        3. Возвращает словарь с cookies.
        4. В случае ошибки возвращает пустой словарь.

- `fetch_fe_version(cls, session: ClientSession) -> str`
    - **Описание**:
    Извлекает `fe-version` из HTML-кода главной страницы.
    - **Параметры**:
        - `session` (ClientSession): Асинхронная сессия клиента.
    - **Возвращает**:
        - `str`: Версия `fe-version` или пустая строка в случае неудачи.
    - **Как работает функция**:
        1. Проверяет, сохранена ли версия `fe_version` в переменной класса `_chat_xfe`. Если да, возвращает сохраненную версию.
        2. Отправляет GET-запрос по URL.
        3. Извлекает значения `xfe1` и `xfe2` из HTML-кода, используя строковые операции.
        4. Формирует `fe_version` как строку `{xfe1}-{xfe2}`.
        5. Сохраняет `fe_version` в `cls._chat_xfe` и возвращает его.
        6. Если извлечение не удалось, возвращает пустую строку.

- `fetch_vqd_and_hash(cls, session: ClientSession, retry_count: int = 0) -> tuple[str, str]`
    - **Описание**:
    Получает VQD токен и хеш для чат-сессии с повторными попытками.
    - **Параметры**:
        - `session` (ClientSession): Асинхронная сессия клиента.
        - `retry_count` (int, optional): Количество попыток повтора. По умолчанию 0.
    - **Возвращает**:
        - `tuple[str, str]`: Кортеж, содержащий VQD токен и хеш.
    - **Вызывает исключения**:
        - `RuntimeError`: Если не удалось получить VQD токен и хеш после максимального количества попыток.
    - **Как работает функция**:
        1. Подготавливает заголовки запроса.
        2. Проверяет наличие cookies в сессии, при необходимости получает их.
        3. Отправляет GET-запрос к `cls.status_url`.
        4. Извлекает VQD токен и хеш из заголовков ответа.
        5. Если VQD токен получен, возвращает его вместе с хешем.
        6. Если VQD токен не получен, выполняет повторную попытку после задержки, если `retry_count` не превышает `cls.max_retries`.
        7. Если после максимального количества попыток не удалось получить VQD токен и хеш, вызывает исключение `RuntimeError`.

- `create_async_generator(cls, model: str, messages: Messages, proxy: str = None, timeout: int = 60, cookies: Cookies = None, conversation: Conversation = None, return_conversation: bool = False, **kwargs) -> AsyncResult`
    - **Описание**:
    Создает асинхронный генератор для взаимодействия с DuckDuckGo AI Chat.
    - **Параметры**:
        - `model` (str): Модель для использования в чате.
        - `messages` (Messages): Список сообщений для отправки.
        - `proxy` (str, optional): Прокси для использования. По умолчанию `None`.
        - `timeout` (int, optional): Время ожидания запроса. По умолчанию 60.
        - `cookies` (Cookies, optional): Cookies для использования. По умолчанию `None`.
        - `conversation` (Conversation, optional): Объект разговора. По умолчанию `None`.
        - `return_conversation` (bool, optional): Флаг, указывающий, нужно ли возвращать объект разговора. По умолчанию `False`.
        - `**kwargs`: Дополнительные параметры.
    - **Возвращает**:
        - `AsyncResult`: Асинхронный генератор, возвращающий сообщения от AI.
    - **Вызывает исключения**:
        - `ModelNotSupportedError`: Если указанная модель не поддерживается.
        - `RateLimitError`: Если превышен лимит запросов.
        - `TimeoutError`: Если время ожидания запроса истекло.
        - `Exception`: В случае других ошибок.
    - **Как работает функция**:
        1. Валидирует модель, используя `cls.validate_model`.
        2. Инициализирует счетчик повторных попыток.
        3. В цикле, пока счетчик повторных попыток не превысит максимальное значение:
            A. Создает асинхронную сессию с таймаутом.
            B. Если `cls._chat_xfe` не определена, получает её, используя `cls.fetch_fe_version`.
            C. Если `conversation` не передан, создает новый объект `Conversation`.
                I. Если `cookies` не переданы, получает их, используя `cls.get_default_cookies`.
                II. Получает VQD токен и хеш, используя `cls.fetch_vqd_and_hash`.
                III. Обновляет `conversation.message_history` первым сообщением пользователя.
            D. Если `conversation` передан, добавляет последнее сообщение пользователя в `conversation.message_history`.
            E. Подготавливает заголовки запроса, включая `x-fe-version`, `x-vqd-4` и `x-vqd-hash-1`.
            F. Подготавливает данные запроса, включая модель и историю сообщений.
            G. Отправляет POST-запрос к `cls.api_endpoint`.
            H. Обрабатывает ответ, проверяя наличие ошибок (например, 429 - превышение лимита запросов).
            I. Для каждой строки в ответе:
                1. Декодирует строку.
                2. Если строка начинается с "data:", извлекает JSON сообщение.
                3. Если в сообщении есть ошибка, вызывает исключение `RateLimitError` или `DuckDuckGoSearchException`.
                4. Если в сообщении есть текст, возвращает его через генератор и добавляет в `full_message`.
                5. Если текста нет, устанавливает `reason` на "stop".
            J. Если `return_conversation` установлен, добавляет ответ ассистента в `conversation.message_history`, обновляет токены и cookies, возвращает `conversation` через генератор.
            K. Возвращает `FinishReason(reason)`.
        4. В случае ошибки `RateLimitError` или `ResponseStatusError`, выполняет повторную попытку после задержки, если `retry_count` не превышает `cls.max_retries`.
        5. В случае ошибки `asyncio.TimeoutError`, вызывает исключение `TimeoutError`.
        6. В случае других ошибок, вызывает исключение.

## Функции

В данном модуле функции как таковые отсутствуют. Основная логика реализована внутри методов класса `DDG`.