# Модуль VoiGpt

## Обзор

Модуль `VoiGpt` предоставляет класс `VoiGpt`, который является провайдером для взаимодействия с сервисом VoiGpt.com. Этот сервис предоставляет API для генерации текста на основе предоставленных сообщений. Модуль предназначен для использования в проекте `hypotez` для обеспечения взаимодействия с VoiGpt.com.

## Подробней

Этот модуль позволяет отправлять запросы к VoiGpt.com для генерации ответов на основе заданных сообщений. Для работы с этим провайдером необходимо получить `csrf token/cookie` с сайта voigpt.com. Этот токен используется для аутентификации запросов к API.

## Классы

### `VoiGpt(AbstractProvider)`

**Описание**: Класс `VoiGpt` является провайдером для VoiGpt.com.

**Наследует**:
- `AbstractProvider`: Абстрактный класс, определяющий интерфейс для провайдеров.

**Атрибуты**:
- `url` (str): URL адрес сервиса VoiGpt.com.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `supports_gpt_35_turbo` (bool): Флаг, указывающий, поддерживает ли провайдер модель `gpt-3.5-turbo`.
- `supports_message_history` (bool): Флаг, указывающий, поддерживает ли провайдер историю сообщений.
- `supports_stream` (bool): Флаг, указывающий, поддерживает ли провайдер потоковую передачу данных.
- `_access_token` (str): Приватный атрибут для хранения токена доступа.

**Методы**:
- `create_completion`: Метод для создания запроса к VoiGpt.com и получения ответа.

## Функции

### `create_completion`

```python
    @classmethod
    def create_completion(
        cls,
        model: str,
        messages: Messages,
        stream: bool,
        proxy: str = None,
        access_token: str = None,
        **kwargs
    ) -> CreateResult:
        """ Функция отправляет запросы к VoiGpt.com для генерации ответов на основе заданных сообщений.

        Args:
            model (str): Модель для использования.
            messages (Messages): Список сообщений для отправки.
            stream (bool): Флаг, указывающий, использовать ли потоковую передачу данных.
            proxy (str, optional): Прокси для использования. По умолчанию `None`.
            access_token (str, optional): Токен доступа для использования. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            CreateResult: Объект, содержащий результат запроса.

        Raises:
            RuntimeError: Если получен некорректный ответ от сервера.
        """
```

**Назначение**:
Функция `create_completion` отправляет запросы к VoiGpt.com для генерации ответов на основе заданных сообщений.

**Параметры**:
- `model` (str): Модель для использования.
- `messages` (Messages): Список сообщений для отправки.
- `stream` (bool): Флаг, указывающий, использовать ли потоковую передачу данных.
- `proxy` (str, optional): Прокси для использования. По умолчанию `None`.
- `access_token` (str, optional): Токен доступа для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `CreateResult`: Объект, содержащий результат запроса.

**Вызывает исключения**:
- `RuntimeError`: Если получен некорректный ответ от сервера.

**Как работает функция**:
1. **Инициализация параметров**:
   - Проверяет, задана ли модель, и если нет, устанавливает значение по умолчанию `"gpt-3.5-turbo"`.
   - Проверяет, задан ли токен доступа, и если нет, использует сохраненный токен (`cls._access_token`).
   - Если токен доступа все еще не задан, выполняет запрос к сайту для получения токена.

2. **Получение токена доступа (если необходимо)**:
   - Если `access_token` не предоставлен, функция выполняет `GET` запрос к `cls.url` для получения CSRF токена.
   - CSRF токен извлекается из cookies ответа и сохраняется в `cls._access_token` для последующего использования.

3. **Формирование заголовков запроса**:
   - Создает словарь `headers`, содержащий необходимые HTTP заголовки, включая CSRF токен в Cookie и `X-Csrftoken`.

4. **Формирование полезной нагрузки (payload)**:
   - Создает словарь `payload`, содержащий сообщения (`messages`), которые будут отправлены в запросе.

5. **Выполнение POST запроса**:
   - Выполняет `POST` запрос к `f"{cls.url}/generate_response/"` с использованием сформированных заголовков и полезной нагрузки.

6. **Обработка ответа**:
   - Пытается распарсить текст ответа как JSON.
   - Извлекает значение из поля `"response"` и возвращает его.

7. **Обработка ошибок**:
   - Если происходит ошибка при парсинге JSON, выбрасывается исключение `RuntimeError` с текстом ответа от сервера.

**ASCII flowchart**:

```
A [Проверка наличия access_token]
|
B [Если access_token отсутствует, получение CSRF токена с сайта voigpt.com]
|
C [Формирование HTTP заголовков с CSRF токеном]
|
D [Формирование payload с сообщениями]
|
E [Выполнение POST запроса к VoiGpt.com]
|
F [Обработка ответа и извлечение текста]
|
G [Возврат текста ответа]
```

**Примеры**:

Пример 1:

```python
messages = [{"role": "user", "content": "Hello, how are you?"}]
result = VoiGpt.create_completion(model="gpt-3.5-turbo", messages=messages, stream=False)
for res in result:
    print(res)
```

Пример 2:

```python
messages = [{"role": "user", "content": "What is the capital of France?"}]
result = VoiGpt.create_completion(model="gpt-3.5-turbo", messages=messages, stream=False, access_token="your_csrf_token")
for res in result:
    print(res)
```