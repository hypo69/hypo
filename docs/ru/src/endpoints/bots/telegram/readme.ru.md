# Модуль: src.endpoints.bots.telegram

## Обзор

Этот модуль содержит реализацию Telegram-бота, который обрабатывает команды, голосовые сообщения и файлы, взаимодействуя с пользователями через Telegram API. Бот предоставляет базовые команды, такие как `/start` и `/help`, а также функциональность для обработки и транскрибирования голосовых сообщений и чтения содержимого текстовых документов.

## Подробнее

Модуль предназначен для создания интерактивного Telegram-бота, способного обрабатывать различные типы входящих сообщений и команд. Он использует библиотеку `python-telegram-bot` для взаимодействия с Telegram API и реализует основные функции, такие как отправка приветственных сообщений, обработка голосовых сообщений и чтение файлов документов.
В данном коде реализованы обработчики для основных команд и типов сообщений, которые позволяют боту взаимодействовать с пользователями Telegram.

## Содержание

- [Основные функции и команды бота](#основные-функции-и-команды-бота)
- [Основные модули и библиотеки](#основные-модули-и-библиотеки)
- [Классы](#классы)
    - [TelegramBot](#telegrambot)
- [Функции](#функции)
    - [main](#main)

## Основные функции и команды бота:

1.  **Инициализация бота:**
    *   Бот инициализируется с токеном, который используется для аутентификации бота в Telegram API.

2.  **Команды:**
    *   `/start`: Отправляет приветственное сообщение пользователю.
    *   `/help`: Предоставляет список доступных команд.
    *   `/sendpdf`: Отправляет PDF-файл пользователю.

3.  **Обработка сообщений:**
    *   Бот обрабатывает входящие текстовые сообщения, голосовые сообщения и файлы документов.
    *   Для голосовых сообщений бот загружает файл, сохраняет его локально и пытается транскрибировать его с помощью сервиса распознавания речи (в настоящее время это заглушка).
    *   Для файлов документов бот загружает файл, сохраняет его локально и читает содержимое текстового документа.

4.  **Обработка голосовых сообщений:**
    *   Бот загружает файл голосового сообщения, сохраняет его локально и пытается транскрибировать его с помощью сервиса распознавания речи (в настоящее время это заглушка).

5.  **Обработка документов:**
    *   Бот загружает файл документа, сохраняет его локально и читает содержимое текстового документа.

6.  **Обработка текстовых сообщений:**
    *   Бот просто возвращает текст, полученный от пользователя.

## Основные модули и библиотеки:

*   `python-telegram-bot`: Основная библиотека для создания Telegram-ботов.
*   `pathlib`: Для работы с путями файлов.
*   `tempfile`: Для создания временных файлов.
*   `asyncio`: Для асинхронного выполнения задач.
*   `requests`: Для загрузки файлов.
*   `src.utils.convertors.tts`: Для распознавания речи и преобразования текста в речь.
*   `src.utils.file`: Для чтения текстовых файлов.

## Классы

### `TelegramBot`

**Описание**: Класс `TelegramBot` представляет собой Telegram-бота, который обрабатывает команды и сообщения от пользователей.

**Как работает класс**:
1.  Класс инициализируется с использованием токена, полученного из Telegram API.
2.  Регистрирует обработчики для различных команд и типов сообщений.
3.  Обрабатывает команды `/start`, `/help` и `/sendpdf`, а также голосовые сообщения и файлы документов.
4.  Для обработки голосовых сообщений и документов используются вспомогательные функции, такие как `transcribe_voice` и `handle_document`.

**Методы**:

*   `__init__(self, token: str)`
    *   **Описание**: Инициализирует бота с токеном и регистрирует обработчики.
        *   Токен используется для аутентификации бота в Telegram API.
    *   **Параметры**:
        *   `token` (str): Токен для аутентификации бота.
    *   **Как работает функция**:
        1.  Сохраняет токен бота.
        2.  Вызывает метод `register_handlers` для регистрации обработчиков команд и сообщений.

*   `register_handlers(self)`
    *   **Описание**: Регистрирует обработчики команд и сообщений.
    *   **Как работает функция**:
        1.  Создает обработчики команд для `/start`, `/help` и `/sendpdf`.
        2.  Создает обработчики сообщений для текстовых сообщений, голосовых сообщений и файлов документов.
        3.  Добавляет созданные обработчики в диспетчер бота.

*   `start(self, update: Update, context: CallbackContext)`
    *   **Описание**: Обрабатывает команду `/start`, отправляя приветственное сообщение пользователю.
    *   **Параметры**:
        *   `update` (Update): Объект `Update`, представляющий входящее обновление от Telegram.
        *   `context` (CallbackContext): Объект `CallbackContext`, содержащий контекст вызова обработчика.
    *   **Как работает функция**:
        1.  Извлекает информацию о пользователе из объекта `update`.
        2.  Формирует приветственное сообщение.
        3.  Отправляет сообщение пользователю, используя метод `send_message` объекта `update.message.chat`.

*   `help_command(self, update: Update, context: CallbackContext)`
    *   **Описание**: Обрабатывает команду `/help`, предоставляя список доступных команд.
    *   **Параметры**:
        *   `update` (Update): Объект `Update`, представляющий входящее обновление от Telegram.
        *   `context` (CallbackContext): Объект `CallbackContext`, содержащий контекст вызова обработчика.
    *   **Как работает функция**:
        1.  Формирует сообщение со списком доступных команд.
        2.  Отправляет сообщение пользователю, используя метод `send_message` объекта `update.message.chat`.

*   `send_pdf(self, pdf_file: str | Path)`
    *   **Описание**: Обрабатывает команду `/sendpdf` для отправки PDF-файла пользователю.
    *   **Параметры**:
        *   `pdf_file` (str | Path): Путь к PDF-файлу, который необходимо отправить.
    *   **Как работает функция**:
        1.  Открывает PDF-файл в режиме чтения.
        2.  Отправляет файл пользователю, используя метод `send_document` объекта `update.message.chat`.

*   `handle_voice(self, update: Update, context: CallbackContext)`
    *   **Описание**: Обрабатывает голосовые сообщения и транскрибирует аудио.
    *   **Параметры**:
        *   `update` (Update): Объект `Update`, представляющий входящее обновление от Telegram.
        *   `context` (CallbackContext): Объект `CallbackContext`, содержащий контекст вызова обработчика.
    *   **Как работает функция**:
        1.  Извлекает информацию о голосовом сообщении из объекта `update`.
        2.  Получает объект `File` для голосового сообщения.
        3.  Создает временный файл для сохранения голосового сообщения.
        4.  Загружает голосовое сообщение во временный файл.
        5.  Транскрибирует голосовое сообщение, используя метод `transcribe_voice`.
        6.  Отправляет транскрибированный текст пользователю.
        7.  Удаляет временный файл.

*   `transcribe_voice(self, file_path: Path) -> str`
    *   **Описание**: Транскрибирует голосовые сообщения (заглушка).
    *   **Параметры**:
        *   `file_path` (Path): Путь к файлу голосового сообщения.
    *   **Возвращает**:
        *   str: Транскрибированный текст (в настоящее время возвращает заглушку).
    *   **Как работает функция**:
        1.  В настоящее время возвращает строку "Транскрипция голоса пока не реализована".
        2.  В будущем здесь будет реализована логика для транскрибирования голосовых сообщений с использованием сервисов распознавания речи.

*   `handle_document(self, update: Update, context: CallbackContext) -> str`
    *   **Описание**: Обрабатывает файлы документов и читает их содержимое.
    *   **Параметры**:
        *   `update` (Update): Объект `Update`, представляющий входящее обновление от Telegram.
        *   `context` (CallbackContext): Объект `CallbackContext`, содержащий контекст вызова обработчика.
    *   **Возвращает**:
        *   str: Содержимое текстового документа.
    *   **Как работает функция**:
        1.  Извлекает информацию о файле документа из объекта `update`.
        2.  Получает объект `File` для файла документа.
        3.  Создает временный файл для сохранения файла документа.
        4.  Загружает файл документа во временный файл.
        5.  Читает содержимое текстового документа, используя функцию `read_text_file` из модуля `src.utils.file`.
        6.  Отправляет содержимое текстового документа пользователю.
        7.  Удаляет временный файл.

*   `handle_message(self, update: Update, context: CallbackContext) -> str`
    *   **Описание**: Обрабатывает текстовые сообщения и возвращает полученный текст.
    *   **Параметры**:
        *   `update` (Update): Объект `Update`, представляющий входящее обновление от Telegram.
        *   `context` (CallbackContext): Объект `CallbackContext`, содержащий контекст вызова обработчика.
    *   **Возвращает**:
        *   str: Текст сообщения, полученный от пользователя.
    *   **Как работает функция**:
        1.  Извлекает текст сообщения из объекта `update`.
        2.  Возвращает текст сообщения.
        3.  Отправляет текст сообщения пользователю.

## Функции

### `main`

*   **Описание**: Инициализирует бота, регистрирует обработчики команд и сообщений, и запускает бота.
*   **Как работает функция**:
    1.  Получает токен Telegram бота из переменной окружения `TELEGRAM_TOKEN`.
    2.  Инициализирует объект `TelegramBot` с использованием полученного токена.
    3.  Запускает бота, используя метод `run_polling()`.