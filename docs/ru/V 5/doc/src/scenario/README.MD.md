# Модуль `src.scenario`

## Обзор

Модуль `src.scenario` предназначен для автоматизации взаимодействия с поставщиками с использованием сценариев, описанных в файлах `JSON`. Он упрощает процесс извлечения и обработки данных о продуктах с веб-сайтов поставщиков и синхронизирует эту информацию с базой данных (например, PrestaShop). Модуль включает функциональность для чтения сценариев, взаимодействия с веб-сайтами, обработки данных, ведения журнала выполнения и организации всего рабочего процесса.

## Подробней

Этот модуль является ключевым компонентом системы, автоматизирующей взаимодействие с поставщиками. Он позволяет извлекать информацию о продуктах с веб-сайтов поставщиков и интегрировать её в базу данных PrestaShop. Использование сценариев в формате `JSON` позволяет гибко настраивать процесс извлечения данных для различных поставщиков и категорий продуктов.

## Содержание

* [Функции `src.scenario`](#module-src-scenario)
* [Обзор](#overview)
* [Основные функции модуля](#core-functions-of-the-module)
* [Основные компоненты модуля](#main-components-of-the-module)
    * [`run_scenario_files(s, scenario_files_list)`](#run_scenario_files-s-scenario_files_list)
    * [`run_scenario_file(s, scenario_file)`](#run_scenario_file-s-scenario_file)
    * [`run_scenario(s, scenario)`](#run_scenario-s-scenario)
    * [`dump_journal(s, journal)`](#dump_journal-s-journal)
    * [`main()`](#main)
* [Пример сценария](#example-scenario)
* [Как это работает](#how-it-works)

## Основные функции модуля

1. **Чтение сценариев**: Загрузка сценариев из файлов `JSON`, содержащих информацию о продуктах и URL-адреса на веб-сайте поставщика.
2. **Взаимодействие с веб-сайтами**: Обработка URL-адресов из сценариев для извлечения данных о продуктах.
3. **Обработка данных**: Преобразование извлеченных данных в формат, подходящий для базы данных, и сохранение их.
4. **Ведение журнала выполнения**: Ведение журналов с подробной информацией о выполнении сценариев и результатах для отслеживания прогресса и выявления ошибок.

## Основные компоненты модуля

### `run_scenario_files(s, scenario_files_list)`

**Описание**: Принимает список файлов сценариев и выполняет их последовательно, вызывая функцию `run_scenario_file` для каждого файла.

**Как работает функция**:

1. Функция `run_scenario_files` принимает список файлов сценариев (`scenario_files_list`) и объект настроек (`s`).
2. Затем она итерируется по списку файлов, и для каждого файла вызывает функцию `run_scenario_file`, передавая ей объект настроек и текущий файл сценария.
3. Функция `run_scenario_file` обрабатывает каждый сценарий в файле, извлекая данные и сохраняя их в базе данных.
4. Если в процессе выполнения возникает исключение, оно перехватывается и логируется.

**Параметры**:
- `s`: Объект настроек (например, для подключения к базе данных).
- `scenario_files_list` (list): Список путей к файлам сценариев.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `FileNotFoundError`: Если файл сценария не найден.
- `JSONDecodeError`: Если файл сценария содержит неверный JSON.

### `run_scenario_file(s, scenario_file)`

**Описание**: Загружает сценарии из указанного файла и вызывает `run_scenario` для каждого сценария в файле.

**Как работает функция**:

1. Функция `run_scenario_file` принимает объект настроек (`s`) и путь к файлу сценария (`scenario_file`).
2. Открывает файл сценария, читает его содержимое и загружает сценарии из `JSON`.
3. Затем она итерируется по сценариям в файле, и для каждого сценария вызывает функцию `run_scenario`, передавая ей объект настроек и текущий сценарий.
4. Функция `run_scenario` обрабатывает каждый сценарий, извлекая данные и сохраняя их в базе данных.
5. Если в процессе выполнения возникает исключение, оно перехватывается и логируется.

**Параметры**:
- `s`: Объект настроек.
- `scenario_file` (str): Путь к файлу сценария.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `FileNotFoundError`: Если файл сценария не найден.
- `JSONDecodeError`: Если файл сценария содержит неверный JSON.
- `Exception`: При любых других проблемах во время выполнения сценария.

### `run_scenario(s, scenario)`

**Описание**: Обрабатывает отдельный сценарий, переходя по URL-адресу, извлекая данные о продукте и сохраняя их в базе данных.

**Как работает функция**:

1. Функция `run_scenario` принимает объект настроек (`s`) и словарь, содержащий сценарий (`scenario`).
2. Извлекает URL-адрес из сценария и переходит по нему, используя библиотеку `requests`.
3. Затем извлекает данные о продукте из HTML-кода страницы, используя `BeautifulSoup`.
4. После этого преобразует извлеченные данные в формат, подходящий для базы данных, и сохраняет их.
5. Если в процессе выполнения возникает исключение, оно перехватывается и логируется.

**Параметры**:
- `s`: Объект настроек.
- `scenario` (dict): Словарь, содержащий сценарий (например, с URL-адресом и категориями).

**Возвращает**:
- `None`

**Вызывает исключения**:
- `requests.exceptions.RequestException`: Если возникают проблемы с запросом к веб-сайту.
- `Exception`: При любых других проблемах во время обработки сценария.

### `dump_journal(s, journal)`

**Описание**: Сохраняет журнал выполнения в файл для последующего анализа.

**Как работает функция**:

1. Функция `dump_journal` принимает объект настроек (`s`) и список записей журнала (`journal`).
2. Открывает файл журнала в режиме записи.
3. Записывает каждую запись журнала в файл в формате `JSON`.
4. Закрывает файл журнала.
5. Если в процессе выполнения возникает исключение, оно перехватывается и логируется.

**Параметры**:
- `s`: Объект настроек.
- `journal` (list): Список записей журнала выполнения.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `Exception`: Если возникают проблемы при записи в файл.

### `main()`

**Описание**: Основная функция для запуска модуля.

**Как работает функция**:

1. Функция `main` является точкой входа в модуль.
2. Она инициализирует объект настроек (`s`), загружая конфигурацию из файла.
3. Затем она получает список файлов сценариев из командной строки или из конфигурации.
4. После этого вызывает функцию `run_scenario_files`, передавая ей объект настроек и список файлов сценариев.
5. Если в процессе выполнения возникает исключение, оно перехватывается и логируется.

**Параметры**:
- `None`

**Возвращает**:
- `None`

**Вызывает исключения**:
- `Exception`: При любых критических ошибках во время выполнения.

## Пример сценария

Пример сценария `JSON` описывает взаимодействие с категориями продуктов на веб-сайте. Он включает URL-адрес, название категории и идентификаторы категорий в базе данных PrestaShop.

```json
{
    "scenarios": {
        "mineral+creams": {
            "url": "https://example.com/category/mineral-creams/",
            "name": "mineral+creams",
            "presta_categories": {
                "default_category": 12345,
                "additional_categories": [12346, 12347]
            }
        }
    }
}
```

## Как это работает

1. Модуль запускается с помощью функции `main()`.
2. Функция `main()` загружает конфигурацию и получает список файлов сценариев.
3. Функция `run_scenario_files()` итерируется по списку файлов сценариев и вызывает `run_scenario_file()` для каждого файла.
4. Функция `run_scenario_file()` загружает сценарии из файла и вызывает `run_scenario()` для каждого сценария.
5. Функция `run_scenario()` переходит по URL-адресу, извлекает данные о продукте и сохраняет их в базе данных.
6. Функция `dump_journal()` сохраняет журнал выполнения в файл для последующего анализа.