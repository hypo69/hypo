# Модуль для работы с провайдером ChatGptEs
=================================================

Модуль :file:`ChatGptEs.py` предоставляет асинхронный генератор для взаимодействия с сервисом ChatGptEs.
Он использует библиотеку `curl_cffi` для выполнения HTTP-запросов и обходит защиту Cloudflare.
В модуле реализована поддержка выбора модели, прокси и обработки сообщений.

## Оглавление

- [Обзор](#обзор)
- [Подробнее](#подробнее)
- [Классы](#классы)
    - [ChatGptEs](#chatgptes)
        - [create_async_generator](#create_async_generator)
- [Исключения](#исключения)

## Обзор

Модуль предназначен для интеграции с сервисом ChatGptEs и предоставляет возможность получения ответов от моделей GPT через асинхронный генератор.
Он включает в себя классы и методы для установки соединения, отправки запросов и обработки ответов.

## Подробнее

Этот модуль обеспечивает взаимодействие с ChatGptEs, обходя защиту Cloudflare с помощью `curl_cffi`.
Он поддерживает выбор модели, использование прокси и обработку сообщений.
В случае отсутствия `curl_cffi`, будет сгенерировано исключение `MissingRequirementsError`.

## Классы

### `ChatGptEs`

**Описание**: Класс `ChatGptEs` является асинхронным генератором провайдера и реализует методы для взаимодействия с ChatGptEs.
Он наследуется от `AsyncGeneratorProvider` и `ProviderModelMixin`.

**Принцип работы**:
1.  Проверяет наличие библиотеки `curl_cffi`.
2.  Формирует запрос на основе переданных сообщений.
3.  Выполняет HTTP-запрос к API ChatGptEs с использованием `curl_cffi` и обходит защиту Cloudflare.
4.  Обрабатывает ответ и возвращает его в виде асинхронного генератора.

**Атрибуты класса**:
-   `url` (str): URL сервиса ChatGptEs.
-   `api_endpoint` (str): URL API endpoint сервиса ChatGptEs.
-   `working` (bool): Указывает, работает ли провайдер.
-   `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных.
-   `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения.
-   `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений.
-   `default_model` (str): Модель, используемая по умолчанию (`gpt-4o`).
-   `models` (List[str]): Список поддерживаемых моделей (`gpt-4`, `gpt-4o`, `gpt-4o-mini`).
-   `SYSTEM_PROMPT` (str): Системное сообщение, используемое для форматирования запроса.

#### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """Создает асинхронный генератор для взаимодействия с ChatGptEs.

    Args:
        model (str): Название модели для использования.
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий ответ от ChatGptEs.

    Raises:
        MissingRequirementsError: Если отсутствует библиотека `curl_cffi`.
        ValueError: Если получен неожиданный формат ответа или произошла ошибка при запросе.

    Как работает функция:
    1. Проверяет наличие установленной библиотеки `curl_cffi`. Если библиотека не установлена, вызывает исключение `MissingRequirementsError`.
    2. Получает название модели, приводя его к допустимому значению, используя метод `get_model()`.
    3. Формирует промпт, объединяя системное сообщение `SYSTEM_PROMPT` с сообщениями пользователя, используя функцию `format_prompt()`.
    4. Создает сессию `curl_cffi.requests.Session` для выполнения HTTP-запросов с автоматическим обходом Cloudflare.
    5. Устанавливает заголовки запроса, включая User-Agent, Referer, Origin, Accept, Accept-Language и Content-Type.
    6. Если указан прокси-сервер, добавляет его в сессию.
    7. Выполняет первый GET-запрос для получения `nonce` (одноразовый токен) и `post_id` (идентификатор поста) со страницы ChatGptEs.
    8. Извлекает `nonce` и `post_id` из текста ответа, используя регулярные выражения.
    9. Генерирует случайный `client_id`.
    10. Формирует данные для POST-запроса, включая `nonce`, `post_id`, URL, действие, сообщение, идентификатор бота, идентификатор чат-бота, `client_id` и историю чата.
    11. Отправляет POST-запрос к API endpoint ChatGptEs.
    12. Обрабатывает ответ, проверяя код состояния HTTP и формат ответа.
    13. Если ответ содержит данные, возвращает их через генератор.

    Внутри функции происходят следующие действия и преобразования:
    A. **Проверка зависимостей**:
    |\
    B. **Подготовка запроса**:
    |\
    C. **Создание сессии**:
    |\
    D. **Установка заголовков**:
    |\
    E. **Получение `nonce` и `post_id`**:
    |\
    F. **Формирование данных**:
    |\
    G. **Отправка POST-запроса**:
    |\
    H. **Обработка ответа**:

    Где:
    - **Проверка зависимостей** - проверяется наличие библиотеки `curl_cffi`. Если библиотека отсутствует, то вызывается исключение `MissingRequirementsError`.
    - **Подготовка запроса** - подготовка запроса, объединение системного сообщения `SYSTEM_PROMPT` с сообщениями пользователя.
    - **Создание сессии** - создание сессии `curl_cffi.requests.Session` для выполнения HTTP-запросов с автоматическим обходом Cloudflare.
    - **Установка заголовков** - установка заголовков запроса, User-Agent, Referer, Origin, Accept, Accept-Language и Content-Type.
    - **Получение `nonce` и `post_id`** - получение `nonce` (одноразовый токен) и `post_id` (идентификатор поста) со страницы ChatGptEs.
    - **Формирование данных** - формирование данных для POST-запроса, включая `nonce`, `post_id`, URL, действие, сообщение, идентификатор бота, идентификатор чат-бота, `client_id` и историю чата.
    - **Отправка POST-запроса** - отправка POST-запроса к API endpoint ChatGptEs.
    - **Обработка ответа** - обработка ответа, проверка кода состояния HTTP и формата ответа.

    """
    ...
```

## Исключения

-   `MissingRequirementsError`: Вызывается, если отсутствует библиотека `curl_cffi`.
-   `ValueError`: Вызывается, если получен неожиданный формат ответа или произошла ошибка при запросе.