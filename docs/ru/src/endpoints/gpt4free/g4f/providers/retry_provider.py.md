# Модуль retry_provider

## Обзор

Модуль `retry_provider` содержит классы `IterListProvider` и `RetryProvider`, предназначенные для организации повторных попыток использования различных провайдеров для выполнения задач, таких как создание текста или асинхронной генерации контента. Он предоставляет механизмы для перебора списка провайдеров, повторных попыток при сбоях и выбора подходящего провайдера в зависимости от поддержки потоковой передачи данных.

## Подробнее

Этот модуль предоставляет инструменты для повышения отказоустойчивости при работе с различными поставщиками услуг, позволяя автоматически переключаться на другого провайдера в случае сбоя. Классы `IterListProvider` и `RetryProvider` позволяют разработчикам легко интегрировать механизмы повторных попыток в свои приложения, обеспечивая более надежную работу с внешними сервисами.

## Классы

### `IterListProvider`

**Описание**:
Класс `IterListProvider` является базовым классом для реализации логики перебора списка провайдеров. Он принимает список провайдеров и пытается использовать каждый из них для выполнения задачи. Если провайдер не поддерживает потоковую передачу данных или его имя находится в списке игнорируемых, он пропускается.

**Принцип работы**:

1.  При инициализации класса `IterListProvider` получает список провайдеров, флаг перемешивания списка и другие параметры.
2.  Метод `create_completion` перебирает список провайдеров и пытается использовать каждый из них для создания завершения.
3.  Если провайдер возвращает результат, функция возвращает этот результат. Если провайдер вызывает исключение, функция переходит к следующему провайдеру.
4.  Метод `create_async_generator` выполняет аналогичные действия в асинхронном режиме.
5.  Метод `get_providers` возвращает список провайдеров, поддерживающих потоковую передачу данных и не находящихся в списке игнорируемых.

**Методы**:

-   `__init__(self, providers: List[Type[BaseProvider]], shuffle: bool = True) -> None`:
    Инициализирует экземпляр класса `IterListProvider`.

    **Параметры**:

    -   `providers` (List[Type[BaseProvider]]): Список провайдеров для использования.
    -   `shuffle` (bool, optional): Флаг, указывающий, следует ли перемешивать список провайдеров. По умолчанию `True`.

-   `create_completion(self, model: str, messages: Messages, stream: bool = False, ignore_stream: bool = False, ignored: list[str] = [], **kwargs) -> CreateResult`:
    Создает завершение, используя доступных провайдеров, с возможностью потоковой передачи ответа.

    **Параметры**:

    -   `model` (str): Модель, используемая для завершения.
    -   `messages` (Messages): Сообщения, используемые для генерации завершения.
    -   `stream` (bool, optional): Флаг, указывающий, следует ли использовать потоковую передачу ответа. По умолчанию `False`.
    -   `ignore_stream` (bool, optional): Флаг, указывающий, следует ли игнорировать потоковую передачу. По умолчанию `False`.
    -   `ignored` (list[str], optional): Список имен провайдеров, которые следует игнорировать. По умолчанию `[]`.
    -   `**kwargs`: Дополнительные аргументы, передаваемые провайдеру.

    **Возвращает**:

    -   `CreateResult`: Токены или результаты завершения.

    **Вызывает исключения**:

    -   `Exception`: Любое исключение, возникшее в процессе завершения.

    **Как работает функция**:

    1.  Функция `create_completion` принимает модель, сообщения и флаг потоковой передачи в качестве входных данных.
    2.  Функция перебирает доступных провайдеров, полученных из метода `get_providers`.
    3.  Для каждого провайдера функция пытается создать завершение с использованием метода `get_create_function`.
    4.  Если создание завершения успешно, функция возвращает результат. Если возникает исключение, функция переходит к следующему провайдеру.
    5.  Если все провайдеры вызывают исключения, функция вызывает исключение `raise_exceptions`.

-   `create_async_generator(self, model: str, messages: Messages, stream: bool = True, ignore_stream: bool = False, ignored: list[str] = [], **kwargs) -> AsyncResult`:
    Создает асинхронный генератор, использующий доступных провайдеров, с возможностью потоковой передачи ответа.

    **Параметры**:

    -   `model` (str): Модель, используемая для генерации.
    -   `messages` (Messages): Сообщения, используемые для генерации.
    -   `stream` (bool, optional): Флаг, указывающий, следует ли использовать потоковую передачу. По умолчанию `True`.
    -   `ignore_stream` (bool, optional): Флаг, указывающий, следует ли игнорировать потоковую передачу. По умолчанию `False`.
    -   `ignored` (list[str], optional): Список имен провайдеров, которые следует игнорировать. По умолчанию `[]`.
    -   `**kwargs`: Дополнительные аргументы, передаваемые провайдеру.

    **Возвращает**:

    -   `AsyncResult`: Асинхронный генератор токенов или результатов.

    **Вызывает исключения**:

    -   `Exception`: Любое исключение, возникшее в процессе генерации.

    **Как работает функция**:

    1.  Функция `create_async_generator` принимает модель, сообщения и флаг потоковой передачи в качестве входных данных.
    2.  Функция перебирает доступных провайдеров, полученных из метода `get_providers`.
    3.  Для каждого провайдера функция пытается создать асинхронный генератор с использованием метода `get_async_create_function`.
    4.  Если создание генератора успешно, функция возвращает результат. Если возникает исключение, функция переходит к следующему провайдеру.
    5.  Если все провайдеры вызывают исключения, функция вызывает исключение `raise_exceptions`.

-   `get_create_function(self) -> callable`:
    Возвращает функцию создания завершения.

    **Возвращает**:

    -   `callable`: Функция `create_completion`.

-   `get_async_create_function(self) -> callable`:
    Возвращает асинхронную функцию создания генератора.

    **Возвращает**:

    -   `callable`: Функция `create_async_generator`.

-   `get_providers(self, stream: bool, ignored: list[str]) -> list[ProviderType]`:
    Возвращает список провайдеров, поддерживающих потоковую передачу данных и не находящихся в списке игнорируемых.

    **Параметры**:

    -   `stream` (bool): Флаг, указывающий, требуется ли потоковая передача.
    -   `ignored` (list[str]): Список имен провайдеров, которые следует игнорировать.

    **Возвращает**:

    -   `list[ProviderType]`: Список провайдеров.

    **Как работает функция**:

    1.  Функция `get_providers` принимает флаг потоковой передачи и список игнорируемых провайдеров в качестве входных данных.
    2.  Функция фильтрует список провайдеров, чтобы вернуть только те, которые поддерживают потоковую передачу (если требуется) и не находятся в списке игнорируемых.
    3.  Если флаг перемешивания установлен, функция перемешивает список провайдеров случайным образом.
    4.  Функция возвращает отфильтрованный и, возможно, перемешанный список провайдеров.

**Примеры**:

```python
from typing import List, Type
from g4f.providers import BaseProvider, RetryProvider

# Пример создания экземпляра IterListProvider
providers: List[Type[BaseProvider]] = [...]  #  <Список провайдеров>
iter_list_provider = RetryProvider(providers=providers, shuffle=True)

# Пример использования IterListProvider для создания завершения
model: str = "gpt-3.5-turbo"
messages: Messages = [...]  # <Список сообщений>
stream: bool = False
result = iter_list_provider.create_completion(model=model, messages=messages, stream=stream)
```

### `RetryProvider`

**Описание**:

Класс `RetryProvider` наследуется от `IterListProvider` и добавляет логику повторных попыток для одного провайдера. Если `single_provider_retry` установлен в `True`, он будет повторять попытки только для первого провайдера в списке до `max_retries` раз, прежде чем перейти к следующему провайдеру.

**Принцип работы**:

1.  При инициализации класса `RetryProvider` получает список провайдеров, флаг перемешивания списка, флаг повторных попыток для одного провайдера и максимальное количество повторных попыток.
2.  Метод `create_completion` проверяет, установлен ли флаг `single_provider_retry`.
3.  Если флаг установлен, функция повторяет попытки для первого провайдера в списке до `max_retries` раз.
4.  Если флаг не установлен, функция вызывает метод `create_completion` родительского класса `IterListProvider`.
5.  Метод `create_async_generator` выполняет аналогичные действия в асинхронном режиме.

**Методы**:

-   `__init__(self, providers: List[Type[BaseProvider]], shuffle: bool = True, single_provider_retry: bool = False, max_retries: int = 3) -> None`:
    Инициализирует экземпляр класса `RetryProvider`.

    **Параметры**:

    -   `providers` (List[Type[BaseProvider]]): Список провайдеров для использования.
    -   `shuffle` (bool, optional): Флаг, указывающий, следует ли перемешивать список провайдеров. По умолчанию `True`.
    -   `single_provider_retry` (bool, optional): Флаг, указывающий, следует ли повторять попытки только для одного провайдера. По умолчанию `False`.
    -   `max_retries` (int, optional): Максимальное количество повторных попыток для одного провайдера. По умолчанию `3`.

-   `create_completion(self, model: str, messages: Messages, stream: bool = False, **kwargs) -> CreateResult`:
    Создает завершение, используя доступных провайдеров, с возможностью повторных попыток для одного провайдера.

    **Параметры**:

    -   `model` (str): Модель, используемая для завершения.
    -   `messages` (Messages): Сообщения, используемые для генерации завершения.
    -   `stream` (bool, optional): Флаг, указывающий, следует ли использовать потоковую передачу ответа. По умолчанию `False`.
    -   `**kwargs`: Дополнительные аргументы, передаваемые провайдеру.

    **Возвращает**:

    -   `CreateResult`: Токены или результаты завершения.

    **Вызывает исключения**:

    -   `Exception`: Любое исключение, возникшее в процессе завершения.

    **Как работает функция**:

    1.  Функция `create_completion` принимает модель, сообщения и флаг потоковой передачи в качестве входных данных.
    2.  Функция проверяет, установлен ли флаг `single_provider_retry`.
    3.  Если флаг установлен, функция повторяет попытки для первого провайдера в списке до `max_retries` раз.
    4.  Если флаг не установлен, функция вызывает метод `create_completion` родительского класса `IterListProvider`.
    5.  Если все попытки завершаются неудачно, функция вызывает исключение `raise_exceptions`.

-   `create_async_generator(self, model: str, messages: Messages, stream: bool = True, **kwargs) -> AsyncResult`:
    Создает асинхронный генератор, используя доступных провайдеров, с возможностью повторных попыток для одного провайдера.

    **Параметры**:

    -   `model` (str): Модель, используемая для генерации.
    -   `messages` (Messages): Сообщения, используемые для генерации.
    -   `stream` (bool, optional): Флаг, указывающий, следует ли использовать потоковую передачу. По умолчанию `True`.
    -   `**kwargs`: Дополнительные аргументы, передаваемые провайдеру.

    **Возвращает**:

    -   `AsyncResult`: Асинхронный генератор токенов или результатов.

    **Вызывает исключения**:

    -   `Exception`: Любое исключение, возникшее в процессе генерации.

    **Как работает функция**:

    1.  Функция `create_async_generator` принимает модель, сообщения и флаг потоковой передачи в качестве входных данных.
    2.  Функция проверяет, установлен ли флаг `single_provider_retry`.
    3.  Если флаг установлен, функция повторяет попытки для первого провайдера в списке до `max_retries` раз.
    4.  Если флаг не установлен, функция вызывает метод `create_async_generator` родительского класса `IterListProvider`.
    5.  Если все попытки завершаются неудачно, функция вызывает исключение `raise_exceptions`.

**Примеры**:

```python
from typing import List, Type
from g4f.providers import BaseProvider, RetryProvider

# Пример создания экземпляра RetryProvider
providers: List[Type[BaseProvider]] = [...]  #  <Список провайдеров>
retry_provider = RetryProvider(providers=providers, shuffle=True, single_provider_retry=True, max_retries=5)

# Пример использования RetryProvider для создания завершения
model: str = "gpt-3.5-turbo"
messages: Messages = [...]  # <Список сообщений>
stream: bool = False
result = retry_provider.create_completion(model=model, messages=messages, stream=stream)
```

## Функции

### `raise_exceptions(exceptions: dict) -> None`

**Описание**:
Функция `raise_exceptions` вызывает исключение, если во время повторных попыток произошли какие-либо исключения.

**Параметры**:

-   `exceptions` (dict): Словарь исключений, возникших во время повторных попыток.

**Вызывает исключения**:

-   `RetryProviderError`: Если какой-либо провайдер столкнулся с исключением.
-   `RetryNoProviderError`: Если не найдено ни одного провайдера.

**Как работает функция**:

1.  Функция `raise_exceptions` принимает словарь исключений в качестве входных данных.
2.  Если словарь не пуст, функция вызывает исключение `RetryProviderError` с сообщением, содержащим информацию об исключениях, вызванных каждым провайдером.
3.  Если словарь пуст, функция вызывает исключение `RetryNoProviderError` с сообщением о том, что не найдено ни одного провайдера.

**Примеры**:

```python
exceptions: dict = {}  #  <Словарь исключений>
raise_exceptions(exceptions=exceptions)