# Модуль для валидации данных в Tiny Troupe
## Обзор

Модуль `validation.py` предоставляет набор функций для валидации и очистки данных, используемых в проекте Tiny Troupe. Он включает в себя функции для проверки допустимых полей в словарях и для очистки строк от недопустимых символов, обеспечивая безопасность и корректность данных.

## Подробней

Этот модуль важен для обеспечения целостности и безопасности данных, передаваемых между различными компонентами системы Tiny Troupe. Функции, предоставляемые модулем, помогают предотвратить ошибки, связанные с некорректными или вредоносными данными, и обеспечивают стабильную работу системы.

## Функции

### `check_valid_fields`

```python
def check_valid_fields(obj: dict, valid_fields: list) -> None:
    """
    Проверяет, являются ли поля в указанном словаре допустимыми, в соответствии со списком допустимых полей. Если нет, вызывает исключение ValueError.
    """
```

**Назначение**: Проверка наличия недопустимых полей в словаре.

**Параметры**:

-   `obj` (dict): Словарь для проверки.
-   `valid_fields` (list): Список допустимых полей.

**Возвращает**:

-   None

**Вызывает исключения**:

-   `ValueError`: Если в словаре обнаружено недопустимое поле.

**Как работает функция**:

1.  Функция перебирает все ключи в переданном словаре `obj`.
2.  Для каждого ключа проверяется, присутствует ли он в списке допустимых полей `valid_fields`.
3.  Если ключ не найден в списке допустимых полей, функция возбуждает исключение `ValueError` с сообщением об ошибке, указывающим недопустимый ключ и список допустимых ключей.

```
Проверка полей
│
├─── Ключ из словаря присутствует в списке допустимых полей?
│    ├─── Да: Переход к следующему ключу
│    └─── Нет: Выброс исключения ValueError
│
Конец
```

**Примеры**:

```python
# Пример 1: Успешная проверка
data = {"name": "John", "age": 30}
valid_keys = ["name", "age"]
check_valid_fields(data, valid_keys)  # Функция не вызовет исключение

# Пример 2: Неуспешная проверка
data = {"name": "John", "age": 30, "city": "New York"}
valid_keys = ["name", "age"]
# check_valid_fields(data, valid_keys)  # Функция вызовет исключение ValueError
```

### `sanitize_raw_string`

```python
def sanitize_raw_string(value: str) -> str:
    """
    Очищает указанную строку путем:
      - удаления любых недопустимых символов.
      - обеспечения того, чтобы она не была длиннее максимальной длины строки Python.

    Это делается из соображений предосторожности с безопасностью, чтобы избежать любых потенциальных проблем со строкой.
    """
```

**Назначение**: Очистка строки от недопустимых символов и ограничение ее длины.

**Параметры**:

-   `value` (str): Строка для очистки.

**Возвращает**:

-   `str`: Очищенная строка.

**Как работает функция**:

1.  **Удаление недопустимых символов**: Строка кодируется в UTF-8 с игнорированием ошибок, а затем декодируется обратно. Это позволяет удалить любые недопустимые символы, несовместимые с UTF-8.
2.  **Нормализация Unicode**: Строка нормализуется с использованием формы NFC, что обеспечивает консистентность представления Unicode.
3.  **Ограничение длины**: Строка обрезается до максимальной длины, допустимой в Python (`sys.maxsize`), чтобы предотвратить потенциальные проблемы с безопасностью и производительностью.

```
Очистка строки
│
├─── Кодирование в UTF-8 (игнорирование ошибок) и декодирование обратно
│    │
│    Удаление недопустимых символов
│
├─── Нормализация Unicode (NFC)
│    │
│    Обеспечение консистентности представления Unicode
│
├─── Обрезка строки до максимальной длины (sys.maxsize)
│    │
│    Предотвращение проблем с безопасностью и производительностью
│
Конец
```

**Примеры**:

```python
# Пример 1: Очистка строки с недопустимыми символами
raw_string = "H\x80ello"  # Строка содержит недопустимый символ \x80
sanitized_string = sanitize_raw_string(raw_string)
print(sanitized_string)  # Вывод: Hello

# Пример 2: Очистка длинной строки
long_string = "A" * (sys.maxsize + 100)  # Создание строки, превышающей максимальную длину
sanitized_string = sanitize_raw_string(long_string)
print(len(sanitized_string))  # Вывод: sys.maxsize
```

### `sanitize_dict`

```python
def sanitize_dict(value: dict) -> dict:
    """
    Очищает указанный словарь путем:
      - удаления любых недопустимых символов.
      - обеспечения того, чтобы словарь не был слишком глубоко вложен.
    """
```

**Назначение**: Очистка словаря, применяя функцию `sanitize_raw_string` к строковым значениям.

**Параметры**:

-   `value` (dict): Словарь для очистки.

**Возвращает**:

-   `dict`: Очищенный словарь.

**Как работает функция**:

1.  Функция перебирает все пары ключ-значение в переданном словаре `value`.
2.  Для каждого значения проверяется, является ли оно строкой.
3.  Если значение является строкой, к нему применяется функция `sanitize_raw_string` для очистки строки от недопустимых символов.
4.  Очищенное значение присваивается соответствующему ключу в словаре.

```
Очистка словаря
│
├─── Перебор пар ключ-значение в словаре
│    │
│    Проверка: Значение является строкой?
│    ├─── Да: Применение sanitize_raw_string к значению
│    └─── Нет: Переход к следующей паре
│
Конец
```

**Примеры**:

```python
# Пример 1: Очистка словаря со строковыми значениями
raw_dict = {"name": "John\x80", "age": "30", "city": "New York"}
sanitized_dict = sanitize_dict(raw_dict)
print(sanitized_dict)  # Вывод: {'name': 'John', 'age': '30', 'city': 'New York'}

# Пример 2: Словарь с разными типами данных
raw_dict = {"name": "John\x80", "age": 30, "address": {"street": "Main St"}}
sanitized_dict = sanitize_dict(raw_dict)
print(sanitized_dict)  # Вывод: {'name': 'John', 'age': 30, 'address': {'street': 'Main St'}}