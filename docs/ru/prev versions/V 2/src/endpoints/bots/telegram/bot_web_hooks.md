# Документация модуля `bot_web_hooks.py`

## Оглавление

1. [Обзор](#обзор)
2. [Классы](#классы)
    - [TelegramBot](#telegrambot)
        - [`__init__`](#__init__)
        - [`_register_handlers`](#_register_handlers)
        - [`_handle_message`](#_handle_message)
3. [Функции](#функции)
    - [`telegram_webhook`](#telegram_webhook)
    - [`initialize_bot`](#initialize_bot)
    - [`startup_event`](#startup_event)
    - [`shutdown_event`](#shutdown_event)
4. [Декораторы](#декораторы)
    - [`@app.on_event("startup")`](#appon_eventstartup)
    - [`@app.on_event("shutdown")`](#appon_eventshutdown)
    - [`@app.add_route("/telegram_webhook", telegram_webhook, methods=["POST"])`](#appadd_route_telegram_webhook)
5. [Прочее](#прочее)
   - [`app.register_router()`](#appregister_router)
   - [`app.run()`](#apprun)
   - [`if __name__ == "__main__":`](#if__name____main__)
6. [Конфигурация](#конфигурация)
7. [Переменные окружения](#переменные-окружения)
8. [Запуск бота](#запуск-бота)

## Обзор

Данный модуль содержит класс `TelegramBot`, который обеспечивает интеграцию Telegram-бота с сервером FastAPI. Он обрабатывает webhook-обновления от Telegram и поддерживает polling как запасной вариант. Модуль также включает функции для инициализации и запуска бота, а также для обработки входящих webhook-запросов.

## Классы

### `TelegramBot`

**Описание**: Класс для управления Telegram-ботом, его настройками и обработкой сообщений.

#### `__init__`

**Описание**: Инициализирует экземпляр класса `TelegramBot`.

**Параметры**:
- `token` (str): Токен Telegram-бота, полученный от BotFather.
- `port` (int): Порт, на котором будет работать сервер FastAPI.
- `webhook_url` (Optional[str], optional): URL-путь для webhook-эндпоинта. По умолчанию `/telegram_webhook`.
- `bot_handler` (Optional[BotHandler], optional): Экземпляр класса `BotHandler` для делегирования обработки сообщений. По умолчанию `None`.
- `fast_api` (FastApi, optional): Экземпляр класса `FastApi` для запуска сервера. По умолчанию `None`.

**Возвращает**:
- `None`: Метод не возвращает значения.

**Вызывает исключения**:
- `None`: Метод не вызывает исключений.

#### `_register_handlers`

**Описание**: Регистрирует обработчики команд и сообщений для Telegram-бота.

**Параметры**:
- `None`: Метод не принимает параметров.

**Возвращает**:
- `None`: Метод не возвращает значения.

**Вызывает исключения**:
- `None`: Метод не вызывает исключений.

#### `_handle_message`

**Описание**: Обрабатывает входящие текстовые сообщения от пользователя.

**Параметры**:
- `update` (Update): Объект, содержащий входящее обновление от Telegram.
- `context` (CallbackContext): Объект контекста для текущего обновления, предоставляющий информацию о боте.

**Возвращает**:
- `None`: Метод не возвращает значения.

**Вызывает исключения**:
- `None`: Метод не вызывает исключений.

## Функции

### `telegram_webhook`

**Описание**: Обрабатывает входящие webhook-запросы от Telegram.

**Параметры**:
- `request` (Request): Объект, представляющий входящий HTTP-запрос от Telegram.

**Возвращает**:
- `Response`: Возвращает ответ со статусом 200 при успехе, или 500 при ошибке.

**Вызывает исключения**:
- `JSONDecodeError`: Ошибка возникает при невозможности декодирования JSON из запроса.
- `Exception`: Общая ошибка при обработке обновления.

### `initialize_bot`

**Описание**: Инициализирует экземпляр `TelegramBot` и устанавливает webhook.

**Параметры**:
- `token` (str): Токен Telegram-бота.
- `port` (int): Порт для сервера FastAPI.

**Возвращает**:
- `None`: Метод не возвращает значения.

**Вызывает исключения**:
- `None`: Метод не вызывает исключений.

### `startup_event`

**Описание**: Запускает бота при старте приложения FastAPI.

**Параметры**:
- `None`: Метод не принимает параметров.

**Возвращает**:
- `None`: Метод не возвращает значения.

**Вызывает исключения**:
- `None`: Метод не вызывает исключений.

### `shutdown_event`

**Описание**: Удаляет webhook при завершении работы приложения FastAPI.

**Параметры**:
- `None`: Метод не принимает параметров.

**Возвращает**:
- `None`: Метод не возвращает значения.

**Вызывает исключения**:
- `None`: Метод не вызывает исключений.

## Декораторы

### `@app.on_event("startup")`

**Описание**: Декоратор для регистрации функции `startup_event` для запуска при старте FastAPI.

**Параметры**:
- `None`: Декоратор не принимает параметров.

**Возвращает**:
- `None`: Декоратор не возвращает значения.

**Вызывает исключения**:
- `None`: Декоратор не вызывает исключений.

### `@app.on_event("shutdown")`

**Описание**: Декоратор для регистрации функции `shutdown_event` для запуска при завершении работы FastAPI.

**Параметры**:
- `None`: Декоратор не принимает параметров.

**Возвращает**:
- `None`: Декоратор не возвращает значения.

**Вызывает исключения**:
- `None`: Декоратор не вызывает исключений.

### `@app.add_route("/telegram_webhook", telegram_webhook, methods=["POST"])`

**Описание**: Декоратор для регистрации маршрута `/telegram_webhook` для обработки POST-запросов.

**Параметры**:
- `/telegram_webhook` (str): URL-путь, на который будут отправляться webhook-сообщения.
- `telegram_webhook` (function): Функция, которая будет обрабатывать запросы.
- `methods` (list): Список HTTP-методов, которые будет принимать данный маршрут.

**Возвращает**:
- `None`: Декоратор не возвращает значения.

**Вызывает исключения**:
- `None`: Декоратор не вызывает исключений.

## Прочее

### `app.register_router()`

**Описание**: Регистрирует маршрутизатор со всеми маршрутами для приложения.

**Параметры**:
- `None`: Метод не принимает параметров.

**Возвращает**:
- `None`: Метод не возвращает значения.

**Вызывает исключения**:
- `None`: Метод не вызывает исключений.

### `app.run()`

**Описание**: Запускает приложение на адресе и порту, установленных в классе `FastApi`.

**Параметры**:
- `None`: Метод не принимает параметров.

**Возвращает**:
- `None`: Метод не возвращает значения.

**Вызывает исключения**:
- `None`: Метод не вызывает исключений.

### `if __name__ == "__main__":`

**Описание**: Блок кода, выполняющийся при запуске скрипта напрямую. Инициализирует FastAPI приложение и запускает его.

**Параметры**:
- `None`: Блок не принимает параметров.

**Возвращает**:
- `None`: Блок не возвращает значения.

**Вызывает исключения**:
- `None`: Блок не вызывает исключений.

## Конфигурация

-   Конфигурация бота загружается из `src/endpoints/bots/telegram/telegram.json`.
-   Конфигурация FastAPI загружается из `src/fast_api/fast_api.json`.

## Переменные окружения

-   `TELEGRAM_BOT_TOKEN`: Токен Telegram-бота.
-   `PORT`: Номер порта, на котором будет работать сервер FastAPI.

## Запуск бота

1.  Убедитесь, что установлен Python 3.7+.
2.  Установите необходимые пакеты: `pip install -r requirements.txt`.
3.  Создайте `.env` файл или задайте переменные окружения `TELEGRAM_BOT_TOKEN` и `PORT`.
4.  Запустите скрипт: `python src/endpoints/bots/telegram/bot_web_hooks.py`.