### –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –º–æ–¥—É–ª—è `admin`

**–ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞**:
- **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º**: 7/10
- **–ü–ª—é—Å—ã**:
    -   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º.
    -   –ü—Ä–∏–º–µ–Ω—è—é—Ç—Å—è FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º.
    -   –ö–æ–¥ —Ä–∞–∑–±–∏—Ç –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ —É–ª—É—á—à–∞–µ—Ç —á–∏—Ç–∞–µ–º–æ—Å—Ç—å.
    -   –ï—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.
- **–ú–∏–Ω—É—Å—ã**:
    -   –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–≤–æ–π–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –º–µ—Å—Ç–∞—Ö, –≥–¥–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ.
    -   –ù–µ –≤–µ–∑–¥–µ –µ—Å—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
    -   –ú–Ω–æ–≥–æ `try-except` –±–ª–æ–∫–æ–≤ –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –±–æ–ª–µ–µ —ç–ª–µ–≥–∞–Ω—Ç–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫.
    -   –ù–µ–∫–æ—Ç–æ—Ä—ã–µ —É—á–∞—Å—Ç–∫–∏ –∫–æ–¥–∞ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –±–æ–ª–µ–µ –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º–∏ –∏ —á–∏—Ç–∞–µ–º—ã–º–∏.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é**:
-   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫, –∫—Ä–æ–º–µ `print`, `input` –∏ `logger.error`.
-   –î–æ–±–∞–≤–∏—Ç—å RST-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏ –∫–ª–∞—Å—Å–æ–≤.
-   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `logger.error` –≤–º–µ—Å—Ç–æ –æ–±—â–∏—Ö `except Exception`.
-   –ò–∑–±–µ–≥–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è –∫–æ–¥–∞.
-   –£–ª—É—á—à–∏—Ç—å –∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –¥–ª—è –±–æ–ª—å—à–µ–π —è—Å–Ω–æ—Å—Ç–∏.
-   –£–±—Ä–∞—Ç—å –ª–∏—à–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, –∑–∞–º–µ–Ω–∏–≤ –∏—Ö –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–º–∏ –æ–ø–∏—Å–∞–Ω–∏—è–º–∏ –¥–µ–π—Å—Ç–≤–∏–π.
-   –ü—Ä–∏–≤–µ—Å—Ç–∏ –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã –≤ –ø–æ—Ä—è–¥–æ–∫.
-   –£–¥–∞–ª–∏—Ç—å –ª–∏—à–Ω–∏–µ `try-except` –±–ª–æ–∫–∏, –≥–¥–µ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ, –∏ –¥–æ–±–∞–≤–∏—Ç—å `logger.error` –≤ –æ—Å—Ç–∞–≤—à–∏–µ—Å—è.

**–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥**:

```python
"""
–ú–æ–¥—É–ª—å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–π —á–∞—Å—Ç—å—é –±–æ—Ç–∞.
==================================================

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–±–æ—Ä —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏, —Ç–æ–≤–∞—Ä–∞–º–∏ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π –±–æ—Ç–∞.
–û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç FSM (–∫–æ–Ω–µ—á–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç—ã) –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.

–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
--------------------
.. code-block:: python

    from aiogram import Dispatcher
    from bot.admin.admin import admin_router

    dp = Dispatcher()
    dp.include_router(admin_router)
"""
import asyncio
from aiogram import Router, F
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import StatesGroup, State
from aiogram.types import CallbackQuery, Message
from sqlalchemy.ext.asyncio import AsyncSession

from bot.config import settings, bot
from bot.dao.dao import UserDAO, ProductDao, CategoryDao, PurchaseDao
from bot.admin.kbs import (
    admin_kb,
    admin_kb_back,
    product_management_kb,
    cancel_kb_inline,
    catalog_admin_kb,
    admin_send_file_kb,
    admin_confirm_kb,
    dell_product_kb
)
from bot.admin.schemas import ProductModel, ProductIDModel
from bot.admin.utils import process_dell_text_msg
from src.logger import logger # –ò—Å–ø–æ–ª—å–∑—É–µ–º –∏–º–ø–æ—Ä—Ç logger –∏–∑ src.logger

admin_router = Router()


class AddProduct(StatesGroup):
    """
    –ö–ª–∞—Å—Å –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞.

    :ivar name: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ —Ç–æ–≤–∞—Ä–∞.
    :vartype name: State
    :ivar description: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–≤–æ–¥–∞ –æ–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞.
    :vartype description: State
    :ivar price: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–≤–æ–¥–∞ —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞.
    :vartype price: State
    :ivar file_id: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–≤–æ–¥–∞ ID —Ñ–∞–π–ª–∞ —Ç–æ–≤–∞—Ä–∞.
    :vartype file_id: State
    :ivar category_id: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–≤–æ–¥–∞ ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞.
    :vartype category_id: State
    :ivar hidden_content: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –≤–≤–æ–¥–∞ —Å–∫—Ä—ã—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Ç–æ–≤–∞—Ä–∞.
    :vartype hidden_content: State
    :ivar confirm_add: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞.
    :vartype confirm_add: State
    """
    name = State()
    description = State()
    price = State()
    file_id = State()
    category_id = State()
    hidden_content = State()
    confirm_add = State()


@admin_router.callback_query(F.data == 'admin_panel', F.from_user.id.in_(settings.ADMIN_IDS))
async def start_admin(call: CallbackQuery):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å—é.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :raises Exception: –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.

    :return: None
    :rtype: None
    """
    await call.answer('–î–æ—Å—Ç—É–ø –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ä–∞–∑—Ä–µ—à–µ–Ω!')
    try:
        await call.message.edit_text(
            text='–í–∞–º —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å. –í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.',
            reply_markup=admin_kb()
        )
    except Exception as e:
        logger.error(f"Error editing message: {e}")  # –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        try:
            await call.message.delete()
            await call.message.answer(
                text='–í–∞–º —Ä–∞–∑—Ä–µ—à–µ–Ω –¥–æ—Å—Ç—É–ø –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å. –í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.',
                reply_markup=admin_kb()
            )
        except Exception as e:
            logger.error(f"Error sending message: {e}") # –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
            await call.message.answer(
                text='–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.',
                reply_markup=admin_kb()
            )


@admin_router.callback_query(F.data == 'statistic', F.from_user.id.in_(settings.ADMIN_IDS))
async def admin_statistic(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :param session_without_commit: –û–±—ä–µ–∫—Ç AsyncSession –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î.
    :type session_without_commit: AsyncSession

    :return: None
    :rtype: None
    """
    await call.answer('–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...')
    await call.answer('üìä –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...')

    stats = await UserDAO.get_statistics(session=session_without_commit)
    payment_stats = await PurchaseDao.get_payment_stats(session=session_without_commit)
    stats_message = (
        'üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:\\n\\n'
        f'üë• –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {stats["total_users"]}\\n'
        f'üÜï –ù–æ–≤—ã—Ö –∑–∞ —Å–µ–≥–æ–¥–Ω—è: {stats["new_today"]}\\n'
        f'üìÖ –ù–æ–≤—ã—Ö –∑–∞ –Ω–µ–¥–µ–ª—é: {stats["new_week"]}\\n'
        f'üìÜ –ù–æ–≤—ã—Ö –∑–∞ –º–µ—Å—è—Ü: {stats["new_month"]}\\n\\n'
        f'üí∞ –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞–∫–∞–∑–∞–º:\\n\\n{payment_stats}'
    )
    await call.message.edit_text(
        text=stats_message,
        reply_markup=admin_kb()
    )


@admin_router.callback_query(F.data == 'cancel', F.from_user.id.in_(settings.ADMIN_IDS))
async def admin_process_cancel(call: CallbackQuery, state: FSMContext):
    """
     –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–º–µ–Ω—ã —Ç–µ–∫—É—â–µ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :param state: –û–±—ä–µ–∫—Ç FSMContext –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏.
    :type state: FSMContext

    :return: None
    :rtype: None
    """
    await state.clear()
    await call.answer('–û—Ç–º–µ–Ω–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞')
    await call.message.delete()
    await call.message.answer(
        text='–û—Ç–º–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞.',
        reply_markup=admin_kb_back()
    )


@admin_router.callback_query(F.data == 'delete_product', F.from_user.id.in_(settings.ADMIN_IDS))
async def admin_process_start_dell(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :param session_without_commit: –û–±—ä–µ–∫—Ç AsyncSession –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î.
    :type session_without_commit: AsyncSession

    :return: None
    :rtype: None
    """
    await call.answer('–†–µ–∂–∏–º —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤')
    all_products = await ProductDao.find_all(session=session_without_commit)

    await call.message.edit_text(
        text=f'–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö {len(all_products)} —Ç–æ–≤–∞—Ä–æ–≤. –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ'
    )
    for product_data in all_products:
        file_id = product_data.file_id
        file_text = 'üì¶ –¢–æ–≤–∞—Ä —Å —Ñ–∞–π–ª–æ–º' if file_id else 'üìÑ –¢–æ–≤–∞—Ä –±–µ–∑ —Ñ–∞–π–ª–∞'

        product_text = (f'üõí –û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:\\n\\n'
                        f'üîπ <b>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:</b> <b>{product_data.name}</b>\\n'
                        f'üîπ <b>–û–ø–∏—Å–∞–Ω–∏–µ:</b>\\n\\n<b>{product_data.description}</b>\\n\\n'
                        f'üîπ <b>–¶–µ–Ω–∞:</b> <b>{product_data.price} ‚ÇΩ</b>\\n'
                        f'üîπ <b>–û–ø–∏—Å–∞–Ω–∏–µ (–∑–∞–∫—Ä—ã—Ç–æ–µ):</b>\\n\\n<b>{product_data.hidden_content}</b>\\n\\n'
                        f'<b>{file_text}</b>')
        if file_id:
            await call.message.answer_document(document=file_id, caption=product_text,
                                               reply_markup=dell_product_kb(product_data.id))
        else:
            await call.message.answer(text=product_text, reply_markup=dell_product_kb(product_data.id))


@admin_router.callback_query(F.data.startswith('dell_'), F.from_user.id.in_(settings.ADMIN_IDS))
async def admin_process_delete_product(call: CallbackQuery, session_with_commit: AsyncSession):
    """
     –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –ø–æ –µ–≥–æ ID.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :param session_with_commit: –û–±—ä–µ–∫—Ç AsyncSession –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î.
    :type session_with_commit: AsyncSession

    :return: None
    :rtype: None
    """
    product_id = int(call.data.split('_')[-1])
    await ProductDao.delete(session=session_with_commit, filters=ProductIDModel(id=product_id))
    await call.answer(f'–¢–æ–≤–∞—Ä —Å ID {product_id} —É–¥–∞–ª–µ–Ω!', show_alert=True)
    await asyncio.sleep(1.5)
    await call.message.delete()


@admin_router.callback_query(F.data == 'process_products', F.from_user.id.in_(settings.ADMIN_IDS))
async def admin_process_products(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞–º–∏.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :param session_without_commit: –û–±—ä–µ–∫—Ç AsyncSession –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î.
    :type session_without_commit: AsyncSession

    :return: None
    :rtype: None
    """
    await call.answer('–†–µ–∂–∏–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞–º–∏')
    all_products_count = await ProductDao.count(session=session_without_commit)
    await call.message.edit_text(
        text=f'–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö {all_products_count} —Ç–æ–≤–∞—Ä–æ–≤. –ß—Ç–æ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å?',
        reply_markup=product_management_kb()
    )


@admin_router.callback_query(F.data == 'add_product', F.from_user.id.in_(settings.ADMIN_IDS))
async def admin_process_add_product(call: CallbackQuery, state: FSMContext):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :param state: –û–±—ä–µ–∫—Ç FSMContext –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏.
    :type state: FSMContext

    :return: None
    :rtype: None
    """
    await call.answer('–ó–∞–ø—É—â–µ–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞.')
    await call.message.delete()
    msg = await call.message.answer(text='–î–ª—è –Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ –∏–º—è —Ç–æ–≤–∞—Ä–∞: ', reply_markup=cancel_kb_inline())
    await state.update_data(last_msg_id=msg.message_id)
    await state.set_state(AddProduct.name)


@admin_router.message(F.text, F.from_user.id.in_(settings.ADMIN_IDS), AddProduct.name)
async def admin_process_name(message: Message, state: FSMContext):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ —Ç–æ–≤–∞—Ä–∞.

    :param message: –û–±—ä–µ–∫—Ç Message.
    :type message: Message
    :param state: –û–±—ä–µ–∫—Ç FSMContext –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏.
    :type state: FSMContext

    :return: None
    :rtype: None
    """
    await state.update_data(name=message.text)
    await process_dell_text_msg(message, state)
    msg = await message.answer(text='–¢–µ–ø–µ—Ä—å –¥–∞–π—Ç–µ –∫–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä—É: ', reply_markup=cancel_kb_inline())
    await state.update_data(last_msg_id=msg.message_id)
    await state.set_state(AddProduct.description)


@admin_router.message(F.text, F.from_user.id.in_(settings.ADMIN_IDS), AddProduct.description)
async def admin_process_description(message: Message, state: FSMContext, session_without_commit: AsyncSession):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞.

    :param message: –û–±—ä–µ–∫—Ç Message.
    :type message: Message
    :param state: –û–±—ä–µ–∫—Ç FSMContext –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏.
    :type state: FSMContext
    :param session_without_commit: –û–±—ä–µ–∫—Ç AsyncSession –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î.
    :type session_without_commit: AsyncSession

    :return: None
    :rtype: None
    """
    await state.update_data(description=message.html_text)
    await process_dell_text_msg(message, state)
    catalog_data = await CategoryDao.find_all(session=session_without_commit)
    msg = await message.answer(text='–¢–µ–ø–µ—Ä—å –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ç–æ–≤–∞—Ä–∞: ', reply_markup=catalog_admin_kb(catalog_data))
    await state.update_data(last_msg_id=msg.message_id)
    await state.set_state(AddProduct.category_id)


@admin_router.callback_query(F.data.startswith('add_category_'),
                             F.from_user.id.in_(settings.ADMIN_IDS),
                             AddProduct.category_id)
async def admin_process_category(call: CallbackQuery, state: FSMContext):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–æ–≤–∞—Ä–∞.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :param state: –û–±—ä–µ–∫—Ç FSMContext –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏.
    :type state: FSMContext

    :return: None
    :rtype: None
    """
    category_id = int(call.data.split('_')[-1])
    await state.update_data(category_id=category_id)
    await call.answer('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –≤—ã–±—Ä–∞–Ω–∞.')
    msg = await call.message.edit_text(text='–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞: ', reply_markup=cancel_kb_inline())
    await state.update_data(last_msg_id=msg.message_id)
    await state.set_state(AddProduct.price)


@admin_router.message(F.text, F.from_user.id.in_(settings.ADMIN_IDS), AddProduct.price)
async def admin_process_price(message: Message, state: FSMContext):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞.

    :param message: –û–±—ä–µ–∫—Ç Message.
    :type message: Message
    :param state: –û–±—ä–µ–∫—Ç FSMContext –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏.
    :type state: FSMContext

    :return: None
    :rtype: None
    """
    try:
        price = int(message.text)
        await state.update_data(price=price)
        await process_dell_text_msg(message, state)
        msg = await message.answer(
            text='–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª (–¥–æ–∫—É–º–µ–Ω—Ç), –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ \'–ë–ï–ó –§–ê–ô–õ–ê\', –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è',
            reply_markup=admin_send_file_kb()
        )
        await state.update_data(last_msg_id=msg.message_id)
        await state.set_state(AddProduct.file_id)
    except ValueError:
        await message.answer(text='–û—à–∏–±–∫–∞! –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ —á–∏—Å–ª–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ü–µ–Ω—ã.')


@admin_router.callback_query(F.data == 'without_file', F.from_user.id.in_(settings.ADMIN_IDS), AddProduct.file_id)
async def admin_process_without_file(call: CallbackQuery, state: FSMContext):
    """
     –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ —Ñ–∞–π–ª –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :param state: –û–±—ä–µ–∫—Ç FSMContext –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏.
    :type state: FSMContext

    :return: None
    :rtype: None
    """
    await state.update_data(file_id=None)
    await call.answer('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω.')
    msg = await call.message.edit_text(
        text='–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–∞ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏',
        reply_markup=cancel_kb_inline())
    await state.update_data(last_msg_id=msg.message_id)
    await state.set_state(AddProduct.hidden_content)


@admin_router.message(F.document, F.from_user.id.in_(settings.ADMIN_IDS), AddProduct.file_id)
async def admin_process_file(message: Message, state: FSMContext):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–∞–π–ª–∞ —Ç–æ–≤–∞—Ä–∞.

    :param message: –û–±—ä–µ–∫—Ç Message.
    :type message: Message
    :param state: –û–±—ä–µ–∫—Ç FSMContext –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏.
    :type state: FSMContext

    :return: None
    :rtype: None
    """
    await state.update_data(file_id=message.document.file_id)
    await process_dell_text_msg(message, state)
    msg = await message.answer(
        text='–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ —Ç–æ–≤–∞—Ä–∞ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏',
        reply_markup=cancel_kb_inline())
    await state.update_data(last_msg_id=msg.message_id)
    await state.set_state(AddProduct.hidden_content)


@admin_router.message(F.text, F.from_user.id.in_(settings.ADMIN_IDS), AddProduct.hidden_content)
async def admin_process_hidden_content(message: Message, state: FSMContext, session_without_commit: AsyncSession):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∫—Ä—ã—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Ç–æ–≤–∞—Ä–∞.

    :param message: –û–±—ä–µ–∫—Ç Message.
    :type message: Message
    :param state: –û–±—ä–µ–∫—Ç FSMContext –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏.
    :type state: FSMContext
    :param session_without_commit: –û–±—ä–µ–∫—Ç AsyncSession –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î.
    :type session_without_commit: AsyncSession

    :return: None
    :rtype: None
    """
    await state.update_data(hidden_content=message.html_text)

    product_data = await state.get_data()
    category_info = await CategoryDao.find_one_or_none_by_id(session=session_without_commit,
                                                             data_id=product_data.get('category_id'))

    file_id = product_data.get('file_id')
    file_text = 'üì¶ –¢–æ–≤–∞—Ä —Å —Ñ–∞–π–ª–æ–º' if file_id else 'üìÑ –¢–æ–≤–∞—Ä –±–µ–∑ —Ñ–∞–π–ª–∞'

    product_text = (f'üõí –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –≤—Å–µ –ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:\\n\\n'
                    f'üîπ <b>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:</b> <b>{product_data["name"]}</b>\\n'
                    f'üîπ <b>–û–ø–∏—Å–∞–Ω–∏–µ:</b>\\n\\n<b>{product_data["description"]}</b>\\n\\n'
                    f'üîπ <b>–¶–µ–Ω–∞:</b> <b>{product_data["price"]} ‚ÇΩ</b>\\n'
                    f'üîπ <b>–û–ø–∏—Å–∞–Ω–∏–µ (–∑–∞–∫—Ä—ã—Ç–æ–µ):</b>\\n\\n<b>{product_data["hidden_content"]}</b>\\n\\n'
                    f'üîπ <b>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</b> <b>{category_info.category_name} (ID: {category_info.id})</b>\\n\\n'
                    f'<b>{file_text}</b>')
    await process_dell_text_msg(message, state)

    if file_id:
        msg = await message.answer_document(document=file_id, caption=product_text, reply_markup=admin_confirm_kb())
    else:
        msg = await message.answer(text=product_text, reply_markup=admin_confirm_kb())
    await state.update_data(last_msg_id=msg.message_id)
    await state.set_state(AddProduct.confirm_add)


@admin_router.callback_query(F.data == 'confirm_add', F.from_user.id.in_(settings.ADMIN_IDS))
async def admin_process_confirm_add(call: CallbackQuery, state: FSMContext, session_with_commit: AsyncSession):
    """
     –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞.

    :param call: –û–±—ä–µ–∫—Ç CallbackQuery.
    :type call: CallbackQuery
    :param state: –û–±—ä–µ–∫—Ç FSMContext –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏.
    :type state: FSMContext
    :param session_with_commit: –û–±—ä–µ–∫—Ç AsyncSession –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î.
    :type session_with_commit: AsyncSession

    :return: None
    :rtype: None
    """
    await call.answer('–ü—Ä–∏—Å—Ç—É–ø–∞—é –∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é —Ñ–∞–π–ª–∞!')
    product_data = await state.get_data()
    await bot.delete_message(chat_id=call.from_user.id, message_id=product_data['last_msg_id'])
    del product_data['last_msg_id']
    await ProductDao.add(session=session_with_commit, values=ProductModel(**product_data))
    await call.message.answer(text='–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö!', reply_markup=admin_kb())