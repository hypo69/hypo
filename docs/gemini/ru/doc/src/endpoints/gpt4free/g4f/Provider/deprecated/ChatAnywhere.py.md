# Модуль `ChatAnywhere`

## Обзор

Модуль `ChatAnywhere` предоставляет асинхронный генератор для взаимодействия с сервисом `chatanywhere.cn`. Он поддерживает модель `gpt-3.5-turbo` и сохраняет историю сообщений. Этот модуль предназначен для использования в качестве одного из провайдеров API для генерации текста на основе предоставленных сообщений.

## Подробнее

Модуль использует библиотеку `aiohttp` для выполнения асинхронных HTTP-запросов. Он отправляет сообщения пользователя на сервер `chatanywhere.cn` и возвращает сгенерированный текст в виде асинхронного генератора.

## Классы

### `ChatAnywhere`

**Описание**: Класс `ChatAnywhere` предоставляет асинхронный генератор для взаимодействия с сервисом `chatanywhere.cn`.

**Принцип работы**: Класс отправляет POST запросы к API `chatanywhere.cn` и асинхронно генерирует ответы на основе полученных данных.

**Аттрибуты**:

- `url` (str): URL сервиса `chatanywhere.cn`.
- `supports_gpt_35_turbo` (bool): Поддержка модели `gpt-3.5-turbo`.
- `supports_message_history` (bool): Поддержка сохранения истории сообщений.
- `working` (bool): Указывает, работает ли провайдер.

**Методы**:

- `create_async_generator`: Создает асинхронный генератор для получения ответов от API.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    timeout: int = 120,
    temperature: float = 0.5,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от API `chatanywhere.cn`.

    Args:
        model (str): Название модели.
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        timeout (int, optional): Время ожидания ответа в секундах. По умолчанию `120`.
        temperature (float, optional): Температура генерации текста. По умолчанию `0.5`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий текст от API.
    """
    ...
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор, который отправляет запросы к API `chatanywhere.cn` и возвращает ответы в виде чанков текста.

**Параметры**:

- `cls`: Ссылка на класс `ChatAnywhere`.
- `model` (str): Название модели, которую нужно использовать для генерации ответа.
- `messages` (Messages): Список сообщений, которые нужно отправить в API. Каждое сообщение содержит роль и контент.
- `proxy` (str, optional): URL прокси-сервера, если необходимо использовать прокси для подключения к API. По умолчанию `None`.
- `timeout` (int, optional): Максимальное время ожидания ответа от API в секундах. По умолчанию `120`.
- `temperature` (float, optional): Параметр, контролирующий случайность генерируемого текста. Значение 0.5 является значением по умолчанию.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API.

**Возвращает**:

- `AsyncResult`: Асинхронный генератор, который выдает чанки текста, полученные от API `chatanywhere.cn`.

**Как работает функция**:

1. **Подготовка заголовков**: Функция создает словарь `headers` с необходимыми HTTP-заголовками для запроса. Заголовки включают `User-Agent`, `Accept`, `Accept-Language`, `Content-Type`, `Referer`, `Origin`, `Sec-Fetch-*`, `Authorization` и `Connection`.
2. **Создание сессии `aiohttp`**: Функция использует `aiohttp.ClientSession` для управления HTTP-соединением. Сессия создается с заданными заголовками и таймаутом.
3. **Подготовка данных для запроса**: Функция создает словарь `data` с данными, которые будут отправлены в теле POST-запроса. Данные включают список сообщений (`messages`), идентификатор (`id`), заголовок (`title`), промпт (`prompt`), температуру (`temperature`), модель (`models`) и флаг непрерывности (`continuous`).
4. **Выполнение POST-запроса**: Функция отправляет POST-запрос к API `chatanywhere.cn` (`f"{cls.url}/v1/chat/gpt/"`) с подготовленными данными и прокси-сервером (если указан).
5. **Обработка ответа**: Функция обрабатывает ответ от API, проверяя статус код. Если статус код указывает на ошибку, вызывается исключение `response.raise_for_status()`.
6. **Генерация чанков текста**: Функция итерируется по содержимому ответа (`response.content.iter_any()`) и декодирует каждый чанк в текст, который затем выдается через `yield`.

**ASCII схема работы функции**:

```
Начало
  |
  Подготовка HTTP заголовков (headers)
  |
  Создание асинхронной сессии aiohttp (session)
  |
  Подготовка данных для POST запроса (data)
  |
  Отправка POST запроса к API (session.post)
  |
  Получение ответа от API (response)
  |
  Проверка статуса ответа (response.raise_for_status())
  |
  Итерация по содержимому ответа (chunk in response.content.iter_any())
  |
  Декодирование чанка текста (chunk.decode())
  |
  Выдача чанка текста через yield
  |
Конец (генератор завершается, когда нет больше чанков)
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio

async def main():
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    async for chunk in ChatAnywhere.create_async_generator(model="gpt-3.5-turbo", messages=messages):
        print(chunk, end="")

if __name__ == "__main__":
    asyncio.run(main())
```

В этом примере создается асинхронный генератор для модели `gpt-3.5-turbo` с одним сообщением. Затем, асинхронно итерируясь по генератору, выводятся чанки текста, полученные от API `chatanywhere.cn`.