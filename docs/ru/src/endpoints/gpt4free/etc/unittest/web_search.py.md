# Модуль unittest для веб-поиска

## Обзор

Этот модуль содержит набор юнит-тестов для проверки функциональности веб-поиска, интегрированного в проект `hypotez`. Он использует библиотеку `duckduckgo_search` для выполнения поисковых запросов и проверяет, что результаты поиска правильно обрабатываются и используются для генерации ответов.

## Подробнее

Модуль предназначен для автоматизированного тестирования интеграции веб-поиска с асинхронным клиентом `AsyncClient`. Он проверяет различные сценарии использования инструмента поиска, включая передачу параметров поиска в разных форматах и обработку исключений, которые могут возникнуть в процессе выполнения поисковых запросов.

## Классы

### `TestIterListProvider`

**Описание**: Класс, содержащий юнит-тесты для проверки функциональности веб-поиска.

**Наследует**: `unittest.IsolatedAsyncioTestCase`

**Методы**:

- `setUp()`: Подготавливает тестовое окружение, проверяя наличие необходимых зависимостей. Если зависимости отсутствуют, тест пропускается.
- `test_search()`: Проверяет основной сценарий использования инструмента поиска с различными параметрами, такими как `query`, `max_results`, `max_words`, `backend`, `add_text`, `timeout`, `region` и `instructions`.
- `test_search2()`: Проверяет сценарий использования инструмента поиска с минимальным набором параметров (только `query`).
- `test_search3()`: Проверяет сценарий использования инструмента поиска, когда параметры передаются в формате JSON.

## Функции

### `setUp`

```python
def setUp(self) -> None:
    """Подготавливает тестовое окружение.

    Args:
        self (TestIterListProvider): Экземпляр класса `TestIterListProvider`.

    Returns:
        None

    Raises:
        unittest.SkipTest: Если не установлены необходимые зависимости (`web search requirements not passed`).
    """
    ...
```

**Назначение**: Подготовка тестового окружения перед выполнением каждого теста.

**Как работает функция**:
1. Проверяет, установлены ли необходимые зависимости для выполнения тестов веб-поиска. Это делается путем проверки значения переменной `has_requirements`.
2. Если `has_requirements` равно `False`, это означает, что необходимые зависимости не установлены. В этом случае функция вызывает `self.skipTest()`, чтобы пропустить текущий тест и указать причину пропуска.

```
Проверка наличия зависимостей
│
├── Нет зависимостей
│   │
│   └── Пропуск теста
│
└── Зависимости установлены
```

**Примеры**:

```python
# Пример вызова setUp (вызывается автоматически перед каждым тестом)
test_case = TestIterListProvider()
test_case.setUp()  # Этот вызов выполнится автоматически перед каждым тестовым методом
```

### `test_search`

```python
async def test_search(self):
    """Проверяет основной сценарий использования инструмента поиска с различными параметрами.

    Args:
        self (TestIterListProvider): Экземпляр класса `TestIterListProvider`.

    Returns:
        None

    Raises:
        unittest.SkipTest: Если возникает исключение `DuckDuckGoSearchException`.
    """
    ...
```

**Назначение**: Проверка основного сценария использования инструмента поиска с различными параметрами.

**Как работает функция**:

1.  Создает экземпляр асинхронного клиента `AsyncClient` с использованием мок-провайдера `YieldProviderMock`.
2.  Определяет структуру `tool_calls`, которая содержит параметры для инструмента поиска. Параметры включают:
    *   `query`: поисковый запрос.
    *   `max_results`: максимальное количество результатов поиска.
    *   `max_words`: максимальное количество слов из результатов поиска для генерации ответа.
    *   `backend`: бэкенд для выполнения поиска (`html`, `lite` или `api`).
    *   `add_text`: флаг, указывающий, нужно ли выполнять скрапинг веб-сайтов.
    *   `timeout`: таймаут для скрапинга веб-сайтов.
    *   `region`: регион для поиска.
    *   `instructions`: инструкции для использования результатов поиска при генерации ответа.
3.  Вызывает метод `client.chat.completions.create()` с передачей параметров поиска в `tool_calls`.
4.  Проверяет, содержит ли ответ строку "Using the provided web search results".
5.  Обрабатывает исключение `DuckDuckGoSearchException`, которое может возникнуть при выполнении поискового запроса. Если исключение возникает, тест пропускается.

```
Создание клиента и параметров поиска
│
├── Вызов client.chat.completions.create()
│   │
│   └── Проверка наличия строки "Using the provided web search results" в ответе
│
└── Обработка исключения DuckDuckGoSearchException
```

**Примеры**:

```python
# Пример вызова test_search (вызывается автоматически при запуске тестов)
test_case = TestIterListProvider()
await test_case.test_search()  # Этот вызов выполнится автоматически при запуске тестов
```

### `test_search2`

```python
async def test_search2(self):
    """Проверяет сценарий использования инструмента поиска с минимальным набором параметров (только query).

    Args:
        self (TestIterListProvider): Экземпляр класса `TestIterListProvider`.

    Returns:
        None

    Raises:
        unittest.SkipTest: Если возникает исключение `DuckDuckGoSearchException`.
    """
    ...
```

**Назначение**: Проверка сценария использования инструмента поиска с минимальным набором параметров (только `query`).

**Как работает функция**:

1.  Создает экземпляр асинхронного клиента `AsyncClient` с использованием мок-провайдера `YieldProviderMock`.
2.  Определяет структуру `tool_calls`, которая содержит минимальный набор параметров для инструмента поиска (только `query`).
3.  Вызывает метод `client.chat.completions.create()` с передачей параметров поиска в `tool_calls`.
4.  Проверяет, содержит ли ответ строку "Using the provided web search results".
5.  Обрабатывает исключение `DuckDuckGoSearchException`, которое может возникнуть при выполнении поискового запроса. Если исключение возникает, тест пропускается.

```
Создание клиента и параметров поиска
│
├── Вызов client.chat.completions.create()
│   │
│   └── Проверка наличия строки "Using the provided web search results" в ответе
│
└── Обработка исключения DuckDuckGoSearchException
```

**Примеры**:

```python
# Пример вызова test_search2 (вызывается автоматически при запуске тестов)
test_case = TestIterListProvider()
await test_case.test_search2()  # Этот вызов выполнится автоматически при запуске тестов
```

### `test_search3`

```python
async def test_search3(self):
    """Проверяет сценарий использования инструмента поиска, когда параметры передаются в формате JSON.

    Args:
        self (TestIterListProvider): Экземпляр класса `TestIterListProvider`.

    Returns:
        None

    Raises:
        unittest.SkipTest: Если возникает исключение `DuckDuckGoSearchException`.
    """
    ...
```

**Назначение**: Проверка сценария использования инструмента поиска, когда параметры передаются в формате JSON.

**Как работает функция**:

1.  Создает экземпляр асинхронного клиента `AsyncClient` с использованием мок-провайдера `YieldProviderMock`.
2.  Определяет структуру `tool_calls`, которая содержит параметры для инструмента поиска, сериализованные в формат JSON. Параметры включают:
    *   `query`: поисковый запрос.
    *   `max_results`: максимальное количество результатов поиска.
    *   `max_words`: максимальное количество слов из результатов поиска для генерации ответа.
3.  Вызывает метод `client.chat.completions.create()` с передачей параметров поиска в `tool_calls`.
4.  Проверяет, содержит ли ответ строку "Using the provided web search results".
5.  Обрабатывает исключение `DuckDuckGoSearchException`, которое может возникнуть при выполнении поискового запроса. Если исключение возникает, тест пропускается.

```
Создание клиента и параметров поиска в формате JSON
│
├── Вызов client.chat.completions.create()
│   │
│   └── Проверка наличия строки "Using the provided web search results" в ответе
│
└── Обработка исключения DuckDuckGoSearchException
```

**Примеры**:

```python
# Пример вызова test_search3 (вызывается автоматически при запуске тестов)
test_case = TestIterListProvider()
await test_case.test_search3()  # Этот вызов выполнится автоматически при запуске тестов