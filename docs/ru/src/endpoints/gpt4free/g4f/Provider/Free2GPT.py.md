# Модуль для работы с Free2GPT провайдером
=========================================

Модуль содержит класс `Free2GPT`, который используется для взаимодействия с сервисом Free2GPT для генерации текста на основе предоставленных сообщений, а также функцию `generate_signature` для генерации подписи запроса.

## Обзор

Этот модуль предоставляет асинхронный интерфейс для взаимодействия с сервисом Free2GPT, позволяя генерировать текст на основе заданных сообщений. Он включает в себя класс `Free2GPT`, который реализует функциональность провайдера, и функцию `generate_signature`, которая генерирует подпись для запросов. Модуль поддерживает прокси и использует `aiohttp` для асинхронных HTTP-запросов.

## Подробней

Модуль предназначен для интеграции с другими частями проекта, где требуется генерация текста с использованием Free2GPT. Он обеспечивает абстракцию от низкоуровневых деталей HTTP-запросов и обработки ответов, предоставляя простой и удобный интерфейс для генерации текста.

## Классы

### `Free2GPT`

**Описание**: Класс `Free2GPT` представляет собой асинхронного провайдера для работы с сервисом Free2GPT. Он наследует от `AsyncGeneratorProvider` и `ProviderModelMixin`.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL сервиса Free2GPT (`"https://chat10.free2gpt.xyz"`).
- `working` (bool): Флаг, указывающий, работает ли провайдер (всегда `True`).
- `supports_message_history` (bool): Флаг, указывающий, поддерживает ли провайдер историю сообщений (всегда `True`).
- `default_model` (str): Модель, используемая по умолчанию (`"gemini-1.5-pro"`).
- `models` (List[str]): Список поддерживаемых моделей (`["gemini-1.5-pro", "gemini-1.5-flash"]`).

#### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    connector: BaseConnector = None,
    **kwargs,
) -> AsyncResult:
    """Создает асинхронный генератор для получения ответов от Free2GPT.

    Args:
        model (str): Модель для использования.
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        connector (BaseConnector, optional): Aiohttp коннектор для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий чанки текста.

    Raises:
        RateLimitError: Если достигнут лимит запросов.
        Exception: Если возникает ошибка при выполнении запроса.

    """
```

**Назначение**: Создает асинхронный генератор, который отправляет сообщения в Free2GPT и возвращает ответы в виде чанков текста.

**Параметры**:
- `model` (str): Модель, используемая для генерации текста.
- `messages` (Messages): Список сообщений, отправляемых в Free2GPT.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `connector` (BaseConnector, optional): Aiohttp коннектор для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий чанки сгенерированного текста.

**Вызывает исключения**:
- `RateLimitError`: Если получен ответ со статусом 500 и сообщением "Quota exceeded".
- `Exception`: Если при выполнении запроса возникла ошибка.

**Как работает функция**:

1. **Формирование заголовков**: Создаются HTTP-заголовки, включающие `User-Agent`, `Accept`, `Accept-Language`, `Accept-Encoding`, `Content-Type`, `Referer` и `Origin`.

2. **Создание сессии**: Создается асинхронная сессия `aiohttp` с использованием предоставленного коннектора и заголовков. Если коннектор не предоставлен, используется коннектор по умолчанию с поддержкой прокси.

3. **Формирование данных**: Создается словарь `data`, включающий список сообщений, текущее время в миллисекундах и подпись, сгенерированную на основе времени и содержимого последнего сообщения.

4. **Отправка запроса**: Отправляется POST-запрос к `f"{cls.url}/api/generate"` с данными в формате JSON.

5. **Обработка ответа**:
   - Если статус ответа равен 500 и в тексте ответа содержится "Quota exceeded", выбрасывается исключение `RateLimitError`.
   - Вызывается функция `raise_for_status` для проверки статуса ответа и выбрасывания исключения в случае ошибки.
   - Асинхронно итерируется по содержимому ответа, декодируя каждый чанк и возвращая его через генератор.

```mermaid
graph LR
    A[Формирование заголовков] --> B(Создание сессии aiohttp)
    B --> C{Формирование данных (messages, time, sign)}
    C --> D[Отправка POST-запроса к Free2GPT]
    D --> E{Обработка ответа}
    E -- Статус 500 и "Quota exceeded" --> F[Выброс RateLimitError]
    E -- Ошибка --> G[Выброс исключения]
    E -- Успех --> H[Асинхронная итерация по содержимому ответа]
    H --> I(Декодирование чанка и возврат через генератор)
```

**Примеры**:

```python
# Пример использования с указанием модели и сообщений
messages = [{"role": "user", "content": "Привет, как дела?"}]
async for chunk in Free2GPT.create_async_generator(model="gemini-1.5-pro", messages=messages):
    print(chunk, end="")

# Пример использования с прокси
messages = [{"role": "user", "content": "Привет, как дела?"}]
async for chunk in Free2GPT.create_async_generator(model="gemini-1.5-pro", messages=messages, proxy="http://proxy.example.com"):
    print(chunk, end="")
```

## Функции

### `generate_signature`

```python
def generate_signature(time: int, text: str, secret: str = ""):
    """Генерирует подпись для запроса на основе времени, текста и секрета.

    Args:
        time (int): Время в формате timestamp.
        text (str): Текст для подписи.
        secret (str, optional): Секретный ключ. По умолчанию "".

    Returns:
        str: SHA256 хеш сообщения.

    """
```

**Назначение**: Генерирует SHA256 хеш для подписи запроса, используя время, текст и секретный ключ.

**Параметры**:
- `time` (int): Время в формате timestamp.
- `text` (str): Текст для подписи.
- `secret` (str, optional): Секретный ключ. По умолчанию `""`.

**Возвращает**:
- `str`: SHA256 хеш сообщения.

**Как работает функция**:

1. **Формирование сообщения**: Создается строка сообщения путем конкатенации времени, текста и секрета через двоеточие.
2. **Кодирование сообщения**: Сообщение кодируется в байты с использованием кодировки UTF-8.
3. **Вычисление хеша**: Вычисляется SHA256 хеш закодированного сообщения.
4. **Возврат хеша**: Хеш возвращается в виде шестнадцатеричной строки.

```mermaid
graph LR
    A[Формирование сообщения (time:text:secret)] --> B(Кодирование сообщения в байты)
    B --> C[Вычисление SHA256 хеша]
    C --> D(Возврат хеша в виде шестнадцатеричной строки)
```

**Примеры**:

```python
# Пример генерации подписи
time = int(time.time() * 1e3)
text = "Привет, как дела?"
signature = generate_signature(time, text)
print(signature)

# Пример генерации подписи с секретным ключом
time = int(time.time() * 1e3)
text = "Привет, как дела?"
secret = "mysecretkey"
signature = generate_signature(time, text, secret)
print(signature)