# `main.py`

## –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å —è–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –¥–ª—è Telegram-–±–æ—Ç–∞, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–µ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ —Ä—ã–Ω–∫–∞. –û–Ω –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç Telegram, –∞ —Ç–∞–∫–∂–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ –º–∏–¥–ª–≤–∞—Ä–∏. –ú–æ–¥—É–ª—å –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –º–∏–¥–ª–≤–∞—Ä–µ–π, –º–∞—Ä—à—Ä—É—Ç–æ–≤, –∞ —Ç–∞–∫–∂–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞.

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–§—É–Ω–∫—Ü–∏–∏](#–§—É–Ω–∫—Ü–∏–∏)
   - [`set_default_commands`](#set_default_commands)
   - [`on_startup`](#on_startup)
   - [`on_shutdown`](#on_shutdown)
   - [`register_middlewares`](#register_middlewares)
   - [`register_routers`](#register_routers)
   - [`create_app`](#create_app)
   - [`main`](#main)
2. [–ò–º–ø–æ—Ä—Ç—ã](#–ò–º–ø–æ—Ä—Ç—ã)

## –ò–º–ø–æ—Ä—Ç—ã

- `aiogram.webhook.aiohttp_server`:  –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ webhook –Ω–∞ aiohttp —Å–µ—Ä–≤–µ—Ä–µ.
- `aiohttp.web`: –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.
- `aiogram.types`: –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∏–ø–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö aiogram, —Ç–∞–∫–∏–º–∏ –∫–∞–∫ `BotCommand` –∏ `BotCommandScopeDefault`.
- `loguru.logger`: –î–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π –∏ –æ—à–∏–±–æ–∫.
- `bot.app.app`: –î–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Ñ—É–Ω–∫—Ü–∏–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook, robokassa –∏ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
- `bot.config`: –î–ª—è –∏–º–ø–æ—Ä—Ç–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–æ—Ç–∞, –≤–∫–ª—é—á–∞—è —Ç–æ–∫–µ–Ω, —Å–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–æ–≤ –∏ —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞.
- `bot.dao.database_middleware`: –î–ª—è –∏–º–ø–æ—Ä—Ç–∞ middleware, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
- `bot.admin.admin`: –î–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Ä–æ—É—Ç–µ—Ä–∞ –∞–¥–º–∏–Ω—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥.
- `bot.user.user_router`: –î–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Ä–æ—É—Ç–µ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –∫–æ–º–∞–Ω–¥.
- `bot.user.catalog_router`: –î–ª—è –∏–º–ø–æ—Ä—Ç–∞ —Ä–æ—É—Ç–µ—Ä–∞ –∫–æ–º–∞–Ω–¥ –∫–∞—Ç–∞–ª–æ–≥–∞.

## –§—É–Ω–∫—Ü–∏–∏

### `set_default_commands`

**–û–ø–∏—Å–∞–Ω–∏–µ**:
–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –±–æ—Ç–∞, —Ç–∞–∫–∏–µ –∫–∞–∫ `/start`.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- –ù–µ—Ç.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `None`

**–í—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è**:
- –ù–µ—Ç.

```python
async def set_default_commands():
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –±–æ—Ç–∞.
    """
    commands = [BotCommand(command='start', description='–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞')]
    await bot.set_my_commands(commands, BotCommandScopeDefault())
```

### `on_startup`

**–û–ø–∏—Å–∞–Ω–∏–µ**:
–í—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Ç–∞–∫–∏–µ –∫–∞–∫ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ webhook, –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –æ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `app` (`aiohttp.web.Application`): –≠–∫–∑–µ–º–ø–ª—è—Ä aiohttp –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `None`

**–í—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è**:
- `Exception`: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.

```python
async def on_startup(app):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    """
    await set_default_commands()
    await bot.set_webhook(settings.get_webhook_url)
    for admin_id in admins:
        try:
            await bot.send_message(admin_id, '–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω ü•≥.')
        except Exception as ex:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É {admin_id}: {ex}")
    logger.info("–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω.")
```

### `on_shutdown`

**–û–ø–∏—Å–∞–Ω–∏–µ**:
–í—ã–ø–æ–ª–Ω—è–µ—Ç –¥–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Ç–∞–∫–∏–µ –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞, —É–¥–∞–ª–µ–Ω–∏–µ webhook –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–µ—Å—Å–∏–∏ –±–æ—Ç–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- `app` (`aiohttp.web.Application`): –≠–∫–∑–µ–º–ø–ª—è—Ä aiohttp –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `None`

**–í—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è**:
- `Exception`: –ï—Å–ª–∏ –Ω–µ —É–¥–∞–µ—Ç—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.

```python
async def on_shutdown(app):
    """
    –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    """
    for admin_id in admins:
        try:
            await bot.send_message(admin_id, '–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü–æ—á–µ–º—É? üòî')
        except Exception as ex:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω—É {admin_id}: {ex}")
    await bot.delete_webhook(drop_pending_updates=True)
    await bot.session.close()
    logger.error("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!")
```

### `register_middlewares`

**–û–ø–∏—Å–∞–Ω–∏–µ**:
–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–∏–¥–ª–≤–∞—Ä–∏ –¥–ª—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞, –≤–∫–ª—é—á–∞—è –º–∏–¥–ª–≤–∞—Ä–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- –ù–µ—Ç.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `None`

**–í—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è**:
- –ù–µ—Ç.

```python
def register_middlewares():
    """
    –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–∏–¥–ª–≤–∞—Ä–∏ –¥–ª—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞.
    """
    dp.update.middleware.register(DatabaseMiddlewareWithoutCommit())
    dp.update.middleware.register(DatabaseMiddlewareWithCommit())
```

### `register_routers`

**–û–ø–∏—Å–∞–Ω–∏–µ**:
–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–æ—É—Ç–µ—Ä—ã –¥–ª—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞, –≤–∫–ª—é—á–∞—è —Ä–æ—É—Ç–µ—Ä—ã –¥–ª—è –∫–∞—Ç–∞–ª–æ–≥–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- –ù–µ—Ç.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `None`

**–í—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è**:
- –ù–µ—Ç.

```python
def register_routers():
    """
    –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –¥–∏—Å–ø–µ—Ç—á–µ—Ä–∞.
    """
    dp.include_router(catalog_router)
    dp.include_router(user_router)
    dp.include_router(admin_router)
```

### `create_app`

**–û–ø–∏—Å–∞–Ω–∏–µ**:
–°–æ–∑–¥–∞–µ—Ç –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç aiohttp –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–∞—Ä—à—Ä—É—Ç–æ–≤, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–º –∏ –±–æ—Ç–æ–º, –∞ —Ç–∞–∫–∂–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–ø—É—Å–∫–∞ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- –ù–µ—Ç.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `aiohttp.web.Application`: –≠–∫–∑–µ–º–ø–ª—è—Ä aiohttp –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

**–í—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è**:
- –ù–µ—Ç.

```python
def create_app():
    """
    –°–æ–∑–¥–∞–µ—Ç –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ aiohttp.
    """
    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    app = web.Application()

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –º–∞—Ä—à—Ä—É—Ç–æ–≤
    app.router.add_post(f"/{settings.BOT_TOKEN}", handle_webhook)
    app.router.add_post("/robokassa/result/", robokassa_result)
    app.router.add_get("/robokassa/fail/", robokassa_fail)
    app.router.add_get("/", home_page)

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –¥–∏—Å–ø–µ—Ç—á–µ—Ä–æ–º –∏ –±–æ—Ç–æ–º
    setup_application(app, dp, bot=bot)

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π –∑–∞–ø—É—Å–∫–∞ –∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    app.on_startup.append(on_startup)
    app.on_shutdown.append(on_shutdown)

    return app
```

### `main`

**–û–ø–∏—Å–∞–Ω–∏–µ**:
–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –û–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –º–∏–¥–ª–≤–∞—Ä–∏ –∏ —Ä–æ—É—Ç–µ—Ä—ã, —Å–æ–∑–¥–∞–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –µ–≥–æ.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã**:
- –ù–µ—Ç.

**–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç**:
- `None`

**–í—ã–∑—ã–≤–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏—è**:
- –ù–µ—Ç.

```python
def main():
    """
    –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    """
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –º–∏–¥–ª–≤–∞—Ä–µ–π –∏ —Ä–æ—É—Ç–µ—Ä–æ–≤
    register_middlewares()
    register_routers()

    # –°–æ–∑–¥–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –µ–≥–æ
    app = create_app()
    web.run_app(app, host=settings.SITE_HOST, port=settings.SITE_PORT)
```