# Модуль для создания AI агента, использующего браузер для поиска и анализа информации.
## Обзор

Модуль `browser_agent` предоставляет класс `AIBrowserAgent`, который позволяет быстро настроить и запустить ИИ-агента, способного искать информацию в Google и анализировать веб-страницы. Он использует библиотеки `langchain_openai` и `browser_use` для взаимодействия с языковой моделью OpenAI и управления браузером. Модуль предназначен для автоматизации задач, требующих поиска и анализа информации в интернете.

## Подробней

Этот модуль предназначен для упрощения процесса создания ИИ-агентов, которые могут взаимодействовать с веб-страницами. Он предоставляет удобный интерфейс для выполнения задач, таких как поиск аналогов продуктов и ответы на вопросы с использованием информации из интернета.

## Классы

### `AIBrowserAgent`

**Описание**: Класс для создания агента, использующего браузер для выполнения задач.

**Принцип работы**:
Класс `AIBrowserAgent` инициализируется с ключом API OpenAI, названием модели, поисковой системой и опциональным драйвером браузера. Он предоставляет методы для запуска задач, поиска аналогов продуктов и ответа на вопросы с использованием информации из интернета.

**Аттрибуты**:
- `api_key` (str): Ключ API OpenAI.
- `model_name` (str): Название языковой модели OpenAI для использования (по умолчанию "gpt-4o-mini").
- `search_engine` (str): Поисковая система для использования (по умолчанию "google").
- `llm` (ChatOpenAI): Инстанс языковой модели OpenAI.
- `custom_driver` (Optional[object]): Опциональный инстанс WebDriver.

**Методы**: 
- `__init__`: Инициализирует класс BrowserAgent.
- `run_task`: Запускает агента для выполнения заданной задачи.
- `find_product_alternatives`: Ищет в сети аналоги для продукта по заданному URL или SKU.
- `ask`: Синхронная обертка для асинхронного метода ask_async. Не рекомендуется к использованию.
- `ask_async`: Отвечает на заданный вопрос, используя поиск в интернете, если это необходимо.

### `__init__`

**Описание**: Инициализирует класс `AIBrowserAgent`.

```python
def __init__(self, api_key: str, model_name: str = "gpt-4o-mini", search_engine: str = "google", custom_driver: Optional[object] = None) -> None:
    """
    Инициализирует класс BrowserAgent.

    Args:
        api_key: Ключ API OpenAI (необязательный). Если не указан, будет использован ключ из переменных окружения.
        model_name: Название языковой модели OpenAI для использования (по умолчанию "gpt-4o-mini").
        search_engine: Поисковая система для использования (по умолчанию "google").
        custom_driver: Optionally injected WebDriver instance, defaults to None (browser_use default).
    """
    ...
```

**Параметры**:
- `api_key` (str): Ключ API OpenAI.
- `model_name` (str): Название языковой модели OpenAI для использования (по умолчанию "gpt-4o-mini").
- `search_engine` (str): Поисковая система для использования (по умолчанию "google").
- `custom_driver` (Optional[object]): Опциональный инстанс WebDriver.

**Как работает функция**:
1. Функция инициализирует атрибуты класса `AIBrowserAgent` с переданными параметрами: `api_key`, `model_name`, `search_engine` и `custom_driver`.
2. Создается инстанс языковой модели OpenAI (`ChatOpenAI`) с использованием `model_name` и `api_key`.
3. Сохранён `custom_driver` в локальную переменную.

```
Инициализация атрибутов класса
│
├── Создание инстанса языковой модели ChatOpenAI
│
└── Сохранение custom_driver
```

### `run_task`

**Описание**: Запускает агента для выполнения заданной задачи.

```python
async def run_task(self, task_prompt: str) -> Optional[str]:
    """
    Запускает агента для выполнения заданной задачи.

    Args:
        task_prompt: Текст задачи для агента.

    Returns:
        Результат выполнения задачи в виде строки, или None в случае ошибки.
    """
    ...
```

**Параметры**:
- `task_prompt` (str): Текст задачи для агента.

**Возвращает**:
- `Optional[str]`: Результат выполнения задачи в виде строки, или `None` в случае ошибки.

**Вызывает исключения**:
- `Exception`: В случае возникновения ошибки во время выполнения задачи.

**Как работает функция**:
1. Функция принимает текст задачи (`task_prompt`) в качестве входных данных.
2. Логирует начало выполнения задачи с использованием `logger.info`.
3. Инициализирует драйвер браузера. Если передан `custom_driver`, он используется; иначе `browser_use` создает свой драйвер.
4. Создает инстанс агента (`Agent`) с переданной задачей, языковой моделью (`self.llm`) и драйвером браузера.
5. Запускает агента для выполнения задачи с использованием `await agent.run()`.
6. Логирует завершение выполнения задачи с использованием `logger.info`.
7. Пытается закрыть драйвер, если он имеет метод `close`.
8. Возвращает результат выполнения задачи.
9. В случае возникновения исключения, логирует ошибку с использованием `logger.error` и возвращает `None`.

```
Принятие текста задачи
│
├── Логирование начала выполнения задачи
│
├── Инициализация драйвера браузера
│   ├── Использование custom_driver, если передан
│   └── Иначе создание драйвера browser_use
│
├── Создание инстанса агента
│
├── Запуск агента для выполнения задачи
│
├── Логирование завершения выполнения задачи
│
├── Попытка закрытия драйвера
│
└── Возврат результата выполнения задачи или None в случае ошибки
```

### `find_product_alternatives`

**Описание**: Ищет в сети аналоги для продукта по заданному URL или SKU.

```python
async def find_product_alternatives(self, product_url: Optional[str] = None, sku: Optional[str] = None) -> Optional[str]:
    """
    Ищет в сети аналоги для продукта по заданному URL или SKU.

    Args:
        product_url: URL продукта, для которого нужно найти аналоги (опционально).
        sku: SKU продукта, для которого нужно найти аналоги (опционально).

    Returns:
        Строку с описанием найденных аналогов, или None в случае ошибки.
    """
    ...
```

**Параметры**:
- `product_url` (Optional[str]): URL продукта, для которого нужно найти аналоги (опционально).
- `sku` (Optional[str]): SKU продукта, для которого нужно найти аналоги (опционально).

**Возвращает**:
- `Optional[str]`: Строку с описанием найденных аналогов, или `None` в случае ошибки.

**Как работает функция**:
1. Функция принимает URL продукта (`product_url`) или SKU (`sku`) в качестве входных данных.
2. Формирует поисковый запрос в зависимости от наличия `product_url` или `sku`.
3. Если не указан ни `product_url`, ни `sku`, логирует предупреждение с использованием `logger.warning` и возвращает `None`.
4. URL-кодирует поисковый запрос с использованием `urllib.parse.quote_plus`.
5. Формирует URL поисковой системы (Google или DuckDuckGo) с закодированным запросом.
6. Формирует текст задачи (`task_prompt`) для агента, включающий использование поисковой системы и переход по сформированному URL.
7. Запускает агента для выполнения задачи с использованием `await self.run_task(task_prompt)`.
8. Возвращает результат выполнения задачи.

```
Принятие URL продукта или SKU
│
├── Формирование поискового запроса
│
├── Проверка наличия product_url или sku
│   └── Если отсутствуют, логирование предупреждения и возврат None
│
├── URL-кодирование поискового запроса
│
├── Формирование URL поисковой системы
│
├── Формирование текста задачи для агента
│
└── Запуск агента для выполнения задачи и возврат результата
```

### `ask`

**Описание**: Синхронная обертка для асинхронного метода `ask_async`. Не рекомендуется к использованию.

```python
def ask(self, q: str) -> Optional[str]:
    """
    Синхронная обертка для асинхронного метода ask_async.  Не рекомендуется к использованию.
    """
    ...
```

**Параметры**:
- `q` (str): Вопрос, на который нужно ответить.

**Возвращает**:
- `Optional[str]`: Ответ на вопрос в виде строки, или `None` в случае ошибки.

**Как работает функция**:
1. Функция принимает вопрос (`q`) в качестве входных данных.
2. Формирует текст задачи (`task_prompt`) для агента, включающий вопрос и указание использовать поиск в интернете при необходимости.
3. Запускает агента для выполнения задачи с использованием `self.run_task(task_prompt)`.
4. Возвращает результат выполнения задачи.

```
Принятие вопроса
│
├── Формирование текста задачи для агента
│
└── Запуск агента для выполнения задачи и возврат результата
```

### `ask_async`

**Описание**: Отвечает на заданный вопрос, используя поиск в интернете, если это необходимо.

```python
async def ask_async(self, q: str) -> Optional[str]:
    """
    Отвечает на заданный вопрос, используя поиск в интернете, если это необходимо.

    Args:
        question: Вопрос, на который нужно ответить.

    Returns:
        Ответ на вопрос в виде строки, или None в случае ошибки.
    """
    ...
```

**Параметры**:
- `q` (str): Вопрос, на который нужно ответить.

**Возвращает**:
- `Optional[str]`: Ответ на вопрос в виде строки, или `None` в случае ошибки.

**Как работает функция**:
1. Функция принимает вопрос (`q`) в качестве входных данных.
2. Формирует текст задачи (`task_prompt`) для агента, включающий вопрос и указание использовать поиск в интернете при необходимости.
3. Запускает агента для выполнения задачи с использованием `await self.run_task(task_prompt)`.
4. Возвращает результат выполнения задачи.

```
Принятие вопроса
│
├── Формирование текста задачи для агента
│
└── Запуск агента для выполнения задачи и возврат результата
```

## Функции

### `main`

**Описание**: Пример использования класса `BrowserAgent`.

```python
async def main():
    """
    Пример использования класса BrowserAgent.
    """
    ...
```

**Как работает функция**:
1. Функция является асинхронной и предназначена для демонстрации использования класса `AIBrowserAgent`.
2. Получает API-ключ OpenAI.
3. Создает инстанс класса `AIBrowserAgent` с API-ключом и названием модели.
4. Запускает пример поиска аналогов продукта по SKU и URL.
5. Выводит найденные аналоги или сообщение об ошибке.
6. Запускает пример ответа на вопрос с использованием `ask_async`.
7. Выводит ответ на вопрос или сообщение об ошибке.

```
Получение API-ключа OpenAI
│
├── Создание инстанса класса AIBrowserAgent
│
├── Запуск примера поиска аналогов продукта
│   ├── Вывод найденных аналогов или сообщения об ошибке
│
└── Запуск примера ответа на вопрос
    └── Вывод ответа на вопрос или сообщения об ошибке
```

**Примеры**:

```python
import asyncio
async def main():
    api_key: str = None 
    model_name: str = 'gpt-4o-mini'
    agent = AIBrowserAgent(api_key=api_key, model_name=model_name)
    sku: str = '1493001'
    product_url: str = None  
    alternatives = await agent.find_product_alternatives(product_url=product_url, sku=sku)
    if alternatives:
        print("Найденные аналоги:")
        print(alternatives)
    else:
        print("Не удалось найти аналоги.")

    question = "Какая сейчас погода в Москве?"
    answer = await agent.ask_async(question)  # Используем асинхронный метод напрямую
    if answer:
        print("Ответ на вопрос:")
        print(answer)
    else:
        print("Не удалось получить ответ на вопрос.")
asyncio.run(main())