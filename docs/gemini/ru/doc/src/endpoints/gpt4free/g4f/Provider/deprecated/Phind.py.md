# Модуль для работы с Phind API (Deprecated)
## Обзор

Модуль предоставляет асинхронный интерфейс для взаимодействия с API Phind. Phind - это поисковая система для разработчиков, которая использует большие языковые модели для предоставления ответов на технические вопросы. Модуль позволяет отправлять запросы к Phind API и получать ответы в асинхронном режиме.

## Подробнее

Модуль содержит класс `Phind`, который наследуется от `AsyncGeneratorProvider` и реализует логику для отправки запросов к API Phind и обработки ответов.

Этот модуль помечен как `deprecated`, что означает, что он устарел и больше не рекомендуется к использованию. Возможно, в будущем он будет удален из проекта.

## Классы

### `Phind`
Описание:
Класс `Phind` предоставляет асинхронный интерфейс для взаимодействия с API Phind.

**Наследует**:
- `AsyncGeneratorProvider`: Базовый класс для асинхронных провайдеров, использующих генераторы.

**Атрибуты**:
- `url` (str): URL адрес веб-сайта Phind.
- `working` (bool): Указывает, работает ли провайдер в данный момент.
- `lockdown` (bool): Указывает, находится ли провайдер в режиме блокировки.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений.

**Методы**:
- `create_async_generator()`: Асинхронный генератор для создания запросов и обработки ответов от API Phind.

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        timeout: int = 120,
        creative_mode: bool = False,
        **kwargs
    ) -> AsyncResult:
        """Асинхронный генератор для создания запросов и обработки ответов от API Phind.

        Args:
            model (str): Модель, используемая для генерации ответа.
            messages (Messages): Список сообщений для отправки в API.
            proxy (str, optional): Прокси-сервер для использования при подключении к API. По умолчанию `None`.
            timeout (int, optional): Максимальное время ожидания ответа от API. По умолчанию `120`.
            creative_mode (bool, optional): Включает или выключает креативный режим. По умолчанию `False`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий части ответа от API.

        Raises:
            RuntimeError: Если API возвращает ошибку.
        """
```

**Назначение**:
Метод `create_async_generator` является асинхронным генератором, который отправляет запросы к API Phind и возвращает ответы в виде потока данных. Он использует `StreamSession` для асинхронной отправки запросов и обработки ответов.

**Параметры**:
- `cls`: Ссылка на класс `Phind`.
- `model` (str): Имя модели, используемой для генерации ответа. Если `model` начинается с "gpt-4", используется модель "GPT-4", иначе используется "Phind-34B".
- `messages` (Messages): Список сообщений, представляющих историю разговора.
- `proxy` (str, optional): URL прокси-сервера для использования при подключении к API. По умолчанию `None`.
- `timeout` (int, optional): Максимальное время ожидания ответа от API в секундах. По умолчанию `120`.
- `creative_mode` (bool, optional): Флаг, указывающий, следует ли использовать креативный режим. По умолчанию `False`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который выдает части ответа от API.

**Вызывает исключения**:
- `RuntimeError`: Если API возвращает ошибку, сообщение об ошибке включается в исключение.

**Как работает функция**:

1. **Формирование заголовков**:
   - Создаются заголовки HTTP-запроса, которые включают информацию о типе принимаемого контента (`Accept`), источнике запроса (`Origin`), URL-адресе страницы (`Referer`) и параметрах безопасности (`Sec-Fetch-*`).

2. **Создание асинхронной сессии**:
   - Используется `StreamSession` для создания асинхронной сессии, которая позволяет отправлять запросы и получать ответы в асинхронном режиме.
   - Устанавливаются заголовки, параметры имитации браузера (`impersonate="chrome"`) и прокси-сервер (если указан).

3. **Получение challenge_seeds**:
   - Отправляется GET-запрос на URL `https://www.phind.com/search?home=true`.
   - Извлекается содержимое страницы и с помощью регулярного выражения `re.search` находится JSON-объект, содержащий данные, необходимые для генерации challenge.
   - Из JSON-объекта извлекаются значения `challenge_seeds`.

4. **Формирование данных запроса**:
   - Извлекается последний вопрос пользователя из списка сообщений.
   - Формируется словарь `data`, содержащий вопрос, историю вопросов и ответов, параметры запроса (язык, дата, модель и т.д.) и контекст (системные сообщения).

5. **Генерация challenge**:
   - Вызывается функция `generate_challenge` для генерации challenge на основе данных запроса и значений `challenge_seeds`.

6. **Отправка POST-запроса**:
   - Отправляется POST-запрос на URL `https://https.api.phind.com/infer/` с заголовками и данными, сформированными ранее.

7. **Обработка ответа**:
   - Читаются строки из ответа сервера в асинхронном режиме.
   - Каждая строка проверяется на наличие префикса `b"data: "`.
   - Если строка содержит данные, они извлекаются и обрабатываются.
   - Если строка содержит `<PHIND_DONE/>`, генерация завершается.
   - Если строка содержит `<PHIND_BACKEND_ERROR>`, выбрасывается исключение `RuntimeError`.
   - Строки, начинающиеся с `<PHIND_WEBRESULTS>`, `<PHIND_FOLLOWUP>`, `<PHIND_METADATA>`, `<PHIND_INDICATOR>`, `<PHIND_SPAN_BEGIN>` или `<PHIND_SPAN_END>`, игнорируются.
   - Остальные строки декодируются и возвращаются генератором.

```
A: Формирование заголовков и создание асинхронной сессии
│
B: Получение challenge_seeds
│
C: Формирование данных запроса
│
D: Генерация challenge
│
E: Отправка POST-запроса
│
F: Обработка ответа (чтение строк, проверка на наличие префиксов, извлечение данных, обработка ошибок, возврат данных)
```

**Примеры**:

```python
# Пример использования create_async_generator
messages = [
    {"role": "user", "content": "What is the capital of France?"},
    {"role": "assistant", "content": "Paris is the capital of France."},
    {"role": "user", "content": "What is the capital of Germany?"}
]

async def main():
    async for chunk in Phind.create_async_generator(model="Phind-34B", messages=messages):
        print(chunk, end="")

# Запуск примера (в асинхронном контексте)
# asyncio.run(main())
```

### `deterministic_stringify`
```python
def deterministic_stringify(obj):
    """Преобразует объект Python в строку JSON с детерминированным порядком ключей.

    Args:
        obj (dict | list | bool | int | float | str | None): Объект для преобразования.

    Returns:
        str: JSON строка с детерминированным порядком ключей.
    """
```
**Назначение**:

Функция `deterministic_stringify` преобразует объект Python (словарь, список, булево значение, число, строка или None) в строку JSON с гарантированным порядком ключей. Это необходимо для обеспечения консистентности при генерации challenge, так как порядок ключей в JSON может влиять на результат хеширования.

**Параметры**:
- `obj` (dict | list | bool | int | float | str | None): Объект, который необходимо преобразовать в JSON строку.

**Возвращает**:
- `str`: JSON строка с детерминированным порядком ключей.

**Как работает функция**:

1. **Внутренняя функция `handle_value`**:
   - Определяет тип входного значения и обрабатывает его соответствующим образом.
   - Если значение является словарем или списком, рекурсивно вызывает `deterministic_stringify` или сортирует элементы списка и вызывает `handle_value` для каждого элемента.
   - Если значение является булевым, преобразует его в строку 'true' или 'false'.
   - Если значение является числом (int или float), форматирует его с точностью до 8 знаков после запятой, удаляет завершающие нули и точку, если она остается последним символом.
   - Если значение является строкой, заключает ее в двойные кавычки.
   - Если значение является None, возвращает строку 'null'.

2. **Сортировка элементов словаря**:
   - Если входной объект является словарем, элементы словаря сортируются по ключам с использованием `sorted(obj.items(), key=lambda x: x[0])`.

3. **Преобразование в JSON строку**:
   - Отсортированные элементы словаря преобразуются в строку вида 'ключ:значение' с помощью генератора списка `[f'{k}:{handle_value(v)}' for k, v in items if handle_value(v) is not None]`.
   - Элементы списка соединяются в строку с помощью `,`.

```
A: Получение элемента для обработки
│
B: Проверка типа элемента
│
C: Обработка значения (словарь/список, bool, int/float, str, None)
│
D: Преобразование в строку JSON
```

**Примеры**:

```python
# Пример использования deterministic_stringify
data = {"b": 2, "a": 1}
json_string = deterministic_stringify(data)
print(json_string)  # Output: a:1.00000000,b:2.00000000
```
### `prng_general`
```python
def prng_general(seed, multiplier, addend, modulus):
    """Генератор псевдослучайных чисел общего назначения.

    Args:
        seed (int): Начальное значение (зерно) для генератора.
        multiplier (int): Множитель.
        addend (int): Добавляемое значение.
        modulus (int): Модуль.

    Returns:
        float: Псевдослучайное число в диапазоне [0, 1).
    """
```

**Назначение**:

Функция `prng_general` реализует генератор псевдослучайных чисел (PRNG) общего назначения. Он принимает начальное значение (зерно), множитель, добавляемое значение и модуль в качестве входных данных и возвращает псевдослучайное число в диапазоне [0, 1).

**Параметры**:
- `seed` (int): Начальное значение (зерно) для генератора.
- `multiplier` (int): Множитель.
- `addend` (int): Добавляемое значение.
- `modulus` (int): Модуль.

**Возвращает**:
- `float`: Псевдослучайное число в диапазоне [0, 1).

**Как работает функция**:

1. **Вычисление нового значения**:
   - Вычисляется новое значение `a` по формуле `a = seed * multiplier + addend`.

2. **Обработка отрицательных значений**:
   - Если `a` отрицательно, выполняется операция `((a%modulus)-modulus)/modulus` для приведения значения к диапазону [0, 1).

3. **Вычисление псевдослучайного числа**:
   - Если `a` неотрицательно, вычисляется псевдослучайное число по формуле `a%modulus/modulus`.

```
A: Вычисление нового значения (seed * multiplier + addend)
│
B: Проверка значения на отрицательность
│
C: Вычисление псевдослучайного числа (a % modulus / modulus)
```

**Примеры**:

```python
# Пример использования prng_general
random_number = prng_general(seed=123, multiplier=1664525, addend=1013904223, modulus=2**32)
print(random_number)
```

### `generate_challenge_seed`
```python
def generate_challenge_seed(l):
    """Генерирует seed для challenge на основе входных данных.

    Args:
        l (dict | list | bool | int | float | str | None): Входные данные для генерации seed.

    Returns:
        int: Seed для challenge.
    """
```

**Назначение**:

Функция `generate_challenge_seed` генерирует seed для challenge на основе входных данных. Она использует функцию `deterministic_stringify` для преобразования входных данных в JSON строку с детерминированным порядком ключей, а затем кодирует эту строку с помощью URL-кодирования и хеширует ее с помощью функции `simple_hash`.

**Параметры**:
- `l` (dict | list | bool | int | float | str | None): Входные данные для генерации seed.

**Возвращает**:
- `int`: Seed для challenge.

**Как работает функция**:

1. **Преобразование в JSON строку**:
   - Вызывается функция `deterministic_stringify` для преобразования входных данных `l` в JSON строку с детерминированным порядком ключей.

2. **URL-кодирование**:
   - JSON строка кодируется с помощью URL-кодирования с помощью функции `parse.quote`.

3. **Хеширование**:
   - URL-кодированная строка хешируется с помощью функции `simple_hash`.

```
A: Преобразование в JSON строку (deterministic_stringify)
│
B: URL-кодирование
│
C: Хеширование (simple_hash)
```

**Примеры**:

```python
# Пример использования generate_challenge_seed
data = {"b": 2, "a": 1}
challenge_seed = generate_challenge_seed(data)
print(challenge_seed)
```

### `simple_hash`
```python
def simple_hash(s):
    """Простая хеш-функция для строк.

    Args:
        s (str): Входная строка для хеширования.

    Returns:
        int: Хеш-значение строки.
    """
```

**Назначение**:

Функция `simple_hash` реализует простую хеш-функцию для строк. Она принимает строку в качестве входных данных и возвращает хеш-значение этой строки.

**Параметры**:
- `s` (str): Входная строка для хеширования.

**Возвращает**:
- `int`: Хеш-значение строки.

**Как работает функция**:

1. **Инициализация хеш-значения**:
   - Инициализируется хеш-значение `d` нулем.

2. **Итерация по символам строки**:
   - Выполняется итерация по символам строки `s`.

3. **Проверка символа**:
   - Если длина символа больше 1 или код символа больше или равен 256, символ игнорируется.

4. **Вычисление хеш-значения**:
   - Вычисляется новое хеш-значение `d` по формуле `d = ((d << 5) - d + ord(char[0])) & 0xFFFFFFFF`.

5. **Обработка переполнения**:
   - Если `d` больше 0x7FFFFFFF (2147483647), из `d` вычитается 0x100000000 (2**32).

```
A: Инициализация хеш-значения
│
B: Итерация по символам строки
│
C: Проверка символа (длина и код)
│
D: Вычисление хеш-значения
│
E: Обработка переполнения
```

**Примеры**:

```python
# Пример использования simple_hash
hash_value = simple_hash("test")
print(hash_value)
```

### `generate_challenge`
```python
def generate_challenge(obj, **kwargs):
    """Генерирует challenge на основе входных данных и параметров.

    Args:
        obj (dict | list | bool | int | float | str | None): Входные данные для генерации challenge.
        **kwargs: Параметры для генератора псевдослучайных чисел.

    Returns:
        float: Challenge.
    """
```

**Назначение**:

Функция `generate_challenge` генерирует challenge на основе входных данных и параметров. Она использует функцию `generate_challenge_seed` для генерации seed на основе входных данных, а затем вызывает функцию `prng_general` для генерации challenge на основе seed и параметров.

**Параметры**:
- `obj` (dict | list | bool | int | float | str | None): Входные данные для генерации challenge.
- `**kwargs`: Параметры для генератора псевдослучайных чисел (multiplier, addend, modulus).

**Возвращает**:
- `float`: Challenge.

**Как работает функция**:

1. **Генерация seed**:
   - Вызывается функция `generate_challenge_seed` для генерации seed на основе входных данных `obj`.

2. **Генерация challenge**:
   - Вызывается функция `prng_general` для генерации challenge на основе seed и параметров `kwargs`.

```
A: Генерация seed (generate_challenge_seed)
│
B: Генерация challenge (prng_general)
```

**Примеры**:

```python
# Пример использования generate_challenge
data = {"b": 2, "a": 1}
challenge = generate_challenge(data, multiplier=1664525, addend=1013904223, modulus=2**32)
print(challenge)
```