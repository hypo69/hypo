# Документация для `fast_api_rpc.py` и `main.py`

## Обзор

Этот документ описывает взаимодействие между `fast_api_rpc.py` (серверная часть) и `main.py` (клиентская часть) в проекте `hypotez`. `fast_api_rpc.py` предоставляет API для управления сервером FastAPI через XML-RPC, а `main.py` предоставляет пользовательский интерфейс для взаимодействия с этим API.

## Подробней

`fast_api_rpc.py` содержит классы `FastApiServer` и `CommandHandler`. `FastApiServer` отвечает за запуск и настройку FastAPI-сервера, а `CommandHandler` управляет вызовами функций управления сервером через XML-RPC.

`main.py` использует `xmlrpc.client.ServerProxy` для создания клиента XML-RPC, который подключается к серверу `fast_api_rpc.py`. Он предоставляет меню команд для пользователя и вызывает соответствующие методы на сервере через RPC.

Взаимодействие происходит следующим образом: клиент отправляет команду на сервер через XML-RPC, сервер выполняет команду и возвращает результат клиенту. XML-RPC сервер работает в отдельном потоке, что позволяет ему работать параллельно с остальным кодом.

## Компоненты

### `fast_api_rpc.py` (серверная часть)

#### Классы

##### `FastApiServer`

**Описание**:
Этот класс отвечает за запуск и настройку FastAPI-сервера.

**Как работает класс**:
Класс `FastApiServer` содержит логику для создания и настройки веб-сервера FastAPI. Он отвечает за добавление новых маршрутов.

##### `CommandHandler`

**Описание**:
Этот класс управляет вызовами функций управления сервером, предоставляя методы для удаленного вызова через XML-RPC.

**Как работает класс**:
Класс `CommandHandler` инициализирует и управляет XML-RPC сервером. Он содержит методы, такие как `start_server`, `stop_server`, `stop_all_servers`, `status_servers`, `add_new_route` и `shutdown`, которые могут вызываться удаленно. В конструкторе `__init__` создается объект `SimpleXMLRPCServer`, который слушает запросы на порту `9000` (по умолчанию). Метод `register_instance(self)` делает все методы класса доступными для удаленного вызова. XML-RPC сервер запускается в отдельном потоке для параллельной работы.

**Методы**:
- `__init__(self)`: Инициализирует XML-RPC сервер и запускает его в отдельном потоке.
- `register_instance(self)`: Регистрирует все методы класса для удаленного вызова через XML-RPC.

### `main.py` (клиентская часть)

#### Обзор

`main.py` предоставляет клиентскую часть для взаимодействия с сервером `fast_api_rpc.py` через XML-RPC. Он отображает меню доступных команд, запрашивает ввод пользователя и вызывает соответствующие методы RPC-сервера.

#### Как работает

`main.py` использует `ServerProxy` из библиотеки `xmlrpc.client` для создания объекта, через который можно вызывать методы XML-RPC сервера. В цикле `while True` отображается меню доступных команд, запрашивается ввод пользователя, парсится введенная строка, и в зависимости от введенной команды вызывается соответствующий метод RPC-сервера.

## Взаимодействие между компонентами

1.  **Запуск `fast_api_rpc.py`**:
    *   Создается экземпляр `CommandHandler`.
    *   В конструкторе `CommandHandler` создается XML-RPC сервер, который начинает слушать порт `9000`.
    *   Запускается FastAPI-сервер(ы) в соответствии с кодом, который мы создали.
2.  **Запуск `main.py`**:
    *   Создается экземпляр `CommandHandler` (но он не играет роли, поскольку в `main.py` используется только RPC-клиент).
    *   Создается `ServerProxy`, который подключается к XML-RPC серверу по адресу `http://localhost:9000`.
    *   `main.py` начинает показывать меню и ожидать ввода пользователя.
3.  **Ввод команды**:
    *   `main.py` анализирует эту строку, выделяет команду и её аргументы.
    *   `main.py` вызывает метод `start_server(port=8000, host="0.0.0.0")` у объекта `rpc_client`. Это *не* вызов метода на локальном объекте, а запрос к XML-RPC серверу.
4.  **Обработка запроса на сервере**:
    *   XML-RPC клиент `rpc_client` создает XML-сообщение, которое отправляет на сервер `fast_api_rpc.py`.
    *   XML-RPC сервер в `fast_api_rpc.py` получает этот запрос.
    *   Вызывается метод `start_server`, который запускает FastAPI сервер.
5.  **Возврат ответа**:
    *   Этот ответ отправляется обратно клиенту `main.py`.
    *   Клиент получает ответ.
6.  **Отображение результата**: `main.py` может отобразить результат в консоль (или проигнорировать его, если это None).
7.  **Повторение цикла**: `main.py` возвращается к началу цикла, отображая меню и ожидая ввода следующей команды.

## Ключевые моменты

*   **Разделение ответственности**: `fast_api_rpc.py` отвечает за управление сервером и предоставление интерфейса для управления, `main.py` отвечает за взаимодействие с пользователем и отправку команд.
*   **XML-RPC**: `xmlrpc` используется для организации связи между двумя процессами, что позволяет вызывать методы сервера из клиентской программы.
*   **Потоки**: XML-RPC сервер запущен в отдельном потоке, поэтому он может работать параллельно с остальным кодом.
*   **Удаленный вызов**: `ServerProxy` позволяет вызывать методы, как если бы они были частью локального кода, хотя на самом деле они выполняются на удаленном сервере.

## Преимущества данного подхода

*   **Управление сервером из другой программы**: Мы можем контролировать запущенный сервер через другой процесс или даже с другой машины.
*   **Разделение кода**: Логика управления сервером и пользовательский интерфейс разделены, что делает код более модульным и легким в обслуживании.
*   **Гибкость**: Мы можем добавить новые методы управления сервером, просто добавив их в `CommandHandler`, и они автоматически станут доступны через RPC.