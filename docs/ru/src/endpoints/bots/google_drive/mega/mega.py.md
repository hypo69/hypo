# Модуль для взаимодействия с сервисом Mega.nz

## Обзор

Модуль предоставляет класс `Mega` для взаимодействия с сервисом Mega.nz. Он позволяет выполнять такие операции, как аутентификация, получение списка файлов, скачивание и загрузка файлов.

## Подробней

Этот модуль позволяет взаимодействовать с API сервиса Mega.nz. Он включает в себя функциональность для входа в систему, получения списка файлов, скачивания и загрузки файлов. Модуль использует различные криптографические методы для обеспечения безопасности передаваемых данных, такие как AES и RSA.

## Классы

### `Mega`

**Описание**:
Класс `Mega` предоставляет интерфейс для взаимодействия с сервисом Mega.nz. Он включает в себя методы для аутентификации, получения списка файлов, скачивания и загрузки файлов.

**Как работает класс**:

1.  **Инициализация**: При создании экземпляра класса `Mega` генерируется случайный номер последовательности (`seqno`) и инициализируется идентификатор сессии (`sid`) как `None`.

2.  **Аутентификация**: Класс предоставляет несколько способов аутентификации, включая вход с использованием электронной почты и пароля, а также вход с использованием эфемерных ключей.

3.  **Взаимодействие с API**: Класс использует метод `api_req` для отправки запросов к API Mega.nz. Этот метод добавляет идентификатор последовательности и идентификатор сессии к запросу, а также обрабатывает ответы API.

4.  **Криптография**: Класс использует различные криптографические методы для обеспечения безопасности передаваемых данных, такие как AES и RSA. Ключи шифрования генерируются и управляются внутри класса.

5.  **Операции с файлами**: Класс предоставляет методы для получения списка файлов, скачивания и загрузки файлов. Эти методы используют API Mega.nz для выполнения соответствующих операций.

**Методы**:

*   `__init__`: Инициализирует экземпляр класса `Mega`.
*   `from_credentials`: Создает экземпляр класса `Mega` и выполняет вход с использованием электронной почты и пароля.
*   `from_ephemeral`: Создает экземпляр класса `Mega` и выполняет вход с использованием эфемерных ключей.
*   `api_req`: Отправляет запрос к API Mega.nz.
*   `login_user`: Выполняет вход с использованием электронной почты и пароля.
*   `login_ephemeral`: Выполняет вход с использованием эфемерных ключей.
*   `_login_common`: Общая логика для входа в систему.
*   `get_files`: Получает список файлов из Mega.nz.
*   `download_from_url`: Скачивает файл по публичной ссылке.
*   `download_file`: Скачивает файл из Mega.nz.
*   `get_public_url`: Получает публичную ссылку на файл.
*   `uploadfile`: Загружает файл в Mega.nz.

## Функции

### `__init__`

```python
def __init__(self):
    """
    Инициализирует экземпляр класса `Mega`.

    Args:
        self (Mega): Экземпляр класса `Mega`.

    Returns:
        None

    Raises:
        None
    """
    ...
```

**Как работает функция**:

1.  Инициализирует `self.seqno` случайным целым числом в диапазоне от 0 до 0xFFFFFFFF. Это нужно для отслеживания последовательности запросов к API.
2.  Устанавливает `self.sid` в `None`. `self.sid` будет хранить идентификатор сессии пользователя после успешной аутентификации.

### `from_credentials`

```python
@classmethod
def from_credentials(cls, email: str, password: str) -> 'Mega':
    """
    Создает экземпляр класса `Mega` и выполняет вход с использованием электронной почты и пароля.

    Args:
        cls (Mega): Класс `Mega`.
        email (str): Электронная почта пользователя.
        password (str): Пароль пользователя.

    Returns:
        Mega: Экземпляр класса `Mega`, прошедший аутентификацию.

    Raises:
        MegaRequestException: Если возникает ошибка при запросе к API.
    """
    ...
```

**Как работает функция**:

1.  Создает экземпляр класса `Mega`.
2.  Вызывает метод `login_user` для аутентификации пользователя с использованием предоставленных электронной почты и пароля.
3.  Возвращает созданный экземпляр класса `Mega`.

### `from_ephemeral`

```python
@classmethod
def from_ephemeral(cls) -> 'Mega':
    """
    Создает экземпляр класса `Mega` и выполняет вход с использованием эфемерных ключей.

    Args:
        cls (Mega): Класс `Mega`.

    Returns:
        Mega: Экземпляр класса `Mega`, прошедший аутентификацию.

    Raises:
        MegaRequestException: Если возникает ошибка при запросе к API.
    """
    ...
```

**Как работает функция**:

1.  Создает экземпляр класса `Mega`.
2.  Вызывает метод `login_ephemeral` для аутентификации пользователя с использованием эфемерных ключей.
3.  Возвращает созданный экземпляр класса `Mega`.

### `api_req`

```python
def api_req(self, data: dict) -> dict:
    """
    Отправляет запрос к API Mega.nz.

    Args:
        self (Mega): Экземпляр класса `Mega`.
        data (dict): Словарь с данными для отправки в запросе.

    Returns:
        dict: Словарь с данными, полученными в ответе от API.

    Raises:
        MegaRequestException: Если API возвращает код ошибки.
    """
    ...
```

**Как работает функция**:

1.  Подготавливает параметры запроса, включая идентификатор запроса (`id`) и идентификатор сессии (`sid`), если он существует.
2.  Преобразует данные запроса в формат JSON.
3.  Выполняет POST-запрос к API Mega.nz.
4.  Обрабатывает ответ API. Если ответ содержит код ошибки, выбрасывает исключение `MegaRequestException`.
5.  Возвращает данные, полученные в ответе от API.

### `login_user`

```python
def login_user(self, email: str, password: str) -> None:
    """
    Выполняет вход с использованием электронной почты и пароля.

    Args:
        self (Mega): Экземпляр класса `Mega`.
        email (str): Электронная почта пользователя.
        password (str): Пароль пользователя.

    Returns:
        None

    Raises:
        MegaRequestException: Если возникает ошибка при запросе к API.
        MegaIncorrectPasswordExcetion: Если указан неверный email или пароль
    """
    ...
```

**Как работает функция**:

1.  Подготавливает ключ шифрования пароля с использованием функции `prepare_key`.
2.  Вычисляет хеш электронной почты и пароля с использованием функции `stringhash`.
3.  Отправляет запрос к API с электронной почтой и хешем пароля.
4.  Вызывает метод `_login_common` для обработки ответа API и завершения процесса входа.

### `login_ephemeral`

```python
def login_ephemeral(self) -> None:
    """
    Выполняет вход с использованием эфемерных ключей.

    Args:
        self (Mega): Экземпляр класса `Mega`.

    Returns:
        None

    Raises:
        MegaRequestException: Если возникает ошибка при запросе к API.
    """
    ...
```

**Как работает функция**:

1.  Генерирует случайные ключи: `random_master_key`, `random_password_key` и `random_session_self_challenge`.
2.  Отправляет запрос к API с зашифрованным мастер-ключом и вызовом `base64urlencode`.
3.  Запрашивает у API `user_handle`
4.  Вызывает метод `_login_common` для обработки ответа API и завершения процесса входа.

### `_login_common`

```python
def _login_common(self, res: dict, password: list) -> None:
    """
    Общая логика для входа в систему.

    Args:
        self (Mega): Экземпляр класса `Mega`.
        res (dict): Ответ от API.
        password (list): Ключ шифрования пароля.

    Returns:
        None

    Raises:
        MegaIncorrectPasswordExcetion: Если указан неверный email или пароль.
    """
    ...
```

**Как работает функция**:

1.  Проверяет, не вернул ли API код ошибки, связанный с неверным email или паролем. Если да, выбрасывает исключение `MegaIncorrectPasswordExcetion`.
2.  Дешифрует мастер-ключ с использованием предоставленного пароля.
3.  Если в ответе API содержится идентификатор сессии (`tsid`), проверяет его подлинность и сохраняет его.
4.  Если в ответе API содержится зашифрованный приватный ключ RSA (`privk`), дешифрует его и сохраняет.

### `get_files`

```python
def get_files(self) -> dict:
    """
    Получает список файлов из Mega.nz.

    Args:
        self (Mega): Экземпляр класса `Mega`.

    Returns:
        dict: Словарь с данными о файлах.

    Raises:
        MegaRequestException: Если возникает ошибка при запросе к API.
    """
    ...
```

**Как работает функция**:

1.  Отправляет запрос к API для получения списка файлов.
2.  Итерируется по списку файлов и дешифрует ключи и атрибуты для каждого файла и каталога.
3.  Сохраняет идентификаторы корневого каталога, входящих и корзины.
4.  Возвращает словарь с данными о файлах.

### `download_from_url`

```python
def download_from_url(self, url: str) -> str:
    """
    Скачивает файл по публичной ссылке.

    Args:
        self (Mega): Экземпляр класса `Mega`.
        url (str): URL файла для скачивания.

    Returns:
        str: Имя скачанного файла.

    Raises:
        MegaRequestException: Если возникает ошибка при запросе к API.
    """
    ...
```

**Как работает функция**:

1.  Извлекает идентификатор файла и ключ файла из URL.
2.  Вызывает метод `download_file` для скачивания файла.
3.  Возвращает имя скачанного файла.

### `download_file`

```python
def download_file(self, file_id: str, file_key: list, public: bool = False, store_path: str | None = None) -> str:
    """
    Скачивает файл из Mega.nz.

    Args:
        self (Mega): Экземпляр класса `Mega`.
        file_id (str): Идентификатор файла.
        file_key (list): Ключ файла.
        public (bool): Является ли файл общедоступным. По умолчанию `False`.
        store_path (str | None): Путь для сохранения файла. По умолчанию `None`.

    Returns:
        str: Имя скачанного файла.

    Raises:
        MegaRequestException: Если возникает ошибка при запросе к API.
        ValueError: Если не совпадают MAC-адреса.
    """
    ...
```

**Как работает функция**:

1.  Отправляет запрос к API для получения информации о файле, используя file_id и, если файл публичный, то g=1 и p=file_id, иначе g=1 и n=file_id.
2.  Вычисляет ключ шифрования файла.
3.  Извлекает URL файла, размер файла и атрибуты файла из ответа API.
4.  Открывает файл для записи.
5.  Дешифрует файл по частям, используя AES в режиме CTR.
6.  Вычисляет MAC-адрес файла и сравнивает его с MAC-адресом, полученным от API.
7.  Закрывает файл.
8.  Возвращает имя скачанного файла.

### `get_public_url`

```python
def get_public_url(self, file_id: str, file_key: list) -> str:
    """
    Получает публичную ссылку на файл.

    Args:
        self (Mega): Экземпляр класса `Mega`.
        file_id (str): Идентификатор файла.
        file_key (list): Ключ файла.

    Returns:
        str: Публичная ссылка на файл.

    Raises:
        MegaRequestException: Если возникает ошибка при запросе к API.
    """
    ...
```

**Как работает функция**:

1.  Запрашивает у API публичный обработчик файла с помощью `file_id`.
2.  Кодирует ключ файла в base64.
3.  Формирует и возвращает публичную ссылку на файл.

### `uploadfile`

```python
def uploadfile(self, filename: str, dst: str | None = None) -> dict:
    """
    Загружает файл в Mega.nz.

    Args:
        self (Mega): Экземпляр класса `Mega`.
        filename (str): Имя файла для загрузки.
        dst (str | None): Идентификатор каталога назначения. По умолчанию `None`.

    Returns:
        dict: Данные ответа API.

    Raises:
        MegaRequestException: Если возникает ошибка при запросе к API.
    """
    ...
```

**Как работает функция**:

1.  Определяет каталог назначения. Если `dst` не указан, использует корневой каталог.
2.  Открывает файл для чтения.
3.  Запрашивает у API URL для загрузки файла.
4.  Генерирует случайные ключи для шифрования файла.
5.  Шифрует файл по частям, используя AES в режиме CTR.
6.  Вычисляет MAC-адрес файла.
7.  Отправляет зашифрованные части файла на URL для загрузки.
8.  Формирует метаданные файла, включая имя файла, зашифрованные атрибуты и ключ шифрования.
9.  Отправляет запрос к API для завершения загрузки файла.
10. Возвращает данные ответа API.