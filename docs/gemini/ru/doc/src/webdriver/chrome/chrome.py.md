# Модуль для работы с WebDriver Chrome

## Обзор

Модуль `chrome.py` предоставляет расширение для `webdriver.Chrome` с дополнительной функциональностью, упрощающей настройку и использование Chrome WebDriver. Он включает поддержку пользовательских профилей, прокси и различных режимов окон.

## Подробней

Этот модуль предназначен для упрощения настройки и управления экземплярами Chrome WebDriver. Он автоматизирует задачи, такие как настройка прокси, управление профилями пользователей и выбор режимов отображения окон. Это позволяет разработчикам сосредоточиться на автоматизации задач, а не на сложной конфигурации браузера.

## Классы

### `Chrome`

**Описание**: Класс `Chrome` расширяет функциональность `webdriver.Chrome` из Selenium, предоставляя дополнительные возможности для настройки и управления браузером Chrome.

**Наследует**:
- `selenium.webdriver.Chrome`

**Атрибуты**:
- `driver_name` (str): Имя драйвера, установлено как `'chrome'`.

**Методы**:
- `__init__`: Инициализирует экземпляр драйвера Chrome с заданными параметрами, такими как профиль пользователя, версия chromedriver, пользовательский агент, прокси и режим окна.
- `set_proxy`: Настраивает прокси для Chrome из словаря, возвращаемого функцией `get_proxies_dict`.
- `_payload`: Загружает исполнителей для локаторов и JavaScript сценариев.

### `__init__`

```python
def __init__(self, profile_name: Optional[str] = None,
                 chromedriver_version: Optional[str] = None,
                 user_agent: Optional[str] = None,
                 proxy_file_path: Optional[str] = None,
                 options: Optional[List[str]] = None,
                 window_mode: Optional[str] = None,
                 *args, **kwargs) -> None:
    """
    Инициализирует экземпляр драйвера Chrome с заданными параметрами.

    Args:
        profile_name (Optional[str], optional): Имя пользовательского профиля Chrome. По умолчанию `None`.
        chromedriver_version (Optional[str], optional): Версия chromedriver. По умолчанию `None`.
        user_agent (Optional[str], optional): Пользовательский агент в формате строки. По умолчанию `None`.
        proxy_file_path (Optional[str], optional): Путь к файлу с прокси. По умолчанию `None`.
        options (Optional[List[str]], optional): Список опций для Chrome. По умолчанию `None`.
        window_mode (Optional[str], optional): Режим окна браузера (`windowless`, `kiosk`, `full_window` и т.д.). По умолчанию `None`.

    Raises:
        WebDriverException: Если не удается запустить WebDriver.
        Exception: Если возникает ошибка во время работы Chrome WebDriver.
    """
```

**Как работает функция**:

1. **Инициализация переменных**:
   - Устанавливает `service` и `options_obj` в `None`.

2. **Загрузка конфигурации**:
   - Загружает конфигурацию Chrome из файла `chrome.json` с использованием `j_loads_ns`.

3. **Определение пути к Chromedriver**:
   - Формирует путь к исполняемому файлу Chromedriver на основе конфигурации.

4. **Инициализация сервиса Chromedriver**:
   - Создает экземпляр `Service` с путем к Chromedriver.

5. **Настройка опций Chrome**:
   - Создает экземпляр `Options` для настройки опций Chrome.

6. **Добавление опций из конфигурации**:
   - Если в конфигурации указаны опции, они добавляются в `options_obj`.

7. **Установка режима окна**:
   - Устанавливает режим окна из конфигурации или параметров инициализации (`window_mode`). Поддерживаемые режимы: `kiosk`, `windowless`, `full_window`.

8. **Добавление дополнительных опций**:
   - Добавляет опции, переданные при инициализации, в `options_obj`.

9. **Установка пользовательского агента**:
   - Устанавливает пользовательский агент, используя либо переданный параметр, либо случайный агент из `UserAgent`.

10. **Настройка прокси**:
    - Если в конфигурации включена поддержка прокси, вызывает метод `set_proxy` для настройки прокси.

11. **Настройка директории профиля**:
    - Определяет директорию профиля на основе конфигурации и параметра `profile_name`.

12. **Запуск WebDriver**:
    - Инициализирует `WebDriver` с настроенными сервисом и опциями.

13. **Обработка исключений**:
    - Перехватывает исключения `WebDriverException` и `Exception` и логирует критические ошибки, возвращая управление.

```
    Начало
    │
    ├── Загрузка конфигурации из chrome.json
    │   (config)
    │
    ├── Определение пути к Chromedriver
    │   (chromedriver_path)
    │
    ├── Инициализация сервиса Chromedriver
    │   (service)
    │
    ├── Создание объекта опций Chrome
    │   (options_obj)
    │
    ├── Добавление опций из файла конфигурации
    │
    ├── Установка режима окна (kiosk, windowless, full_window)
    │
    ├── Добавление дополнительных опций
    │
    ├── Установка User-Agent
    │
    ├── Настройка прокси (если включено)
    │
    ├── Настройка директории профиля
    │
    ├── Запуск Chrome WebDriver
    │
    └── Обработка исключений (WebDriverException, Exception)
        │
        └── Завершение
```

**Примеры**:

```python
from src.webdriver.chrome.chrome import Chrome

# Инициализация Chrome WebDriver с профилем и режимом полного окна
driver = Chrome(profile_name='my_profile', window_mode='full_window')

# Инициализация Chrome WebDriver с пользовательским user-agent
driver = Chrome(user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64)')

# Инициализация Chrome WebDriver с дополнительными опциями
options = ['--disable-extensions', '--mute-audio']
driver = Chrome(options=options)
```

### `set_proxy`

```python
def set_proxy(self, options: Options) -> None:
    """
    Настраивает прокси для Chrome из словаря, возвращаемого функцией `get_proxies_dict`.

    Args:
        options (Options): Опции Chrome, в которые добавляются настройки прокси.
    """
```

**Как работает функция**:

1. **Получение словаря прокси**:
   - Вызывает функцию `get_proxies_dict` для получения словаря с настройками прокси.

2. **Создание списка всех прокси**:
   - Объединяет списки прокси `socks4` и `socks5` из словаря в один список `all_proxies`.

3. **Перебор прокси для поиска рабочего**:
   - Перебирает прокси из списка `all_proxies` в случайном порядке.
   - Для каждого прокси проверяет его работоспособность с помощью функции `check_proxy`.
   - Если прокси работает, он сохраняется в переменной `working_proxy` и цикл прерывается.

4. **Настройка прокси**:
   - Если найден рабочий прокси (`working_proxy` не `None`):
     - Извлекает протокол прокси (`http`, `socks4`, `socks5`).
     - Добавляет аргумент командной строки для настройки прокси в зависимости от протокола.
     - Логирует информацию о настройке прокси.
   - Если рабочий прокси не найден, логирует предупреждение о отсутствии доступных прокси.

```
    Начало
    │
    ├── Получение словаря прокси (proxies_dict)
    │
    ├── Создание списка всех прокси (all_proxies)
    │
    ├── Перебор прокси для поиска рабочего
    │   │
    │   └── Проверка работоспособности прокси (check_proxy)
    │       │
    │       └── Если прокси рабочий -> Сохранение прокси (working_proxy)
    │
    └── Настройка прокси (если найден рабочий)
        │
        ├── Определение протокола прокси
        │
        └── Добавление аргумента командной строки для настройки прокси
            │
            └── Логирование информации о настройке прокси
        │
        └── Если рабочий прокси не найден -> Логирование предупреждения
    │
    └── Завершение
```

**Примеры**:

```python
from selenium.webdriver.chrome.options import Options
from src.webdriver.chrome.chrome import Chrome

# Пример использования функции set_proxy
options = Options()
chrome_instance = Chrome()
chrome_instance.set_proxy(options)
```

### `_payload`

```python
def _payload(self) -> None:
    """
    Загружает исполнителей для локаторов и JavaScript сценариев.
    """
```

**Как работает функция**:

1. **Создание экземпляра JavaScript**:
   - Создает экземпляр класса `JavaScript`, передавая текущий экземпляр `Chrome` в качестве аргумента.

2. **Назначение JavaScript функций**:
   - Присваивает методы экземпляра `JavaScript` текущему экземпляру `Chrome`, делая их доступными как методы драйвера.

3. **Создание экземпляра ExecuteLocator**:
   - Создает экземпляр класса `ExecuteLocator`, передавая текущий экземпляр `Chrome` в качестве аргумента.

4. **Назначение методов ExecuteLocator**:
   - Присваивает методы экземпляра `ExecuteLocator` текущему экземпляру `Chrome`, делая их доступными как методы драйвера.

```
    Начало
    │
    ├── Создание экземпляра JavaScript (j)
    │
    ├── Присваивание JavaScript функций текущему экземпляру Chrome
    │
    ├── Создание экземпляра ExecuteLocator (execute_locator)
    │
    └── Присваивание методов ExecuteLocator текущему экземпляру Chrome
    │
    └── Завершение
```

**Примеры**:

```python
from src.webdriver.chrome.chrome import Chrome

# Пример использования функции _payload
driver = Chrome()
driver._payload()
```

## Примеры

```python
if __name__ == "__main__":
    driver = Chrome(window_mode='full_window')
    driver.get(r"https://google.com")
```