# Модуль для работы с провайдером Ails (GPT4Free)
## Обзор
Модуль `Ails.py` предоставляет асинхронный генератор для взаимодействия с сервисом `ai.ls` через API `caipacity.com`. Он использует модель `gpt-3.5-turbo` и поддерживает как историю сообщений, так и потоковую передачу данных. Этот модуль предназначен для интеграции с другими частями проекта `hypotez`, где требуется доступ к API `ai.ls`.
## Подробнее
Модуль содержит класс `Ails`, который наследуется от `AsyncGeneratorProvider`. Он предназначен для работы с API `ai.ls` для генерации текста на основе модели `gpt-3.5-turbo`. В модуле определены функции для форматирования timestamp и создания хэша, используемых при взаимодействии с API.
## Классы
### `Ails`
**Описание**: Класс `Ails` предоставляет асинхронный генератор для взаимодействия с API `ai.ls`. Он поддерживает историю сообщений и потоковую передачу данных.
**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных генераторов провайдеров.
**Атрибуты**:
- `url` (str): URL сервиса `ai.ls`.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений.
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели `gpt-3.5-turbo`.
**Методы**:
- `create_async_generator`: Создает асинхронный генератор для взаимодействия с API `ai.ls`.
#### `create_async_generator`
```python
    @staticmethod
    async def create_async_generator(
        model: str,
        messages: Messages,
        stream: bool,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для взаимодействия с API `ai.ls`.
        Args:
            model (str): Модель для использования (в данном случае всегда `gpt-3.5-turbo`).
            messages (Messages): Список сообщений для отправки в API.
            stream (bool): Флаг, указывающий на необходимость потоковой передачи данных.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            **kwargs: Дополнительные параметры.
        Returns:
            AsyncResult: Асинхронный генератор, возвращающий текст от API `ai.ls`.
        Raises:
            Exception: Если ответ содержит признаки ошибки, такие как упоминания `ai.ls` или `ai.ci`.
        """
```
**Как работает функция**:
1.  **Формирование заголовков**: Функция формирует заголовки для HTTP-запроса, включая `authorization`, `client-id`, `client-v`, `content-type` и другие необходимые параметры.
2.  **Создание сессии**: Используется `ClientSession` из библиотеки `aiohttp` для выполнения асинхронных HTTP-запросов.
3.  **Формирование данных запроса**: Создается словарь `json_data`, включающий модель, температуру, флаг потоковой передачи, сообщения, дату и хэш.
4.  **Отправка запроса**: Отправляется POST-запрос к API `caipacity.com` с использованием сформированных заголовков и данных.
5.  **Обработка ответа**: Функция асинхронно итерируется по строкам ответа, декодирует их и извлекает контент из JSON-ответа.
6.  **Проверка на ошибки**: Проверяется наличие в ответе признаков ошибки (например, упоминаний `ai.ls` или `ai.ci`). Если ошибка обнаружена, вызывается исключение.
7.  **Генерация токенов**: Извлеченные токены передаются через `yield`, что позволяет использовать функцию как асинхронный генератор.
A
|
Заголовки и сессия
|
Данные запроса
|
Отправка POST-запроса
|
Обработка ответа
|
Проверка на ошибки
|
Генерация токенов
**Примеры**:
```python
# Пример использования функции create_async_generator
import asyncio
async def main():
    messages = [{"role": "user", "content": "Hello, world!"}]
    async for token in Ails.create_async_generator(model="gpt-3.5-turbo", messages=messages, stream=True):
        print(token, end="")

if __name__ == "__main__":
    asyncio.run(main())
```
## Функции
### `_hash`
```python
def _hash(json_data: dict[str, str]) -> SHA256:
    """Создает SHA256 хэш на основе переданных данных.
    Args:
        json_data (dict[str, str]): Словарь с данными для хэширования, содержащий ключи `t` (timestamp) и `m` (message).
    Returns:
        SHA256: SHA256 хэш, созданный на основе данных.
    """
```
**Как работает функция**:
1.  **Формирование строки**: Функция формирует строку `base_string`, объединяя timestamp и сообщение с фиксированным ключом и длиной сообщения.
2.  **Хэширование**: Строка кодируется в байты и хэшируется с использованием алгоритма SHA256.
3.  **Возврат хэша**: Функция возвращает SHA256 хэш в виде шестнадцатеричной строки.
```
Данные (timestamp, message)
|
Формирование строки
|
Кодирование и хэширование
|
Возврат хэша
```
**Примеры**:
```python
# Пример использования функции _hash
data = {"t": "1625270400", "m": "Hello"}
hash_value = _hash(data)
print(hash_value)
```
### `_format_timestamp`
```python
def _format_timestamp(timestamp: int) -> str:
    """Форматирует timestamp.
    Args:
        timestamp (int): Timestamp для форматирования.
    Returns:
        str: Отформатированный timestamp в виде строки.
    """
```
**Как работает функция**:
1.  **Вычисление остатка**: Функция вычисляет остаток от деления timestamp на 10.
2.  **Коррекция остатка**: Если остаток четный, к нему добавляется 1; в противном случае остаток не изменяется.
3.  **Форматирование**: Из исходного timestamp вычитается остаток и прибавляется скорректированный остаток. Результат преобразуется в строку.
```
Timestamp
|
Вычисление остатка
|
Коррекция остатка
|
Форматирование
|
Возврат строки
```
**Примеры**:
```python
# Пример использования функции _format_timestamp
timestamp = 1625270405
formatted_timestamp = _format_timestamp(timestamp)
print(formatted_timestamp)