# Модуль `post_message.py`

## Обзор

Модуль `post_message.py` предназначен для автоматизации процесса публикации сообщений в Facebook, включая добавление заголовка, описания и медиафайлов. Модуль содержит функции для загрузки медиа, обновления подписей к изображениям и публикации поста.

## Подробней

Этот модуль является частью проекта `hypotez` и отвечает за автоматизацию процесса создания рекламных постов в Facebook. Он использует Selenium WebDriver для взаимодействия с веб-интерфейсом Facebook. Модуль предоставляет функции для загрузки медиафайлов, добавления заголовков и описаний к постам, а также для публикации этих постов.

## Функции

### `post_title`

```python
def post_title(d: Driver, message: SimpleNamespace | str) -> bool:
    """
    Отправляет заголовок и описание кампании в поле сообщения поста.

    Args:
        d (Driver): Экземпляр драйвера, используемый для взаимодействия с веб-страницей.
        message (SimpleNamespace | str): Объект SimpleNamespace, содержащий заголовок и описание, или строка сообщения для отправки.

    Returns:
        bool: `True`, если заголовок и описание были успешно отправлены, иначе `None`.

    Example:
        >>> driver = Driver(...)
        >>> message = SimpleNamespace(title="Заголовок кампании", description="Описание кампании")
        >>> post_title(driver, message)
        True
    """
```

**Как работает функция**:

1.  **Прокрутка страницы**: Функция начинает с прокрутки страницы назад, чтобы убедиться, что все элементы интерфейса доступны. Если прокрутка не удалась, функция логирует ошибку и завершается.
2.  **Открытие поля "Добавить публикацию"**: Функция пытается открыть поле для добавления новой публикации. Если это не удается, функция логирует отладочное сообщение и завершается.
3.  **Формирование сообщения**: Функция формирует сообщение для публикации, объединяя заголовок и описание из объекта `message`. Если `message` является строкой, она используется как есть.
4.  **Добавление сообщения в поле**: Функция добавляет сформированное сообщение в поле для ввода текста публикации. Используется `d.execute_locator` для поиска и заполнения поля. Если добавление не удается, функция логирует отладочное сообщение и завершается.
5.  **Возврат результата**: Если все шаги выполнены успешно, функция возвращает `True`.

### `upload_media`

```python
def upload_media(d: Driver, media: SimpleNamespace | List[SimpleNamespace] | str | list[str],   no_video: bool = False, without_captions:bool = False) -> bool:
    """
    Загружает медиафайлы в раздел изображений и обновляет подписи.

    Args:
        d (Driver): Экземпляр драйвера, используемый для взаимодействия с веб-страницей.
        media (SimpleNamespace | List[SimpleNamespace] | str | list[str]): Список объектов SimpleNamespace или строк, содержащих пути к медиафайлам.
        no_video (bool, optional): Если `True`, видео не загружаются. По умолчанию `False`.
        without_captions (bool, optional): Если `True`, подписи к изображениям не обновляются. По умолчанию `False`.

    Returns:
        bool: `True`, если медиафайлы были успешно загружены, иначе `None`.

    Raises:
        Exception: Если возникает ошибка при загрузке медиа или обновлении подписей.

    Example:
        >>> driver = Driver(...)
        >>> media = [SimpleNamespace(local_image_path='путь/к/изображению.jpg', ...)]
        >>> upload_media(driver, media)
        True
    """
```

**Как работает функция**:

1.  **Проверка наличия медиа**: Функция проверяет, переданы ли медиафайлы для загрузки. Если нет, функция логирует отладочное сообщение и завершается.
2.  **Открытие формы "Добавить медиа"**: Функция пытается открыть форму для добавления медиафайлов. Если это не удается, функция завершается.
3.  **Подготовка списка медиа**: Функция преобразует входной параметр `media` в список, если он не является списком.
4.  **Загрузка медиафайлов**: Функция итерируется по списку медиафайлов и загружает каждый файл.
    *   Определяется путь к медиафайлу (`media_path`) в зависимости от типа элемента в списке `media_list`. Если элемент является объектом `SimpleNamespace`, проверяется наличие атрибута `local_video_path` (если `no_video` равно `False`), иначе используется `local_image_path`. Если элемент является строкой или объектом `Path`, его значение присваивается `media_path`.
    *   Медиафайл загружается с использованием `d.execute_locator` для поиска поля загрузки и отправки пути к файлу. Если загрузка не удается, функция логирует ошибку и завершается.
5.  **Обновление подписей (если необходимо)**: Если `without_captions` равно `False`, функция пытается обновить подписи к загруженным медиафайлам.
    *   Открывается форма редактирования загруженных медиафайлов. Если это не удается, функция логирует ошибку и завершается.
    *   Находится фрейм с загруженными медиафайлами. Если фрейм не найден, функция логирует отладочное сообщение и завершается.
    *   Находится список текстовых полей для ввода подписей к изображениям. Если поля не найдены, функция логирует ошибку и завершается.
    *   Вызывается функция `update_images_captions` для обновления подписей.
6.  **Возврат результата**: Если все шаги выполнены успешно, функция возвращает `True`.

### `update_images_captions`

```python
def update_images_captions(d: Driver, media: List[SimpleNamespace], textarea_list: List[WebElement]) -> None:
    """
    Добавляет описания к загруженным медиафайлам.

    Args:
        d (Driver): Экземпляр драйвера, используемый для взаимодействия с веб-страницей.
        media (List[SimpleNamespace]): Список продуктов с деталями для обновления.
        textarea_list (List[WebElement]): Список текстовых полей, в которые добавляются подписи.

    Raises:
        Exception: Если возникает ошибка при обновлении подписей к медиафайлам.
    """
```

**Как работает функция**:

1.  **Загрузка локализованных единиц**: Загружаются локализованные строки из файла `translations.json` с использованием функции `j_loads_ns`. Эти строки используются для формирования подписей на разных языках.
2.  **Внутренняя функция `handle_product`**: Определяется внутренняя функция `handle_product`, которая обрабатывает обновление подписи для одного продукта.

    ```python
    def handle_product(product: SimpleNamespace, textarea_list: List[WebElement], i: int) -> None:
        """
        Обрабатывает обновление подписей к медиафайлам для одного продукта.

        Args:
            product (SimpleNamespace): Продукт для обновления.
            textarea_list (List[WebElement]): Список текстовых полей, в которые добавляются подписи.
            i (int): Индекс продукта в списке.
        """
    ```

    **Как работает внутренняя функция `handle_product`**:

    1.  **Определение направления текста**: Определяется язык продукта и направление текста (LTR или RTL) на основе атрибута `language` продукта и данных из `local_units`.
    2.  **Формирование сообщения**: Формируется сообщение для подписи, включающее заголовок продукта, описание, цену, скидку, рейтинг и ссылку на продвижение. Формирование сообщения зависит от направления текста.
    3.  **Отправка сообщения в текстовое поле**: Функция пытается отправить сформированное сообщение в соответствующее текстовое поле. Если отправка не удается, функция логирует ошибку и завершается.
3.  **Обработка продуктов**: Функция итерируется по списку продуктов и вызывает `handle_product` для каждого продукта.

### `publish`

```python
def publish(d:Driver, attempts = 5) -> bool:
    """
    Публикует сообщение после редактирования.

    Args:
        d (Driver): Экземпляр драйвера, используемый для взаимодействия с веб-страницей.
        attempts (int, optional): Количество попыток публикации. По умолчанию 5.

    Returns:
        bool: `True`, если сообщение успешно опубликовано, иначе `None`.
    """
```

**Как работает функция**:

1.  **Проверка количества попыток**: Функция проверяет, осталось ли попыток для публикации. Если `attempts` меньше 0, функция завершается.
2.  **Нажатие кнопки "Завершить редактирование"**: Функция пытается нажать кнопку "Завершить редактирование". Если это не удается, функция логирует отладочное сообщение и завершается.
3.  **Нажатие кнопки "Опубликовать"**: Функция пытается нажать кнопку "Опубликовать". Если это не удается, функция проверяет наличие всплывающих окон ("Закрыть" или "Не сейчас") и пытается нажать их, затем рекурсивно вызывает себя с уменьшенным количеством попыток.
4.  **Ожидание освобождения поля ввода**: Функция ожидает, пока поле ввода сообщения не освободится. Если поле не освобождается, функция проверяет наличие всплывающих окон ("Закрыть" или "Не сейчас") и пытается нажать их, затем рекурсивно вызывает себя с уменьшенным количеством попыток.
5.  **Возврат результата**: Если все шаги выполнены успешно, функция возвращает `True`.

### `promote_post`

```python
def promote_post(d: Driver, category: SimpleNamespace, products: List[SimpleNamespace], no_video: bool = False) -> bool:
    """
    Управляет процессом продвижения поста с заголовком, описанием и медиафайлами.

    Args:
        d (Driver): Экземпляр драйвера, используемый для взаимодействия с веб-страницей.
        category (SimpleNamespace): Детали категории, используемые для заголовка и описания поста.
        products (List[SimpleNamespace]): Список продуктов, содержащих медиа и детали для публикации.
        no_video (bool, optional): Если `True`, видео не загружаются. По умолчанию `False`.

    Example:
        >>> driver = Driver(...)
        >>> category = SimpleNamespace(title="Заголовок кампании", description="Описание кампании")
        >>> products = [SimpleNamespace(local_image_path='путь/к/изображению.jpg', ...)]
        >>> promote_post(driver, category, products)
    """
```

**Как работает функция**:

1.  **Публикация заголовка**: Функция вызывает функцию `post_title` для публикации заголовка и описания поста. Если публикация не удалась, функция завершается.
2.  **Загрузка медиа**: Функция вызывает функцию `upload_media` для загрузки медиафайлов. Если загрузка не удалась, функция завершается.
3.  **Нажатие кнопки "Завершить редактирование"**: Функция пытается нажать кнопку "Завершить редактирование". Если это не удается, функция завершается.
4.  **Публикация поста**: Функция пытается нажать кнопку "Опубликовать". Если это не удается, функция завершается.
5.  **Возврат результата**: Если все шаги выполнены успешно, функция возвращает `True`.

### `post_message`

```python
def post_message(d: Driver, message: SimpleNamespace,  no_video: bool = False,  images:Optional[str | list[str]] = None, without_captions:bool = False) -> bool:
    """
    Управляет процессом продвижения поста с заголовком, описанием и медиафайлами.

    Args:
        d (Driver): Экземпляр драйвера, используемый для взаимодействия с веб-страницей.
        message (SimpleNamespace): Детали сообщения, используемые для заголовка и описания поста.
        no_video (bool, optional): Если `True`, видео не загружаются. По умолчанию `False`.
        images (Optional[str | list[str]], optional): Список изображений для публикации. По умолчанию `None`.
        without_captions (bool, optional): Если `True`, подписи к изображениям не обновляются. По умолчанию `False`.

    Example:
        >>> driver = Driver(...)
        >>> category = SimpleNamespace(title="Заголовок кампании", description="Описание кампании")
        >>> products = [SimpleNamespace(local_image_path='путь/к/изображению.jpg', ...)]
        >>> promote_post(driver, category, products)
    """
```

**Как работает функция**:

1.  **Публикация заголовка**: Функция вызывает функцию `post_title` для публикации заголовка и описания поста. Если публикация не удалась, функция завершается.
2.  **Загрузка медиа**: Функция вызывает функцию `upload_media` для загрузки медиафайлов. Если загрузка не удалась, функция завершается.
3.  **Проверка наличия одного изображения**: Если присутствует только одно изображение, функция пытается нажать кнопку "Отправить" и завершается.
4.  **Нажатие кнопки "Завершить редактирование"**: Функция пытается нажать кнопку "Завершить редактирование". Если это не удается, функция завершается.
5.  **Публикация поста**: Функция вызывает функцию `publish` для публикации поста. Если публикация не удалась, функция завершается.
6.  **Возврат результата**: Если все шаги выполнены успешно, функция возвращает `True`.