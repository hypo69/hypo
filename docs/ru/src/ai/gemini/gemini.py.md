# Модуль для интеграции с Google Generative AI

## Обзор

Модуль `src.ai.gemini.gemini` предоставляет интеграцию с Google Generative AI, позволяя взаимодействовать с различными моделями Gemini для выполнения задач, связанных с генерацией контента, чатом и анализом изображений.

## Подробней

Этот модуль содержит класс `GoogleGenerativeAI`, который упрощает взаимодействие с API Google Gemini. Он поддерживает различные функции, такие как отправка текстовых запросов, ведение истории чата, загрузка файлов и описание изображений. Модуль предназначен для использования в проектах, требующих интеграции с AI-моделями Google. Расположение файла `hypotez/src/ai/gemini/gemini.py` указывает на то, что он является частью подсистемы искусственного интеллекта проекта `hypotez`.

## Классы

### `Config`

**Описание**:
Этот класс не документирован в предоставленном коде.

### `GoogleGenerativeAI`

**Описание**:
Класс `GoogleGenerativeAI` предоставляет интерфейс для взаимодействия с моделями Google Generative AI, такими как Gemini. Он позволяет отправлять текстовые запросы, вести историю чата, загружать файлы и описывать изображения.

**Как работает класс**:
1.  **Инициализация**: При создании экземпляра класса `GoogleGenerativeAI` происходит настройка API-ключа, выбор модели и инициализация чата.
2.  **Взаимодействие с моделью**: Методы `ask`, `ask_async` и `chat` позволяют отправлять запросы к модели и получать ответы.
3.  **Управление историей чата**: Методы `_save_chat_history`, `_load_chat_history` и `clear_history` обеспечивают сохранение, загрузку и очистку истории чата.
4.  **Обработка изображений**: Метод `describe_image` позволяет отправлять изображения и получать их текстовые описания.
5.  **Загрузка файлов**: Метод `upload_file` позволяет загружать файлы в модель Gemini.

**Параметры**:

*   `api_key` (str): API-ключ для доступа к Google Generative AI.
*   `model_name` (str): Имя используемой модели Gemini. По умолчанию "gemini-2.0-flash-exp".
*   `dialogue_txt_path` (Path): Путь к файлу для сохранения диалогов.
*   `generation_config` (Dict): Конфигурация генерации.
*   `system_instruction` (Optional[str]): Системные инструкции для модели.
*   `history_dir` (Path): Путь к директории для сохранения истории чата.
*   `history_txt_file` (Path): Путь к файлу для сохранения истории чата в текстовом формате.
*   `history_json_file` (Path): Путь к файлу для сохранения истории чата в формате JSON.
*   `config` (SimpleNamespace): Конфигурация, загруженная из `gemini.json`.
*   `chat_history` (List[Dict]): История чата.
*   `model` (Any): Экземпляр модели Gemini.
*   `_chat` (Any): Экземпляр чата.
*   `MODELS` (List[str]): Список поддерживаемых моделей.

**Методы**:

*   `__post_init__`: Инициализация модели GoogleGenerativeAI с дополнительными настройками.
*   `normalize_answer`: Очистка вывода от форматирования Markdown, Python, JSON, HTML и т.п.
*   `_start_chat`: Запуск чата с начальной настройкой.
*   `clear_history`: Очищает историю чата в памяти и удаляет файл истории, если он существует.
*   `_save_chat_history`: Сохраняет всю историю чата в JSON файл.
*   `_load_chat_history`: Загружает историю чата из JSON файла.
*   `chat`: Обрабатывает чат-запрос с различными режимами управления историей чата.
*   `ask`: Отправляет текстовый запрос модели и возвращает ответ.
*   `ask_async`: Асинхронно отправляет текстовый запрос модели и возвращает ответ.
*   `describe_image`: Отправляет изображение в Gemini Pro Vision и возвращает его текстовое описание.
*   `upload_file`: Загружает файл в модель Gemini.

## Функции

### `main`

```python
async def main():
    ...
```

**Описание**:
Функция `main` является точкой входа для демонстрации работы с классом `GoogleGenerativeAI`.

**Как работает функция**:

1.  **Инициализация**: Создает экземпляр класса `GoogleGenerativeAI` с API-ключом и системными инструкциями.
2.  **Анализ изображений**:
    *   Загружает изображение из файла `test.jpg`.
    *   Отправляет запрос на анализ изображения с указанием формата JSON.
    *   Выводит описание изображения в формате JSON или текстовом формате.
3.  **Загрузка файлов**:
    *   Создает текстовый файл `test.txt` с содержимым "Hello, Gemini!".
    *   Загружает файл в модель Gemini.
4.  **Чат**:
    *   Запускает цикл, в котором принимает сообщения от пользователя и отправляет их в модель Gemini.
    *   Выводит ответы модели.

**Параметры**:
Нет параметров.

**Возвращает**:
Нет возвращаемого значения.

**Вызывает исключения**:
Не обрабатывает конкретные исключения, но может вызывать исключения при взаимодействии с API Gemini.

**Примеры**:

```python
# Замените на свой ключ API
system_instruction = "Ты - полезный ассистент. Отвечай на все вопросы кратко"
ai = GoogleGenerativeAI(api_key=gs.credentials.gemini.api_key, system_instruction=system_instruction)

# Пример вызова describe_image с промптом
image_path = Path(r"test.jpg")  # Замените на путь к вашему изображению

if not image_path.is_file():
    print(
        f"Файл {image_path} не существует. Поместите в корневую папку с программой файл с названием test.jpg"
    )
else:
    prompt = """Проанализируй это изображение. Выдай ответ в формате JSON,
    где ключом будет имя объекта, а значением его описание.
     Если есть люди, опиши их действия."""

    description = await ai.describe_image(image_path, prompt=prompt)
    if description:
        print("Описание изображения (с JSON форматом):")
        print(description)
        try:
            parsed_description = j_loads(description)

        except Exception as ex:
            print("Не удалось распарсить JSON. Получен текст:")
            print(description)

    else:
        print("Не удалось получить описание изображения.")

    # Пример без JSON вывода
    prompt = "Проанализируй это изображение. Перечисли все объекты, которые ты можешь распознать."
    description = await ai.describe_image(image_path, prompt=prompt)
    if description:
        print("Описание изображения (без JSON формата):")
        print(description)

file_path = Path('test.txt')
with open(file_path, "w") as f:
    f.write("Hello, Gemini!")

file_upload = await ai.upload_file(file_path, 'test_file.txt')
print(file_upload)

# Пример чата
while True:
    user_message = input("You: ")
    if user_message.lower() == 'exit':
        break
    ai_message = await ai.chat(user_message)
    if ai_message:
        print(f"Gemini: {ai_message}")
    else:
        print("Gemini: Ошибка получения ответа")
```