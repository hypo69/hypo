# Модуль `bot_aiogram.py`

## Обзор

Модуль предоставляет реализацию Telegram-бота с использованием библиотеки `aiogram` и интеграцией с сервером FastAPI через RPC. 
Он включает в себя класс `TelegramBot`, который управляет основными аспектами работы бота, такими как обработка команд, 
получение и отправка сообщений, а также взаимодействие с внешними сервисами через RPC.

## Подробней

Этот код обеспечивает создание и запуск Telegram-бота, который может обрабатывать различные команды и сообщения. 
Он использует библиотеку `aiogram` для работы с Telegram API и FastAPI для создания веб-сервера, 
который принимает обновления от Telegram. Взаимодействие между ботом и сервером осуществляется через RPC.

Модуль содержит следующие компоненты:

- Класс `TelegramBot`: Основной класс, управляющий ботом.
- Обработчики сообщений: Функции, обрабатывающие различные типы сообщений, такие как команды, текст, голос и документы.
- RPC-клиент: Используется для взаимодействия с внешними сервисами через RPC.

## Классы

### `TelegramBot`

**Описание**:
Класс `TelegramBot` представляет собой интерфейс для работы с Telegram-ботом. Он инициализирует бота, регистрирует обработчики команд, запускает веб-сервер для приема обновлений от Telegram и обеспечивает взаимодействие с внешними сервисами через RPC. Класс реализован как Singleton.

**Как работает класс**:

1.  **Инициализация**: При создании экземпляра класса `TelegramBot` происходит инициализация токена, маршрута вебхука, загрузка конфигурации, создание экземпляров `Bot` и `Dispatcher` из библиотеки `aiogram`, а также регистрация обработчиков команд.
2.  **Запуск**: Метод `run` запускает бота, инициализирует RPC-клиент для взаимодействия с внешним сервером, регистрирует маршрут вебхука и запускает веб-сервер для приема обновлений от Telegram.
3.  **Регистрация обработчиков**: Метод `_register_default_handlers` регистрирует обработчики команд, такие как `/start`, `/help`, `/sendpdf`, а также обработчики для текста, голоса и документов.
4.  **Обработка сообщений**: Метод `_handle_message` обрабатывает текстовые сообщения, перенаправляя их в `bot_handler`.
5.  **Инициализация вебхука**: Метод `initialize_bot_webhook` инициализирует вебхук для получения обновлений от Telegram. Если хост указан как `127.0.0.1` или `localhost`, используется `ngrok` для создания туннеля.
6.  **Регистрация маршрута через RPC**: Метод `_register_route_via_rpc` регистрирует маршрут вебхука на сервере через RPC.
7.  **Остановка бота**: Метод `stop` останавливает бота, удаляет вебхук и закрывает веб-сервер.

**Методы**:

*   `__init__(self, token: str, route: str = 'telegram_webhook')`

    *   **Описание**: Инициализирует экземпляр класса `TelegramBot`.
    *   **Параметры**:
        *   `token` (str): Токен Telegram-бота.
        *   `route` (str): Маршрут вебхука для FastAPI. По умолчанию `'telegram_webhook'`.
    *   **Как работает метод**:
        1.  Инициализирует атрибуты класса, такие как токен, маршрут, порт и конфигурацию.
        2.  Создает экземпляры `Bot` и `Dispatcher` из библиотеки `aiogram`.
        3.  Создает экземпляр класса `BotHandler` для обработки сообщений.
        4.  Регистрирует обработчики команд по умолчанию.
        5.  Инициализирует атрибуты `app` и `rpc_client` как `None`.

*   `run(self)`

    *   **Описание**: Запускает бота, инициализирует RPC и вебхук.
    *   **Как работает метод**:
        1.  Инициализирует RPC-клиент для взаимодействия с сервером.
        2.  Запускает RPC-сервер через RPC-клиент.
        3.  Инициализирует вебхук для получения обновлений от Telegram.
        4.  Регистрирует маршрут вебхука через RPC.
        5.  Запускает веб-сервер для приема обновлений от Telegram.
        6.  В случае ошибки логирует исключение и завершает работу.

*   `_register_default_handlers(self)`

    *   **Описание**: Регистрирует обработчики команд по умолчанию.
    *   **Как работает метод**:
        1.  Регистрирует обработчики для команд `/start`, `/help`, `/sendpdf`.
        2.  Регистрирует обработчики для текстовых сообщений, голосовых сообщений и документов.
        3.  Вся логика обработки вынесена в класс `BotHandler`

*   `_handle_message(self, message: types.Message)`

    *   **Описание**: Обрабатывает текстовые сообщения.
    *   **Параметры**:
        *   `message` (types.Message): Объект сообщения от Telegram.
    *   **Как работает метод**:
        1.  Передает сообщение в `bot_handler` для дальнейшей обработки.

*   `initialize_bot_webhook(self, route: str)`

    *   **Описание**: Инициализирует вебхук для получения обновлений от Telegram.
    *   **Параметры**:
        *   `route` (str): Маршрут вебхука.
    *   **Возвращает**:
        *   `webhook_url` (str): URL вебхука.
    *   **Как работает метод**:
        1.  Формирует URL вебхука на основе хоста и маршрута.
        2.  Если хост указан как `127.0.0.1` или `localhost`, использует `ngrok` для создания туннеля.
        3.  Устанавливает вебхук для бота.
        4.  В случае ошибки логирует исключение и возвращает `False`.

*   `_register_route_via_rpc(self, rpc_client: ServerProxy)`

    *   **Описание**: Регистрирует маршрут вебхука на сервере через RPC.
    *   **Параметры**:
        *   `rpc_client` (ServerProxy): RPC-клиент.
    *   **Как работает метод**:
        1.  Регистрирует маршрут вебхука на сервере через RPC-клиент.
        2.  В случае ошибки логирует исключение.

*   `stop(self)`

    *   **Описание**: Останавливает бота и удаляет вебхук.
    *   **Как работает метод**:
        1.  Останавливает веб-сервер.
        2.  Удаляет вебхук.
        3.  В случае ошибки логирует исключение.

## Функции

### `__name__ == "__main__"`

*   **Описание**: Точка входа для запуска бота.
*   **Как работает функция**:
    1.  Загружает переменные окружения из файла `.env`.
    2.  Создает экземпляр класса `TelegramBot` с токеном, полученным из переменной окружения `TELEGRAM_TOKEN`.
    3.  Запускает бота.