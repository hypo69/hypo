# Модуль для интеграции с Google generative AI (Magenta)

## Обзор

Модуль `magenta.py` предоставляет класс `MagentaMusic` для генерации музыки с использованием моделей Magenta. Он позволяет загружать MIDI-файлы в качестве затравки, генерировать мелодии, добавлять аккорды и барабаны, устанавливать темп и сохранять готовую композицию в MIDI-файл.

## Подробней

Этот модуль предназначен для интеграции с библиотекой Magenta от Google для генерации музыки с использованием моделей машинного обучения. Он предоставляет удобный интерфейс для создания музыкальных композиций, позволяя настраивать различные параметры, такие как модель, темп, температура и количество шагов.

## Классы

### `MagentaMusic`

**Описание**: Класс для генерации музыки с использованием моделей Magenta.

**Принцип работы**:
Класс `MagentaMusic` инициализируется с заданными параметрами, такими как директория вывода, имя модели, температура, количество шагов, MIDI-файл затравки и темп. Он загружает MIDI-файл затравки или создает пустую NoteSequence, если файл не найден. Затем он генерирует мелодию, добавляет аккорды и барабаны, устанавливает темп и сохраняет готовую композицию в MIDI-файл.

**Аттрибуты**:

- `output_dir` (str): Директория для сохранения сгенерированных MIDI-файлов. По умолчанию 'generated_music_advanced'.
- `model_name` (str): Имя модели Magenta для генерации музыки. По умолчанию 'attention_rnn'.
- `temperature` (float): Параметр температуры для генерации мелодии. Влияет на случайность генерации. По умолчанию 1.2.
- `num_steps` (int): Количество шагов для генерации мелодии. По умолчанию 256.
- `primer_midi_file` (str): Путь к MIDI-файлу, используемому в качестве затравки для генерации. По умолчанию 'primer.mid'.
- `tempo` (int): Темп композиции в ударах в минуту (BPM). По умолчанию 100.
- `melody_rnn`: Объект класса `MelodyRnnSequenceGenerator` для генерации мелодий.
- `primer_sequence`: Объект класса `NoteSequence`, представляющий затравку для генерации мелодии.

**Методы**:

- `__init__(self, output_dir='generated_music_advanced', model_name='attention_rnn', temperature=1.2, num_steps=256, primer_midi_file='primer.mid', tempo=100)`: Инициализирует класс `MagentaMusic` с заданными параметрами.
- `_load_primer_sequence(self)`: Загружает MIDI-файл затравки или создает пустую NoteSequence, если файл не найден.
- `generate_melody(self)`: Генерирует мелодию с заданными параметрами.
- `add_chords(self, melody_sequence)`: Добавляет аккорды к мелодии.
- `add_drums(self, melody_with_chords_sequence)`: Добавляет барабаны к мелодии.
- `set_tempo(self, music_sequence)`: Устанавливает темп.
- `save_midi(self, music_sequence, filename='full_music_advanced.mid')`: Сохраняет готовую композицию в MIDI-файл.
- `generate_full_music(self)`: Объединяет все шаги в один вызов для удобства.

## Функции

### `_load_primer_sequence`

```python
    def _load_primer_sequence(self):
        """Загружает MIDI-файл затравки или создает пустую NoteSequence, если файл не найден.

        Args:
            self: Объект класса.

        Returns:
            NoteSequence: Объект NoteSequence, представляющий затравку для генерации мелодии.
        """
        ...
```

**Назначение**: Загружает MIDI-файл затравки или создает пустую NoteSequence, если файл не найден.

**Параметры**:
- `self`: Объект класса.

**Возвращает**:
- `NoteSequence`: Объект NoteSequence, представляющий затравку для генерации мелодии.

**Как работает функция**:

1. Проверяет, существует ли файл, указанный в `self.primer_midi_file`.
2. Если файл существует, загружает его содержимое как NoteSequence, используя `mm.midi_file_to_sequence_proto`.
3. Если файл не существует, возвращает пустую NoteSequence.

```
Проверка наличия файла затравки
│
├───> Файл существует?
│     │
│     └───> Да: Загрузка NoteSequence из MIDI-файла
│     │       │
│     │       └───> Возврат NoteSequence
│     │
│     └───> Нет: Создание пустой NoteSequence
│           │
│           └───> Возврат пустой NoteSequence
│
Конец
```

### `generate_melody`

```python
    def generate_melody(self):
        """Генерирует мелодию с заданными параметрами.

        Args:
            self: Объект класса.

        Returns:
            NoteSequence: Объект NoteSequence, представляющий сгенерированную мелодию.
        """
        ...
```

**Назначение**: Генерирует мелодию с заданными параметрами.

**Параметры**:
- `self`: Объект класса.

**Возвращает**:
- `NoteSequence`: Объект NoteSequence, представляющий сгенерированную мелодию.

**Как работает функция**:

1. Вызывает метод `generate` объекта `self.melody_rnn` с параметрами `temperature`, `steps` и `primer_sequence`.
2. Возвращает сгенерированную мелодию в виде объекта `NoteSequence`.

```
Генерация мелодии
│
└───> Вызов метода generate melody_rnn
│     │
│     └───> Возврат NoteSequence
│
Конец
```

### `add_chords`

```python
    def add_chords(self, melody_sequence):
        """Добавляет аккорды к мелодии.

        Args:
            melody_sequence (NoteSequence): Объект NoteSequence, представляющий мелодию.

        Returns:
            NoteSequence: Объект NoteSequence, представляющий мелодию с добавленными аккордами.
        """
        ...
```

**Назначение**: Добавляет аккорды к мелодии.

**Параметры**:
- `melody_sequence` (NoteSequence): Объект NoteSequence, представляющий мелодию.

**Возвращает**:
- `NoteSequence`: Объект NoteSequence, представляющий мелодию с добавленными аккордами.

**Как работает функция**:

1. Создает список аккордов.
2. Создает объект `ChordSequence` из списка аккордов.
3. Объединяет мелодию и аккорды с помощью `mm.sequences_lib.concatenate_sequences`.
4. Возвращает объединенную последовательность.

```
Добавление аккордов к мелодии
│
└───> Создание списка аккордов
│     │
│     └───> Создание ChordSequence из списка аккордов
│     │
│     └───> Объединение мелодии и аккордов
│     │
│     └───> Возврат объединенной последовательности
│
Конец
```

### `add_drums`

```python
    def add_drums(self, melody_with_chords_sequence):
        """Добавляет барабаны к мелодии.

        Args:
            melody_with_chords_sequence (NoteSequence): Объект NoteSequence, представляющий мелодию с аккордами.

        Returns:
            NoteSequence: Объект NoteSequence, представляющий мелодию с аккордами и барабанами.
        """
        ...
```

**Назначение**: Добавляет барабаны к мелодии.

**Параметры**:
- `melody_with_chords_sequence` (NoteSequence): Объект NoteSequence, представляющий мелодию с аккордами.

**Возвращает**:
- `NoteSequence`: Объект NoteSequence, представляющий мелодию с аккордами и барабанами.

**Как работает функция**:

1. Создает объект `DrumTrack`, представляющий партию барабанов.
2. Объединяет мелодию с аккордами и партию барабанов с помощью `mm.sequences_lib.concatenate_sequences`.
3. Возвращает объединенную последовательность.

```
Добавление барабанов к мелодии
│
└───> Создание DrumTrack
│     │
│     └───> Объединение мелодии с аккордами и барабанами
│     │
│     └───> Возврат объединенной последовательности
│
Конец
```

### `set_tempo`

```python
    def set_tempo(self, music_sequence):
        """Устанавливает темп.

        Args:
            music_sequence (NoteSequence): Объект NoteSequence, представляющий музыкальную последовательность.

        Returns:
            NoteSequence: Объект NoteSequence с установленным темпом.
        """
        ...
```

**Назначение**: Устанавливает темп.

**Параметры**:
- `music_sequence` (NoteSequence): Объект NoteSequence, представляющий музыкальную последовательность.

**Возвращает**:
- `NoteSequence`: Объект NoteSequence с установленным темпом.

**Как работает функция**:

1. Устанавливает значение `qpm` (ударов в минуту) первого элемента в списке `music_sequence.tempos` равным `self.tempo`.
2. Возвращает музыкальную последовательность с установленным темпом.

```
Установка темпа
│
└───> Установка значения qpm
│     │
│     └───> Возврат музыкальной последовательности с установленным темпом
│
Конец
```

### `save_midi`

```python
    def save_midi(self, music_sequence, filename='full_music_advanced.mid'):
         """Сохраняет готовую композицию в MIDI-файл.

         Args:
             music_sequence (NoteSequence): Объект NoteSequence, представляющий музыкальную последовательность.
             filename (str): Имя файла для сохранения MIDI-файла. По умолчанию 'full_music_advanced.mid'.
         """
         ...
```

**Назначение**: Сохраняет готовую композицию в MIDI-файл.

**Параметры**:
- `music_sequence` (NoteSequence): Объект NoteSequence, представляющий музыкальную последовательность.
- `filename` (str): Имя файла для сохранения MIDI-файла. По умолчанию 'full_music_advanced.mid'.

**Как работает функция**:

1. Формирует полный путь к файлу, объединяя `self.output_dir` и `filename`.
2. Сохраняет музыкальную последовательность в MIDI-файл с помощью `mm.sequence_proto_to_midi_file`.

```
Сохранение в MIDI-файл
│
└───> Формирование полного пути к файлу
│     │
│     └───> Сохранение музыкальной последовательности в MIDI-файл
│
Конец
```

### `generate_full_music`

```python
    def generate_full_music(self):
        """Объединяет все шаги в один вызов для удобства.

        Args:
            self: Объект класса.
        """
        ...
```

**Назначение**: Объединяет все шаги в один вызов для удобства.

**Параметры**:
- `self`: Объект класса.

**Как работает функция**:

1. Генерирует мелодию с помощью `self.generate_melody()`.
2. Добавляет аккорды к мелодии с помощью `self.add_chords()`.
3. Добавляет барабаны к мелодии с аккордами с помощью `self.add_drums()`.
4. Устанавливает темп с помощью `self.set_tempo()`.
5. Сохраняет полную композицию в MIDI-файл с помощью `self.save_midi()`.

```
Генерация полной композиции
│
├───> Генерация мелодии
│   │
│   └───> Добавление аккордов
│       │
│       └───> Добавление барабанов
│           │
│           └───> Установка темпа
│               │
│               └───> Сохранение в MIDI-файл
│
Конец
```

**Примеры**:
- Создайте MIDI файлы primer.mid и primer2.mid, или оставьте их пустыми если не хотите использовать затравку.
- Запустите скрипт: python magenta_music_class.py.
- Сгенерированные композиции будут сохранены в папках my_music и my_music2.
```python
# Пример использования класса
music_generator = MagentaMusic(output_dir='my_music', model_name='attention_rnn',
                                temperature=1.1, num_steps=200, primer_midi_file='primer.mid', tempo=110)
music_generator.generate_full_music()

# Другой пример с другими параметрами
music_generator2 = MagentaMusic(output_dir='my_music2', model_name='basic_rnn',
                                temperature=0.9, num_steps=150, primer_midi_file='primer2.mid', tempo=120)
music_generator2.generate_full_music()