# Модуль для работы с Free2GPT

## Обзор

Модуль `Free2GPT` предоставляет асинхронный интерфейс для взаимодействия с сервисом Free2GPT для генерации текста. Он включает в себя функциональность для создания асинхронных генераторов, поддержки истории сообщений, а также обработки ошибок, таких как превышение лимита запросов.

## Подробнее

Этот модуль предназначен для интеграции с другими частями проекта `hypotez`, где требуется взаимодействие с моделями генерации текста через API Free2GPT. Он использует `aiohttp` для асинхронных HTTP-запросов и предоставляет удобные методы для отправки сообщений и получения результатов. Расположение файла в структуре проекта указывает на его роль как одного из провайдеров для GPT.

## Классы

### `Free2GPT`

**Описание**: Класс `Free2GPT` предоставляет асинхронный интерфейс для взаимодействия с сервисом Free2GPT. Он наследуется от `AsyncGeneratorProvider` и `ProviderModelMixin`.

**Принцип работы**:
Класс использует асинхронный генератор для обработки ответов от API Free2GPT. Он поддерживает указание модели, прокси и другие параметры запроса. В случае ошибки, такой как превышение лимита запросов, выбрасывается исключение `RateLimitError`.

**Методы**:

- `create_async_generator`: Создает асинхронный генератор для взаимодействия с API Free2GPT.

#### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    connector: BaseConnector = None,
    **kwargs,
) -> AsyncResult:
    """
    Создает асинхронный генератор для взаимодействия с API Free2GPT.

    Args:
        model (str): Название используемой модели.
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
        connector (BaseConnector, optional): Асинхронный коннектор. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий чанки текста.

    Raises:
        RateLimitError: Если достигнут лимит запросов.
        Exception: При других ошибках HTTP-запроса.

    Как работает функция:
    1. Функция принимает параметры модели, сообщения, прокси и коннектор.
    2. Формируются заголовки запроса, включая User-Agent, Accept и Content-Type.
    3. Создается асинхронная сессия с использованием `ClientSession` и переданного коннектора (или создается новый).
    4. Генерируется timestamp и подпись сообщения с использованием функции `generate_signature`.
    5. Формируется тело запроса в формате JSON, содержащее сообщения, timestamp и подпись.
    6. Отправляется POST-запрос к API Free2GPT (`/api/generate`).
    7. Обрабатывается ответ:
        - Если статус код 500 и в тексте ответа содержится "Quota exceeded", выбрасывается исключение `RateLimitError`.
        - В противном случае, проверяется статус код ответа и выбрасывается исключение, если статус код не указывает на успешное выполнение запроса.
        - Асинхронно перебираются чанки данных из ответа и декодируются в текст, который выдается через генератор.

    Внутри функции происходят следующие действия и преобразования:
    A. Подготовка запроса: Формирование заголовков и тела запроса.
    |
    -- B. Отправка запроса: Отправка POST-запроса к API Free2GPT.
    |
    C. Обработка ответа: Проверка статус кода и извлечение данных из ответа.
    |
    D. Генерация чанков текста: Декодирование и выдача чанков текста через асинхронный генератор.
    """
    ...
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from aiohttp import TCPConnector

async def main():
    model = "gemini-1.5-pro"
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    proxy = None
    connector = TCPConnector(limit=300)

    generator = await Free2GPT.create_async_generator(
        model=model, messages=messages, proxy=proxy, connector=connector
    )

    async for chunk in generator:
        print(chunk, end="")

    await connector.close()

if __name__ == "__main__":
    asyncio.run(main())
```

## Функции

### `generate_signature`

```python
def generate_signature(time: int, text: str, secret: str = ""):
    """
    Генерирует подпись для запроса к API Free2GPT.

    Args:
        time (int): Timestamp запроса.
        text (str): Текст сообщения.
        secret (str, optional): Секретный ключ. По умолчанию "".

    Returns:
        str: Сгенерированная подпись в виде шестнадцатеричной строки.

    Как работает функция:
    1. Функция принимает timestamp, текст сообщения и секретный ключ (по умолчанию пустой).
    2. Формируется строка сообщения путем конкатенации timestamp, текста и секретного ключа через двоеточие.
    3. Строка сообщения кодируется в байты.
    4. Вычисляется SHA256 хеш от байтовой строки.
    5. Хеш преобразуется в шестнадцатеричную строку и возвращается.

    Внутри функции происходят следующие действия и преобразования:
    A. Формирование строки сообщения: Конкатенация timestamp, текста и секретного ключа.
    |
    B. Кодирование строки в байты: Преобразование строки в байтовую последовательность.
    |
    C. Вычисление SHA256 хеша: Вычисление хеша от байтовой строки.
    |
    D. Преобразование хеша в шестнадцатеричную строку: Форматирование хеша в виде шестнадцатеричной строки.

    Примеры:
        >>> generate_signature(1678886400, "Hello", "secret")
        '6465696434613530386132326339313063663934363233393664343937353135'
    """
    ...
```

**Примеры**:

```python
# Пример использования generate_signature
signature = generate_signature(int(time.time() * 1e3), "Hello, world!", "secret")
print(signature)