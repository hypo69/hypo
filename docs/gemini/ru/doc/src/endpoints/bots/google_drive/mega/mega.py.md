# Модуль для работы с сервисом Mega.nz
=======================================

Модуль содержит класс `Mega`, который предоставляет интерфейс для взаимодействия с сервисом Mega.nz, включая аутентификацию, скачивание и загрузку файлов.

## Обзор

Этот модуль позволяет автоматизировать взаимодействие с сервисом Mega.nz. Он предоставляет классы и функции для аутентификации, скачивания файлов по URL, загрузки файлов на сервер Mega.

## Подробнее

Модуль предоставляет класс `Mega`, который инкапсулирует всю логику взаимодействия с API Mega.nz.  
Он включает методы для входа в систему с использованием учетных данных или временного ключа, скачивания файлов (как публичных, так и приватных) и загрузки файлов на сервер.  
Этот модуль использует библиотеки `requests`, `urlobject`, `Crypto` для выполнения HTTP-запросов и криптографических операций.

## Классы

### `Mega`

**Описание**: Класс для взаимодействия с API Mega.

**Принцип работы**:
Класс `Mega` предоставляет методы для аутентификации, скачивания и загрузки файлов. При инициализации класса генерируется случайный идентификатор последовательности запросов (`seqno`). Класс также может быть создан с использованием учетных данных (`from_credentials`) или временного ключа (`from_ephemeral`).

**Атрибуты**:
- `seqno` (int): Идентификатор последовательности запросов.
- `sid` (str): Идентификатор сессии.
- `master_key` (List[int]): Мастер-ключ для шифрования и дешифрования данных.
- `rsa_priv_key` (List[int]): Приватный RSA-ключ для расшифровки идентификатора сессии (sid).
- `root_id` (str): Идентификатор корневой папки ("Cloud Drive").
- `inbox_id` (str): Идентификатор папки "Inbox".
- `trashbin_id` (str): Идентификатор корзины.

**Методы**:
- `__init__`: Инициализирует экземпляр класса `Mega`.
- `from_credentials`: Создает экземпляр класса `Mega` с использованием email и пароля.
- `from_ephemeral`: Создает экземпляр класса `Mega` с использованием временного ключа.
- `api_req`: Отправляет API-запрос к серверу Mega.
- `login_user`: Аутентифицирует пользователя с использованием email и пароля.
- `login_ephemeral`: Аутентифицирует пользователя с использованием временного ключа.
- `_login_common`: Общая логика для входа в систему.
- `get_files`: Получает список файлов и папок в аккаунте.
- `download_from_url`: Скачивает файл по публичной ссылке.
- `download_file`: Скачивает файл по его идентификатору и ключу.
- `get_public_url`: Получает публичную ссылку на файл.
- `uploadfile`: Загружает файл на сервер.

## Функции

### `__init__`

```python
def __init__(self):
    """
    Инициализирует экземпляр класса Mega.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        None

    """
```

**Назначение**:
Инициализирует экземпляр класса `Mega`. Устанавливает случайный идентификатор последовательности запросов (`seqno`) и инициализирует идентификатор сессии (`sid`) в `None`.

**Как работает функция**:
1. Инициализирует атрибут `seqno` случайным целым числом в диапазоне от 0 до 0xFFFFFFFF. Это необходимо для отслеживания последовательности API-запросов.
2. Устанавливает атрибут `sid` в `None`. Этот атрибут будет содержать идентификатор сессии после успешной аутентификации.

**Примеры**:

```python
mega = Mega()
print(mega.seqno)
print(mega.sid)
```

### `from_credentials`

```python
@classmethod
def from_credentials(cls, email, password):
    """
    Создает экземпляр класса Mega, выполняя вход в систему с использованием email и пароля.

    Args:
        cls (Mega): Класс Mega.
        email (str): Email пользователя.
        password (str): Пароль пользователя.

    Returns:
        Mega: Экземпляр класса Mega.
    """
```

**Назначение**:
Создает экземпляр класса `Mega` и выполняет вход в систему с использованием предоставленных email и пароля.

**Параметры**:
- `cls` (Mega): Класс `Mega`.
- `email` (str): Email пользователя.
- `password` (str): Пароль пользователя.

**Возвращает**:
- `Mega`: Экземпляр класса `Mega`, уже аутентифицированный.

**Как работает функция**:
1. Создает новый экземпляр класса `Mega`.
2. Вызывает метод `login_user` для аутентификации пользователя с использованием предоставленных email и пароля.
3. Возвращает созданный экземпляр класса `Mega`.

**Примеры**:

```python
mega = Mega.from_credentials('user@example.com', 'password')
print(mega.sid)
```

### `from_ephemeral`

```python
    @classmethod
    def from_ephemeral(cls):
        """
        Создает экземпляр класса Mega, выполняя вход в систему с использованием временного ключа.

        Args:
            cls (Mega): Класс Mega.

        Returns:
            Mega: Экземпляр класса Mega.
        """
```

**Назначение**:
Создает экземпляр класса `Mega` и выполняет вход в систему с использованием временного ключа.

**Параметры**:
- `cls` (Mega): Класс `Mega`.

**Возвращает**:
- `Mega`: Экземпляр класса `Mega`, уже аутентифицированный с использованием временного ключа.

**Как работает функция**:
1. Создает новый экземпляр класса `Mega`.
2. Вызывает метод `login_ephemeral` для аутентификации пользователя с использованием временного ключа.
3. Возвращает созданный экземпляр класса `Mega`.

**Примеры**:

```python
mega = Mega.from_ephemeral()
print(mega.sid)
```

### `api_req`

```python
def api_req(self, data):
    """
    Отправляет API-запрос к серверу Mega.

    Args:
        self (Mega): Экземпляр класса Mega.
        data (dict): Данные для отправки в запросе.

    Returns:
        dict: Ответ от сервера Mega в формате JSON.

    Raises:
        MegaRequestException: Если сервер возвращает код ошибки.
    """
```

**Назначение**:
Отправляет API-запрос к серверу Mega.

**Параметры**:
- `self` (Mega): Экземпляр класса `Mega`.
- `data` (dict): Данные для отправки в запросе.

**Возвращает**:
- `dict`: Ответ от сервера Mega в формате JSON.

**Вызывает исключения**:
- `MegaRequestException`: Если сервер возвращает код ошибки.

**Как работает функция**:

1.  Подготавливает параметры запроса, включая идентификатор запроса (`id`) и идентификатор сессии (`sid`, если существует).
2.  Преобразует данные запроса в JSON-формат.
3.  Отправляет POST-запрос к API Mega.
4.  Обрабатывает ответ от сервера:
    *   Если ответ является целым числом, вызывает исключение `MegaRequestException`.
    *   В противном случае возвращает первый элемент JSON-ответа.

**Примеры**:

```python
mega = Mega()
response = mega.api_req({'a': 'g', 'g': 1, 'p': 'file_id'})
print(response)
```

### `login_user`

```python
def login_user(self, email, password):
    """
    Аутентифицирует пользователя с использованием email и пароля.

    Args:
        self (Mega): Экземпляр класса Mega.
        email (str): Email пользователя.
        password (str): Пароль пользователя.

    Returns:
        None

    Raises:
        MegaRequestException: Если запрос к API завершается с ошибкой.
    """
```

**Назначение**:
Аутентифицирует пользователя в Mega с использованием email и пароля.

**Параметры**:
- `self` (Mega): Экземпляр класса Mega.
- `email` (str): Email пользователя.
- `password` (str): Пароль пользователя.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `MegaRequestException`: Если запрос к API завершается с ошибкой.

**Как работает функция**:
1.  Подготавливает ключ шифрования пароля с использованием функции `prepare_key`.
2.  Вычисляет хеш email и пароля с использованием функции `stringhash`.
3.  Отправляет API-запрос для аутентификации пользователя.
4.  Вызывает метод `_login_common` для обработки общего процесса входа в систему.

**Примеры**:

```python
mega = Mega()
mega.login_user('user@example.com', 'password')
print(mega.sid)
```

### `login_ephemeral`

```python
def login_ephemeral(self):
    """
    Аутентифицирует пользователя с использованием временного ключа.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        None

    Raises:
        MegaRequestException: Если запрос к API завершается с ошибкой.
    """
```

**Назначение**:
Аутентифицирует пользователя в Mega с использованием временного ключа.

**Параметры**:
- `self` (Mega): Экземпляр класса Mega.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `MegaRequestException`: Если запрос к API завершается с ошибкой.

**Как работает функция**:
1.  Генерирует случайные ключи для мастера, пароля и self-challenge.
2.  Отправляет API-запрос для получения user handle.
3.  Отправляет API-запрос для аутентификации пользователя с использованием полученного user handle.
4.  Вызывает метод `_login_common` для обработки общего процесса входа в систему.

**Примеры**:

```python
mega = Mega()
mega.login_ephemeral()
print(mega.sid)
```

### `_login_common`

```python
def _login_common(self, res, password):
    """
    Общая логика для входа в систему.

    Args:
        self (Mega): Экземпляр класса Mega.
        res (dict): Ответ от API с данными для входа.
        password (List[int]): Ключ шифрования пароля.

    Returns:
        None

    Raises:
        MegaIncorrectPasswordExcetion: Если введен неверный email и/или пароль.
    """
```

**Назначение**:
Содержит общую логику для завершения процесса аутентификации, используемую как при обычном входе, так и при использовании временного ключа.

**Параметры**:
- `self` (Mega): Экземпляр класса Mega.
- `res` (dict): Ответ от API с данными для входа.
- `password` (List[int]): Ключ шифрования пароля.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `MegaIncorrectPasswordExcetion`: Если введен неверный email и/или пароль.

**Как работает функция**:
1.  Проверяет, не является ли ответ ошибкой (-2 или -9), что указывает на неверный email и/или пароль.
2.  Дешифрует мастер-ключ с использованием предоставленного ключа шифрования пароля.
3.  Пытается получить идентификатор сессии (`sid`) из ответа API.
    *   Если присутствует `tsid`, использует его для получения `sid`.
    *   Если присутствует `csid`, использует RSA-ключи для расшифровки `sid`.

**Примеры**:

```python
# Этот метод вызывается внутри login_user и login_ephemeral и не предназначен для прямого вызова.
```

### `get_files`

```python
def get_files(self):
    """
    Получает список файлов и папок в аккаунте.

    Args:
        self (Mega): Экземпляр класса Mega.

    Returns:
        dict: Данные о файлах и папках в аккаунте.
    """
```

**Назначение**:
Получает список файлов и папок в аккаунте Mega.

**Параметры**:
- `self` (Mega): Экземпляр класса Mega.

**Возвращает**:
- `dict`: Данные о файлах и папках в аккаунте.

**Как работает функция**:
1. Отправляет API-запрос для получения списка файлов и папок.
2.  Обрабатывает каждый файл/папку в полученных данных:
    *   Дешифрует ключ файла/папки.
    *   Декодирует атрибуты файла/папки.
3.  Сохраняет идентификаторы корневой папки, папки "Входящие" и корзины.
4.  Возвращает обработанные данные о файлах и папках.

**Примеры**:

```python
mega = Mega.from_credentials('user@example.com', 'password')
files = mega.get_files()
print(files)
```

### `download_from_url`

```python
def download_from_url(self, url):
    """
    Скачивает файл по публичной ссылке.

    Args:
        self (Mega): Экземпляр класса Mega.
        url (str): Публичная ссылка на файл.

    Returns:
        str: Имя скачанного файла.
    """
```

**Назначение**:
Скачивает файл из Mega по предоставленной публичной ссылке.

**Параметры**:
- `self` (Mega): Экземпляр класса Mega.
- `url` (str): Публичная ссылка на файл Mega.

**Возвращает**:
- `str`: Имя скачанного файла.

**Как работает функция**:
1.  Извлекает идентификатор файла и ключ файла из URL.
2.  Вызывает метод `download_file` для скачивания файла.
3.  Возвращает имя скачанного файла.

**Примеры**:

```python
mega = Mega()
file_name = mega.download_from_url('https://mega.nz/#!file_id!file_key')
print(file_name)
```

### `download_file`

```python
def download_file(self, file_id, file_key, public=False, store_path=None):
    """
    Скачивает файл по его идентификатору и ключу.

    Args:
        self (Mega): Экземпляр класса Mega.
        file_id (str): Идентификатор файла.
        file_key (str): Ключ файла.
        public (bool): Является ли файл публичным.
        store_path (str): Путь для сохранения файла.

    Returns:
        str: Имя скачанного файла.
    """
```

**Назначение**:
Скачивает файл из Mega по его идентификатору и ключу.

**Параметры**:
- `self` (Mega): Экземпляр класса Mega.
- `file_id` (str): Идентификатор файла.
- `file_key` (str): Ключ файла.
- `public` (bool, optional): Указывает, является ли файл публичным. По умолчанию `False`.
- `store_path` (str, optional): Путь для сохранения файла. По умолчанию `None`.

**Возвращает**:
- `str`: Имя скачанного файла.

**Как работает функция**:
1.  Отправляет API-запрос для получения данных о файле.
2.  Декодирует ключ файла.
3.  Получает URL файла, его размер и атрибуты.
4.  Открывает файл для записи.
5.  Дешифрует содержимое файла по частям и записывает его в файл.
6.  Выполняет проверку целостности файла.
7.  Возвращает имя скачанного файла.

**Примеры**:

```python
mega = Mega.from_credentials('user@example.com', 'password')
file_name = mega.download_file('file_id', 'file_key')
print(file_name)
```

### `get_public_url`

```python
def get_public_url(self, file_id, file_key):
    """
    Получает публичную ссылку на файл.

    Args:
        self (Mega): Экземпляр класса Mega.
        file_id (str): Идентификатор файла.
        file_key (str): Ключ файла.

    Returns:
        str: Публичная ссылка на файл.
    """
```

**Назначение**:
Создает публичную ссылку для скачивания файла.

**Параметры**:
- `self` (Mega): Экземпляр класса Mega.
- `file_id` (str): Идентификатор файла.
- `file_key` (str): Ключ файла.

**Возвращает**:
- `str`: Публичная ссылка для скачивания файла.

**Как работает функция**:
1.  Отправляет API-запрос для получения public handle файла.
2.  Преобразует ключ файла в base64.
3.  Формирует и возвращает публичную ссылку.

**Примеры**:

```python
mega = Mega.from_credentials('user@example.com', 'password')
public_url = mega.get_public_url('file_id', 'file_key')
print(public_url)
```

### `uploadfile`

```python
def uploadfile(self, filename, dst=None):
    """
    Загружает файл на сервер.

    Args:
        self (Mega): Экземпляр класса Mega.
        filename (str): Имя файла для загрузки.
        dst (str): Идентификатор папки назначения.

    Returns:
        dict: Данные о загруженном файле.
    """
```

**Назначение**:
Загружает указанный файл на сервер Mega.

**Параметры**:
- `self` (Mega): Экземпляр класса Mega.
- `filename` (str): Путь к файлу, который нужно загрузить.
- `dst` (str, optional): Идентификатор папки назначения. Если не указан, файл будет загружен в корневую папку. По умолчанию `None`.

**Возвращает**:
- `dict`: Данные о загруженном файле.

**Как работает функция**:
1.  Определяет папку назначения (если не указана, использует корневую папку).
2.  Открывает файл для чтения.
3.  Получает URL для загрузки файла.
4.  Генерирует случайные ключи для шифрования файла.
5.  Шифрует файл по частям и отправляет его на сервер.
6.  Вычисляет мета-MAC.
7.  Формирует данные о файле и отправляет API-запрос для завершения загрузки.
8.  Возвращает данные о загруженном файле.

**Примеры**:

```python
mega = Mega.from_credentials('user@example.com', 'password')
data = mega.uploadfile('example.txt')
print(data)