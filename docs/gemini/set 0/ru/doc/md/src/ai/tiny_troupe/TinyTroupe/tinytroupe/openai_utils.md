# Модуль openai_utils

## Обзор

Этот модуль предоставляет инструменты для взаимодействия с API OpenAI, включая настройку, кеширование запросов, обработку различных типов моделей (OpenAI и Azure) и обработку исключений.

## Параметры по умолчанию

### `default`

**Описание**: Словарь, содержащий значения параметров по умолчанию для вызовов модели. Эти значения взяты из файла конфигурации `config.ini` или установлены по умолчанию, если соответствующий параметр отсутствует в файле.

**Ключи и значения**:
- `model`: Идентификатор модели OpenAI по умолчанию (например, `gpt-4`).
- `max_tokens`: Максимальное количество токенов в ответе по умолчанию (целое число).
- `temperature`: Температура по умолчанию для генерации текста (вещественное число).
- `top_p`: Точность по умолчанию для генерации текста (целое число).
- `frequency_penalty`: Штраф за частоту повторения слов по умолчанию (вещественное число).
- `presence_penalty`: Штраф за присутствие слов по умолчанию (вещественное число).
- `timeout`: Максимальное время ожидания ответа API (вещественное число в секундах).
- `max_attempts`: Максимальное количество попыток получения ответа (вещественное число).
- `waiting_time`: Время ожидания между попытками запроса API (вещественное число в секундах).
- `exponential_backoff_factor`: Коэффициент экспоненциального увеличения времени ожидания между попытками запроса API (вещественное число).
- `embedding_model`: Модель по умолчанию для вычисления встраиваний текста.
- `cache_api_calls`: Флаг кеширования вызовов API (булево значение).
- `cache_file_name`: Имя файла кеша API-вызовов.

## Классы

### `LLMCall`

**Описание**: Класс для представления вызова модели LLM. Содержит входные сообщения, конфигурацию модели и выходные данные модели.

**Методы**:

- `__init__(system_template_name: str, user_template_name: str = None, **model_params)`: Инициализирует экземпляр `LLMCall` с указанными шаблонами системы и пользователя.
    - `system_template_name` (str): Шаблон для системного сообщения.
    - `user_template_name` (str, optional): Шаблон для пользовательского сообщения. По умолчанию `None`.
    - `**model_params`: Параметры модели.
- `call(**rendering_configs)`: Вызывает модель LLM с указанными параметрами рендеринга.
    - `**rendering_configs`: Параметры рендеринга.
- `__repr__()`: Возвращает строковое представление объекта.

### `OpenAIClient`

**Описание**: Класс для взаимодействия с API OpenAI.

**Методы**:

- `__init__(cache_api_calls=default["cache_api_calls"], cache_file_name=default["cache_file_name"])`: Инициализирует экземпляр `OpenAIClient` и настраивает кеширование API.
- `set_api_cache(cache_api_calls, cache_file_name=default["cache_file_name"])`: Включает или отключает кеширование API вызовов.
- `_setup_from_config()`: Настраивает параметры OpenAI API для данного клиента.
- `send_message(...)`: Отправляет сообщение в API OpenAI и возвращает ответ.  (Подробное описание параметров см. в исходном коде).
- `_raw_model_call(...)`:  Вызывает API OpenAI с указанными параметрами. (Подробное описание см. в исходном коде).
- `_raw_model_response_extractor(...)`: Извлекает ответ из ответа API. (Подробное описание см. в исходном коде).
- `_count_tokens(...)`: Считает количество токенов OpenAI в списке сообщений.
- `_save_cache()`: Сохраняет кеш API-вызовов на диск.
- `_load_cache()`: Загружает кеш API-вызовов из файла.
- `get_embedding(...)`: Получает встраивание текста с использованием модели OpenAI.
- `_raw_embedding_model_call(...)`: Вызывает API для вычисления встраиваний текста.
- `_raw_embedding_model_response_extractor(...)`: Извлекает встраивания из ответа API.

### `AzureClient`

**Описание**: Класс для взаимодействия с Azure OpenAI Service API. Наследуется от `OpenAIClient`.

**Методы**:
- `__init__(cache_api_calls=default["cache_api_calls"], cache_file_name=default["cache_file_name"])`: Инициализирует экземпляр `AzureClient`.
- `_setup_from_config()`: Настраивает параметры Azure OpenAI Service API для данного клиента.
- `_raw_model_call(...)`: Вызывает API Azure OpenAI Service с указанными параметрами. (Подробное описание см. в исходном коде).


## Функции

### `register_client(api_type, client)`

**Описание**: Регистрирует клиента для указанного типа API.

**Параметры**:
- `api_type` (str): Тип API (например, `"openai"` или `"azure"`).
- `client`: Объект класса клиента (например, `OpenAIClient` или `AzureClient`).

### `_get_client_for_api_type(api_type)`

**Описание**: Возвращает клиента для данного типа API.

**Параметры**:
- `api_type` (str): Тип API.

### `client()`

**Описание**: Возвращает клиент для сконфигурированного типа API.

### `force_api_type(api_type)`

**Описание**: Принудительно устанавливает тип API.

**Параметры**:
- `api_type` (str): Тип API.

### `force_api_cache(cache_api_calls, cache_file_name=default["cache_file_name"])`

**Описание**: Принудительно устанавливает конфигурацию кеширования API.

**Параметры**:
- `cache_api_calls` (bool): Включить или выключить кеширование.
- `cache_file_name` (str, optional): Имя файла кеша.

### `force_default_value(key, value)`

**Описание**: Принудительно устанавливает значение параметра по умолчанию.

**Параметры**:
- `key` (str): Ключ параметра.
- `value`: Новое значение параметра.


## Исключения

### `InvalidRequestError`

**Описание**: Исключение, которое выбрасывается, если запрос в API OpenAI недействителен.

### `NonTerminalError`

**Описание**: Исключение, которое выбрасывается, если возникает ошибка, для которой можно повторить попытку запроса.


##  Поддержка


Этот модуль поддерживает как OpenAI, так и Azure OpenAI Service API.  Конфигурация API осуществляется через файл `config.ini`.  В этом модуле есть механизмы для переключения между этими API с помощью функций `register_client` и `client()`.  Также поддерживается кеширование API вызовов для повышения производительности.