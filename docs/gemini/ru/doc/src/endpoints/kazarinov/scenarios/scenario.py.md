# Модуль `scenario.py`

## Обзор

Модуль `scenario.py` предназначен для реализации сценариев сбора информации о товарах с различных веб-сайтов, их обработки с использованием AI и генерации отчетов. Модуль содержит классы и функции для парсинга данных с сайтов, взаимодействия с AI-моделями (например, Google Gemini), создания отчетов в формате JSON и передачи информации через Telegram-бота.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для автоматизации процесса сбора, обработки и представления информации о товарах. Он включает в себя следующие этапы:
1.  Сбор данных о товарах с использованием граберов для различных поставщиков.
2.  Обработка собранных данных с использованием AI-моделей для перевода и анализа.
3.  Генерация отчетов на основе обработанных данных.
4.  Отправка отчетов и уведомлений через Telegram-бот.

## Функции

### `fetch_target_urls_onetab`

```python
def fetch_target_urls_onetab(one_tab_url: str) -> tuple[str, str, list[str]] | bool:
    """
    Функция паресит целевые URL из полученного OneTab.
    """
    ...
```

**Назначение**: Извлекает целевые URL, цену и имя из OneTab URL.

**Как работает функция**:

1.  Отправляет GET-запрос по указанному `one_tab_url` для получения содержимого страницы OneTab.
2.  Использует `BeautifulSoup` для парсинга HTML-содержимого ответа.
3.  Извлекает все ссылки с классом `tabLink` и сохраняет их в список `urls`.
4.  Извлекает текст из элемента `div` с классом `tabGroupLabel`, разделяет его на цену и имя.
5.  В случае успеха возвращает цену, имя и список URL. В случае ошибки логирует ошибку и возвращает `False, False, False`.

**Параметры**:

*   `one_tab_url` (str): URL OneTab, из которого необходимо извлечь данные.

**Возвращает**:

*   `tuple[str, str, list[str]] | bool`: Кортеж, содержащий цену (str), имя (str) и список URL (list[str]), или `False`, если произошла ошибка.

**Вызывает исключения**:

*   `requests.exceptions.RequestException`: Возникает при ошибках, связанных с HTTP-запросами (например, при недоступности URL).

## Классы

### `Scenario`

```python
class Scenario(QuotationBuilder):
    """Исполнитель сценария для Казаринова"""
    ...
```

**Описание**: Класс `Scenario` является исполнителем сценария для сбора и обработки информации о товарах. Он наследуется от класса `QuotationBuilder` и предназначен для автоматизации процесса парсинга данных, обработки их с помощью AI и генерации отчетов.

**Как работает класс**:

1.  Инициализируется с именем, драйвером веб-браузера и дополнительными параметрами.
2.  Определяет основные этапы сценария: сбор данных о товарах, обработка с использованием AI и генерация отчетов.
3.  Использует граберы для извлечения данных с различных веб-сайтов.
4.  Применяет AI-модели для перевода и анализа данных.
5.  Создает отчеты на основе обработанных данных и отправляет их через Telegram-бота.

**Методы**:

*   `__init__(self, mexiron_name:Optional[str] = gs.now, driver:Optional[Firefox | Playwrid | str] = None, **kwards)`: Конструктор класса.
*   `run_scenario_async(self, urls: List[str], price: Optional[str] = '', mexiron_name: Optional[str] = gs.now, bot: Optional[telebot.TeleBot] = None, chat_id: Optional[int] = 0, attempts: int = 3) -> bool`: Асинхронно выполняет сценарий: парсит продукты, обрабатывает их с помощью AI и сохраняет данные.

### `Scenario.__init__`

```python
def __init__(self, mexiron_name:Optional[str] = gs.now, driver:Optional[Firefox | Playwrid | str] = None, **kwards):
    """Сценарий сбора информации."""
    ...
```

**Назначение**: Инициализирует экземпляр класса `Scenario`.

**Как работает метод**:

1.  Устанавливает режим окна браузера в `normal`.
2.  Инициализирует драйвер веб-браузера (`Firefox`, `Playwrid` или пользовательский драйвер) для управления браузером.
3.  Вызывает конструктор родительского класса `QuotationBuilder` для инициализации общих параметров.

**Параметры**:

*   `mexiron_name` (Optional[str]): Имя для сценария. По умолчанию использует текущее время.
*   `driver` (Optional[Firefox | Playwrid | str]): Драйвер веб-браузера для управления браузером. По умолчанию создает экземпляр `Firefox`.
*   `kwards` (dict): Дополнительные параметры конфигурации.

### `Scenario.run_scenario_async`

```python
async def run_scenario_async(
        self,
        urls: List[str],  
        price: Optional[str] = '',
        mexiron_name: Optional[str] = gs.now, 
        bot: Optional[telebot.TeleBot] = None,
        chat_id: Optional[int] = 0,
        attempts: int = 3,
    ) -> bool:
    """
    Executes the scenario: parses products, processes them via AI, and stores data.
    """
    ...
```

**Назначение**: Асинхронно выполняет сценарий: парсит продукты, обрабатывает их с помощью AI и сохраняет данные.

**Как работает метод**:

1.  Инициализирует пустой список `products_list` для хранения данных о товарах.
2.  Перебирает список URL, полученных из OneTab.
3.  Для каждого URL определяет грабер, соответствующий поставщику.
4.  Использует грабер для извлечения полей товара.
5.  Преобразует полученные поля товара.
6.  Сохраняет данные о товаре.
7.  После сбора данных о всех товарах запускает процесс AI-обработки для перевода и анализа данных на нескольких языках.
8.  Генерирует отчеты на каждом языке и сохраняет их в формате JSON.
9.  Отправляет отчеты через Telegram-бота, если он предоставлен.

**Параметры**:

*   `urls` (List[str]): Список URL для парсинга.
*   `price` (Optional[str]): Цена, связанная с URL. По умолчанию ''.
*   `mexiron_name` (Optional[str]): Имя для сценария. По умолчанию использует текущее время.
*   `bot` (Optional[telebot.TeleBot]): Экземпляр Telegram-бота для отправки сообщений. По умолчанию `None`.
*   `chat_id` (Optional[int]): ID чата Telegram для отправки сообщений. По умолчанию 0.
*   `attempts` (int): Количество попыток выполнения сценария. По умолчанию 3.

**Возвращает**:

*   `bool`: `True`, если сценарий выполнен успешно.

**Вызывает исключения**:

*   `Exception`: Возникает при ошибках в процессе грабинга данных, AI-обработки или генерации отчетов.

## Функции

### `run_sample_scenario`

```python
def run_sample_scenario():
    """"""
    ...
```

**Назначение**: Запускает пример сценария для демонстрации работы класса `Scenario`.

**Как работает функция**:

1.  Определяет список URL для парсинга.
2.  Создает экземпляр класса `Scenario` с параметром `window_mode = 'headless'`.
3.  Запускает асинхронный сценарий с использованием `asyncio.run`.

## Примеры

### Пример запуска сценария

```python
if __name__ == '__main__':
    run_sample_scenario()
```

Этот код запускает пример сценария при запуске модуля.