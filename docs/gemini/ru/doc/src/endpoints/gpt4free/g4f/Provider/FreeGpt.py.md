# Модуль FreeGpt

## Обзор

Модуль `FreeGpt` предоставляет асинхронный интерфейс для взаимодействия с сервисом FreeGpt. Он включает в себя функциональность для генерации текста на основе предоставленных сообщений, используя модели `gemini-1.5-pro` и `gemini-1.5-flash`. Модуль поддерживает использование прокси и обработку ошибок, таких как достижение лимита запросов.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для обеспечения доступа к моделям FreeGpt. Он включает в себя класс `FreeGpt`, который реализует асинхронную генерацию текста на основе предоставленных сообщений. Модуль использует `StreamSession` для выполнения асинхронных HTTP-запросов и включает в себя функции для построения запросов и генерации подписей.

## Классы

### `FreeGpt`

**Описание**: Класс `FreeGpt` предоставляет асинхронный интерфейс для взаимодействия с сервисом FreeGpt.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных провайдеров генераторов.
- `ProviderModelMixin`: Предоставляет вспомогательные методы для работы с моделями провайдера.

**Атрибуты**:
- `url` (str): URL сервиса FreeGpt.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений.
- `supports_system_message` (bool): Флаг, указывающий на поддержку системных сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`gemini-1.5-pro`).
- `models` (List[str]): Список поддерживаемых моделей (`gemini-1.5-pro`, `gemini-1.5-flash`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения текстовых фрагментов от FreeGpt.
- `_build_request_data`: Статический метод для построения данных запроса.

#### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: Optional[str] = None,
        timeout: int = 120,
        **kwargs: Any
    ) -> AsyncGenerator[str, None]:
        """
        Создает асинхронный генератор для получения текстовых фрагментов от FreeGpt.

        Args:
            model (str): Имя используемой модели.
            messages (Messages): Список сообщений для отправки.
            proxy (Optional[str], optional): URL прокси-сервера. По умолчанию `None`.
            timeout (int, optional): Время ожидания запроса в секундах. По умолчанию `120`.
            **kwargs (Any): Дополнительные аргументы.

        Returns:
            AsyncGenerator[str, None]: Асинхронный генератор текстовых фрагментов.

        Raises:
            RateLimitError: Если достигнут лимит запросов.
        """
        ...
```

**Назначение**: Создает асинхронный генератор для получения текстовых фрагментов от FreeGpt.

**Параметры**:
- `model` (str): Имя используемой модели.
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (Optional[str], optional): URL прокси-сервера. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания запроса в секундах. По умолчанию `120`.
- `**kwargs` (Any): Дополнительные аргументы.

**Возвращает**:
- `AsyncGenerator[str, None]`: Асинхронный генератор текстовых фрагментов.

**Вызывает исключения**:
- `RateLimitError`: Если достигнут лимит запросов.

**Как работает функция**:

1.  **Подготовка данных**:
    - Извлекает последний элемент `messages` для получения `prompt` (запроса).
    - Получает текущую метку времени (`timestamp`).
    - Вызывает `_build_request_data` для формирования данных запроса, включая сообщения, временную метку и подпись.
2.  **Выбор домена**:
    - Выбирает случайный домен из списка `DOMAINS`.
3.  **Асинхронный HTTP-запрос**:
    - Использует `StreamSession` для выполнения асинхронного POST-запроса к сервису FreeGpt.
    - Если указан `proxy`, устанавливает его для сессии.
    - Устанавливает `timeout` для запроса.
    - Отправляет запрос к `f"{domain}/api/generate"` с данными в формате JSON.
4.  **Обработка ответа**:
    - Вызывает `raise_for_status` для проверки статуса ответа и возбуждения исключения в случае ошибки.
    - Итерируется по содержимому ответа (`response.iter_content()`) для получения фрагментов данных.
    - Декодирует каждый фрагмент (`chunk.decode(errors="ignore")`).
    - Проверяет, равен ли декодированный фрагмент сообщению об ошибке лимита запросов (`RATE_LIMIT_ERROR_MESSAGE`).
    - Если лимит достигнут, возбуждает исключение `RateLimitError`.
    - Возвращает декодированный фрагмент.

```
    Подготовка данных:
    Извлекает prompt и timestamp -> Формирует данные запроса

    Выбор домена:
    Выбирает случайный домен из DOMAINS

    Асинхронный HTTP-запрос:
    Использует StreamSession для POST-запроса -> Устанавливает proxy (если есть) -> Устанавливает timeout -> Отправляет запрос

    Обработка ответа:
    Проверяет статус ответа -> Итерируется по содержимому ответа -> Декодирует фрагмент -> Проверяет на лимит запросов -> Возвращает фрагмент
```

**Примеры**:

```python
    # Пример использования create_async_generator
    messages = [{"role": "user", "content": "Напиши стихотворение о весне."}]
    async def main():
        generator = FreeGpt.create_async_generator(model="gemini-1.5-pro", messages=messages)
        async for chunk in await generator:
            print(chunk, end="")

    # Пример использования с прокси
    messages = [{"role": "user", "content": "Напиши стихотворение о лете."}]
    async def main_with_proxy():
        generator = FreeGpt.create_async_generator(model="gemini-1.5-pro", messages=messages, proxy="http://proxy.example.com:8080")
        async for chunk in await generator:
            print(chunk, end="")
```

#### `_build_request_data`

```python
    @staticmethod
    def _build_request_data(messages: Messages, prompt: str, timestamp: int, secret: str = "") -> Dict[str, Any]:
        """
        Строит данные запроса для отправки в FreeGpt.

        Args:
            messages (Messages): Список сообщений.
            prompt (str): Последнее сообщение пользователя.
            timestamp (int): Временная метка.
            secret (str, optional): Секретный ключ. По умолчанию "".

        Returns:
            Dict[str, Any]: Словарь с данными запроса.
        """
        ...
```

**Назначение**: Строит данные запроса для отправки в FreeGpt.

**Параметры**:
- `messages` (Messages): Список сообщений.
- `prompt` (str): Последнее сообщение пользователя.
- `timestamp` (int): Временная метка.
- `secret` (str, optional): Секретный ключ. По умолчанию "".

**Возвращает**:
- `Dict[str, Any]`: Словарь с данными запроса.

**Как работает функция**:

1.  **Создание словаря данных**:
    - Формирует словарь, содержащий сообщения (`messages`), временную метку (`time`), значение `pass` установленное в `None`, и подпись (`sign`).
    - Подпись генерируется с помощью функции `generate_signature`, используя временную метку, запрос и секретный ключ.
    - Возвращает сформированный словарь.

```
    Создание словаря данных:
    Формирует словарь с messages, time, pass, sign -> Генерирует подпись через generate_signature -> Возвращает словарь
```

**Примеры**:

```python
    # Пример использования _build_request_data
    messages = [{"role": "user", "content": "Привет!"}]
    prompt = "Привет!"
    timestamp = int(time.time())
    data = FreeGpt._build_request_data(messages, prompt, timestamp)
    print(data)
```

## Функции

### `generate_signature`

```python
def generate_signature(timestamp: int, message: str, secret: str = "") -> str:
    """
    Генерирует подпись для запроса.

    Args:
        timestamp (int): Временная метка.
        message (str): Сообщение.
        secret (str, optional): Секретный ключ. По умолчанию "".

    Returns:
        str: Сгенерированная подпись.
    """
    ...
```

**Назначение**: Генерирует подпись для запроса.

**Параметры**:
- `timestamp` (int): Временная метка.
- `message` (str): Сообщение.
- `secret` (str, optional): Секретный ключ. По умолчанию "".

**Возвращает**:
- `str`: Сгенерированная подпись.

**Как работает функция**:

1.  **Формирование данных**:
    - Объединяет временную метку, сообщение и секретный ключ в строку, разделенную двоеточиями.
2.  **Вычисление хеша**:
    - Кодирует полученную строку в байты.
    - Вычисляет SHA-256 хеш закодированной строки.
    - Возвращает полученный хеш в шестнадцатеричном формате.

```
    Формирование данных:
    Объединяет timestamp, message и secret в строку

    Вычисление хеша:
    Кодирует строку в байты -> Вычисляет SHA-256 хеш -> Возвращает хеш в hex-формате
```

**Примеры**:

```python
    # Пример использования generate_signature
    timestamp = int(time.time())
    message = "Привет!"
    signature = generate_signature(timestamp, message)
    print(signature)