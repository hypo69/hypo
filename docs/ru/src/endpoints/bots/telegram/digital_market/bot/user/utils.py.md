# Модуль `utils` для обработки успешных платежей в Telegram-боте

## Обзор

Модуль `utils` содержит функции для обработки логики успешной оплаты в Telegram-боте цифрового рынка. Основная функция `successful_payment_logic` обрабатывает данные об оплате, добавляет информацию о покупке в базу данных, отправляет уведомления администраторам и предоставляет информацию о товаре пользователю.

## Подробней

Этот модуль играет важную роль в обработке платежей в Telegram-боте. Он обеспечивает сохранение информации о покупке, уведомление администраторов о новых покупках и предоставление пользователю информации о приобретенном товаре. Модуль использует асинхронные функции для эффективной работы с базой данных и Telegram API. Расположение модуля `hypotez/src/endpoints/bots/telegram/digital_market/bot/user/utils.py` указывает, что он является частью пользовательского интерфейса бота, отвечающего за обработку пользовательских покупок.

## Функции

### `successful_payment_logic`

```python
async def successful_payment_logic(session: AsyncSession, payment_data, currency, user_tg_id, bot: Bot):
    """Обрабатывает логику успешной оплаты, добавляет информацию о покупке в БД, отправляет уведомления и информацию пользователю.

    Args:
        session (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных.
        payment_data: Данные об оплате, полученные из платежной системы.
        currency: Валюта, в которой была произведена оплата.
        user_tg_id: Telegram ID пользователя, совершившего покупку.
        bot (Bot): Экземпляр бота aiogram для отправки сообщений.

    Raises:
        Exception: Если происходит ошибка при отправке уведомления администраторам.

    Как работает функция:
    1.  Извлекает данные о продукте и платеже из переданных аргументов.
    2.  Добавляет информацию о платеже в базу данных через `PurchaseDao.add`.
    3.  Ищет данные о продукте в базе данных по `product_id` через `ProductDao.find_one_or_none_by_id`.
    4.  Отправляет уведомления администраторам о новой покупке.
    5.  Формирует текст сообщения с информацией о товаре для пользователя.
    6.  Отправляет пользователю сообщение с информацией о товаре и, если есть, файл товара.
    7.  Если оплата была произведена звездами, инициирует возврат звезд пользователю.

    Внутри функции происходят следующие действия и преобразования:
    Извлечение данных о платеже и продукте из `payment_data` -> Добавление информации о платеже в базу данных -> Поиск данных о продукте в базе данных -> Отправка уведомлений администраторам -> Формирование текста сообщения для пользователя -> Отправка сообщения (и файла, если есть) пользователю -> Возврат звезд, если оплата была произведена звездами.
    """
```

**Параметры**:

-   `session` (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных.
-   `payment_data`: Данные об оплате, полученные из платежной системы.
-   `currency`: Валюта, в которой была произведена оплата.
-   `user_tg_id`: Telegram ID пользователя, совершившего покупку.
-   `bot` (Bot): Экземпляр бота aiogram для отправки сообщений.

**Возвращает**:

-   `None`: Функция ничего не возвращает явно.

**Вызывает исключения**:

-   `Exception`: Возникает, если происходит ошибка при отправке уведомления администраторам.

**Примеры**:

```python
# Пример вызова функции successful_payment_logic
# Предположим, что у вас есть необходимые объекты и данные
# await successful_payment_logic(session, payment_data, currency, user_tg_id, bot)