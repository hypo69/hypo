# Модуль для генерации отчетов в форматах HTML, PDF и DOCX

## Обзор

Модуль предоставляет класс `ReportGenerator`, который используется для генерации отчетов в различных форматах (HTML, PDF, DOCX) на основе данных из JSON. Он использует Jinja2 для создания HTML-шаблонов и pdfkit/html_to_docx для конвертации в PDF/DOCX.

## Подробней

Модуль предназначен для автоматического создания отчетов на основе данных, полученных из внешних источников. Он обеспечивает гибкость в настройке формата отчета и позволяет легко интегрировать его в существующие системы.
`ReportGenerator` используется для формирования отчетов, например, для мехиронов Казаринова.

## Классы

### `ReportGenerator`

**Описание**: Класс для генерации HTML- и PDF-отчётов на основе данных из JSON.

**Как работает класс**:
1.  **Инициализация**: Принимает флаги для определения необходимости генерации PDF и DOCX файлов.
2.  **Создание отчетов**: Метод `create_reports_async` является основным методом для генерации всех типов отчетов (HTML, PDF, DOCX).
3.  **Генерация HTML**: Метод `create_html_report_async` генерирует HTML-контент на основе шаблона Jinja2 и данных.
4.  **Генерация PDF**: Метод `create_pdf_report_async` преобразует HTML-контент в PDF-файл с использованием `pdfkit`.
5.  **Генерация DOCX**: Метод `create_docx_report_async` преобразует HTML-контент в DOCX-файл с использованием `html_to_docx`.

**Атрибуты**:

-   `if_need_html` (bool): Флаг, указывающий на необходимость генерации HTML-отчета.
-   `if_need_pdf` (bool): Флаг, указывающий на необходимость генерации PDF-отчета.
-   `if_need_docx` (bool): Флаг, указывающий на необходимость генерации DOCX-отчета.
-   `storage_path` (Path): Путь к директории для сохранения сгенерированных отчетов. По умолчанию `gs.path.external_storage / ENDPOINT`.
-   `html_path` (Path | str): Путь к HTML-файлу.
-   `pdf_path` (Path | str): Путь к PDF-файлу.
-   `docs_path` (Path | str): Путь к DOCX-файлу.
-   `html_content` (str): HTML-контент отчета.
-   `data` (dict): Данные для генерации отчета.
-   `lang` (str): Язык отчета.
-   `mexiron_name` (str): Имя мехирона.
-   `env` (Environment): Окружение Jinja2 для работы с шаблонами.

**Методы**:

#### `__init__`

```python
def __init__(self, 
             if_need_pdf:Optional[bool] = True, 
             if_need_docx:Optional[bool] = True, 
        ):
    """Определение, какие форматы данных требуется вернуть"""
```

**Назначение**: Инициализирует экземпляр класса `ReportGenerator`.

**Параметры**:

-   `if_need_pdf` (Optional[bool], optional): Флаг, указывающий на необходимость генерации PDF-отчета. По умолчанию `True`.
-   `if_need_docx` (Optional[bool], optional): Флаг, указывающий на необходимость генерации DOCX-отчета. По умолчанию `True`.

**Как работает метод**:

1.  Устанавливает значения атрибутов `if_need_pdf` и `if_need_docx` на основе переданных аргументов.

#### `create_reports_async`

```python
async def create_reports_async(self,
                         bot: telebot.TeleBot,
                         chat_id: int,
                         data:dict,
                         lang:str,
                         mexiron_name:str,
                         ) -> tuple:
    """Create ALL types: HTML, PDF, DOCX"""
```

**Назначение**: Создает отчеты во всех необходимых форматах (HTML, PDF, DOCX).

**Параметры**:

-   `bot` (telebot.TeleBot): Экземпляр бота Telebot для отправки уведомлений и файлов.
-   `chat_id` (int): ID чата для отправки уведомлений.
-   `data` (dict): Данные для генерации отчета.
-   `lang` (str): Язык отчета.
-   `mexiron_name` (str): Имя мехирона.

**Возвращает**:

-   `tuple`: Кортеж, содержащий результаты генерации отчетов.

**Как работает метод**:

1.  Устанавливает значения атрибутов `mexiron_name`, `html_path`, `pdf_path`, `docx_path`, `bot` и `chat_id`.
2.  Вызывает метод `create_html_report_async` для генерации HTML-контента.
3.  Если HTML-контент не был сгенерирован, возвращает `False`.
4.  Если флаг `if_need_pdf` установлен, вызывает метод `create_pdf_report_async` для генерации PDF-отчета.
5.  Если флаг `if_need_docx` установлен, вызывает метод `create_docx_report_async` для генерации DOCX-отчета.

#### `service_apendix`

```python
def service_apendix(self, lang:str) -> dict:
    """ """
```

**Назначение**: Возвращает словарь с данными для добавления сервисного приложения к отчету.

**Параметры**:

-   `lang` (str): Язык отчета.

**Возвращает**:

-   `dict`: Словарь с данными сервисного приложения.

**Как работает метод**:

1.  Определяет имя продукта в зависимости от языка (`ru` или `he`).
2.  Читает HTML-спецификацию сервиса из файла `service_as_product_{lang}.html`.
3.  Генерирует случайное изображение с помощью `random_image`.
4.  Возвращает словарь, содержащий `product_id`, `product_name`, `specification` и `image_local_saved_path`.

#### `create_html_report_async`

```python
async def create_html_report_async(self, data:dict, lang:str, html_path:Optional[ str|Path] ) -> str | None:
    """
    Генерирует HTML-контент на основе шаблона и данных.

    Args:
        lang (str): Язык отчёта.

    Returns:
        str: HTML-контент.
    """
```

**Назначение**: Генерирует HTML-контент на основе шаблона и данных.

**Параметры**:

-   `data` (dict): Данные для генерации отчета.
-   `lang` (str): Язык отчета.
-   `html_path` (Optional[str | Path], optional): Путь для сохранения HTML-файла. По умолчанию использует `self.html_path`.

**Возвращает**:

-   `str | None`: HTML-контент или `None` в случае ошибки.

**Как работает метод**:

1.  Устанавливает значение `self.html_path` на основе переданного аргумента `html_path`.
2.  Вызывает метод `service_apendix` для получения данных сервисного приложения.
3.  Добавляет сервисные данные в список продуктов в данных отчета.
4.  Определяет имя шаблона в зависимости от языка (`he` или `ru`).
5.  Формирует путь к шаблону.
6.  Читает содержимое шаблона из файла.
7.  Рендерит шаблон с использованием данных и сохраняет HTML-контент в `self.html_content`.
8.  Пытается сохранить HTML-контент в файл по пути `self.html_path`.
9.  Логирует информацию об успешном сохранении файла.
10. Возвращает HTML-контент.
11. В случае ошибки логирует информацию об ошибке и возвращает `None`.

#### `create_pdf_report_async`

```python
async def create_pdf_report_async(self, 
                            data: dict, 
                            lang:str, 
                            pdf_path:str |Path) -> bool:
    """
    Полный цикл генерации отчёта.

    Args:
        lang (str): Язык отчёта.
    """
```

**Назначение**: Генерирует PDF-отчет из HTML-контента.

**Параметры**:

-   `data` (dict): Данные для генерации отчета.
-   `lang` (str): Язык отчета.
-   `pdf_path` (str | Path): Путь для сохранения PDF-файла.

**Возвращает**:

-   `bool`: `True` в случае успешной генерации PDF-отчета, `False` в случае ошибки.

**Как работает метод**:

1.  Устанавливает значение `pdf_path` на основе переданного аргумента `pdf_path`.
2.  Устанавливает значение `self.html_content` на основе переданного аргумента `data`.
3.  Инициализирует экземпляр класса `PDFUtils`.
4.  Вызывает метод `save_pdf_pdfkit` для сохранения HTML-контента в PDF-файл.
5.  Если не удалось сохранить PDF-файл, логирует информацию об ошибке и отправляет сообщение в чат (если бот определен).
6.  Если бот определен, пытается отправить PDF-файл в чат.
7.  Возвращает `True` в случае успешной отправки файла, `False` в случае ошибки.

#### `create_docx_report_async`

```python
async def create_docx_report_async(self, html_path:str|Path, docx_path:str|Path) -> bool :
    """Создаю docx файл """
```

**Назначение**: Создает DOCX-файл из HTML-контента.

**Параметры**:

-   `html_path` (str | Path): Путь к HTML-файлу.
-   `docx_path` (str | Path): Путь для сохранения DOCX-файла.

**Возвращает**:

-   `bool`: `True` в случае успешной генерации DOCX-файла, `False` в случае ошибки.

**Как работает метод**:

1.  Вызывает функцию `html_to_docx` для преобразования HTML-файла в DOCX-файл.
2.  Если не удалось скомпилировать DOCX-файл, логирует информацию об ошибке.
3.  Возвращает `True` в случае успешной генерации DOCX-файла, `False` в случае ошибки.

## Функции

### `main`

```python
def main(maxiron_name:str, lang:str) ->bool:
    """ """
```

**Назначение**: Главная функция для запуска процесса генерации отчетов.

**Параметры**:

-   `maxiron_name` (str): Имя мехирона.
-   `lang` (str): Язык отчета.

**Возвращает**:

-   `bool`: `True` в случае успешной генерации отчетов, `False` в случае ошибки.

**Как работает функция**:

1.  Формирует путь к директории с данными мехирона.
2.  Загружает данные из JSON-файла.
3.  Формирует пути к HTML, PDF и DOCX файлам.
4.  Устанавливает флаги `if_need_html`, `if_need_pdf` и `if_need_docx` в `True`.
5.  Создает экземпляр класса `ReportGenerator`.
6.  Запускает асинхронный процесс генерации отчетов с использованием `asyncio.run`.

**Примеры**:

```python
if __name__ == "__main__":
    maxiron_name = '250127221657987' # <- debug
    lang:str = 'ru'
    
    main(maxiron_name, lang)