# Модуль Websim для работы с Websim.ai
## Обзор

Модуль `Websim` предоставляет асинхронные классы для взаимодействия с сервисом Websim.ai, включая поддержку текстовых запросов и генерации изображений. Он включает в себя функциональность для создания уникальных идентификаторов проектов, обработки запросов через API Websim.ai и обработки ответов, возвращаемых сервисом.

## Подробнее

Этот модуль предназначен для интеграции с Websim.ai, позволяя пользователям отправлять запросы на генерацию текста и изображений. Он содержит логику для обработки API-запросов, включая повторные попытки при возникновении ошибок, таких как превышение лимита запросов. Модуль использует асинхронные операции для обеспечения высокой производительности и эффективного использования ресурсов.

## Содержание

- [Классы](#Классы)
    - [Websim](#Websim)
        - [Методы](#Методы)
            - [generate_project_id](#generate_project_id)
            - [create_async_generator](#create_async_generator)
            - [_handle_image_request](#_handle_image_request)
            - [_handle_chat_request](#_handle_chat_request)

## Классы

### `Websim`

**Описание**: Класс `Websim` реализует асинхронного провайдера для работы с Websim.ai. Он поддерживает как текстовые запросы (chat completion), так и запросы на генерацию изображений.

**Принцип работы**:
Класс использует `aiohttp` для выполнения асинхронных HTTP-запросов к API Websim.ai. Он генерирует уникальные идентификаторы проектов, форматирует запросы и обрабатывает ответы, возвращая результаты в виде асинхронного генератора. Поддерживает повторные попытки при возникновении ошибок, связанных с лимитами запросов.

**Переменные класса**:
- `url`: URL сервиса Websim.ai (`https://websim.ai`).
- `login_url`: URL для логина (в данном случае `None`).
- `chat_api_endpoint`: URL для отправки запросов на генерацию текста (`https://websim.ai/api/v1/inference/run_chat_completion`).
- `image_api_endpoint`: URL для отправки запросов на генерацию изображений (`https://websim.ai/api/v1/inference/run_image_generation`).
- `working`: Флаг, указывающий на работоспособность провайдера (`True`).
- `needs_auth`: Флаг, указывающий необходимость аутентификации (`False`).
- `use_nodriver`: Флаг, указывающий на использование драйвера (`False`).
- `supports_stream`: Флаг, указывающий поддержку потоковой передачи данных (`False`).
- `supports_system_message`: Флаг, указывающий поддержку системных сообщений (`True`).
- `supports_message_history`: Флаг, указывающий поддержку истории сообщений (`True`).
- `default_model`: Модель, используемая по умолчанию для генерации текста (`gemini-1.5-pro`).
- `default_image_model`: Модель, используемая по умолчанию для генерации изображений (`flux`).
- `image_models`: Список поддерживаемых моделей для генерации изображений (`[default_image_model]`).
- `models`: Список всех поддерживаемых моделей, включая модели для текста и изображений (`[default_model, 'gemini-1.5-flash'] + image_models`).

### Методы

#### `generate_project_id`

```python
    @staticmethod
    def generate_project_id(for_image=False):
        """
        Generate a project ID in the appropriate format
        
        For chat: format like \'ke3_xh5gai3gjkmruomu\'
        For image: format like \'kx0m131_rzz66qb2xoy7\'
        """
```

**Назначение**: Генерирует идентификатор проекта в зависимости от типа запроса (текст или изображение).

**Параметры**:
- `for_image` (bool): Если `True`, генерирует идентификатор для запроса изображения, иначе - для текстового запроса. По умолчанию `False`.

**Возвращает**:
- `str`: Сгенерированный идентификатор проекта.

**Как работает функция**:
Функция генерирует идентификатор проекта, используя случайные символы и цифры. Формат идентификатора зависит от того, предназначен ли он для запроса изображения или для текстового запроса. Если `for_image` равен `True`, генерируется идентификатор в формате `'kx0m131_rzz66qb2xoy7'`, иначе - в формате `'ke3_xh5gai3gjkmruomu'`.

Внутри функции происходят следующие действия и преобразования:
1. **Определение набора символов**: Определяется набор символов, состоящий из строчных букв и цифр.
2. **Генерация идентификатора для изображения**: Если `for_image` равен `True`, генерируются две части идентификатора: первая часть длиной 7 символов и вторая часть длиной 12 символов. Затем они объединяются с символом `_`.
3. **Генерация идентификатора для текста**: Если `for_image` равен `False`, генерируются префикс длиной 3 символа и суффикс длиной 15 символов. Затем они объединяются с символом `_`.

#### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        prompt: str = None,
        proxy: str = None,
        aspect_ratio: str = "1:1",
        project_id: str = None,
        **kwargs
    ) -> AsyncResult:
        """ """
```

**Назначение**: Создает асинхронный генератор для выполнения запросов к API Websim.ai.

**Параметры**:
- `model` (str): Модель, используемая для генерации текста или изображения.
- `messages` (Messages): Список сообщений для отправки в запросе.
- `prompt` (str, optional): Дополнительный промпт для запроса. По умолчанию `None`.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `aspect_ratio` (str, optional): Соотношение сторон для запроса изображения. По умолчанию `"1:1"`.
- `project_id` (str, optional): Идентификатор проекта. Если не указан, будет сгенерирован автоматически. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы, передаваемые в методы обработки запросов.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий результаты запроса.

**Как работает функция**:
Функция `create_async_generator` определяет, является ли запрос запросом изображения или текстовым запросом, на основе указанной модели. Если идентификатор проекта не предоставлен, он генерируется автоматически. В зависимости от типа запроса, функция вызывает методы `_handle_image_request` или `_handle_chat_request` для обработки запроса и возвращает асинхронный генератор, который предоставляет результаты.

Внутри функции происходят следующие действия и преобразования:
1. **Определение типа запроса**: Проверяется, является ли указанная модель моделью для генерации изображений.
2. **Генерация идентификатора проекта**: Если `project_id` не указан, генерируется новый идентификатор с помощью метода `generate_project_id`.
3. **Определение заголовков**: Устанавливаются заголовки для HTTP-запроса, включая `referer` в зависимости от типа запроса.
4. **Вызов обработчика запроса**: В зависимости от типа запроса вызывается метод `_handle_image_request` или `_handle_chat_request` для обработки запроса и получения результатов.

#### `_handle_image_request`

```python
    @classmethod
    async def _handle_image_request(
        cls,
        project_id: str,
        messages: Messages,
        prompt: str,
        aspect_ratio: str,
        headers: dict,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """ """
```

**Назначение**: Обрабатывает запрос на генерацию изображения, отправляя его в API Websim.ai и возвращая URL изображения.

**Параметры**:
- `project_id` (str): Идентификатор проекта.
- `messages` (Messages): Список сообщений для формирования промпта.
- `prompt` (str): Дополнительный промпт для запроса.
- `aspect_ratio` (str): Соотношение сторон для изображения.
- `headers` (dict): Заголовки HTTP-запроса.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий объект `ImageResponse` с URL изображения и альтернативным текстом.

**Как работает функция**:
Функция `_handle_image_request` форматирует промпт на основе предоставленных сообщений и дополнительного промпта, затем отправляет POST-запрос к API Websim.ai для генерации изображения. После получения ответа, функция извлекает URL изображения из JSON-ответа и возвращает объект `ImageResponse`, содержащий URL изображения и использованный промпт.

Внутри функции происходят следующие действия и преобразования:
1. **Форматирование промпта**: Форматируется промпт с использованием метода `format_image_prompt`.
2. **Отправка запроса**: Отправляется POST-запрос к API Websim.ai с использованием `aiohttp.ClientSession`.
3. **Обработка ответа**: Извлекается URL изображения из JSON-ответа и возвращается объект `ImageResponse`.

#### `_handle_chat_request`

```python
    @classmethod
    async def _handle_chat_request(
        cls,
        project_id: str,
        messages: Messages,
        headers: dict,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """ """
```

**Назначение**: Обрабатывает запрос на генерацию текста, отправляя его в API Websim.ai и возвращая сгенерированный текст.

**Параметры**:
- `project_id` (str): Идентификатор проекта.
- `messages` (Messages): Список сообщений для отправки в запросе.
- `headers` (dict): Заголовки HTTP-запроса.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий сгенерированный текст.

**Как работает функция**:
Функция `_handle_chat_request` отправляет POST-запрос к API Websim.ai для генерации текста на основе предоставленных сообщений. Функция включает логику повторных попыток при получении ошибок, связанных с лимитами запросов (код состояния 429). После успешного получения ответа, функция извлекает сгенерированный текст из JSON-ответа и возвращает его.

Внутри функции происходят следующие действия и преобразования:
1. **Настройка повторных попыток**: Устанавливается максимальное количество попыток и счетчик текущих попыток.
2. **Отправка запроса**: Отправляется POST-запрос к API Websim.ai с использованием `aiohttp.ClientSession`.
3. **Обработка ответа**:
    - Если получен код состояния 429 (превышение лимита запросов), функция ожидает некоторое время и повторяет попытку.
    - Если запрос успешен, функция извлекает сгенерированный текст из JSON-ответа и возвращает его.
    - Если произошла ошибка JSONDecodeError, функция возвращает текст ответа без обработки.