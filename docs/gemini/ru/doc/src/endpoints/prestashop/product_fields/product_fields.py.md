# Модуль product_fields.py

## Обзор

Модуль `product_fields.py` предназначен для описания и управления полями товаров в формате API PrestaShop. Он содержит класс `ProductFields`, который позволяет загружать, устанавливать и форматировать значения полей товара, включая мультиязычные значения.

## Подробней

Этот модуль используется для стандартизации данных о товарах при взаимодействии с API PrestaShop. Он обеспечивает удобный интерфейс для работы с полями товаров, поддерживая различные типы данных и мультиязычность.

## Классы

### `ProductFields`

**Описание**: Класс `ProductFields` предназначен для представления полей товара в формате, совместимом с API PrestaShop. Он содержит методы для загрузки значений полей по умолчанию, установки мультиязычных значений и преобразования данных в формат, пригодный для отправки через API.

**Как работает класс**:

1.  При инициализации класса происходит загрузка значений полей по умолчанию из файлов `fields_list.txt` и `product_fields_default_values.json`.
2.  Класс предоставляет свойства (property) для доступа к отдельным полям товара, таким как `id_product`, `name`, `description` и т.д.
3.  Для мультиязычных полей используются методы `_set_multilang_value` для установки значений на разных языках.
4.  Метод `to_dict` преобразует данные объекта в словарь, готовый для отправки через API PrestaShop.

**Методы**:

*   `__post_init__`: Инициализирует класс после создания экземпляра. Вызывает метод `_payload` для загрузки значений полей.

*   `_payload`
    ```python
    def _payload(self) -> bool:
        """
        Загрузка дефолтных значений полей.
        Returns:
            bool: True, если загрузка прошла успешно, иначе False.
        """
    ```

    **Назначение**: Загружает значения полей товара по умолчанию из файлов `fields_list.txt` и `product_fields_default_values.json`.

    **Как работает функция**:

    1.  Определяет базовый путь к файлам конфигурации.
    2.  Считывает список полей из файла `fields_list.txt`. Если файл не найден или пуст, логирует ошибку и возвращает `False`.
    3.  Создает объект `SimpleNamespace` для хранения полей товара.
    4.  Загружает значения по умолчанию из файла `product_fields_default_values.json`. Если файл не найден или пуст, логирует отладочное сообщение и возвращает `False`.
    5.  Устанавливает значения атрибутов объекта `self.presta_fields` на основе загруженных данных.
    6.  В случае возникновения исключений в процессе загрузки или конвертации, логирует ошибку и возвращает `False`.

    **Параметры**:

    *   Нет

    **Возвращает**:

    *   `bool`: `True`, если загрузка прошла успешно, иначе `False`.

    **Вызывает исключения**:

    *   `Exception`: Если возникает ошибка при чтении или обработке файлов.

*   `_set_multilang_value`
    ```python
    def _set_multilang_value(self, field_name: str, value: str, id_lang: Optional[int | str] = None) -> bool:
        """
        Устанавливает мультиязычное значение для заданного поля.

        Args:
            field_name (str): Имя поля (например, 'name', 'description').
            value (str): Значение для установки.
            id_lang (Optional[Union[int, str]]): ID языка. Если не указан, используется self.id_lan.

        Returns:
            bool: True, если значение успешно установлено, False в случае ошибки.
        """
    ```

    **Назначение**: Устанавливает мультиязычное значение для указанного поля товара.

    **Как работает функция**:

    1.  Определяет ID языка. Если `id_lang` не указан, использует значение `self.id_lang`.
    2.  Формирует структуру данных для хранения значения языка.
    3.  Проверяет, существует ли поле с указанным именем в `self.presta_fields`.
    4.  Если поле не существует, создает его и устанавливает значение для указанного языка.
    5.  Если поле существует, проверяет, имеет ли оно правильную структуру (словарь с ключом `language`, содержащим список). Если структура неправильная, перезаписывает поле с новой структурой.
    6.  Если структура правильная, пытается обновить значение для указанного языка. Если язык уже существует в списке, его значение обновляется. Если язык не существует, добавляется новая запись в список.
    7.  В случае возникновения исключений, логирует ошибку и возвращает `False`.

    **Параметры**:

    *   `field_name` (str): Имя поля для установки значения.
    *   `value` (str): Значение для установки.
    *   `id_lang` (Optional[int | str], optional): ID языка. По умолчанию `None`.

    **Возвращает**:

    *   `bool`: `True`, если значение успешно установлено, иначе `False`.

    **Вызывает исключения**:

    *   `Exception`: Если возникает ошибка при установке значения.

*   Свойства для доступа к полям таблицы `ps_product` и `ps_product_lang`.

    Каждое свойство имеет геттер и сеттер для получения и установки значений соответствующих полей. Например:

    ```python
    @property
    def id_product(self) -> Optional[int]:
        """ property `ps_product.id_product: int(10) unsigned` """
        return self.presta_fields.id_product

    @id_product.setter
    def id_product(self, value: int = None):
        """ setter `ID` товара. Для нового товара id назначается из `PrestaShop`. """
        try:
            self.presta_fields.id_product = value
        except Exception as ex:
            logger.error(f"Ошибка при установке id_product:",ex)
    ```

    **Описание**: Геттер возвращает значение поля `id_product` из `self.presta_fields`. Сеттер устанавливает значение поля `id_product` в `self.presta_fields`.

    **Параметры**:

    *   `value` (int, optional): Значение для установки. По умолчанию `None`.

    **Возвращает**:

    *   `Optional[int]`: Значение поля `id_product`.

    **Вызывает исключения**:

    *   `Exception`: Если возникает ошибка при установке значения.

*   Свойства для доступа к полям таблицы `ps_product_lang`.

    Каждое свойство имеет геттер и сеттер для получения и установки мультиязычных значений соответствующих полей. Например:

    ```python
    @property
    def name(self) -> Optional[str]:
        """ property `ps_product_lang.name: varchar(128)` """
        return self.presta_fields.name

    @name.setter
    def name(self, value: str):
        """ setter Название товара. Мультиязычное поле."""
        self._set_multilang_value('name', value)
    ```

    **Описание**: Геттер возвращает значение поля `name` из `self.presta_fields`. Сеттер устанавливает мультиязычное значение поля `name` с использованием метода `_set_multilang_value`.

    **Параметры**:

    *   `value` (str): Значение для установки.

    **Возвращает**:

    *   `Optional[str]`: Значение поля `name`.

    **Вызывает исключения**:

    *   Нет

*   `to_dict`
    ```python
    def to_dict(self) -> Dict[str, Any]:
        """
        Преобразует объект ProductFields в словарь для PrestaShop API,
        исключая ключи, значения которых равны None или пустой строке,
        и формирует мультиязычные поля в нужном формате. Все поля должны быть представлены как строки.

        Returns:
            Dict[str, Any]: Словарь с полями, готовый для PrestaShop API.
        """
    ```

    **Назначение**: Преобразует объект `ProductFields` в словарь, пригодный для отправки в API PrestaShop.

    **Как работает функция**:

    1.  Создает пустой словарь `product_dict`.
    2.  Для каждого поля в `self.presta_fields` проверяет, установлено ли значение. Если значение установлено, преобразует его в строку и добавляет в словарь `product_dict`.
    3.  Для мультиязычных полей вызывает метод `_format_multilang_value` для форматирования значений.
    4.  Добавляет информацию об associations, если она есть.
    5.  Возвращает словарь `product_dict`.

    **Параметры**:

    *   Нет

    **Возвращает**:

    *   `Dict[str, Any]`: Словарь с полями, готовый для PrestaShop API.

    **Вызывает исключения**:

    *   Нет

*   `_format_multilang_value`
    ```python
    def _format_multilang_value(self, data: Any) -> List[Dict[str, str]]:
        """
        Форматирует мультиязычные значения в список словарей для PrestaShop API. Все значения представляются как строки.

        Args:
            data (Any): Значение поля. Если это словарь, ожидается структура {'language': [{'attrs': {'id': lang_id}, 'value': value}]}

        Returns:
            List[Dict[str, str]]: Список словарей, где каждый словарь содержит 'id' и 'value' (все как строки) для каждого языка.
        """
    ```

    **Назначение**: Форматирует мультиязычные значения в список словарей для PrestaShop API.

    **Как работает функция**:

    1.  Проверяет, является ли `data` словарем и содержит ли ключ `language`.
    2.  Если да, итерируется по списку языковых словарей в `data['language']`.
    3.  Извлекает `lang_id` и `lang_value` из каждого языкового словаря.
    4.  Добавляет словарь с `id` и `value` в результирующий список.
    5.  Если `data` не соответствует ожидаемой структуре, создает список с одним элементом для текущего языка.
    6.  Возвращает результирующий список.

    **Параметры**:

    *   `data` (Any): Значение поля. Ожидается структура `{'language': [{'attrs': {'id': lang_id}, 'value': value}]}`.

    **Возвращает**:

    *   `List[Dict[str, str]]`: Список словарей, где каждый словарь содержит `id` и `value` для каждого языка.

    **Вызывает исключения**:

    *   Нет

*   `_ensure_associations`
    ```python
    def _ensure_associations(self):
        """Убеждается, что структура associations существует в presta_fields."""
    ```

    **Назначение**: Убеждается, что структура associations существует в presta_fields.

    **Как работает функция**:

    1.  Проверяет, существует ли атрибут `associations` в `self.presta_fields`.
    2.  Если атрибут не существует, создает его как пустой словарь.

    **Параметры**:

    *   Нет

    **Возвращает**:

    *   Нет

    **Вызывает исключения**:

    *   Нет

*   Методы для работы с associations (связями) товара.

    Эти методы позволяют добавлять, удалять и получать связи с другими сущностями PrestaShop, такими как категории, изображения, комбинации, опции продукта, характеристики продукта, теги, доступность на складе, вложения, аксессуары и бандлы продуктов.

    Примеры:

    ```python
    @property
    def additional_categories(self) -> Optional[List[dict]]:
        """"""
        return self.presta_fields.associations.get('categories') if hasattr(self.presta_fields, 'associations') else []

    def additional_category_append(self, category_id: int | str):
        """Добавляет связь с категорией, если ее еще нет."""
        
        self._ensure_associations()
        try:
            category_id = int(category_id)
        except (ValueError, Exception) as ex:
            logger.error("`category_id` должен быть `int`",ex)
            return


        if 'categories' not in self.presta_fields.associations:
            self.presta_fields.associations['categories']:list[dict] = []
        
        category_id_str = str(category_id)
        
        # проверяем есть ли уже такая категория
        if not any(d['id'] == category_id_str for d in self.presta_fields.associations['categories']):
            self.presta_fields.associations['categories'].append({'id': category_id_str})

    def additional_categories_clear(self):
        """Очищает все связи с категориями."""
        self._ensure_associations()
        if 'categories' in self.presta_fields.associations:
            del self.presta_fields.associations['categories']
    ```

    **Описание**: Геттер возвращает список дополнительных категорий товара. Метод `additional_category_append` добавляет связь с категорией, если ее еще нет. Метод `additional_categories_clear` очищает все связи с категориями.

    **Параметры**:

    *   `category_id` (int | str): ID категории для добавления.

    **Возвращает**:

    *   `Optional[List[dict]]`: Список дополнительных категорий.

    **Вызывает исключения**:

    *   `ValueError`, `Exception`: Если `category_id` не является целым числом.

## Функции

В данном модуле нет отдельных функций, все операции выполняются методами класса `ProductFields`.