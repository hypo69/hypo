# Модуль для работы с ReplicateHome
======================================

Модуль предназначен для асинхронного взаимодействия с API ReplicateHome для генерации текста и изображений.
Он предоставляет класс `ReplicateHome`, который наследуется от `AsyncGeneratorProvider` и `ProviderModelMixin`.

## Обзор

Модуль предоставляет асинхронный интерфейс для работы с API ReplicateHome, позволяя генерировать текст и изображения на основе различных моделей.
Он включает поддержку стриминга результатов, выбор модели и обработку ошибок.

## Подробнее

Модуль `ReplicateHome.py` является частью проекта `hypotez` и предназначен для обеспечения взаимодействия с платформой Replicate.
Он позволяет пользователям отправлять запросы на генерацию контента (текста или изображений) с использованием различных моделей,
предлагаемых Replicate. Модуль асинхронный, что позволяет эффективно обрабатывать запросы без блокировки основного потока выполнения.

## Классы

### `ReplicateHome`

**Описание**: Класс для взаимодействия с API ReplicateHome.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями.

**Атрибуты**:
- `url` (str): URL главной страницы Replicate.
- `api_endpoint` (str): URL API для отправки запросов на предсказание.
- `working` (bool): Флаг, указывающий, работает ли провайдер (по умолчанию `False`).
- `supports_stream` (bool): Флаг, указывающий, поддерживает ли провайдер потоковую передачу данных (по умолчанию `True`).
- `default_model` (str): Модель, используемая по умолчанию для генерации текста (`'google-deepmind/gemma-2b-it'`).
- `default_image_model` (str): Модель, используемая по умолчанию для генерации изображений (`'stability-ai/stable-diffusion-3'`).
- `image_models` (List[str]): Список моделей, поддерживаемых для генерации изображений.
- `text_models` (List[str]): Список моделей, поддерживаемых для генерации текста.
- `models` (List[str]): Объединенный список всех поддерживаемых моделей (текстовых и графических).
- `model_aliases` (Dict[str, str]): Словарь, содержащий псевдонимы моделей для удобства использования.
- `model_versions` (Dict[str, str]): Словарь, содержащий версии моделей.

**Методы**:
- `create_async_generator()`: Создает асинхронный генератор для выполнения запроса к API ReplicateHome.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    prompt: str = None,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для выполнения запроса к API ReplicateHome.

    Args:
        cls (ReplicateHome): Класс ReplicateHome.
        model (str): Название модели для использования.
        messages (Messages): Список сообщений для формирования запроса.
        prompt (str, optional): Текст запроса. Если не указан, формируется автоматически. По умолчанию `None`.
        proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий результаты запроса.

    Raises:
        Exception: Если предсказание завершилось неудачно или истекло время ожидания.

    Внутренние функции:
        отсутствуют

    """
```

**Назначение**: Создание асинхронного генератора для взаимодействия с API ReplicateHome.

**Параметры**:
- `cls` (ReplicateHome): Класс `ReplicateHome`.
- `model` (str): Название модели для использования.
- `messages` (Messages): Список сообщений для формирования запроса.
- `prompt` (str, optional): Текст запроса. Если не указан, формируется автоматически. По умолчанию `None`.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий результаты запроса.

**Вызывает исключения**:
- `Exception`: Если предсказание завершилось неудачно или истекло время ожидания.
- `ValueError`: Если получен неожиданный формат ответа от сервера.

**Как работает функция**:

1. **Определение модели**: Функция извлекает название модели из входных параметров, используя `cls.get_model(model)`.
2. **Формирование заголовков**: Создаются заголовки HTTP-запроса, необходимые для взаимодействия с API ReplicateHome.
3. **Создание сессии**: Используется `aiohttp.ClientSession` для выполнения асинхронных HTTP-запросов.
4. **Подготовка данных**: Если `prompt` не указан, он формируется на основе `messages`. Для моделей изображений используется `messages[-1]['content']`, для текстовых моделей используется `format_prompt(messages)`.
5. **Отправка запроса**: Отправляется POST-запрос к `cls.api_endpoint` с данными, включающими модель, версию и запрос.
6. **Получение ID предсказания**: Извлекается `prediction_id` из JSON-ответа.
7. **Опрос API**: Выполняется цикл опроса API по URL `poll_url` до получения результата или достижения максимального количества попыток.
8. **Обработка результата**: Если статус предсказания `'succeeded'`, функция возвращает результат в виде текста или изображения. Если статус `'failed'`, выбрасывается исключение.
9. **Обработка ошибок**: В случае ошибок при запросах или декодировании JSON, выбрасываются соответствующие исключения.
10. **Таймаут**: Если по истечении максимального количества попыток предсказание не завершилось, выбрасывается исключение о таймауте.

```text
    Определение модели (model)
    │
    Создание заголовков (headers)
    │
    Создание асинхронной сессии (session)
    │
    Подготовка данных (data)
    │
    Отправка POST-запроса (session.post)
    │
    Получение ID предсказания (prediction_id)
    │
    Цикл опроса API (poll_url)
    │
    Обработка результата (result)
    │
    Возврат результата или исключения
```

**Примеры**:

```python
# Пример использования для генерации текста
model_name = "gemma-2b"
messages = [{"role": "user", "content": "Напиши короткий рассказ о космосе."}]
async for chunk in ReplicateHome.create_async_generator(model=model_name, messages=messages):
    print(chunk, end="")

# Пример использования для генерации изображения
model_name = "sd-3"
messages = [{"role": "user", "content": "Фотография кота в космосе."}]
async for image_response in ReplicateHome.create_async_generator(model=model_name, messages=messages):
    print(image_response.image_url)