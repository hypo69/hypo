# Модуль `utils.py` для обработки успешных платежей в Telegram боте

## Обзор

Модуль содержит функцию `successful_payment_logic`, которая обрабатывает логику после успешной оплаты товара пользователем в Telegram боте. Функция добавляет информацию о покупке в базу данных, отправляет уведомления администраторам и предоставляет пользователю информацию о приобретенном товаре.

## Подробней

Этот модуль является важной частью логики работы Telegram-бота, обеспечивая связь между фактом оплаты и предоставлением товара пользователю. Функция `successful_payment_logic` координирует запись данных о платеже, уведомление администраторов о покупке и предоставление информации о товаре покупателю.

## Функции

### `successful_payment_logic`

```python
async def successful_payment_logic(session: AsyncSession, payment_data, currency, user_tg_id, bot: Bot):
    """
    Обрабатывает логику после успешной оплаты товара пользователем.

    Args:
        session (AsyncSession): Сессия базы данных SQLAlchemy.
        payment_data: Данные о платеже.
        currency: Валюта платежа.
        user_tg_id: ID пользователя в Telegram.
        bot (Bot): Экземпляр бота aiogram.

    Returns:
        None

    Raises:
        Exception: Если происходит ошибка при отправке уведомления администраторам.

    Example:
        Пример вызова функции (требуется настройка окружения и данных):

        >>> from aiogram import Bot
        >>> from sqlalchemy.ext.asyncio import AsyncSession
        >>> # Предположим, что у вас есть настроенные session, payment_data, currency, user_tg_id и bot
        >>> # await successful_payment_logic(session, payment_data, currency, user_tg_id, bot)
    """
```

**Как работает функция**:

1.  **Извлечение данных о платеже**: Извлекает `product_id`, `price`, `payment_type`, `payment_id` и `user_id` из `payment_data`.
2.  **Добавление информации о покупке**: Добавляет данные о платеже в базу данных, используя `PurchaseDao.add`.
3.  **Получение данных о продукте**: Получает информацию о продукте из базы данных, используя `ProductDao.find_one_or_none_by_id`.
4.  **Отправка уведомлений администраторам**: Отправляет уведомления администраторам о совершенной покупке, используя `bot.send_message`. В случае ошибки логирует ошибку с использованием `logger.error`.
5.  **Формирование текста сообщения для пользователя**: Формирует текст сообщения с информацией о товаре для пользователя.
6.  **Отправка товара пользователю**: Если у товара есть `file_id`, отправляет файл пользователю, используя `bot.send_document`. В противном случае отправляет текстовое сообщение, используя `bot.send_message`.
7.  **Автоматический возврат звезд за покупку**: Если тип платежа `stars`, выполняет возврат звезд пользователю, используя `bot.refund_star_payment`.

**Параметры**:

*   `session` (AsyncSession): Асинхронная сессия базы данных SQLAlchemy для выполнения операций с базой данных.
*   `payment_data`: (dict) Словарь, содержащий данные о платеже, включая `product_id`, `price`, `payment_type`, `payment_id` и `user_id`.
*   `currency` (str): Валюта, в которой был произведен платеж.
*   `user_tg_id` (int): ID пользователя в Telegram, совершившего покупку.
*   `bot` (Bot): Экземпляр бота aiogram для отправки сообщений и документов пользователям и администраторам.

**Возвращает**:

*   `None`: Функция ничего не возвращает.

**Вызывает исключения**:

*   `Exception`: Если происходит ошибка при отправке уведомления администраторам.

**Примеры**:

```python
# Пример вызова функции (требуется настройка окружения и данных):
from aiogram import Bot
from sqlalchemy.ext.asyncio import AsyncSession

# Предположим, что у вас есть настроенные session, payment_data, currency, user_tg_id и bot
# await successful_payment_logic(session, payment_data, currency, user_tg_id, bot)