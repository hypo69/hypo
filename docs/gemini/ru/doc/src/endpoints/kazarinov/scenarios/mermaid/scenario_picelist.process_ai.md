# Диаграмма процесса обработки списка продуктов (scenario_picelist.process_ai.mmd)

## Обзор

Данная диаграмма описывает процесс обработки запроса пользователя на обработку списка продуктов (products_list) с помощью AI-модели.  Процесс включает в себя обработку ошибок, повторные запросы и проверку валидности данных.


## Диаграмма

```mermaid
sequenceDiagram
    participant User
    participant AI_Model
    participant Logger
    
    User->>AI_Model: Запрос на обработку продуктов (products_list)
    AI_Model->>AI_Model: Обработка запроса с командой модели
    AI_Model->>User: Ответ от модели
    
    alt Нет ответа от модели
        Logger->>Logger: Логирирование ошибки "no response from gemini"
        User->>AI_Model: Повторный запрос (attempts - 1)
    end
    
    alt Невалидные данные (data)
        Logger->>Logger: Логирирование ошибки "Error in data from gemini"
        User->>AI_Model: Повторный запрос (attempts - 1)
    end
    
    alt Получены данные (data)
        alt Данные в виде списка
            alt Два элемента (ru, he)
                User->>User: Извлечение ru и he
            end
            alt Один элемент
                User->>User: Извлечение ru и he из первого элемента
            end
            alt Невалидная структура данных
                Logger->>Logger: Логирирование ошибки "Проблема парсинга ответа"
                User->>AI_Model: Повторный запрос (attempts - 1)
            end
        end
    
        alt Данные в виде объекта
            User->>User: Извлечение ru и he из объекта
        end
    
        alt Невалидные значения (ru или he)
            Logger->>Logger: Логирирование ошибки "Invalid ru or he data"
            User->>AI_Model: Повторный запрос (attempts - 1)
        end
    
        User->>User: Возврат результата ru и he
    end
```

## Обрабатываемые типы данных

Данный процесс может принимать данные в виде списка или объекта. При получении списка, проверяется соответствие структуре:

* Если в списке два элемента (например,  `[ru_data, he_data]`), они будут извлечены напрямую.
* Если в списке один элемент,  извлекаются ru и he из первого элемента этого списка.
* В случае несоответствия ожидаемой структуре, регистрируется ошибка "Проблема парсинга ответа".


Если данные передаются в виде объекта, то происходит извлечение полей ru и he из объекта.

## Возможные ошибки

Процесс обрабатывает следующие возможные ошибки:

* **"no response from gemini"**: Ошибка, возникающая, если AI-модель не отвечает на запрос.
* **"Error in data from gemini"**: Ошибка, если полученные данные не соответствуют ожидаемому формату.
* **"Проблема парсинга ответа"**: Ошибка, если полученный список или объект не имеет ожидаемой структуры для извлечения значений ru и he.
* **"Invalid ru or he data"**: Ошибка, если значения ru или he не имеют корректного формата или отсутствуют.

## Логирование ошибок

В процессе используется модуль `Logger` для регистрации всех ошибок.


## Результат

В случае успешной обработки, процесс возвращает извлеченные значения `ru` и `he`.