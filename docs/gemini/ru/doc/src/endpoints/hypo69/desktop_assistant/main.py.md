# Модуль `main.py` для desktop_assistant
## Обзор

Модуль `main.py` представляет собой основной файл приложения `desktop_assistant`, использующего фреймворк FastAPI.
Он определяет API-endpoint для чата с использованием модели Google Gemini и предоставляет статические файлы (HTML, JSON) для пользовательского интерфейса.

## Подорбней
Модуль настраивает CORS middleware для обеспечения взаимодействия с различными источниками, определяет модели запросов и ответов,
а также обрабатывает запросы к API для чата и получения локализованных файлов.
Код использует модуль `logger` для логирования ошибок и других событий, что облегчает отладку и мониторинг приложения.

## Классы

### `ChatRequest`
**Описание**: Класс `ChatRequest` наследуется от `BaseModel` библиотеки `pydantic` и представляет собой модель запроса для чата.

**Аттрибуты**:
- `message` (str): Сообщение пользователя.

### **Методы**:
- Отсутствуют

## Функции

### `root`

```python
async def root():
    """
    Отображает HTML-страницу index.html.

    Args:
        Нет

    Returns:
        HTMLResponse: HTML-контент страницы index.html.

    Raises:
        HTTPException: В случае, если файл index.html не найден или произошла ошибка при его чтении.

    """
```

**Назначение**: Обеспечивает отображение главной страницы приложения, загружая и возвращая содержимое файла `index.html`.

**Как работает функция**:
 1. Определяет путь к файлу `index.html` в директории `templates`.
 2. Проверяет существование файла. Если файл не существует, вызывает исключение `FileNotFoundError`.
 3. Читает содержимое файла в кодировке UTF-8.
 4. Возвращает HTML-контент страницы в виде объекта `HTMLResponse`.
 5. В случае возникновения исключений `FileNotFoundError` или других ошибок, логирует ошибку с помощью `logger.error` и вызывает исключение `HTTPException` с кодом состояния 500.

**ASII flowchart**:

```
    A[Определение пути к index.html]
    |
    B[Проверка существования файла]
    |
    C[Чтение содержимого файла]
    |
    D[Возврат HTML-контента]
    |
    E[Обработка исключений]
```
**Примеры**:

```python
# Запрос к корневому пути ("/")
# Ожидается HTML-страница с пользовательским интерфейсом
```

### `chat`

```python
async def chat(request: ChatRequest):
    """
    Обрабатывает запросы к чат-боту.

    Args:
        request (ChatRequest): Запрос, содержащий сообщение пользователя.

    Returns:
        dict: Ответ от чат-бота в формате JSON.

    Raises:
        HTTPException: В случае ошибки при взаимодействии с моделью Google Gemini.
    """
```

**Назначение**: Обрабатывает запросы к чат-боту, используя модель Google Gemini для генерации ответов.

**Параметры**:
- `request` (ChatRequest): Запрос, содержащий сообщение пользователя.

**Возвращает**:
- `dict`: Ответ от чат-бота в формате JSON.

**Как работает функция**:

1.  Проверяет, инициализирована ли глобальная переменная `model`. Если нет, создает экземпляр класса `GoogleGenerativeAI` с использованием API-ключа из `gs.credentials.gemini.games` и модели `gemini-2.0-flash-exp`.
2.  Вызывает метод `chat` экземпляра `model` с сообщением пользователя из запроса.
3.  Возвращает ответ от чат-бота в виде словаря JSON с ключом `"response"`.
4.  В случае возникновения исключений, логирует ошибку с использованием `logger.error` и вызывает исключение `HTTPException` с кодом состояния 500.

**ASII flowchart**:

```
    A[Проверка инициализации модели]
    |
    B[Создание экземпляра GoogleGenerativeAI (если необходимо)]
    |
    C[Вызов метода chat модели]
    |
    D[Возврат ответа в формате JSON]
    |
    E[Обработка исключений]
```

**Примеры**:

```python
# Запрос к "/api/chat" с JSON-сообщением
# Ожидается ответ от чат-бота
```

### `get_locale_file`

```python
def get_locale_file(lang: str):
    """
    Загружает файл локализации JSON для указанного языка.

    Args:
        lang (str): Код языка (например, "en", "ru").

    Returns:
        dict: Словарь, содержащий локализованные строки.

    Raises:
        HTTPException:
            - Если файл локализации не найден (код состояния 404).
            - Если файл локализации содержит некорректный JSON (код состояния 500).
            - Если произошла другая ошибка при чтении файла (код состояния 500).
    """
```

**Назначение**: Загружает JSON-файл локализации для указанного языка.

**Параметры**:
- `lang` (str): Код языка (например, "en", "ru").

**Возвращает**:
- `dict`: Словарь, содержащий локализованные строки.

**Как работает функция**:

1.  Формирует путь к файлу локализации на основе кода языка.
2.  Открывает файл локализации на чтение в кодировке UTF-8.
3.  Загружает JSON-данные из файла в словарь Python.
4.  Возвращает словарь с локализованными строками.
5.  Обрабатывает исключения:
    *   `FileNotFoundError`: Если файл не найден, логирует ошибку и вызывает `HTTPException` с кодом 404.
    *   `json.JSONDecodeError`: Если JSON в файле некорректный, логирует ошибку и вызывает `HTTPException` с кодом 500.
    *   Любые другие исключения: Логирует ошибку и вызывает `HTTPException` с кодом 500.

**ASII flowchart**:

```
    A[Формирование пути к файлу локализации]
    |
    B[Открытие файла локализации]
    |
    C[Загрузка JSON-данных]
    |
    D[Возврат словаря с локализованными строками]
    |
    E[Обработка исключений (FileNotFoundError, json.JSONDecodeError, Exception)]
```

**Примеры**:

```python
# Загрузка файла локализации для русского языка:
# locale_data = get_locale_file("ru")
```

### `locales`

```python
async def locales(lang: str):
    """
    Возвращает файл локализации JSON для указанного языка.

    Args:
        lang (str): Код языка (например, "en", "ru").

    Returns:
        JSONResponse: JSON-контент файла локализации.

    Raises:
        HTTPException: Если файл локализации не найден или содержит некорректный JSON.
    """
```

**Назначение**: Предоставляет API endpoint для получения JSON-файла локализации для указанного языка.

**Параметры**:
- `lang` (str): Код языка (например, "en", "ru").

**Возвращает**:
- `JSONResponse`: JSON-контент файла локализации.

**Как работает функция**:

1.  Вызывает функцию `get_locale_file` с указанным кодом языка.
2.  Возвращает результат, который представляет собой словарь с локализованными строками. FastAPI автоматически преобразует этот словарь в JSON-ответ.

**ASII flowchart**:

```
    A[Вызов функции get_locale_file с кодом языка]
    |
    B[Возврат JSON-ответа]
```

**Примеры**:

```python
# Запрос к "/locales/ru.json"
# Ожидается JSON с локализованными строками для русского языка
```
```python
if __name__ == "__main__":
    uvicorn.run(app, host="127.0.0.1", port=8000)
```

**Назначение**: Запускает FastAPI-приложение с использованием Uvicorn.

**Как работает функция**:

1.  Запускает Uvicorn-сервер, который будет обслуживать FastAPI-приложение.
2.  Указывает хост (`127.0.0.1`) и порт (`8000`), на котором будет работать сервер.

**ASII flowchart**:

```
A[Запуск Uvicorn-сервера]
```

**Примеры**:

```python
# Запуск сервера локально:
# python main.py