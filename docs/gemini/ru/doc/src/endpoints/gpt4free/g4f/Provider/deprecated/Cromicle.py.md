# Модуль Cromicle

## Обзор

Модуль `Cromicle` предоставляет асинхронный генератор для взаимодействия с сервисом `cromicle.top`. Он используется для отправки запросов к API чата и получения ответов в потоковом режиме. Модуль поддерживает модель `gpt-3.5-turbo`.

## Подробнее

Модуль содержит класс `Cromicle`, который наследуется от `AsyncGeneratorProvider` и переопределяет метод `create_async_generator` для создания асинхронного генератора, отправляющего запросы к API `cromicle.top`.
Также, содержит две вспомогательные функции `_create_header` и `_create_payload` для формирования заголовков и полезной нагрузки запроса соответственно.

## Классы

### `Cromicle`

**Описание**: Класс `Cromicle` предоставляет функциональность для взаимодействия с сервисом `cromicle.top`.

**Наследует**:
- `AsyncGeneratorProvider`:  Этот класс является базовым для асинхронных провайдеров, предоставляющих потоковую генерацию ответов.

**Атрибуты**:
- `url` (str): URL-адрес сервиса `cromicle.top`.
- `working` (bool): Индикатор работоспособности сервиса (в данном случае `False`).
- `supports_gpt_35_turbo` (bool):  Указывает, поддерживает ли сервис модель `gpt-3.5-turbo` (в данном случае `True`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для отправки запросов и получения ответов от API.

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для взаимодействия с API cromicle.top.

        Args:
            model (str): Модель, используемая для генерации ответа.
            messages (Messages): Список сообщений для отправки в запросе.
            proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
            **kwargs: Дополнительные именованные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, выдающий части ответа от API.
        """
        ...
```

**Назначение**: Создает асинхронный генератор для отправки запросов к API `cromicle.top` и получения ответов в потоковом режиме.

**Параметры**:
- `model` (str): Модель, используемая для генерации ответа.
- `messages` (Messages): Список сообщений для отправки в запросе.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные именованные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий части ответа от API.

**Как работает функция**:

1. **Инициализация сессии**: Функция создает асинхронную сессию `ClientSession` с заголовками, полученными из функции `_create_header`.
2. **Формирование запроса**: Подготавливается полезная нагрузка (payload) запроса с использованием функции `_create_payload`, которая форматирует сообщения.
3. **Отправка POST-запроса**: Отправляется POST-запрос к API `cromicle.top/chat` с использованием созданной сессии, прокси (если указан) и сформированной полезной нагрузкой.
4. **Обработка ответа**: Функция итерируется по содержимому ответа в потоковом режиме и декодирует каждый полученный фрагмент, после чего передает его через `yield`.
5. **Обработка ошибок**: Если во время запроса возникает ошибка, `response.raise_for_status()` вызовет исключение.

**ASCII Flowchart**:

```
    Создание асинхронной сессии с заголовками
    │
    └──> Формирование полезной нагрузки запроса (payload)
    │
    └──> Отправка POST-запроса к API cromicle.top/chat
    │
    └──> Итерация по содержимому ответа в потоковом режиме
    │
    └──> Декодирование полученного фрагмента ответа
    │
    └──> Передача фрагмента ответа через yield
```

**Примеры**:

```python
# Пример использования (необходимо создать messages)
messages = [{"role": "user", "content": "Hello"}]
async def test():
    async for message in Cromicle.create_async_generator(model="gpt-3.5-turbo", messages=messages):
        print(message)
```

## Функции

### `_create_header`

```python
def _create_header() -> Dict[str, str]:
    """
    Создает словарь с HTTP-заголовками.

    Returns:
        Dict[str, str]: Словарь, содержащий заголовки 'accept' и 'content-type'.
    """
    ...
```

**Назначение**: Создает словарь с HTTP-заголовками, необходимыми для запроса.

**Возвращает**:
- `Dict[str, str]`: Словарь, содержащий заголовки `accept` и `content-type`.

**Как работает функция**:

1. **Создание заголовков**: Функция создает словарь, содержащий HTTP-заголовки `accept` и `content-type`.
2. **Возврат словаря**: Функция возвращает созданный словарь с заголовками.

**ASCII Flowchart**:

```
Создание словаря с HTTP-заголовками (accept, content-type)
│
└──> Возврат словаря с заголовками
```

**Примеры**:

```python
# Пример использования
header = _create_header()
print(header)  # Вывод: {'accept': '*/*', 'content-type': 'application/json'}
```

### `_create_payload`

```python
def _create_payload(message: str) -> Dict[str, str]:
    """
    Создает словарь с полезной нагрузкой (payload) для запроса.

    Args:
        message (str): Текст сообщения для отправки.

    Returns:
        Dict[str, str]: Словарь, содержащий сообщение, токен и хеш.
    """
    ...
```

**Назначение**: Создает словарь с полезной нагрузкой (payload) для запроса.

**Параметры**:
- `message` (str): Текст сообщения для отправки.

**Возвращает**:
- `Dict[str, str]`: Словарь, содержащий сообщение, токен и хеш.

**Как работает функция**:

1. **Кодирование сообщения**: Функция кодирует сообщение в байты.
2. **Вычисление хеша**: Вычисляет хеш SHA256 от конкатенации закодированного токена 'abc' и закодированного сообщения.
3. **Создание payload**: Создает словарь, содержащий сообщение, токен 'abc' и вычисленный хеш.
4. **Возврат payload**: Функция возвращает созданный словарь с полезной нагрузкой.

**ASCII Flowchart**:

```
Кодирование сообщения в байты
│
└──> Вычисление хеша SHA256 от конкатенации токена и сообщения
│
└──> Создание словаря с сообщением, токеном и хешем
│
└──> Возврат словаря с полезной нагрузкой
```

**Примеры**:

```python
# Пример использования
payload = _create_payload("Hello, world!")
print(payload)
#Пример вывода: {'message': 'Hello, world!', 'token': 'abc', 'hash': 'b4dd9976c3899695c7746dca49f59ca4603cb8404fca4ca14358ea4918c1880f'}