# Модуль `Yqcloud.py`

## Обзор

Модуль предназначен для взаимодействия с провайдером Yqcloud, предоставляющим доступ к модели `gpt-3.5-turbo`. Он содержит функции для отправки запросов к API Yqcloud и получения ответов в потоковом режиме.

## Подробней

Модуль использует библиотеку `requests` для выполнения HTTP-запросов к API Yqcloud.  Он поддерживает потоковую передачу данных, что позволяет получать ответы от модели в режиме реального времени. Модуль определяет функцию `_create_completion`, которая формирует запрос к API Yqcloud и обрабатывает полученные ответы.

## Функции

### `_create_completion`

```python
def _create_completion(model: str, messages: list, stream: bool, **kwargs):
    """Функция отправляет запрос к API Yqcloud и возвращает ответ в потоковом режиме.

    Args:
        model (str): Название модели, используемой для генерации ответа.
        messages (list): Список сообщений, составляющих контекст запроса.
        stream (bool): Флаг, указывающий на необходимость потоковой передачи данных.
        **kwargs: Дополнительные аргументы.

    Returns:
        Generator[str, None, None]: Генератор, возвращающий токены ответа в потоковом режиме.

    Raises:
        Exception: Если возникает ошибка при отправке запроса или обработке ответа.

    Example:
        Пример вызова функции:

        >>> model = 'gpt-3.5-turbo'
        >>> messages = [{'content': 'Hello, how are you?'}]
        >>> stream = True
        >>> for token in _create_completion(model, messages, stream):
        ...     print(token, end='')
        I am doing well, thank you for asking. How can I assist you today?
    """
```

**Назначение**: Функция `_create_completion` отвечает за отправку запроса к API Yqcloud и получение ответа в потоковом режиме.

**Параметры**:
- `model` (str): Название используемой модели (в данном случае `gpt-3.5-turbo`).
- `messages` (list): Список сообщений, представляющих историю разговора.  Содержит контекст для генерации ответа моделью.
- `stream` (bool):  Указывает, следует ли возвращать ответ в потоковом режиме. `True` для потоковой передачи.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API Yqcloud.

**Возвращает**:
- `Generator[str, None, None]`:  Генератор, выдающий части (токены) ответа от API Yqcloud. Позволяет получать ответ постепенно, не дожидаясь его полной генерации.

**Вызывает исключения**:
- `requests.exceptions.RequestException`:  Возникает при проблемах с HTTP-запросом (например, при отсутствии соединения или ошибке на сервере).

**Как работает функция**:

1.  **Формирование заголовков запроса:**
    Создаются HTTP-заголовки для запроса к API Yqcloud. Заголовки включают информацию о браузере пользователя (`user-agent`), источнике запроса (`origin`), и другие параметры.
2.  **Формирование тела запроса (JSON):**
    Создается JSON-структура с данными для отправки в API.  Включает:
    *   `prompt`:  Текст запроса, извлеченный из последнего сообщения в списке `messages`. Добавляется префикс `'always respond in english |'`
    *   `userId`:  Уникальный идентификатор пользователя, генерируемый на основе текущего времени.
    *   `network`:  Указывает на использование сети.
    *   `apikey`:  Ключ API (в данном случае пустая строка).
    *   `system`:  Системные инструкции (в данном случае пустая строка).
    *   `withoutContext`:  Указывает, следует ли использовать контекст разговора (в данном случае `False`).
3.  **Отправка POST-запроса:**
    Используется библиотека `requests` для отправки POST-запроса к API Yqcloud (`https://api.aichatos.cloud/api/generateStream`) с сформированными заголовками и JSON-данными.  Указан параметр `stream=True` для получения ответа в потоковом режиме.
4.  **Обработка потокового ответа:**
    Функция итерируется по содержимому ответа, получая данные небольшими частями (`chunk_size=2046`).
    *   **Проверка токена:**  Для каждого полученного токена выполняется проверка на наличие подстроки `b'always respond in english'`. Это нужно для удаления артефактов.
    *   **Преобразование и выдача токена:**  Если токен проходит проверку, он декодируется из UTF-8 и выдается генератором.

5.  **Генерация токенов:** Функция использует `yield` для возвращения токенов, что позволяет обрабатывать большие объемы данных постепенно, не загружая всю информацию в память сразу.

```
Запрос к API Yqcloud
│
│
▼
Формирование заголовков HTTP
│
│
▼
Формирование JSON тела запроса
│
│
▼
Отправка POST-запроса к 'https://api.aichatos.cloud/api/generateStream'
│
│
▼
Итерация по частям ответа (токены)
│
│
▼
Проверка наличия b'always respond in english' в токене
│
├───► Нет:  Пропустить токен
│
│
└───► Да: Декодирование токена (UTF-8)
│
│
▼
Выдача токена через yield
```

**Примеры**:

```python
# Пример 1: Отправка простого запроса
model = "gpt-3.5-turbo"
messages = [{"content": "Напиши небольшое стихотворение о весне."}]
stream = True

for token in _create_completion(model=model, messages=messages, stream=stream):
    print(token, end="")

# Пример 2: Использование контекста в запросе
model = "gpt-3.5-turbo"
messages = [
    {"content": "Как дела?"},
    {"content": "Что ты умеешь делать?"}
]
stream = True

for token in _create_completion(model=model, messages=messages, stream=stream):
    print(token, end="")