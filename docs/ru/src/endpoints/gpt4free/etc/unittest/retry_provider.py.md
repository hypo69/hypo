# Модуль для тестирования провайдера повторных попыток `retry_provider`

## Обзор

Модуль содержит юнит-тесты для проверки функциональности провайдера повторных попыток `IterListProvider`, используемого в асинхронном клиенте `AsyncClient`. Этот провайдер позволяет перебирать список других провайдеров, пока один из них не вернет успешный результат.

## Подробнее

Этот модуль тестирует различные сценарии использования `IterListProvider`, включая пропуск провайдеров, выбрасывающих исключения, возврат только одного результата из нескольких провайдеров, и обработку случаев, когда провайдер возвращает `None`.  В тестах используются моки провайдеров, чтобы изолировать тесты и контролировать поведение провайдеров.

## Классы

### `TestIterListProvider`

**Описание**: Класс, содержащий набор асинхронных юнит-тестов для `IterListProvider`.

**Принцип работы**:
Класс наследуется от `unittest.IsolatedAsyncioTestCase` и содержит несколько асинхронных тестов, которые проверяют различные аспекты работы `IterListProvider`. Каждый тест создает экземпляр `AsyncClient` с `IterListProvider`, настроенным с разными моками провайдеров, а затем выполняет запрос к API чата и проверяет результат.

**Методы**:

- `test_skip_provider`: Проверяет, что `IterListProvider` пропускает провайдеров, которые выбрасывают исключения, и использует следующий провайдер в списке.
- `test_only_one_result`: Проверяет, что `IterListProvider` возвращает только один результат, даже если несколько провайдеров возвращают успешные результаты.
- `test_stream_skip_provider`: Проверяет, что `IterListProvider` пропускает провайдеров, которые выбрасывают исключения при потоковой передаче, и использует следующий провайдер в списке.
- `test_stream_only_one_result`: Проверяет, что при потоковой передаче `IterListProvider` возвращает чанки только от одного провайдера.
- `test_skip_none`: Проверяет, что `IterListProvider` пропускает провайдеров, которые возвращают `None`, и использует следующий провайдер в списке.
- `test_stream_skip_none`: Проверяет, что `IterListProvider` пропускает провайдеров, которые возвращают `None` при потоковой передаче, и использует следующий провайдер в списке.

## Функции

### `test_skip_provider`

```python
    async def test_skip_provider(self):
        """
        Проверяет, что `IterListProvider` пропускает провайдеров, которые выбрасывают исключения, и использует следующий провайдер в списке.
        """
```

**Как работает функция**:

1. **Создание клиента**: Создается экземпляр `AsyncClient` с `IterListProvider`, который настроен на использование `RaiseExceptionProviderMock` (который выбрасывает исключение) и `YieldProviderMock` (который возвращает успешный результат).
2. **Выполнение запроса**: Выполняется асинхронный запрос к API чата с использованием `client.chat.completions.create`.
3. **Проверка результата**: Проверяется, что возвращенный результат является экземпляром `ChatCompletion` и что содержимое сообщения равно "Hello", что указывает на то, что был использован `YieldProviderMock`.

### `test_only_one_result`

```python
    async def test_only_one_result(self):
        """
        Проверяет, что `IterListProvider` возвращает только один результат, даже если несколько провайдеров возвращают успешные результаты.
        """
```

**Как работает функция**:

1. **Создание клиента**: Создается экземпляр `AsyncClient` с `IterListProvider`, который настроен на использование двух экземпляров `YieldProviderMock`.
2. **Выполнение запроса**: Выполняется асинхронный запрос к API чата с использованием `client.chat.completions.create`.
3. **Проверка результата**: Проверяется, что возвращенный результат является экземпляром `ChatCompletion` и что содержимое сообщения равно "Hello", что указывает на то, что был использован один из `YieldProviderMock`.

### `test_stream_skip_provider`

```python
    async def test_stream_skip_provider(self):
        """
        Проверяет, что `IterListProvider` пропускает провайдеров, которые выбрасывают исключения при потоковой передаче, и использует следующий провайдер в списке.
        """
```

**Как работает функция**:

1. **Создание клиента**: Создается экземпляр `AsyncClient` с `IterListProvider`, который настроен на использование `AsyncRaiseExceptionProviderMock` (который выбрасывает исключение) и `YieldProviderMock` (который возвращает успешный результат).
2. **Подготовка сообщений**: Создается список сообщений для отправки в запросе.
3. **Выполнение запроса с потоковой передачей**: Выполняется асинхронный запрос к API чата с использованием `client.chat.completions.create` и `stream=True`.
4. **Проверка чанков**: Перебираются чанки, возвращаемые из потока, и проверяется, что каждый чанк является экземпляром `ChatCompletionChunk` и что содержимое каждого чанка является строкой.

### `test_stream_only_one_result`

```python
    async def test_stream_only_one_result(self):
        """
        Проверяет, что при потоковой передаче `IterListProvider` возвращает чанки только от одного провайдера.
        """
```

**Как работает функция**:

1. **Создание клиента**: Создается экземпляр `AsyncClient` с `IterListProvider`, который настроен на использование двух экземпляров `YieldProviderMock`.
2. **Подготовка сообщений**: Создается список сообщений для отправки в запросе.
3. **Выполнение запроса с потоковой передачей**: Выполняется асинхронный запрос к API чата с использованием `client.chat.completions.create` и `stream=True`.
4. **Сбор чанков**: Чанки, возвращаемые из потока, собираются в список `response_list`.
5. **Проверка количества чанков и содержимого**: Проверяется, что количество чанков равно 3 и что содержимое каждого чанка равно "You ".

### `test_skip_none`

```python
    async def test_skip_none(self):
        """
        Проверяет, что `IterListProvider` пропускает провайдеров, которые возвращают `None`, и использует следующий провайдер в списке.
        """
```

**Как работает функция**:

1. **Создание клиента**: Создается экземпляр `AsyncClient` с `IterListProvider`, который настроен на использование `YieldNoneProviderMock` (который возвращает `None`) и `YieldProviderMock` (который возвращает успешный результат).
2. **Выполнение запроса**: Выполняется асинхронный запрос к API чата с использованием `client.chat.completions.create`.
3. **Проверка результата**: Проверяется, что возвращенный результат является экземпляром `ChatCompletion` и что содержимое сообщения равно "Hello", что указывает на то, что был использован `YieldProviderMock`.

### `test_stream_skip_none`

```python
    async def test_stream_skip_none(self):
        """
        Проверяет, что `IterListProvider` пропускает провайдеров, которые возвращают `None` при потоковой передаче, и использует следующий провайдер в списке.
        """
```

**Как работает функция**:

1. **Создание клиента**: Создается экземпляр `AsyncClient` с `IterListProvider`, который настроен на использование `YieldNoneProviderMock` (который возвращает `None`) и `YieldProviderMock` (который возвращает успешный результат).
2. **Выполнение запроса с потоковой передачей**: Выполняется асинхронный запрос к API чата с использованием `client.chat.completions.create` и `stream=True`.
3. **Сбор чанков**: Чанки, возвращаемые из потока, собираются в список `response_list`.
4. **Проверка количества чанков и содержимого**: Проверяется, что количество чанков равно 2 и что содержимое каждого чанка равно "Hello".