# Модуль `service.py`

## Обзор

Модуль `service.py` содержит функции для получения и преобразования поставщиков и моделей, используемых в проекте `hypotez`. Он обеспечивает выбор модели и поставщика на основе входных параметров, обрабатывает ошибки, связанные с отсутствием поставщиков или моделей, а также проверяет поддержку потоковой передачи данных.

## Подробнее

Этот модуль является важной частью инфраструктуры `gpt4free`, поскольку он определяет, какие поставщики и модели будут использоваться для генерации ответов. Он также обрабатывает различные сценарии, такие как отсутствие поставщика для заданной модели или попытка использовать потоковую передачу с поставщиком, который ее не поддерживает.

## Функции

### `convert_to_provider`

```python
def convert_to_provider(provider: str) -> ProviderType:
    """Преобразует строку с именем поставщика в объект поставщика.

    Args:
        provider (str): Строка с именем поставщика или список поставщиков, разделенных пробелами.

    Returns:
        ProviderType: Объект поставщика.

    Raises:
        ProviderNotFoundError: Если поставщик не найден.

    Как работает функция:
    1. Проверяет, содержит ли строка `provider` пробелы. Если да, разбивает строку на список имен поставщиков.
    2. Преобразует каждый элемент списка в объект поставщика, используя `ProviderUtils.convert`.
    3. Если список поставщиков пуст, вызывает исключение `ProviderNotFoundError`.
    4. Если в строке `provider` нет пробелов, пытается преобразовать ее непосредственно в объект поставщика, используя `ProviderUtils.convert`.
    5. Если преобразование не удалось, вызывает исключение `ProviderNotFoundError`.
    6. Возвращает объект поставщика.

    ASCII flowchart:
    Начало
    │
    ├─── Проверка наличия пробелов в `provider` ───> Есть пробелы?
    │   └─── Да ───> Разбить строку на список поставщиков
    │   │            └─── Преобразовать каждый элемент списка в объект поставщика
    │   │            └─── Список поставщиков пуст? ───> Да ───> Вызвать исключение `ProviderNotFoundError`
    │   └─── Нет ───> Преобразовать строку `provider` в объект поставщика
    │                    └─── Преобразование не удалось? ───> Да ───> Вызвать исключение `ProviderNotFoundError`
    │
    └─── Возврат объекта поставщика
    │
    Конец

    Примеры:
    - `convert_to_provider("Gemini")`
    - `convert_to_provider("Bard")`
    - `convert_to_provider("Gemini Bard")`
    """
```

### `get_model_and_provider`

```python
def get_model_and_provider(model: Union[Model, str],
                           provider: Union[ProviderType, str, None],
                           stream: bool,
                           ignore_working: bool = False,
                           ignore_stream: bool = False,
                           logging: bool = True,
                           has_images: bool = False) -> tuple[str, ProviderType]:
    """Извлекает модель и поставщика на основе входных параметров.

    Args:
        model (Union[Model, str]): Модель для использования, либо объект, либо строковый идентификатор.
        provider (Union[ProviderType, str, None]): Поставщик для использования, либо объект, строковый идентификатор, либо None.
        stream (bool): Указывает, следует ли выполнять операцию как поток.
        ignore_working (bool, optional): Если True, игнорирует рабочее состояние поставщика. По умолчанию False.
        ignore_stream (bool, optional): Если True, игнорирует возможность потоковой передачи поставщика. По умолчанию False.
        logging (bool, optional): Логировать ли использование поставщика и модели. По умолчанию True.
        has_images (bool, optional): Указывает, есть ли изображения. По умолчанию False.

    Returns:
        tuple[str, ProviderType]: Кортеж, содержащий имя модели и тип поставщика.

    Raises:
        ProviderNotFoundError: Если поставщик не найден.
        ModelNotFoundError: Если модель не найдена.
        ProviderNotWorkingError: Если поставщик не работает.
        StreamNotSupportedError: Если потоковая передача не поддерживается поставщиком.

    Как работает функция:
    1. Проверяет и обновляет версию, если `debug.version_check` имеет значение True.
    2. Преобразует входные параметры `provider` и `model` в соответствующие объекты, если они представлены строками.
    3. Если `provider` не указан, определяет модель и поставщика по умолчанию на основе флага `has_images`.
    4. Если модель передана строкой, пытается найти ее в `ModelUtils.convert`.
    5. Если поставщик не найден, вызывает исключение `ProviderNotFoundError`.
    6. Проверяет, работает ли поставщик, и вызывает исключение `ProviderNotWorkingError`, если это не так.
    7. Если используется `BaseRetryProvider`, фильтрует список поставщиков, оставляя только работающие.
    8. Проверяет, поддерживает ли поставщик потоковую передачу, и вызывает исключение `StreamNotSupportedError`, если это не так.
    9. Регистрирует используемого поставщика и модель, если включено логирование.
    10. Возвращает кортеж, содержащий имя модели и тип поставщика.

    ASCII flowchart:
    Начало
    │
    ├─── Проверка версии ───> Обновление версии (если необходимо)
    │
    ├─── Преобразование `provider` и `model` в объекты (если строки)
    │
    ├─── `provider` не указан? ───> Да ───> Определение модели и поставщика по умолчанию
    │                                      │
    │                                      └─── Модель передана строкой? ───> Поиск модели в `ModelUtils.convert`
    │
    ├─── Поставщик не найден? ───> Да ───> Вызвать исключение `ProviderNotFoundError`
    │
    ├─── Поставщик не работает? ───> Да ───> Вызвать исключение `ProviderNotWorkingError`
    │
    ├─── Используется `BaseRetryProvider`? ───> Да ───> Фильтрация списка поставщиков
    │
    ├─── Поставщик не поддерживает потоковую передачу? ───> Да ───> Вызвать исключение `StreamNotSupportedError`
    │
    ├─── Логирование ───> Регистрация используемого поставщика и модели
    │
    └─── Возврат кортежа (имя модели, тип поставщика)
    │
    Конец

    Примеры:
    - `get_model_and_provider(model="gemini", provider="Gemini", stream=False)`
    - `get_model_and_provider(model=Model.CHAT, provider=ProviderType.OpenAI, stream=True)`
    """
```

### `get_last_provider`

```python
def get_last_provider(as_dict: bool = False) -> Union[ProviderType, dict[str, str], None]:
    """Извлекает последнего использованного поставщика.

    Args:
        as_dict (bool, optional): Если True, возвращает информацию о поставщике в виде словаря. По умолчанию False.

    Returns:
        Union[ProviderType, dict[str, str], None]: Последний использованный поставщик, либо объект, либо словарь.

    Как работает функция:
    1. Получает последнего использованного поставщика из `debug.last_provider`.
    2. Если последний поставщик является экземпляром `BaseRetryProvider`, получает его последнего поставщика.
    3. Если `as_dict` имеет значение True, возвращает информацию о поставщике в виде словаря, содержащего имя, URL, модель и метку.
    4. В противном случае возвращает объект поставщика.

    ASCII flowchart:
    Начало
    │
    ├─── Получение последнего поставщика из `debug.last_provider`
    │
    ├─── Последний поставщик является `BaseRetryProvider`? ───> Да ───> Получение последнего поставщика из `BaseRetryProvider`
    │
    ├─── `as_dict` == True? ───> Да ───> Возврат информации о поставщике в виде словаря
    │
    └─── Возврат объекта поставщика
    │
    Конец

    Примеры:
    - `get_last_provider()`
    - `get_last_provider(as_dict=True)`
    """