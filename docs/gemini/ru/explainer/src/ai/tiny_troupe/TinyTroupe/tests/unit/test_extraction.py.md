## АНАЛИЗ КОДА: `test_extraction.py`

### 1. <алгоритм>

**Блок-схема работы тестов:**

```mermaid
graph LR
    A[Начало] --> B{Фикстура exporter()};
    B --> C[test_export_json(exporter)];
    C --> D{Создание JSON данных};
    D --> E[exporter.export(json)];
    E --> F{Проверка существования JSON файла};
    F --> G{Чтение JSON файла};
    G --> H{Сравнение данных};
    H --> I[test_export_text(exporter)];
     I --> J{Создание текстовых данных};
    J --> K[exporter.export(text)];
    K --> L{Проверка существования текстового файла};
    L --> M{Чтение текстового файла};
    M --> N{Сравнение данных};
    N --> O[test_export_docx(exporter)];
    O --> P{Создание Markdown данных};
    P --> Q[exporter.export(docx)];
    Q --> R{Проверка существования DOCX файла};
    R --> S{Чтение DOCX файла};
    S --> T{Проверка содержания и форматирования};
    T --> U[test_normalizer()];
    U --> V{Определение списка концепций};
    V --> W[Создание Normalizer];
    W --> X{Проверка размера нормализованных элементов};
    X --> Y{Генерация случайных наборов};
    Y --> Z{Цикл нормализации наборов};
    Z --> AA{Нормализация};
    AA --> AB{Лог и печать нормализованного понятия};
    AB --> AC{Проверка размера нормализованных наборов};
    AC --> AD{Проверка наличия элементов в `normalizing_map`};
    AD --> AE{Проверка размера кеша};
    AE --> AF[Конец];
```

**Примеры:**

*   **`test_export_json(exporter)`**:
    1.  Создает `artifact_data` (словарь) с данными для экспорта.
    2.  Вызывает `exporter.export` с параметрами `target_format="json"`.
    3.  Проверяет, существует ли файл `test_artifact.json`.
    4.  Считывает данные из файла и сравнивает с оригинальными данными.
*   **`test_export_text(exporter)`**:
    1.  Создает `artifact_data` (строка) с текстом для экспорта.
    2.  Вызывает `exporter.export` с параметрами `target_format="txt"`.
    3.  Проверяет, существует ли файл `test_artifact.txt`.
    4.  Считывает текст из файла и сравнивает с оригинальным текстом.
*   **`test_export_docx(exporter)`**:
    1.  Создает `artifact_data` (строка) с Markdown текстом для экспорта.
    2.  Вызывает `exporter.export` с параметрами `target_format="docx"`.
    3.  Проверяет, существует ли файл `test_artifact.docx`.
    4.  Считывает текст из документа, проверяет наличие исходного контента (но без markdown разметки).
*   **`test_normalizer()`**:
    1.  Создает список `concepts`.
    2.  Создает экземпляр `Normalizer`.
    3.  Проверяет количество нормализованных элементов.
    4.  Создает 5 случайных выборок по 15 элементов из `concepts`.
    5.  Проходит циклом по каждой выборке и нормализует, проверяя результат на корректность.
    6.  Проверяет, что cache пополняется, но не убывает.

### 2. <mermaid>

```mermaid
flowchart TD
    subgraph Фикстура exporter()
        A[ArtifactExporter]
    end
    
    subgraph test_export_json(exporter)
        B[Создание JSON данных]
        C[exporter.export(json)]
        D[Проверка существования JSON файла]
        E[Чтение JSON файла]
        F[Сравнение данных]
    end
    
    subgraph test_export_text(exporter)
        G[Создание текстовых данных]
        H[exporter.export(text)]
        I[Проверка существования текстового файла]
        J[Чтение текстового файла]
        K[Сравнение данных]
    end
    
    subgraph test_export_docx(exporter)
        L[Создание Markdown данных]
        M[exporter.export(docx)]
        N[Проверка существования DOCX файла]
        O[Чтение DOCX файла]
         P[Проверка содержания и форматирования]
    end
    
   subgraph test_normalizer()
        Q[Определение списка концепций]
        R[Создание Normalizer]
        S[Проверка размера нормализованных элементов]
        T[Генерация случайных наборов]
        U[Цикл нормализации наборов]
        V[Нормализация]
        W[Лог и печать нормализованного понятия]
        X[Проверка размера нормализованных наборов]
        Y[Проверка наличия элементов в normalizing_map]
        Z[Проверка размера кеша]
    end
        
    A --> B
    B --> C
    C --> D
    D --> E
    E --> F
    
    F --> G
    G --> H
    H --> I
    I --> J
    J --> K
    
    K --> L
     L --> M
    M --> N
    N --> O
    O --> P
    
    P --> Q
    Q --> R
    R --> S
    S --> T
    T --> U
    U --> V
    V --> W
    W --> X
    X --> Y
    Y --> Z
```

**Объяснение зависимостей:**

1.  `ArtifactExporter`:  Класс, ответственный за экспорт артефактов в различные форматы. Используется во всех функциях, тестирующих экспорт.
2.  `Normalizer`: Класс для нормализации текстовых концептов, используется в `test_normalizer`.
3.  `pytest`: Фреймворк для тестирования, используемый для создания фикстуры `exporter` и запуска тестов.
4.  `os`: Модуль для работы с операционной системой, используется для проверки существования файлов.
5.  `json`: Модуль для работы с JSON, используется для экспорта и проверки JSON файлов.
6.  `docx`: Модуль для работы с docx, используется для экспорта и чтения docx файлов.
7.  `random`: Модуль для генерации случайных чисел, используется при проверке Normalizer.
8.  `logging`: Модуль для логирования, используется для отладки процесса нормализации.
9.  `sys`: Модуль для взаимодействия с интерпретатором Python, используется для добавления путей к проекту.
10. `testing_utils`: Самописный модуль (путь к нему добавляется через `sys.path`), который не используется в данном конкретном файле, однако он импортируется.
11. `utils`: Самописный модуль (путь к нему добавляется через `sys.path`), который не используется в данном конкретном файле, однако он импортируется.

### 3. <объяснение>

**Импорты:**

*   `pytest`: Используется для создания тестовой среды и запуска тестов.
*   `os`: Предоставляет функции для взаимодействия с операционной системой, например, для проверки существования файлов.
*   `json`:  Используется для работы с JSON-данными (сериализация и десериализация), для экспорта и сравнения.
*   `random`: Для генерации случайных данных, в частности для создания тестовых наборов для нормализации.
*   `logging`: Для ведения журнала выполнения, позволяет отслеживать ход работы, помогает отлавливать ошибки.
*   `sys`: Для добавления путей к модулям проекта в `sys.path`.
*   `testing_utils`: Модуль с вспомогательными функциями для тестирования, но он не используется напрямую в данном файле.
*   `tinytroupe.extraction`: Импортирует классы `ArtifactExporter` и `Normalizer` из модуля `extraction` пакета `tinytroupe`.
*   `tinytroupe.utils`: Импортируется модуль `utils`, который не используется в данном файле.

**Классы:**

*   `ArtifactExporter`:
    *   Роль: Экспортирует данные в различные форматы (JSON, text, docx).
    *   Атрибуты: `base_output_folder` (путь к папке экспорта).
    *   Методы: `export(artifact_name, artifact_data, content_type, content_format, target_format)`: принимает имя артефакта, данные, тип контента, формат контента, целевой формат и сохраняет их в файл.
*   `Normalizer`:
    *   Роль:  Нормализует текстовые концепции.
    *   Атрибуты: `normalized_elements`, `normalizing_map`.
    *   Методы: `normalize(concepts)`: принимает список концепций для нормализации.

**Функции:**

*   `exporter()`:
    *   Аргументы: Нет.
    *   Возвращаемое значение: Экземпляр класса `ArtifactExporter` с папкой для экспорта `"./test_exports"`.
    *   Назначение: Фикстура для создания экземпляра `ArtifactExporter` для каждого теста.
*   `test_export_json(exporter)`:
    *   Аргументы: Экземпляр класса `ArtifactExporter` (из фикстуры `exporter()`).
    *   Возвращаемое значение: Нет.
    *   Назначение: Тестирует экспорт JSON-файла.
*   `test_export_text(exporter)`:
    *   Аргументы: Экземпляр класса `ArtifactExporter` (из фикстуры `exporter()`).
    *   Возвращаемое значение: Нет.
    *   Назначение: Тестирует экспорт текстового файла.
*  `test_export_docx(exporter)`:
    *   Аргументы: Экземпляр класса `ArtifactExporter` (из фикстуры `exporter()`).
    *   Возвращаемое значение: Нет.
    *   Назначение: Тестирует экспорт docx файла.
*   `test_normalizer()`:
    *   Аргументы: Нет.
    *   Возвращаемое значение: Нет.
    *   Назначение: Тестирует нормализатор текстовых концепций.

**Переменные:**

*   `artifact_data`: Содержит данные для экспорта (различного типа).
*   `exported_data`: Содержит данные, считанные из экспортированных файлов.
*   `concepts`: Список текстовых концепций для нормализации.
*   `normalizer`: Экземпляр класса `Normalizer`.
*   `random_concepts_buckets`: Список случайных выборок концепций.
*   `init_cache_size` : размер кеша до начала нормализации
*    `next_cache_size`: размер кеша после нормализации

**Потенциальные ошибки и улучшения:**

1.  **Жестко заданные пути:** Пути к файлам, такие как `./test_exports`, лучше вынести в переменные окружения или параметры конфигурации, для большей гибкости.
2.  **Отсутствие обработки ошибок:** В коде не предусмотрена обработка исключений при записи/чтении файлов, что может привести к неожиданному поведению в случае ошибок.
3.  **Дублирование кода:** Логика проверки существования файла и чтения данных повторяется в нескольких тестах. Можно создать общую функцию для этого.
4.  **Тестирование Normalizer:** Для нормализатора проверяется только размер и корректность заполнения кеша. Не проверяется, насколько хорошо он нормализует, и что именно он возвращает.
5.  **Зависимость от Docx:** В тесте `test_export_docx` есть зависимость от библиотеки `python-docx`, что является избыточным, так как тест проверяет корректность переноса Markdown форматирования в docx, но не работоспособность библиотеки.
6.  **Ограниченность тестов:** В файле отсутствуют негативные тесты, проверяющие обработку ошибок и невалидных входных данных.

**Взаимосвязь с другими частями проекта:**

*   `ArtifactExporter` и `Normalizer` используются в других частях проекта, где требуется экспорт данных и нормализация текста.
*   `testing_utils` содержит общие функции, которые могут быть использованы в других тестах.
*   `utils` может содержать вспомогательные функции, необходимые для работы модулей `extraction`.