# Модуль `user_router`

## Обзор

Модуль `user_router` предназначен для обработки сообщений и запросов обратного вызова (callback query) от пользователей в Telegram-боте. Он содержит обработчики для различных команд и действий пользователя, таких как старт бота, просмотр информации о магазине, профиля пользователя и истории покупок.

## Подробней

Модуль использует библиотеку `aiogram` для работы с Telegram API и `SQLAlchemy` для взаимодействия с базой данных. Он определяет роутер (`user_router`), который регистрирует обработчики для различных событий. Обработчики используют DAO (Data Access Object) для выполнения операций с базой данных, таких как поиск, добавление и получение информации о пользователях и их покупках.

## Классы

В данном модуле классы отсутствуют.

## Функции

### `cmd_start`

```python
async def cmd_start(message: Message, session_with_commit: AsyncSession):
    """Обработчик команды `/start`.

    Args:
        message (Message): Объект сообщения от пользователя.
        session_with_commit (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных с возможностью коммита изменений.

    Returns:
        Awaitable[Message]: Отправляет пользователю приветственное сообщение и основную клавиатуру.

    Raises:
        Не вызывает исключений напрямую.
    """
    ...
```

**Как работает функция**:
1. Функция извлекает `user_id` из объекта `message`.
2. Использует `UserDAO.find_one_or_none` для поиска пользователя в базе данных по `telegram_id`.
3. Если пользователь найден, отправляет приветственное сообщение с использованием `main_user_kb`.
4. Если пользователь не найден, создает объект `UserModel` с данными пользователя и добавляет его в базу данных с помощью `UserDAO.add`.
5. Отправляет пользователю сообщение с благодарностью за регистрацию и основную клавиатуру.

**Параметры**:
- `message` (Message): Объект сообщения от пользователя. Содержит информацию о пользователе, отправившем команду, и текст команды.
- `session_with_commit` (AsyncSession): Асинхровая сессия SQLAlchemy, связанная с базой данных. Используется для выполнения запросов к базе данных.

**Возвращает**:
- `Awaitable[Message]`: Отправляет пользователю приветственное сообщение и основную клавиатуру.

**Примеры**:

```python
# Пример вызова функции (неявно вызывается aiogram при получении команды /start)
# await cmd_start(message, session_with_commit)
```

### `page_home`

```python
async def page_home(call: CallbackQuery):
    """Обработчик callback query с данными "home".

    Args:
        call (CallbackQuery): Объект callback query от пользователя.

    Returns:
        Awaitable[Message]: Отправляет пользователю приветственное сообщение и основную клавиатуру.

    Raises:
        Не вызывает исключений напрямую.
    """
    ...
```

**Как работает функция**:
1. Функция отвечает на callback query с текстом "Главная страница".
2. Отправляет пользователю приветственное сообщение с использованием `main_user_kb`.

**Параметры**:
- `call` (CallbackQuery): Объект callback query от пользователя. Содержит информацию о пользователе, вызвавшем callback, и данные callback query.

**Возвращает**:
- `Awaitable[Message]`: Отправляет пользователю приветственное сообщение и основную клавиатуру.

**Примеры**:

```python
# Пример вызова функции (неявно вызывается aiogram при получении callback query с data="home")
# await page_home(call)
```

### `page_about`

```python
async def page_about(call: CallbackQuery):
    """Обработчик callback query с данными "about".

    Args:
        call (CallbackQuery): Объект callback query от пользователя.

    Returns:
        Awaitable[Message]: Отправляет пользователю информацию о магазине.

    Raises:
        Не вызывает исключений напрямую.
    """
    ...
```

**Как работает функция**:
1. Функция отвечает на callback query с текстом "О магазине".
2. Отправляет пользователю текстовое сообщение с информацией о магазине.

**Параметры**:
- `call` (CallbackQuery): Объект callback query от пользователя. Содержит информацию о пользователе, вызвавшем callback, и данные callback query.

**Возвращает**:
- `Awaitable[Message]`: Отправляет пользователю информацию о магазине.

**Примеры**:

```python
# Пример вызова функции (неявно вызывается aiogram при получении callback query с data="about")
# await page_about(call)
```

### `page_about` (my_profile)

```python
async def page_about(call: CallbackQuery, session_without_commit: AsyncSession):
    """Обработчик callback query с данными "my_profile".

    Args:
        call (CallbackQuery): Объект callback query от пользователя.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных без возможности коммита изменений.

    Returns:
        Awaitable[Message]: Отправляет пользователю информацию о его профиле и статистику покупок.

    Raises:
        Не вызывает исключений напрямую.
    """
    ...
```

**Как работает функция**:
1. Функция отвечает на callback query с текстом "Профиль".
2. Использует `UserDAO.get_purchase_statistics` для получения статистики покупок пользователя.
3. Формирует текстовое сообщение в зависимости от наличия покупок.
4. Если покупок нет, отправляет сообщение об отсутствии покупок и предлагает открыть каталог.
5. Если покупки есть, отправляет сообщение с информацией о количестве покупок и общей сумме, а также предлагает просмотреть детали покупок.

**Параметры**:
- `call` (CallbackQuery): Объект callback query от пользователя. Содержит информацию о пользователе, вызвавшем callback, и данные callback query.
- `session_without_commit` (AsyncSession): Асинхровая сессия SQLAlchemy, связанная с базой данных. Используется для выполнения запросов к базе данных.

**Возвращает**:
- `Awaitable[Message]`: Отправляет пользователю информацию о его профиле и статистику покупок.

**Примеры**:

```python
# Пример вызова функции (неявно вызывается aiogram при получении callback query с data="my_profile")
# await page_about(call, session_without_commit)
```

### `page_user_purchases`

```python
async def page_user_purchases(call: CallbackQuery, session_without_commit: AsyncSession):
    """Обработчик callback query с данными "purchases".

    Args:
        call (CallbackQuery): Объект callback query от пользователя.
        session_without_commit (AsyncSession): Асинхровая сессия SQLAlchemy для работы с базой данных без возможности коммита изменений.

    Returns:
        Awaitable[Message]: Отправляет пользователю информацию о его покупках.

    Raises:
        Не вызывает исключений напрямую.
    """
    ...
```

**Как работает функция**:
1. Функция отвечает на callback query с текстом "Мои покупки".
2. Пытается удалить предыдущее сообщение пользователя.
3. Использует `UserDAO.get_purchased_products` для получения списка покупок пользователя.
4. Если покупок нет, отправляет сообщение об отсутствии покупок и предлагает открыть каталог.
5. Если покупки есть, для каждой покупки формирует текстовое сообщение с информацией о товаре и, если товар включает файл, отправляет файл с текстом.
6. Отправляет пользователю сообщение с благодарностью за доверие.

**Параметры**:
- `call` (CallbackQuery): Объект callback query от пользователя. Содержит информацию о пользователе, вызвавшем callback, и данные callback query.
- `session_without_commit` (AsyncSession): Асинхровая сессия SQLAlchemy, связанная с базой данных. Используется для выполнения запросов к базе данных.

**Возвращает**:
- `Awaitable[Message]`: Отправляет пользователю информацию о его покупках.

**Примеры**:

```python
# Пример вызова функции (неявно вызывается aiogram при получении callback query с data="purchases")
# await page_user_purchases(call, session_without_commit)