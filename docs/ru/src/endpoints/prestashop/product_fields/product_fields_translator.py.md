# Модуль перевода полей товара на языки клиентской базы данных

## Обзор

Модуль `product_fields_translator.py` предназначен для перевода полей товара на языки, соответствующие клиентской базе данных. Он содержит функции для приведения идентификаторов языков в соответствие со схемой клиентской базы данных PrestaShop, а также для получения и вставки переводов из/в таблицу переводов.

## Подробней

Модуль предназначен для работы с мультиязычными полями товаров, полученными с сайта поставщика. Он обеспечивает соответствие идентификаторов языков в этих полях со схемой языков, используемой в базе данных клиента PrestaShop. Это необходимо, так как идентификаторы языков могут различаться в зависимости от настроек PrestaShop.

## Функции

### `rearrange_language_keys`

```python
def rearrange_language_keys(presta_fields_dict: dict, client_langs_schema: dict | List[dict], page_lang: str) -> dict:
    """Функция обновляет идентификатор языка в словаре presta_fields_dict на соответствующий идентификатор
    из схемы клиентских языков при совпадении языка страницы.

    Args:
        presta_fields_dict (dict): Словарь полей товара.
        page_lang (str): Язык страницы.
        client_langs_schema (list | dict): Схема языков клиента.

    Returns:
        dict: Обновленный словарь presta_fields_dict.
    """
    ...
```

**Назначение**: Обновление идентификатора языка в словаре полей товара (`presta_fields_dict`) на соответствующий идентификатор из схемы клиентских языков (`client_langs_schema`) при совпадении языка страницы (`page_lang`).

**Как работает функция**:

1.  **Поиск идентификатора языка клиента**:
    *   Функция проходит по схеме языков клиента (`client_langs_schema`), чтобы найти соответствующий идентификатор языка.
    *   Сравнение происходит по полям `locale`, `iso_code` и `language_code` в схеме с языком страницы (`page_lang`).
2.  **Обновление идентификатора языка в полях товара**:
    *   Если идентификатор языка найден, функция проходит по всем полям в словаре `presta_fields_dict`.
    *   Для каждого поля, содержащего данные о языке (ключ `'language'`), обновляется атрибут `'id'` на найденный идентификатор языка клиента.

**Параметры**:

*   `presta_fields_dict` (dict): Словарь полей товара, который требуется обновить.
*   `client_langs_schema` (list | dict): Схема языков клиента, используемая для поиска соответствия языков.
*   `page_lang` (str): Язык страницы, для которого необходимо обновить идентификатор.

**Возвращает**:

*   `dict`: Обновленный словарь `presta_fields_dict` с новыми идентификаторами языков.

### `translate_presta_fields_dict`

```python
def translate_presta_fields_dict (presta_fields_dict: dict, 
                                  client_langs_schema: list | dict, 
                                  page_lang: str = None) -> dict:
    """ @Перевод мультиязычных полей в соответствии со схемой значений `id` языка в базе данных клиента
	    Функция получает на вход заполненный словарь полей. Мультиязычные поля содржат значения,
	    полученные с сайта поставщика в виде словаря 
	    ```
	    {
	\t    'language':[\
	\t\t\t\t\t    {'attrs':{'id':'1'}, 'value':value},\
	\t\t\t\t\t    ]\
	    }\
	    ```\
	    У клиента язык с ключом `id=1` Может быть любым в зависимости от того на каком языке была 
	    изначально установлена PrestaShop. Чаще всего это английский, но это не правило.
	    Точные соответствия я получаю в схеме языков клиента 
	    locator_description
	    Самый быстрый способ узнать схему API языков - набрать в адресной строке браузера
	    https://API_KEY@mypresta.com/api/languages?display=full&io_format=JSON
	  
    @param client_langs_schema `dict` словарь актуальных языков на клиенте
    @param presta_fields_dict `dict` словарь полей товара собранный со страницы поставщика
    @param page_lang `str` язык страницы поставщика в коде en-US, ru-RU, he_HE. 
    Если не задан - функция пытается определить п тексту
    @returns presta_fields_dict переведенный словарь полей товара
    """
    ...
```

**Назначение**: Перевод мультиязычных полей в соответствии со схемой значений `id` языка в базе данных клиента.

**Как работает функция**:

1.  **Переупорядочивание ключей таблицы**:
    *   Вызывается функция `rearrange_language_keys` для обновления идентификаторов языков в соответствии со схемой клиентских языков.
2.  **Поиск существующих переводов**:
    *   Вызывается функция `get_translations_from_presta_translations_table` для получения существующих переводов товара из таблицы переводов.
3.  **Обработка отсутствующих переводов**:
    *   Если переводы для товара отсутствуют в таблице, текущие значения полей добавляются как новые переводы.
4.  **Перевод полей на основе существующих записей**:
    *   Для каждого языка клиента и каждой записи перевода выполняется попытка найти соответствие между кодом языка клиента (`iso_code`) и локалью записи перевода.
    *   Если соответствие найдено, значения полей товара обновляются значениями из записи перевода.
    *   В случае возникновения ошибки логируется сообщение об ошибке с использованием `logger.error`.

**Параметры**:

*   `presta_fields_dict` (dict): Словарь полей товара, собранный со страницы поставщика.
*   `client_langs_schema` (list | dict): Словарь актуальных языков на клиенте.
*   `page_lang` (str, optional): Язык страницы поставщика. Если не задан, функция пытается определить его по тексту. По умолчанию `None`.

**Возвращает**:

*   `dict`: Переведенный словарь полей товара.