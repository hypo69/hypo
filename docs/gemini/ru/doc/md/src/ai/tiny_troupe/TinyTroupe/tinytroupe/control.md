# Модуль `tinytroupe.control`

## Обзор

Этот модуль предоставляет механизмы управления симуляцией, включая инициализацию, остановку, сохранение состояний, добавление агентов, сред и фабрик.  Он поддерживает кэширование состояний симуляции для последующего восстановления и транзакционный контроль.

## Классы

### `Simulation`

**Описание**: Класс `Simulation` управляет всей симуляцией.  Он хранит информацию о агентах, средах, фабриках и текущем состоянии.

**Атрибуты**:

- `id` (str): Идентификатор симуляции. По умолчанию "default".
- `agents` (list): Список агентов в симуляции.
- `name_to_agent` (dict): Словарь, сопоставляющий имена агентов с самими агентами.
- `environments` (list): Список сред в симуляции.
- `factories` (list): Список фабрик в симуляции.
- `name_to_factory` (dict): Словарь, сопоставляющий имена фабрик с самими фабриками.
- `name_to_environment` (dict): Словарь, сопоставляющий имена сред с самими средами.
- `status` (str): Текущее состояние симуляции ("stopped" или "started").
- `cache_path` (str): Путь к файлу кэша. По умолчанию "./tinytroupe-cache-{id}.json".
- `auto_checkpoint` (bool): Автоматически ли создавать контрольные точки после каждой транзакции. По умолчанию `False`.
- `has_unsaved_cache_changes` (bool): Признак наличия несохранённых изменений в кэше.
- `_under_transaction` (bool): Флаг, указывающий, находится ли симуляция в состоянии транзакции.
- `cached_trace` (list): Список состояний симуляции, кэшированных для быстрого восстановления.
- `execution_trace` (list): Список состояний симуляции во время текущей сессии.


**Методы**:

- `begin(cache_path: str = None, auto_checkpoint: bool = False)`: Инициализирует симуляцию.
    - `cache_path` (str, необязательно): Путь к файлу кэша.
    - `auto_checkpoint` (bool, необязательно): Флаг автоматического создания контрольных точек.
- `end()`: Останавливает симуляцию и сохраняет текущее состояние.
- `checkpoint()`: Сохраняет текущее состояние симуляции в кэше.
- `add_agent(agent)`: Добавляет агента в симуляцию.
- `add_environment(environment)`: Добавляет среду в симуляцию.
- `add_factory(factory)`: Добавляет фабрику в симуляцию.
- `_execution_trace_position() -> int`: Возвращает текущую позицию в трассе выполнения.
- `_function_call_hash(self, function_name, *args, **kwargs) -> int`:  Вычисляет хеш для вызова функции.
- `_skip_execution_with_cache()`: Пропускает выполнение, если соответствующее состояние уже кэшировано.
- `_is_transaction_event_cached(event_hash) -> bool`: Проверяет наличие кэшированного состояния для события.
- `_drop_cached_trace_suffix()`: Удаляет часть кэшированной трассы.
- `_add_to_execution_trace(state: dict, event_hash: int, event_output)`: Добавляет состояние в трассу выполнения.
- `_add_to_cache_trace(state: dict, event_hash: int, event_output)`: Добавляет состояние в кэшированную трассу.
- `_load_cache_file(cache_path: str)`: Загружает данные из кэша.
- `_save_cache_file(cache_path: str)`: Сохраняет данные в кэше.
- `begin_transaction()`: Начинает транзакцию.
- `end_transaction()`: Завершает транзакцию.
- `is_under_transaction()`: Проверяет, находится ли симуляция в состоянии транзакции.
- `_clear_communications_buffers()`: Очищает буферы коммуникаций всех агентов и сред.
- `_encode_simulation_state() -> dict`: Кодирует текущее состояние симуляции.
- `_decode_simulation_state(state: dict)`: Декодирует состояние симуляции.


### `Transaction`

**Описание**: Класс `Transaction` управляет транзакционным выполнением функций внутри симуляции.

**Методы**:

- `execute()`: Выполняет функцию в рамках транзакции, учитывая кэширование.
- `_encode_function_output(output) -> dict`: Кодирует результат функции для сохранения в кэше.
- `_decode_function_output(encoded_output: dict)`: Декодирует результат функции из кэша.

## Функции

### `transactional(func)`

**Описание**: Декоратор, делающий функцию транзакционной внутри симуляции.

### `reset()`

**Описание**: Сбрасывает состояние управления симуляцией.

### `_simulation(id="default")`

**Описание**: Возвращает экземпляр `Simulation` по заданному ID.

### `begin(cache_path=None, id="default", auto_checkpoint=False)`

**Описание**: Начинает симуляцию.

### `end(id="default")`

**Описание**: Останавливает симуляцию.

### `checkpoint(id="default")`

**Описание**: Сохраняет текущее состояние симуляции.

### `current_simulation()`

**Описание**: Возвращает текущую симуляцию.

## Исключения

- `ValueError`:  Поднимается при ошибках состояния симуляции, уникальности имен и недопустимых типах.
- `SkipTransaction`: Исключение для пропуска транзакции.
- `CacheOutOfSync`: Поднимается, если кэшированные и текущие данные не синхронизированы.
- `ExecutionCached`: Поднимается, если действие уже кэшировано.