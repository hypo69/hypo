# Модуль для работы с прокси

## Обзор

Модуль предоставляет функциональность для загрузки, парсинга и проверки списка прокси-серверов. Он предназначен для получения актуальных данных о прокси из внешнего источника, их обработки и категоризации по протоколам (HTTP, SOCKS4, SOCKS5), а также проверки их работоспособности.

## Подробнее

Этот модуль играет важную роль в автоматизации задач, требующих анонимности или обхода географических ограничений. Он загружает список прокси из заданного URL, сохраняет его в локальном файле, а затем анализирует этот файл, распределяя прокси по типам протоколов. Кроме того, модуль предоставляет возможность проверки работоспособности каждого прокси-сервера, что позволяет исключить недействительные прокси из дальнейшего использования.

## Функции

### `download_proxies_list`

```python
def download_proxies_list(url: str = url, save_path: Path = proxies_list_path) -> bool:
    """
    Загружает файл по указанному URL и сохраняет его в заданный путь.

    Args:
        url (str): URL файла для загрузки. По умолчанию используется глобальная переменная `url`.
        save_path (Path): Путь для сохранения загруженного файла. По умолчанию используется глобальная переменная `proxies_list_path`.

    Returns:
        bool: `True`, если файл успешно загружен и сохранен, иначе `False`.

    Raises:
        Exception: В случае ошибки при загрузке или сохранении файла.
    """
    ...
```

**Назначение**: Загружает файл со списком прокси-серверов из интернета и сохраняет его локально.

**Параметры**:
- `url` (str): URL-адрес, по которому расположен файл со списком прокси.
- `save_path` (Path): Путь к файлу, в который будет сохранен список прокси.

**Возвращает**:
- `bool`: `True`, если загрузка и сохранение прошли успешно, `False` в противном случае.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при выполнении запроса или записи файла.

**Как работает функция**:

1.  **Инициализация**: Функция принимает URL-адрес и путь для сохранения файла.
2.  **Загрузка файла**: Отправляет HTTP-запрос по указанному URL-адресу для загрузки файла со списком прокси.
3.  **Обработка ответа**: Проверяет статус ответа, чтобы убедиться в успешности запроса.
4.  **Сохранение файла**: Сохраняет содержимое ответа в локальный файл по указанному пути.
5.  **Обработка ошибок**: В случае возникновения ошибок во время загрузки или сохранения файла, функция логирует ошибку и возвращает `False`.

```
    A: Получение URL и пути сохранения
    │
    ├──► B: Отправка HTTP запроса к URL
    │   │
    │   └──► C: Проверка статуса ответа
    │       │
    │       ├──► Успех: D: Сохранение содержимого в файл
    │       │   │
    │       │   └──► E: Логирование успеха и возврат True
    │       │
    │       └──► Ошибка: F: Логирование ошибки и возврат False
    │
    └──► G: Обработка исключений и возврат False
```

**Примеры**:

```python
from pathlib import Path
# Пример использования с параметрами по умолчанию
result = download_proxies_list()
print(f"Результат загрузки: {result}")

# Пример использования с указанием URL и пути сохранения
custom_url = "https://example.com/proxies.txt"
custom_path = Path("/tmp/proxies.txt")
result = download_proxies_list(url=custom_url, save_path=custom_path)
print(f"Результат загрузки: {result}")
```

### `get_proxies_dict`

```python
def get_proxies_dict(file_path: Path = proxies_list_path) -> Dict[str, List[Dict[str, Any]]]:
    """
    Парсит файл с прокси-адресами и распределяет их по категориям.

    Args:
        file_path (Path): Путь к файлу с прокси. По умолчанию используется глобальная переменная `proxies_list_path`.

    Returns:
        Dict[str, List[Dict[str, Any]]]: Словарь с распределёнными по типам прокси.
            Ключи словаря - типы прокси ('http', 'socks4', 'socks5'), значения - списки словарей,
            где каждый словарь содержит информацию о прокси ('protocol', 'host', 'port').

    Raises:
        FileNotFoundError: Если указанный файл не найден.
        Exception: В случае ошибки при парсинге прокси.
    """
    ...
```

**Назначение**: Парсит файл со списком прокси-серверов и распределяет их по категориям (http, socks4, socks5).

**Параметры**:
- `file_path` (Path): Путь к файлу, содержащему список прокси.

**Возвращает**:
- `Dict[str, List[Dict[str, Any]]]: Словарь, где ключи — это типы прокси ("http", "socks4", "socks5"), а значения — списки словарей, содержащих информацию о каждом прокси (протокол, хост, порт).

**Вызывает исключения**:
- `FileNotFoundError`: Если файл с прокси не найден.
- `Exception`: При возникновении ошибки во время парсинга файла.

**Как работает функция**:

1.  **Инициализация**: Функция принимает путь к файлу со списком прокси.
2.  **Загрузка списка прокси**: Вызывает функцию `download_proxies_list` для обновления локального файла со списком прокси.
3.  **Инициализация структуры данных**: Создает словарь `proxies` для хранения прокси, с ключами `http`, `socks4` и `socks5`, каждый из которых содержит пустой список.
4.  **Чтение файла**: Открывает файл и читает его построчно.
5.  **Парсинг каждой строки**: Для каждой строки пытается извлечь протокол, хост и порт, используя регулярное выражение.
6.  **Распределение прокси**: Если строка соответствует формату прокси, информация о прокси добавляется в соответствующий список в словаре `proxies`.
7.  **Обработка ошибок**: В случае возникновения ошибок, функция логирует их и возвращает пустой словарь.

```
    A: Получение пути к файлу
    │
    ├──► B: Загрузка списка прокси (download_proxies_list)
    │
    ├──► C: Инициализация словаря прокси
    │
    ├──► D: Открытие и чтение файла
    │   │
    │   └──► E: Для каждой строки: Попытка извлечь протокол, хост и порт
    │       │
    │       ├──► F: Соответствует: Добавление информации в словарь прокси
    │       │
    │       └──► G: Не соответствует: Следующая строка
    │
    └──► H: Обработка ошибок и возврат словаря
```

**Примеры**:

```python
from pathlib import Path
# Пример использования с параметрами по умолчанию
proxies = get_proxies_dict()
print(f"Полученные прокси: {proxies}")

# Пример использования с указанием пути к файлу
custom_path = Path("/tmp/proxies.txt")
proxies = get_proxies_dict(file_path=custom_path)
print(f"Полученные прокси: {proxies}")
```

### `check_proxy`

```python
def check_proxy(proxy: dict) -> bool:
    """
    Проверяет работоспособность прокси-сервера.
    
    Args:
        proxy (dict): Словарь с данными прокси (host, port, protocol).

    Returns:
        bool: True, если прокси работает, иначе False.

    Raises:
        отсутствуют
    """
    ...
```

**Назначение**: Проверяет, является ли прокси-сервер работоспособным, путем выполнения HTTP-запроса через него.

**Параметры**:
- `proxy` (dict): Словарь, содержащий информацию о прокси-сервере, включая хост, порт и протокол.

**Возвращает**:
- `bool`: `True`, если прокси-сервер работает и возвращает код ответа 200, иначе `False`.

**Как работает функция**:

1.  **Инициализация**: Функция принимает словарь с данными прокси (хост, порт, протокол).
2.  **Выполнение HTTP-запроса**: Пытается выполнить HTTP-запрос к `https://httpbin.org/ip` через указанный прокси-сервер.
3.  **Проверка статуса ответа**: Проверяет код статуса ответа. Если код равен 200, считается, что прокси-сервер работает.
4.  **Обработка исключений**: В случае возникновения ошибок (например, `ProxyError`, `RequestException`), функция логирует ошибку и возвращает `False`.

```
    A: Получение данных прокси
    │
    ├──► B: Выполнение HTTP-запроса через прокси
    │   │
    │   └──► C: Проверка статуса ответа
    │       │
    │       ├──► 200: D: Логирование успеха и возврат True
    │       │
    │       └──► Другой: E: Логирование предупреждения и возврат False
    │
    └──► F: Обработка исключений и возврат False
```

**Примеры**:

```python
# Пример использования
proxy_data = {'protocol': 'http', 'host': '1.2.3.4', 'port': '8080'}
result = check_proxy(proxy_data)
print(f"Прокси работает: {result}")

proxy_data = {'protocol': 'socks5', 'host': '1.2.3.4', 'port': '1080'}
result = check_proxy(proxy_data)
print(f"Прокси работает: {result}")
```