# `tinytroupe/openai_utils.py`

## Обзор

Этот модуль содержит утилиты для взаимодействия с API OpenAI, включая поддержку как OpenAI, так и Azure OpenAI. Он включает в себя классы для отправки сообщений, обработки ответов, подсчета токенов и кэширования запросов.

## Оглавление

- [Обзор](#обзор)
- [Константы](#константы)
- [Классы](#классы)
  - [`LLMCall`](#llmcall)
  - [`OpenAIClient`](#openaiclient)
  - [`AzureClient`](#azureclient)
  - [`InvalidRequestError`](#invalidrequesterror)
  - [`NonTerminalError`](#nonterminalerror)
- [Функции](#функции)
  - [`register_client`](#register_client)
  - [`_get_client_for_api_type`](#_get_client_for_api_type)
  - [`client`](#client)
  - [`force_api_type`](#force_api_type)
  - [`force_api_cache`](#force_api_cache)
  - [`force_default_value`](#force_default_value)

## Константы
Здесь перечислены константы, используемые в модуле:

- `default`: Словарь, содержащий значения параметров по умолчанию.
    - `"model"`: Модель OpenAI по умолчанию, например, `"gpt-4"`.
    - `"max_tokens"`: Максимальное количество токенов для генерации, по умолчанию `1024`.
    - `"temperature"`: Температура для управления креативностью модели, по умолчанию `0.3`.
    - `"top_p"`: Параметр для управления качеством ответа модели, по умолчанию `0`.
    - `"frequency_penalty"`: Параметр для управления повторением ответа, по умолчанию `0.0`.
    - `"presence_penalty"`: Параметр для управления разнообразием ответа, по умолчанию `0.0`.
    - `"timeout"`: Максимальное время ожидания ответа от API, по умолчанию `30.0`.
    - `"max_attempts"`: Максимальное количество попыток запроса к API, по умолчанию `0.0`.
    - `"waiting_time"`: Время ожидания между запросами, по умолчанию `0.5`.
    - `"exponential_backoff_factor"`: Коэффициент для экспоненциального увеличения времени ожидания, по умолчанию `5`.
    - `"embedding_model"`: Модель для получения эмбеддингов текста, по умолчанию `"text-embedding-3-small"`.
    - `"cache_api_calls"`: Флаг для кэширования API вызовов, по умолчанию `False`.
    - `"cache_file_name"`: Имя файла для хранения кэша API вызовов, по умолчанию `"openai_api_cache.pickle"`.

## Классы

### `LLMCall`

**Описание**: Класс, представляющий вызов языковой модели (LLM). Он содержит входные сообщения, конфигурацию модели и вывод модели.

**Методы**:

- `__init__`:
  
  **Описание**: Инициализирует экземпляр `LLMCall` с указанными шаблонами системы и пользователя.
  
  **Параметры**:
    - `system_template_name` (str): Имя шаблона системы.
    - `user_template_name` (Optional[str], optional): Имя шаблона пользователя. По умолчанию `None`.
    - `**model_params`: Дополнительные параметры модели.

- `call`:
  
  **Описание**: Вызывает модель LLM с указанными конфигурациями рендеринга.
  
  **Параметры**:
    - `**rendering_configs`: Конфигурации рендеринга.
  
  **Возвращает**:
    - `str | None`: Содержимое ответа модели или `None`, если ответ не содержит ключа `'content'`.
    
- `__repr__`:
  
  **Описание**: Возвращает строковое представление объекта `LLMCall`.
  
  **Возвращает**:
    - `str`: Строковое представление объекта `LLMCall`.

### `OpenAIClient`

**Описание**: Утилитный класс для взаимодействия с API OpenAI.

**Методы**:

- `__init__`:
  
  **Описание**: Инициализирует экземпляр `OpenAIClient`.
  
  **Параметры**:
    - `cache_api_calls` (bool, optional): Определяет, следует ли кэшировать вызовы API. По умолчанию значение из `default["cache_api_calls"]`.
    - `cache_file_name` (str, optional): Имя файла для кэширования вызовов API. По умолчанию значение из `default["cache_file_name"]`.

- `set_api_cache`:
  
  **Описание**: Включает или отключает кэширование вызовов API.
  
  **Параметры**:
    - `cache_api_calls` (bool): Определяет, следует ли кэшировать вызовы API.
    - `cache_file_name` (str, optional): Имя файла для кэширования вызовов API. По умолчанию значение из `default["cache_file_name"]`.

- `_setup_from_config`:
  
  **Описание**: Настраивает параметры API OpenAI для этого клиента.

- `send_message`:
  
  **Описание**: Отправляет сообщение в API OpenAI и возвращает ответ.
  
  **Параметры**:
    - `current_messages` (list): Список словарей, представляющих историю разговора.
    - `model` (str, optional): Идентификатор модели для генерации ответа. По умолчанию значение из `default["model"]`.
    - `temperature` (float, optional): Контролирует "креативность" ответа. По умолчанию значение из `default["temperature"]`.
    - `max_tokens` (int, optional): Максимальное количество токенов для генерации ответа. По умолчанию значение из `default["max_tokens"]`.
    - `top_p` (float, optional): Контролирует "качество" ответа. По умолчанию значение из `default["top_p"]`.
    - `frequency_penalty` (float, optional): Контролирует "повторение" ответа. По умолчанию значение из `default["frequency_penalty"]`.
    - `presence_penalty` (float, optional): Контролирует "разнообразие" ответа. По умолчанию значение из `default["presence_penalty"]`.
    - `stop` (list, optional): Список строк, при обнаружении которых генерация ответа прекращается. По умолчанию `[]`.
    - `timeout` (float, optional): Максимальное время ожидания ответа от API. По умолчанию значение из `default["timeout"]`.
    - `max_attempts` (int, optional): Максимальное количество попыток генерации ответа. По умолчанию значение из `default["max_attempts"]`.
    - `waiting_time` (float, optional): Время ожидания между запросами. По умолчанию значение из `default["waiting_time"]`.
    - `exponential_backoff_factor` (float, optional): Коэффициент для экспоненциального увеличения времени ожидания. По умолчанию значение из `default["exponential_backoff_factor"]`.
    - `n` (int, optional): Количество ответов модели. По умолчанию `1`.
    - `echo` (bool, optional): Выводить ли входное сообщение в ответе. По умолчанию `False`.
  
  **Возвращает**:
    - `dict | None`: Словарь, представляющий сгенерированный ответ или `None` в случае ошибки.

- `_raw_model_call`:
  
  **Описание**: Вызывает API OpenAI с заданными параметрами.
  
  **Параметры**:
    - `model` (str): Идентификатор модели.
    - `chat_api_params` (dict): Параметры для вызова API.
  
  **Возвращает**:
    - API Response: Ответ от API OpenAI.

- `_raw_model_response_extractor`:
  
  **Описание**: Извлекает ответ из ответа API.
  
  **Параметры**:
    - `response` (API Response): Ответ от API.
  
  **Возвращает**:
    - `dict`: Извлеченный ответ.

- `_count_tokens`:
  
  **Описание**: Подсчитывает количество токенов OpenAI в списке сообщений с использованием tiktoken.
  
  **Параметры**:
    - `messages` (list): Список словарей, представляющих историю разговора.
    - `model` (str): Имя модели для кодирования строки.
  
  **Возвращает**:
    - `int | None`: Количество токенов или `None` в случае ошибки.
    
- `_save_cache`:
  
  **Описание**: Сохраняет кэш API на диск.

- `_load_cache`:
  
  **Описание**: Загружает кэш API с диска.

- `get_embedding`:
  
  **Описание**: Получает векторное представление (эмбеддинг) текста, используя указанную модель.
  
  **Параметры**:
    - `text` (str): Текст, для которого необходимо получить эмбеддинг.
    - `model` (str, optional): Имя модели для получения эмбеддинга. По умолчанию значение из `default["embedding_model"]`.
  
  **Возвращает**:
    - `list`: Эмбеддинг текста.

- `_raw_embedding_model_call`:
  
  **Описание**: Вызывает API OpenAI для получения эмбеддинга текста.
  
  **Параметры**:
    - `text` (str): Текст, для которого необходимо получить эмбеддинг.
    - `model` (str): Имя модели для получения эмбеддинга.
  
  **Возвращает**:
      - API Response: Ответ от API OpenAI.

- `_raw_embedding_model_response_extractor`:
  
  **Описание**: Извлекает эмбеддинг из ответа API.
  
  **Параметры**:
      - `response` (API Response): Ответ от API.
      
  **Возвращает**:
    - `list`: Эмбеддинг.

### `AzureClient`

**Описание**: Класс для взаимодействия с API Azure OpenAI Service.

**Методы**:

- `__init__`:
  
  **Описание**: Инициализирует экземпляр `AzureClient`.
  
    - `cache_api_calls` (bool, optional): Определяет, следует ли кэшировать вызовы API. По умолчанию значение из `default["cache_api_calls"]`.
    - `cache_file_name` (str, optional): Имя файла для кэширования вызовов API. По умолчанию значение из `default["cache_file_name"]`.

- `_setup_from_config`:
  
  **Описание**: Настраивает параметры API Azure OpenAI Service для этого клиента.

- `_raw_model_call`:
  
  **Описание**: Вызывает API Azure OpenAI Service с заданными параметрами.
    - `model` (str): Идентификатор модели.
    - `chat_api_params` (dict): Параметры для вызова API.
  
  **Возвращает**:
    - API Response: Ответ от API Azure OpenAI Service.

### `InvalidRequestError`

**Описание**: Исключение, возникающее при недействительном запросе к API OpenAI.

### `NonTerminalError`

**Описание**: Исключение, возникающее при неспецифической ошибке, но при этом можно повторить запрос.

## Функции

### `register_client`

**Описание**: Регистрирует клиента для данного типа API.

**Параметры**:

  - `api_type` (str): Тип API, для которого мы хотим зарегистрировать клиента.
  - `client`: Клиент для регистрации.

### `_get_client_for_api_type`

**Описание**: Возвращает клиента для заданного типа API.

**Параметры**:

  - `api_type` (str): Тип API, для которого мы хотим получить клиента.
  
**Возвращает**:
  - Возвращает клиент, соответствующий заданному типу API.

**Вызывает исключения**:

  - `ValueError`: Если тип API не поддерживается.

### `client`

**Описание**: Возвращает клиента для настроенного типа API.

**Возвращает**:
  - Клиент, который соответствует типу API, указанному в конфигурации или переопределенному при помощи `force_api_type`.

### `force_api_type`

**Описание**: Принудительно устанавливает использование данного типа API, переопределяя любую другую конфигурацию.

**Параметры**:

  - `api_type` (str): Тип API для использования.

### `force_api_cache`

**Описание**: Принудительно устанавливает использование заданной конфигурации кэша API, переопределяя любую другую конфигурацию.

**Параметры**:

  - `cache_api_calls` (bool): Указывает, кэшировать ли вызовы API.
  - `cache_file_name` (str, optional): Имя файла для кэширования вызовов API. По умолчанию значение из `default["cache_file_name"]`.

### `force_default_value`

**Описание**: Принудительно устанавливает значение конфигурации по умолчанию для заданного ключа, переопределяя любую другую конфигурацию.

**Параметры**:

  - `key` (str): Ключ для переопределения.
  - `value`: Значение, которое необходимо установить для ключа.

**Вызывает исключения**:
   - `ValueError`: Если ключ не является допустимым ключом конфигурации.