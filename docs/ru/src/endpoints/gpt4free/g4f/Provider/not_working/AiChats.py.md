# Модуль AiChats
## Обзор

Модуль `AiChats` предоставляет асинхронный интерфейс для взаимодействия с сервисом ai-chats.org. Он поддерживает как текстовые запросы через модель `gpt-4`, так и запросы на генерацию изображений через модель `dalle`. Модуль использует `aiohttp` для выполнения асинхронных HTTP-запросов и предоставляет результаты в виде асинхронного генератора.

## Подробнее

Модуль предназначен для интеграции с другими частями проекта `hypotez`, требующими функциональности чат-бота или генерации изображений. Он обеспечивает абстракцию от низкоуровневых деталей HTTP-запросов и обработки ответов, предоставляя удобный интерфейс для отправки запросов и получения результатов.

## Классы

### `AiChats`

**Описание**: Класс `AiChats` является асинхронным провайдером и предоставляет методы для создания асинхронных генераторов и выполнения запросов к сервису ai-chats.org.
**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает поддержку асинхронных генераторов.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL сервиса ai-chats.org.
- `api_endpoint` (str): URL для отправки запросов к API сервиса.
- `working` (bool): Флаг, указывающий на работоспособность провайдера (в данном случае `False`).
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`gpt-4`).
- `models` (List[str]): Список поддерживаемых моделей (`gpt-4`, `dalle`).

#### Методы:

- `create_async_generator`: Создает асинхронный генератор для отправки запросов к сервису и получения ответов.
- `create_async`: Отправляет запрос к сервису и возвращает результат.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для отправки запросов к сервису ai-chats.org и получения ответов.

        Args:
            model (str): Модель для использования (`gpt-4` или `dalle`).
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий результаты запроса.

        Raises:
            Exception: В случае ошибки при выполнении запроса.
        """
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор, который отправляет запросы к API ai-chats.org и возвращает ответы. Генератор позволяет обрабатывать ответы по мере их поступления, что особенно полезно для потоковой передачи данных.

**Параметры**:
- `model` (str): Указывает, какую модель использовать для генерации ответа. Может быть `gpt-4` для текстовых ответов или `dalle` для генерации изображений.
- `messages` (Messages): Список сообщений, которые будут отправлены в запросе. Для `gpt-4` используется форматирование prompt, а для `dalle` берется последнее сообщение.
- `proxy` (str, optional): Прокси-сервер для использования при отправке запроса. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в функцию.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который возвращает текстовые ответы или объекты `ImageResponse` в зависимости от используемой модели.

**Вызывает исключения**:
- `Exception`: В случае возникновения ошибок при выполнении HTTP-запроса или обработке ответа от сервера.

**Внутренние функции**:
- Отсутствуют.

**Как работает функция**:

1.  **Подготовка заголовков**: Формируются HTTP-заголовки, необходимые для запроса к API ai-chats.org. Заголовки включают информацию о типе контента, User-Agent и Referer.
2.  **Создание сессии**: Создается асинхронная сессия `aiohttp.ClientSession` с заданными заголовками.
3.  **Формирование данных запроса**: В зависимости от выбранной модели (`gpt-4` или `dalle`) формируются данные для отправки в запросе. Для `dalle` извлекается последний `content` из списка сообщений, для `gpt-4` используется `format_prompt(messages)`.
4.  **Отправка запроса**: Отправляется асинхронный POST-запрос к `cls.api_endpoint` с сформированными данными и заголовками. Используется `proxy`, если он указан.
5.  **Обработка ответа**:
    *   Если модель `dalle`, извлекается URL изображения из JSON-ответа, скачивается изображение по этому URL, кодируется в base64 и возвращается объект `ImageResponse`.
    *   Если модель `gpt-4`, читается ответ построчно, извлекаются данные, начинающиеся с `data:`, и возвращается текстовое сообщение.
6.  **Обработка ошибок**: В случае возникновения исключений возвращается сообщение об ошибке.

```
    Подготовка заголовков и сессии
    │
    ├──► Определение модели (gpt-4 или dalle)
    │   │
    │   └──► Формирование данных запроса
    │       │
    │       ├──► Отправка POST-запроса к API
    │       │   │
    │       │   └──► Обработка ответа
    │       │       │
    │       │       ├──► dalle: Извлечение URL, скачивание, кодирование в base64, ImageResponse
    │       │       │   │
    │       │       │   └──► Возврат ImageResponse
    │       │       │
    │       │       └──► gpt-4: Чтение ответа построчно, извлечение данных, возврат сообщения
    │       │           │
    │       │           └──► Возврат текстового сообщения
    │       │
    │       └──► Обработка ошибок
    │           │
    │           └──► Возврат сообщения об ошибке
    │
    Завершение
```

**Примеры**:

```python
# Пример использования с моделью gpt-4
messages = [{"role": "user", "content": "Hello, how are you?"}]
async for response in AiChats.create_async_generator(model='gpt-4', messages=messages):
    print(response)

# Пример использования с моделью dalle
messages = [{"role": "user", "content": "Generate an image of a cat."}]
async for response in AiChats.create_async_generator(model='dalle', messages=messages):
    print(response)
```

### `create_async`

```python
    @classmethod
    async def create_async(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> str:
        """
        Отправляет запрос к сервису ai-chats.org и возвращает результат.

        Args:
            model (str): Модель для использования (`gpt-4` или `dalle`).
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            str: Результат запроса.

        Raises:
            Exception: В случае ошибки при выполнении запроса.
        """
```

**Назначение**: Функция `create_async` отправляет запрос к API ai-chats.org и возвращает результат в виде строки. Она использует `create_async_generator` для получения ответа и возвращает первый элемент генератора.

**Параметры**:
- `model` (str): Указывает, какую модель использовать для генерации ответа. Может быть `gpt-4` для текстовых ответов или `dalle` для генерации изображений.
- `messages` (Messages): Список сообщений, которые будут отправлены в запросе.
- `proxy` (str, optional): Прокси-сервер для использования при отправке запроса. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в функцию.

**Возвращает**:
- `str`: Результат запроса. Если используется модель `dalle`, возвращается URL сгенерированного изображения. Если используется модель `gpt-4`, возвращается текстовый ответ.

**Вызывает исключения**:
- `Exception`: В случае возникновения ошибок при выполнении HTTP-запроса или обработке ответа от сервера.

**Внутренние функции**:
- Отсутствуют.

**Как работает функция**:

1.  **Вызов генератора**: Вызывается функция `cls.create_async_generator` с переданными параметрами для получения асинхронного генератора ответов.
2.  **Получение ответа**: Из генератора извлекается первый элемент. Если элемент является экземпляром `ImageResponse`, возвращается URL первого изображения. В противном случае возвращается сам элемент (текстовый ответ).

```
    Вызов асинхронного генератора create_async_generator
    │
    └──► Получение первого элемента из генератора
        │
        ├──► Элемент является ImageResponse
        │   │
        │   └──► Возврат URL изображения
        │
        └──► Возврат текстового ответа
```

**Примеры**:

```python
# Пример использования с моделью gpt-4
messages = [{"role": "user", "content": "Hello, how are you?"}]
response = await AiChats.create_async(model='gpt-4', messages=messages)
print(response)

# Пример использования с моделью dalle
messages = [{"role": "user", "content": "Generate an image of a cat."}]
response = await AiChats.create_async(model='dalle', messages=messages)
print(response)