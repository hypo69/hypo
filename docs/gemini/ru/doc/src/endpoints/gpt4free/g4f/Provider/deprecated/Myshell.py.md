# Модуль Myshell

## Обзор

Модуль `Myshell` предоставляет асинхронный интерфейс для взаимодействия с сервисом Myshell AI. Он позволяет генерировать текст на основе предоставленных сообщений, используя различные модели, такие как "samantha", "gpt-3.5-turbo" и "gpt-4". Модуль использует вебсокеты для асинхронной передачи данных и поддерживает прокси.

## Подробней

Этот модуль является асинхронным провайдером, предназначенным для интеграции с API Myshell AI. Он предоставляет функциональность для создания и отправки запросов к Myshell AI с использованием вебсокетов, а также для обработки потоковых ответов. Он использует асинхронные операции для обеспечения неблокирующего взаимодействия, что важно для приложений, требующих высокой производительности и отзывчивости.

## Классы

### `Myshell`

**Описание**: Класс `Myshell` является асинхронным провайдером и предоставляет методы для взаимодействия с API Myshell AI.

**Наследует**: `AsyncGeneratorProvider`

**Атрибуты**:
- `url` (str): URL для подключения к сервису Myshell AI.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели "gpt-3.5-turbo".
- `supports_gpt_4` (bool): Флаг, указывающий на поддержку модели "gpt-4".

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        timeout: int = 90,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для взаимодействия с API Myshell AI.

        Args:
            model (str): Идентификатор модели, которую нужно использовать.
            messages (Messages): Список сообщений для отправки в API.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            timeout (int, optional): Время ожидания ответа от сервера. По умолчанию `90`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий текст от API.

        Raises:
            ValueError: Если указанная модель не поддерживается.
            RuntimeError: Если получен неожиданный тип сообщения от сервера.
        """
```

**Назначение**: Создает асинхронный генератор для взаимодействия с API Myshell AI. Этот метод является сердцем класса `Myshell`, поскольку он устанавливает соединение с сервером Myshell AI через вебсокет и управляет обменом сообщениями для генерации текста.

**Параметры**:
- `model` (str): Идентификатор модели, которую нужно использовать. Поддерживаемые модели: "samantha", "gpt-3.5-turbo", "gpt-4".
- `messages` (Messages): Список сообщений для отправки в API.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания ответа от сервера. По умолчанию `90`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий текст от API.

**Вызывает исключения**:
- `ValueError`: Если указанная модель не поддерживается.
- `RuntimeError`: Если получен неожиданный тип сообщения от сервера.

**Как работает функция**:
1. **Определение идентификатора бота**: В зависимости от переданной модели выбирается соответствующий `bot_id`. Если модель не указана, используется модель "samantha". Если модель не поддерживается, выбрасывается исключение `ValueError`.
2. **Генерация идентификатора посетителя**: Генерируется уникальный `visitor_id` на основе `user_agent`.
3. **Установка соединения с вебсокетом**: Устанавливается асинхронное соединение с вебсокетом `wss://api.myshell.ai/ws/?EIO=4&transport=websocket` с использованием `aiohttp.ClientSession`.
4. **Обмен сообщениями для установки соединения**:
   - Отправляется и принимается приветственное сообщение.
   - Отправляется сообщение с `token` и `visitorId`.
5. **Решение проблемы "need_verify_captcha"**: Добавляется небольшая задержка в 5 секунд для обхода возможной проверки капчи.
6. **Создание сообщения чата**: Форматируется текст сообщения на основе списка сообщений (`messages`) и генерируется JSON-представление сообщения для отправки в чат.
7. **Генерация подписи сообщения**: Генерируется подпись для сообщения с использованием функций `generate_signature`.
8. **Отправка сообщения в чат**: Отправляется сообщение в чат с использованием вебсокета.
9. **Прием сообщений и генерация результата**:
   - Осуществляется асинхронный прием сообщений из вебсокета.
   - Если тип сообщения `WSMsgType.TEXT`, то обрабатывается сообщение.
   - Если получено сообщение "2", отправляется ответ "3" (ping-pong).
   - Если сообщение начинается с префикса `chat_start`, то извлекается тип данных и данные сообщения.
   - Если тип данных `text_stream`, то извлекается текст и генерируется результат. Если `isFinal` равен `True`, то генерация завершается.
   - Если тип данных `message_replied` или `need_verify_captcha`, выбрасывается исключение `RuntimeError`.

**Внутренние функции**: Нет

**Примеры**:
```python
# Пример использования create_async_generator
import asyncio
from typing import List, Dict

async def main():
    model = "gpt-3.5-turbo"
    messages: List[Dict[str, str]] = [
        {"role": "user", "content": "Привет, как дела?"}
    ]

    generator = Myshell.create_async_generator(model=model, messages=messages)
    try:
        async for message in await generator:
            print(message, end="")
    except Exception as ex:
        print(f"Ошибка: {ex}")

if __name__ == "__main__":
    asyncio.run(main())
```

## Функции

### `generate_timestamp`

```python
def generate_timestamp() -> str:
    """Генерирует timestamp для подписи запросов.

    Returns:
        str: Сгенерированный timestamp.
    """
```

**Назначение**: Генерирует timestamp, используемый для подписи запросов к API Myshell AI. Timestamp генерируется на основе текущего времени в миллисекундах и дополнительной контрольной суммы.

**Параметры**: Нет

**Возвращает**:
- `str`: Сгенерированный timestamp.

**Как работает функция**:
1. **Получение текущего времени**: Получает текущее время в миллисекундах.
2. **Вычисление контрольной суммы**: Вычисляет контрольную сумму на основе цифр текущего времени.
3. **Формирование timestamp**: Объединяет текущее время и контрольную сумму в строку.

**Внутренние функции**: Нет

**Примеры**:
```python
# Пример использования generate_timestamp
timestamp = generate_timestamp()
print(f"Сгенерированный timestamp: {timestamp}")
```

### `generate_signature`

```python
def generate_signature(text: str):
    """Генерирует подпись для запроса к API Myshell AI.

    Args:
        text (str): Текст запроса.

    Returns:
        dict: Словарь с подписью, timestamp и версией.
    """
```

**Назначение**: Генерирует подпись для запроса к API Myshell AI. Подпись используется для аутентификации запросов и предотвращения несанкционированного доступа.

**Параметры**:
- `text` (str): Текст запроса.

**Возвращает**:
- `dict`: Словарь с подписью, timestamp и версией.

**Как работает функция**:
1. **Генерация timestamp**: Генерирует timestamp с использованием функции `generate_timestamp`.
2. **Формирование данных для подписи**: Объединяет версию, текст запроса, timestamp и секретный ключ в строку.
3. **Вычисление MD5-хеша**: Вычисляет MD5-хеш от полученной строки.
4. **Инвертирование хеша**: Инвертирует полученный MD5-хеш.
5. **Формирование словаря с подписью**: Возвращает словарь, содержащий подпись, timestamp и версию.

**Внутренние функции**: Нет

**Примеры**:
```python
# Пример использования generate_signature
text = "Привет, как дела?"
signature_data = generate_signature(text)
print(f"Данные подписи: {signature_data}")
```

### `xor_hash`

```python
def xor_hash(B: str):
    """Вычисляет XOR-хеш от строки.

    Args:
        B (str): Строка для вычисления хеша.

    Returns:
        str: XOR-хеш строки.
    """
```

**Назначение**: Вычисляет XOR-хеш от строки. Используется для генерации `visitor_id`.

**Параметры**:
- `B` (str): Строка для вычисления хеша.

**Возвращает**:
- `str`: XOR-хеш строки.

**Как работает функция**:
1. **Инициализация переменных**: Инициализирует список `r` и переменную `i`.
2. **Определение внутренней функции `o`**: Определяет внутреннюю функцию `o`, которая выполняет XOR-операцию между `e` и значениями из списка `r`.
3. **Итерация по строке**: Итерируется по каждому символу строки `B`.
4. **Вычисление XOR-хеша**:
   - Преобразует символ в его ASCII-код и добавляет в список `r`.
   - Если длина списка `r` достигает 4, вызывает функцию `o` для обновления значения `i` и очищает список `r`.
5. **Обработка оставшихся элементов**: Если после итерации в списке `r` остались элементы, вызывает функцию `o` для их обработки.
6. **Возвращение результата**: Возвращает XOR-хеш в шестнадцатеричном формате.

**Внутренние функции**:

#### `o`
```python
    def o(e, t):
        """Выполняет XOR-операцию между e и значениями из списка t.

        Args:
            e: Значение для XOR-операции.
            t: Список значений для XOR-операции.

        Returns:
            int: Результат XOR-операции.
        """
```
**Назначение**: Выполняет XOR-операцию между `e` и значениями из списка `t`.
**Как работает функция**:
1. Вычисляет `o_val`, который является результатом сдвига элементов `r` на 8 битов влево, умноженные на их индекс.
2. Возвращает результат XOR-операции между `e` и `o_val`.

**Примеры**:
```python
# Пример использования xor_hash
string = "test_string"
hashed_value = xor_hash(string)
print(f"XOR-хеш строки: {hashed_value}")
```

### `performance`

```python
def performance() -> str:
    """Генерирует строку производительности на основе времени.

    Returns:
        str: Строка производительности.
    """
```

**Назначение**: Генерирует строку, отражающую производительность, на основе текущего времени. Используется для генерации `visitor_id`.

**Параметры**: Нет

**Возвращает**:
- `str`: Строка производительности.

**Как работает функция**:
1. **Получение текущего времени**: Получает текущее время в миллисекундах.
2. **Вычисление итераций**: Подсчитывает количество итераций, которые выполняются за одну миллисекунду.
3. **Формирование строки**: Объединяет текущее время и количество итераций в шестнадцатеричном формате.

**Внутренние функции**: Нет

**Примеры**:
```python
# Пример использования performance
performance_string = performance()
print(f"Строка производительности: {performance_string}")
```

### `generate_visitor_id`

```python
def generate_visitor_id(user_agent: str) -> str:
    """Генерирует идентификатор посетителя на основе user-agent.

    Args:
        user_agent (str): User-agent браузера.

    Returns:
        str: Сгенерированный идентификатор посетителя.
    """
```

**Назначение**: Генерирует идентификатор посетителя на основе user-agent. Используется для идентификации посетителя на сервере Myshell AI.

**Параметры**:
- `user_agent` (str): User-agent браузера.

**Возвращает**:
- `str`: Сгенерированный идентификатор посетителя.

**Как работает функция**:
1. **Генерация компонентов**:
   - Генерирует строку производительности с использованием функции `performance`.
   - Генерирует случайное шестнадцатеричное число.
   - Вычисляет XOR-хеш user-agent с использованием функции `xor_hash`.
   - Генерирует строку, представляющую разрешение экрана (1080 * 1920).
2. **Формирование идентификатора**: Объединяет все компоненты в строку, разделенную дефисами.

**Внутренние функции**: Нет

**Примеры**:
```python
# Пример использования generate_visitor_id
user_agent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"
visitor_id = generate_visitor_id(user_agent)
print(f"Сгенерированный идентификатор посетителя: {visitor_id}")
```