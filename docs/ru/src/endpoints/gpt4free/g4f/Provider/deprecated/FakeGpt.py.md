# Модуль `FakeGpt`

## Обзор

Модуль `FakeGpt` предоставляет асинхронный генератор для взаимодействия с API `chat-shared2.zhile.io`. Этот модуль предназначен для имитации работы с GPT-подобными моделями и используется для получения ответов на основе заданных сообщений. Он поддерживает модель `gpt-3.5-turbo`.

## Подробней

Модуль `FakeGpt` использует библиотеку `aiohttp` для выполнения асинхронных HTTP-запросов. Он получает токен доступа и отправляет сообщения для генерации ответов. Модуль обрабатывает ответы в формате `text/event-stream` и извлекает полезные данные для возврата пользователю. В случае отсутствия валидного ответа выбрасывается исключение `RuntimeError`.

## Классы

### `FakeGpt`

**Описание**: Класс `FakeGpt` является асинхронным генератором провайдера.

**Принцип работы**:
1.  Класс инициализируется с URL `https://chat-shared2.zhile.io` и флагом `supports_gpt_35_turbo`, установленным в `True`, указывающим на поддержку модели `gpt-3.5-turbo`.
2.  Метод `create_async_generator` создает асинхронный генератор для получения ответов на основе предоставленных сообщений.
3.  Внутри метода происходит получение токена доступа, формирование запроса и отправка данных на сервер.
4.  Полученные ответы обрабатываются и передаются пользователю в виде асинхронного генератора.
5.  В случае возникновения ошибок или отсутствия валидного ответа, выбрасывается исключение.

**Атрибуты**:

*   `url` (str): URL для взаимодействия с API `chat-shared2.zhile.io`.
*   `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели `gpt-3.5-turbo`.
*   `working` (bool): Флаг, указывающий на работоспособность класса (по умолчанию `False`).
*   `_access_token` (str | None): Приватный атрибут для хранения токена доступа (по умолчанию `None`).
*   `_cookie_jar` (aiohttp.CookieJar | None): Приватный атрибут для хранения cookie (по умолчанию `None`).

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для получения ответов от API.

        Args:
            model (str): Модель для использования.
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий ответы от API.

        Raises:
            RuntimeError: Если не получен валидный ответ от API.

        Example:
            async for message in FakeGpt.create_async_generator(model='gpt-3.5-turbo', messages=[{'role': 'user', 'content': 'Hello'}]):
                print(message)
        """
```

**Назначение**: Создает асинхронный генератор для получения ответов от API.

**Параметры**:

*   `cls`: Ссылка на класс.
*   `model` (str): Модель для использования.
*   `messages` (Messages): Список сообщений для отправки.
*   `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
*   `**kwargs`: Дополнительные аргументы.

**Возвращает**:

*   `AsyncResult`: Асинхронный генератор, возвращающий ответы от API.

**Вызывает исключения**:

*   `RuntimeError`: Если не получен валидный ответ от API.

**Как работает функция**:

1.  **Инициализация**: Функция принимает параметры `model` (модель для использования), `messages` (список сообщений для отправки), `proxy` (прокси-сервер для использования, по умолчанию `None`) и дополнительные аргументы `**kwargs`.
2.  **Формирование заголовков**: Создаются заголовки HTTP-запроса, включающие `Accept-Language`, `User-Agent`, `Referer`, `sec-ch-ua`, `sec-ch-ua-platform` и `sec-ch-ua-mobile`.
3.  **Создание сессии `aiohttp`**: Используется `ClientSession` для выполнения асинхронных HTTP-запросов с заданными заголовками и cookie jar.
4.  **Получение токена доступа**:
    *   Если `cls._access_token` не установлен, выполняется запрос к `cls.url/api/loads` для получения списка токенов.
    *   Выбирается случайный токен из списка.
    *   Выполняется POST-запрос к `cls.url/auth/login` с данными, включающими выбранный токен и случайный пароль сессии.
    *   Выполняется GET-запрос к `cls.url/api/auth/session` для получения токена доступа.
    *   Сохраняется токен доступа в `cls._access_token` и cookie jar в `cls._cookie_jar`.
5.  **Формирование тела запроса**:
    *   Создаются заголовки запроса, включающие `Content-Type`, `Accept` и `X-Authorization` с токеном доступа.
    *   Формируется тело запроса в формате JSON, включающее сообщения, идентификаторы сообщений, модель, параметры плагинов, временную зону и другие настройки.
6.  **Отправка запроса и обработка ответа**:
    *   Выполняется POST-запрос к `cls.url/api/conversation` с телом запроса и заголовками.
    *   Полученный ответ обрабатывается построчно.
    *   Если строка начинается с `b"data: "`, извлекаются данные и преобразуются из JSON.
    *   Если тип сообщения `next`, извлекается текст сообщения и передается в генератор.
    *   Сохраняется последнее полученное сообщение.
7.  **Обработка ошибок**:
    *   Если не получено ни одного валидного сообщения, выбрасывается исключение `RuntimeError`.

**ASII flowchart**:

```
    Начало
    |
    --> Формирование HTTP заголовков
    |
    --> Создание асинхронной сессии
    |
    --> Проверка наличия токена доступа
    |   Нет
    |   --> Запрос к /api/loads для получения списка токенов
    |   --> Выбор случайного токена
    |   --> POST запрос к /auth/login для аутентификации
    |   --> GET запрос к /api/auth/session для получения access token
    |   --> Сохранение токена и cookie
    |   Да
    |   --> Формирование JSON тела запроса с сообщениями
    |   --> POST запрос к /api/conversation с телом запроса и заголовками
    |   --> Обработка ответа (text/event-stream)
    |   --> Извлечение данных из строк, начинающихся с "data: "
    |   --> Проверка типа сообщения ("next")
    |   |   Да
    |   |   --> Извлечение текста сообщения и передача в генератор
    |   |   --> Сохранение последнего сообщения
    |   |   Нет
    |   |   --> Пропуск
    |   --> Если нет валидных сообщений --> RuntimeError
    |
    Конец
```

**Примеры**:

```python
async for message in FakeGpt.create_async_generator(model='gpt-3.5-turbo', messages=[{'role': 'user', 'content': 'Hello'}]):
    print(message)
```

В этом примере создается асинхронный генератор для модели `gpt-3.5-turbo` и отправляется сообщение "Hello". Ответы от API будут выводиться в консоль.
```python
async for message in FakeGpt.create_async_generator(model='gpt-3.5-turbo', messages=[{'role': 'user', 'content': 'Как дела?'}], proxy="http://proxy.example.com:8080"):
    print(message)
```

В этом примере используется прокси-сервер "http://proxy.example.com:8080" для выполнения запроса.
```python
async for message in FakeGpt.create_async_generator(model='gpt-3.5-turbo', messages=[{'role': 'user', 'content': 'Explain quantum physics to me like I am five years old'}]):
    print(message)
```

В этом примере отправляется запрос с более сложным вопросом.