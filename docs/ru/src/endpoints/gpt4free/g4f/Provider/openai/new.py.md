# Модуль для генерации токенов и обработки Turnstile

## Обзор

Модуль `new.py` предназначен для генерации токенов, необходимых для обхода защиты Cloudflare Turnstile, а также для обработки этих токенов. Он содержит функции для получения времени парсинга, формирования конфигурации, решения математических задач для получения токенов и обработки токенов Turnstile. Модуль использует различные техники, такие как хеширование, кодирование base64 и XOR-шифрование, чтобы взаимодействовать с защитой Turnstile.

## Подробнее

Модуль предоставляет функциональность для генерации и обработки токенов, используемых для обхода защиты Cloudflare Turnstile. Он включает в себя функции для формирования конфигурации, решения математических задач для получения токенов и обработки токенов Turnstile. Этот модуль играет важную роль в проекте, обеспечивая возможность обхода защиты Cloudflare Turnstile для доступа к необходимым ресурсам.

## Функции

### `get_parse_time`

```python
def get_parse_time() -> str:
    """Возвращает текущее время в формате, необходимом для запросов.

    Возвращает:
        str: Текущее время в формате "%a %b %d %Y %H:%M:%S GMT+0200 (Central European Summer Time)".
    """
```

**Назначение**: Получение текущего времени в определенном формате, который, вероятно, требуется для взаимодействия с API.

**Как работает функция**:

1.  Получает текущее время с учетом временной зоны (UTC-5).
2.  Форматирует полученное время в строку, соответствующую формату: "%a %b %d %Y %H:%M:%S GMT+0200 (Central European Summer Time)".

**Примеры**:

```python
>>> get_parse_time()
'Sat Jun 22 2024 10:30:00 GMT+0200 (Central European Summer Time)'
```

### `get_config`

```python
def get_config(user_agent: str) -> List[Any]:
    """Формирует конфигурацию, используемую для генерации токенов.

    Args:
        user_agent (str): User-agent, используемый для запросов.

    Returns:
        List[Any]: Список, представляющий собой конфигурацию.
    """
```

**Назначение**: Функция создает конфигурацию, которая используется при генерации токенов для обхода защиты Turnstile. Конфигурация включает в себя информацию о ядре процессора, разрешении экрана, user-agent и другие параметры.

**Как работает функция**:

1.  Выбирает случайное значение из списка `cores` и `screens`.
2.  Формирует список `config`, содержащий различные параметры, такие как ядро процессора, разрешение экрана, текущее время, user-agent, данные о сборке, язык и другие случайные значения.

**Примеры**:

```python
>>> get_config('Mozilla/5.0')
[3016, 'Sat Jun 22 2024 10:30:00 GMT+0200 (Central European Summer Time)', None, 0.123456789, 'Mozilla/5.0', None, 'data-build', 'en-US', 'en-US,es-US,en,es', 0, 'registerProtocolHandler−function registerProtocolHandler() { [native code] }', 'location', '0', 1.23456789, 'uuid', '', 8, 1627000000]
```

### `get_answer_token`

```python
def get_answer_token(seed: str, diff: str, config: List[Any]) -> str:
    """Получает токен ответа, решая задачу на основе seed и diff.

    Args:
        seed (str): Seed для решения задачи.
        diff (str): Сложность задачи.
        config (List[Any]): Конфигурация.

    Returns:
        str: Токен ответа.

    Raises:
        Exception: Если не удалось решить задачу.
    """
```

**Назначение**: Функция генерирует токен ответа на основе предоставленных seed, сложности и конфигурации.

**Как работает функция**:

1.  Вызывает функцию `generate_answer` для решения задачи.
2.  Если задача решена, возвращает токен в формате "gAAAAAB" + answer.
3.  Если задача не решена, вызывает исключение Exception.

**Примеры**:

```python
>>> get_answer_token('seed', 'diff', [1, 2, 3])
'gAAAAABanswer'
```

### `generate_answer`

```python
def generate_answer(seed: str, diff: str, config: List[Any]) -> tuple[str, bool]:
    """Генерирует ответ на задачу, используя seed, сложность и конфигурацию.

    Args:
        seed (str): Seed для решения задачи.
        diff (str): Сложность задачи в шестнадцатеричном формате.
        config (List[Any]): Конфигурация.

    Returns:
        tuple[str, bool]: Кортеж, содержащий ответ и флаг, указывающий, была ли задача решена.
    """
```

**Назначение**: Функция генерирует ответ на задачу, используя seed, сложность (diff) и конфигурацию. Она пытается найти такое значение, которое при хешировании с seed и конфигурацией дает результат, удовлетворяющий заданной сложности.

**Как работает функция**:

1.  Преобразует входные параметры в байты.
2.  В цикле от 0 до `maxAttempts` (500000) генерирует две строки (`d1` и `d2`) на основе текущей итерации.
3.  Формирует строку `string` путем конкатенации частей конфигурации и сгенерированных строк.
4.  Кодирует строку `string` в base64.
5.  Вычисляет SHA3-512 хеш от конкатенации seed и закодированной строки.
6.  Сравнивает первые `diff_len` байт хеша с целевой сложностью `target_diff`.
7.  Если хеш удовлетворяет сложности, возвращает закодированную строку и `True`.
8.  Если за `maxAttempts` итераций решение не найдено, возвращает строку-заглушку и `False`.

ASCII-схема работы функции:

```
Начало
    │
    ├── Подготовка данных (seed, diff, config)
    │
    └── Цикл (maxAttempts раз)
        │
        ├── Генерация строк d1 и d2 на основе итерации
        │
        ├── Формирование строки string (конкатенация config, d1, d2)
        │
        ├── Кодирование строки string в base64
        │
        ├── Вычисление SHA3-512 хеша
        │
        ├── Сравнение хеша с целевой сложностью
        │   └── Если хеш <= сложности:
        │       └── Возврат (base64 encoded string, True)
        │
        └── Конец итерации
    │
    └── Возврат (заглушка, False)
    │
Конец
```

**Примеры**:

```python
>>> generate_answer('seed', '0fffff', [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18])
('wQ8Lk5FbGpA2NcR9dShT6gYjU7VxZ4D"c2VlZA=="', False)
```

### `get_requirements_token`

```python
def get_requirements_token(config: List[Any]) -> str:
    """Получает токен требований, решая задачу со случайным seed и сложностью "0fffff".

    Args:
        config (List[Any]): Конфигурация.

    Returns:
        str: Токен требований.

    Raises:
        Exception: Если не удалось решить задачу.
    """
```

**Назначение**: Функция генерирует токен требований, необходимый для прохождения защиты Turnstile.

**Как работает функция**:

1.  Вызывает функцию `generate_answer` со случайным seed и фиксированной сложностью "0fffff".
2.  Если задача решена, возвращает токен в формате 'gAAAAAC' + require.
3.  Если задача не решена, вызывает исключение Exception.

**Примеры**:

```python
>>> get_requirements_token([1, 2, 3])
'gAAAAACtoken'
```

### `OrderedMap`

```python
class OrderedMap:
    """Класс для хранения данных в виде упорядоченного словаря.
    """
    def __init__(self):
        """Конструктор класса OrderedMap.
        """

    def add(self, key: str, value: Any):
        """Добавляет пару ключ-значение в словарь.

        Args:
            key (str): Ключ.
            value (Any): Значение.
        """

    def to_json(self):
        """Преобразует словарь в JSON-строку.

        Returns:
            str: JSON-представление словаря.
        """

    def __str__(self):
        """Возвращает JSON-представление словаря в виде строки.

        Returns:
            str: JSON-представление словаря.
        """
```

**Описание**: Класс `OrderedMap` представляет собой обертку над `OrderedDict` из модуля `collections`. Он предоставляет методы для добавления элементов, преобразования в JSON и строкового представления.

**Методы**:

*   `__init__`: Инициализирует пустой упорядоченный словарь `self.map`.
*   `add(key: str, value: Any)`: Добавляет пару ключ-значение в упорядоченный словарь.
*   `to_json()`: Преобразует упорядоченный словарь в JSON-строку с помощью `json.dumps`.
*   `__str__()`: Возвращает JSON-представление словаря в виде строки.

**Примеры**:

```python
>>> ordered_map = OrderedMap()
>>> ordered_map.add("key1", "value1")
>>> ordered_map.add("key2", 123)
>>> print(ordered_map.to_json())
{"key1": "value1", "key2": 123}
```

### `get_turnstile_token`

```python
def get_turnstile_token(dx: str, p: str) -> str:
    """Декодирует и обрабатывает токен Turnstile.

    Args:
        dx (str): Закодированная строка.
        p (str): Ключ для обработки.

    Returns:
        str: Обработанный токен.
    """
```

**Назначение**: Функция декодирует строку `dx` из base64 и передает результат в функцию `process_turnstile_token` вместе с ключом `p` для дальнейшей обработки.

**Как работает функция**:

1.  Декодирует строку `dx` из base64 в байты с помощью `base64.b64decode`.
2.  Декодирует полученные байты в строку, используя кодировку UTF-8.
3.  Вызывает функцию `process_turnstile_token` с декодированной строкой и ключом `p`.
4.  Возвращает результат, полученный от `process_turnstile_token`.

**Примеры**:

```python
>>> get_turnstile_token('YmFzZTY0LWVuY29kZWQgc3RyaW5n', 'ключ')
'обработанный токен'
```

### `process_turnstile_token`

```python
def process_turnstile_token(dx: str, p: str) -> str:
    """Обрабатывает токен Turnstile с использованием XOR-шифрования.

    Args:
        dx (str): Строка для обработки.
        p (str): Ключ для обработки.

    Returns:
        str: Обработанная строка.
    """
```

**Назначение**: Функция обрабатывает строку `dx` с использованием XOR-шифрования, применяя ключ `p`.

**Как работает функция**:

1.  Определяет длину ключа `p`.
2.  Если длина ключа не равна 0, выполняет XOR-шифрование каждого символа строки `dx` с символом ключа `p` по индексу `i % p_length`.
3.  Если длина ключа равна 0, просто преобразует строку `dx` в список символов.
4.  Объединяет полученный список символов в строку и возвращает её.

**Примеры**:

```python
>>> process_turnstile_token('строка', 'ключ')
'обработанная строка'
```

### `is_slice`

```python
def is_slice(input_val: Any) -> bool:
    """Проверяет, является ли входное значение списком или кортежем.

    Args:
        input_val (Any): Проверяемое значение.

    Returns:
        bool: True, если значение является списком или кортежем, иначе False.
    """
```

**Назначение**: Функция проверяет, является ли переданное значение списком или кортежем.

**Как работает функция**:

1.  Использует функцию `isinstance` для проверки, является ли `input_val` экземпляром класса `list` или `tuple`.
2.  Возвращает `True`, если `input_val` является списком или кортежем, иначе возвращает `False`.

**Примеры**:

```python
>>> is_slice([1, 2, 3])
True
>>> is_slice((1, 2, 3))
True
>>> is_slice("hello")
False
```

### `is_float`

```python
def is_float(input_val: Any) -> bool:
    """Проверяет, является ли входное значение числом с плавающей точкой.

    Args:
        input_val (Any): Проверяемое значение.

    Returns:
        bool: True, если значение является числом с плавающей точкой, иначе False.
    """
```

**Назначение**: Функция проверяет, является ли переданное значение числом с плавающей точкой (float).

**Как работает функция**:

1.  Использует функцию `isinstance` для проверки, является ли `input_val` экземпляром класса `float`.
2.  Возвращает `True`, если `input_val` является числом с плавающей точкой, иначе возвращает `False`.

**Примеры**:

```python
>>> is_float(3.14)
True
>>> is_float(5)
False
>>> is_float("hello")
False
```

### `is_string`

```python
def is_string(input_val: Any) -> bool:
    """Проверяет, является ли входное значение строкой.

    Args:
        input_val (Any): Проверяемое значение.

    Returns:
        bool: True, если значение является строкой, иначе False.
    """
```

**Назначение**: Функция проверяет, является ли переданное значение строкой.

**Как работает функция**:

1.  Использует функцию `isinstance` для проверки, является ли `input_val` экземпляром класса `str`.
2.  Возвращает `True`, если `input_val` является строкой, иначе возвращает `False`.

**Примеры**:

```python
>>> is_string("hello")
True
>>> is_string(123)
False
>>> is_string([1, 2, 3])
False
```

### `to_str`

```python
def to_str(input_val: Any) -> str:
    """Преобразует входное значение в строку с учетом специальных случаев.

    Args:
        input_val (Any): Преобразуемое значение.

    Returns:
        str: Строковое представление значения.
    """
```

**Назначение**: Функция преобразует входное значение в строковое представление с учетом нескольких специальных случаев и типов данных.

**Как работает функция**:

1.  Если `input_val` равен `None`, возвращает строку "undefined".
2.  Если `input_val` является числом с плавающей точкой, форматирует его как строку с 16 знаками после запятой.
3.  Если `input_val` является строкой, проверяет наличие специальных случаев в словаре `special_cases` и возвращает соответствующее значение, если найдено. В противном случае возвращает исходную строку.
4.  Если `input_val` является списком, содержащим только строки, объединяет элементы списка в одну строку, разделенную запятыми.
5.  В остальных случаях преобразует `input_val` в строку с помощью `str()` и возвращает результат.

**Примеры**:

```python
>>> to_str(None)
'undefined'
>>> to_str(3.141592653589793)
'3.141592653589793'
>>> to_str("window.Math")
'[object Math]'
>>> to_str(["a", "b", "c"])
'a,b,c'
>>> to_str([1, 2, 3])
'[1, 2, 3]'
```

### `get_func_map`

```python
def get_func_map() -> FloatMap:
    """Создает и возвращает словарь функций для обработки токенов Turnstile.

    Returns:
        FloatMap: Словарь функций, где ключи - числа с плавающей точкой.
    """
```

**Назначение**: Функция создает и возвращает словарь, содержащий функции, используемые для обработки токенов Turnstile. Этот словарь используется для динамического вызова функций на основе значений, найденных в токенах.

**Как работает функция**:

1.  Инициализирует словарь `process_map` с использованием `defaultdict`, где значениями по умолчанию являются `None`.
2.  Определяет несколько внутренних функций (`func_1`, `func_2`, `func_5`, `func_6`, `func_7`, `func_8`, `func_14`, `func_15`, `func_17`, `func_18`, `func_19`, `func_20`, `func_21`, `func_23`, `func_24`), каждая из которых выполняет определенные операции над данными, хранящимися в `process_map`.
3.  Обновляет словарь `process_map`, связывая числовые ключи с соответствующими функциями или строковыми значениями.
4.  Возвращает словарь `process_map`.

**Примеры**:

```python
>>> func_map = get_func_map()
>>> type(func_map)
<class 'collections.defaultdict'>
>>> func_map[1]
<function func_1 at 0x...>
>>> func_map[10]
'window'
```

### `process_turnstile`

```python
def process_turnstile(dx: str, p: str) -> str:
    """Обрабатывает токен Turnstile, используя предоставленные функции и данные.

    Args:
        dx (str): Закодированная строка.
        p (str): Ключ для обработки.

    Returns:
        str: Результат обработки токена.
    """
```

**Назначение**: Функция обрабатывает токен Turnstile, используя предоставленные функции и данные. Она декодирует токен, извлекает функции и параметры из токена и выполняет эти функции.

**Как работает функция**:

1.  Вызывает функцию `get_turnstile_token` для декодирования и начальной обработки токена `dx` с ключом `p`.
2.  Загружает токен в формате JSON, чтобы получить список токенов.
3.  Получает карту функций `process_map` с помощью `get_func_map()`.
4.  Определяет внутреннюю функцию `func_3`, которая кодирует строку в base64 и сохраняет результат в переменной `res`.
5.  Обновляет карту функций `process_map`, добавляя функцию `func_3` под ключом `3`, список токенов под ключом `9` и ключ `p` под ключом `16`.
6.  Итерируется по списку токенов, извлекая идентификатор функции `e` и параметры `t` для каждого токена.
7.  Получает функцию `f` из карты функций `process_map` по идентификатору `e`.
8.  Если функция `f` существует и является вызываемой, вызывает ее с параметрами `t`.
9.  Если во время обработки токена возникает исключение, перехватывает его и выводит сообщение об ошибке.
10. Возвращает результат `res`, который содержит base64-закодированную строку, полученную в результате выполнения функции `func_3`.

ASCII-схема работы функции:

```
Начало
    │
    ├── Получение токенов и карты функций
    │   ├── get_turnstile_token(dx, p)
    │   ├── JSON.loads(tokens)
    │   └── get_func_map()
    │
    ├── Инициализация переменных
    │   └── res = ""
    │
    ├── Определение func_3
    │   └── Кодирование в base64
    │
    ├── Обновление process_map
    │   ├── process_map[3] = func_3
    │   ├── process_map[9] = token_list
    │   └── process_map[16] = p
    │
    ├── Цикл по токенам
    │   ├── Извлечение e и t из токена
    │   ├── Получение функции f из process_map по ключу e
    │   ├── Если f вызываема:
    │   │   └── Вызов f(*t)
    │   ├── Обработка исключений
    │   │   └── Вывод сообщения об ошибке
    │
    └── Возврат res
Конец
```