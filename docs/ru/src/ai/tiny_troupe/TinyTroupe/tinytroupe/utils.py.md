# Модуль `utils`

## Обзор

Модуль `utils.py` содержит общие утилиты и вспомогательные функции, используемые в проекте TinyTroupe. Включает в себя функции для обработки ввода/вывода модели, управления моделью, валидации, работы с промптами, рендеринга и разметки, ввода/вывода и запуска, а также другие утилиты.

## Оглавление

- [Функции](#функции)
  - [`compose_initial_LLM_messages_with_templates`](#compose_initial_llm_messages_with_templates)
  - [`extract_json`](#extract_json)
  - [`extract_code_block`](#extract_code_block)
  - [`repeat_on_error`](#repeat_on_error)
  - [`check_valid_fields`](#check_valid_fields)
  - [`sanitize_raw_string`](#sanitize_raw_string)
  - [`sanitize_dict`](#sanitize_dict)
  - [`add_rai_template_variables_if_enabled`](#add_rai_template_variables_if_enabled)
  - [`inject_html_css_style_prefix`](#inject_html_css_style_prefix)
  - [`break_text_at_length`](#break_text_at_length)
  - [`pretty_datetime`](#pretty_datetime)
  - [`dedent`](#dedent)
  - [`read_config_file`](#read_config_file)
  - [`pretty_print_config`](#pretty_print_config)
  - [`start_logger`](#start_logger)
  - [`name_or_empty`](#name_or_empty)
  - [`custom_hash`](#custom_hash)
  - [`fresh_id`](#fresh_id)
- [Классы](#классы)
  - [`JsonSerializableRegistry`](#jsonserializableregistry)

## Функции

### `compose_initial_LLM_messages_with_templates`

**Описание**:
Составляет начальные сообщения для вызова LLM модели, предполагая, что всегда используется системное (общее описание задачи) и опциональное пользовательское сообщение (конкретное описание задачи). Эти сообщения составляются с использованием указанных шаблонов и конфигураций рендеринга.

**Параметры**:
- `system_template_name` (str): Имя шаблона системного сообщения.
- `user_template_name` (str, optional): Имя шаблона пользовательского сообщения. По умолчанию `None`.
- `rendering_configs` (dict, optional): Словарь конфигураций для рендеринга шаблонов. По умолчанию `{}`.

**Возвращает**:
- `list`: Список сообщений для LLM модели.

### `extract_json`

**Описание**:
Извлекает JSON объект из строки, игнорируя любой текст перед первой открывающей фигурной скобкой, а также любые теги Markdown для открытия или закрытия JSON (`\`\`\`json` и `\`\`\``).

**Параметры**:
- `text` (str): Строка для извлечения JSON объекта.

**Возвращает**:
- `dict`: Извлеченный JSON объект или пустой словарь в случае ошибки.

### `extract_code_block`

**Описание**:
Извлекает блок кода из строки, игнорируя любой текст до первого открывающего тройного обратного апострофа и после закрывающего тройного обратного апострофа.

**Параметры**:
- `text` (str): Строка для извлечения блока кода.

**Возвращает**:
- `str`: Извлеченный блок кода или пустая строка в случае ошибки.

### `repeat_on_error`

**Описание**:
Декоратор, который повторяет вызов указанной функции, если возникает исключение из указанного списка, до указанного количества повторных попыток. Если количество повторных попыток превышено, исключение перевыбрасывается. Если исключение не возникает, функция возвращается нормально.

**Параметры**:
- `retries` (int): Количество повторных попыток.
- `exceptions` (list): Список классов исключений, которые нужно перехватывать.

**Возвращает**:
- `decorator`: Декоратор, который можно применить к функции.

### `check_valid_fields`

**Описание**:
Проверяет, являются ли поля в указанном словаре допустимыми, согласно списку допустимых полей. Если нет, вызывает `ValueError`.

**Параметры**:
- `obj` (dict): Словарь для проверки.
- `valid_fields` (list): Список допустимых полей.

**Вызывает исключения**:
- `ValueError`: Если найден недопустимый ключ в словаре.

### `sanitize_raw_string`

**Описание**:
Очищает указанную строку, удаляя недопустимые символы и гарантируя, что ее длина не превышает максимальную длину строки Python.

**Параметры**:
- `value` (str): Строка для очистки.

**Возвращает**:
- `str`: Очищенная строка.

### `sanitize_dict`

**Описание**:
Очищает указанный словарь, удаляя недопустимые символы и гарантируя, что словарь не слишком глубоко вложен.

**Параметры**:
- `value` (dict): Словарь для очистки.

**Возвращает**:
- `dict`: Очищенный словарь.

### `add_rai_template_variables_if_enabled`

**Описание**:
Добавляет переменные шаблона RAI в указанный словарь, если включены соответствующие дисклеймеры RAI. Эти переменные загружают дисклеймеры RAI из соответствующих файлов в каталоге prompts.

**Параметры**:
- `template_variables` (dict): Словарь переменных шаблона.

**Возвращает**:
- `dict`: Обновленный словарь переменных шаблона с переменными RAI.

### `inject_html_css_style_prefix`

**Описание**:
Вставляет префикс стиля ко всем атрибутам стиля в заданной HTML-строке.

**Параметры**:
- `html` (str): HTML-строка для изменения.
- `style_prefix_attributes` (str): Префикс стиля для вставки.

**Возвращает**:
- `str`: HTML-строка с добавленным префиксом стиля.

### `break_text_at_length`

**Описание**:
Разбивает текст (или JSON) на указанной длине, вставляя строку `(...)` в точке разрыва. Если максимальная длина равна `None`, содержимое возвращается как есть.

**Параметры**:
- `text` (Union[str, dict]): Текст или JSON для разбиения.
- `max_length` (int, optional): Максимальная длина текста. По умолчанию `None`.

**Возвращает**:
- `str`: Разбитый текст.

### `pretty_datetime`

**Описание**:
Возвращает строку, представляющую объект datetime в формате `YYYY-MM-DD HH:MM`.

**Параметры**:
- `dt` (datetime): Объект datetime.

**Возвращает**:
- `str`: Строковое представление datetime.

### `dedent`

**Описание**:
Удаляет отступы из указанного текста.

**Параметры**:
- `text` (str): Текст для удаления отступов.

**Возвращает**:
- `str`: Текст без отступов.

### `read_config_file`

**Описание**:
Считывает файл конфигурации (`config.ini`) из текущей директории или из директории модуля. Использует кэширование, чтобы избежать повторного чтения файла.

**Параметры**:
- `use_cache` (bool, optional): Определяет, использовать ли кэшированную конфигурацию. По умолчанию `True`.
- `verbose` (bool, optional): Определяет, выводить ли отладочную информацию. По умолчанию `True`.

**Возвращает**:
- `configparser.ConfigParser`: Объект конфигурации.

**Вызывает исключения**:
- `ValueError`: Если не удается найти файл конфигурации.

### `pretty_print_config`

**Описание**:
Выводит текущую конфигурацию TinyTroupe в консоль.

**Параметры**:
- `config` (`configparser.ConfigParser`): Объект конфигурации для вывода.

### `start_logger`

**Описание**:
Инициализирует и запускает логгер TinyTroupe.

**Параметры**:
- `config` (`configparser.ConfigParser`): Объект конфигурации для настройки уровня логирования.

### `name_or_empty`

**Описание**:
Возвращает имя указанного агента или окружения, или пустую строку, если агент равен `None`.

**Параметры**:
- `named_entity` (AgentOrWorld): Агент или окружение.

**Возвращает**:
- `str`: Имя агента или окружения, или пустая строка.

### `custom_hash`

**Описание**:
Возвращает хэш для указанного объекта. Объект сначала преобразуется в строку, чтобы сделать его хэшируемым. Этот метод детерминирован.

**Параметры**:
- `obj` (Any): Объект для хэширования.

**Возвращает**:
- `str`: Хэш объекта.

### `fresh_id`

**Описание**:
Возвращает свежий ID для нового объекта.

**Возвращает**:
- `int`: Уникальный ID.

## Классы

### `JsonSerializableRegistry`

**Описание**:
Миксин-класс, предоставляющий сериализацию и десериализацию JSON, а также регистрацию подклассов.

**Методы**:
- `to_json(include: list = None, suppress: list = None, file_path: str = None) -> dict`:
    - **Описание**: Возвращает JSON-представление объекта.
    - **Параметры**:
        - `include` (list, optional): Атрибуты для включения в сериализацию.
        - `suppress` (list, optional): Атрибуты для исключения из сериализации.
        - `file_path` (str, optional): Путь к файлу для записи JSON.
    - **Возвращает**:
        - `dict`: JSON-представление объекта.
- `from_json(json_dict_or_path, suppress: list = None, post_init_params: dict = None)`:
    - **Описание**: Загружает JSON-представление объекта и создает экземпляр класса.
    - **Параметры**:
        - `json_dict_or_path` (dict или str): JSON-словарь или путь к файлу.
        - `suppress` (list, optional): Атрибуты, которые не нужно загружать.
        - `post_init_params` (dict, optional): Дополнительные параметры для `_post_deserialization_init`.
    - **Возвращает**:
        - Экземпляр класса, заполненный данными из `json_dict_or_path`.
- `__init_subclass__(cls, **kwargs)`:
    - **Описание**: Регистрирует подкласс, добавляет его атрибуты для сериализации и десериализации.
- `_post_deserialization_init(self, **kwargs)`:
    - **Описание**: Выполняет дополнительную инициализацию после десериализации, если есть метод `_post_init`.