# Модуль интеграции Google Generative AI

## Обзор

Класс `GoogleGenerativeAI` предназначен для взаимодействия с моделями Google Generative AI. Этот класс предоставляет методы для отправки запросов, обработки ответов, управления диалогами и интеграции с различными функциональностями ИИ. Он включает в себя надежную обработку ошибок, ведение журнала и настройки конфигурации для обеспечения беспрепятственной работы.

## Содержание

- [Обзор](#обзор)
- [Основные функции](#основные-функции)
  - [`__init__`](#__init__)
  - [`config`](#config)
  - [`_start_chat`](#_start_chat)
  - [`_save_dialogue`](#_save_dialogue)
  - [`ask`](#ask)
  - [`chat`](#chat)
  - [`describe_image`](#describe_image)
  - [`upload_file`](#upload_file)
- [Обработка ошибок](#обработка-ошибок)
- [Ведение журнала и история](#ведение-журнала-и-история)
- [Зависимости](#зависимости)
- [Пример использования](#пример-использования)

## Основные функции

### `__init__(self, api_key: str, model_name: Optional[str] = None, generation_config: Optional[Dict] = None, system_instruction: Optional[str] = None, **kwargs)`

**Назначение**: Инициализирует класс `GoogleGenerativeAI` с необходимыми конфигурациями.

**Как работает класс**:
Конструктор класса `GoogleGenerativeAI` принимает параметры для настройки взаимодействия с моделями Google Generative AI. Он устанавливает ключ API, имя модели, конфигурацию генерации и системную инструкцию. Также определяет пути для ведения журнала диалогов и хранения истории. В конце инициализируется модель Google Generative AI.

**Параметры**:
- `api_key` (str): Ключ API для доступа к сервисам Google Generative AI.
- `model_name` (Optional[str], optional): Имя используемой модели. По умолчанию `None`.
- `generation_config` (Optional[Dict], optional): Конфигурация генерации. По умолчанию `None`.
- `system_instruction` (Optional[str], optional): Системная инструкция для модели. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- None

**Вызывает исключения**:
- None

### `config()`

**Назначение**: Получает конфигурацию из файла настроек.

**Как работает функция**:
Функция `config` читает и разбирает файл конфигурации, расположенный по пути `gs.path.src / 'ai' / 'gemini' / 'gemini.json'`. Она использует `j_loads` или `j_loads_ns` для загрузки JSON из файла конфигурации.

**Параметры**:
- None

**Возвращает**:
- None

**Вызывает исключения**:
- None

### `_start_chat(self)`

**Назначение**: Запускает сессию чата с моделью ИИ.

**Как работает функция**:
Функция `_start_chat` инициализирует сессию чата с пустой историей. Это подготавливает модель к интерактивному взаимодействию, позволяя вести диалог.

**Параметры**:
- None

**Возвращает**:
- None

**Вызывает исключения**:
- None

### `_save_dialogue(self, dialogue: list)`

**Назначение**: Сохраняет диалог в текстовые и JSON файлы.

**Как работает функция**:
Функция `_save_dialogue` принимает список сообщений диалога и сохраняет их в двух форматах: текстовом и JSON. Каждое сообщение добавляется в текстовый файл для удобства чтения, а также сохраняется в формате JSON для последующего анализа и обработки.

**Параметры**:
- `dialogue` (list): Список сообщений диалога.

**Возвращает**:
- None

**Вызывает исключения**:
- None

### `ask(self, q: str, attempts: int = 15) -> Optional[str]`

**Назначение**: Отправляет текстовый запрос модели ИИ и получает ответ.

**Как работает функция**:
Функция `ask` отправляет текстовый запрос `q` модели ИИ и пытается получить ответ. Если происходят ошибки сети или сервис недоступен, она повторяет попытки до `attempts` раз. В случае успеха возвращает текст ответа, в противном случае логирует ошибку и возвращает `None`.

Внутри функции происходят следующие действия и преобразования:
A: Отправка запроса `q` к модели ИИ.
|
B: Обработка возможных ошибок сети или недоступности сервиса.
|
C: Логирование ошибок и повторные попытки с экспоненциальной задержкой.
|
D: Сохранение диалога в файлы истории.
|
E: Возвращение текста ответа или `None` в случае неудачи.

**Параметры**:
- `q` (str): Текстовый запрос.
- `attempts` (int, optional): Количество попыток. По умолчанию `15`.

**Возвращает**:
- `Optional[str]`: Текст ответа или `None` в случае ошибки.

**Вызывает исключения**:
- None

### `chat(self, q: str) -> str`

**Назначение**: Отправляет сообщение чата модели ИИ и получает ответ.

**Как работает функция**:
Функция `chat` использует сессию чата, инициализированную методом `_start_chat`, для отправки сообщения `q` модели ИИ и получения ответа. Логирует ошибки и возвращает текст ответа.

**Параметры**:
- `q` (str): Сообщение чата.

**Возвращает**:
- `str`: Текст ответа.

**Вызывает исключения**:
- None

### `describe_image(self, image_path: Path) -> Optional[str]`

**Назначение**: Генерирует текстовое описание изображения.

**Как работает функция**:
Функция `describe_image` принимает путь к изображению, кодирует изображение в base64 и отправляет его модели ИИ. Возвращает сгенерированное описание или логирует ошибку, если операция не удалась.

**Параметры**:
- `image_path` (Path): Путь к изображению.

**Возвращает**:
- `Optional[str]`: Сгенерированное описание или `None` в случае ошибки.

**Вызывает исключения**:
- None

### `upload_file(self, file: str | Path | IOBase, file_name: Optional[str] = None) -> bool`

**Назначение**: Загружает файл в модель ИИ.

**Как работает функция**:
Функция `upload_file` обрабатывает загрузку файла в модель ИИ и логирует успех или неудачу. Предоставляет логику повторных попыток в случае ошибок.

**Параметры**:
- `file` (str | Path | IOBase): Файл для загрузки.
- `file_name` (Optional[str], optional): Имя файла. По умолчанию `None`.

**Возвращает**:
- `bool`: `True` в случае успеха, `False` в случае неудачи.

**Вызывает исключения**:
- None

## Обработка ошибок

Класс включает в себя комплексную обработку ошибок для различных сценариев:
- **Ошибки сети**: Повторяет попытки с экспоненциальной задержкой.
- **Недоступность сервиса**: Ведет журнал ошибок и повторяет попытки.
- **Лимиты квот**: Ведет журнал и ждет перед повторной попыткой.
- **Ошибки аутентификации**: Ведет журнал и прекращает дальнейшие попытки.
- **Неверный ввод**: Ведет журнал и повторяет попытки с таймаутом.
- **Ошибки API**: Ведет журнал и прекращает дальнейшие попытки.

## Ведение журнала и история

Все взаимодействия с моделями ИИ ведутся в журнале, и диалоги сохраняются как в текстовых, так и в JSON форматах для последующего анализа. Это обеспечивает отслеживаемость всех операций и возможность их просмотра для отладки или аудита.

## Зависимости

- `google.generativeai`
- `requests`
- `grpc`
- `google.api_core.exceptions`
- `google.auth.exceptions`
- `src.logger`
- `src.utils.printer`
- `src.utils.file`
- `src.utils.date_time`
- `src.utils.convertors.unicode`
- `src.utils.jjson`

## Пример использования

```python
ai = GoogleGenerativeAI(api_key="your_api_key", system_instruction="Instruction")
response = ai.ask("Как дела?")
print(response)
```

Этот пример инициализирует класс `GoogleGenerativeAI` и отправляет запрос модели ИИ, выводя ответ.

---

Для получения более подробной информации обратитесь к исходному коду и комментариям внутри класса `GoogleGenerativeAI`.