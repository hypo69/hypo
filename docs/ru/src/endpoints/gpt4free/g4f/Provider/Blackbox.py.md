# Модуль Blackbox

## Обзор

Модуль `Blackbox` предоставляет класс `Blackbox`, который является асинхронным провайдером для взаимодействия с API Blackbox AI. Он поддерживает текстовые и визуальные модели, а также различные режимы агентов. Этот модуль предназначен для интеграции с платформой g4f (gpt4free) и обеспечивает функциональность для генерации текста и изображений с использованием Blackbox AI.

## Подробней

Модуль `Blackbox` предназначен для упрощения взаимодействия с API Blackbox AI, предоставляя удобные методы для создания сессий, запроса моделей и генерации контента. Он также включает механизмы для автоматического обнаружения и использования премиум-аккаунтов, если они доступны через HAR-файлы. Это позволяет пользователям получать доступ к полному списку моделей и функций, предоставляемых Blackbox AI.

## Классы

### `Conversation(JsonConversation)`

**Описание**: Класс `Conversation` представляет собой разговор с AI. Он хранит информацию о текущем состоянии разговора, такую как ID чата, историю сообщений и модель, используемую в разговоре.

**Наследует**:
- `JsonConversation`: Этот класс, вероятно, предоставляет базовую функциональность для работы с разговорами в формате JSON, такую как сериализация и десериализация.

**Атрибуты**:
- `validated_value` (str): Строка, представляющая собой валидированное значение для текущего разговора.
- `chat_id` (str): Уникальный идентификатор текущего чата.
- `message_history` (Messages): Список сообщений в истории разговора. Тип `Messages` предполагает, что это список, содержащий структуру сообщений, специфичную для данного модуля.
- `model` (str): Модель, используемая в разговоре.

**Методы**:
- `__init__(self, model: str)`: Инициализирует новый экземпляр класса `Conversation`.

### `Blackbox(AsyncGeneratorProvider, ProviderModelMixin)`

**Описание**: Класс `Blackbox` является асинхронным провайдером для взаимодействия с API Blackbox AI. Он поддерживает потоковую генерацию текста и изображений, а также предоставляет методы для управления сессиями и выбора моделей.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронной генерации контента.
- `ProviderModelMixin`: Предоставляет методы для управления и выбора моделей.

**Атрибуты**:
- `label` (str): "Blackbox AI" - название провайдера.
- `url` (str): "https://www.blackbox.ai" - URL главной страницы Blackbox AI.
- `api_endpoint` (str): "https://www.blackbox.ai/api/chat" - URL API для чата.
- `working` (bool): `True` - указывает, что провайдер в рабочем состоянии.
- `supports_stream` (bool): `True` - указывает, что провайдер поддерживает потоковую генерацию.
- `supports_system_message` (bool): `True` - указывает, что провайдер поддерживает системные сообщения.
- `supports_message_history` (bool): `True` - указывает, что провайдер поддерживает историю сообщений.
- `default_model` (str): "blackboxai" - модель, используемая по умолчанию.
- `default_vision_model` (str): "blackboxai" - модель для работы с изображениями, используемая по умолчанию.
- `default_image_model` (str): 'flux' - модель для генерации изображений, используемая по умолчанию.
- `fallback_models` (list): Список моделей, доступных для неавторизованных пользователей.
- `image_models` (list): Список моделей для работы с изображениями.
- `vision_models` (list): Список моделей, поддерживающих зрение.
- `userSelectedModel` (list): Список моделей, выбранных пользователем.
- `agentMode` (dict): Конфигурации для режимов агентов.
- `trendingAgentMode` (dict): Конфигурации для популярных режимов агентов.
- `_all_models` (list): Полный список всех доступных моделей.
- `models` (list): Инициализируется как `fallback_models` - список доступных моделей.
- `model_aliases` (dict): Псевдонимы моделей для упрощения использования.

**Методы**:
- `generate_session(cls, id_length: int = 21, days_ahead: int = 365) -> dict`: Генерирует динамическую сессию с правильным форматом ID и срока действия.
- `fetch_validated(cls, url: str = "https://www.blackbox.ai", force_refresh: bool = False) -> Optional[str]`: Извлекает валидированное значение с веб-сайта Blackbox AI.
- `generate_id(cls, length: int = 7) -> str`: Генерирует случайный ID заданной длины.
- `get_models(cls) -> list`: Возвращает список доступных моделей в зависимости от статуса авторизации пользователя.
- `_check_premium_access(cls) -> bool`: Проверяет наличие авторизованной сессии в HAR-файлах.
- `create_async_generator(...) -> AsyncResult`: Создает асинхронный генератор для взаимодействия с API Blackbox AI.

## Функции

### `generate_session(cls, id_length: int = 21, days_ahead: int = 365) -> dict`

**Назначение**: Генерирует динамическую сессию с правильным форматом ID и срока действия. Эта функция создает сессионный словарь, содержащий информацию о пользователе и сроке действия сессии.

**Параметры**:
- `id_length` (int): Длина числового ID (по умолчанию: 21).
- `days_ahead` (int): Количество дней до истечения срока действия (по умолчанию: 365).

**Возвращает**:
- `dict`: Словарь сессии с информацией о пользователе и сроке действия.

**Как работает функция**:
1. **Генерация числового ID**: Функция генерирует случайный числовой ID указанной длины.
2. **Генерация даты истечения срока действия**: Вычисляет будущую дату истечения срока действия на основе текущей даты и заданного количества дней.
3. **Декодирование закодированного email**: Декодирует email адрес из base64 строки.
4. **Генерация случайного ID изображения**: Генерирует случайный ID для URL изображения.
5. **Формирование словаря сессии**: Создает и возвращает словарь, содержащий имя пользователя, email, URL изображения, ID и срок действия.

```
    A: Генерация числового ID
    │
    B: Генерация даты истечения срока действия
    │
    C: Декодирование закодированного email
    │
    D: Генерация случайного ID изображения
    │
    E: Формирование словаря сессии
    │
    F: Возврат словаря сессии
```

**Примеры**:
```python
session = Blackbox.generate_session()
print(session)
# {'user': {'name': 'BLACKBOX AI', 'email': 'gisele@blackbox.ai', 'image': 'https://lh3.googleusercontent.com/a/ACg8oc...=s96-c', 'id': '...'}, 'expires': '2025-05-22T12:34:56.789Z'}

session = Blackbox.generate_session(id_length=10, days_ahead=100)
print(session)
# {'user': {'name': 'BLACKBOX AI', 'email': 'gisele@blackbox.ai', 'image': 'https://lh3.googleusercontent.com/a/ACg8oc...=s96-c', 'id': '...'}, 'expires': '2024-08-31T12:34:56.789Z'}
```

### `fetch_validated(cls, url: str = "https://www.blackbox.ai", force_refresh: bool = False) -> Optional[str]`

**Назначение**: Извлекает валидированное значение с веб-сайта Blackbox AI. Эта функция пытается получить `validated_value` из кэша, если он существует, или извлекает его с веб-сайта Blackbox AI, используя регулярные выражения для поиска JavaScript-файлов и UUID.

**Параметры**:
- `url` (str): URL для извлечения валидированного значения (по умолчанию: "https://www.blackbox.ai").
- `force_refresh` (bool): Если `True`, принудительно обновляет кэш (по умолчанию: `False`).

**Возвращает**:
- `Optional[str]`: Валидированное значение или `None`, если не удалось получить.

**Как работает функция**:
1. **Проверка кэша**: Функция проверяет, существует ли файл кэша и содержит ли он валидированное значение. Если да, возвращает его.
2. **Поиск JavaScript-файлов**: Если кэш не найден или `force_refresh` установлен в `True`, функция извлекает содержимое веб-страницы и ищет JavaScript-файлы, соответствующие определенному шаблону.
3. **Поиск UUID**: В каждом найденном JavaScript-файле функция ищет UUID, используя регулярные выражения.
4. **Проверка контекста**: Проверяет, является ли контекст вокруг найденного UUID валидным.
5. **Кэширование валидированного значения**: Если UUID найден и контекст валиден, функция сохраняет валидированное значение в кэш.
6. **Возврат валидированного значения**: Возвращает найденное и кэшированное валидированное значение.

```
    A: Проверка кэша
    │
    B: Извлечение содержимого веб-страницы
    │
    C: Поиск JavaScript-файлов
    │
    D: Поиск UUID в JavaScript-файлах
    │
    E: Проверка контекста UUID
    │
    F: Кэширование валидированного значения
    │
    G: Возврат валидированного значения
```

**Примеры**:
```python
validated_value = await Blackbox.fetch_validated()
print(validated_value)
# "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"

validated_value = await Blackbox.fetch_validated(force_refresh=True)
print(validated_value)
# "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

### `generate_id(cls, length: int = 7) -> str`

**Назначение**: Генерирует случайный ID заданной длины. Эта функция создает случайную строку, состоящую из букв и цифр.

**Параметры**:
- `length` (int): Длина генерируемого ID (по умолчанию: 7).

**Возвращает**:
- `str`: Случайный ID.

**Как работает функция**:
1. **Определение набора символов**: Определяет набор символов, из которых будет генерироваться ID (буквы и цифры).
2. **Генерация случайного ID**: Генерирует случайную строку заданной длины, выбирая случайные символы из определенного набора.
3. **Возврат ID**: Возвращает сгенерированный ID.

```
    A: Определение набора символов
    │
    B: Генерация случайного ID
    │
    C: Возврат ID
```

**Примеры**:
```python
id = Blackbox.generate_id()
print(id)
# "aBc12De"

id = Blackbox.generate_id(length=10)
print(id)
# "1aB2cDeF3g"
```

### `get_models(cls) -> list`

**Назначение**: Возвращает список доступных моделей в зависимости от статуса авторизации пользователя. Авторизованные пользователи получают полный список моделей, в то время как неавторизованные пользователи получают только `fallback_models`.

**Возвращает**:
- `list`: Список доступных моделей.

**Как работает функция**:
1. **Проверка премиум-доступа**: Функция проверяет наличие премиум-доступа, используя метод `_check_premium_access`.
2. **Возврат списка моделей**: Если премиум-доступ подтвержден, возвращается полный список моделей (`_all_models`). В противном случае возвращается список `fallback_models`.

```
    A: Проверка премиум-доступа
    │
    B: Возврат списка моделей (полный или fallback)
```

**Примеры**:
```python
models = Blackbox.get_models()
print(models)
# ["blackboxai", "gpt-4o-mini", ...] (если нет премиум-доступа)

models = Blackbox.get_models()
print(models)
# ["blackboxai", "GPT-4o", "flux", ...] (если есть премиум-доступ)
```

### `_check_premium_access(cls) -> bool`

**Назначение**: Проверяет наличие авторизованной сессии в HAR-файлах. Функция ищет HAR-файлы в определенной директории и анализирует их содержимое для определения, имеет ли пользователь премиум-доступ.

**Возвращает**:
- `bool`: `True`, если найдена валидная сессия, отличная от демонстрационной, иначе `False`.

**Как работает функция**:
1. **Проверка директории HAR**: Функция проверяет, существует ли директория с HAR-файлами и имеет ли у пользователя права на чтение этой директории.
2. **Поиск HAR-файлов**: Функция ищет HAR-файлы в указанной директории.
3. **Анализ HAR-файлов**: Для каждого найденного HAR-файла функция пытается проанализировать его содержимое и найти записи, относящиеся к API Blackbox AI.
4. **Извлечение данных сессии**: Извлекает данные сессии из ответов API Blackbox AI.
5. **Проверка сессии**: Проверяет, является ли найденная сессия валидной и отличается ли она от демонстрационной сессии.
6. **Возврат результата**: Если найдена валидная сессия, отличная от демонстрационной, функция возвращает `True`, иначе `False`.

```
    A: Проверка директории HAR
    │
    B: Поиск HAR-файлов
    │
    C: Анализ HAR-файлов
    │
    D: Извлечение данных сессии
    │
    E: Проверка сессии
    │
    F: Возврат результата
```

**Примеры**:
```python
has_premium_access = Blackbox._check_premium_access()
print(has_premium_access)
# True (если премиум-доступ подтвержден)

has_premium_access = Blackbox._check_premium_access()
print(has_premium_access)
# False (если премиум-доступ не подтвержден)
```

### `create_async_generator(cls, model: str, messages: Messages, prompt: str = None, proxy: str = None, media: MediaListType = None, top_p: float = None, temperature: float = None, max_tokens: int = None, conversation: Conversation = None, return_conversation: bool = False, **kwargs) -> AsyncResult`

**Назначение**: Создает асинхронный генератор для взаимодействия с API Blackbox AI. Эта функция отправляет сообщения в API Blackbox AI и возвращает асинхронный генератор, который выдает ответы по мере их поступления.

**Параметры**:
- `model` (str): Модель, используемая для генерации ответа.
- `messages` (Messages): Список сообщений для отправки в API.
- `prompt` (str): Дополнительный промпт для генерации (по умолчанию: `None`).
- `proxy` (str): Прокси-сервер для использования (по умолчанию: `None`).
- `media` (MediaListType): Список медиа-файлов для отправки в API (по умолчанию: `None`).
- `top_p` (float): Параметр top_p для управления случайностью генерации (по умолчанию: `None`).
- `temperature` (float): Параметр temperature для управления случайностью генерации (по умолчанию: `None`).
- `max_tokens` (int): Максимальное количество токенов в ответе (по умолчанию: `None`).
- `conversation` (Conversation): Объект разговора для сохранения истории (по умолчанию: `None`).
- `return_conversation` (bool): Если `True`, возвращает объект разговора в конце генерации (по умолчанию: `False`).
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий ответы от API.

**Как работает функция**:
1. **Выбор модели**: Функция выбирает модель для генерации ответа, используя метод `get_model`.
2. **Создание заголовков**: Создает заголовки для HTTP-запроса.
3. **Инициализация разговора**: Если объект разговора не предоставлен или не имеет `chat_id`, функция создает новый объект разговора и генерирует `validated_value` и `chat_id`.
4. **Формирование сообщений**: Функция формирует список сообщений для отправки в API, добавляя информацию об ID сообщения, содержимом и роли.
5. **Обработка медиа-файлов**: Если предоставлены медиа-файлы, функция добавляет их в последнее сообщение.
6. **Получение данных сессии**: Функция пытается получить данные сессии из HAR-файлов или генерирует новую сессию, если HAR-файлы не найдены.
7. **Формирование данных запроса**: Функция формирует словарь данных для отправки в API, включая сообщения, параметры генерации и данные сессии.
8. **Отправка запроса в API**: Функция отправляет POST-запрос в API Blackbox AI с сформированными данными.
9. **Обработка ответа**: Функция обрабатывает ответ от API, извлекая сгенерированный текст или URL изображения (для моделей генерации изображений).
10. **Возврат асинхронного генератора**: Функция возвращает асинхронный генератор, который выдает ответы по мере их поступления.

```
    A: Выбор модели
    │
    B: Создание заголовков
    │
    C: Инициализация разговора
    │
    D: Формирование сообщений
    │
    E: Обработка медиа-файлов
    │
    F: Получение данных сессии
    │
    G: Формирование данных запроса
    │
    H: Отправка запроса в API
    │
    I: Обработка ответа
    │
    J: Возврат асинхронного генератора
```

**Примеры**:
```python
messages = [{"role": "user", "content": "Hello, how are you?"}]
async_generator = await Blackbox.create_async_generator(model="blackboxai", messages=messages)
async for message in async_generator:
    print(message)
# "I am doing well, thank you for asking!"

messages = [{"role": "user", "content": "Draw me a cat."}]
async_generator = await Blackbox.create_async_generator(model=Blackbox.default_image_model, messages=messages)
async for message in async_generator:
    print(message)
# ImageResponse(images=["https://example.com/image.jpg"], alt="Draw me a cat.")