# Сценарий обработки списка продуктов (scenario_picelist.process_ai.mmd)

## Обзор

Данный сценарий описывает процесс обработки запроса пользователя на получение списка продуктов от модели AI.  Сценарий включает в себя обработку потенциальных ошибок, таких как отсутствие ответа от модели, невалидные данные, и некорректные значения.

## Диаграмма последовательности

```plantuml
@startuml
sequenceDiagram
    participant User
    participant AI_Model
    participant Logger

    User->>AI_Model: Запрос на обработку продуктов (products_list)
    AI_Model->>AI_Model: Обработка запроса с командой модели
    AI_Model->>User: Ответ от модели

    alt Нет ответа от модели
        Logger->>Logger: Логирирование ошибки "no response from gemini"
        User->>AI_Model: Повторный запрос (attempts - 1)
    end

    alt Невалидные данные (data)
        Logger->>Logger: Логирирование ошибки "Error in data from gemini"
        User->>AI_Model: Повторный запрос (attempts - 1)
    end

    alt Получены данные (data)
        alt Данные в виде списка
            alt Два элемента (ru, he)
                User->>User: Извлечение ru и he
            end
            alt Один элемент
                User->>User: Извлечение ru и he из первого элемента
            end
            alt Невалидная структура данных
                Logger->>Logger: Логирирование ошибки "Проблема парсинга ответа"
                User->>AI_Model: Повторный запрос (attempts - 1)
            end
        end

        alt Данные в виде объекта
            User->>User: Извлечение ru и he из объекта
        end

        alt Невалидные значения (ru или he)
            Logger->>Logger: Логирирование ошибки "Invalid ru or he data"
            User->>AI_Model: Повторный запрос (attempts - 1)
        end

        User->>User: Возврат результата ru и he
    end
@enduml
```

## Обработка ошибок

При возникновении ошибок выполняется логирование в `Logger`, а клиент получает повторный запрос с уменьшенным количеством попыток. Ошибки, которые могут возникнуть:

* **"no response from gemini"**: Отсутствие ответа от AI-модели.
* **"Error in data from gemini"**: Невалидные данные, полученные от AI-модели.
* **"Проблема парсинга ответа"**: Невалидная структура данных, полученная от AI-модели.
* **"Invalid ru or he data"**: Невалидные значения `ru` или `he` в полученных данных.


## Поток обработки данных


1. **Запрос к модели:** Пользователь отправляет запрос на получение списка продуктов.
2. **Обработка запроса:** Модель AI обрабатывает запрос и возвращает данные.
3. **Проверка ответа:**  Программа проверяет, получен ли ответ. Если нет, логируется ошибка "no response from gemini" и делается повторный запрос.
4. **Проверка валидности данных:** Проверяется корректность полученных данных. Если данные невалидные, логируется ошибка, и делается повторный запрос.
5. **Извлечение данных:** В зависимости от типа данных (список или объект), извлекаются значения `ru` и `he`.
6. **Проверка значений:** Проверяется корректность значений `ru` и `he`. Если значения некорректны, логируется ошибка, и делается повторный запрос.
7. **Возврат результата:** Если все проверки пройдены, программа возвращает полученные значения `ru` и `he`.

##  Рекомендации по улучшению

* Добавить механизм для ограничение количества неудачных попыток, чтобы предотвратить бесконечный цикл при непреодолимых проблемах.
* Уточнить типы данных для `ru` и `he`, чтобы предотвратить ошибки обработки типов.
* Подробнее описать типы данных и структуры, которые ожидаются от модели AI, для избежания неоднозначности.
* Добавить логирование дополнительных параметров, таких как ID запроса, тип данных, полученных от модели, для лучшего отслеживания ошибок.