# Модуль для поиска свободного порта

## Обзор

Модуль предоставляет функцию `get_free_port`, которая позволяет найти свободный порт в заданном диапазоне или первый доступный порт, если диапазон не указан.

## Подробней

Данный модуль предназначен для поиска свободного порта, который может быть использован для сетевых соединений. Он проверяет, занят ли порт, и возвращает первый свободный порт в указанном диапазоне или первый доступный порт, если диапазон не задан. Модуль использует сокеты для проверки доступности портов и предоставляет возможность указания диапазона портов в виде строки или списка строк.

## Функции

### `get_free_port`

```python
def get_free_port(host: str, port_range: Optional[str | List[str]] = None) -> int:
    """
    Находит и возвращает свободный порт в указанном диапазоне или первый доступный порт, если диапазон не указан.

    Args:
        host (str): Адрес хоста для проверки доступных портов.
        port_range (Optional[str | List[str]], optional): Диапазон портов, заданный как строка "min-max" или список строк.
               Например: "3000-3999", ["3000-3999", "8000-8010"], None. По умолчанию `None`.

    Returns:
        int: Доступный номер порта.

    Raises:
        ValueError: Если не удается найти свободный порт в указанном диапазоне или если диапазон портов недействителен.
    """
```

**Назначение**: Находит и возвращает свободный порт в указанном диапазоне или первый доступный порт, если диапазон не указан.

**Параметры**:
- `host` (str): Адрес хоста для проверки доступных портов.
- `port_range` (Optional[str | List[str]], optional): Диапазон портов, заданный как строка "min-max" или список строк. Например: "3000-3999", ["3000-3999", "8000-8010"], None. По умолчанию `None`.

**Возвращает**:
- `int`: Доступный номер порта.

**Вызывает исключения**:
- `ValueError`: Если не удается найти свободный порт в указанном диапазоне или если диапазон портов недействителен.

**Как работает функция**:

1.  Функция `get_free_port` принимает адрес хоста (`host`) и необязательный диапазон портов (`port_range`).

2.  Если `port_range` указан:
    *   Проверяется тип `port_range`: строка или список.
    *   Если строка, вызывается `_parse_port_range` для получения минимального и максимального портов.
    *   Если список, перебираются элементы списка, и для каждого элемента, являющегося строкой, вызывается `_parse_port_range`.
    *   Внутри каждого допустимого диапазона портов перебираются порты и проверяется, используется ли порт с помощью `_is_port_in_use`.
    *   Если порт не используется, он возвращается.
    *   Если ни один свободный порт не найден в указанных диапазонах, вызывается исключение `ValueError`.
    *   Если тип `port_range` не строка и не список, вызывается исключение `ValueError`.

3.  Если `port_range` не указан:
    *   Начинается поиск с порта 1024 (так как порты ниже 1024 обычно зарезервированы для системных служб).
    *   Проверяется, используется ли порт с помощью `_is_port_in_use`.
    *   Если порт не используется, он возвращается.
    *   Если порт используется, номер порта увеличивается на 1.
    *   Если достигнут максимальный номер порта (65535) и свободный порт не найден, вызывается исключение `ValueError`.

4.  Функция логирует ошибки с использованием `logger.error` при возникновении исключений `ValueError`.

```
A: Начало
│
B: Проверка наличия port_range
│
├─── Да ─── C: Проверка типа port_range
│           │
│           ├─── Строка ─── D: _parse_port_range(port_range)
│           │               │
│           │               E: Цикл по диапазону портов
│           │               │
│           │               F: _is_port_in_use(host, port)
│           │               │
│           │               └─── Нет ─── G: Возврат port
│           │
│           └─── Список ─── H: Цикл по элементам port_range
│                           │
│                           I: Проверка типа элемента
│                           │
│                           └─── Строка ─── J: _parse_port_range(item)
│                                           │
│                                           K: Цикл по диапазону портов
│                                           │
│                                           L: _is_port_in_use(host, port)
│                                           │
│                                           └─── Нет ─── M: Возврат port
│
└─── Нет ─── N: port = 1024
            │
            O: Цикл поиска порта
            │
            P: _is_port_in_use(host, port)
            │
            └─── Нет ─── Q: Возврат port
```

**Внутренние функции**:

#### `_is_port_in_use`

```python
    def _is_port_in_use(host: str, port: int) -> bool:
        """
        Проверяет, используется ли данный порт на указанном хосте.

        Args:
            host (str): Адрес хоста.
            port (int): Номер порта для проверки.

        Returns:
            bool: True, если порт используется, False в противном случае.
        """
```

**Назначение**: Проверяет, используется ли указанный порт на заданном хосте.

**Параметры**:
- `host` (str): Адрес хоста.
- `port` (int): Номер порта для проверки.

**Возвращает**:
- `bool`: `True`, если порт используется, `False` в противном случае.

**Как работает функция**:

1.  Создается сокет `socket.socket(socket.AF_INET, socket.SOCK_STREAM)`.
2.  Пытается привязать сокет к указанному хосту и порту (`sock.bind((host, port))`).
3.  Если привязка успешна, значит, порт свободен, и функция возвращает `False`.
4.  Если при привязке возникает исключение `OSError`, значит, порт занят, и функция возвращает `True`.

#### `_parse_port_range`

```python
    def _parse_port_range(port_range_str: str) -> Tuple[int, int]:
        """
        Разбирает строку диапазона портов "min-max" в кортеж (min_port, max_port).

        Args:
            port_range_str (str): Строка диапазона портов.

        Returns:
            Tuple[int, int]: Кортеж, содержащий минимальный и максимальный номера портов.

        Raises:
            ValueError: Если формат строки диапазона портов недействителен.
        """
```

**Назначение**: Разбирает строку диапазона портов "min-max" в кортеж (min\_port, max\_port).

**Параметры**:
- `port_range_str` (str): Строка диапазона портов.

**Возвращает**:
- `Tuple[int, int]`: Кортеж, содержащий минимальный и максимальный номера портов.

**Вызывает исключения**:
- `ValueError`: Если формат строки диапазона портов недействителен.

**Как работает функция**:

1.  Разделяет строку `port_range_str` на две части по символу "-".
2.  Проверяет, что получено ровно две части. Если нет, вызывает исключение `ValueError` и логирует ошибку.
3.  Преобразует обе части в целые числа. Если преобразование не удается, вызывает исключение `ValueError` и логирует ошибку.
4.  Проверяет, что минимальный порт меньше или равен максимальному порту. Если нет, вызывает исключение `ValueError` и логирует ошибку.
5.  Возвращает кортеж, содержащий минимальный и максимальный номера портов.

**Примеры**:

```python
    >>> get_free_port('localhost', '3000-3005')
    3001
    >>> get_free_port('localhost', ['3000-3005', '8000-8010'])
    3001
    >>> get_free_port('localhost')
    1024