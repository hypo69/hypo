# Модуль `backend.py`

## Обзор

Модуль `backend.py` является частью серверной логики приложения `freegpt-webui-ru` и отвечает за обработку запросов к API, взаимодействие с моделями генерации текста (например, g4f), а также реализацию различных функций, таких как поддержка прокси, jailbreak-инструкции и перевод языка ответа.

## Подробней

Этот модуль содержит класс `Backend_Api`, который инициализирует API endpoints и обрабатывает входящие запросы. Он также включает функции для построения сообщений, поиска в интернете и генерации ответов с учетом jailbreak-инструкций.

## Классы

### `Backend_Api`

**Описание**: Класс `Backend_Api` управляет API endpoints для обработки запросов и генерации ответов.

**Принцип работы**:
Класс инициализируется с приложением Flask и конфигурацией. Он определяет маршруты для API endpoints, такие как `/backend-api/v2/conversation`, который обрабатывает запросы на генерацию текста. Если включено использование автоматических прокси, класс также запускает поток для обновления списка рабочих прокси.

**Методы**:

- `__init__(self, app, config: dict) -> None`:
    ```python
    def __init__(self, app, config: dict) -> None:
        """Инициализирует экземпляр класса Backend_Api.

        Args:
            app: Flask-приложение.
            config (dict): Словарь с конфигурационными параметрами, включая `use_auto_proxy`.

        Returns:
            None
        """
    ```
    **Параметры**:
    - `app`: Flask-приложение, используемое для маршрутизации запросов.
    - `config` (dict): Словарь с конфигурационными параметрами, включая `use_auto_proxy`.

    **Как работает функция**:
     1. Функция принимает Flask-приложение и словарь конфигурации в качестве входных данных.
     2. Инициализирует атрибуты экземпляра класса, такие как `app`, `use_auto_proxy` и `routes`.
     3. Определяет маршруты API и соответствующие функции для обработки запросов.
     4. Если в конфигурации указано использование автоматических прокси, запускает поток для обновления списка рабочих прокси в фоновом режиме.

    - `_conversation(self)`:
    ```python
    def _conversation(self):
        """Обрабатывает запрос на генерацию текста.

        Args:
            None

        Returns:
            Flask.response_class: Поток событий сервера (Server-Sent Events) сгенерированного ответа.
            tuple: Кортеж, содержащий словарь с информацией об ошибке и код состояния HTTP 400 в случае возникновения ошибки.

        Raises:
            Exception: Если возникает ошибка при обработке запроса или генерации ответа.
        """
    ```

    **Параметры**:
    - Отсутствуют.

    **Возвращает**:
    - `Flask.response_class`: Поток событий сервера (Server-Sent Events) сгенерированного ответа.
    - `tuple`: Кортеж, содержащий словарь с информацией об ошибке и код состояния HTTP 400 в случае возникновения ошибки.

    **Как работает функция**:
    1.  Извлекает параметры запроса из JSON-данных, такие как `stream`, `jailbreak` и `model`.
    2.  Вызывает функцию `build_messages` для построения списка сообщений на основе параметров запроса.
    3.  Вызывает `ChatCompletion.create` из библиотеки `g4f` для генерации ответа на основе указанной модели и сообщений.
    4.  Возвращает поток событий сервера (Server-Sent Events) сгенерированного ответа с использованием функции `generate_stream`.
    5.  В случае возникновения ошибки, возвращает словарь с информацией об ошибке и код состояния HTTP 400.

## Функции

### `build_messages(jailbreak)`

```python
def build_messages(jailbreak):
    """Создает список сообщений для запроса к модели.

    Args:
        jailbreak: Имя jailbreak-инструкции.

    Returns:
        list: Список сообщений для запроса к модели.

    Raises:
        None
    """
```

**Параметры**:
- `jailbreak`: Имя jailbreak-инструкции.

**Возвращает**:
- `list`: Список сообщений для запроса к модели.

**Как работает функция**:
1. Извлекает данные из запроса, такие как `_conversation` (история разговоров), `internet_access` (доступ к интернету) и `prompt` (запрос пользователя).
2. Формирует системное сообщение, включающее текущую дату и язык ответа.
3. Инициализирует разговор с системным сообщением.
4. Добавляет существующую историю разговоров.
5. Если включен доступ к интернету, добавляет результаты поиска в разговор.
6. Если указана jailbreak-инструкция, добавляет ее в разговор.
7. Добавляет запрос пользователя в разговор.
8. Ограничивает размер разговора, чтобы избежать ошибок, связанных с количеством токенов API.

**Примеры**:

```python
# Пример вызова функции
messages = build_messages("Default")
```

### `fetch_search_results(query)`

```python
def fetch_search_results(query):
    """Выполняет поиск в интернете и возвращает результаты.

    Args:
        query: Поисковый запрос.

    Returns:
        list: Список результатов поиска в формате сообщений для модели.

    Raises:
        None
    """
```

**Параметры**:
- `query`: Поисковый запрос.

**Возвращает**:
- `list`: Список результатов поиска в формате сообщений для модели.

**Как работает функция**:
1. Выполняет поиск в интернете с использованием API DuckDuckGo.
2. Формирует список результатов поиска, включая сниппеты и ссылки.
3. Преобразует результаты поиска в формат сообщений для модели.

**Примеры**:

```python
# Пример вызова функции
results = fetch_search_results("Что такое Python?")
```

### `generate_stream(response, jailbreak)`

```python
def generate_stream(response, jailbreak):
    """Генерирует поток ответов с учетом jailbreak-инструкций.

    Args:
        response: Объект ответа от модели.
        jailbreak: Имя jailbreak-инструкции.

    Yields:
        str: Часть сгенерированного ответа.

    Raises:
        None
    """
```

**Параметры**:
- `response`: Объект ответа от модели.
- `jailbreak`: Имя jailbreak-инструкции.

**Yields**:
- `str`: Часть сгенерированного ответа.

**Как работает функция**:
1. Проверяет, используется ли jailbreak-инструкция.
2. Если jailbreak используется, анализирует ответ модели на предмет соответствия jailbreak-инструкциям.
3. Если jailbreak не используется, возвращает ответ модели без изменений.

**Примеры**:

```python
# Пример вызова функции
stream = generate_stream(response, "Default")
for message in stream:
    print(message)
```

### `response_jailbroken_success(response: str) -> bool`

```python
def response_jailbroken_success(response: str) -> bool:
    """Определяет, успешно ли выполнена jailbreak-инструкция.

    Args:
        response (str): Ответ от модели.

    Returns:
        bool: True, если jailbreak-инструкция выполнена успешно, иначе False.

    Raises:
        None
    """
```

**Параметры**:
- `response` (str): Ответ от модели.

**Возвращает**:
- `bool`: True, если jailbreak-инструкция выполнена успешно, иначе False.

**Как работает функция**:
1. Ищет в ответе модели маркер "ACT:", указывающий на успешное выполнение jailbreak-инструкции.
2. Возвращает True, если маркер найден, иначе False.

**Примеры**:

```python
# Пример вызова функции
success = response_jailbroken_success("ACT: Jailbreak выполнен успешно")
print(success)  # Вывод: True
```

### `response_jailbroken_failed(response)`

```python
def response_jailbroken_failed(response):
    """Определяет, не удалось ли выполнить jailbreak-инструкцию.

    Args:
        response: Ответ от модели.

    Returns:
        bool: True, если jailbreak-инструкция не выполнена, иначе False.

    Raises:
        None
    """
```

**Параметры**:
- `response`: Ответ от модели.

**Возвращает**:
- `bool`: True, если jailbreak-инструкция не выполнена, иначе False.

**Как работает функция**:
1. Проверяет, начинается ли ответ модели с маркеров "GPT:" или "ACT:".
2. Если ответ не начинается с указанных маркеров и имеет длину не менее 4 символов, возвращает True, иначе False.

**Примеры**:

```python
# Пример вызова функции
failed = response_jailbroken_failed("Неизвестный ответ")
print(failed)  # Вывод: True
```

### `set_response_language(prompt)`

```python
def set_response_language(prompt):
    """Определяет язык запроса и возвращает инструкцию для модели.

    Args:
        prompt: Запрос пользователя.

    Returns:
        str: Инструкция для модели о языке ответа.

    Raises:
        None
    """
```

**Параметры**:
- `prompt`: Запрос пользователя.

**Возвращает**:
- `str`: Инструкция для модели о языке ответа.

**Как работает функция**:
1. Определяет язык запроса пользователя с использованием библиотеки `googletrans`.
2. Формирует инструкцию для модели, указывающую на необходимость ответа на определенном языке.

**Примеры**:

```python
# Пример вызова функции
instruction = set_response_language({"content": "Привет мир!"})
print(instruction)  # Вывод: You will respond in the language: ru.
```

### `isJailbreak(jailbreak)`

```python
def isJailbreak(jailbreak):
    """Определяет, используется ли jailbreak-инструкция.

    Args:
        jailbreak: Имя jailbreak-инструкции.

    Returns:
        list | None: Список инструкций, если jailbreak используется, иначе None.

    Raises:
        None
    """
```

**Параметры**:
- `jailbreak`: Имя jailbreak-инструкции.

**Возвращает**:
- `list | None`: Список инструкций, если jailbreak используется, иначе None.

**Как работает функция**:
1. Проверяет, является ли jailbreak-инструкция значением "Default".
2. Если jailbreak не является "Default", ищет инструкцию в словаре `special_instructions`.
3. Возвращает список инструкций, если jailbreak найден в словаре, иначе None.

**Примеры**:

```python
# Пример вызова функции
instructions = isJailbreak("CustomJailbreak")
if instructions:
    print(instructions)
else:
    print("Jailbreak не используется")