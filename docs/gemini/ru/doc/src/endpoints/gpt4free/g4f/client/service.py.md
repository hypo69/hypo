# Модуль service

## Обзор

Модуль `service` предназначен для управления провайдерами и моделями в проекте `hypotez`. Он предоставляет функции для преобразования строк в объекты провайдеров, получения моделей и провайдеров на основе входных параметров, а также для получения информации о последнем использованном провайдере.

## Подробнее

Модуль содержит функции для работы с провайдерами и моделями, используемыми для взаимодействия с различными сервисами. Он обрабатывает случаи, когда провайдер или модель не найдены, не работают или не поддерживают потоковую передачу. Модуль также включает логирование используемых провайдеров и моделей для отладки.

## Функции

### `convert_to_provider`

```python
def convert_to_provider(provider: str) -> ProviderType:
    """Преобразует строку с именем провайдера в объект провайдера.

    Args:
        provider (str): Строка с именем провайдера. Может содержать несколько провайдеров, разделенных пробелами.

    Returns:
        ProviderType: Объект провайдера.

    Raises:
        ProviderNotFoundError: Если провайдер не найден.
    """
    ...
```

**Как работает функция**:

1.  Функция `convert_to_provider` принимает строку `provider` в качестве аргумента.
2.  Проверяет, содержит ли строка пробелы. Если да, то разделяет строку на список имен провайдеров.
3.  Преобразует каждое имя провайдера в объект провайдера, используя `ProviderUtils.convert`.
4.  Если ни один провайдер не найден, вызывает исключение `ProviderNotFoundError`.
5.  Если провайдеров несколько, создает объект `IterListProvider` из списка провайдеров.
6.  Если в строке нет пробелов, пытается преобразовать строку непосредственно в объект провайдера.
7.  Если провайдер не найден, вызывает исключение `ProviderNotFoundError`.
8.  Возвращает объект провайдера.

**ASCII flowchart**:

```
Начало
  ↓
Проверка наличия пробелов в строке provider
  ├── Да → Разделение строки на список имен провайдеров
  │        ↓
  │   Преобразование каждого имени провайдера в объект провайдера
  │        ↓
  │   Проверка, найден ли хотя бы один провайдер
  │   ├── Нет → Вызов исключения ProviderNotFoundError
  │   └── Да  → Создание объекта IterListProvider из списка провайдеров
  └── Нет → Преобразование строки в объект провайдера
       ↓
  Проверка, найден ли провайдер
  ├── Нет → Вызов исключения ProviderNotFoundError
  └── Да  → Возврат объекта провайдера
  ↓
Конец
```

**Примеры**:

```python
# Пример 1: Преобразование существующего провайдера
provider = convert_to_provider("Gpt4Free")
print(type(provider))  # Вывод: <class 'src.providers.gpt4free.Gpt4Free'>

# Пример 2: Преобразование нескольких провайдеров
provider = convert_to_provider("Gpt4Free YouAreAI")
print(type(provider))  # Вывод: <class 'src.providers.retry_provider.IterListProvider'>
```

### `get_model_and_provider`

```python
def get_model_and_provider(model: Union[Model, str],
                           provider: Union[ProviderType, str, None],
                           stream: bool,
                           ignore_working: bool = False,
                           ignore_stream: bool = False,
                           logging: bool = True,
                           has_images: bool = False) -> tuple[str, ProviderType]:
    """Получает модель и провайдера на основе входных параметров.

    Args:
        model (Union[Model, str]): Модель для использования, либо объект, либо строковый идентификатор.
        provider (Union[ProviderType, str, None]): Провайдер для использования, либо объект, строковый идентификатор, либо None.
        stream (bool): Указывает, следует ли выполнять операцию как поток.
        ignore_working (bool, optional): Если True, игнорирует рабочий статус провайдера. По умолчанию False.
        ignore_stream (bool, optional): Если True, игнорирует возможность потоковой передачи провайдера. По умолчанию False.
        logging (bool, optional): Если True, включает логирование используемых провайдеров и моделей. По умолчанию True.
        has_images (bool, optional):  Указывает, имеет ли модель дело с изображениями. По умолчанию False.

    Returns:
        tuple[str, ProviderType]: Кортеж, содержащий имя модели и тип провайдера.

    Raises:
        ProviderNotFoundError: Если провайдер не найден.
        ModelNotFoundError: Если модель не найдена.
        ProviderNotWorkingError: Если провайдер не работает.
        StreamNotSupportedError: Если потоковая передача не поддерживается провайдером.
    """
    ...
```

**Как работает функция**:

1.  Функция `get_model_and_provider` принимает модель, провайдера, флаг потоковой передачи и флаги игнорирования рабочего статуса и поддержки потоковой передачи в качестве аргументов.
2.  Выполняет проверку версии, если `debug.version_check` имеет значение `True`.
3.  Преобразует строковое представление провайдера в объект провайдера, используя `convert_to_provider`.
4.  Преобразует строковое представление модели в объект модели, используя `ModelUtils.convert`.
5.  Если провайдер не указан, определяет провайдера и модель по умолчанию.
6.  Если модель указана строкой, пытается получить провайдера из `ProviderUtils.convert`.
7.  Если провайдер по-прежнему не найден, вызывает исключение `ProviderNotFoundError`.
8.  Проверяет, работает ли провайдер, и вызывает исключение `ProviderNotWorkingError`, если это не так.
9.  Проверяет, поддерживает ли провайдер потоковую передачу, и вызывает исключение `StreamNotSupportedError`, если это не так и требуется потоковая передача.
10. Выполняет логирование используемого провайдера и модели.
11. Возвращает имя модели и объект провайдера.

**ASCII flowchart**:

```
Начало
  ↓
Проверка версии
  ↓
Преобразование provider в объект ProviderType
  ↓
Преобразование model в объект Model
  ↓
Проверка, что provider не None
  ├── Да →  Проверка, что model не None
  │       ├── Да → Проверка, что  model строка или объект
  │       │       ├── Да → Поиск provider в ProviderUtils.convert
  │       │       └── Нет → ModelNotFoundError
  │       └── Нет → ProviderNotFoundError
  └── Нет → Определение provider и model по умолчанию
  ↓
Проверка working provider
  ↓
Проверка support stream
  ↓
Логирование
  ↓
Конец
```

**Примеры**:

```python
# Пример 1: Получение модели и провайдера по умолчанию
model, provider = get_model_and_provider(None, None, False)
print(f"Model: {model}, Provider: {provider.__name__}")

# Пример 2: Получение модели и провайдера по имени
model, provider = get_model_and_provider("gpt-3.5-turbo", "Gpt4Free", True)
print(f"Model: {model}, Provider: {provider.__name__}")
```

### `get_last_provider`

```python
def get_last_provider(as_dict: bool = False) -> Union[ProviderType, dict[str, str], None]:
    """Получает последнего использованного провайдера.

    Args:
        as_dict (bool, optional): Если True, возвращает информацию о провайдере в виде словаря. По умолчанию False.

    Returns:
        Union[ProviderType, dict[str, str]]: Последний использованный провайдер, либо объект, либо словарь.
    """
    ...
```

**Как работает функция**:

1.  Функция `get_last_provider` принимает флаг `as_dict`, указывающий, следует ли возвращать информацию о провайдере в виде словаря.
2.  Получает последнего использованного провайдера из `debug.last_provider`.
3.  Если последний провайдер является экземпляром `BaseRetryProvider`, получает последний провайдер из него.
4.  Если `as_dict` имеет значение `True`, возвращает информацию о провайдере в виде словаря, содержащего имя, URL, модель и метку провайдера.
5.  Если `as_dict` имеет значение `False`, возвращает объект провайдера.

**ASCII flowchart**:

```
Начало
  ↓
Получение последнего провайдера из debug.last_provider
  ↓
Проверка, является ли провайдер экземпляром BaseRetryProvider
  ├── Да → Получение последнего провайдера из BaseRetryProvider
  └── Нет → Продолжение
  ↓
Проверка значения as_dict
  ├── True → Формирование словаря с информацией о провайдере
  └── False → Возврат объекта провайдера
  ↓
Конец
```

**Примеры**:

```python
# Пример 1: Получение последнего провайдера в виде объекта
provider = get_last_provider()
if provider:
    print(f"Last provider: {provider.__name__}")

# Пример 2: Получение последнего провайдера в виде словаря
provider_info = get_last_provider(as_dict=True)
print(f"Last provider info: {provider_info}")