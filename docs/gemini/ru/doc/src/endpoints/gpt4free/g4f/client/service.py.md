# Модуль service.py

## Обзор

Модуль `service.py` предназначен для получения моделей и провайдеров, используемых в проекте `hypotez`. Он содержит функции для конвертации и получения провайдеров, а также для извлечения информации о последнем использованном провайдере. Этот модуль является важной частью системы, так как он обеспечивает выбор и настройку провайдеров, необходимых для работы с различными моделями.

## Подробнее

Модуль предоставляет функциональность для динамического выбора провайдеров и моделей, что позволяет системе гибко адаптироваться к различным требованиям и условиям. Он также включает механизмы проверки работоспособности провайдеров и поддержку потоковой передачи данных.

## Функции

### `convert_to_provider`

```python
def convert_to_provider(provider: str) -> ProviderType:
    """
    Преобразует строку с именем провайдера в объект провайдера.

    Args:
        provider (str): Строка с именем провайдера или списком провайдеров, разделенных пробелами.

    Returns:
        ProviderType: Объект провайдера.

    Raises:
        ProviderNotFoundError: Если провайдер не найден.

    Как работает функция:
    1. Проверяет, содержит ли строка `provider` пробелы. Если да, то разбивает строку на список провайдеров.
    2. Преобразует каждый элемент списка, если он есть в `ProviderUtils.convert`, в соответствующий объект провайдера.
    3. Если список провайдеров пуст, вызывает исключение `ProviderNotFoundError`.
    4. Если в строке `provider` нет пробелов, проверяет, есть ли провайдер в `ProviderUtils.convert`. Если да, то возвращает соответствующий объект провайдера.
    5. Если провайдер не найден, вызывает исключение `ProviderNotFoundError`.
    6. Возвращает объект провайдера.
    """
    ...
```
**Примеры:**
```python
    convert_to_provider('Vercel')
    convert_to_provider('Vercel Bard')
```

### `get_model_and_provider`

```python
def get_model_and_provider(model    : Union[Model, str], 
                           provider : Union[ProviderType, str, None], 
                           stream   : bool,
                           ignore_working: bool = False,
                           ignore_stream: bool = False,
                           logging: bool = True,
                           has_images: bool = False) -> tuple[str, ProviderType]:
    """
    Извлекает модель и провайдер на основе входных параметров.

    Args:
        model (Union[Model, str]): Модель для использования, объект или строковый идентификатор.
        provider (Union[ProviderType, str, None]): Провайдер для использования, объект, строковый идентификатор или None.
        stream (bool): Указывает, должна ли операция выполняться как поток.
        ignore_working (bool, optional): Если True, игнорирует рабочий статус провайдера. По умолчанию False.
        ignore_stream (bool, optional): Если True, игнорирует возможность потоковой передачи провайдера. По умолчанию False.
        logging (bool, optional): Если True, включает логирование. По умолчанию True.
        has_images (bool, optional): Если True, указывает, что запрос содержит изображения. По умолчанию False.

    Returns:
        tuple[str, ProviderType]: Кортеж, содержащий имя модели и тип провайдера.

    Raises:
        ProviderNotFoundError: Если провайдер не найден.
        ModelNotFoundError: Если модель не найдена.
        ProviderNotWorkingError: Если провайдер не работает.
        StreamNotSupportedError: Если потоковая передача не поддерживается провайдером.

    Как работает функция:
    1. Проверяет версию, если необходимо.
    2. Преобразует `provider` в объект `ProviderType`, если это строка.
    3. Преобразует `model` в объект `Model`, если это строка.
    4. Если `provider` не указан:
        - Если `model` не указана, выбирает модель и провайдер по умолчанию в зависимости от наличия изображений.
        - Если `model` является строкой, пытается найти провайдер по имени модели.
        - Если `model` является объектом `Model`, выбирает лучший провайдер для этой модели.
    5. Если `provider` не найден, вызывает исключение `ProviderNotFoundError`.
    6. Проверяет, работает ли провайдер, если `ignore_working` равно `False`.
    7. Если провайдер является `BaseRetryProvider`, удаляет неработающие провайдеры из списка, если `ignore_working` равно `False`.
    8. Проверяет, поддерживает ли провайдер потоковую передачу, если `ignore_stream` равно `False` и `stream` равно `True`.
    9. Логирует использование провайдера и модели.
    10. Возвращает имя модели и объект провайдера.

    Внутренние логические блоки:
    1. **Версионный контроль**: Проверяет и обновляет версию, если необходимо.
    2. **Преобразование типов**: Преобразует строковые представления модели и провайдера в соответствующие объекты.
    3. **Выбор провайдера**: Определяет провайдер, основываясь на переданных аргументах и информации о модели.
    4. **Обработка ошибок**: Вызывает исключения, если провайдер или модель не найдены, или если провайдер не работает.
    5. **Потоковая передача**: Проверяет, поддерживает ли провайдер потоковую передачу, если это необходимо.
    6. **Логирование**: Регистрирует информацию об используемых провайдерах и моделях для отладки и мониторинга.
    """
    ...
```
**Примеры:**
```python
    get_model_and_provider(model='gpt-3.5-turbo', provider='Vercel', stream=True)
    get_model_and_provider(model=default, provider=None, stream=False, has_images=True)
```

### `get_last_provider`

```python
def get_last_provider(as_dict: bool = False) -> Union[ProviderType, dict[str, str], None]:
    """
    Извлекает последнего использованного провайдера.

    Args:
        as_dict (bool, optional): Если True, возвращает информацию о провайдере в виде словаря. По умолчанию False.

    Returns:
        Union[ProviderType, dict[str, str], None]: Последний использованный провайдер, объект или словарь.

    Как работает функция:
    1. Получает последнего использованного провайдера из `debug.last_provider`.
    2. Если последний провайдер является `BaseRetryProvider`, получает последнего провайдера из него.
    3. Если `as_dict` равно `True`, возвращает информацию о провайдере в виде словаря, включая имя, URL, модель и метку.
    4. Если `as_dict` равно `False`, возвращает объект провайдера.

    Внутренние логические блоки:
    1. **Получение провайдера**: Извлекает последнего использованного провайдера из контекста отладки.
    2. **Обработка RetryProvider**: Если провайдер является `BaseRetryProvider`, получает последнего провайдера из него.
    3. **Форматирование данных**: Возвращает информацию о провайдере в виде словаря или объекта в зависимости от значения `as_dict`.
    """
    ...
```
**Примеры:**
```python
    get_last_provider()
    get_last_provider(as_dict=True)