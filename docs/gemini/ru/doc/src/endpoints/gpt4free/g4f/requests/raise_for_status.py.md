# Модуль для обработки статусов ответов и вызова исключений
=================================================================

Модуль предоставляет функции для проверки статуса ответа от сервера и вызова соответствующих исключений в случае ошибок.
Он обрабатывает различные типы ответов, включая ответы от `aiohttp`, `requests` и `StreamResponse`, а также специфические ошибки, такие как Cloudflare, OpenAI Bot detection, Rate Limit и другие.

## Обзор

Модуль `raise_for_status.py` предназначен для централизованной обработки HTTP-статусов ответов и генерации исключений, специфичных для различных ситуаций, таких как ошибки Cloudflare, обнаружение ботов OpenAI, превышение лимитов запросов и другие общие ошибки HTTP. Это позволяет упростить обработку ошибок в других частях проекта и обеспечивает консистентный подход к обработке ответов от различных сервисов.

## Подробней

Модуль содержит функции для проверки статуса ответа от сервера и вызова исключений в случае ошибок. Он обрабатывает различные типы ответов, включая ответы от `aiohttp`, `requests` и `StreamResponse`, а также специфические ошибки, такие как Cloudflare, OpenAI Bot detection, Rate Limit и другие.

## Функции

### `is_cloudflare`

```python
def is_cloudflare(text: str) -> bool:
    """
    Определяет, является ли переданный текст ответом Cloudflare.

    Args:
        text (str): Текст ответа.

    Returns:
        bool: `True`, если текст содержит признаки Cloudflare, иначе `False`.
    """
```

**Назначение**:
Функция `is_cloudflare` проверяет, содержит ли предоставленный текст признаки защиты Cloudflare. Это необходимо для идентификации ситуаций, когда доступ к сервису блокируется из-за Cloudflare.

**Параметры**:
- `text` (str): Текст ответа, который необходимо проверить.

**Возвращает**:
- `bool`: Возвращает `True`, если текст содержит характерные признаки Cloudflare, иначе `False`.

**Как работает функция**:

1.  **Проверка наличия текста "Generated by cloudfront"**: Проверяет, содержит ли текст строку "Generated by cloudfront".
2.  **Проверка наличия `<p id="cf-spinner-please-wait">`**: Проверяет, содержит ли текст строку \`<p id="cf-spinner-please-wait">\`
3.  **Проверка наличия текста "<title>Attention Required! | Cloudflare</title>" или 'id="cf-cloudflare-status"'**: Проверяет, содержит ли текст строку "<title>Attention Required! | Cloudflare</title>" или 'id="cf-cloudflare-status"'.
4.  **Проверка наличия текста '<div id="cf-please-wait">\' или "<title>Just a moment...</title>"'**: Проверяет, содержит ли текст строку '<div id="cf-please-wait">\' или "<title>Just a moment...</title>".
5.  **Возврат значения**: Если одно из условий выполняется, функция возвращает `True`, иначе `False`.

**ASCII flowchart**:

```
A [Проверка "Generated by cloudfront" in text]
|
B [Проверка '<p id="cf-spinner-please-wait">' in text]
|
C [Проверка "<title>Attention Required! | Cloudflare</title>" in text or 'id="cf-cloudflare-status"' in text]
|
D [Проверка '<div id="cf-please-wait">' in text or "<title>Just a moment...</title>" in text]
|
E [Возврат True, если A или B или C или D истинно, иначе False]
```

**Примеры**:

```python
text1 = "<html><body>Generated by cloudfront</body></html>"
text2 = '<p id="cf-spinner-please-wait">Загрузка...</p>'
text3 = '<title>Attention Required! | Cloudflare</title>'
text4 = '<div id="cf-please-wait">Пожалуйста, подождите...</div>'

print(is_cloudflare(text1))  # Вывод: True
print(is_cloudflare(text2))  # Вывод: True
print(is_cloudflare(text3))  # Вывод: True
print(is_cloudflare(text4))  # Вывод: True
print(is_cloudflare("<html><body>Hello</body></html>"))  # Вывод: False
```

### `is_openai`

```python
def is_openai(text: str) -> bool:
    """
    Определяет, является ли переданный текст ответом OpenAI, указывающим на проблему.

    Args:
        text (str): Текст ответа.

    Returns:
        bool: `True`, если текст содержит признаки OpenAI, иначе `False`.
    """
```

**Назначение**:
Функция `is_openai` проверяет, содержит ли предоставленный текст признаки блокировки со стороны OpenAI. Это позволяет идентифицировать ситуации, когда OpenAI блокирует доступ из-за различных ограничений.

**Параметры**:
- `text` (str): Текст ответа, который необходимо проверить.

**Возвращает**:
- `bool`: Возвращает `True`, если текст содержит характерные признаки OpenAI, иначе `False`.

**Как работает функция**:

1.  **Проверка наличия текста "<p>Unable to load site</p>"**: Проверяет, содержит ли текст строку "<p>Unable to load site</p>".
2.  **Проверка наличия текста 'id="challenge-error-text"'**: Проверяет, содержит ли текст строку 'id="challenge-error-text"'.
3.  **Возврат значения**: Если одно из условий выполняется, функция возвращает `True`, иначе `False`.

**ASCII flowchart**:

```
A [Проверка "<p>Unable to load site</p>" in text]
|
B [Проверка 'id="challenge-error-text"' in text]
|
C [Возврат True, если A или B истинно, иначе False]
```

**Примеры**:

```python
text1 = "<html><body><p>Unable to load site</p></body></html>"
text2 = '<div id="challenge-error-text">Ошибка</div>'

print(is_openai(text1))  # Вывод: True
print(is_openai(text2))  # Вывод: True
print(is_openai("<html><body>Hello</body></html>"))  # Вывод: False
```

### `raise_for_status_async`

```python
async def raise_for_status_async(response: Union[StreamResponse, ClientResponse], message: str = None):
    """
    Асинхронно проверяет статус ответа и вызывает исключение, если статус указывает на ошибку.

    Args:
        response (Union[StreamResponse, ClientResponse]): Объект ответа.
        message (str, optional): Дополнительное сообщение об ошибке. По умолчанию `None`.

    Raises:
        MissingAuthError: Если статус ответа 401.
        CloudflareError: Если статус ответа 403 и обнаружен Cloudflare.
        ResponseStatusError: Если статус ответа 403 и обнаружен OpenAI Bot, или если статус 502, или в других случаях ошибок.
        RateLimitError: Если статус ответа 504 или 429/402.
    """
```

**Назначение**:
Функция `raise_for_status_async` асинхронно проверяет статус HTTP-ответа и вызывает исключение, если ответ содержит код ошибки. Функция обрабатывает различные типы ответов и специфические ошибки, такие как Cloudflare и ошибки, связанные с OpenAI.

**Параметры**:
- `response` (Union[StreamResponse, ClientResponse]): Объект ответа, который требуется проверить.
- `message` (str, optional): Дополнительное сообщение об ошибке. По умолчанию `None`.

**Вызывает исключения**:
- `MissingAuthError`: Вызывается, если статус ответа равен 401 (не авторизован).
- `CloudflareError`: Вызывается, если статус ответа равен 403 (запрещено) и ответ содержит признаки Cloudflare.
- `ResponseStatusError`: Вызывается, если статус ответа равен 403 (запрещено) и ответ содержит признаки OpenAI Bot, или если статус ответа равен 502 (Bad Gateway), или в других случаях ошибок.
- `RateLimitError`: Вызывается, если статус ответа равен 504 (Gateway Timeout) или 429/402 (Превышен лимит запросов).

**Как работает функция**:

1.  **Проверка успешности ответа**: Проверяется, является ли ответ успешным (`response.ok`). Если да, функция завершается.
2.  **Определение типа содержимого**: Если `message` не предоставлено, функция пытается получить тип содержимого из заголовков ответа.
3.  **Обработка JSON-ответа**: Если тип содержимого начинается с "application/json", функция пытается извлечь сообщение об ошибке из JSON-ответа.
4.  **Обработка HTML-ответа**: Если тип содержимого начинается с "text/html" или сообщение начинается с "<!DOCTYPE", считается, что это HTML-ответ, и устанавливается флаг `is_html`.
5.  **Обработка специфических кодов ошибок**: Если `message` не определено или является HTML, функция проверяет специфические коды ошибок, такие как 520 (Unknown error (Cloudflare)), 429/402 (Rate limit).
6.  **Вызов исключений**: В зависимости от кода ответа и содержимого, функция вызывает соответствующее исключение:
    -   401: `MissingAuthError`
    -   403 и Cloudflare: `CloudflareError`
    -   403 и OpenAI: `ResponseStatusError`
    -   502: `ResponseStatusError`
    -   504: `RateLimitError`
    -   В остальных случаях: `ResponseStatusError`

**ASCII flowchart**:

```
A [response.ok?]
| Да: Конец
| Нет:
B [message is None?]
| Да:
C [content_type = response.headers.get("content-type", "")]
|
D [content_type.startswith("application/json")?]
| Да:
E [message = await response.json().get("error", message).get("message", message)]
| Нет:
F [message = (await response.text()).strip()]
|
G [is_html = content_type.startswith("text/html") or message.startswith("<!DOCTYPE")]
| Нет: Конец обработки JSON/HTML
|
H [message is None or is_html?]
| Да:
I [response.status == 520?]
| Да: message = "Unknown error (Cloudflare)"
| Нет:
J [response.status in (429, 402)?]
| Да: message = "Rate limit"
| Нет: Конец обработки кодов ошибок
| Конец обработки message
|
K [response.status == 401?]
| Да: raise MissingAuthError
| Нет:
L [response.status == 403 and is_cloudflare(message)?]
| Да: raise CloudflareError
| Нет:
M [response.status == 403 and is_openai(message)?]
| Да: raise ResponseStatusError (OpenAI Bot detected)
| Нет:
N [response.status == 502?]
| Да: raise ResponseStatusError (Bad Gateway)
| Нет:
O [response.status == 504?]
| Да: raise RateLimitError (Gateway Timeout)
| Нет: raise ResponseStatusError (Generic error)
```

**Примеры**:

```python
from aiohttp import ClientResponse, ClientSession
import asyncio

async def example():
    async with ClientSession() as session:
        response = ClientResponse('GET', url='http://example.com', session=session)
        response.status = 404
        try:
            await raise_for_status_async(response, "Страница не найдена")
        except Exception as ex:
            print(f"Произошла ошибка: {ex}")

asyncio.run(example())

#Пример вызова исключения  RateLimitError
async def example2():
    async with ClientSession() as session:
        response = ClientResponse('GET', url='http://example.com', session=session)
        response.status = 429
        try:
            await raise_for_status_async(response)
        except Exception as ex:
            print(f"Произошла ошибка: {ex}")

asyncio.run(example2())
```

### `raise_for_status`

```python
def raise_for_status(response: Union[Response, StreamResponse, ClientResponse, RequestsResponse], message: str = None):
    """
    Проверяет статус ответа и вызывает исключение, если статус указывает на ошибку.

    Args:
        response (Union[Response, StreamResponse, ClientResponse, RequestsResponse]): Объект ответа.
        message (str, optional): Дополнительное сообщение об ошибке. По умолчанию `None`.

    Raises:
        MissingAuthError: Если статус ответа 401.
        CloudflareError: Если статус ответа 403 и обнаружен Cloudflare.
        ResponseStatusError: Если статус ответа 403 и обнаружен OpenAI Bot, или если статус 502, или в других случаях ошибок.
        RateLimitError: Если статус ответа 504 или 429/402.
    """
```

**Назначение**:
Функция `raise_for_status` проверяет статус HTTP-ответа и вызывает исключение, если ответ содержит код ошибки. Функция поддерживает различные типы ответов и обрабатывает специфические ошибки, такие как Cloudflare и ошибки, связанные с OpenAI.

**Параметры**:
- `response` (Union[Response, StreamResponse, ClientResponse, RequestsResponse]): Объект ответа, который требуется проверить.
- `message` (str, optional): Дополнительное сообщение об ошибке. По умолчанию `None`.

**Вызывает исключения**:
- `MissingAuthError`: Вызывается, если статус ответа равен 401 (не авторизован).
- `CloudflareError`: Вызывается, если статус ответа равен 403 (запрещено) и ответ содержит признаки Cloudflare.
- `ResponseStatusError`: Вызывается, если статус ответа равен 403 (запрещено) и ответ содержит признаки OpenAI Bot, или если статус ответа равен 502 (Bad Gateway), или в других случаях ошибок.
- `RateLimitError`: Вызывается, если статус ответа равен 504 (Gateway Timeout) или 429/402 (Превышен лимит запросов).

**Как работает функция**:

1.  **Проверка наличия атрибута `status`**: Проверяет, есть ли у объекта `response` атрибут `status`. Если да, вызывается асинхронная функция `raise_for_status_async` для обработки ответа.
2.  **Проверка успешности ответа**: Проверяется, является ли ответ успешным (`response.ok`). Если да, функция завершается.
3.  **Определение типа содержимого**: Если `message` не предоставлено, функция пытается определить, является ли ответ HTML, проверяя заголовок `content-type` и начало текста ответа.
4.  **Обработка специфических кодов ошибок**: Если `message` не определено или является HTML, функция проверяет специфические коды ошибок, такие как 520 (Unknown error (Cloudflare)), 429/402 (Rate limit).
5.  **Вызов исключений**: В зависимости от кода ответа и содержимого, функция вызывает соответствующее исключение:
    -   401: `MissingAuthError`
    -   403 и Cloudflare: `CloudflareError`
    -   403 и OpenAI: `ResponseStatusError`
    -   502: `ResponseStatusError`
    -   504: `RateLimitError`
    -   В остальных случаях: `ResponseStatusError`

**ASCII flowchart**:

```
A [hasattr(response, "status")?]
| Да: raise_for_status_async(response, message)
| Нет:
B [response.ok?]
| Да: Конец
| Нет:
C [message is None?]
| Да:
D [is_html = response.headers.get("content-type", "").startswith("text/html") or response.text.startswith("<!DOCTYPE")]
| Нет: Конец определения типа содержимого
|
E [message is None or is_html?]
| Да:
F [response.status_code == 520?]
| Да: message = "Unknown error (Cloudflare)"
| Нет:
G [response.status_code in (429, 402)?]
| Да: raise RateLimitError
| Нет: Конец обработки кодов ошибок
| Конец обработки message
|
H [response.status_code == 401?]
| Да: raise MissingAuthError
| Нет:
I [response.status_code == 403 and is_cloudflare(response.text)?]
| Да: raise CloudflareError
| Нет:
J [response.status_code == 403 and is_openai(response.text)?]
| Да: raise ResponseStatusError (OpenAI Bot detected)
| Нет:
K [response.status_code == 502?]
| Да: raise ResponseStatusError (Bad Gateway)
| Нет:
L [response.status_code == 504?]
| Да: raise RateLimitError (Gateway Timeout)
| Нет: raise ResponseStatusError (Generic error)
```

**Примеры**:

```python
import requests
from requests import Response

# Пример вызова исключения MissingAuthError
response = Response()
response.status_code = 401
response.text = "Требуется аутентификация"
try:
    raise_for_status(response, "Ошибка аутентификации")
except Exception as ex:
    print(f"Произошла ошибка: {ex}")

# Пример вызова исключения CloudflareError
response = Response()
response.status_code = 403
response.text = '<html><body><title>Attention Required! | Cloudflare</title></body></html>'
try:
    raise_for_status(response)
except Exception as ex:
    print(f"Произошла ошибка: {ex}")