# Модуль `G4F`

## Обзор

Модуль `G4F` предоставляет интерфейс для взаимодействия с фреймворком G4F (GPT4Free), который использует различные модели для генерации текста и изображений. Модуль включает классы для работы с моделями DeepseekAI и BlackForestLabs Flux1Dev, а также методы для асинхронной генерации контента.

## Подробнее

Этот модуль предназначен для интеграции с различными AI-моделями через huggingface.co, в частности, для использования моделей DeepseekAI и BlackForestLabs Flux1Dev. Он обеспечивает асинхронное взаимодействие с API этих моделей, позволяя генерировать текст и изображения на основе заданных параметров. В модуле реализована логика для получения токенов GPU, необходимых для работы с некоторыми моделями, а также обработка и форматирование запросов к API.

## Классы

### `FluxDev`

**Описание**: Класс `FluxDev` предоставляет доступ к модели Flux-1-dev от BlackForestLabs.

**Наследует**: `BlackForestLabs_Flux1Dev`

**Атрибуты**:

-   `url` (str): URL для доступа к пространству Flux-1-dev на Hugging Face.
-   `space` (str): Имя пространства Flux-1-dev на Hugging Face.
-   `referer` (str): Referer для HTTP-запросов.

### `G4F`

**Описание**: Класс `G4F` предоставляет интерфейс для работы с фреймворком G4F, включая модели DeepseekAI и Flux.

**Наследует**: `DeepseekAI_JanusPro7b`

**Атрибуты**:

-   `label` (str): Метка для идентификации фреймворка G4F.
-   `space` (str): Имя пространства Janus-Pro-7B на Hugging Face.
-   `url` (str): URL для доступа к пространству G4F на Hugging Face.
-   `api_url` (str): URL для доступа к API Janus-Pro-7B.
-   `url_flux` (str): URL для запуска предсказаний Flux.
-   `referer` (str): Referer для HTTP-запросов.
-   `default_model` (str): Модель, используемая по умолчанию ("flux").
-   `model_aliases` (dict): Псевдонимы для моделей.
-   `image_models` (list): Список моделей, поддерживающих генерацию изображений.
-   `models` (list): Список всех поддерживаемых моделей.

**Методы**:

-   `create_async_generator`: Асинхронный генератор для создания контента с использованием различных моделей.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    prompt: str = None,
    aspect_ratio: str = "1:1",
    width: int = None,
    height: int = None,
    seed: int = None,
    cookies: dict = None,
    api_key: str = None,
    zerogpu_uuid: str = "[object Object]",
    **kwargs
) -> AsyncResult:
    """
    Асинхронный генератор для создания контента с использованием различных моделей.

    Args:
        model (str): Имя используемой модели.
        messages (Messages): Сообщения для генерации контента.
        proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
        prompt (str, optional): Текст запроса. По умолчанию `None`.
        aspect_ratio (str, optional): Соотношение сторон изображения. По умолчанию `"1:1"`.
        width (int, optional): Ширина изображения. По умолчанию `None`.
        height (int, optional): Высота изображения. По умолчанию `None`.
        seed (int, optional): Зерно для генерации случайных чисел. По умолчанию `None`.
        cookies (dict, optional): Куки для HTTP-запросов. По умолчанию `None`.
        api_key (str, optional): API-ключ. По умолчанию `None`.
        zerogpu_uuid (str, optional): UUID для ZeroGPU. По умолчанию `"[object Object]"`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный результат генерации.

    Yields:
        chunk (AsyncResult): Часть сгенерированного контента.
    """
```

**Назначение**: Метод `create_async_generator` является асинхронным генератором, который позволяет создавать контент (текст или изображения) с использованием различных AI-моделей, таких как Flux и DeepseekAI. Он выбирает подходящую модель в зависимости от входных параметров и делегирует генерацию контента соответствующим классам и методам.

**Параметры**:

-   `cls` (class): Ссылка на класс `G4F`.
-   `model` (str): Имя используемой модели. Может быть "flux", "flux-dev" или другими моделями, поддерживаемыми `DeepseekAI_JanusPro7b`.
-   `messages` (Messages): Список сообщений, используемых для генерации текста или изображений.
-   `proxy` (str, optional): Адрес прокси-сервера для выполнения HTTP-запросов. По умолчанию `None`.
-   `prompt` (str, optional): Текст запроса, используемый для генерации контента. По умолчанию `None`.
-   `aspect_ratio` (str, optional): Соотношение сторон изображения, если генерируется изображение. По умолчанию `"1:1"`.
-   `width` (int, optional): Ширина изображения в пикселях. По умолчанию `None`.
-   `height` (int, optional): Высота изображения в пикселях. По умолчанию `None`.
-   `seed` (int, optional): Зерно для генерации случайных чисел, что позволяет получать воспроизводимые результаты. По умолчанию `None`.
-   `cookies` (dict, optional): Словарь с куки для выполнения HTTP-запросов. По умолчанию `None`.
-   `api_key` (str, optional): API-ключ для доступа к модели. По умолчанию `None`.
-   `zerogpu_uuid` (str, optional): UUID для использования ZeroGPU. По умолчанию `"[object Object]"`.
-   `**kwargs`: Дополнительные параметры, которые могут быть переданы в методы генерации контента.

**Возвращает**:

-   `AsyncResult`: Асинхронный результат генерации, который может быть текстовым или изображением.

**Вызывает исключения**:

-   Различные исключения, которые могут возникнуть при выполнении HTTP-запросов или обработке данных, возвращаемых моделями.

**Как работает функция**:

1.  **Выбор модели**: Функция определяет, какую модель использовать для генерации контента. Если `model` равно "flux" или "flux-dev", она делегирует выполнение классу `FluxDev`. Если `model` не содержит `cls.default_model` (т.е. "flux"), она вызывает метод `create_async_generator` родительского класса (`DeepseekAI_JanusPro7b`).
2.  **Подготовка параметров**: Функция подготавливает параметры для генерации изображения, такие как ширина, высота, текст запроса (`prompt`) и зерно (`seed`). Ширина и высота корректируются, чтобы быть кратными 8. Если `prompt` не задан, он формируется с использованием `format_image_prompt(messages)`. Если `seed` не задан, он генерируется случайным образом.
3.  **Формирование payload**: Функция формирует полезную нагрузку (`payload`) для запроса к API, включая текст запроса, зерно, ширину и высоту изображения.
4.  **Получение токена GPU**: Если `api_key` не задан, функция пытается получить токен GPU, вызывая `get_zerogpu_token`.
5.  **Выполнение запроса к API**: Функция выполняет POST-запрос к API (`cls.url_flux`) с использованием `aiohttp.ClientSession`. Запрос включает заголовок с токеном GPU.
6.  **Обработка ответа**: Функция обрабатывает ответ от API, извлекая URL изображения из JSON-ответа.
7.  **Асинхронный генератор**: Функция использует `asyncio.create_task` для запуска генерации изображения в фоновом режиме. Она возвращает промежуточные результаты (например, статус генерации) с использованием `yield`, пока задача не будет завершена.

**Внутренние функции**:

-   `generate()`:
    ```python
    async def generate():
        """
        Выполняет POST-запрос к API и возвращает URL изображения.

        Args:
            cls (class): Ссылка на класс `G4F`.
            session (ClientSession): Асинхронная HTTP-сессия.
            payload (dict): Полезная нагрузка для запроса.
            proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
            headers (dict): Заголовки HTTP-запроса.

        Returns:
            ImageResponse: Объект `ImageResponse` с URL изображения и текстом запроса.

        Raises:
            Exception: Если возникает ошибка при выполнении запроса или обработке ответа.
        """
    ```

    **Назначение**: Внутренняя функция `generate` выполняет POST-запрос к API для генерации изображения и возвращает URL полученного изображения.

    **Параметры**:

    -   Нет явных параметров, но использует переменные из внешней области видимости (`cls`, `session`, `payload`, `proxy`, `headers`).

    **Возвращает**:

    -   `ImageResponse`: Объект, содержащий URL сгенерированного изображения и текст запроса (`prompt`).

    **Вызывает исключения**:

    -   Исключения, которые могут возникнуть при выполнении HTTP-запроса или обработке JSON-ответа.

    **Как работает функция**:

    1.  **Выполнение POST-запроса**: Функция выполняет асинхронный POST-запрос к API (`cls.url_flux`) с использованием `aiohttp.ClientSession`. В запросе передается полезная нагрузка (`payload`), прокси-сервер (если задан) и заголовки (`headers`).
    2.  **Обработка ответа**: Функция ожидает получения ответа от API и преобразует его в JSON-формат. Затем она извлекает URL изображения из JSON-ответа.
    3.  **Создание объекта ImageResponse**: Функция создает объект `ImageResponse`, содержащий URL изображения и текст запроса (`prompt`).

**ASCII Flowchart**:

```
graph LR
    A[Выбор модели] --> B{model == "flux" or "flux-dev"};
    B -- True --> C[FluxDev.create_async_generator];
    B -- False --> D{model содержит cls.default_model};
    D -- False --> E[super().create_async_generator];
    D -- True --> F[Подготовка параметров];
    F --> G[Формирование payload];
    G --> H{api_key is None};
    H -- True --> I[Получение токена GPU];
    H -- False --> J[Выполнение запроса к API];
    I --> J;
    J --> K[Обработка ответа];
    K --> L[Асинхронный генератор];
    L --> M[Возврат результата];
```

**Примеры**:

```python
# Пример 1: Генерация изображения с использованием модели "flux"
async for chunk in G4F.create_async_generator(
    model="flux",
    messages=[{"role": "user", "content": "A cat in space"}],
    width=512,
    height=512
):
    print(chunk)

# Пример 2: Генерация изображения с использованием модели DeepseekAI с указанием seed
async for chunk in G4F.create_async_generator(
    model="deepseekai",
    messages=[{"role": "user", "content": "A dog in space"}],
    width=512,
    height=512,
    seed=12345
):
    print(chunk)