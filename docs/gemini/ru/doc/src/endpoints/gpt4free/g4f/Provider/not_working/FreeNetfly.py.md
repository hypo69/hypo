# Модуль `FreeNetfly.py`

## Обзор

Модуль `FreeNetfly.py` предоставляет асинхронный интерфейс для взаимодействия с API FreeNetfly, который позволяет получать ответы от языковых моделей, таких как `gpt-3.5-turbo` и `gpt-4`. Он реализует функциональность асинхронного генератора для обработки потоковых ответов от API.

## Подробней

Этот модуль предназначен для интеграции с другими частями проекта `hypotez`, где требуется взаимодействие с языковыми моделями через API FreeNetfly. Он обеспечивает асинхронный способ отправки запросов и обработки ответов, что позволяет эффективно использовать ресурсы и избегать блокировок.

## Классы

### `FreeNetfly`

**Описание**: Класс `FreeNetfly` является асинхронным провайдером и миксином для работы с API FreeNetfly. Он предоставляет методы для отправки запросов к API и обработки потоковых ответов.

**Принцип работы**:
Класс наследует `AsyncGeneratorProvider` и `ProviderModelMixin`, что позволяет ему использовать функциональность асинхронного генератора и предоставлять информацию о поддерживаемых моделях. Основной метод `create_async_generator` отправляет запросы к API FreeNetfly и возвращает асинхронный генератор, который выдает чанки текста по мере их поступления.

**Аттрибуты**:
- `url` (str): URL API FreeNetfly.
- `api_endpoint` (str): Endpoint API для отправки запросов на completion.
- `working` (bool): Указывает, работает ли провайдер в данный момент.
- `default_model` (str): Модель, используемая по умолчанию (`gpt-3.5-turbo`).
- `models` (List[str]): Список поддерживаемых моделей (`gpt-3.5-turbo`, `gpt-4`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от API.
- `_process_response`: Обрабатывает ответ от API и извлекает контент.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от API FreeNetfly.

    Args:
        model (str): Название модели для использования.
        messages (Messages): Список сообщений для отправки в API.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий чанки текста.

    Raises:
        ClientError: Если возникает ошибка при отправке запроса.
        asyncio.TimeoutError: Если превышено время ожидания ответа.

    Example:
        Примеры вызовов со всем спектром параметров, которые можно передать в функцию
    """
    ...
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор, который отправляет запросы к API FreeNetfly и возвращает ответы в виде потока текстовых чанков.

**Параметры**:
- `model` (str): Модель, которую необходимо использовать для генерации ответа.
- `messages` (Messages): Список сообщений, которые будут отправлены в API для получения ответа.
- `proxy` (str, optional): Адрес прокси-сервера, если необходимо использовать прокси для подключения к API. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который выдает чанки текста по мере их поступления от API.

**Вызывает исключения**:
- `ClientError`: Если возникает ошибка на стороне клиента при отправке запроса (например, ошибка подключения).
- `asyncio.TimeoutError`: Если время ожидания ответа от API превышено.

**Как работает функция**:

1. **Подготовка заголовков и данных**:
   - Формируются заголовки HTTP-запроса, включая `accept`, `content-type`, `user-agent` и другие необходимые параметры.
   - Подготавливаются данные запроса в формате JSON, включая сообщения, модель, температуру и другие параметры.
2. **Отправка запроса с повторными попытками**:
   - Используется цикл `for` для выполнения нескольких попыток отправки запроса в случае ошибок.
   - Внутри цикла `try` выполняется отправка POST-запроса к API FreeNetfly с использованием `ClientSession` из библиотеки `aiohttp`.
   - Если запрос выполнен успешно, функция вызывает `_process_response` для обработки ответа.
   - Если возникает ошибка `ClientError` или `asyncio.TimeoutError`, выполняется проверка на количество попыток. Если попытки не исчерпаны, функция ждет некоторое время и повторяет попытку.
3. **Обработка ответа**:
   - Функция `_process_response` вызывается для обработки полученного ответа.
4. **Обработка ошибок**:
   - Если все попытки отправки запроса завершились неудачей, функция повторно выбрасывает последнее исключение.

**ASCII flowchart**:

```
Начало
  │
  │  Подготовка заголовков и данных
  │
  │  Цикл повторных попыток (max_retries = 5)
  │
  │  ┌──► Отправка POST-запроса к API FreeNetfly
  │  │   │
  │  │   └──► Успех?
  │  │       │
  │  │       ├──► Да: _process_response(response)
  │  │       │
  │  │       └──► Нет: Ошибка (ClientError, asyncio.TimeoutError)
  │  │           │
  │  │           └──► Попытки исчерпаны?
  │  │               │
  │  │               ├──► Да: Выброс исключения
  │  │               │
  │  │               └──► Нет: Ожидание и повторная попытка
  │  │
  └── Обработка ответа через _process_response
  │
Конец
```

**Примеры**:

```python
# Пример вызова функции с минимальными параметрами
async def example():
    model = "gpt-3.5-turbo"
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    async for chunk in FreeNetfly.create_async_generator(model=model, messages=messages):
        print(chunk, end="")

# Пример вызова функции с указанием прокси
async def example_with_proxy():
    model = "gpt-3.5-turbo"
    messages = [{"role": "user", "content": "Translate 'hello' to French."}]
    proxy = "http://your-proxy-server:8080"
    async for chunk in FreeNetfly.create_async_generator(model=model, messages=messages, proxy=proxy):
        print(chunk, end="")
```

### `_process_response`

```python
@classmethod
async def _process_response(cls, response) -> AsyncGenerator[str, None]:
    """
    Обрабатывает ответ от API и извлекает контент.

    Args:
        response: Ответ от API.

    Returns:
        AsyncGenerator[str, None]: Асинхронный генератор, выдающий чанки текста.

    Raises:
        json.JSONDecodeError: Если не удалось распарсить JSON.
        KeyError: Если отсутствует ожидаемый ключ в JSON.

    """
    ...
```

**Назначение**: Функция `_process_response` обрабатывает HTTP-ответ, полученный от API, и извлекает из него контент, предназначенный для пользователя. Она разбирает потоковые данные, выделяет полезную информацию и передает ее в виде асинхронного генератора.

**Параметры**:
- `response`: Объект HTTP-ответа, полученный от API.

**Возвращает**:
- `AsyncGenerator[str, None]`: Асинхронный генератор, который выдает текстовые чанки контента.

**Вызывает исключения**:
- `json.JSONDecodeError`: Если возникает ошибка при попытке разобрать JSON-ответ от API.
- `KeyError`: Если в структуре JSON-ответа отсутствуют ожидаемые ключи.

**Как работает функция**:

1. **Инициализация буфера**:
   - Создается пустая строка `buffer`, которая будет использоваться для накопления данных из потока ответа.
2. **Асинхронный перебор строк ответа**:
   - Функция асинхронно перебирает строки, поступающие из `response.content`. Каждая строка декодируется из байтов в UTF-8 и добавляется в `buffer`.
3. **Поиск маркера конца блока данных**:
   - Проверяется, заканчивается ли `buffer` на `\n\n`, что является маркером конца блока данных в потоковом ответе.
4. **Разбор данных при наличии маркера**:
   - Если маркер найден, `buffer` разделяется на подстроки по символу `\n`.
   - Каждая подстрока проверяется на наличие префикса `data: `. Если префикс найден, подстрока считается содержащей полезные данные.
   - Если подстрока равна `data: [DONE]`, это означает конец потока, и функция завершает свою работу.
   - В противном случае из подстроки извлекаются JSON-данные, и из них извлекается поле `content` из структуры `data['choices'][0]['delta']`.
   - Если поле `content` существует, оно передается в асинхронный генератор.
5. **Обработка ошибок при разборе JSON**:
   - Если при разборе JSON-данных возникает ошибка `json.JSONDecodeError` или `KeyError`, функция выводит сообщение об ошибке и продолжает работу.
6. **Очистка буфера**:
   - После обработки всех подстрок `buffer` очищается.
7. **Обработка остаточных данных в буфере**:
   - После завершения цикла обработки строк проверяется, остались ли какие-либо данные в `buffer`. Если данные остались, они обрабатываются аналогично данным, полученным в основном цикле.

**ASCII flowchart**:

```
Начало
│
│  Инициализация buffer = ""
│
│  Асинхронный перебор строк из response.content
│  │
│  │  Декодирование строки и добавление в buffer
│  │
│  │  Проверка: buffer.endswith('\n\n')?
│  │  │
│  │  ├── Да: Разделение buffer на подстроки по '\n'
│  │  │   │
│  │  │   └── Перебор подстрок
│  │  │       │
│  │  │       └── Проверка: подстрока.startswith('data: ')?
│  │  │           │
│  │  │           ├── Да: Проверка: подстрока == 'data: [DONE]'?
│  │  │           │   │
│  │  │           │   ├── Да: Конец (return)
│  │  │           │   │
│  │  │           │   └── Нет: Извлечение JSON-данных и content
│  │  │           │       │
│  │  │           │       └── Вывод content через yield
│  │  │           │
│  │  │           └── Нет: Пропуск подстроки
│  │  │
│  │  └── Нет: Продолжение цикла
│  │
│  Обработка остаточных данных в buffer (если есть)
│
Конец
```

**Примеры**:

Примеры использования данной функции могут быть только в контексте работы с `create_async_generator`, так как она является внутренней и вызывается для обработки ответа от API.
```python
#Пример работы в context create_async_generator
async def example():
    model = "gpt-3.5-turbo"
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    async for chunk in FreeNetfly.create_async_generator(model=model, messages=messages):
        print(chunk, end="")