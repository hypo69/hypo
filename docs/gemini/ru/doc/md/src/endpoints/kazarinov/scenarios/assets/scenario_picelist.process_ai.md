# Процесс обработки списка продуктов (scenario_picelist.process_ai.mmd)

## Обзор

Данный сценарий описывает процесс обработки запроса на обработку списка продуктов (products_list) с помощью AI-модели.  Сценарий включает в себя обработку потенциальных ошибок и невалидных данных, а также различные варианты структуры ответа от модели.

## Последовательность действий

```mermaid
sequenceDiagram
    participant User
    participant AI_Model
    participant Logger

    User->>AI_Model: Запрос на обработку продуктов (products_list)
    AI_Model->>AI_Model: Обработка запроса с командой модели
    AI_Model->>User: Ответ от модели

    alt Нет ответа от модели
        Logger->>Logger: Логирирование ошибки "no response from gemini"
        User->>AI_Model: Повторный запрос (attempts - 1)
    end

    alt Невалидные данные (data)
        Logger->>Logger: Логирирование ошибки "Error in data from gemini"
        User->>AI_Model: Повторный запрос (attempts - 1)
    end

    alt Получены данные (data)
        alt Данные в виде списка
            alt Два элемента (ru, he)
                User->>User: Извлечение ru и he
            end
            alt Один элемент
                User->>User: Извлечение ru и he из первого элемента
            end
            alt Невалидная структура данных
                Logger->>Logger: Логирирование ошибки "Проблема парсинга ответа"
                User->>AI_Model: Повторный запрос (attempts - 1)
            end
        end

        alt Данные в виде объекта
            User->>User: Извлечение ru и he из объекта
        end

        alt Невалидные значения (ru или he)
            Logger->>Logger: Логирирование ошибки "Invalid ru or he data"
            User->>AI_Model: Повторный запрос (attempts - 1)
        end

        User->>User: Возврат результата ru и he
    end
```

## Обрабатываемые типы данных

В данном сценарии обрабатываются следующие типы данных:

* **products_list:** Список продуктов, передаваемый в запрос.
* **Ответ от модели:**  Может быть в виде списка или объекта. Ожидаемые данные `ru` и `he`.


## Возможные ошибки

* `"no response from gemini"` -  Модель не отвечает.
* `"Error in data from gemini"` -  Невалидные данные получены от модели.
* `"Проблема парсинга ответа"` -  Неправильный формат ответа от модели.
* `"Invalid ru or he data"` - Невалидные значения `ru` или `he` в ответе.


##  Описание алгоритма

Сценарий реализует цикл повторных запросов к AI-модели, пока не будет получен корректный ответ.  На каждом шаге производится проверка типа данных ответа от модели, наличие необходимых элементов `ru` и `he`. При возникновении ошибок, происходит логирование соответствующего сообщения и выполняется повторный запрос.  Если  получен корректный ответ, то происходит извлечение данных `ru` и `he` и возврат результата пользователю.


## Замечания

* Введены дополнительные проверки валидности данных, чтобы обеспечить надежную обработку.
* Для увеличения устойчивости к ошибкам используется цикл повторных запросов.
* Необходимая логика извлечения `ru` и `he`  зависит от структуры данных в ответе от модели и должна быть реализована в соответствующей функции.


```