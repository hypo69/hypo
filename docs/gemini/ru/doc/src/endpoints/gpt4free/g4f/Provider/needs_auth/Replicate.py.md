# Модуль Replicate

## Обзор

Модуль `Replicate` предоставляет асинхронный генератор для взаимодействия с платформой Replicate, которая позволяет запускать и масштабировать модели машинного обучения. Этот модуль поддерживает стриминг ответов и требует аутентификации через API-ключ.

## Подробней

Модуль предназначен для работы с различными моделями, размещенными на платформе Replicate. Он обеспечивает удобный интерфейс для отправки запросов к моделям и получения результатов в асинхронном режиме. Для аутентификации требуется API-ключ, который передается в заголовках запроса. Модуль также поддерживает настройку прокси и таймаутов для сетевых запросов.

## Классы

### `Replicate`

**Описание**: Класс `Replicate` является асинхронным провайдером генератора и миксином модели провайдера. Он реализует функциональность для взаимодействия с API Replicate, включая аутентификацию, отправку запросов и получение потоковых ответов.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных провайдеров генераторов.
- `ProviderModelMixin`: Предоставляет вспомогательные методы для работы с моделями.

**Атрибуты**:
- `url` (str): URL главной страницы Replicate.
- `login_url` (str): URL страницы для получения API-токенов.
- `working` (bool): Указывает, является ли провайдер рабочим.
- `needs_auth` (bool): Указывает, требуется ли аутентификация для работы с провайдером.
- `default_model` (str): Модель, используемая по умолчанию.
- `models` (list): Список поддерживаемых моделей.

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    api_key: str = None,
    proxy: str = None,
    timeout: int = 180,
    system_prompt: str = None,
    max_tokens: int = None,
    temperature: float = None,
    top_p: float = None,
    top_k: float = None,
    stop: list = None,
    extra_data: dict = {},
    headers: dict = {
        "accept": "application/json",
    },
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для взаимодействия с API Replicate.

    Args:
        cls (Replicate): Класс `Replicate`.
        model (str): Название модели для использования.
        messages (Messages): Список сообщений для отправки в модель.
        api_key (str, optional): API-ключ для аутентификации. По умолчанию `None`.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        timeout (int, optional): Время ожидания ответа в секундах. По умолчанию 180.
        system_prompt (str, optional): Системный промт для модели. По умолчанию `None`.
        max_tokens (int, optional): Максимальное количество токенов в ответе. По умолчанию `None`.
        temperature (float, optional): Температура для генерации текста. По умолчанию `None`.
        top_p (float, optional): Top-p для генерации текста. По умолчанию `None`.
        top_k (float, optional): Top-k для генерации текста. По умолчанию `None`.
        stop (list, optional): Список стоп-слов для остановки генерации. По умолчанию `None`.
        extra_data (dict, optional): Дополнительные данные для отправки в запросе. По умолчанию `{}`.
        headers (dict, optional): Дополнительные заголовки для запроса. По умолчанию `{"accept": "application/json"}`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор для получения потоковых ответов от API Replicate.

    Raises:
        MissingAuthError: Если `api_key` не предоставлен и требуется аутентификация.
        ResponseError: Если получен невалидный ответ от API Replicate.
    """
    ...
```

**Как работает функция**:

1.  **Подготовка параметров**: Функция принимает параметры, необходимые для запроса к API Replicate, такие как модель, сообщения, API-ключ, прокси и другие настройки генерации текста.
2.  **Проверка аутентификации**: Если для провайдера требуется аутентификация и `api_key` не предоставлен, вызывается исключение `MissingAuthError`.
3.  **Формирование заголовков**: Если `api_key` предоставлен, он добавляется в заголовок `Authorization`.
4.  **Создание сессии**: Создается асинхронная сессия с использованием `StreamSession` для выполнения HTTP-запросов.
5.  **Формирование данных запроса**: Формируются данные запроса, включающие промт, системный промт, максимальное количество токенов, температуру и другие параметры генерации текста.
6.  **Отправка запроса**: Отправляется POST-запрос к API Replicate с сформированными данными.
7.  **Обработка ответа**: Обрабатывается ответ от API Replicate, проверяется наличие ошибок и извлекается идентификатор предсказания.
8.  **Получение потоковых ответов**: Отправляется GET-запрос для получения потоковых ответов от API Replicate.
9.  **Генерация текста**: Итерируется по строкам ответа, извлекается сгенерированный текст и передается в генератор.
10. **Завершение**: Генератор завершает работу после получения события `done`.

```text
    Начало
    │
    ├── Проверка аутентификации (api_key)
    │   └── Если не предоставлен и требуется аутентификация:
    │       └── Выброс исключения MissingAuthError
    │
    ├── Формирование заголовков (headers)
    │   └── Если api_key предоставлен:
    │       └── Добавление api_key в заголовок Authorization
    │
    ├── Создание асинхронной сессии (session)
    │   └── Отправка POST-запроса к API Replicate
    │   │   └── Обработка ответа:
    │   │       ├── Проверка наличия ошибок
    │   │       └── Извлечение идентификатора предсказания
    │   │
    │   └── Отправка GET-запроса для получения потоковых ответов
    │       └── Итерация по строкам ответа:
    │           ├── Извлечение сгенерированного текста
    │           └── Передача текста в генератор
    │
    └── Завершение после получения события "done"
```

**Примеры**:

```python
# Пример использования create_async_generator с API-ключом
async for text in Replicate.create_async_generator(
    model="meta/meta-llama-3-70b-instruct",
    messages=[{"role": "user", "content": "Напиши короткий рассказ."}],
    api_key="YOUR_API_KEY"
):
    print(text, end="")
```

```python
# Пример использования create_async_generator без API-ключа (если не требуется аутентификация)
async for text in Replicate.create_async_generator(
    model="meta/meta-llama-3-70b-instruct",
    messages=[{"role": "user", "content": "Напиши короткий рассказ."}]
):
    print(text, end="")