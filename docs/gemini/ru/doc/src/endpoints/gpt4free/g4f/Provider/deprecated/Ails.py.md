# Модуль Ails

## Обзор

Модуль `Ails` предоставляет асинхронный генератор для взаимодействия с моделью GPT-3.5-turbo через API `ai.ls`. Он предназначен для потоковой передачи ответов от языковой модели, обеспечивая асинхронную обработку запросов.

## Подробнее

Модуль `Ails` является частью провайдеров для работы с различными языковыми моделями. Он использует асинхронные запросы для получения ответов от API `ai.ls`. Модуль поддерживает проксирование запросов и обеспечивает обработку ошибок, связанных с контентом ответов.

## Классы

### `Ails`

**Описание**: Класс `Ails` является асинхронным провайдером, который реализует взаимодействие с API `ai.ls` для получения ответов от модели GPT-3.5-turbo.

**Принцип работы**:
1.  Класс наследуется от `AsyncGeneratorProvider`, что позволяет использовать его для асинхронной генерации ответов.
2.  Он определяет URL API, указывает на поддержку истории сообщений и модели GPT-3.5-turbo.
3.  Метод `create_async_generator` создает асинхронный генератор, который отправляет запросы к API и возвращает токены ответа.

**Методы**:

*   `create_async_generator(model: str, messages: Messages, stream: bool, proxy: str = None, **kwargs) -> AsyncResult`: Создает асинхронный генератор для получения ответов от API `ai.ls`.

## Функции

### `create_async_generator`

```python
@staticmethod
async def create_async_generator(
    model: str,
    messages: Messages,
    stream: bool,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от API `ai.ls`.

    Args:
        model (str): Название модели для использования (в данном случае всегда "gpt-3.5-turbo").
        messages (Messages): Список сообщений для отправки в API.
        stream (bool): Флаг, указывающий на необходимость потоковой передачи ответов.
        proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы, такие как `temperature`.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий токены ответа.

    Raises:
        Exception: Если ответ содержит запрещенные слова (`ai.ls` или `ai.ci`).

    Как работает функция:
    1.  Формирует заголовки запроса, включая `client-id`, `client-v`, `authorization` и другие необходимые параметры.
    2.  Создает асинхронную сессию с использованием `aiohttp.ClientSession`.
    3.  Формирует JSON-данные для запроса, включая модель, температуру, сообщения, дату и хеш.
    4.  Отправляет POST-запрос к API `https://api.caipacity.com/v1/chat/completions` с использованием асинхронной сессии.
    5.  Обрабатывает ответ, извлекая токены из потока данных и возвращая их через генератор.
    6.  Проверяет наличие запрещенных слов в токенах и вызывает исключение, если они обнаружены.

    Внутри функции происходят следующие действия и преобразования:
    A. Формирование заголовков запроса: Определяются необходимые заголовки, включая авторизацию и идентификаторы клиента.
    |
    -- B. Создание асинхронной сессии: Используется `aiohttp.ClientSession` для выполнения асинхронных запросов.
    |
    C. Формирование JSON-данных: Создается структура данных, включающая параметры модели, сообщения и временные метки.
    |
    D - E. Отправка POST-запроса и обработка ответа: Запрос отправляется к API, и ответ обрабатывается построчно для извлечения токенов.
    |
    F. Проверка токенов: Проверяется наличие запрещенных слов в извлеченных токенах.

    Примеры:
    Пример 1:
        messages = [{"role": "user", "content": "Hello, how are you?"}]
        async for token in Ails.create_async_generator(model="gpt-3.5-turbo", messages=messages, stream=True):
            print(token, end="")

    Пример 2 (с прокси):
        messages = [{"role": "user", "content": "Tell me a joke."}]
        async for token in Ails.create_async_generator(model="gpt-3.5-turbo", messages=messages, stream=True, proxy="http://your_proxy:8080"):
            print(token, end="")
    """
    ...
```

### `_hash`

```python
def _hash(json_data: dict[str, str]) -> SHA256:
    """
    Создает SHA256 хеш на основе переданных данных.

    Args:
        json_data (dict[str, str]): Словарь с данными для хеширования, содержащий ключи "t" (timestamp) и "m" (message).

    Returns:
        SHA256: SHA256 хеш, вычисленный на основе данных.

    Как работает функция:
    1.  Формирует строку base_string, объединяя timestamp и message с фиксированным ключом и длиной message.
    2.  Вычисляет SHA256 хеш от base_string.
    3.  Возвращает полученный хеш.

    Внутри функции происходят следующие действия и преобразования:
    A. Формирование строки base_string: Объединяются timestamp и message с фиксированным ключом.
    |
    B. Вычисление SHA256 хеша: Вычисляется хеш от полученной строки.
    |
    C. Возврат хеша: Возвращается вычисленный SHA256 хеш.

    Примеры:
    Пример 1:
        data = {"t": "1678886400", "m": "Hello"}
        hashed_value = _hash(data)
        print(hashed_value)

    Пример 2:
        data = {"t": "1678886400", "m": "How are you?"}
        hashed_value = _hash(data)
        print(hashed_value)
    """
    ...
```

### `_format_timestamp`

```python
def _format_timestamp(timestamp: int) -> str:
    """
    Форматирует timestamp, изменяя последнюю цифру в соответствии с условием.

    Args:
        timestamp (int): Timestamp для форматирования.

    Returns:
        str: Отформатированный timestamp в виде строки.

    Как работает функция:
    1.  Извлекает последнюю цифру из timestamp.
    2.  Если последняя цифра четная, добавляет 1.
    3.  Если последняя цифра нечетная, оставляет ее без изменений.
    4.  Возвращает измененный timestamp в виде строки.

    Внутри функции происходят следующие действия и преобразования:
    A. Извлечение последней цифры: Получение последней цифры из timestamp.
    |
    B. Условное изменение цифры: Проверка на четность и изменение цифры при необходимости.
    |
    C. Возврат измененного timestamp: Возвращается измененный timestamp в виде строки.

    Примеры:
    Пример 1:
        timestamp = 1678886400
        formatted_timestamp = _format_timestamp(timestamp)
        print(formatted_timestamp)  # Output: 1678886401

    Пример 2:
        timestamp = 1678886401
        formatted_timestamp = _format_timestamp(timestamp)
        print(formatted_timestamp)  # Output: 1678886401
    """
    ...