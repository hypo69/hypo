# Модуль для работы с прокси

## Обзор

Модуль определяет функции для загрузки и парсинга списка прокси. Загружается текстовый файл с прокси-адресами и распределяется по категориям.

## Подробней

Этот модуль предназначен для автоматической загрузки и обработки списка прокси-серверов. Он выполняет следующие задачи:

1.  Загружает список прокси-серверов из указанного URL-адреса.
2.  Сохраняет загруженный список в локальный файл.
3.  Парсит файл со списком прокси-серверов, разделяя их по протоколам (HTTP, SOCKS4, SOCKS5).
4.  Проверяет работоспособность каждого прокси-сервера.

Этот модуль полезен для автоматизации задач, требующих использования прокси-серверов, таких как парсинг веб-страниц, тестирование безопасности и обход географических ограничений.

## Функции

### `download_proxies_list`

```python
def download_proxies_list(url: str = url, save_path: Path = proxies_list_path) -> bool:
    """
    Загружает файл по указанному URL и сохраняет его в заданный путь.

    Args:
        url (str): URL файла для загрузки. По умолчанию используется глобальная переменная `url`.
        save_path (Path): Путь для сохранения загруженного файла. По умолчанию используется глобальная переменная `proxies_list_path`.

    Returns:
        bool: `True`, если файл успешно загружен и сохранен, `False` в случае ошибки.

    Raises:
        Exception: Если возникает ошибка при загрузке или сохранении файла.

    Example:
        >>> download_proxies_list()
        True
    """
```

**Назначение**: Загружает файл по указанному URL и сохраняет его в заданный путь.

**Как работает функция**:

1.  Отправляет GET-запрос по указанному URL.
2.  Проверяет статус ответа HTTP. Если статус указывает на ошибку (например, 404), генерируется исключение.
3.  Открывает файл по указанному пути для записи в бинарном режиме (`wb`).
4.  Читает содержимое ответа по частям (chunks) и записывает каждую часть в файл.
5.  Логирует информацию об успешной загрузке файла или об ошибке в случае неудачи.

```
    Начало
    │
    └──> GET-запрос к URL
         │
         └──> Проверка статуса HTTP
              │
              └──> Открытие файла для записи (wb)
                   │
                   └──> Чтение и запись данных в файл по частям
                        │
                        └──> Логирование результата
                             │
                             Конец
```

**Примеры**:

```python
download_proxies_list(url='http://example.com/proxies.txt', save_path=Path('/tmp/proxies.txt'))
```

### `get_proxies_dict`

```python
def get_proxies_dict(file_path: Path = proxies_list_path) -> Dict[str, List[Dict[str, Any]]]:
    """
    Парсит файл с прокси-адресами и распределяет их по категориям.

    Args:
        file_path (Path): Путь к файлу с прокси. По умолчанию используется глобальная переменная `proxies_list_path`.

    Returns:
        Dict[str, List[Dict[str, Any]]]: Словарь с распределёнными по типам прокси (http, socks4, socks5).
        Пример:
        {
            'http': [{'protocol': 'http', 'host': '1.2.3.4', 'port': '8080'}, ...],
            'socks4': [{'protocol': 'socks4', 'host': '5.6.7.8', 'port': '1080'}, ...],
            'socks5': [{'protocol': 'socks5', 'host': '9.10.11.12', 'port': '4145'}, ...]
        }

    Raises:
        FileNotFoundError: Если файл с прокси не найден.
        Exception: Если возникает ошибка при парсинге прокси.

    """
```

**Назначение**: Парсит файл с прокси-адресами и распределяет их по категориям (http, socks4, socks5).

**Как работает функция**:

1.  Вызывает функцию `download_proxies_list()` для загрузки списка прокси-серверов.
2.  Инициализирует словарь `proxies` с пустыми списками для каждого типа прокси (http, socks4, socks5).
3.  Открывает файл для чтения в кодировке UTF-8.
4.  Читает файл построчно и пытается извлечь протокол, хост и порт прокси-сервера с помощью регулярного выражения.
5.  Если строка соответствует формату прокси-сервера, добавляет информацию о прокси в соответствующий список в словаре `proxies`.
6.  Обрабатывает исключения `FileNotFoundError` (если файл не найден) и `Exception` (если возникает ошибка при парсинге).
7.  Возвращает словарь `proxies` с распределенными по типам прокси.

```
    Начало
    │
    └──> Загрузка списка прокси (download_proxies_list)
         │
         └──> Инициализация словаря proxies
              │
              └──> Открытие файла для чтения
                   │
                   └──> Чтение файла построчно
                        │
                        └──> Извлечение протокола, хоста и порта с помощью регулярного выражения
                             │
                             └──> Добавление информации о прокси в словарь
                                  │
                                  └──> Обработка исключений
                                       │
                                       └──> Возврат словаря proxies
                                            │
                                            Конец
```

**Примеры**:

```python
proxies = get_proxies_dict(file_path=Path('/tmp/proxies.txt'))
print(proxies)
```

### `check_proxy`

```python
def check_proxy(proxy: dict) -> bool:
    """
    Проверяет работоспособность прокси-сервера.
    
    Args:
        proxy (dict): Словарь с данными прокси (host, port, protocol).

    Returns:
        bool: True, если прокси работает, иначе False.
    """
```

**Назначение**: Проверяет работоспособность прокси-сервера.

**Как работает функция**:

1.  Пытается отправить GET-запрос на `https://httpbin.org/ip` через указанный прокси-сервер с таймаутом в 5 секунд.
2.  Проверяет код ответа HTTP. Если код равен 200, считается, что прокси-сервер работает.
3.  Логирует информацию о результате проверки прокси-сервера.
4.  Обрабатывает исключения `ProxyError` и `RequestException`, которые могут возникнуть при подключении к прокси-серверу.
5.  Возвращает `True`, если прокси-сервер работает, и `False` в противном случае.

```
    Начало
    │
    └──> Отправка GET-запроса через прокси
         │
         └──> Проверка кода ответа HTTP
              │
              └──> Логирование результата проверки
                   │
                   └──> Обработка исключений ProxyError и RequestException
                        │
                        └──> Возврат True, если прокси работает, иначе False
                             │
                             Конец
```

**Примеры**:

```python
proxy = {'protocol': 'http', 'host': '1.2.3.4', 'port': '8080'}
if check_proxy(proxy):
    print('Прокси работает')
else:
    print('Прокси не работает')
```

## Главный блок `if __name__ == '__main__':`

```python
if __name__ == '__main__':
    # Загрузка списка прокси и парсинг
    if download_proxies_list():
        parsed_proxies = parse_proxies()
        logger.info(f'Обработано {sum(len(v) for v in parsed_proxies.values())} прокси.')
```

**Назначение**: Обеспечивает выполнение кода только при запуске скрипта напрямую, а не при импорте модуля.

**Как работает**:

1.  Вызывает функцию `download_proxies_list()` для загрузки списка прокси-серверов.
2.  Если загрузка прошла успешно, вызывает функцию `parse_proxies()` для парсинга списка прокси-серверов.
3.  Логирует информацию об общем количестве обработанных прокси-серверов.

```
    Начало
    │
    └──> Загрузка списка прокси (download_proxies_list)
         │
         └──> Парсинг списка прокси (parse_proxies)
              │
              └──> Логирование количества обработанных прокси
                   │
                   Конец