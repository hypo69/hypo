# Модуль интеграции Google Generative AI

## Обзор

Класс `GoogleGenerativeAI` предназначен для облегчения взаимодействия с генеративными моделями AI от Google. Этот класс предоставляет методы для отправки запросов, обработки ответов, управления диалогами и интеграции с различными функциями AI. Он включает надежную обработку ошибок, ведение журнала и параметры конфигурации для обеспечения бесперебойной работы.

## Подробнее

Этот модуль предоставляет интерфейс для взаимодействия с Google Gemini API. Он позволяет отправлять текстовые запросы, обрабатывать ответы, сохранять историю диалогов и описывать изображения. Модуль также включает механизмы обработки ошибок и ведения журнала для обеспечения стабильной работы. Он использует различные утилиты из проекта `hypotez`, такие как логирование, работа с файлами и преобразование данных.

## Классы

### `GoogleGenerativeAI`

**Описание**: Класс для интеграции с Google Generative AI моделями.

**Принцип работы**: Класс инициализируется с API-ключом, именем модели, конфигурацией генерации и системными инструкциями. Он предоставляет методы для отправки запросов к модели, управления историей диалогов и обработки ответов. Класс также обрабатывает различные ошибки и ведет журналы для отслеживания операций.

**Атрибуты**:
- `api_key` (str): API-ключ для доступа к Google Generative AI.
- `model_name` (Optional[str]): Имя используемой модели (по умолчанию `None`).
- `generation_config` (Optional[Dict]): Конфигурация генерации (по умолчанию `None`).
- `system_instruction` (Optional[str]): Системные инструкции для модели (по умолчанию `None`).

**Методы**:
- `__init__`: Инициализирует класс `GoogleGenerativeAI`.
- `config`: Извлекает конфигурацию из файла настроек.
- `_start_chat`: Начинает чат-сессию с AI-моделью.
- `_save_dialogue`: Сохраняет диалог в текстовый и JSON-файлы.
- `ask`: Отправляет текстовый запрос к AI-модели и получает ответ.
- `chat`: Отправляет сообщение в чат AI-модели и получает ответ.
- `describe_image`: Генерирует текстовое описание изображения.
- `upload_file`: Загружает файл в AI-модель.

## Функции

### `__init__(self, api_key: str, model_name: Optional[str] = None, generation_config: Optional[Dict] = None, system_instruction: Optional[str] = None, **kwargs)`

**Назначение**: Инициализирует класс `GoogleGenerativeAI` с необходимыми конфигурациями.

**Параметры**:
- `api_key` (str): API-ключ для доступа к Google Generative AI.
- `model_name` (Optional[str]): Имя используемой модели (по умолчанию `None`).
- `generation_config` (Optional[Dict]): Конфигурация генерации (по умолчанию `None`).
- `system_instruction` (Optional[str]): Системные инструкции для модели (по умолчанию `None`).
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `None`: Функция ничего не возвращает.

**Вызывает исключения**:
- `Exception`: В случае ошибок при инициализации модели.

**Как работает функция**:
1. Инициализирует параметры класса, такие как `api_key`, `model_name`, `generation_config` и `system_instruction`.
2. Определяет пути для сохранения истории диалогов.
3. Конфигурирует параметры модели на основе `generation_config`, если он предоставлен, или использует конфигурацию по умолчанию.
4. Инициализирует модель Google Generative AI с использованием `api_key` и `generation_config`.
5. Инициализирует историю чата как пустой список.
6. Если `system_instruction` предоставлен, добавляет его как первое сообщение в историю чата.

```
Инициализация параметров --> Определение путей --> Конфигурация параметров модели --> Инициализация модели Google Generative AI --> Инициализация истории чата --> Добавление системных инструкций (если есть)
```

**Примеры**:

```python
ai = GoogleGenerativeAI(api_key="your_api_key", system_instruction="Instruction")
```

### `config()`

**Назначение**: Извлекает конфигурацию из файла настроек.

**Параметры**:
- `None`: Функция не принимает параметров.

**Возвращает**:
- `dict`: Словарь с конфигурационными параметрами.

**Вызывает исключения**:
- `FileNotFoundError`: Если файл конфигурации не найден.
- `json.JSONDecodeError`: Если файл конфигурации содержит невалидный JSON.
- `Exception`: В случае других ошибок при чтении файла.

**Как работает функция**:
1. Определяет путь к файлу конфигурации `gemini.json` в директории `src/ai/gemini`.
2. Использует функцию `j_loads` для загрузки конфигурации из файла.
3. Возвращает словарь с конфигурационными параметрами.

```
Определение пути к файлу --> Загрузка конфигурации с помощью j_loads --> Возврат словаря с параметрами
```

**Примеры**:

```python
config = GoogleGenerativeAI.config()
print(config)
```

### `_start_chat(self)`

**Назначение**: Начинает чат-сессию с AI-моделью.

**Параметры**:
- `None`: Функция не принимает параметров.

**Возвращает**:
- `None`: Функция ничего не возвращает.

**Вызывает исключения**:
- `Exception`: В случае ошибок при инициализации чата.

**Как работает функция**:
1. Инициализирует чат-сессию с пустой историей.
2. Если `system_instruction` был предоставлен, добавляет его как первое сообщение в историю чата.

```
Инициализация чат-сессии --> Добавление системных инструкций (если есть)
```

**Примеры**:

```python
ai = GoogleGenerativeAI(api_key="your_api_key")
ai._start_chat()
```

### `_save_dialogue(self, dialogue: list)`

**Назначение**: Сохраняет диалог в текстовый и JSON-файлы.

**Параметры**:
- `dialogue` (list): Список сообщений в диалоге.

**Возвращает**:
- `None`: Функция ничего не возвращает.

**Вызывает исключения**:
- `Exception`: В случае ошибок при записи в файл.

**Как работает функция**:
1. Определяет пути к текстовому и JSON-файлам для сохранения диалога.
2. Открывает файлы в режиме добавления (`'a'`).
3. Записывает каждое сообщение в диалоге в текстовый файл.
4. Записывает весь диалог в JSON-файл.
5. Закрывает оба файла.

```
Определение путей к файлам --> Открытие файлов в режиме добавления --> Запись сообщений в текстовый файл --> Запись диалога в JSON-файл --> Закрытие файлов
```

**Примеры**:

```python
ai = GoogleGenerativeAI(api_key="your_api_key")
dialogue = [{"role": "user", "content": "Привет!"}, {"role": "model", "content": "Здравствуйте!"}]
ai._save_dialogue(dialogue)
```

### `ask(self, q: str, attempts: int = 15) -> Optional[str]`

**Назначение**: Отправляет текстовый запрос к AI-модели и получает ответ.

**Параметры**:
- `q` (str): Текстовый запрос.
- `attempts` (int): Максимальное количество попыток в случае ошибки (по умолчанию `15`).

**Возвращает**:
- `Optional[str]`: Ответ от AI-модели или `None` в случае ошибки.

**Вызывает исключения**:
- `Exception`: В случае ошибок при отправке запроса или получении ответа.

**Как работает функция**:
1. Инициализирует переменные для отслеживания количества попыток и задержки между попытками.
2. В цикле выполняет попытки отправки запроса к AI-модели.
3. При успешном получении ответа сохраняет диалог в историю.
4. Возвращает ответ.
5. В случае ошибки логирует ее и увеличивает задержку между попытками.

```
Инициализация переменных --> Цикл попыток: Отправка запроса --> Получение ответа --> Сохранение диалога --> Возврат ответа
```

**Примеры**:

```python
ai = GoogleGenerativeAI(api_key="your_api_key")
response = ai.ask("Как дела?")
print(response)
```

### `chat(self, q: str) -> str`

**Назначение**: Отправляет сообщение в чат AI-модели и получает ответ.

**Параметры**:
- `q` (str): Текст сообщения.

**Возвращает**:
- `str`: Ответ от AI-модели.

**Вызывает исключения**:
- `Exception`: В случае ошибок при отправке сообщения или получении ответа.

**Как работает функция**:
1. Добавляет сообщение пользователя в историю чата.
2. Отправляет запрос в чат AI-модели.
3. Добавляет ответ AI-модели в историю чата.
4. Сохраняет диалог в историю.
5. Возвращает ответ.

```
Добавление сообщения пользователя в историю --> Отправка запроса в чат --> Добавление ответа в историю --> Сохранение диалога --> Возврат ответа
```

**Примеры**:

```python
ai = GoogleGenerativeAI(api_key="your_api_key")
ai._start_chat()
response = ai.chat("Привет!")
print(response)
```

### `describe_image(self, image_path: Path) -> Optional[str]`

**Назначение**: Генерирует текстовое описание изображения.

**Параметры**:
- `image_path` (Path): Путь к файлу изображения.

**Возвращает**:
- `Optional[str]`: Текстовое описание изображения или `None` в случае ошибки.

**Вызывает исключения**:
- `Exception`: В случае ошибок при обработке изображения или отправке запроса.

**Как работает функция**:
1. Читает файл изображения.
2. Кодирует изображение в base64.
3. Отправляет запрос с изображением в AI-модель.
4. Возвращает текстовое описание изображения.

```
Чтение файла изображения --> Кодирование изображения в base64 --> Отправка запроса с изображением --> Возврат описания
```

**Примеры**:

```python
from pathlib import Path
ai = GoogleGenerativeAI(api_key="your_api_key")
image_path = Path("image.jpg")
description = ai.describe_image(image_path)
print(description)
```

### `upload_file(self, file: str | Path | IOBase, file_name: Optional[str] = None) -> bool`

**Назначение**: Загружает файл в AI-модель.

**Параметры**:
- `file` (str | Path | IOBase): Путь к файлу, объект Path или файловый объект.
- `file_name` (Optional[str]): Имя файла (по умолчанию `None`).

**Возвращает**:
- `bool`: `True` в случае успешной загрузки, `False` в случае ошибки.

**Вызывает исключения**:
- `Exception`: В случае ошибок при загрузке файла.

**Как работает функция**:
1. Проверяет тип файла (путь, объект Path или файловый объект).
2. Открывает файл, если это путь или объект Path.
3. Загружает файл в AI-модель.
4. Возвращает `True` в случае успеха, `False` в случае ошибки.

```
Проверка типа файла --> Открытие файла (если необходимо) --> Загрузка файла --> Возврат результата
```

**Примеры**:

```python
from pathlib import Path
ai = GoogleGenerativeAI(api_key="your_api_key")
file_path = Path("file.txt")
success = ai.upload_file(file_path)
print(success)
```

## Обработка ошибок

Класс включает в себя обработку ошибок для различных сценариев:
- **Сетевые ошибки**: Повторные попытки с экспоненциальной задержкой.
- **Недоступность сервиса**: Запись ошибок в журнал и повторные попытки.
- **Ограничения квоты**: Запись в журнал и ожидание перед повторной попыткой.
- **Ошибки аутентификации**: Запись в журнал и прекращение дальнейших попыток.
- **Неверный ввод**: Запись в журнал и повторные попытки с таймаутом.
- **Ошибки API**: Запись в журнал и прекращение дальнейших попыток.

## Ведение журнала и история

Все взаимодействия с AI-моделями регистрируются, а диалоги сохраняются как в текстовом, так и в JSON-формате для будущего анализа.

## Зависимости

- `google.generativeai`
- `requests`
- `grpc`
- `google.api_core.exceptions`
- `google.auth.exceptions`
- `src.logger`
- `src.utils.printer`
- `src.utils.file`
- `src.utils.date_time`
- `src.utils.convertors.unicode`
- `src.utils.jjson`

## Пример использования

```python
ai = GoogleGenerativeAI(api_key="your_api_key", system_instruction="Instruction")
response = ai.ask("Как дела?")
print(response)
```

Этот пример инициализирует класс `GoogleGenerativeAI`, отправляет запрос AI-модели и выводит ответ.