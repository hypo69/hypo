# Модуль product_fields

## Обзор

Модуль `product_fields.py` предназначен для описания и управления полями товаров в формате API PrestaShop. Он включает в себя класс `ProductFields`, который позволяет загружать, устанавливать и форматировать значения полей товаров, а также управлять связями между товарами и другими сущностями (категориями, изображениями и т.д.).

## Подробней

Модуль предназначен для работы с API PrestaShop и обеспечивает удобный интерфейс для управления полями товаров. Он использует dataclasses для представления данных и включает методы для работы с мультиязычными значениями, а также для преобразования объекта в формат, подходящий для API PrestaShop.

## Классы

### `ProductFields`

**Описание**: Класс `ProductFields` описывает поля товара в формате API PrestaShop. Он позволяет загружать значения полей по умолчанию, устанавливать значения для различных языков и преобразовывать объект в словарь, готовый для отправки в API PrestaShop.

**Принцип работы**:

1.  При инициализации класса загружаются значения полей товара по умолчанию из файла `product_fields_default_values.json`.
2.  Поддерживается установка мультиязычных значений для полей, таких как название, описание и мета-данные.
3.  Класс предоставляет свойства (properties) для доступа к отдельным полям товара, таким как `id_product`, `price`, `name` и т.д.
4.  Метод `to_dict` преобразует объект `ProductFields` в словарь, который можно использовать для отправки данных в API PrestaShop.

**Атрибуты**:

*   `presta_fields` (SimpleNamespace): Объект, содержащий поля товара. Инициализируется в методе `__post_init__`.
*   `id_lang` (int): ID языка, используемый по умолчанию.

**Методы**:

*   `__post_init__()`: Инициализирует объект `ProductFields` после создания экземпляра класса.
*   `_payload()`: Загружает дефолтные значения полей товара из файла.
*   `_set_multilang_value(field_name: str, value: str, id_lang: Optional[int | str] = None) -> bool`: Устанавливает мультиязычное значение для заданного поля.
*   `id_product`: Свойство для управления `ID` товара.
*   `id_supplier`: Свойство для управления `ID` поставщика.
*   `id_manufacturer`: Свойство для управления `ID` бренда.
*   `id_category_default`: Свойство для управления `ID` главной категории товара.
*   `id_shop_default`: Свойство для управления `ID` магазина по умолчанию.
*   `id_shop`: Свойство для управления `ID` магазина (для multishop).
*   `id_tax`: Свойство для управления `ID` налога.
*   `position_in_category`: Свойство для управления позицией товара в категории.
*   `on_sale`: Свойство для управления флагом распродажи.
*   `online_only`: Свойство для управления флагом "только онлайн".
*   `ean13`: Свойство для управления EAN13 кодом товара.
*   `isbn`: Свойство для управления ISBN кодом товара.
*   `upc`: Свойство для управления UPC кодом товара.
*   `mpn`: Свойство для управления MPN кодом товара.
*   `ecotax`: Свойство для управления Эко налог.
*   `minimal_quantity`: Свойство для управления минимальным количеством товара для заказа.
*   `low_stock_threshold`: Свойство для управления пороговым значением для уведомления о низком запасе.
*   `low_stock_alert`: Свойство для управления флагом уведомления о низком запасе.
*   `price`: Свойство для управления ценой товара.
*   `wholesale_price`: Свойство для управления оптовой ценой.
*   `unity`: Свойство для управления единицей измерения.
*   `unit_price_ratio`: Свойство для управления соотношением цены за единицу.
*   `additional_shipping_cost`: Свойство для управления дополнительной стоимостью доставки.
*   `reference`: Свойство для управления артикулом товара.
*   `supplier_reference`: Свойство для управления артикулом поставщика.
*   `location`: Свойство для управления местоположением товара на складе.
*   `width`: Свойство для управления шириной товара.
*   `height`: Свойство для управления высотой товара.
*   `depth`: Свойство для управления глубиной товара.
*   `weight`: Свойство для управления весом товара.
*   `volume`: Свойство для управления объемом товара.
*   `out_of_stock`: Свойство для управления действием при отсутствии товара на складе.
*   `additional_delivery_times`: Свойство для управления дополнительным временем доставки.
*   `quantity_discount`: Свойство для управления флагом скидки на количество.
*   `customizable`: Свойство для управления флагом возможности кастомизации.
*   `uploadable_files`: Свойство для управления флагом возможности загрузки файлов.
*   `text_fields`: Свойство для управления количеством текстовых полей.
*   `active`: Свойство для управления флагом активности товара.
*   `redirect_type`: Свойство для управления типом редиректа.
*   `id_type_redirected`: Свойство для управления ID связанного редиректа.
*   `available_for_order`: Свойство для управления флагом доступности для заказа.
*   `available_date`: Свойство для управления датой доступности товара.
*   `show_condition`: Свойство для управления флагом отображения состояния товара.
*   `condition`: Свойство для управления состоянием товара.
*   `show_price`: Свойство для управления флагом отображения цены.
*   `indexed`: Свойство для управления флагом индексации товара.
*   `visibility`: Свойство для управления видимостью товара.
*   `cache_is_pack`: Свойство для управления флагом кэширования как пакет товара.
*   `cache_has_attachments`: Свойство для управления флагом кэширования вложений.
*   `is_virtual`: Свойство для управления флагом виртуального товара.
*   `cache_default_attribute`: Свойство для управления ID атрибута по умолчанию для кэширования.
*   `date_add`: Свойство для управления датой добавления товара.
*   `date_upd`: Свойство для управления датой обновления товара.
*   `advanced_stock_management`: Свойство для управления флагом расширенного управления запасами.
*   `pack_stock_type`: Свойство для управления типом управления запасами пакета товаров.
*   `state`: Свойство для управления состоянием товара.
*   `product_type`: Свойство для управления типом товара.
*   `name`: Свойство для управления названием товара (мультиязычное поле).
*   `description`: Свойство для управления описанием товара (мультиязычное поле).
*   `description_short`: Свойство для управления кратким описанием товара (мультиязычное поле).
*   `link_rewrite`: Свойство для управления URL товара (мультиязычное поле).
*   `meta_description`: Свойство для управления Meta описанием товара (мультиязычное поле).
*   `meta_keywords`: Свойство для управления Meta ключевыми словами товара (мультиязычное поле).
*   `meta_title`: Свойство для управления Meta заголовком товара (мультиязычное поле).
*   `available_now`: Свойство для управления текстом "в наличии" (мультиязычное поле).
*   `available_later`: Свойство для управления текстом "ожидается" (мультиязычное поле).
*   `delivery_in_stock`: Свойство для управления текстом доставки при наличии (мультиязычное поле).
*   `delivery_out_stock`: Свойство для управления текстом доставки при отсутствии (мультиязычное поле).
*   `delivery_additional_message`: Свойство для управления дополнительным сообщением о доставке (мультиязычное поле).
*   `affiliate_short_link`: Свойство для управления короткой ссылкой аффилиата (мультиязычное поле).
*   `affiliate_text`: Свойство для управления текстом аффилиата (мультиязычное поле).
*   `affiliate_summary`: Свойство для управления кратким описанием аффилиата (мультиязычное поле).
*   `affiliate_summary_2`: Свойство для управления вторым кратким описанием аффилиата (мультиязычное поле).
*   `affiliate_image_small`: Свойство для управления маленьким изображением аффилиата (мультиязычное поле).
*   `affiliate_image_medium`: Свойство для управления средним изображением аффилиата (мультиязычное поле).
*   `affiliate_image_large`: Свойство для управления большим изображением аффилиата (мультиязычное поле).
*   `ingredients`: Свойство для управления списком ингридиентов (мультиязычное поле).
*   `specification`: Свойство для управления спецификацией товара (мультиязычное поле).
*   `how_to_use`: Свойство для управления инструкцией "как использовать товар" (мультиязычное поле).
*   `id_default_image`: Свойство для управления ID изображения по умолчанию.
*    `link_to_video`: Свойство для управления ссылкой на видео.
*   `local_image_path`: Свойство для управления путем к локальному изображению.
*   `local_video_path`: Свойство для управления путем к локальному видео.
*   `additional_categories`: Возвращает список дополнительных категорий.
*   `additional_category_append`: Добавляет связь с категорией, если ее еще нет.
*   `additional_categories_clear`: Очищает все связи с категориями.
*   `product_images`: Возвращает список изображений продукта.
*   `product_image_append`: Добавляет связь с изображением продукта.
*   `product_images_clear`: Очищает все связи с изображениями продукта.
*    `images_urls`: Свойство для управления списком URL дополнительных изображений.
*   `images_urls_append`: Устанавливает список URL, откуда скачать дополнительные изображения.
*   `product_combinations`: Возвращает список комбинаций продукта.
*   `product_combination_append`: Добавляет связь с комбинацией продукта.
*   `product_combinations_clear`: Очищает все связи с комбинациями продукта.
*   `product_options`: Возвращает список опций продукта.
*   `product_options_append`: Добавляет связь со значением опции продукта.
*   `product_options_clear`: Очищает все связи со значениями опций продукта.
*   `product_product_features`: Возвращает список характеристик продукта.
*   `product_features_append`: Добавляет связь с характеристикой продукта.
*   `product_features_clear`: Очищает все связи с характеристиками продукта.
*   `product_product_tags`: Возвращает список тегов продукта.
*   `product_tag_append`: Добавляет связь с тегом продукта.
*   `product_tags_clear`: Очищает все связи с тегами продукта.
*   `product_stock_availables`: Возвращает список доступностей на складе.
*   `product_stock_available_append`: Добавляет связь с доступностью на складе.
*   `product_stock_availables_clear`: Очищает все связи с доступностью на складе.
    `product_attachments`: Возвращает список вложений продукта.
*   `product_attachment_append`: Добавляет связь с вложением продукта.
*   `product_attachments_clear`: Очищает все связи с вложениями продукта.
*   `product_accessories`: Возвращает список аксессуаров продукта.
*   `product_accessory_append`: Добавляет связь с аксессуаром продукта.
*   `product_accessories_clear`: Очищает все связи с аксессуарами продукта.
*   `product_bundle`: Возвращает список бандлов продукта.
*   `product_bundle_append`: Добавляет связь с бандлом продукта.
*   `product_bundle_clear`: Очищает все связи с бандлами продукта.
*   `to_dict() -> Dict[str, Any]`: Преобразует объект `ProductFields` в словарь для PrestaShop API.
*   `_format_multilang_value(data: Any) -> List[Dict[str, str]]`: Форматирует мультиязычные значения в список словарей для PrestaShop API.

#### `_payload`

```python
def _payload(self) -> bool:
    """
    Загрузка дефолтных значений полей.
    Returns:
        bool: True, если загрузка прошла успешно, иначе False.
    """
    ...
```

**Назначение**: Загружает значения полей товара по умолчанию из файлов `fields_list.txt` и `product_fields_default_values.json`.

**Как работает функция**:

1.  Определяет базовый путь к каталогу с файлами конфигурации.
2.  Читает список полей из файла `fields_list.txt` и создает объект `SimpleNamespace` с этими полями, инициализированными значением `None`.
3.  Загружает словарь с значениями по умолчанию из файла `product_fields_default_values.json`.
4.  Устанавливает значения по умолчанию для полей объекта `presta_fields` из загруженного словаря.

```
    A: Определение базового пути
    |
    B: Чтение списка полей из fields_list.txt
    |
    C: Создание SimpleNamespace с полями
    |
    D: Загрузка словаря значений по умолчанию из product_fields_default_values.json
    |
    E: Установка значений по умолчанию для полей объекта presta_fields
```

**Примеры**:

```python
product_fields = ProductFields()
result = product_fields._payload()
print(result)  # Вывод: True или False в зависимости от успешности загрузки
```

#### `_set_multilang_value`

```python
def _set_multilang_value(self, field_name: str, value: str, id_lang: Optional[int | str] = None) -> bool:
    """
    Устанавливает мультиязычное значение для заданного поля.

    Args:
        field_name (str): Имя поля (например, 'name', 'description').
        value (str): Значение для установки.
        id_lang (Optional[Union[int, str]]): ID языка. Если не указан, используется self.id_lan.

    Описание:
        Функция устанавливает мультиязычное значение для указанного поля объекта.  
        Поле может хранить значения для разных языков.  Значения хранятся в виде списка словарей,
        где каждый словарь представляет собой значение для определенного языка и имеет структуру:

        {'attrs': {'id': 'language_id'}, 'value': 'language_value'}
         {'id': 'language_id'}, 'value': 'language_value'}

        - 'attrs': Словарь, содержащий атрибуты значения.  В данном случае, обязательным атрибутом является 'id',
                   который представляет собой идентификатор языка.
        - 'value': Значение поля для указанного языка.

        Если поле с указанным именем не существует, оно создается. Если поле существует, но не имеет
        ожидаемой структуры (словарь с ключом 'language', содержащим список), поле перезаписывается.
        Если поле существует и имеет правильную структуру, функция пытается обновить значение для
        указанного языка. Если язык уже существует в списке, его значение обновляется. Если язык
        не существует, добавляется новая запись в список.

    Returns:
        bool: True, если значение успешно установлено, False в случае ошибки.
    """
    ...
```

**Назначение**: Устанавливает или обновляет мультиязычное значение для указанного поля объекта `presta_fields`.

**Как работает функция**:

1.  Определяет `ID` языка. Если `id_lang` не указан, используется значение по умолчанию `self.id_lang`.
2.  Формирует структуру данных для языка в виде словаря `lang_data`.
3.  Проверяет, существует ли поле `field_name` в объекте `presta_fields`.
4.  Если поле не существует, создает его и устанавливает значение `lang_data`.
5.  Если поле существует, но не имеет ожидаемой структуры (словарь с ключом `'language'`, содержащим список), перезаписывает поле, создавая словарь с новым значением `lang_data`.
6.  Если поле существует и имеет правильную структуру, пытается обновить значение для указанного языка. Если язык уже существует в списке, его значение обновляется. Если язык не существует, добавляется новая запись в список.

```
    A: Определение ID языка
    |
    B: Формирование структуры данных для языка (lang_data)
    |
    C: Проверка существования поля field_name в presta_fields
    |
    D: Если поле не существует: создание поля и установка значения lang_data
    |
    E: Если поле существует: проверка структуры поля
    |
    F: Если структура неправильная: перезапись поля с новым значением lang_data
    |
    G: Если структура правильная: обновление или добавление значения для указанного языка
```

**Примеры**:

```python
product_fields = ProductFields()
result = product_fields._set_multilang_value('name', 'Новое название', id_lang=2)
print(result)  # Вывод: True или False в зависимости от успешности установки
```

#### EnumRedirect
```python
class EnumRedirect(Enum):
    """Перечисление для типов редиректов."""
    ERROR_404 = '404'
    REDIRECT_301_PRODUCT = '301-product'
    REDIRECT_302_PRODUCT = '302-product'
    REDIRECT_301_CATEGORY = '301-category'
    REDIRECT_302_CATEGORY = '302-category'
```

**Описание**:
Перечисление `EnumRedirect` определяет возможные типы редиректов для товара.

**Значения**:

*   `ERROR_404`: Редирект на страницу ошибки 404.
*   `REDIRECT_301_PRODUCT`: Постоянный редирект (301) на другой товар.
*   `REDIRECT_302_PRODUCT`: Временный редирект (302) на другой товар.
*   `REDIRECT_301_CATEGORY`: Постоянный редирект (301) на категорию.
*   `REDIRECT_302_CATEGORY`: Временный редирект (302) на категорию.

#### EnumCondition
```python
class EnumCondition(Enum):
    """Перечисление для состояний товара."""
    NEW = 'new'
    USED = 'used'
    REFURBISHED = 'refurbished'
```
**Описание**:
Перечисление `EnumCondition` определяет возможные состояния товара.

**Значения**:

*   `NEW`: Новый товар.
*   `USED`: Бывший в употреблении товар.
*   `REFURBISHED`: Восстановленный товар.

#### EnumVisibity
```python
class EnumVisibity(Enum):
    """Перечисление для видимости товара."""
    BOTH = 'both'
    CATALOG = 'catalog'
    SEARCH = 'search'
    NONE = 'none'
```

**Описание**:
Перечисление `EnumVisibity` определяет возможные варианты видимости товара.

**Значения**:

*   `BOTH`: Виден и в каталоге, и в результатах поиска.
*   `CATALOG`: Виден только в каталоге.
*   `SEARCH`: Виден только в результатах поиска.
*   `NONE`: Не виден нигде.

#### EnumProductType
```python
class EnumProductType(Enum):
    """Перечисление для типов товаров."""
    STANDARD = 'standard'
    PACK = 'pack'
    VIRTUAL = 'virtual'
    COMBINATIONS = 'combinations'
    EMPTY = ''
```

**Описание**:
Перечисление `EnumProductType` определяет возможные типы товаров.

**Значения**:

*   `STANDARD`: Стандартный товар.
*   `PACK`: Набор товаров.
*   `VIRTUAL`: Виртуальный товар (например, цифровой продукт).
*   `COMBINATIONS`: Товар с комбинациями (например, размеры и цвета).
*   `EMPTY`: Пустой тип.

#### to_dict

```python
def to_dict(self) -> Dict[str, Any]:
    """
    Преобразует объект ProductFields в словарь для PrestaShop API,
    исключая ключи, значения которых равны None или пустой строке,
    и формирует мультиязычные поля в нужном формате. Все поля должны быть представлены как строки.

    Returns:
        Dict[str, Any]: Словарь с полями, готовый для PrestaShop API.
    """
    ...
```

**Назначение**: Преобразует объект `ProductFields` в словарь, готовый для отправки в API PrestaShop.

**Как работает функция**:

1.  Создает пустой словарь `product_dict`.
2.  Использует вспомогательную функцию `str_val` для преобразования значений в строки, обрабатывая `None`.
3.  Для каждого поля объекта `ProductFields` проверяет, установлено ли значение. Если значение установлено, добавляет поле в словарь `product_dict`.
4.  Форматирует мультиязычные значения с помощью метода `_format_multilang_value`.
5.  Обрабатывает associations (категории, изображения, комбинации и т.д.), добавляя их в словарь `product_dict`.

```
    A: Создание пустого словаря product_dict
    |
    B: Для каждого поля объекта ProductFields:
    |   C: Проверка, установлено ли значение поля
    |   |   D: Если значение установлено:
    |   |   |   E: Преобразование значения в строку с помощью str_val
    |   |   |   F: Добавление поля в словарь product_dict
    |
    G: Форматирование мультиязычных значений с помощью _format_multilang_value
    |
    H: Обработка associations (категории, изображения, комбинации и т.д.)
    |
    I: Возврат словаря product_dict
```

**Примеры**:

```python
product_fields = ProductFields()
product_fields.name = 'Test Product'
product_dict = product_fields.to_dict()
print(product_dict)  # Вывод: словарь с полями товара, готовый для PrestaShop API
```

#### \_format_multilang_value

```python
def _format_multilang_value(self, data: Any) -> List[Dict[str, str]]:
    """
    Форматирует мультиязычные значения в список словарей для PrestaShop API. Все значения представляются как строки.

    Args:
        data (Any): Значение поля. Если это словарь, ожидается структура {'language': [{'attrs': {'id': lang_id}, 'value': value}]}

    Returns:
        List[Dict[str, str]]: Список словарей, где каждый словарь содержит 'id' и 'value' (все как строки) для каждого языка.
    """
    ...
```

**Назначение**: Форматирует мультиязычные значения в список словарей для PrestaShop API.

**Как работает функция**:

Функция принимает данные и должна возвращать их в нужном формате для PrestaShop API.

```
    A: Принимает данные data
    |
    B: Возвращает данные data без изменений
```

**Примеры**:

```python
product_fields = ProductFields()
formatted_value = product_fields._format_multilang_value({"language": [{"id": "1", "value": "Test"}]})
print(formatted_value)  # Вывод:  {"language": [{"id": "1", "value": "Test"}]}