# Модуль поддержки инструментов (tool_support.py)

## Обзор

Модуль `tool_support.py` предназначен для обеспечения поддержки инструментов (tools) в запросах к различным провайдерам моделей ИИ, таким как GPT-4. Он предоставляет класс `ToolSupportProvider`, который позволяет использовать инструменты, определенные в формате JSON, для обработки запросов и форматирования ответов.

## Подробнее

Этот модуль служит адаптером между запросами, содержащими описание инструментов, и асинхронными провайдерами моделей ИИ. Он обрабатывает входные данные, преобразует их в формат, понятный провайдеру, и возвращает результаты, включая вызовы инструментов и статистику использования. Модуль поддерживает только один инструмент за раз и требует, чтобы ответы были в формате JSON.

## Классы

### `ToolSupportProvider`

**Описание**: Класс `ToolSupportProvider` является асинхронным провайдером, который поддерживает использование инструментов при взаимодействии с моделями ИИ.

**Наследует**:
- `AsyncGeneratorProvider`: Наследует функциональность асинхронного генератора провайдера.

**Аттрибуты**:
- `working` (bool): Указывает, работает ли провайдер. По умолчанию `True`.

**Методы**:
- `create_async_generator()`: Создает асинхронный генератор для выполнения запроса с использованием инструментов.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    stream: bool = True,
    media: MediaListType = None,
    tools: list[str] = None,
    response_format: dict = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для выполнения запроса с использованием инструментов.

    Args:
        model (str): Имя модели для использования. Может включать имя провайдера через `:`.
        messages (Messages): Список сообщений для отправки в модель.
        stream (bool): Флаг, указывающий, использовать ли потоковую передачу. По умолчанию `True`.
        media (MediaListType): Список медиафайлов для отправки в модель. По умолчанию `None`.
        tools (list[str]): Список инструментов для использования. Поддерживается только один инструмент. По умолчанию `None`.
        response_format (dict): Формат ответа. Должен быть `{"type": "json"}`, если используются инструменты. По умолчанию `None`.
        **kwargs: Дополнительные аргументы, передаваемые провайдеру.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий результаты от провайдера.

    Raises:
        ValueError: Если передано более одного инструмента.

    """
```

**Назначение**:
Создает и возвращает асинхронный генератор, который обрабатывает запросы к моделям ИИ с использованием предоставленных инструментов.

**Параметры**:
- `cls`: Ссылка на класс `ToolSupportProvider`.
- `model` (str): Имя используемой модели. Может включать имя провайдера, разделенное символом `:`.
- `messages` (Messages): Список сообщений, отправляемых в модель ИИ.
- `stream` (bool): Определяет, использовать ли потоковую передачу данных. По умолчанию `True`.
- `media` (MediaListType): Список медиафайлов, которые будут отправлены в модель. По умолчанию `None`.
- `tools` (list[str]): Список инструментов для использования. В текущей версии поддерживается только один инструмент. По умолчанию `None`.
- `response_format` (dict): Формат ответа, который ожидается от модели. Если используются инструменты, должен быть установлен в `{"type": "json"}`. По умолчанию `None`.
- `**kwargs`: Дополнительные именованные аргументы, которые будут переданы провайдеру модели.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, предоставляющий результаты от провайдера модели ИИ.

**Вызывает исключения**:
- `ValueError`: Если в списке `tools` передано более одного инструмента.

**Как работает функция**:

1. **Подготовка**:
   - Извлекает имя провайдера и модели из параметра `model`.
   - Получает экземпляр провайдера модели ИИ, используя функцию `get_model_and_provider`.
   - Проверяет, что передан только один инструмент, и устанавливает формат ответа в JSON, если используются инструменты.
   - Формирует сообщение для модели, включающее информацию о необходимости ответа в формате JSON и структуру ожидаемых свойств.

2. **Запрос к провайдеру**:
   - Вызывает асинхронную функцию `get_async_create_function` провайдера для получения генератора ответов.
   - Передает все необходимые параметры, включая модель, сообщения, медиа и формат ответа.

3. **Обработка ответов**:
   - Итерируется по чанкам (частям) ответа, возвращаемым генератором провайдера.
   - Если чанк является строкой, добавляет его в список `chunks`.
   - Если чанк является экземпляром `Usage`, передает его вызывающей стороне и устанавливает флаг `has_usage`.
   - Если чанк является экземпляром `FinishReason`, запоминает его и завершает итерацию.
   - Все остальные чанки передаются вызывающей стороне.

4. **Формирование результата**:
   - Если не было информации об использовании (`Usage`), создает и передает объект `Usage` с информацией о количестве токенов.
   - Объединяет все строковые чанки в одну строку.
   - Если использовались инструменты, формирует объект `ToolCalls` с информацией о вызове инструмента и аргументами, извлеченными из ответа модели.
   - Передает строку с результатом или объект `ToolCalls` вызывающей стороне.
   - Если был получен `FinishReason`, передает его вызывающей стороне.

**ASCII flowchart**:

```
A: Подготовка данных (извлечение провайдера, модели, проверка инструментов)
|
B: Формирование сообщения (JSON формат, описание структуры)
|
C: Запрос к провайдеру (вызов get_async_create_function)
|
D: Обработка ответов (итерация по чанкам)
|
E: Формирование результата (Usage, ToolCalls, FinishReason)
|
F: Возврат результата
```

**Примеры**:

```python
# Пример использования с указанием модели и сообщения
model = "gpt-4"
messages = [{"role": "user", "content": "Напиши функцию на Python, которая складывает два числа."}]
async_generator = ToolSupportProvider.create_async_generator(model=model, messages=messages)

# Пример использования с указанием инструмента
tools = [{
    "function": {
        "name": "get_current_weather",
        "parameters": {
            "properties": {
                "location": {"type": "string"},
                "format": {"type": "string"}
            }
        }
    }
}]
async_generator = ToolSupportProvider.create_async_generator(model=model, messages=messages, tools=tools)