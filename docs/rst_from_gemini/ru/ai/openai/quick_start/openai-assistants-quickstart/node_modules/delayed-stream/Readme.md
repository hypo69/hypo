```markdown
# delayed-stream

Buffers events from a stream until you are ready to handle them.

## Installation

```bash
npm install delayed-stream
```

## Usage

This example demonstrates a simple HTTP echo server that delays its response by 1000ms.

```javascript
const DelayedStream = require('delayed-stream');
const http = require('http');

const server = http.createServer((req, res) => {
  const delayed = DelayedStream.create(req);

  setTimeout(() => {
    res.writeHead(200);
    delayed.pipe(res);
  }, 1000);
});

server.listen(3000, () => console.log('Server listening on port 3000'));
```

If you don't use `pipe`, you can manually release the buffered events:

```javascript
const delayed = DelayedStream.create(req);

setTimeout(() => {
  delayed.resume(); // Emit all buffered events and resume the underlying source
}, 1000);
```

## Implementation Details

### Event Buffering/Proxying

`delayed-stream` intercepts all events from the source stream by overriding the `source.emit` method. This is the only way to achieve this functionality reliably until Node.js provides a better solution for event interception.

`delayed-stream` continues to emit all captured events from the `source`, regardless of whether the stream is released or not.

- Upon creation, it captures all `source` events and stores them in an internal buffer.
- When `delayedStream.release()` is called, all buffered events are emitted on the `delayedStream`, and the buffer is cleared.  After that, it acts as a proxy for the underlying source.

### Error Handling

Error events from the `source` are also buffered/proxied.  Crucially, `delayedStream.create` adds a no-op `'error'` listener to the `source`. This means you only need to handle errors on the `delayedStream` object, not in two separate locations.

### Buffer Limits

`delayed-stream` has a `maxDataSize` property (enabled by default) to prevent issues with problematic sources that don't pause appropriately.

- `maxDataSize` defaults to 1MB (1024 * 1024).
- For `Buffer` objects, `maxDataSize` refers to bytes.
- For strings, it refers to characters.
- Set to `Infinity` to disable the limit (use with caution).  You can change this property at runtime.

## API

### `DelayedStream.create(source, [options])`

Creates a new `delayedStream` object.

* **`source`**: The stream to delay.
* **`options`**:
    * **`pauseStream`**: Defaults to `true`. Whether to pause the underlying `source` stream when `DelayedStream.create()` is called.  Modifying this after creation has no effect.
    * **`maxDataSize`**: Default 1MB (1024 * 1024). The maximum amount of data to buffer before emitting an error.

### `delayedStream.source`

The original `source` stream. Useful for accessing properties on the original source stream.

### `delayedStream.pauseStream`

Whether the underlying stream was paused during creation.  Modifying this after creation is ignored.

### `delayedStream.maxDataSize`

The maximum amount of data to buffer. Default: 1MB.  Set to `Infinity` to disable the limit.

### `delayedStream.dataSize`

The current amount of data buffered.

### `delayedStream.readable`

An ECMA5 getter that returns the `source.readable` property.

### `delayedStream.resume()`

If `delayedStream` hasn't been released, calls `delayedStream.release()`.  Then, calls `source.resume()`.

### `delayedStream.pause()`

Calls `source.pause()`.

### `delayedStream.pipe(dest)`

Calls `delayedStream.resume()` and then proxies the call to `source.pipe(dest)`.

### `delayedStream.release()`

Emits all buffered events and clears the buffer. **Does not resume the underlying source**. Use `delayedStream.resume()` for that.

## License

[MIT License](LICENSE)
```