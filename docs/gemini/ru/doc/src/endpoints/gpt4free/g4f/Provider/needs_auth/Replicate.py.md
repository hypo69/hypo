# Модуль Replicate

## Обзор

Модуль `Replicate` предоставляет асинхронный генератор для взаимодействия с API Replicate.com. Он позволяет выполнять запросы к различным моделям, размещенным на Replicate, и получать результаты в виде асинхронного потока. Модуль поддерживает аутентификацию через API-ключ и предоставляет гибкие настройки для управления параметрами запроса.

## Подробней

Модуль `Replicate` предназначен для интеграции с сервисом Replicate.com, который предоставляет доступ к различным моделям машинного обучения. Класс `Replicate` реализует асинхронный генератор, позволяющий получать результаты от API Replicate в потоковом режиме.

В данном коде используется асинхронный подход для взаимодействия с API, что позволяет эффективно обрабатывать запросы и получать результаты в реальном времени. Класс `Replicate` предоставляет методы для аутентификации, настройки параметров запроса и обработки ответов от API Replicate.

## Классы

### `Replicate`

**Описание**: Класс `Replicate` является асинхронным генератором и предоставляет методы для взаимодействия с API Replicate.

**Принцип работы**:

1.  **Инициализация**: При создании экземпляра класса `Replicate` устанавливаются базовые параметры, такие как URL, необходимость аутентификации и используемая модель.
2.  **Аутентификация**: Если требуется аутентификация, класс использует API-ключ для авторизации запросов.
3.  **Формирование запроса**: Класс формирует запрос к API Replicate с учетом переданных параметров, таких как модель, входные данные и настройки генерации.
4.  **Обработка ответа**: Класс отправляет запрос к API Replicate и обрабатывает полученный ответ, генерируя асинхронный поток результатов.

**Наследует**:

*   `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
*   `ProviderModelMixin`: Предоставляет методы для работы с моделями.

**Атрибуты**:

*   `url` (str): URL сервиса Replicate.
*   `login_url` (str): URL для получения API-токена.
*   `working` (bool): Флаг, указывающий на работоспособность провайдера.
*   `needs_auth` (bool): Флаг, указывающий на необходимость аутентификации.
*   `default_model` (str): Модель, используемая по умолчанию.
*   `models` (list[str]): Список поддерживаемых моделей.

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        api_key: str = None,
        proxy: str = None,
        timeout: int = 180,
        system_prompt: str = None,
        max_tokens: int = None,
        temperature: float = None,
        top_p: float = None,
        top_k: float = None,
        stop: list = None,
        extra_data: dict = {},\
        headers: dict = {\
            "accept": "application/json",\
        },\
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для взаимодействия с API Replicate.

        Args:
            model (str): Имя модели для использования.
            messages (Messages): Список сообщений для отправки в модель.
            api_key (str, optional): API-ключ для аутентификации. По умолчанию `None`.
            proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
            timeout (int, optional): Максимальное время ожидания ответа. По умолчанию 180.
            system_prompt (str, optional): Системное сообщение для модели. По умолчанию `None`.
            max_tokens (int, optional): Максимальное количество токенов в ответе. По умолчанию `None`.
            temperature (float, optional): Температура для генерации текста. По умолчанию `None`.
            top_p (float, optional): Значение Top P для генерации текста. По умолчанию `None`.
            top_k (float, optional): Значение Top K для генерации текста. По умолчанию `None`.
            stop (list, optional): Список стоп-слов для прекращения генерации. По умолчанию `None`.
            extra_data (dict, optional): Дополнительные данные для отправки в запросе. По умолчанию `{}`.
            headers (dict, optional): Дополнительные заголовки для отправки в запросе. По умолчанию `{"accept": "application/json"}`.
            **kwargs: Дополнительные параметры.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий результаты от API Replicate.

        Raises:
            MissingAuthError: Если отсутствует API-ключ при необходимости аутентификации.
            ResponseError: Если получен некорректный ответ от API.

        Внутренние функции:
            async with StreamSession(...): Используется для создания асинхронной сессии для выполнения HTTP-запросов.
            format_prompt(messages): Форматирует сообщения для отправки в модель.
            filter_none(...): Фильтрует `None` значения из параметров запроса.
            raise_for_status(...): Проверяет статус ответа и вызывает исключение в случае ошибки.

        """
        ...
```

**Назначение**: Создает асинхронный генератор для взаимодействия с API Replicate.

**Параметры**:

*   `cls`: Ссылка на класс.
*   `model` (str): Имя модели для использования.
*   `messages` (Messages): Список сообщений для отправки в модель.
*   `api_key` (str, optional): API-ключ для аутентификации. По умолчанию `None`.
*   `proxy` (str, optional): Адрес прокси-сервера. По умолчанию `None`.
*   `timeout` (int, optional): Максимальное время ожидания ответа. По умолчанию 180.
*   `system_prompt` (str, optional): Системное сообщение для модели. По умолчанию `None`.
*   `max_tokens` (int, optional): Максимальное количество токенов в ответе. По умолчанию `None`.
*   `temperature` (float, optional): Температура для генерации текста. По умолчанию `None`.
*   `top_p` (float, optional): Значение Top P для генерации текста. По умолчанию `None`.
*   `top_k` (float, optional): Значение Top K для генерации текста. По умолчанию `None`.
*   `stop` (list, optional): Список стоп-слов для прекращения генерации. По умолчанию `None`.
*   `extra_data` (dict, optional): Дополнительные данные для отправки в запросе. По умолчанию `{}`.
*   `headers` (dict, optional): Дополнительные заголовки для отправки в запросе. По умолчанию `{"accept": "application/json"}`.
*   `**kwargs`: Дополнительные параметры.

**Возвращает**:

*   `AsyncResult`: Асинхронный генератор, возвращающий результаты от API Replicate.

**Вызывает исключения**:

*   `MissingAuthError`: Если отсутствует API-ключ при необходимости аутентификации.
*   `ResponseError`: Если получен некорректный ответ от API.

**Как работает функция**:

1.  **Получение модели**: Функция `get_model` используется для получения имени модели.
2.  **Проверка аутентификации**: Если для провайдера требуется аутентификация и API-ключ не предоставлен, вызывается исключение `MissingAuthError`.
3.  **Формирование заголовков**: Если API-ключ предоставлен, он добавляется в заголовок `Authorization`.
4.  **Создание сессии**: Создается асинхронная сессия с использованием `StreamSession` для выполнения HTTP-запросов.
5.  **Формирование данных**: Формируются данные для отправки в запросе, включая входные данные, системное сообщение и параметры генерации.
6.  **Отправка запроса**: Отправляется POST-запрос к API Replicate с сформированными данными.
7.  **Обработка ответа**: Обрабатывается ответ от API Replicate, проверяется наличие ошибок и извлекается идентификатор предсказания.
8.  **Получение потока**: Получается поток результатов с использованием GET-запроса к URL потока.
9.  **Генерация результатов**: Асинхронно перебираются строки в потоке результатов, извлекаются данные и генерируются результаты.

```
    A. Получение и проверка параметров
    │
    ├── B. Проверка необходимости аутентификации
    │   │
    │   └── C. Формирование заголовков запроса (при необходимости)
    │
    │
    D. Создание асинхронной сессии
    │
    ├── E. Формирование данных запроса
    │   │
    │   └── F. Отправка POST-запроса к API
    │
    │
    G. Обработка ответа от API
    │
    ├── H. Извлечение идентификатора предсказания
    │   │
    │   └── I. Получение потока результатов
    │
    │
    J. Асинхронная генерация результатов
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from typing import AsyncGenerator, List, Dict

from g4f.Provider.needs_auth import Replicate

async def main():
    model = "meta/meta-llama-3-70b-instruct"
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    api_key = "YOUR_API_KEY"  # Замените на ваш реальный API-ключ
    
    try:
        generator: AsyncGenerator = await Replicate.create_async_generator(
            model=model, 
            messages=messages, 
            api_key=api_key
        )
        
        async for response in generator:
            print(response, end="")
            
    except Exception as ex:
        print(f"Ошибка при вызове Replicate: {ex}")

if __name__ == "__main__":
    asyncio.run(main())