# Модуль `DfeHub.py`

## Обзор

Модуль `DfeHub.py` предоставляет класс `DfeHub`, который является провайдером для взаимодействия с API чат-бота DfeHub. Он поддерживает потоковую передачу данных и модель `gpt-3.5-turbo`.

## Подробней

Этот модуль позволяет отправлять запросы к API DfeHub для генерации ответов на основе предоставленных сообщений. Он использует библиотеку `requests` для отправки HTTP-запросов и обрабатывает потоковые ответы от сервера. Модуль предназначен для интеграции с другими частями проекта `hypotez`, где требуется взаимодействие с чат-ботом DfeHub.

## Классы

### `DfeHub(AbstractProvider)`

**Описание**: Класс `DfeHub` является провайдером для взаимодействия с API чат-бота DfeHub.

**Наследует**:
- `AbstractProvider`: Абстрактный класс, определяющий интерфейс для провайдеров.

**Атрибуты**:
- `url` (str): URL-адрес API DfeHub.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных.
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель `gpt-3.5-turbo`.

**Методы**:
- `create_completion()`: Отправляет запрос к API DfeHub и возвращает ответ.

## Функции

### `create_completion`

```python
    @staticmethod
    def create_completion(
        model: str,
        messages: list[dict[str, str]],
        stream: bool, **kwargs: Any) -> CreateResult:
        """
        Отправляет запрос к API DfeHub для создания завершения чата.

        Args:
            model (str): Название модели для использования.
            messages (list[dict[str, str]]): Список сообщений для отправки в API.
            stream (bool): Указывает, следует ли использовать потоковую передачу данных.
            **kwargs (Any): Дополнительные аргументы для передачи в API.

        Returns:
            CreateResult: Результат создания завершения чата.

        Raises:
            requests.exceptions.RequestException: Если возникает ошибка при отправке запроса.
            json.JSONDecodeError: Если возникает ошибка при декодировании JSON-ответа.

        """
        ...
```

**Назначение**: Отправляет запрос к API DfeHub для создания завершения чата на основе предоставленных сообщений и параметров.

**Параметры**:
- `model` (str): Название модели для использования. В данном случае всегда `gpt-3.5-turbo`.
- `messages` (list[dict[str, str]]): Список сообщений, где каждое сообщение представляет собой словарь с ключами `"role"` и `"content"`.
- `stream` (bool): Указывает, следует ли использовать потоковую передачу данных. Если `True`, ответ возвращается по частям.
- `**kwargs (Any)`: Дополнительные аргументы, такие как `temperature`, `presence_penalty`, `frequency_penalty` и `top_p`, которые передаются в API.

**Возвращает**:
- `CreateResult`: Результат создания завершения чата. Это генератор, который возвращает части ответа по мере их поступления.

**Вызывает исключения**:
- `requests.exceptions.RequestException`: Если возникает ошибка при отправке HTTP-запроса.
- `json.JSONDecodeError`: Если возникает ошибка при декодировании JSON-ответа от сервера.

**Как работает функция**:

1. **Подготовка заголовков**: Создаются HTTP-заголовки для запроса, включая `authority`, `accept`, `content-type`, `origin`, `referer`, `user-agent` и другие.
2. **Подготовка данных JSON**: Формируется JSON-объект с сообщениями, моделью и дополнительными параметрами из `kwargs`.
3. **Отправка POST-запроса**: Отправляется POST-запрос к API `https://chat.dfehub.com/api/openai/v1/chat/completions` с заголовками и данными JSON.
4. **Обработка потокового ответа**: Функция итерирует по строкам потокового ответа:
   - Если строка содержит `"detail"`, извлекается значение задержки (в секундах) и вызывается рекурсивно `DfeHub.create_completion` после задержки.
   - Если строка содержит `"content"`, извлекается содержимое сообщения из JSON, декодируется и возвращается как часть ответа.

```
    Подготовка данных JSON
    │
    └── Запрос к API
        │
        ├── Если "detail" в ответе: Извлечение задержки и рекурсивный вызов
        │   └── Пауза на указанное время
        │
        └── Если "content" в ответе: Извлечение и возврат содержимого
```

**Примеры**:

```python
messages = [{"role": "user", "content": "Hello, how are you?"}]
model = "gpt-3.5-turbo"
stream = True
kwargs = {"temperature": 0.7, "top_p": 0.9}

result = DfeHub.create_completion(model, messages, stream, **kwargs)
for chunk in result:
    print(chunk, end="")