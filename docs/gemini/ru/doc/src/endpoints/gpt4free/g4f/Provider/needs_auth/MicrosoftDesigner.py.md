# Модуль MicrosoftDesigner

## Обзор

Модуль `MicrosoftDesigner` предоставляет асинхронный интерфейс для генерации изображений с использованием Microsoft Designer API. Он включает в себя функциональность для получения токена доступа, создания изображений на основе текстового запроса и возврата результатов в виде списка URL-адресов изображений.

## Подробней

Этот модуль предназначен для интеграции с другими частями проекта `hypotez`, предоставляя возможность генерации изображений на основе текстовых описаний. Он использует асинхронные запросы для взаимодействия с API Microsoft Designer, что позволяет эффективно обрабатывать запросы и минимизировать задержки.

Модуль поддерживает различные размеры изображений и предоставляет возможность использования прокси-сервера для обхода ограничений сети.

## Классы

### `MicrosoftDesigner`

**Описание**: Класс `MicrosoftDesigner` предоставляет методы для асинхронной генерации изображений с использованием Microsoft Designer API.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет общие методы для работы с моделями.

**Атрибуты**:
- `label` (str): Метка провайдера ("Microsoft Designer").
- `url` (str): URL-адрес Microsoft Designer ("https://designer.microsoft.com").
- `working` (bool): Флаг, указывающий на работоспособность провайдера (True).
- `use_nodriver` (bool): Флаг, указывающий на использование без драйвера (True).
- `needs_auth` (bool): Флаг, указывающий на необходимость аутентификации (True).
- `default_image_model` (str): Модель изображения по умолчанию ("dall-e-3").
- `image_models` (list): Список поддерживаемых моделей изображений (включая размеры).
- `models` (list): Псевдоним для `image_models`.

**Методы**:

- `create_async_generator`
- `generate`

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        prompt: str = None,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для генерации изображений.

        Args:
            model (str): Модель для генерации изображений.
            messages (Messages): Список сообщений для формирования запроса.
            prompt (str, optional): Текстовый запрос для генерации изображения. По умолчанию `None`.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий объекты `ImageResponse`.

        Как работает функция:
        1. Определяет размер изображения на основе выбранной модели.
        2. Вызывает метод `generate` для генерации изображения.
        3. Возвращает асинхронный генератор, который возвращает результат генерации изображения.
        """
```

**Как работает функция**:

1.  **Определение размера изображения**: На основе выбранной модели (`model`) определяет размер изображения (`image_size`). Если модель не является моделью по умолчанию и присутствует в списке поддерживаемых моделей, то используется соответствующий размер.
2.  **Генерация изображения**: Вызывает метод `generate` для фактической генерации изображения с использованием текстового запроса (`prompt`), размера изображения (`image_size`) и прокси-сервера (`proxy`).
3.  **Возврат результата**: Возвращает результат генерации изображения в виде объекта `ImageResponse` с использованием `yield`. Это делает функцию асинхронным генератором.

```
Размер изображения --> Генерация изображения --> Возврат результата
```

**Примеры**:

```python
# Пример вызова create_async_generator
async for image_response in MicrosoftDesigner.create_async_generator(
    model="dall-e-3",
    messages=[{"role": "user", "content": "A cat"}],
    prompt="A cat",
    proxy="http://proxy.example.com"
):
    print(image_response)
```

### `generate`

```python
    @classmethod
    async def generate(cls, prompt: str, image_size: str, proxy: str = None) -> ImageResponse:
        """Генерирует изображения на основе текстового запроса.

        Args:
            prompt (str): Текстовый запрос для генерации изображения.
            image_size (str): Размер изображения.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.

        Returns:
            ImageResponse: Объект `ImageResponse`, содержащий URL-адреса сгенерированных изображений.

        Raises:
            NoValidHarFileError: Если не найден валидный HAR-файл.

        Как работает функция:
        1. Пытается прочитать токен доступа и user-agent из HAR-файла.
        2. Если HAR-файл не найден или не содержит токена доступа, пытается получить их с помощью `get_access_token_and_user_agent`.
        3. Вызывает функцию `create_images` для создания изображений на основе полученных данных.
        4. Возвращает объект `ImageResponse`, содержащий URL-адреса сгенерированных изображений.
        """
```

**Как работает функция**:

1.  **Получение токена доступа и user-agent**:
    *   Пытается прочитать токен доступа (`access_token`) и user-agent из HAR-файла с использованием функции `readHAR`.
    *   Если происходит ошибка `NoValidHarFileError`, то пытается получить токен доступа и user-agent с помощью функции `get_access_token_and_user_agent`.
2.  **Создание изображений**: Вызывает функцию `create_images` для создания изображений на основе полученного текстового запроса (`prompt`), токена доступа (`access_token`), user-agent, размера изображения (`image_size`) и прокси-сервера (`proxy`).
3.  **Возврат результата**: Возвращает объект `ImageResponse`, содержащий URL-адреса сгенерированных изображений.

```
Получение токена доступа и user-agent --> Создание изображений --> Возврат результата
```

**Примеры**:

```python
# Пример вызова generate
image_response = await MicrosoftDesigner.generate(
    prompt="A futuristic cityscape",
    image_size="1024x1024",
    proxy="http://proxy.example.com"
)
print(image_response)
```

## Функции

### `create_images`

```python
async def create_images(prompt: str, access_token: str, user_agent: str, image_size: str, proxy: str = None, seed: int = None):
    """Создает изображения на основе текстового запроса, используя API Microsoft Designer.

    Args:
        prompt (str): Текстовый запрос для генерации изображения.
        access_token (str): Токен доступа для аутентификации в API.
        user_agent (str): User-Agent для HTTP-запросов.
        image_size (str): Размер изображения.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        seed (int, optional): Зерно для случайной генерации. По умолчанию `None`.

    Returns:
        list[str]: Список URL-адресов сгенерированных изображений.

    Как работает функция:
    1. Определяет URL-адрес API.
    2. Генерирует случайное зерно, если оно не предоставлено.
    3. Формирует заголовки HTTP-запроса.
    4. Формирует данные формы для POST-запроса.
    5. Отправляет POST-запрос к API для генерации изображений.
    6. Извлекает URL-адреса сгенерированных изображений из ответа API.
    7. Отправляет POST-запросы для опроса API, пока изображения не будут сгенерированы.
    8. Возвращает список URL-адресов сгенерированных изображений.
    """
```

**Как работает функция**:

1.  **Определение URL-адреса API**: Определяет URL-адрес API Microsoft Designer для генерации изображений.
2.  **Генерация случайного зерна**: Если `seed` не предоставлен, генерирует случайное целое число в диапазоне от 0 до 10000.
3.  **Формирование заголовков HTTP-запроса**: Создает словарь `headers`, содержащий необходимые заголовки для HTTP-запроса, включая `User-Agent`, `Authorization` и другие параметры.
4.  **Формирование данных формы для POST-запроса**: Создает объект `aiohttp.FormData` и добавляет в него необходимые поля, такие как `dalle-caption` (текстовый запрос), `dalle-batch-size` (количество изображений) и `dalle-image-size` (размер изображения).
5.  **Отправка POST-запроса к API для генерации изображений**: Отправляет асинхронный POST-запрос к API Microsoft Designer с использованием библиотеки `aiohttp`.
6.  **Извлечение URL-адресов сгенерированных изображений из ответа API**: Извлекает URL-адреса сгенерированных изображений из ответа API.
7.  **Отправка POST-запросов для опроса API, пока изображения не будут сгенерированы**: Отправляет асинхронные POST-запросы для опроса API, пока изображения не будут сгенерированы.
8.  **Возврат списка URL-адресов сгенерированных изображений**: Возвращает список URL-адресов сгенерированных изображений.

```
Определение URL-адреса API --> Генерация случайного зерна --> Формирование заголовков HTTP-запроса --> Формирование данных формы для POST-запроса --> Отправка POST-запроса к API для генерации изображений --> Извлечение URL-адресов сгенерированных изображений из ответа API --> Отправка POST-запросов для опроса API, пока изображения не будут сгенерированы --> Возврат списка URL-адресов сгенерированных изображений
```

**Примеры**:

```python
# Пример вызова create_images
images = await create_images(
    prompt="A cat",
    access_token="your_access_token",
    user_agent="your_user_agent",
    image_size="1024x1024",
    proxy="http://proxy.example.com",
    seed=1234
)
print(images)
```

### `readHAR`

```python
def readHAR(url: str) -> tuple[str, str]:
    """Считывает токен доступа и user-agent из HAR-файла.

    Args:
        url (str): URL-адрес, который должен присутствовать в HAR-файле.

    Returns:
        tuple[str, str]: Кортеж, содержащий токен доступа и user-agent.

    Raises:
        NoValidHarFileError: Если не найден валидный HAR-файл.

    Как работает функция:
    1. Перебирает HAR-файлы, полученные из `get_har_files()`.
    2. Читает содержимое каждого файла и пытается разобрать его как JSON.
    3. Перебирает записи в HAR-файле и ищет записи, URL которых начинается с заданного URL.
    4. Извлекает токен доступа и user-agent из заголовков HTTP-запроса.
    5. Если токен доступа не найден, вызывает исключение `NoValidHarFileError`.
    6. Возвращает токен доступа и user-agent.
    """
```

**Как работает функция**:

1.  **Перебор HAR-файлов**: Перебирает HAR-файлы, полученные из функции `get_har_files()`.
2.  **Чтение и разбор содержимого файла**: Читает содержимое каждого файла и пытается разобрать его как JSON с использованием `json.loads`. Если файл не является валидным JSON, переходит к следующему файлу.
3.  **Перебор записей в HAR-файле**: Перебирает записи в HAR-файле (`harFile['log']['entries']`) и ищет записи, URL которых начинается с заданного URL (`url`).
4.  **Извлечение токена доступа и user-agent**: Извлекает токен доступа (`api_key`) и user-agent из заголовков HTTP-запроса (`v['request']['headers']`).
5.  **Обработка отсутствия токена доступа**: Если токен доступа не найден, вызывает исключение `NoValidHarFileError`.
6.  **Возврат токена доступа и user-agent**: Возвращает токен доступа и user-agent в виде кортежа.

```
Перебор HAR-файлов --> Чтение и разбор содержимого файла --> Перебор записей в HAR-файле --> Извлечение токена доступа и user-agent --> Обработка отсутствия токена доступа --> Возврат токена доступа и user-agent
```

**Примеры**:

```python
# Пример вызова readHAR
try:
    api_key, user_agent = readHAR("https://designerapp.officeapps.live.com")
    print(f"API Key: {api_key}")
    print(f"User Agent: {user_agent}")
except NoValidHarFileError as ex:
    print(f"Error: {ex}")
```

### `get_access_token_and_user_agent`

```python
async def get_access_token_and_user_agent(url: str, proxy: str = None):
    """Получает токен доступа и user-agent с использованием Playwright.

    Args:
        url (str): URL-адрес для получения токена доступа и user-agent.
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.

    Returns:
        tuple[str, str]: Кортеж, содержащий токен доступа и user-agent.

    Как работает функция:
    1. Запускает браузер с использованием Playwright.
    2. Открывает страницу по заданному URL.
    3. Извлекает user-agent из браузера.
    4. Извлекает токен доступа из localStorage.
    5. Закрывает страницу и останавливает браузер.
    6. Возвращает токен доступа и user-agent.
    """
```

**Как работает функция**:

1.  **Запуск браузера с использованием Playwright**: Запускает браузер с использованием Playwright через функцию `get_nodriver`, которая возвращает экземпляр браузера и функцию для его остановки.
2.  **Открытие страницы по заданному URL**: Открывает страницу по заданному URL с помощью метода `browser.get(url)`.
3.  **Извлечение user-agent из браузера**: Извлекает user-agent из браузера с помощью метода `page.evaluate("navigator.userAgent")`.
4.  **Извлечение токена доступа из localStorage**: Извлекает токен доступа из `localStorage` с помощью метода `page.evaluate`. Этот метод выполняет JavaScript-код в контексте страницы, который перебирает элементы `localStorage`, ищет элемент с `credentialType == "AccessToken"` и `item.target.includes("designerappservice")`, и возвращает его `secret` (токен доступа).
5.  **Закрытие страницы и остановка браузера**: Закрывает страницу с помощью метода `page.close()` и останавливает браузер с помощью функции `stop_browser()`.
6.  **Возврат токена доступа и user-agent**: Возвращает токен доступа и user-agent в виде кортежа.

```
Запуск браузера с использованием Playwright --> Открытие страницы по заданному URL --> Извлечение user-agent из браузера --> Извлечение токена доступа из localStorage --> Закрытие страницы и остановка браузера --> Возврат токена доступа и user-agent
```

**Примеры**:

```python
# Пример вызова get_access_token_and_user_agent
try:
    access_token, user_agent = await get_access_token_and_user_agent(
        url="https://designerapp.officeapps.live.com",
        proxy="http://proxy.example.com"
    )
    print(f"Access Token: {access_token}")
    print(f"User Agent: {user_agent}")
except Exception as ex:
    print(f"Error: {ex}")