# Модуль `Chatgpt4Online.py`

## Обзор

Модуль предназначен для асинхронного взаимодействия с провайдером Chatgpt4Online. Он позволяет отправлять запросы к API и получать ответы в виде асинхронного генератора. Модуль использует `aiohttp` для выполнения асинхронных HTTP-запросов.

## Подробней

Модуль содержит класс `Chatgpt4Online`, который наследуется от `AsyncGeneratorProvider` и реализует логику взаимодействия с API `chatgpt4online.org`. Он включает в себя методы для получения `nonce` (одноразового ключа), необходимого для аутентификации запросов, и для создания асинхронного генератора, который возвращает ответы от API в реальном времени.

## Классы

### `Chatgpt4Online`

**Описание**: Класс для взаимодействия с провайдером Chatgpt4Online.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных генераторов провайдеров.

**Атрибуты**:
- `url` (str): URL главной страницы `chatgpt4online.org`.
- `api_endpoint` (str): Endpoint API для отправки сообщений.
- `working` (bool): Указывает, является ли провайдер рабочим (в данном случае `False`).
- `default_model` (str): Модель, используемая по умолчанию (`'gpt-4'`).
- `models` (List[str]): Список поддерживаемых моделей (в данном случае только `default_model`).

**Методы**:
- `get_nonce(headers: dict) -> str`: Получает одноразовый ключ (nonce) для аутентификации запросов.
- `create_async_generator(model: str, messages: Messages, proxy: str = None, **kwargs) -> AsyncResult`: Создает асинхронный генератор для отправки запросов и получения ответов от API.

## Функции

### `get_nonce`

```python
async def get_nonce(headers: dict) -> str:
    """Получает одноразовый ключ (nonce) для аутентификации запросов.

    Args:
        headers (dict): Заголовки HTTP-запроса.

    Returns:
        str: Одноразовый ключ (nonce).
    """
```

**Назначение**: Получение `nonce` (одноразового ключа) для аутентификации запросов к API `chatgpt4online.org`.

**Параметры**:
- `headers` (dict): Заголовки HTTP-запроса, используемые при запросе `nonce`.

**Возвращает**:
- `str`: Одноразовый ключ (nonce), полученный из ответа API.

**Как работает функция**:
1. **Создание асинхронной сессии**: Функция создает асинхронную сессию с использованием `ClientSession` из библиотеки `aiohttp` с переданными заголовками.
2. **Выполнение POST-запроса**: Выполняется POST-запрос к endpoint `/wp-json/mwai/v1/start_session` для получения `nonce`.
3. **Обработка ответа**: Извлекает `nonce` из JSON-ответа, возвращаемого сервером.

```ascii
    Создание асинхронной сессии
     ↓
    Выполнение POST-запроса к API
     ↓
    Извлечение nonce из JSON-ответа
     ↓
    Возврат nonce
```

**Примеры**:

```python
headers = {
    "accept": "text/event-stream",
    "accept-language": "en-US,en;q=0.9",
    "content-type": "application/json",
    "dnt": "1",
    "origin": "https://chatgpt4online.org",
    "priority": "u=1, i",
    "referer": "https://chatgpt4online.org/",
    "sec-ch-ua": '"Not/A)Brand";v="8", "Chromium";v="126"',
    "sec-ch-ua-mobile": "?0",
    "sec-ch-ua-platform": '"Linux"',
    "sec-fetch-dest": "empty",
    "sec-fetch-mode": "cors",
    "sec-fetch-site": "same-origin",
    "user-agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/126.0.0.0 Safari/537.36",
}

# Вызов функции для получения nonce
# nonce = await Chatgpt4Online.get_nonce(headers)
```

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """Создает асинхронный генератор для отправки запросов и получения ответов от API.

    Args:
        model (str): Модель для использования.
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): Proxy для использования. По умолчанию `None`.

    Yields:
        str: Части ответа от API.
    """
```

**Назначение**: Создание асинхронного генератора для отправки запросов к API `chatgpt4online.org` и получения ответов в реальном времени.

**Параметры**:
- `model` (str): Модель, используемая для генерации ответа.
- `messages` (Messages): Список сообщений, отправляемых в запросе.
- `proxy` (str, optional): Адрес прокси-сервера для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий части ответа от API.

**Как работает функция**:

1. **Формирование заголовков**: Создаются необходимые HTTP-заголовки для запроса, включая User-Agent, Content-Type и другие.
2. **Получение `nonce`**: Вызывается функция `get_nonce` для получения одноразового ключа аутентификации.
3. **Создание асинхронной сессии**: Создается асинхронная сессия с использованием `ClientSession` из библиотеки `aiohttp` с настроенными заголовками.
4. **Форматирование запроса**: Форматируется запрос на основе списка сообщений.
5. **Отправка POST-запроса**: Отправляется POST-запрос к endpoint `/wp-json/mwai-ui/v1/chats/submit` с данными запроса (включая сообщение и идентификатор бота).
6. **Обработка ответа**:
   - Читаются данные из ответа по частям (chunks).
   - Извлекаются JSON-объекты из каждой части.
   - Если тип JSON-объекта `live`, добавляются данные к полному ответу.
   - Если тип JSON-объекта `end`, извлекается окончательный ответ из данных и генератор завершает работу.
7. **Генерация ответа**: Функция является асинхронным генератором и возвращает части ответа по мере их получения.

```ascii
    Формирование заголовков
     ↓
    Получение nonce
     ↓
    Создание асинхронной сессии
     ↓
    Форматирование запроса
     ↓
    Отправка POST-запроса к API
     ↓
    Обработка ответа (по частям)
     ├── JSON type == live → Добавление данных к ответу
     └── JSON type == end  → Извлечение и возврат окончательного ответа
     ↓
    Генерация ответа
```

**Примеры**:

```python
messages = [
    {"role": "user", "content": "Привет, как дела?"}
]

# Пример вызова функции для создания асинхронного генератора
# async_generator = Chatgpt4Online.create_async_generator(model="gpt-4", messages=messages)
# async for part in async_generator:
#     print(part)