# Модуль telegram_webhooks.py

## Обзор

Модуль `telegram_webhooks.py` предназначен для создания и управления Telegram-ботом через сервер FastAPI с использованием RPC (Remote Procedure Call). Он обеспечивает интеграцию бота с Telegram API, обработку входящих сообщений и команд, а также регистрацию вебхуков для получения обновлений от Telegram.

## Подробней

Этот модуль является частью проекта `hypotez` и отвечает за функциональность Telegram-бота. Он использует библиотеку `python-telegram-bot` для взаимодействия с Telegram API и FastAPI для создания веб-сервера, который принимает обновления от Telegram через вебхуки. RPC используется для взаимодействия между различными компонентами системы, такими как регистрация маршрутов и запуск сервера.

## Классы

### `TelegramBot`

**Описание**:
Класс `TelegramBot` представляет собой интерфейс для работы с Telegram-ботом. Он отвечает за инициализацию бота, регистрацию обработчиков команд и сообщений, запуск и остановку бота, а также настройку вебхуков. Класс реализован как Singleton.

**Как работает класс**:

1.  **Инициализация**: При создании экземпляра класса `TelegramBot` происходит инициализация токена бота, маршрута вебхука, конфигурации из файла `telegram.json`, экземпляра `Application` из библиотеки `python-telegram-bot`, а также экземпляра класса `BotHandler`, который содержит обработчики команд и сообщений.
2.  **Регистрация обработчиков**: В методе `_register_default_handlers` регистрируются обработчики для команд `/start`, `/help`, `/sendpdf`, а также обработчики для текстовых сообщений, голосовых сообщений и документов.
3.  **Запуск бота**: Метод `run` запускает бота, инициализирует RPC-клиент, запускает сервер через RPC, регистрирует маршрут вебхука через RPC, настраивает вебхук и запускает приложение.
4.  **Остановка бота**: Метод `stop` останавливает бота и удаляет вебхук.

**Методы**:

*   `__init__(self, token: str, route: str = 'telegram_webhook')`:
    Инициализирует экземпляр класса `TelegramBot`.
*   `run(self)`:
    Запускает бота и инициализирует RPC и вебхук.
*   `_register_default_handlers(self)`:
    Регистрирует обработчики команд и сообщений по умолчанию.
*   `_handle_message(self, update: Update, context: CallbackContext) -> None`:
    Обрабатывает входящие текстовые сообщения.
*   `initialize_bot_webhook(self, route: str)`:
    Инициализирует вебхук для бота.
*   `_register_route_via_rpc(self, rpc_client: ServerProxy)`:
    Регистрирует маршрут вебхука через RPC.
*   `stop(self)`:
    Останавливает бота и удаляет вебхук.

## Функции

### `__init__`

```python
def __init__(self, token: str, route: str = 'telegram_webhook'):
    """
    Инициализирует экземпляр класса `TelegramBot`.

    Args:
        token (str): Токен Telegram-бота.
        route (str): Маршрут вебхука для FastAPI. По умолчанию '/telegram_webhook'.
    """
    ...
```

**Параметры**:

*   `token` (str): Токен Telegram-бота, который используется для аутентификации бота в Telegram API.
*   `route` (str): Маршрут вебхука для FastAPI. Определяет URL, по которому Telegram будет отправлять обновления боту. По умолчанию `/telegram_webhook`.

**Как работает функция**:

1.  Функция сохраняет переданные значения токена и маршрута в атрибуты экземпляра класса `TelegramBot`.
2.  Загружает конфигурацию из файла `telegram.json` с использованием функции `j_loads_ns` и сохраняет ее в атрибуте `config`.
3.  Создает экземпляр `Application` из библиотеки `python-telegram-bot`, используя переданный токен.
4.  Создает экземпляр класса `BotHandler`, который содержит обработчики команд и сообщений.
5.  Вызывает метод `_register_default_handlers` для регистрации обработчиков команд и сообщений по умолчанию.

### `run`

```python
def run(self):
    """
    Запускает бота и инициализирует RPC и вебхук.
    """
    ...
```

**Как работает функция**:

1.  Инициализирует RPC-клиент для взаимодействия с сервером по адресу `http://{gs.host}:9000`.
2.  Вызывает удаленную процедуру `start_server` на сервере через RPC для запуска сервера на порту `self.port` и хосте `gs.host`.
3.  Инициализирует вебхук для получения обновлений от Telegram, вызывая метод `initialize_bot_webhook` и передавая маршрут `self.route`.
4.  Если вебхук успешно инициализирован, регистрирует маршрут через RPC, вызывая метод `_register_route_via_rpc` и передавая RPC-клиент.
5.  Запускает приложение Telegram-бота с использованием вебхука, указывая параметры `listen`, `webhook_url` и `port`.
6.  В случае возникновения исключений в процессе запуска, логирует ошибки и завершает работу программы.
7.  Если не удалось инициализировать вебхук, запускает бота в режиме опроса (polling).

### `_register_default_handlers`

```python
def _register_default_handlers(self):
    """Регистрирует обработчики команд и сообщений по умолчанию, используя экземпляр `BotHandler`."""
    ...
```

**Как работает функция**:

1.  Добавляет обработчик команды `/start`, используя `CommandHandler` и метод `self.handler.start`.
2.  Добавляет обработчик команды `/help`, используя `CommandHandler` и метод `self.handler.help_command`.
3.  Добавляет обработчик команды `/sendpdf`, используя `CommandHandler` и метод `self.handler.send_pdf`.
4.  Добавляет обработчик текстовых сообщений, используя `MessageHandler` и фильтры `filters.TEXT & ~filters.COMMAND`, а также метод `self._handle_message`.
5.  Добавляет обработчик голосовых сообщений, используя `MessageHandler` и фильтр `filters.VOICE`, а также метод `self.handler.handle_voice`.
6.  Добавляет обработчик документов, используя `MessageHandler` и фильтр `filters.Document.ALL`, а также метод `self.handler.handle_document`.
7.  Добавляет обработчик для логирования текстовых сообщений, используя `MessageHandler`, фильтры `filters.TEXT & ~filters.COMMAND` и метод `self.handler.handle_log`.

### `_handle_message`

```python
async def _handle_message(self, update: Update, context: CallbackContext) -> None:
    """Обрабатывает любое текстовое сообщение."""
    ...
```

**Параметры**:

*   `update` (Update): Объект `Update`, представляющий входящее обновление от Telegram.
*   `context` (CallbackContext): Объект `CallbackContext`, содержащий информацию о контексте обработки обновления.

**Как работает функция**:

1.  Вызывает асинхронный метод `self.bot_handler.handle_message`, передавая ему объекты `update` и `context` для обработки текстового сообщения.

### `initialize_bot_webhook`

```python
def initialize_bot_webhook(self, route: str):
    """Инициализирует вебхук для бота."""
    ...
```

**Параметры**:

*   `route` (str): Маршрут вебхука.

**Как работает функция**:

1.  Формирует URL вебхука на основе переданного маршрута и хоста. Если маршрут не начинается с `/`, добавляет `/` в начало.
2.  Если хост указан как `127.0.0.1` или `localhost`, использует `ngrok` для создания туннеля и получения публичного URL.
3.  Устанавливает вебхук для бота, используя метод `self.application.bot.set_webhook` и передавая URL вебхука.
4.  Логирует информацию об успешной установке вебхука.
5.  В случае возникновения исключений, логирует ошибки и возвращает `False`.

### `_register_route_via_rpc`

```python
def _register_route_via_rpc(self, rpc_client: ServerProxy):
    """Регистрирует маршрут вебхука Telegram через RPC."""
    ...
```

**Параметры**:

*   `rpc_client` (ServerProxy): RPC-клиент для взаимодействия с сервером.

**Как работает функция**:

1.  Формирует маршрут, добавляя `/` в начало, если это необходимо.
2.  Вызывает удаленную процедуру `add_new_route` на сервере через RPC, передавая маршрут, обработчик (`self.bot_handler.handle_message`) и метод (`POST`).
3.  Логирует информацию об успешной регистрации маршрута.
4.  В случае возникновения исключений, логирует ошибки.

### `stop`

```python
def stop(self):
    """Останавливает бота и удаляет вебхук."""
    ...
```

**Как работает функция**:

1.  Останавливает приложение Telegram-бота, вызывая метод `self.application.stop()`.
2.  Удаляет вебхук, вызывая метод `self.application.bot.delete_webhook()`.
3.  Логирует информацию об остановке бота.
4.  В случае возникновения исключений, логирует ошибки.