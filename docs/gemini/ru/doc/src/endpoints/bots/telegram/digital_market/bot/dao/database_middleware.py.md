# Модуль `database_middleware.py`

## Обзор

Модуль предоставляет middleware для интеграции базы данных в обработчики `aiogram`. Он содержит базовый класс `BaseDatabaseMiddleware`, а также два его подкласса: `DatabaseMiddlewareWithoutCommit` и `DatabaseMiddlewareWithCommit`, которые определяют, будет ли сессия базы данных автоматически коммититься после обработки запроса.

## Подробней

Этот модуль предназначен для упрощения работы с базой данных в обработчиках `aiogram`. Он предоставляет механизм для создания сессии базы данных, передачи её в обработчик и автоматического закрытия сессии после обработки запроса. В зависимости от выбранного middleware, сессия может быть автоматически закоммичена или нет.

## Классы

### `BaseDatabaseMiddleware`

**Описание**:
Базовый класс middleware для работы с базой данных. Обеспечивает создание, передачу и закрытие сессии базы данных.

**Как работает класс**:
Класс `BaseDatabaseMiddleware` является базовым классом для middleware, которые работают с базой данных. Он реализует метод `__call__`, который вызывается для каждого входящего события (сообщения или callback-запроса). Внутри этого метода создается сессия базы данных, которая передается в обработчик. После обработки запроса сессия закрывается. Класс также предоставляет методы `set_session` и `after_handler`, которые могут быть переопределены в подклассах для настройки поведения middleware.

**Методы**:

- `__call__`:
    ```python
    async def __call__(
            self,
            handler: Callable[[Message | CallbackQuery, Dict[str, Any]], Awaitable[Any]],
            event: Message | CallbackQuery,
            data: Dict[str, Any]
    ) -> Any:
        """
        Выполняет middleware обработку, создавая сессию базы данных, передавая её в обработчик и закрывая сессию после обработки.

        Args:
            handler (Callable[[Message | CallbackQuery, Dict[str, Any]], Awaitable[Any]]):
                Обработчик, который будет вызван после middleware.
            event (Message | CallbackQuery):
                Событие (сообщение или callback-запрос), которое вызвало обработчик.
            data (Dict[str, Any]):
                Словарь данных, который будет передан в обработчик.

        Returns:
            Any:
                Результат выполнения обработчика.
        
        Как работает функция:
        1. Функция `__call__` является точкой входа для middleware. Она принимает обработчик, событие и словарь данных в качестве аргументов.
        2. Создается асинхронная сессия базы данных с использованием `async_session_maker()`.
        3. Вызывается метод `self.set_session(data, session)` для установки сессии в словаре данных.
        4. Вызывается обработчик `handler(event, data)` для обработки события.
        5. После выполнения обработчика вызывается метод `self.after_handler(session)` для выполнения действий после вызова обработчика (например, коммит).
        6. Если в процессе обработки возникает исключение, выполняется откат сессии (`await session.rollback()`) и исключение перебрасывается.
        7. В блоке `finally` сессия закрывается (`await session.close()`).

        Внутри функции происходят следующие действия и преобразования:
        A: Создание асинхронной сессии базы данных.
        |
        -- B: Установка сессии в словаре данных.
        |
        C: Вызов обработчика для обработки события.
        |
        D: Выполнение действий после вызова обработчика (например, коммит).

        """
    ```

- `set_session`:
    ```python
    def set_session(self, data: Dict[str, Any], session) -> None:
        """Метод для установки сессии в словарь данных."""
        raise NotImplementedError("Этот метод должен быть реализован в подклассах.")
    ```

    **Назначение**:
    Устанавливает сессию базы данных в словарь данных, чтобы она была доступна в обработчике.

    **Параметры**:
    - `data` (Dict[str, Any]): Словарь данных, в который будет установлена сессия.
    - `session`: Сессия базы данных, которую нужно установить.

    **Возвращает**:
    - `None`

    **Вызывает исключения**:
    - `NotImplementedError`: Если метод не реализован в подклассе.

     **Как работает функция**:
        Функция `set_session` предназначена для установки сессии базы данных в словарь `data`, чтобы она была доступна обработчикам.
        Поскольку конкретная логика установки сессии зависит от подкласса, в базовом классе метод вызывает исключение `NotImplementedError`,
        чтобы указать на необходимость его переопределения в подклассах.

    **Примеры**:

    Этот метод должен быть реализован в подклассах.

- `after_handler`:
    ```python
    async def after_handler(self, session) -> None:
        """Метод для выполнения действий после вызова хендлера (например, коммит)."""
        pass
    ```

    **Назначение**:
    Выполняет действия после вызова обработчика, например, коммит сессии.

    **Параметры**:
    - `session`: Сессия базы данных, с которой нужно выполнить действия.

    **Возвращает**:
    - `None`

    **Как работает функция**:
        Функция `after_handler` предназначена для выполнения действий после завершения работы обработчика.
        В базовом классе метод ничего не делает (`pass`), но он может быть переопределен в подклассах для выполнения
        специфичных действий, таких как коммит изменений в базе данных.
    
    **Примеры**:

    Этот метод может быть переопределен в подклассах.

### `DatabaseMiddlewareWithoutCommit`

**Описание**:
Middleware для работы с базой данных без автоматического коммита сессии.

**Как работает класс**:
Класс `DatabaseMiddlewareWithoutCommit` является подклассом `BaseDatabaseMiddleware`. Он переопределяет метод `set_session`, чтобы установить сессию базы данных в словаре данных под ключом `'session_without_commit'`. Это позволяет обработчикам получать доступ к сессии базы данных и выполнять операции с ней, но не коммитить изменения автоматически.

**Методы**:

- `set_session`:
    ```python
    def set_session(self, data: Dict[str, Any], session) -> None:
        """Устанавливает сессию базы данных в словарь данных без автоматического коммита."""
        data['session_without_commit'] = session
    ```

    **Назначение**:
    Устанавливает сессию базы данных в словарь данных под ключом `'session_without_commit'`.

    **Параметры**:
    - `data` (Dict[str, Any]): Словарь данных, в который будет установлена сессия.
    - `session`: Сессия базы данных, которую нужно установить.

    **Возвращает**:
    - `None`

    **Как работает функция**:
        Функция `set_session` устанавливает переданную сессию базы данных в словарь `data` под ключом `'session_without_commit'`.
        Это позволяет получить доступ к сессии из обработчика и выполнять операции с базой данных без автоматического коммита.

    **Примеры**:

    ```python
    data = {}
    session = ... # Предположим, что это ваша сессия базы данных
    middleware = DatabaseMiddlewareWithoutCommit()
    middleware.set_session(data, session)
    assert 'session_without_commit' in data
    assert data['session_without_commit'] == session
    ```

### `DatabaseMiddlewareWithCommit`

**Описание**:
Middleware для работы с базой данных с автоматическим коммитом сессии.

**Как работает класс**:
Класс `DatabaseMiddlewareWithCommit` является подклассом `BaseDatabaseMiddleware`. Он переопределяет методы `set_session` и `after_handler`. Метод `set_session` устанавливает сессию базы данных в словаре данных под ключом `'session_with_commit'`. Метод `after_handler` выполняет коммит сессии после обработки запроса.

**Методы**:

- `set_session`:
    ```python
    def set_session(self, data: Dict[str, Any], session) -> None:
        """Устанавливает сессию базы данных в словарь данных с автоматическим коммитом."""
        data['session_with_commit'] = session
    ```

    **Назначение**:
    Устанавливает сессию базы данных в словарь данных под ключом `'session_with_commit'`.

    **Параметры**:
    - `data` (Dict[str, Any]): Словарь данных, в который будет установлена сессия.
    - `session`: Сессия базы данных, которую нужно установить.

    **Возвращает**:
    - `None`

    **Как работает функция**:
        Функция `set_session` устанавливает переданную сессию базы данных в словарь `data` под ключом `'session_with_commit'`.
        Это позволяет получить доступ к сессии из обработчика и выполнять операции с базой данных с автоматическим коммитом.

    **Примеры**:

    ```python
    data = {}
    session = ... # Предположим, что это ваша сессия базы данных
    middleware = DatabaseMiddlewareWithCommit()
    middleware.set_session(data, session)
    assert 'session_with_commit' in data
    assert data['session_with_commit'] == session
    ```

- `after_handler`:
    ```python
    async def after_handler(self, session) -> None:
        """Выполняет коммит сессии после вызова обработчика."""
        await session.commit()
    ```

    **Назначение**:
    Выполняет коммит сессии после вызова обработчика.

    **Параметры**:
    - `session`: Сессия базы данных, которую нужно закоммитить.

    **Возвращает**:
    - `None`

    **Как работает функция**:
        Функция `after_handler` выполняет коммит (сохранение) изменений, внесённых в базу данных в рамках текущей сессии.
        Это гарантирует, что все операции, выполненные во время обработки запроса, будут сохранены в базе данных.

    **Примеры**:

    ```python
    session = ... # Предположим, что это ваша сессия базы данных
    middleware = DatabaseMiddlewareWithCommit()
    await middleware.after_handler(session)
    # Все изменения в сессии будут закоммичены в базу данных
    ```