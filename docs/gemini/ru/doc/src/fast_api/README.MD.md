# FastApi: Singleton для FastAPI с динамическим управлением портами

## Обзор

Класс `FastApi` предоставляет реализацию singleton для FastAPI, позволяя запускать и управлять сервером FastAPI, а также динамически добавлять и останавливать порты во время выполнения.

## Ключевые особенности

*   **Singleton:** Обеспечивает единственный экземпляр приложения FastAPI в вашем приложении.
*   **Динамическое управление портами:** Позволяет запускать сервер на нескольких портах и добавлять и останавливать порты во время выполнения.
*   **Явный запуск и остановка:** Предоставляет методы `start()` и `stop()` для управления сервером на каждом порту.
*   **Асинхронность:** Использует `asyncio` для асинхронного запуска сервера.

## Содержание

- [Обзор](#обзор)
- [Ключевые особенности](#ключевые-особенности)
- [Установка](#установка)
- [Создание экземпляра](#создание-экземпляра)
- [Добавление маршрутов](#добавление-маршрутов)
- [Регистрация роутера](#регистрация-роутера)
- [Запуск сервера на порту](#запуск-сервера-на-порту)
- [Динамическое добавление портов](#динамическое-добавление-портов)
- [Остановка сервера на порту](#остановка-сервера-на-порту)
- [Остановка всех серверов](#остановка-всех-серверов)
- [Настройки](#настройки)
- [Примеры](#примеры)
- [Заключение](#заключение)

## Установка

Для использования класса `FastApi` необходимо установить FastAPI и Uvicorn:

```bash
pip install fastapi uvicorn
```

## Создание экземпляра

Создайте экземпляр класса `FastApi`:

```python
from fastapi import FastAPI as Fapi, APIRouter
import uvicorn
from typing import List, Callable, Dict, Any
import functools
import threading
import asyncio


class FastApi(Fapi):
    _instance = None

    def __new__(cls, *args, **kwargs):
        if cls._instance is None:
            cls._instance = super().__new__(cls, *args, **kwargs)
            cls._instance._initialized = False
            cls._instance.server_tasks = {}  # Словарь для хранения задач (port: task)
            cls._instance.servers = {}  # Словарь для хранения серверов (port: server)
        return cls._instance

    def __init__(self, title: str = "FastAPI Singleton Server", host: str = "127.0.0.1", **kwargs):
        if self._initialized:
            return
        super().__init__(title=title, **kwargs)
        self.router = APIRouter()
        self.host = host
        self._initialized = True
```

### `__init__`

**Описание**: Инициализирует экземпляр класса `FastApi`.

**Параметры**:
*   `title` (str, optional): Заголовок FastAPI приложения. По умолчанию `"FastAPI Singleton Server"`.
*   `host` (str, optional): Хост для запуска сервера. По умолчанию `"127.0.0.1"`.
*   `**kwargs`: Дополнительные именованные аргументы для FastAPI.

**Возвращает**:
*   `None`

### `add_route`

**Описание**: Добавляет маршрут в приложение FastAPI.

**Параметры**:
*   `path` (str): Путь маршрута.
*   `func` (Callable): Функция-обработчик маршрута.
*   `methods` (List[str], optional): Список HTTP методов, поддерживаемых маршрутом. По умолчанию `["GET"]`.
*   `**kwargs`: Дополнительные именованные аргументы для добавления маршрута.

**Возвращает**:
*  `None`

### `register_router`
**Описание**: Регистрирует маршрутизатор в приложении FastAPI.

**Параметры**:
*   `None`

**Возвращает**:
* `None`

### `_start_server`
**Описание**: Запускает сервер Uvicorn на указанном порту.

**Параметры**:
*    `port` (int): Порт, на котором будет запущен сервер.

**Возвращает**:
*    `None`

### `start`

**Описание**: Запускает сервер FastAPI на указанном порту.

**Параметры**:
*   `port` (int): Порт, на котором запускается сервер.

**Возвращает**:
* `None`

### `stop`

**Описание**: Останавливает сервер на указанном порту.

**Параметры**:
*   `port` (int): Порт, на котором нужно остановить сервер.

**Возвращает**:
*   `None`

### `stop_all`

**Описание**: Останавливает все запущенные серверы.

**Параметры**:
*   `None`

**Возвращает**:
*    `None`

### `get_app`

**Описание**: Возвращает экземпляр FastAPI приложения.

**Параметры**:
*   `None`

**Возвращает**:
*   `Fapi`: Экземпляр FastAPI приложения

## Добавление маршрутов

Используйте метод `add_route()` для добавления маршрутов в ваше приложение:

```python
api.add_route("/hello", test_function)
api.add_route("/post", test_post, methods=["POST"])
```
`path`: Путь маршрута.
`func`: Функция-обработчик.
`methods`: Список HTTP методов.
`kwargs`: Дополнительные аргументы.

## Регистрация роутера

Не забудьте зарегистрировать роутер с помощью метода `register_router()`:

```python
api.register_router()
```

## Запуск сервера на порту

Используйте метод `start()` для запуска сервера на определенном порту:

```python
api.start(port=8080)
```
`port`: Порт для запуска.

## Динамическое добавление портов

Вы можете добавлять новые порты для прослушивания в любое время, вызывая `start()` с новым номером порта:

```python
api.start(port=8081)
```

## Остановка сервера на порту

Используйте метод `stop()` для остановки сервера на определенном порту:

```python
await api.stop(port=8080)
```
`port`: Порт для остановки.

## Остановка всех серверов

Используйте метод `stop_all()` для остановки всех работающих серверов:

```python
await api.stop_all()
```

## Настройки

*   **`title`**: Заголовок вашего FastAPI приложения. Устанавливается при создании экземпляра класса.
    ```python
    api = FastApi(title="My API", host="0.0.0.0")
    ```
*   **`host`**: Хост, на котором будет работать сервер. Устанавливается при создании экземпляра класса.
    ```python
        api = FastApi(title="My API", host="0.0.0.0")
    ```
*   **`port`**: Порт, на котором будет запущен сервер. Устанавливается в методе `start`.
    ```python
    api.start(port=8081)
    ```

## Примеры

Примеры использования можно найти в коде выше.

## Заключение

Класс `FastApi` предоставляет мощный и гибкий инструмент для работы с FastAPI, позволяя динамически управлять портами и ресурсами вашего приложения.

Этот `README.md` файл должен дать пользователям хорошее представление о том, как использовать ваш класс `FastApi`. Если у вас есть дополнительные вопросы, я всегда готов помочь!