# Модуль интеграции Google Generative AI

## Обзор

Класс `GoogleGenerativeAI` разработан для облегчения взаимодействия с моделями Google Generative AI. Этот класс предоставляет методы для отправки запросов, обработки ответов, управления диалогами и интеграции с различными функциями AI. Он включает надежную обработку ошибок, ведение журналов и параметры конфигурации для обеспечения бесперебойной работы.

## Подробнее

Этот модуль предоставляет интерфейс для взаимодействия с Google Generative AI моделями, позволяя отправлять запросы, получать ответы и управлять диалогами. Он также включает функции для обработки изображений и загрузки файлов. Модуль обеспечивает журналирование всех взаимодействий и сохранение диалогов для последующего анализа и отладки. Он используется для интеграции AI-функциональности в другие части проекта `hypotez`.

## Основные функции

### `__init__(self, api_key: str, model_name: Optional[str] = None, generation_config: Optional[Dict] = None, system_instruction: Optional[str] = None, **kwargs)`

**Назначение**: Инициализирует класс `GoogleGenerativeAI` с необходимыми конфигурациями.

**Как работает функция**:
- Устанавливает API-ключ, имя модели, конфигурацию генерации и системную инструкцию.
- Определяет пути для логирования диалогов и хранения истории.
- Инициализирует модель Google Generative AI.

**Параметры**:
- `api_key` (str): API-ключ для доступа к Google Generative AI.
- `model_name` (Optional[str], optional): Имя используемой модели. По умолчанию `None`.
- `generation_config` (Optional[Dict], optional): Конфигурация генерации. По умолчанию `None`.
- `system_instruction` (Optional[str], optional): Системная инструкция для модели. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры конфигурации.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `google.auth.exceptions.MutualTLSChannelError`: Если возникла ошибка при аутентификации TLS.
- `google.auth.exceptions.RefreshError`: Если не удалось обновить учетные данные.
- `ValueError`: Если `api_key` не предоставлен.

### `config()`

**Назначение**: Извлекает конфигурацию из файла настроек.

**Как работает функция**:
- Читает и анализирует файл конфигурации, расположенный по адресу `gs.path.src / 'ai' / 'gemini' / 'gemini.json'`.
- Использует `j_loads` для загрузки JSON-конфигурации.

**Параметры**:
- `None`

**Возвращает**:
- `dict`: Словарь с параметрами конфигурации.

**Вызывает исключения**:
- `FileNotFoundError`: Если файл конфигурации не найден.
- `json.JSONDecodeError`: Если файл конфигурации имеет неверный формат JSON.

### `_start_chat(self)`

**Назначение**: Запускает сеанс чата с AI-моделью.

**Как работает функция**:
- Инициализирует сеанс чата с пустой историей.

**Параметры**:
- `None`

**Возвращает**:
- `google.generativeai.generative_models.ChatSession`: Объект сеанса чата.

**Вызывает исключения**:
- `google.generativeai.api_core.exceptions.GoogleAPIError`: Если возникает ошибка при взаимодействии с API Google.

### `_save_dialogue(self, dialogue: list)`

**Назначение**: Сохраняет диалог в текстовый и JSON-файлы.

**Как работает функция**:
- Добавляет каждое сообщение в диалоге в текстовый файл.
- Добавляет каждое сообщение в формате JSON в JSON-файл.
- Использует `logger.info` для логирования сохранения диалога.

**Параметры**:
- `dialogue` (list): Список сообщений в диалоге.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `IOError`: Если возникает ошибка при записи в файл.

### `ask(self, q: str, attempts: int = 15) -> Optional[str]`

**Назначение**: Отправляет текстовый запрос в AI-модель и получает ответ.

**Как работает функция**:
1. **Обработка запроса**:
   - Логирует входящий запрос `q` с использованием `logger.info(f'ask: {q}')`.
2. **Попытки отправки запроса**:
   - Использует цикл `for` для выполнения нескольких попыток (`attempts`) отправки запроса в случае ошибок.
3. **Отправка запроса и обработка ответа**:
   - Пытается отправить запрос `q` в AI-модель с помощью метода `self.model.generate_content(q)`.
   - Извлекает текстовый ответ из сгенерированного контента: `response_text = response.text`.
   - Логирует полученный ответ с использованием `logger.info(f'response_text: {response_text}')`.
   - Сохраняет диалог, добавляя запрос и ответ в историю диалога.
4. **Обработка исключений**:
   - Обрабатывает различные типы исключений, которые могут возникнуть в процессе отправки запроса и получения ответа.
     - `exceptions.QuotaExceeded`: Ошибка превышения квоты. Логирует ошибку и ждет некоторое время перед повторной попыткой.
     - `exceptions.APIError`: Общая ошибка API. Логирует ошибку и прекращает дальнейшие попытки.
     - `exceptions.ServiceUnavailable`: Сервис временно недоступен. Логирует ошибку и повторяет попытку.
     - `exceptions.ModelInputBlockedError`: Входные данные заблокированы моделью. Логирует ошибку и возвращает сообщение об ошибке.
     - `Exception as ex`: Другие исключения. Логирует ошибку с трассировкой стека и повторяет попытку.
5. **Возврат результата**:
   - Если запрос успешно выполнен и получен ответ, возвращает текст ответа.
   - Если все попытки исчерпаны и не удалось получить ответ, возвращает `None`.

**Параметры**:
- `q` (str): Текстовый запрос для отправки в AI-модель.
- `attempts` (int, optional): Количество попыток отправки запроса. По умолчанию 15.

**Возвращает**:
- `Optional[str]`: Текстовый ответ от AI-модели или `None`, если не удалось получить ответ после всех попыток.

**Вызывает исключения**:
- `google.generativeai.api_core.exceptions.GoogleAPIError`: При возникновении ошибки во время взаимодействия с API Google.
- `Exception`: При возникновении других ошибок, таких как сетевые проблемы или проблемы с обработкой данных.

### `chat(self, q: str) -> str`

**Назначение**: Отправляет сообщение в чат AI-модели и получает ответ.

**Как работает функция**:
1. **Логирование запроса**:
   - Логирует входящий запрос `q` с использованием `logger.info(f'chat: {q}')`.
2. **Отправка запроса в чат**:
   - Отправляет запрос `q` в сеанс чата с помощью метода `self.chat_session.send_message(q)`.
3. **Обработка ответа**:
   - Извлекает текстовый ответ из полученного ответа: `response_text = response.text`.
   - Логирует полученный ответ с использованием `logger.info(f'response_text: {response_text}')`.
4. **Обработка исключений**:
   - Обрабатывает исключение `Exception as ex`, которое может возникнуть в процессе отправки запроса и получения ответа.
     - Логирует ошибку с трассировкой стека с использованием `logger.error(ex, exc_info=True)`.
     - Возвращает сообщение об ошибке.
5. **Возврат результата**:
   - Если запрос успешно выполнен и получен ответ, возвращает текст ответа.
   - Если произошла ошибка, возвращает сообщение об ошибке.

**Параметры**:
- `q` (str): Текстовое сообщение для отправки в чат AI-модели.

**Возвращает**:
- `str`: Текстовый ответ от AI-модели или сообщение об ошибке, если произошла ошибка.

**Вызывает исключения**:
- `google.generativeai.api_core.exceptions.GoogleAPIError`: При возникновении ошибки во время взаимодействия с API Google.
- `Exception`: При возникновении других ошибок, таких как сетевые проблемы или проблемы с обработкой данных.

### `describe_image(self, image_path: Path) -> Optional[str]`

**Назначение**: Генерирует текстовое описание изображения.

**Как работает функция**:
1. **Подготовка изображения**:
   - Открывает файл изображения по указанному пути `image_path` в режиме чтения байтов (`'rb'`).
   - Читает содержимое файла и кодирует его в base64.
   - Преобразует закодированное содержимое в строку, чтобы его можно было отправить в AI-модель.
2. **Отправка запроса в AI-модель**:
   - Отправляет запрос с закодированным изображением в AI-модель с помощью метода `self.model.generate_content([image_content])`.
3. **Обработка ответа**:
   - Извлекает текстовое описание из полученного ответа: `response_text = response.text`.
   - Логирует полученный ответ с использованием `logger.info(f'response_text: {response_text}')`.
4. **Обработка исключений**:
   - Обрабатывает исключение `Exception as ex`, которое может возникнуть в процессе отправки запроса и получения ответа.
     - Логирует ошибку с трассировкой стека с использованием `logger.error(ex, exc_info=True)`.
     - Возвращает `None`, если произошла ошибка.
5. **Возврат результата**:
   - Если запрос успешно выполнен и получено описание изображения, возвращает текст описания.
   - Если произошла ошибка, возвращает `None`.

**Параметры**:
- `image_path` (Path): Путь к файлу изображения.

**Возвращает**:
- `Optional[str]`: Текстовое описание изображения или `None`, если произошла ошибка.

**Вызывает исключения**:
- `FileNotFoundError`: Если файл изображения не найден.
- `IOError`: Если возникает ошибка при чтении файла изображения.
- `google.generativeai.api_core.exceptions.GoogleAPIError`: При возникновении ошибки во время взаимодействия с API Google.
- `Exception`: При возникновении других ошибок, таких как сетевые проблемы или проблемы с обработкой данных.

### `upload_file(self, file: str | Path | IOBase, file_name: Optional[str] = None) -> bool`

**Назначение**: Загружает файл в AI-модель.

**Как работает функция**:
1. **Подготовка файла**:
   - Проверяет тип входного параметра `file`:
     - Если `file` является строкой или объектом `Path`, пытается открыть файл по указанному пути в режиме чтения байтов (`'rb'`).
     - Если `file` уже является открытым файловым объектом (`IOBase`), использует его напрямую.
   - Если `file_name` не указан, пытается извлечь имя файла из пути `file`.
2. **Отправка файла в AI-модель**:
   - Вызывает метод `self._upload_file(file_obj, file_name)` для фактической загрузки файла.
3. **Обработка исключений**:
   - Обрабатывает исключение `Exception as ex`, которое может возникнуть в процессе открытия файла.
     - Логирует ошибку с трассировкой стека с использованием `logger.error(ex, exc_info=True)`.
     - Возвращает `False`, если произошла ошибка.
4. **Возврат результата**:
   - Если файл успешно загружен, возвращает `True`.
   - Если произошла ошибка, возвращает `False`.

**Параметры**:
- `file` (str | Path | IOBase): Путь к файлу или открытый файловый объект.
- `file_name` (Optional[str], optional): Имя файла. Если не указано, будет извлечено из пути `file`.

**Возвращает**:
- `bool`: `True`, если файл успешно загружен, `False` в противном случае.

**Вызывает исключения**:
- `FileNotFoundError`: Если файл не найден.
- `IOError`: Если возникает ошибка при чтении файла.
- `google.generativeai.api_core.exceptions.GoogleAPIError`: При возникновении ошибки во время взаимодействия с API Google.
- `Exception`: При возникновении других ошибок, таких как сетевые проблемы или проблемы с обработкой данных.

## Обработка ошибок

Класс включает комплексную обработку ошибок для различных сценариев:

- **Сетевые ошибки**: Повторные попытки с экспоненциальной задержкой.
- **Недоступность сервиса**: Логирование ошибок и повторные попытки.
- **Ограничения квоты**: Логирование и ожидание перед повторной попыткой.
- **Ошибки аутентификации**: Логирование и прекращение дальнейших попыток.
- **Неверный ввод**: Логирование и повторные попытки с таймаутом.
- **Ошибки API**: Логирование и прекращение дальнейших попыток.

## Логирование и история

Все взаимодействия с AI-моделями логируются, а диалоги сохраняются в текстовом и JSON-форматах для будущего анализа. Это гарантирует, что все операции отслеживаются и могут быть просмотрены для отладки или аудита.

## Зависимости

- `google.generativeai`
- `requests`
- `grpc`
- `google.api_core.exceptions`
- `google.auth.exceptions`
- `src.logger`
- `src.utils.printer`
- `src.utils.file`
- `src.utils.date_time`
- `src.utils.convertors.unicode`
- `src.utils.jjson`

## Пример использования

```python
ai = GoogleGenerativeAI(api_key="your_api_key", system_instruction="Instruction")
response = ai.ask("Как дела?")
print(response)
```

Этот пример инициализирует класс `GoogleGenerativeAI` и отправляет запрос в AI-модель, печатая ответ.

---

Для получения более подробной информации обратитесь к исходному коду и комментариям в классе `GoogleGenerativeAI`.