# Модуль промежуточного программного обеспечения для работы с базой данных

## Обзор

Этот модуль предоставляет базовый класс `BaseDatabaseMiddleware` и его подклассы `DatabaseMiddlewareWithoutCommit` и `DatabaseMiddlewareWithCommit` для управления сессиями базы данных при обработке сообщений и callback-запросов в боте Telegram. Он обеспечивает автоматическое создание, передачу и закрытие сессий, а также обработку исключений и коммиты транзакций.

## Подробней

Этот код используется для упрощения работы с базой данных в обработчиках бота. `BaseDatabaseMiddleware` создает сессию, передает ее в обработчик и автоматически закрывает сессию после выполнения обработчика. Подклассы `DatabaseMiddlewareWithoutCommit` и `DatabaseMiddlewareWithCommit` определяют, нужно ли автоматически выполнять коммит транзакции после выполнения обработчика.

## Классы

### `BaseDatabaseMiddleware`

**Описание**: Базовый класс для промежуточного программного обеспечения, управляющего сессиями базы данных.

**Как работает класс**:
1.  При получении события (сообщения или callback-запроса) создает новую асинхронную сессию базы данных с использованием `async_session_maker`.
2.  Устанавливает сессию в словарь данных, передаваемый обработчику. Метод `set_session` должен быть реализован в подклассах.
3.  Вызывает обработчик, передавая ему событие и данные, содержащие сессию.
4.  После вызова обработчика вызывает метод `after_handler` для выполнения дополнительных действий (например, коммита).
5.  В случае возникновения исключения выполняет откат транзакции.
6.  В любом случае закрывает сессию после завершения работы.

**Методы**:

*   `__call__`: Асинхронный метод, вызываемый при обработке события.
*   `set_session`: Метод для установки сессии в словарь данных. Должен быть реализован в подклассах.
*   `after_handler`: Метод для выполнения действий после вызова обработчика (например, коммит).

### `DatabaseMiddlewareWithoutCommit`

**Описание**: Подкласс `BaseDatabaseMiddleware`, который не выполняет автоматический коммит транзакции после вызова обработчика.

**Как работает класс**:

Переопределяет метод `set_session` для установки сессии в словарь данных под ключом `'session_without_commit'`.

**Методы**:

*   `set_session`: Устанавливает сессию в словарь данных под ключом `'session_without_commit'`.

### `DatabaseMiddlewareWithCommit`

**Описание**: Подкласс `BaseDatabaseMiddleware`, который выполняет автоматический коммит транзакции после вызова обработчика.

**Как работает класс**:

Переопределяет метод `set_session` для установки сессии в словарь данных под ключом `'session_with_commit'`.
Переопределяет метод `after_handler` для выполнения коммита транзакции.

**Методы**:

*   `set_session`: Устанавливает сессию в словарь данных под ключом `'session_with_commit'`.
*   `after_handler`: Выполняет коммит транзакции.

## Функции

### `set_session`

```python
def set_session(self, data: Dict[str, Any], session) -> None:
    """Метод для установки сессии в словарь данных."""
    raise NotImplementedError("Этот метод должен быть реализован в подклассах.")
```

**Описание**: Метод для установки сессии в словарь данных.

**Как работает функция**:
Вызывает исключение `NotImplementedError`, указывая, что метод должен быть реализован в подклассах.

**Параметры**:

*   `data` (Dict[str, Any]): Словарь данных, в который необходимо установить сессию.
*   `session`: Сессия базы данных, которую необходимо установить.

**Вызывает исключения**:

*   `NotImplementedError`: Всегда вызывается, так как метод должен быть переопределен в подклассах.

### `after_handler`

```python
async def after_handler(self, session) -> None:
    """Метод для выполнения действий после вызова хендлера (например, коммит)."""
    pass
```

**Описание**: Метод для выполнения действий после вызова обработчика (например, коммит).

**Как работает функция**:

Ничего не делает. Предназначен для переопределения в подклассах.

**Параметры**:

*   `session`: Сессия базы данных.

### `__call__`

```python
async def __call__(
        self,
        handler: Callable[[Message | CallbackQuery, Dict[str, Any]], Awaitable[Any]],
        event: Message | CallbackQuery,
        data: Dict[str, Any]
) -> Any:
    """

    """
```

**Описание**:

**Как работает функция**:
1.  Создает асинхронную сессию базы данных с использованием `async_session_maker`.
2.  Устанавливает сессию в словарь данных `data` с помощью метода `set_session`.
3.  Вызывает обработчик `handler`, передавая ему событие `event` и данные `data`.
4.  После успешного выполнения обработчика вызывает метод `after_handler` для выполнения дополнительных действий (например, коммита).
5.  Если в процессе обработки возникает исключение, выполняет откат транзакции с помощью `await session.rollback()`.
6.  В блоке `finally` закрывает сессию с помощью `await session.close()`.

**Параметры**:

*   `handler` (Callable[[Message | CallbackQuery, Dict[str, Any]], Awaitable[Any]]): Асинхронная функция, которая будет обрабатывать событие.
*   `event` (Message | CallbackQuery): Объект сообщения или CallbackQuery, представляющий событие, которое необходимо обработать.
*   `data` (Dict[str, Any]): Словарь, содержащий дополнительные данные, которые могут потребоваться обработчику.

**Возвращает**:

*   `Any`: Результат выполнения обработчика.

**Вызывает исключения**:

*   `Exception as e`: Перехватывает любые исключения, возникшие в процессе обработки, выполняет откат транзакции и повторно выбрасывает исключение.