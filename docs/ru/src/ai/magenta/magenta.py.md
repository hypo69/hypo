# Модуль magenta.py

## Обзор

Модуль `magenta.py` предоставляет класс `MagentaMusic` для генерации музыки с использованием моделей Magenta. Он позволяет создавать мелодии, добавлять аккорды и барабаны, устанавливать темп и сохранять готовую композицию в MIDI-файл.

## Подробней

Модуль предназначен для интеграции с Google generative AI и моделями Magenta для автоматической генерации музыкальных композиций. Он предоставляет удобный интерфейс для настройки параметров генерации и комбинирования различных элементов музыки.

## Классы

### `MagentaMusic`

**Описание**: Класс `MagentaMusic` предназначен для генерации музыкальных композиций с использованием моделей Magenta.

**Как работает класс**:

Класс инициализируется с параметрами, определяющими выходной каталог, имя модели, температуру, количество шагов, MIDI-файл затравки и темп. Он загружает MIDI-файл затравки или создает пустую NoteSequence, если файл не найден. Методы класса позволяют генерировать мелодию, добавлять аккорды и барабаны, устанавливать темп и сохранять готовую композицию в MIDI-файл.

**Методы**:
- `__init__`: Инициализирует объект `MagentaMusic` с заданными параметрами.
- `_load_primer_sequence`: Загружает MIDI-файл затравки или создает пустую NoteSequence, если файл не найден.
- `generate_melody`: Генерирует мелодию с заданными параметрами.
- `add_chords`: Добавляет аккорды к мелодии.
- `add_drums`: Добавляет барабаны к мелодии.
- `set_tempo`: Устанавливает темп.
- `save_midi`: Сохраняет готовую композицию в MIDI-файл.
- `generate_full_music`: Объединяет все шаги в один вызов для удобства.

#### `__init__`

```python
def __init__(self, output_dir='generated_music_advanced', model_name='attention_rnn', temperature=1.2,
                 num_steps=256, primer_midi_file='primer.mid', tempo=100):
```

**Назначение**: Инициализирует объект `MagentaMusic` с заданными параметрами.

**Как работает метод**:
1. Устанавливает значения атрибутов объекта на основе переданных аргументов.
2. Создает выходной каталог, если он не существует.
3. Инициализирует генератор мелодий `MelodyRnnSequenceGenerator` с указанной моделью.
4. Загружает MIDI-файл затравки или создает пустую мелодию, используя метод `_load_primer_sequence`.

**Параметры**:
- `output_dir` (str): Выходной каталог для сохранения сгенерированной музыки. По умолчанию `'generated_music_advanced'`.
- `model_name` (str): Имя модели для генерации мелодии. По умолчанию `'attention_rnn'`.
- `temperature` (float): Температура для генерации мелодии. По умолчанию `1.2`.
- `num_steps` (int): Количество шагов для генерации мелодии. По умолчанию `256`.
- `primer_midi_file` (str): Путь к MIDI-файлу затравки. По умолчанию `'primer.mid'`.
- `tempo` (int): Темп композиции в ударах в минуту. По умолчанию `100`.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `OSError`: Если не удается создать выходной каталог.

#### `_load_primer_sequence`

```python
def _load_primer_sequence(self):
```

**Назначение**: Загружает MIDI-файл затравки или создает пустую NoteSequence, если файл не найден.

**Как работает метод**:
1. Проверяет, существует ли файл, указанный в `self.primer_midi_file`.
2. Если файл существует, он преобразуется в объект `NoteSequence` с использованием `mm.midi_file_to_sequence_proto`.
3. Если файл не существует, создается пустая `NoteSequence`.

**Параметры**:
- `None`

**Возвращает**:
- `mm.NoteSequence`: Объект `NoteSequence`, представляющий MIDI-файл затравки или пустую мелодию.

#### `generate_melody`

```python
def generate_melody(self):
```

**Назначение**: Генерирует мелодию с заданными параметрами.

**Как работает метод**:
1. Использует `self.melody_rnn.generate` для генерации мелодии на основе установленных параметров, таких как температура, количество шагов и затравка.

**Параметры**:
- `None`

**Возвращает**:
- `mm.NoteSequence`: Объект `NoteSequence`, представляющий сгенерированную мелодию.

#### `add_chords`

```python
def add_chords(self, melody_sequence):
```

**Назначение**: Добавляет аккорды к мелодии.

**Как работает метод**:
1. Создает список аккордов, который повторяется в зависимости от количества шагов.
2. Преобразует список аккордов в объект `ChordSequence`.
3. Объединяет мелодию и аккорды в одну последовательность с использованием `mm.sequences_lib.concatenate_sequences`.

**Параметры**:
- `melody_sequence` (mm.NoteSequence): Объект `NoteSequence`, представляющий мелодию.

**Возвращает**:
- `mm.NoteSequence`: Объект `NoteSequence`, представляющий мелодию с добавленными аккордами.

#### `add_drums`

```python
def add_drums(self, melody_with_chords_sequence):
```

**Назначение**: Добавляет барабаны к мелодии.

**Как работает метод**:
1. Создает паттерн ударных, представляющий собой последовательность MIDI-нот для барабанов.
2. Создает объект `DrumTrack` на основе этого паттерна.
3. Объединяет мелодию с аккордами и барабанами в одну последовательность с использованием `mm.sequences_lib.concatenate_sequences`.

**Параметры**:
- `melody_with_chords_sequence` (mm.NoteSequence): Объект `NoteSequence`, представляющий мелодию с аккордами.

**Возвращает**:
- `mm.NoteSequence`: Объект `NoteSequence`, представляющий мелодию с аккордами и барабанами.

#### `set_tempo`

```python
def set_tempo(self, music_sequence):
```

**Назначение**: Устанавливает темп.

**Как работает метод**:
1. Устанавливает темп для музыкальной последовательности, изменяя атрибут `qpm` первого элемента в списке `music_sequence.tempos`.

**Параметры**:
- `music_sequence` (mm.NoteSequence): Объект `NoteSequence`, представляющий музыкальную последовательность.

**Возвращает**:
- `mm.NoteSequence`: Объект `NoteSequence` с установленным темпом.

#### `save_midi`

```python
def save_midi(self, music_sequence, filename='full_music_advanced.mid'):
```

**Назначение**: Сохраняет готовую композицию в MIDI-файл.

**Как работает метод**:
1. Формирует путь к MIDI-файлу на основе выходного каталога и имени файла.
2. Преобразует музыкальную последовательность в MIDI-файл с использованием `mm.sequence_proto_to_midi_file`.

**Параметры**:
- `music_sequence` (mm.NoteSequence): Объект `NoteSequence`, представляющий музыкальную последовательность.
- `filename` (str): Имя файла для сохранения MIDI-композиции. По умолчанию `'full_music_advanced.mid'`.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `OSError`: Если не удается сохранить MIDI-файл.

#### `generate_full_music`

```python
def generate_full_music(self):
```

**Назначение**: Объединяет все шаги в один вызов для удобства.

**Как работает метод**:
1. Вызывает методы для генерации мелодии, добавления аккордов, добавления барабанов и установки темпа.
2. Сохраняет готовую композицию в MIDI-файл.

**Параметры**:
- `None`

**Возвращает**:
- `None`

## Функции

### `__main__`

```python
if __name__ == '__main__':
```

**Назначение**: Пример использования класса `MagentaMusic`.

**Как работает функция**:
1. Создает два экземпляра класса `MagentaMusic` с разными параметрами.
2. Вызывает метод `generate_full_music` для каждого экземпляра, чтобы сгенерировать и сохранить музыкальные композиции.

**Параметры**:
- `None`

**Возвращает**:
- `None`