# Модуль `Theb`

## Обзор

Модуль `Theb` предоставляет интерфейс для взаимодействия с различными моделями, предоставляемыми сервисом [TheB.AI](https://beta.theb.ai). Он позволяет отправлять запросы к моделям и получать ответы, используя веб-драйвер для автоматизации взаимодействия с веб-сайтом.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для интеграции с различными AI-моделями через веб-интерфейс TheB.AI. Он автоматизирует процесс отправки запросов и получения ответов, что позволяет использовать эти модели в программных решениях.
Этот код предназначен для работы с веб-сайтом TheB.AI и использует WebDriver для эмуляции действий пользователя в браузере. Он содержит функции для отправки запросов к различным моделям и получения ответов.

## Классы

### `Theb(AbstractProvider)`

**Описание**: Класс `Theb` предоставляет методы для взаимодействия с моделями TheB.AI.

**Наследует**:
- `AbstractProvider`: `Theb` наследует от `AbstractProvider`, который, вероятно, предоставляет базовый интерфейс для взаимодействия с различными провайдерами моделей.

**Атрибуты**:
- `label` (str): Метка, идентифицирующая провайдера как "TheB.AI".
- `url` (str): URL веб-сайта TheB.AI.
- `working` (bool): Указывает, работает ли провайдер в данный момент (в данном случае `False`).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных (в данном случае `True`).
- `models` (dict): Список поддерживаемых моделей, полученный из `models.keys()`.

**Методы**:
- `create_completion(model: str, messages: Messages, stream: bool, proxy: str = None, webdriver: WebDriver = None, virtual_display: bool = True, **kwargs) -> CreateResult`: Метод для создания запроса к модели и получения ответа.

## Функции

### `create_completion`

```python
@classmethod
def create_completion(
    cls,
    model: str,
    messages: Messages,
    stream: bool,
    proxy: str = None,
    webdriver: WebDriver = None,
    virtual_display: bool = True,
    **kwargs
) -> CreateResult:
    """
    Создает запрос к модели и получает ответ.

    Args:
        model (str): Название модели для использования.
        messages (Messages): Список сообщений для отправки модели.
        stream (bool): Указывает, следует ли использовать потоковую передачу данных.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        webdriver (WebDriver, optional): Экземпляр веб-драйвера для управления браузером. По умолчанию `None`.
        virtual_display (bool, optional): Указывает, следует ли использовать виртуальный дисплей. По умолчанию `True`.
        **kwargs: Дополнительные аргументы.

    Returns:
        CreateResult: Результат выполнения запроса.

    Raises:
        Exception: Если происходит ошибка во время выполнения запроса.
    """
```

**Назначение**:
Функция `create_completion` отправляет запрос к указанной модели через веб-интерфейс TheB.AI и возвращает ответ. Она использует `selenium` для автоматизации действий в браузере, таких как ввод текста, выбор модели и чтение ответа.

**Параметры**:
- `model` (str): Название модели, которую необходимо использовать для генерации ответа.
- `messages` (Messages): Список сообщений, которые будут отправлены модели в качестве запроса.
- `stream` (bool): Флаг, указывающий, следует ли использовать потоковый режим для получения ответа.
- `proxy` (str, optional): Адрес прокси-сервера, который будет использоваться для подключения к TheB.AI. По умолчанию `None`.
- `webdriver` (WebDriver, optional): Экземпляр веб-драйвера, используемый для управления браузером. По умолчанию `None`.
- `virtual_display` (bool, optional): Флаг, указывающий, следует ли использовать виртуальный дисплей для запуска браузера. По умолчанию `True`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в функцию.

**Возвращает**:
- `CreateResult`: Результат выполнения запроса. Тип `CreateResult` определяется в модуле `...typing`.

**Вызывает исключения**:
- `Exception`: Может выбрасывать различные исключения в случае ошибок при взаимодействии с веб-сайтом TheB.AI или при выполнении JavaScript-кода в браузере.

**Как работает функция**:

1. **Преобразование имени модели**: Если `model` находится в словаре `models`, то её значение заменяется на соответствующее значение из словаря. `model = models[model]`
2. **Форматирование запроса**: Форматирует список сообщений `messages` в строку `prompt`, пригодную для отправки в модель.
3. **Создание веб-сессии**: Инициализирует веб-сессию с использованием `WebDriver` и опциональным прокси.
4. **Настройка перехвата `fetch`**: Внедряет JavaScript-код в браузер для перехвата запросов к `/api/conversation` и чтения потока данных из ответа.
5. **Навигация на сайт**: Открывает главную страницу TheB.AI (`cls.url/home`) и ожидает загрузки элемента `textareaAutosize`.
6. **Выбор модели (если указана)**: Кликает на элемент выбора модели и выбирает указанную модель из списка.
7. **Отправка запроса**: Вводит отформатированный запрос `prompt` в поле `textareaAutosize`.
8. **Чтение ответа**: Использует JavaScript-код для чтения потока данных из ответа и извлекает содержимое каждого чанка.
9. **Генерация чанков ответа**: Возвращает содержимое каждого чанка ответа с использованием `yield`.

**Внутренние функции**:
Внутри функции `create_completion` используется несколько анонимных JavaScript-функций, которые выполняются в контексте браузера через `driver.execute_script`. Эти функции отвечают за перехват сетевых запросов, чтение потока данных и извлечение полезной информации из ответов сервера.

```ascii
A: Преобразование имени модели
|
B: Форматирование запроса
|
C: Создание веб-сессии
|
D: Настройка перехвата fetch
|
E: Навигация на сайт
|
F: Выбор модели (если указана)
|
G: Отправка запроса
|
H: Чтение ответа --> I: Генерация чанков ответа
```

**Примеры**:

```python
# Пример использования функции create_completion
from selenium import webdriver
from src.endpoints.gpt4free.g4f.Provider.not_working.Theb import Theb
from src.webdirver import Driver, Firefox
from typing import List, Dict

# Инициализация веб-драйвера
driver = Driver(Firefox).get_driver()

# Определение параметров запроса
model: str = "gpt-3.5-turbo"
messages: List[Dict[str, str]] = [{"role": "user", "content": "Hello, world!"}]
stream: bool = True

# Вызов функции create_completion
result = Theb.create_completion(
    model=model,
    messages=messages,
    stream=stream,
    webdriver=driver,
    virtual_display=False
)

# Обработка результата
if stream:
    for chunk in result:
        print(chunk, end="")
else:
    print(result)

# Закрытие веб-драйвера
driver.quit()
```

Этот пример показывает, как использовать функцию `create_completion` для отправки запроса к модели "gpt-3.5-turbo" с сообщением "Hello, world!". Результат выводится на экран по частям, если включен потоковый режим, или целиком, если потоковый режим выключен. В конце работы веб-драйвер закрывается.