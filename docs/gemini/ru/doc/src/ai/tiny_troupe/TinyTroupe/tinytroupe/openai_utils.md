# Модуль openai_utils

## Обзор

Этот модуль предоставляет классы и функции для взаимодействия с API OpenAI, включая кеширование API-вызовов и обработку различных ошибок. Он поддерживает как стандартный OpenAI API, так и Azure OpenAI Service API.  Модуль позволяет настраивать параметры вызовов, такие как модель, максимальное количество токенов и т.д., используя конфигурационный файл `config.ini`.


## Оглавление

- [Модуль openai_utils](#модуль-openai_utils)
- [Обзор](#обзор)
- [Функции](#функции)
    - [`default`](#default)
    - [`LLMCall`](#llmcall)
        - [`__init__`](#__init__)
        - [`call`](#call)
        - [`__repr__`](#__repr__)
- [Класс `OpenAIClient`](#класс-openaiclient)
    - [`__init__`](#__init_-1)
    - [`set_api_cache`](#set_api_cache)
    - [`_setup_from_config`](#_setup_from_config)
    - [`send_message`](#send_message)
        - [`aux_exponential_backoff`](#aux_exponential_backoff)
        - [`_raw_model_call`](#_raw_model_call)
        - [`_raw_model_response_extractor`](#_raw_model_response_extractor)
        - [`_count_tokens`](#_count_tokens)
    - [`_save_cache`](#_save_cache)
    - [`_load_cache`](#_load_cache)
    - [`get_embedding`](#get_embedding)
        - [`_raw_embedding_model_call`](#_raw_embedding_model_call)
        - [`_raw_embedding_model_response_extractor`](#_raw_embedding_model_response_extractor)
- [Класс `AzureClient`](#класс-azureclient)
    - [`__init__`](#__init_-2)
    - [`_setup_from_config`](#_setup_from_config-1)
    - [`_raw_model_call`](#_raw_model_call-1)
- [Исключения](#исключения)
    - [`InvalidRequestError`](#invalidrequestexception)
    - [`NonTerminalError`](#nonterminalerror)
- [Регистрация и получение клиентов](#регистрация-и-получение-клиентов)
    - [`register_client`](#register_client)
    - [`_get_client_for_api_type`](#_get_client_for_api_type)
    - [`client`](#client)
- [Дополнительные функции](#дополнительные-функции)
    - [`force_api_type`](#force_api_type)
    - [`force_api_cache`](#force_api_cache)
    - [`force_default_value`](#force_default_value)


## Функции

### `default`

**Описание**: Словарь с настройками по умолчанию для модели OpenAI.


### `LLMCall`

**Описание**: Класс для вызовов моделей LLM. Содержит входные сообщения, конфигурацию модели и выход модели.

#### `__init__`

**Описание**: Инициализирует экземпляр `LLMCall` с указанными шаблонами для системных и пользовательских сообщений.

**Параметры**:
- `system_template_name` (str): Имя шаблона для системного сообщения.
- `user_template_name` (str, optional): Имя шаблона для пользовательского сообщения. По умолчанию `None`.
- `**model_params`: (Ключевые параметры): Дополнительные параметры модели.


#### `call`

**Описание**: Вызывает модель LLM с указанными конфигурациями рендеринга.

**Параметры**:
- `**rendering_configs` (Ключевые параметры): Дополнительные параметры рендеринга.

**Возвращает**:
- `str | None`: Текст ответа модели или `None` при ошибке.


#### `__repr__`

**Описание**: Возвращает строковое представление объекта `LLMCall`.


## Класс `OpenAIClient`

**Описание**: Утилитарный класс для взаимодействия с API OpenAI.

#### `__init__`

**Описание**: Инициализирует экземпляр `OpenAIClient`.

**Параметры**:
- `cache_api_calls` (bool, optional): Флаг, указывающий на необходимость кеширования вызовов API. По умолчанию значение из `default`.
- `cache_file_name` (str, optional): Имя файла для кеширования вызовов API. По умолчанию значение из `default`.


#### `set_api_cache`

**Описание**: Устанавливает параметры кеширования API-вызовов.

**Параметры**:
- `cache_api_calls` (bool): Флаг, указывающий на необходимость кеширования API-вызовов.
- `cache_file_name` (str): Имя файла для кеширования API-вызовов.



#### `_setup_from_config`

**Описание**: Настраивает конфигурацию OpenAI API для данного клиента.


#### `send_message`

**Описание**: Отправляет сообщение в API OpenAI и возвращает ответ.

**Параметры**:
(см. код для полного списка параметров)

**Возвращает**:
- `dict | None`: Словарь с ответом модели или `None` при ошибке.

#### `_raw_model_call`

**Описание**: Вызывает API OpenAI с заданными параметрами. Подклассы должны переопределить этот метод для реализации собственных вызовов API.

#### `_raw_model_response_extractor`

**Описание**: Извлекает ответ из ответа API. Подклассы должны переопределить этот метод для реализации собственной обработки ответа.

#### `_count_tokens`

**Описание**: Подсчитывает количество токенов OpenAI в списке сообщений с помощью tiktoken.


#### `_save_cache`

**Описание**: Сохраняет кэш API-вызовов в файл.

#### `_load_cache`

**Описание**: Загружает кэш API-вызовов из файла.

#### `get_embedding`

**Описание**: Получает вложение заданного текста, используя указанную модель.

**Параметры**:
- `text` (str): Текст для вложения.
- `model` (str, optional): Название модели для вложения текста. По умолчанию значение из `default`.

**Возвращает**:
- `list`: Вложение текста.



## Исключение


### `InvalidRequestError`

**Описание**: Исключение, возникающее при недопустимом запросе к API OpenAI.

### `NonTerminalError`

**Описание**: Исключение, возникающее при неопределённой ошибке, но мы знаем, что можно повторить попытку.


## Регистрация и получение клиентов

### `register_client`

**Описание**: Регистрирует клиента для указанного типа API.


### `_get_client_for_api_type`

**Описание**: Возвращает клиента для указанного типа API.


### `client`

**Описание**: Возвращает клиент для настроенного типа API.


## Дополнительные функции

### `force_api_type`

**Описание**: Принудительно использует заданный тип API, тем самым переопределяя любую другую конфигурацию.

### `force_api_cache`

**Описание**: Принудительно использует заданную конфигурацию кэша API, тем самым переопределяя любую другую конфигурацию.

### `force_default_value`

**Описание**: Принудительно использует заданное значение конфигурации по умолчанию для указанного ключа, тем самым переопределяя любую другую конфигурацию.