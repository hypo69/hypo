# Модуль для конвертации изображений в формат PNG

## Обзор

Модуль `png.py` предоставляет инструменты для работы с изображениями, в частности, для конвертации текста в PNG-изображения и наложения одного PNG-изображения на другое. Он включает класс `TextToImageGenerator` для генерации PNG-изображений из текста с различными опциями настройки внешнего вида, а также функцию `webp2png` для конвертации изображений из формата WEBP в формат PNG.

## Подробней

Этот модуль предназначен для автоматического создания изображений на основе текстовых данных, что может быть полезно для создания превью, водяных знаков или других графических элементов. Модуль использует библиотеку Pillow для работы с изображениями и предоставляет гибкие настройки для управления внешним видом генерируемых изображений.

## Классы

### `TextToImageGenerator`

**Описание**: Класс `TextToImageGenerator` предназначен для генерации PNG-изображений из текстовых строк.

**Принцип работы**:
Класс инициализируется с настройками по умолчанию, такими как каталог вывода, размер холста, отступы, цвета фона и текста, а также уровень логирования. Он предоставляет метод `generate_images` для генерации изображений на основе списка текстовых строк, а также методы для настройки параметров изображения, таких как шрифт, размер холста и цвета.

**Аттрибуты**:
- `default_output_dir` (Path): Путь к директории вывода по умолчанию ("./output").
- `default_canvas_size` (Tuple[int, int]): Размер холста по умолчанию (1024, 1024).
- `default_padding` (float): Отступ от края холста по умолчанию (0.10).
- `default_background` (str): Цвет фона по умолчанию ("white").
- `default_text_color` (str): Цвет текста по умолчанию ("black").
- `default_log_level` (str): Уровень логирования по умолчанию ("WARNING").

**Методы**:
- `__init__`: Инициализирует класс `TextToImageGenerator` с настройками по умолчанию.
- `generate_images`: Генерирует PNG-изображения из предоставленных текстовых строк.
- `generate_png`: Создает PNG-изображение с указанным текстом, шрифтом и цветами.
- `center_text_position`: Вычисляет позицию для центрирования текста на холсте.
- `overlay_images`: Накладывает одно PNG-изображение на другое в указанной позиции.

### `__init__`
**Описание**: Инициализирует класс `TextToImageGenerator` с настройками по умолчанию.

**Как работает функция**:
1. Устанавливает значения по умолчанию для атрибутов класса, таких как каталог вывода, размер холста, отступы, цвета фона и текста, а также уровень логирования.

**Примеры**:
```python
generator = TextToImageGenerator()
print(generator.default_output_dir) # "./output"
```

### `generate_images`

```python
async def generate_images(
    self,
    lines: List[str],
    output_dir: str | Path = None,
    font: str | ImageFont.ImageFont = "sans-serif",
    canvas_size: Tuple[int, int] = None,
    padding: float = None,
    background_color: str = None,
    text_color: str = None,
    log_level: int | str | bool = None,
    clobber: bool = False,
) -> List[Path]:
    """
    Генерирует PNG-изображения из предоставленных текстовых строк.

    Args:
        lines (List[str]): Список строк с текстом для генерации изображений.
        output_dir (str | Path, optional): Директория для сохранения изображений. По умолчанию "./output".
        font (str | ImageFont.ImageFont, optional): Шрифт для текста. По умолчанию "sans-serif".
        canvas_size (Tuple[int, int], optional): Размер холста в пикселях. По умолчанию (1024, 1024).
        padding (float, optional): Отступ от края холста в процентах. По умолчанию 0.10.
        background_color (str, optional): Цвет фона изображений. По умолчанию "white".
        text_color (str, optional): Цвет текста. По умолчанию "black".
        log_level (int | str | bool, optional): Уровень логирования. По умолчанию "WARNING".
        clobber (bool, optional): Если True, перезаписывает существующие файлы. По умолчанию False.

    Returns:
        List[Path]: Список путей к сгенерированным PNG-изображениям.

    Example:
        >>> generator = TextToImageGenerator()
        >>> lines = ["Text 1", "Text 2", "Text 3"]
        >>> output_dir = "./output"
        >>> images = await generator.generate_images(lines, output_dir=output_dir)
        >>> print(images)
        [PosixPath(\'./output/Text 1.png\'), PosixPath(\'./output/Text 2.png\'), PosixPath(\'./output/Text 3.png\')]
    """
```

**Назначение**: Генерация PNG-изображений из списка текстовых строк с возможностью настройки параметров изображения.

**Параметры**:
- `lines` (List[str]): Список строк с текстом для генерации изображений.
- `output_dir` (str | Path, optional): Директория для сохранения изображений. По умолчанию "./output".
- `font` (str | ImageFont.ImageFont, optional): Шрифт для текста. По умолчанию "sans-serif".
- `canvas_size` (Tuple[int, int], optional): Размер холста в пикселях. По умолчанию (1024, 1024).
- `padding` (float, optional): Отступ от края холста в процентах. По умолчанию 0.10.
- `background_color` (str, optional): Цвет фона изображений. По умолчанию "white".
- `text_color` (str, optional): Цвет текста. По умолчанию "black".
- `log_level` (int | str | bool, optional): Уровень логирования. По умолчанию "WARNING".
- `clobber` (bool, optional): Если True, перезаписывает существующие файлы. По умолчанию False.

**Возвращает**:
- `List[Path]`: Список путей к сгенерированным PNG-изображениям.

**Как работает функция**:

1. **Инициализация**:
   - Определяет директорию вывода, используя предоставленный параметр `output_dir` или значение по умолчанию из атрибута `default_output_dir`.
   - Настраивает логирование, вызывая метод `setup_logging` с уровнем логирования, указанным в параметре `log_level`.
   - Если параметры `canvas_size` или `padding` не указаны, использует значения по умолчанию из атрибутов `default_canvas_size` и `default_padding` соответственно.

2. **Обработка каждой строки**:
   - Перебирает каждую строку текста в списке `lines`.
   - Формирует путь к файлу изображения, добавляя расширение ".png" к каждой строке и помещая его в директорию вывода.
   - Проверяет, существует ли файл изображения и нужно ли его перезаписывать в соответствии с параметром `clobber`. Если файл существует и перезапись не разрешена, пропускает текущую строку и переходит к следующей.

3. **Генерация и сохранение изображения**:
   - Генерирует PNG-изображение, вызывая метод `generate_png` с текущей строкой текста и параметрами изображения.
   - Сохраняет сгенерированное изображение в файл, используя путь, сформированный на предыдущем шаге.
   - Добавляет путь к сгенерированному изображению в список `generated_images`.

4. **Завершение**:
   - После обработки всех строк возвращает список путей к сгенерированным изображениям.

```
 A (Определение параметров)
 |
 -- B (Обработка каждой строки)
 |  |
 |  -- C (Проверка существования файла)
 |  |  |
 |  |  -- D (Генерация PNG)
 |  |  |
 |  |  -- E (Сохранение PNG)
 |  |
 |
 -- F (Возврат списка путей)
```
Где:
- `A`: Определение параметров и установка значений по умолчанию.
- `B`: Цикл по каждой строке текста.
- `C`: Проверка существования файла и необходимости его перезаписи.
- `D`: Генерация PNG-изображения с использованием метода `generate_png`.
- `E`: Сохранение сгенерированного изображения в файл.
- `F`: Возврат списка путей к сгенерированным изображениям.

**Примеры**:
```python
generator = TextToImageGenerator()
lines = ["Text 1", "Text 2", "Text 3"]
output_dir = "./output"
images = await generator.generate_images(lines, output_dir=output_dir)
print(images)
# [PosixPath('./output/Text 1.png'), PosixPath('./output/Text 2.png'), PosixPath('./output/Text 3.png')]
```

### `generate_png`

```python
def generate_png(
    self,
    text: str,
    canvas_size: Tuple[int, int],
    padding: float,
    background_color: str,
    text_color: str,
    font: str | ImageFont.ImageFont,
) -> Image:
    """
    Создает PNG-изображение с указанным текстом, шрифтом и цветами.

    Args:
        text (str): Текст для отображения на изображении.
        canvas_size (Tuple[int, int]): Размер холста в пикселях.
        padding (float): Отступ от края холста в процентах.
        background_color (str): Цвет фона изображения.
        text_color (str): Цвет текста.
        font (str | ImageFont.ImageFont): Шрифт для текста.

    Returns:
        Image: Сгенерированное PNG-изображение.
    """
```

**Назначение**: Создание PNG-изображения с заданным текстом, шрифтом и цветами.

**Параметры**:
- `text` (str): Текст для отображения на изображении.
- `canvas_size` (Tuple[int, int]): Размер холста в пикселях.
- `padding` (float): Отступ от края холста в процентах.
- `background_color` (str): Цвет фона изображения.
- `text_color` (str): Цвет текста.
- `font` (str | ImageFont.ImageFont): Шрифт для текста.

**Возвращает**:
- `Image`: Сгенерированное PNG-изображение.

**Как работает функция**:
1. **Создание изображения**:
   - Создает новое изображение в формате RGB с заданным размером холста и цветом фона.

2. **Настройка рисования**:
   - Создает объект `ImageDraw` для рисования на изображении.
   - Определяет размер шрифта, вызывая метод `get_font_size` с размером холста и отступом.
   - Загружает шрифт, используя `ImageFont.truetype` с указанным шрифтом и размером.

3. **Определение позиции текста**:
   - Вычисляет позицию для центрирования текста на холсте, вызывая метод `center_text_position` с объектом `ImageDraw`, текстом, шрифтом и размером холста.

4. **Отрисовка текста**:
   - Рисует текст на изображении в вычисленной позиции, используя указанный цвет текста и шрифт.

5. **Завершение**:
   - Возвращает сгенерированное изображение.

```
A (Создание изображения)
|
-- B (Настройка рисования)
|  |
|  -- C (Определение позиции текста)
|
-- D (Отрисовка текста)
|
-- E (Возврат изображения)
```

Где:
- `A`: Создание нового изображения с заданным размером и цветом фона.
- `B`: Настройка рисования, включая определение размера шрифта и загрузку шрифта.
- `C`: Вычисление позиции для центрирования текста на холсте.
- `D`: Отрисовка текста на изображении.
- `E`: Возврат сгенерированного изображения.

**Примеры**:
```python
generator = TextToImageGenerator()
text = "Example Text"
canvas_size = (512, 512)
padding = 0.05
background_color = "lightblue"
text_color = "darkblue"
font = "arial.ttf"
image = generator.generate_png(text, canvas_size, padding, background_color, text_color, font)
image.save("example.png")
```

### `center_text_position`

```python
def center_text_position(
    self, draw: ImageDraw.Draw, text: str, font: ImageFont.ImageFont, canvas_size: Tuple[int, int]
) -> Tuple[int, int]:
    """
    Вычисляет позицию для центрирования текста на холсте.

    Args:
        draw (ImageDraw.Draw): Объект ImageDraw.
        text (str): Текст для отображения.
        font (ImageFont.ImageFont): Используемый шрифт.
        canvas_size (Tuple[int, int]): Размер холста в пикселях.

    Returns:
        Tuple[int, int]: Координаты для центрирования текста.
    """
```

**Назначение**: Вычисление координат для центрирования текста на холсте.

**Параметры**:
- `draw` (ImageDraw.Draw): Объект `ImageDraw` для измерения размера текста.
- `text` (str): Текст, который нужно центрировать.
- `font` (ImageFont.ImageFont): Шрифт, используемый для текста.
- `canvas_size` (Tuple[int, int]): Размер холста в пикселях.

**Возвращает**:
- `Tuple[int, int]`: Кортеж, содержащий координаты (x, y) для центрирования текста.

**Как работает функция**:

1. **Измерение размера текста**:
   - Вычисляет ширину и высоту текста с использованием метода `textsize` объекта `ImageDraw`.

2. **Вычисление позиции**:
   - Вычисляет позицию для центрирования текста по горизонтали и вертикали, вычитая ширину и высоту текста из размера холста и деля результат на 2.

3. **Завершение**:
   - Возвращает кортеж с координатами (x, y) для центрирования текста.

```
A (Измерение размера текста)
|
-- B (Вычисление позиции)
|
-- C (Возврат координат)
```

Где:
- `A`: Измерение ширины и высоты текста с использованием `draw.textsize()`.
- `B`: Вычисление координат для центрирования текста на основе размера холста и размера текста.
- `C`: Возврат вычисленных координат.

**Примеры**:
```python
from PIL import Image, ImageDraw, ImageFont

# Пример использования
img = Image.new('RGB', (500, 300), color='white')
draw = ImageDraw.Draw(img)
font = ImageFont.truetype("arial.ttf", size=24)
text = "Hello, World!"

generator = TextToImageGenerator()
x, y = generator.center_text_position(draw, text, font, (500, 300))

draw.text((x, y), text, font=font, fill='black')
img.save('centered_text.png')
```

### `overlay_images`

```python
def overlay_images(
    self,
    background_path: str | Path,
    overlay_path: str | Path,
    position: tuple[int, int] = (0, 0),
    alpha: float = 1.0,
) -> Image:
    """Накладывает одно PNG-изображение на другое в указанной позиции.

    Args:
        background_path (str | Path): Путь к фоновому PNG-изображению.
        overlay_path (str | Path): Путь к накладываемому PNG-изображению.
        position (tuple[int, int], optional): Координаты (x, y), где будет размещено накладываемое изображение. По умолчанию (0, 0).
        alpha (float, optional): Уровень прозрачности накладываемого изображения (0.0 - 1.0). По умолчанию 1.0.

    Returns:
        Image: Результирующее изображение с наложенным изображением.

    Example:
        >>> result_image = overlay_images("background.png", "overlay.png", position=(50, 50), alpha=0.8)
        >>> result_image.save("result.png")
    """
```

**Назначение**: Наложение одного PNG-изображения на другое с возможностью указания позиции и прозрачности.

**Параметры**:
- `background_path` (str | Path): Путь к фоновому изображению.
- `overlay_path` (str | Path): Путь к накладываемому изображению.
- `position` (tuple[int, int], optional): Координаты (x, y) для размещения накладываемого изображения. По умолчанию (0, 0).
- `alpha` (float, optional): Уровень прозрачности накладываемого изображения (0.0 - 1.0). По умолчанию 1.0.

**Возвращает**:
- `Image`: Результирующее изображение с наложенным изображением.

**Как работает функция**:
1. **Открытие изображений**:
   - Открывает фоновое и накладываемое изображения с использованием `Image.open`.
   - Преобразует оба изображения в формат RGBA для поддержки прозрачности.

2. **Изменение размера накладываемого изображения**:
   - Если размеры накладываемого изображения не совпадают с размерами фонового изображения, изменяет размер накладываемого изображения с использованием `overlay.resize`.

3. **Настройка прозрачности**:
   - Копирует накладываемое изображение и устанавливает уровень прозрачности с использованием `overlay.putalpha`.

4. **Накладывание изображения**:
   - Накладывает накладываемое изображение на фоновое изображение с использованием `background.paste`.

5. **Завершение**:
   - Возвращает результирующее изображение.

```
A (Открытие изображений)
|
-- B (Изменение размера)
|
-- C (Настройка прозрачности)
|
-- D (Накладывание изображения)
|
-- E (Возврат результата)
```

Где:
- `A`: Открытие фонового и накладываемого изображений.
- `B`: Изменение размера накладываемого изображения, если необходимо.
- `C`: Настройка прозрачности накладываемого изображения.
- `D`: Наложение накладываемого изображения на фоновое изображение.
- `E`: Возврат результирующего изображения.

**Примеры**:
```python
from PIL import Image
from pathlib import Path

# Предполагается, что background.png и overlay.png существуют в текущей директории
background_path = "background.png"
overlay_path = "overlay.png"

# Создаем тестовые изображения, если их нет
if not Path(background_path).exists():
    Image.new("RGB", (500, 500), "white").save(background_path)
if not Path(overlay_path).exists():
    Image.new("RGBA", (200, 200), (0, 0, 0, 128)).save(overlay_path)

generator = TextToImageGenerator()
result_image = generator.overlay_images(background_path, overlay_path, position=(50, 50), alpha=0.8)
result_image.save("result.png")
```

## Функции

### `webp2png`

```python
def webp2png(webp_path: str, png_path: str) -> bool:
    """
    Конвертирует изображение из формата WEBP в формат PNG.

    Args:
        webp_path (str): Путь к входному файлу WEBP.
        png_path (str): Путь для сохранения сконвертированного файла PNG.

    Example:
        webp2png(\'image.webp\', \'image.png\')
    """
```

**Назначение**: Конвертация изображения из формата WEBP в формат PNG.

**Параметры**:
- `webp_path` (str): Путь к входному файлу WEBP.
- `png_path` (str): Путь для сохранения сконвертированного файла PNG.

**Как работает функция**:
1. **Открытие WEBP-изображения**:
   - Открывает WEBP-изображение с использованием `Image.open`.

2. **Конвертация и сохранение**:
   - Конвертирует изображение в формат PNG и сохраняет его по указанному пути с использованием `img.save`.

3. **Обработка исключений**:
   - Перехватывает возможные исключения в процессе конвертации и выводит сообщение об ошибке.

4. **Завершение**:
   - Возвращает `True`, если конвертация прошла успешно, и `None` в случае ошибки.

```
A (Открытие WEBP-изображения)
|
-- B (Конвертация и сохранение)
|
-- C (Обработка исключений)
|
-- D (Возврат результата)
```

Где:
- `A`: Открытие WEBP-изображения с использованием `Image.open`.
- `B`: Конвертация изображения в формат PNG и сохранение его по указанному пути.
- `C`: Обработка исключений, которые могут возникнуть в процессе конвертации.
- `D`: Возврат `True` в случае успеха и `None` в случае ошибки.

**Примеры**:
```python
from PIL import Image

# Создаем тестовый файл WEBP (если его нет)
test_webp_path = "test.webp"
test_png_path = "test.png"

# Создаем простое изображение и сохраняем его как WEBP
if not Path(test_webp_path).exists():
    test_image = Image.new("RGB", (100, 100), color="red")
    test_image.save(test_webp_path, "WEBP")

# Пример использования функции webp2png
result = webp2png(test_webp_path, test_png_path)
print(f"Conversion successful: {result}")  # Выведет: Conversion successful: True