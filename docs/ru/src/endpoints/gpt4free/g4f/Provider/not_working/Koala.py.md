# Модуль `Koala`

## Обзор

Модуль `Koala` предоставляет асинхронный интерфейс для взаимодействия с API Koala.sh, который позволяет генерировать текст на основе предоставленных сообщений, используя различные модели, такие как `gpt-4o-mini`. Он включает в себя функции для создания асинхронного генератора, отправки запросов к API и обработки потока событий для получения результатов.

## Подробней

Модуль `Koala` предназначен для интеграции с другими частями проекта `hypotez`, требующими функциональности чат-ботов или генерации текста на основе моделей. Он использует `aiohttp` для асинхронных HTTP-запросов и предоставляет удобный интерфейс для отправки сообщений и получения ответов. Модуль поддерживает прокси и использует случайные идентификаторы для каждого посетителя.

## Классы

### `Koala`

**Описание**: Класс `Koala` является асинхронным провайдером, реализующим взаимодействие с API Koala.sh. Он наследует функциональность от `AsyncGeneratorProvider` и `ProviderModelMixin`.

**Наследует**:
- `AsyncGeneratorProvider`: Предоставляет базовую функциональность для асинхронных провайдеров, генерирующих данные.
- `ProviderModelMixin`: Добавляет поддержку выбора модели.

**Атрибуты**:
- `url` (str): URL Koala.sh.
- `api_endpoint` (str): URL API Koala.sh.
- `working` (bool): Флаг, указывающий, работает ли провайдер.
- `supports_message_history` (bool): Флаг, указывающий, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`gpt-4o-mini`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от API Koala.
- `_parse_event_stream`: Разбирает поток событий, возвращаемый API.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: Optional[str] = None,
    connector: Optional[BaseConnector] = None,
    **kwargs: Any
) -> AsyncGenerator[Dict[str, Union[str, int, float, List[Dict[str, Any]], None]], None]:
    """
    Создает асинхронный генератор для получения ответов от API Koala.

    Args:
        model (str): Модель для использования.
        messages (Messages): Список сообщений для отправки.
        proxy (Optional[str], optional): Прокси-сервер для использования. По умолчанию `None`.
        connector (Optional[BaseConnector], optional): Кастомный коннектор `aiohttp`. По умолчанию `None`.
        **kwargs (Any): Дополнительные аргументы.

    Returns:
        AsyncGenerator[Dict[str, Union[str, int, float, List[Dict[str, Any]], None]], None]: Асинхронный генератор, возвращающий словарь с ответом.

    Raises:
        Exception: Если возникает ошибка при отправке запроса или обработке ответа.
    """
    ...
```

**Назначение**: Создает асинхронный генератор, который отправляет сообщения в API Koala.sh и возвращает результаты по мере их поступления.

**Параметры**:
- `cls`: Ссылка на класс `Koala`.
- `model` (str): Модель для использования при генерации ответа.
- `messages` (Messages): Список сообщений, отправляемых в API.
- `proxy` (Optional[str], optional): Прокси-сервер для использования. По умолчанию `None`.
- `connector` (Optional[BaseConnector], optional): Пользовательский коннектор `aiohttp`. По умолчанию `None`.
- `**kwargs (Any)`: Дополнительные параметры, которые могут быть переданы.

**Возвращает**:
- `AsyncGenerator[Dict[str, Union[str, int, float, List[Dict[str, Any]], None]], None]`: Асинхронный генератор, возвращающий словарь с результатами.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при отправке запроса или обработке ответа.

**Как работает функция**:

1. **Подготовка заголовков**: Функция устанавливает заголовки запроса, включая `User-Agent`, `Accept`, `Referer` и другие необходимые параметры. Заголовки используются для имитации запроса от браузера.
2. **Создание сессии `aiohttp`**: Создается асинхронная сессия `aiohttp` с использованием предоставленных заголовков и прокси (если указан).
3. **Формирование данных запроса**: Функция извлекает текст из последнего сообщения пользователя и объединяет его с системными сообщениями, если они есть. Затем формируются данные для отправки в API, включая историю сообщений пользователя и ответы ассистента.
4. **Отправка запроса**: Функция отправляет POST-запрос к API Koala.sh с сформированными данными.
5. **Обработка потока событий**: Функция вызывает `_parse_event_stream` для обработки потока событий, возвращаемого API, и генерирует результаты по мере их поступления.

```
create_async_generator
│
├─── Подготовка_заголовков
│
├─── Создание_сессии_aiohttp
│
├─── Формирование_данных_запроса
│   │
│   ├─── Извлечение_текста_из_последнего_сообщения
│   │
│   └─── Объединение_с_системными_сообщениями
│
├─── Отправка_POST_запроса
│
└─── Обработка_потока_событий через _parse_event_stream
```

**Примеры**:

```python
# Пример вызова функции create_async_generator
messages = [
    {"role": "user", "content": "Привет, как дела?"},
    {"role": "assistant", "content": "Привет! У меня все хорошо, спасибо!"},
    {"role": "user", "content": "Расскажи мне о Python."}
]
async def test():
    generator = await Koala.create_async_generator(model="gpt-4o-mini", messages=messages)
    async for chunk in generator:
        print(chunk)
```

### `_parse_event_stream`

```python
@staticmethod
async def _parse_event_stream(response: ClientResponse) -> AsyncGenerator[Dict[str, Any], None]:
    """
    Разбирает поток событий, возвращаемый API.

    Args:
        response (ClientResponse): Объект ответа `aiohttp`.

    Yields:
        Dict[str, Any]: Словарь с данными из потока событий.
    """
    ...
```

**Назначение**: Разбирает поток событий, возвращаемый API Koala.sh, и извлекает данные из каждого чанка.

**Параметры**:
- `response` (ClientResponse): Объект ответа `aiohttp`, содержащий поток событий.

**Возвращает**:
- `AsyncGenerator[Dict[str, Any], None]`: Асинхронный генератор, возвращающий словарь с данными из потока событий.

**Как работает функция**:

1. **Итерация по чанкам**: Функция асинхронно итерирует по чанкам в содержимом ответа.
2. **Проверка префикса**: Для каждого чанка проверяется, начинается ли он с префикса `b"data: "`.
3. **Извлечение данных**: Если префикс совпадает, функция извлекает данные, удаляет префикс и преобразует JSON-строку в словарь.
4. **Генерация результата**: Функция генерирует полученный словарь.

```
_parse_event_stream
│
├─── Итерация_по_чанкам
│
├─── Проверка_префикса
│
└─── Извлечение_данных_и_генерация_результата
```

**Примеры**:

```python
# Пример использования функции _parse_event_stream
import aiohttp
async def test():
    async with aiohttp.ClientSession() as session:
        async with session.get("https://example.com/stream") as response:
            async for chunk in Koala._parse_event_stream(response):
                print(chunk)