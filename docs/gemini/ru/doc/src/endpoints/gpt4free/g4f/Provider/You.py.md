# Модуль `You.py`

## Обзор

Модуль предоставляет асинхронный класс `You` для взаимодействия с API You.com, позволяющий генерировать текст и изображения с использованием различных моделей, включая `gpt-4o-mini`, `dall-e` и другие. Поддерживает потоковую передачу данных, загрузку изображений и настройку параметров чата.

## Подробней

Этот модуль является частью проекта `hypotez` и предназначен для интеграции с сервисом You.com. Он обеспечивает асинхронное взаимодействие с API You.com для генерации текста и изображений, используя различные модели. Модуль поддерживает потоковую передачу данных, загрузку изображений и настройку параметров чата. Для работы с API требуется наличие актуальных cookies, которые могут быть получены автоматически или переданы в явном виде.

## Классы

### `You`

**Описание**: Класс `You` является асинхронным провайдером и реализует методы для взаимодействия с API You.com. Он позволяет генерировать текст и изображения с использованием различных моделей.

**Принцип работы**:
Класс использует асинхронные запросы для взаимодействия с API You.com. Он поддерживает потоковую передачу данных, загрузку изображений и настройку параметров чата. Для работы с API требуется наличие актуальных cookies, которые могут быть получены автоматически или переданы в явном виде.

**Методы**:

- `create_async_generator`: Создает асинхронный генератор для получения ответов от API You.com.
- `upload_file`: Загружает файл изображения на сервер You.com.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    stream: bool = True,
    image: ImageType = None,
    image_name: str = None,
    proxy: str = None,
    timeout: int = 240,
    chat_mode: str = "default",
    cookies: Cookies = None,
    **kwargs,
) -> AsyncResult:
    """Создает асинхронный генератор для получения ответов от API You.com.

    Args:
        cls (Type[You]): Класс `You`.
        model (str): Название модели для использования.
        messages (Messages): Список сообщений для отправки.
        stream (bool, optional): Флаг, указывающий, использовать ли потоковую передачу данных. По умолчанию `True`.
        image (ImageType, optional): Изображение для отправки. По умолчанию `None`.
        image_name (str, optional): Имя файла изображения. По умолчанию `None`.
        proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
        timeout (int, optional): Время ожидания ответа в секундах. По умолчанию `240`.
        chat_mode (str, optional): Режим чата. По умолчанию `"default"`.
        cookies (Cookies, optional): Cookies для отправки. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор для получения ответов от API.

    Raises:
        MissingRequirementsError: Если не удалось получить cookies.
        ResponseError: Если API вернул ошибку.

    Как работает функция:
    1. Определяет режим чата в зависимости от наличия изображения и выбранной модели.
    2. Если cookies не предоставлены и режим чата не `"default"`, пытается получить их из домена `.you.com`. Если не удается, запускает браузер для получения cookies.
    3. Создает асинхронную сессию с использованием `StreamSession`.
    4. Если предоставлено изображение, загружает его на сервер You.com с помощью метода `upload_file`.
    5. Формирует заголовки и данные для запроса к API.
    6. Отправляет GET-запрос к API You.com с использованием потоковой передачи данных.
    7. Обрабатывает ответы от API, извлекая данные из событий `youChatUpdate` и `youChatToken`.
    8. В случае ошибок поднимает исключение `ResponseError`.
    
    Внутри функции происходят следующие действия и преобразования:
        A. Определение режима чата: `chat_mode` определяется в зависимости от наличия изображения и выбранной модели.
        B. Получение cookies: Если cookies не предоставлены, функция пытается получить их автоматически.
        C. Создание асинхронной сессии: Создается сессия для выполнения запросов к API.
        D. Загрузка изображения (если есть): Изображение загружается на сервер You.com.
        E. Формирование данных запроса: Подготавливаются данные для отправки в API, включая сообщения, режим чата и модель.
        F. Отправка запроса и обработка ответов: Отправляется запрос к API и обрабатываются полученные данные, включая извлечение текста и изображений.

    Примеры:
        >>> model = "gpt-4o-mini"
        >>> messages = [{"role": "user", "content": "Hello, how are you?"}]
        >>> async for message in You.create_async_generator(model=model, messages=messages):
        ...     print(message)

        >>> model = "dall-e"
        >>> messages = [{"role": "user", "content": "Create an image of a cat."}]
        >>> async for message in You.create_async_generator(model=model, messages=messages):
        ...     print(message)
    """
    ...
```

### `upload_file`

```python
@classmethod
async def upload_file(cls, client: StreamSession, cookies: Cookies, file: bytes, filename: str = None) -> dict:
    """Загружает файл изображения на сервер You.com.

    Args:
        cls (Type[You]): Класс `You`.
        client (StreamSession): Асинхронная сессия для выполнения запросов.
        cookies (Cookies): Cookies для отправки.
        file (bytes): Байтовое представление файла.
        filename (str, optional): Имя файла. По умолчанию `None`.

    Returns:
        dict: Словарь с информацией о загруженном файле.

    Raises:
        ResponseError: Если API вернул ошибку.

    Как работает функция:
        1. Получает nonce (одноразовый токен) для загрузки файла с сервера You.com.
        2. Формирует данные формы для загрузки файла, включая сам файл, тип контента и имя файла.
        3. Отправляет POST-запрос на сервер You.com для загрузки файла.
        4. Обрабатывает ответ от API, извлекая информацию о загруженном файле.
        5. Добавляет в результат информацию о имени файла и размере файла.

    Внутри функции происходят следующие действия и преобразования:
        A. Получение nonce: Запрашивается nonce для загрузки файла.
        B. Формирование данных формы: Подготавливаются данные для отправки файла, включая тип контента и имя файла.
        C. Отправка запроса: Отправляется POST-запрос на сервер You.com для загрузки файла.
        D. Обработка ответа: Обрабатывается ответ от API, извлекая информацию о загруженном файле, и добавляется информация о размере и имени файла.

    Примеры:
        >>> import aiohttp
        >>> cookies = {"afUserId": "some_user_id"}
        >>> file_path = "image.png"
        >>> with open(file_path, "rb") as f:
        ...     file_bytes = f.read()
        >>> async with aiohttp.ClientSession() as session:
        ...     result = await You.upload_file(session, cookies, file_bytes, file_path)
        ...     print(result)
        {'file_id': '...', 'filename': 'image.png', 'size': 12345}
    """
    ...