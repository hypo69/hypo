# Модуль для конвертации HTML в Markdown
## Обзор

Модуль `html2text.py` предназначен для преобразования HTML-документов в Markdown-форматированный текст. Он обеспечивает читаемость контента, извлеченного из HTML, путем удаления избыточных тегов и сохранения структуры текста.

## Подробней

Этот модуль полезен для извлечения текстового контента из веб-страниц или HTML-документов и представления его в формате Markdown, который легко читается и может быть использован для дальнейшей обработки или отображения. Модуль обрабатывает различные HTML-элементы, стили и сущности, чтобы создать максимально точное представление текста в формате Markdown.

## Содержание

- [Основные принципы](#основные-принципы)
- [Функции](#функции)
- [Классы](#классы)

## Основные принципы

Модуль `html2text` использует следующие основные принципы:

- Преобразование HTML-тегов в соответствующие Markdown-эквиваленты.
- Обработка HTML-сущностей для правильного отображения специальных символов.
- Поддержка различных стилей текста, таких как выделение жирным шрифтом, курсив и зачеркивание.
- Игнорирование или преобразование ссылок и изображений в зависимости от настроек.
- Поддержка списков, таблиц и других структурированных элементов HTML.

## Функции

### `has_key(x, y)`

```python
def has_key(x, y):
    """Проверяет, содержит ли объект `x` ключ `y`.

    Args:
        x: Объект, который нужно проверить (например, словарь).
        y: Ключ, наличие которого нужно проверить в объекте `x`.

    Returns:
        bool: `True`, если объект `x` содержит ключ `y`, и `False` в противном случае.
    """
```

**Как работает функция**:
Функция `has_key` проверяет, содержит ли объект `x` ключ `y`. Она работает как для объектов, у которых есть метод `has_key`, так и для объектов, поддерживающих оператор `in`.

### `name2cp(k)`

```python
def name2cp(k):
    """Преобразует имя HTML-сущности в её кодовую точку Unicode.

    Args:
        k (str): Имя HTML-сущности (например, 'apos').

    Returns:
        int: Кодовая точка Unicode для данной сущности.

    Raises:
        KeyError: Если сущность не найдена в таблице `htmlentitydefs`.
    """
```

**Как работает функция**:
Функция `name2cp` преобразует имя HTML-сущности в её кодовую точку Unicode. Сначала она проверяет, является ли сущность апострофом (`'`). Затем, если доступен атрибут `name2codepoint` в модуле `htmlentitydefs`, она использует его для преобразования. В противном случае она использует `entitydefs` и пытается преобразовать сущность в кодовую точку.

### `charref(name)`

```python
def charref(name):
    """Преобразует символьную ссылку (character reference) в символ Unicode.

    Args:
        name (str): Символьная ссылка, которая может быть в десятичном или шестнадцатеричном формате.

    Returns:
        str: Соответствующий символ Unicode.

    """
```

**Как работает функция**:
Функция `charref` преобразует символьную ссылку (например, `&#123;` или `&#x7B;`) в соответствующий символ Unicode. Сначала она определяет, является ли ссылка шестнадцатеричной или десятичной. Затем она преобразует ссылку в целое число и возвращает соответствующий символ Unicode.

### `entityref(c)`

```python
def entityref(c):
    """Преобразует ссылку на HTML-сущность в символ Unicode.

    Args:
        c (str): Строка, представляющая ссылку на HTML-сущность (например, 'nbsp').

    Returns:
        str: Соответствующий символ Unicode или исходная строка, если преобразование невозможно.
    """
```

**Как работает функция**:
Функция `entityref` преобразует ссылку на HTML-сущность (например, `&nbsp;`) в соответствующий символ Unicode. Если `UNICODE_SNOB` не установлен и сущность есть в `unifiable`, возвращается соответствующее значение из `unifiable`. В противном случае функция пытается преобразовать сущность в кодовую точку Unicode и вернуть соответствующий символ.

### `replaceEntities(s)`

```python
def replaceEntities(s):
    """Заменяет HTML-сущности в строке на соответствующие символы.

    Args:
        s (re.Match): Объект Match, содержащий HTML-сущность.

    Returns:
        str: Соответствующий символ Unicode.
    """
```

**Как работает функция**:
Функция `replaceEntities` извлекает HTML-сущность из объекта `Match` и заменяет её на соответствующий символ Unicode, используя функции `charref` и `entityref`.

### `unescape(s)`

```python
def unescape(s):
    """Удаляет HTML-сущности из строки.

    Args:
        s (str): Строка, содержащая HTML-сущности.

    Returns:
        str: Строка без HTML-сущностей.
    """
```

**Как работает функция**:
Функция `unescape` удаляет HTML-сущности из строки, используя регулярное выражение `r_unescape` и функцию `replaceEntities` для замены каждой сущности на соответствующий символ.

### `onlywhite(line)`

```python
def onlywhite(line):
    """Проверяет, состоит ли строка только из пробельных символов.

    Args:
        line (str): Строка для проверки.

    Returns:
        bool: `True`, если строка состоит только из пробельных символов, и `False` в противном случае.
    """
```

**Как работает функция**:
Функция `onlywhite` проверяет, состоит ли строка только из пробельных символов. Она возвращает `True`, если все символы в строке являются пробелами, и `False` в противном случае.

### `optwrap(text)`

```python
def optwrap(text):
    """Оборачивает текст по заданной ширине.

    Args:
        text (str): Текст для оборачивания.

    Returns:
        str: Обернутый текст.
    """
```

**Как работает функция**:
Функция `optwrap` оборачивает текст по заданной ширине `BODY_WIDTH`. Она разбивает текст на параграфы и оборачивает каждый параграф, если он не начинается с пробела, дефиса или звездочки.

### `hn(tag)`

```python
def hn(tag):
    """Определяет уровень заголовка HTML-тега.

    Args:
        tag (str): HTML-тег для проверки.

    Returns:
        int | None: Уровень заголовка (1-9), если тег является заголовком, иначе `None`.
    """
```

**Как работает функция**:
Функция `hn` определяет уровень заголовка HTML-тега. Она проверяет, начинается ли тег с `h` и имеет ли длину 2. Если это так, она пытается преобразовать второй символ тега в целое число и возвращает его, если оно находится в диапазоне от 1 до 9.

### `dumb_property_dict(style)`

```python
def dumb_property_dict(style):
    """Преобразует строку CSS-стилей в словарь атрибутов.

    Args:
        style (str): Строка CSS-стилей.

    Returns:
        dict: Словарь CSS-атрибутов, где ключи - это имена атрибутов, а значения - их значения.
    """
```

**Как работает функция**:
Функция `dumb_property_dict` преобразует строку CSS-стилей в словарь атрибутов. Она разбивает строку на пары атрибут-значение и создает словарь, где ключи - это имена атрибутов, а значения - их значения.

### `dumb_css_parser(data)`

```python
def dumb_css_parser(data):
    """Разбирает CSS-данные и возвращает словарь селекторов и их атрибутов.

    Args:
        data (str): Строка CSS-данных.

    Returns:
        dict: Словарь CSS-селекторов, где ключи - это селекторы, а значения - словари CSS-атрибутов.
    """
```

**Как работает функция**:
Функция `dumb_css_parser` разбирает CSS-данные и возвращает словарь селекторов и их атрибутов. Она удаляет `@import` предложения, разбивает данные на селекторы и атрибуты и создает словарь, где ключи - это селекторы, а значения - словари CSS-атрибутов.

### `element_style(attrs, style_def, parent_style)`

```python
def element_style(attrs, style_def, parent_style):
    """Определяет итоговый стиль элемента на основе атрибутов, стилей CSS и стилей родительского элемента.

    Args:
        attrs (dict): Атрибуты элемента.
        style_def (dict): Определения стилей CSS.
        parent_style (dict): Стили родительского элемента.

    Returns:
        dict: Итоговый стиль элемента.
    """
```

**Как работает функция**:
Функция `element_style` определяет итоговый стиль элемента на основе атрибутов, стилей CSS и стилей родительского элемента. Она копирует стили родительского элемента, обновляет их стилями из атрибута `class` элемента и стилями из атрибута `style` элемента.

### `google_list_style(style)`

```python
def google_list_style(style):
    """Определяет, является ли список упорядоченным или неупорядоченным на основе CSS-стилей Google Docs.

    Args:
        style (dict): Словарь CSS-стилей.

    Returns:
        str: 'ul', если список неупорядоченный, и 'ol', если список упорядоченный.
    """
```

**Как работает функция**:
Функция `google_list_style` определяет, является ли список упорядоченным или неупорядоченным на основе CSS-стилей Google Docs. Она проверяет наличие атрибута `list-style-type` в стилях и возвращает `'ul'`, если значение этого атрибута равно `'disc'`, `'circle'`, `'square'` или `'none'`, и `'ol'` в противном случае.

### `google_nest_count(style)`

```python
def google_nest_count(style):
    """Вычисляет уровень вложенности списка Google Docs на основе CSS-стилей.

    Args:
        style (dict): Словарь CSS-стилей.

    Returns:
        int: Уровень вложенности списка.
    """
```

**Как работает функция**:
Функция `google_nest_count` вычисляет уровень вложенности списка Google Docs на основе CSS-стилей. Она проверяет наличие атрибута `margin-left` в стилях и возвращает значение этого атрибута, деленное на `GOOGLE_LIST_INDENT`.

### `google_has_height(style)`

```python
def google_has_height(style):
    """Проверяет, определен ли атрибут 'height' в CSS-стилях элемента Google Docs.

    Args:
        style (dict): Словарь CSS-стилей.

    Returns:
        bool: `True`, если атрибут 'height' определен, и `False` в противном случае.
    """
```

**Как работает функция**:
Функция `google_has_height` проверяет, определен ли атрибут `'height'` в CSS-стилях элемента Google Docs.

### `google_text_emphasis(style)`

```python
def google_text_emphasis(style):
    """Определяет типы выделения текста на основе CSS-стилей Google Docs.

    Args:
        style (dict): Словарь CSS-стилей.

    Returns:
        list: Список строк, представляющих типы выделения текста (например, 'text-decoration', 'font-style', 'font-weight').
    """
```

**Как работает функция**:
Функция `google_text_emphasis` определяет типы выделения текста на основе CSS-стилей Google Docs. Она проверяет наличие атрибутов `text-decoration`, `font-style` и `font-weight` в стилях и возвращает список строк, представляющих типы выделения текста.

### `google_fixed_width_font(style)`

```python
def google_fixed_width_font(style):
    """Проверяет, используется ли шрифт фиксированной ширины в CSS-стилях Google Docs.

    Args:
        style (dict): Словарь CSS-стилей.

    Returns:
        bool: `True`, если используется шрифт фиксированной ширины, и `False` в противном случае.
    """
```

**Как работает функция**:
Функция `google_fixed_width_font` проверяет, используется ли шрифт фиксированной ширины в CSS-стилях Google Docs. Она проверяет наличие атрибута `font-family` в стилях и возвращает `True`, если значение этого атрибута равно `'Courier New'` или `'Consolas'`.

### `list_numbering_start(attrs)`

```python
def list_numbering_start(attrs):
    """Извлекает начальное значение нумерации из атрибутов элемента списка.

    Args:
        attrs (dict): Атрибуты элемента списка.

    Returns:
        int: Начальное значение нумерации (на 1 меньше значения атрибута 'start') или 0, если атрибут 'start' отсутствует.
    """
```

**Как работает функция**:
Функция `list_numbering_start` извлекает начальное значение нумерации из атрибутов элемента списка. Она проверяет наличие атрибута `start` в атрибутах и возвращает значение этого атрибута, преобразованное в целое число и уменьшенное на 1, или 0, если атрибут `start` отсутствует.

### `html2text_file(html, out=wrapwrite, baseurl='')`

```python
def html2text_file(html, out=wrapwrite, baseurl=''):
    """Преобразует HTML-код в текст, используя указанный метод вывода и базовый URL.

    Args:
        html (str): HTML-код для преобразования.
        out (callable, optional): Функция для вывода преобразованного текста. По умолчанию `wrapwrite`.
        baseurl (str, optional): Базовый URL для разрешения относительных ссылок. По умолчанию ''.

    Returns:
        str: Преобразованный текст.
    """
```

**Как работает функция**:
Функция `html2text_file` создает экземпляр класса `_html2text`, передает ему HTML-код для обработки и возвращает преобразованный текст.

### `html2text(html, baseurl='')`

```python
def html2text(html, baseurl=''):
    """Преобразует HTML в Markdown-текст с возможностью указания базового URL.

    Args:
        html (str): HTML-код для преобразования.
        baseurl (str, optional): Базовый URL для разрешения относительных ссылок. По умолчанию ''.

    Returns:
        str: Markdown-текст, полученный из HTML.
    """
```

**Как работает функция**:
Функция `html2text` преобразует HTML в Markdown-текст, используя функции `html2text_file` и `optwrap` для оборачивания текста по заданной ширине.

### `wrapwrite(text)`

```python
def wrapwrite(text):
    """Выводит текст в стандартный поток вывода, кодируя его в UTF-8.

    Args:
        text (str): Текст для вывода.
    """
```

**Как работает функция**:
Функция `wrapwrite` выводит текст в стандартный поток вывода, кодируя его в UTF-8. Она пытается использовать `sys.stdout.buffer.write` для Python 3 и `sys.stdout.write` для Python 2.

## Классы

### `_html2text(HTMLParser.HTMLParser)`

```python
class _html2text(HTMLParser.HTMLParser):
    """Преобразует HTML в удобочитаемый текст.

    Args:
        out (callable, optional): Функция для вывода преобразованного текста. По умолчанию `self.outtextf`.
        baseurl (str, optional): Базовый URL для разрешения относительных ссылок. По умолчанию ''.
    """
    def __init__(self, out=None, baseurl=''):
        """Инициализирует объект класса _html2text.

        Args:
            out (callable, optional): Функция для вывода преобразованного текста. По умолчанию `self.outtextf`.
            baseurl (str, optional): Базовый URL для разрешения относительных ссылок. По умолчанию ''.
        """

    def feed(self, data):
        """Обрабатывает данные HTML, заменяя небезопасные теги <script>.

        Args:
            data (str): HTML-код для обработки.
        """

    def outtextf(self, s):
        """Добавляет текст в список вывода.

        Args:
            s (str): Строка для добавления в список вывода.
        """

    def close(self):
        """Завершает обработку HTML и возвращает преобразованный текст.

        Returns:
            str: Преобразованный текст.
        """

    def handle_charref(self, c):
        """Обрабатывает символьные ссылки.

        Args:
            c (str): Символьная ссылка.
        """

    def handle_entityref(self, c):
        """Обрабатывает ссылки на HTML-сущности.

        Args:
            c (str): Ссылка на HTML-сущность.
        """

    def handle_starttag(self, tag, attrs):
        """Обрабатывает начальные теги HTML.

        Args:
            tag (str): Имя тега.
            attrs (list): Список атрибутов тега.
        """

    def handle_endtag(self, tag):
        """Обрабатывает конечные теги HTML.

        Args:
            tag (str): Имя тега.
        """

    def previousIndex(self, attrs):
        """Ищет индекс ссылки с заданными атрибутами.

        Args:
            attrs (dict): Атрибуты ссылки.

        Returns:
            int | None: Индекс ссылки или None, если ссылка не найдена.
        """

    def drop_last(self, nLetters):
        """Удаляет последние символы из вывода, если это необходимо.

        Args:
            nLetters (int): Количество символов для удаления.
        """

    def handle_emphasis(self, start, tag_style, parent_style):
        """Обрабатывает выделение текста.

        Args:
            start (bool): True, если это начальный тег, False - если конечный.
            tag_style (dict): Стили текущего тега.
            parent_style (dict): Стили родительского тега.
        """

    def handle_tag(self, tag, attrs, start):
        """Обрабатывает HTML-теги.

        Args:
            tag (str): Имя тега.
            attrs (dict): Атрибуты тега.
            start (bool): True, если это начальный тег, False - если конечный.
        """

    def pbr(self):
        """Добавляет разрыв строки, если необходимо."""

    def p(self):
        """Добавляет два разрыва строки."""

    def soft_br(self):
        """Добавляет мягкий разрыв строки."""

    def o(self, data, puredata=0, force=0):
        """Выводит данные с учетом различных условий.

        Args:
            data (str): Данные для вывода.
            puredata (int, optional): Флаг, указывающий, что данные являются "чистыми". По умолчанию 0.
            force (int | str, optional): Флаг принудительного вывода. По умолчанию 0.
        """

    def handle_data(self, data):
        """Обрабатывает текстовые данные.

        Args:
            data (str): Текстовые данные.
        """

    def unknown_decl(self, data):
        """Обрабатывает неизвестные объявления.

        Args:
            data (str): Неизвестные данные.
        """
```

**Описание класса**:

Класс `_html2text` наследуется от `HTMLParser.HTMLParser` и предназначен для преобразования HTML в удобочитаемый текст. Он обрабатывает различные HTML-теги, атрибуты и стили, чтобы создать текстовое представление HTML-документа.

**Как работает класс**:

1.  **Инициализация**:
    *   При инициализации класса `_html2text` задаются функции вывода, базовый URL и другие параметры, необходимые для преобразования HTML.
2.  **Обработка HTML**:
    *   Метод `feed` используется для подачи HTML-кода в парсер.
    *   Методы `handle_starttag`, `handle_endtag` и `handle_data` вызываются парсером HTML для обработки соответствующих элементов HTML.
3.  **Преобразование HTML в текст**:
    *   В процессе обработки HTML-теги преобразуются в соответствующие Markdown-эквиваленты.
    *   Текстовые данные извлекаются и форматируются с учетом стилей и структуры HTML.
4.  **Вывод результата**:
    *   Результат преобразования накапливается в списке `self.outtextlist`.
    *   Метод `close` завершает обработку HTML, объединяет элементы списка `self.outtextlist` и возвращает преобразованный текст.

**Методы**:

*   `__init__`: инициализирует объект класса `_html2text`
*   `feed`: обрабатывает данные HTML, заменяя небезопасные теги `<script>`.
*   `outtextf`: добавляет текст в список вывода.
*   `close`: завершает обработку HTML и возвращает преобразованный текст.
*   `handle_charref`: обрабатывает символьные ссылки.
*   `handle_entityref`: обрабатывает ссылки на HTML-сущности.
*   `handle_starttag`: обрабатывает начальные теги HTML.
*   `handle_endtag`: обрабатывает конечные теги HTML.
*   `previousIndex`: ищет индекс ссылки с заданными атрибутами.
*   `drop_last`: удаляет последние символы из вывода, если это необходимо.
*   `handle_emphasis`: обрабатывает выделение текста.
*   `handle_tag`: обрабатывает HTML-теги.
*   `pbr`: добавляет разрыв строки, если необходимо.
*   `p`: добавляет два разрыва строки.
*   `soft_br`: добавляет мягкий разрыв строки.
*   `o`: выводит данные с учетом различных условий.
*   `handle_data`: обрабатывает текстовые данные.
*   `unknown_decl`: обрабатывает неизвестные объявления.

### `Storage`

```python
class Storage: 
    pass
```

**Описание класса**:

Класс `Storage` используется для хранения настроек модуля.

**Как работает класс**:

Класс `Storage` не имеет методов и атрибутов. Он используется для создания объекта, который будет хранить настройки модуля.

```python
options = Storage()
options.google_doc = False
options.ul_item_mark = '*'
```
В данном примере создается объект `options` класса `Storage`, который используется для хранения настроек модуля.