# Модуль `Berlin`

## Обзор

Модуль `Berlin` представляет собой асинхронный провайдер, интегрирующийся с сервисом `ai.berlin4h.top` для предоставления доступа к модели `gpt-3.5-turbo`. Он использует `aiohttp` для выполнения асинхронных HTTP-запросов и управляет аутентификацией посредством токена. Модуль предназначен для генерации текста на основе входных сообщений, следуя принципам асинхронной работы.

## Подробней

Модуль предоставляет класс `Berlin`, который является подклассом `AsyncGeneratorProvider`. Он взаимодействует с API `ai.berlin4h.top` для получения ответов от модели `gpt-3.5-turbo`. Для аутентификации используется логин и пароль, а полученный токен сохраняется для последующих запросов.

## Классы

### `Berlin`

**Описание**: Класс `Berlin` предоставляет функциональность асинхронного взаимодействия с API `ai.berlin4h.top` для генерации текста на основе модели `gpt-3.5-turbo`.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных провайдеров, возвращающих результаты в виде асинхронного генератора.

**Атрибуты**:
- `url` (str): URL-адрес сервиса `ai.berlin4h.top`.
- `working` (bool): Указывает, работает ли провайдер в данный момент.
- `supports_gpt_35_turbo` (bool): Подтверждает поддержку модели `gpt-3.5-turbo`.
- `_token` (Optional[str]): Токен аутентификации, полученный после логина.

**Методы**:
- `create_async_generator`: Асинхронный генератор для получения ответов от модели.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от модели.

    Args:
        model (str): Имя модели для использования (по умолчанию "gpt-3.5-turbo").
        messages (Messages): Список сообщений для отправки в модель.
        proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
        **kwargs: Дополнительные аргументы для передачи в API.

    Returns:
        AsyncResult: Асинхронный генератор, выдающий ответы от модели.

    Raises:
        RuntimeError: Если возникает ошибка при обработке ответа от API.

    """
```

**Назначение**: Метод `create_async_generator` создает асинхронный генератор, который взаимодействует с API `ai.berlin4h.top` для получения ответов от языковой модели. Он выполняет аутентификацию, формирует запрос и обрабатывает ответы, возвращая их в виде асинхронного генератора.

**Параметры**:
- `cls` (type[Berlin]): Ссылка на класс `Berlin`.
- `model` (str): Имя используемой модели (по умолчанию: `"gpt-3.5-turbo"`).
- `messages` (Messages): Список сообщений, отправляемых модели.
- `proxy` (str, optional): Адрес прокси-сервера (по умолчанию: `None`).
- `**kwargs`: Дополнительные параметры, передаваемые в API.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, выдающий ответы от модели.

**Вызывает исключения**:
- `RuntimeError`: Вызывается, если при обработке ответа от API возникает ошибка.

**Как работает функция**:

1.  **Инициализация**: Проверяет, установлен ли токен аутентификации. Если токен отсутствует, выполняет вход в систему, используя логин и пароль, и сохраняет полученный токен.
2.  **Формирование запроса**: Формирует запрос к API, включая сообщения, параметры модели и заголовок с токеном аутентификации.
3.  **Отправка запроса**: Отправляет запрос к API с использованием `aiohttp.ClientSession`.
4.  **Обработка ответа**: Получает ответ от API в виде асинхронного потока данных.
5.  **Генерация результатов**: Преобразует полученные данные в формат JSON и извлекает содержимое, которое затем передается через асинхронный генератор.
6.  **Обработка ошибок**: Обрабатывает возможные ошибки при обработке ответа от API и вызывает исключение `RuntimeError` в случае возникновения ошибки.

```
A: Проверка наличия токена аутентификации
|
B: Вход в систему (если токен отсутствует)
|
C: Формирование запроса к API
|
D: Отправка запроса к API
|
E: Обработка ответа от API в виде асинхронного потока данных
|
F: Преобразование данных в JSON и извлечение содержимого
|
G: Передача содержимого через асинхронный генератор
|
H: Обработка ошибок при обработке ответа от API
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from typing import List, Dict

async def main():
    model_name = "gpt-3.5-turbo"
    messages: List[Dict[str, str]] = [{"role": "user", "content": "Hello, how are you?"}]
    proxy_url = None
    extra_params = {"temperature": 0.5}

    async for response_chunk in Berlin.create_async_generator(model_name, messages, proxy_url, **extra_params):
        print(response_chunk, end="")

    print()

if __name__ == "__main__":
    asyncio.run(main())
```
В данном примере демонстрируется использование асинхронного генератора `create_async_generator` для получения ответов от API. Функция `main` создает список сообщений, задает параметры прокси и дополнительные параметры, а затем итерируется по асинхронному генератору, выводя каждый полученный фрагмент ответа.
```python
# Пример использования create_async_generator с прокси
import asyncio
from typing import List, Dict

async def main():
    model_name = "gpt-3.5-turbo"
    messages: List[Dict[str, str]] = [{"role": "user", "content": "Привет, как дела?"}]
    proxy_url = "http://your-proxy-url:8080" #  <Вместо your-proxy-url  укажи адрес своего прокси-сервера>
    extra_params = {"temperature": 0.5}

    async for response_chunk in Berlin.create_async_generator(model_name, messages, proxy_url, **extra_params):
        print(response_chunk, end="")

    print()

if __name__ == "__main__":
    asyncio.run(main())
```
В данном примере демонстрируется использование асинхронного генератора `create_async_generator` для получения ответов от API через прокси-сервер. Функция `main` создает список сообщений, задает URL прокси и дополнительные параметры, а затем итерируется по асинхронному генератору, выводя каждый полученный фрагмент ответа.