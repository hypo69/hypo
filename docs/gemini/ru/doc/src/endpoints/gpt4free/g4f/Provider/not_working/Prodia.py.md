# Модуль `Prodia`

## Обзор

Модуль `Prodia` предоставляет интерфейс для взаимодействия с API сервиса Prodia, позволяющего генерировать изображения на основе текстовых запросов. Модуль включает в себя асинхронный генератор изображений и предоставляет возможность выбора различных моделей и параметров для генерации.

## Подробней

Модуль предназначен для интеграции с другими частями проекта `hypotez`, где требуется функциональность генерации изображений. Он использует `aiohttp` для выполнения асинхронных HTTP-запросов к API Prodia и предоставляет методы для настройки параметров генерации, таких как модель, промпт, количество шагов, и другие.

## Классы

### `Prodia`

**Описание**: Класс `Prodia` является асинхронным провайдером генерации изображений, который взаимодействует с API Prodia.

**Наследует**:

- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность выбора и управления моделями.

**Атрибуты**:

- `url` (str): Базовый URL сервиса Prodia (`https://app.prodia.com`).
- `api_endpoint` (str): URL API для генерации изображений (`https://api.prodia.com/generate`).
- `working` (bool): Флаг, указывающий на работоспособность провайдера (в данном случае `False`).
- `default_model` (str): Модель, используемая по умолчанию (`absolutereality_v181.safetensors [3d9d4d2b]`).
- `default_image_model` (str): Модель изображения по умолчанию (совпадает с `default_model`).
- `image_models` (List[str]): Список доступных моделей изображений.
- `models` (List[str]): Список всех доступных моделей (в данном случае совпадает с `image_models`).

**Методы**:

- `get_model(model: str) -> str`: Возвращает имя модели на основе переданного аргумента, используя псевдонимы или модель по умолчанию, если переданная модель не найдена.
- `create_async_generator(...) -> AsyncResult`: Создает асинхронный генератор для генерации изображений на основе переданных параметров.
- `_poll_job(session: ClientSession, job_id: str, proxy: str, max_attempts: int = 30, delay: int = 2) -> str`: Опрашивает API Prodia для получения статуса задачи генерации изображения и возвращает URL изображения после завершения.

## Функции

### `get_model`

```python
    @classmethod
    def get_model(cls, model: str) -> str:
        ...
```

**Назначение**: Определяет и возвращает используемую модель на основе входных данных.

**Параметры**:

- `model` (str): Имя модели, которую необходимо получить.

**Возвращает**:

- `str`: Имя модели, если она найдена в списке доступных моделей или псевдонимов. В противном случае возвращает модель по умолчанию.

**Как работает функция**:

1.  **Проверка наличия модели в списке моделей**: Функция проверяет, содержится ли переданное имя модели (`model`) в списке доступных моделей (`cls.models`).
2.  **Проверка наличия модели в псевдонимах**: Если модель не найдена в списке моделей, функция проверяет, содержится ли она в словаре псевдонимов (`cls.model_aliases`).
3.  **Возврат модели по умолчанию**: Если модель не найдена ни в списке моделей, ни в псевдонимах, функция возвращает модель, используемую по умолчанию (`cls.default_model`).

```text
    Модель --> Проверка в списке моделей
        |
        Нет
        |
        --> Проверка в псевдонимах
            |
            Нет
            |
            --> Возврат модели по умолчанию
```

**Примеры**:

```python
# Пример 1: Модель найдена в списке моделей
model = Prodia.get_model('absolutereality_v181.safetensors [3d9d4d2b]')
print(model)  # Вывод: absolutereality_v181.safetensors [3d9d4d2b]

# Пример 2: Модель не найдена, возвращается модель по умолчанию
model = Prodia.get_model('non_existent_model')
print(model)  # Вывод: absolutereality_v181.safetensors [3d9d4d2b]
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        negative_prompt: str = "",
        steps: str = 20, # 1-25
        cfg: str = 7, # 0-20
        seed: Optional[int] = None,
        sampler: str = "DPM++ 2M Karras", # "Euler", "Euler a", "Heun", "DPM++ 2M Karras", "DPM++ SDE Karras", "DDIM"
        aspect_ratio: str = "square", # "square", "portrait", "landscape"
        **kwargs
    ) -> AsyncResult:
        ...
```

**Назначение**: Создает асинхронный генератор для генерации изображений на основе заданных параметров.

**Параметры**:

- `model` (str): Модель, используемая для генерации изображения.
- `messages` (Messages): Список сообщений, содержащих текстовый запрос.
- `proxy` (str, optional): Прокси-сервер для выполнения запросов. По умолчанию `None`.
- `negative_prompt` (str, optional): Негативный промпт, указывающий, что не должно быть на изображении. По умолчанию пустая строка.
- `steps` (str, optional): Количество шагов для генерации изображения. По умолчанию 20.
- `cfg` (str, optional): Параметр CFG (Classifier-Free Guidance). По умолчанию 7.
- `seed` (Optional[int], optional): Зерно для случайной генерации. Если не указано, генерируется случайное число.
- `sampler` (str, optional): Сэмплер, используемый для генерации изображения. По умолчанию "DPM++ 2M Karras".
- `aspect_ratio` (str, optional): Соотношение сторон изображения. По умолчанию "square".
- `**kwargs`: Дополнительные параметры.

**Возвращает**:

- `AsyncResult`: Асинхронный генератор, возвращающий объект `ImageResponse` с URL сгенерированного изображения.

**Как работает функция**:

1.  **Выбор модели**: Сначала функция вызывает `cls.get_model(model)` для определения используемой модели.
2.  **Генерация зерна**: Если `seed` не указан, генерируется случайное целое число в диапазоне от 0 до 10000.
3.  **Формирование заголовков**: Создаются заголовки HTTP-запроса, включающие `user-agent`, `referer` и другие необходимые параметры.
4.  **Создание асинхронной сессии**: Используется `aiohttp.ClientSession` для выполнения асинхронных запросов.
5.  **Извлечение промпта**: Извлекается текстовый запрос из списка сообщений `messages`.
6.  **Формирование параметров запроса**: Создается словарь `params`, содержащий все параметры, необходимые для запроса к API Prodia.
7.  **Выполнение запроса к API**: Выполняется `GET`-запрос к `cls.api_endpoint` с указанными параметрами и прокси (если указан).
8.  **Получение ID задачи**: Извлекается `job_id` из JSON-ответа.
9.  **Опрос статуса задачи**: Вызывается `cls._poll_job(session, job_id, proxy)` для ожидания завершения задачи генерации изображения.
10. **Генерация результата**: Возвращается объект `ImageResponse` с URL сгенерированного изображения и альтернативным текстом (промптом).

**Внутренняя функция**:
*   `_poll_job(cls, session: ClientSession, job_id: str, proxy: str, max_attempts: int = 30, delay: int = 2) -> str`: Опрашивает API Prodia для получения статуса задачи генерации изображения и возвращает URL изображения после завершения.

```text
    Выбор модели --> Генерация зерна --> Формирование заголовков --> Создание асинхронной сессии --> Извлечение промпта
    |
    --> Формирование параметров запроса --> Выполнение запроса к API --> Получение ID задачи --> Опрос статуса задачи
    |
    --> Генерация результата (ImageResponse)
```

**Примеры**:

```python
# Пример использования (требуется асинхронный контекст)
# async def main():
#     model = "absolutereality_v181.safetensors [3d9d4d2b]"
#     messages = [{"role": "user", "content": "A cat wearing a hat"}]
#     async for image_response in Prodia.create_async_generator(model=model, messages=messages):
#         print(image_response.url)
#
# asyncio.run(main())
```

### `_poll_job`

```python
    @classmethod
    async def _poll_job(cls, session: ClientSession, job_id: str, proxy: str, max_attempts: int = 30, delay: int = 2) -> str:
        ...
```

**Назначение**: Опрашивает API Prodia для получения статуса задачи генерации изображения.

**Параметры**:

- `session` (ClientSession): Асинхронная сессия для выполнения запросов.
- `job_id` (str): ID задачи генерации изображения.
- `proxy` (str): Прокси-сервер для выполнения запросов.
- `max_attempts` (int, optional): Максимальное количество попыток опроса. По умолчанию 30.
- `delay` (int, optional): Задержка в секундах между попытками опроса. По умолчанию 2.

**Возвращает**:

- `str`: URL сгенерированного изображения, если задача успешно завершена.

**Вызывает исключения**:

- `Exception`: Если задача завершилась с ошибкой или превышено максимальное количество попыток.

**Как работает функция**:

1.  **Цикл опроса**: Функция выполняет цикл опроса API Prodia до тех пор, пока не будет достигнуто максимальное количество попыток (`max_attempts`).
2.  **Выполнение запроса к API**: В каждой итерации цикла выполняется `GET`-запрос к API Prodia для получения статуса задачи.
3.  **Анализ статуса задачи**: Анализируется JSON-ответ, чтобы определить статус задачи.
    -   Если статус `succeeded`, возвращается URL изображения.
    -   Если статус `failed`, вызывается исключение `Exception`.
4.  **Задержка**: После каждой попытки опроса выполняется задержка на `delay` секунд.
5.  **Обработка таймаута**: Если после `max_attempts` попыток задача не завершилась, вызывается исключение `Exception` с сообщением о таймауте.

```text
    Цикл (max_attempts) --> Выполнение запроса к API --> Анализ статуса задачи
    |                                             |
    succeeded                                     failed
    |                                             |
    --> Возврат URL изображения                    --> Вызов исключения Exception
    |
    Задержка (delay)
    |
    Таймаут --> Вызов исключения Exception
```

**Примеры**:

```python
# Пример использования (требуется асинхронный контекст)
# async def main():
#     async with ClientSession() as session:
#         try:
#             image_url = await Prodia._poll_job(session, "some_job_id", None)
#             print(image_url)
#         except Exception as e:
#             print(f"Error: {e}")
#
# asyncio.run(main())