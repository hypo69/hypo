# Модуль исполнения сценария создания мехирона для Сергея Казаринова

## Обзор

Модуль предназначен для извлечения, разбора и сохранения данных о продуктах от различных поставщиков с целью последующей публикации в Prestashop. Он включает в себя функциональность для подготовки данных, обработки с использованием AI и интеграции с Prestashop.

## Подробней

Этот модуль является частью процесса автоматизации обновления товарной информации в интернет-магазине на платформе Prestashop. Он позволяет получать данные о товарах от поставщиков, обрабатывать их с помощью AI для улучшения качества описаний и характеристик, и затем автоматически публиковать эти товары в Prestashop.

## Классы

### `SupplierToPrestashopProvider`

**Описание**:
Класс `SupplierToPrestashopProvider` предназначен для обработки данных о продуктах, получаемых от поставщиков, и подготовки их к публикации в Prestashop. Он включает в себя методы для извлечения данных, их преобразования, обработки с помощью AI и сохранения в Prestashop.

**Как работает класс**:
1.  **Инициализация**: При создании экземпляра класса происходит загрузка конфигурационных файлов, инициализация Selenium WebDriver (если он не передан извне) и AI-модели Gemini.
2.  **Сбор данных**: Используются граберы (скрейперы) для извлечения данных о товарах с сайтов поставщиков.
3.  **Обработка данных**: Данные преобразуются, обрабатываются AI-моделью для улучшения качества описаний и характеристик.
4.  **Сохранение данных**: Подготовленные данные сохраняются в файлы JSON и публикуются в Prestashop.
5.  **Создание отчетов**: Формируются отчеты в формате HTML и PDF, которые могут быть отправлены боту.

**Атрибуты**:

*   `driver (Driver)`: Экземпляр Selenium WebDriver для управления браузером.
*   `export_path (Path)`: Путь для экспорта данных о продуктах.
*   `mexiron_name (str)`: Название мехирона.
*   `price (float)`: Цена продукта.
*   `timestamp (str)`: Временная метка для идентификации данных.
*   `products_list (list)`: Список обработанных данных о продуктах.
*   `model (GoogleGenerativeAI)`: Экземпляр AI-модели Google Gemini.
*   `config (SimpleNamespace)`: Конфигурация, загруженная из JSON-файла.
*   `local_images_path (Path)`: Путь к локальному хранилищу изображений.
*   `lang (str)`: Язык, используемый для обработки данных и генерации отчетов.
*   `gemini_api (str)`: API-ключ для доступа к Google Gemini.
*   `presta_api (str)`: API-ключ для доступа к Prestashop.
*   `presta_url (str)`: URL-адрес Prestashop.

**Методы**:

*   `__init__`: Инициализирует экземпляр класса `SupplierToPrestashopProvider`.
*   `initialise_ai_model`: Инициализирует AI-модель Gemini.
*   `run_scenario`: Выполняет основной сценарий обработки данных о продуктах.
*   `save_product_data`: Сохраняет данные о продукте в файл JSON.
*   `process_ai`: Обрабатывает список продуктов с использованием AI-модели.
*   `read_data_from_json`: Загружает данные из JSON-файлов.
*   `save_in_prestashop`: Сохраняет товары в Prestashop.
*   `post_facebook`: Публикует информацию о товаре в Facebook.
*   `create_report`: Создает отчеты в формате HTML и PDF.

### `__init__`

```python
def __init__(self, 
             lang: str, 
             gemini_api: str,
             presta_api: str,
             presta_url: str,
             driver: Optional[Driver] = None):
    """
    Инициализирует класс SupplierToPrestashopProvider необходимыми компонентами.

    Args:
        lang (str): Язык для обработки данных и генерации отчетов.
        gemini_api (str): API-ключ для доступа к Google Gemini.
        presta_api (str): API-ключ для доступа к Prestashop.
        presta_url (str): URL-адрес Prestashop.
        driver (Optional[Driver], optional): Экземпляр Selenium WebDriver. Defaults to None.
    """
```

**Как работает функция**:

1.  Сохраняет переданные API-ключи и URL-адрес Prestashop в атрибуты экземпляра класса.
2.  Загружает конфигурацию из JSON-файла `emil.json` и сохраняет её в атрибуте `config`.
3.  Инициализирует временную метку `timestamp` с текущим временем.
4.  Инициализирует драйвер (`driver`) либо переданным экземпляром, либо создает новый экземпляр `Firefox`.
5.  Инициализирует AI-модель Gemini с использованием метода `initialise_ai_model`.

### `initialise_ai_model`

```python
def initialise_ai_model(self):
    """Инициализация модели Gemini"""
```

**Как работает функция**:

1.  Формирует путь к файлу с системными инструкциями для AI-модели на основе языка (`self.lang`).
2.  Считывает содержимое файла с инструкциями.
3.  Создает экземпляр класса `GoogleGenerativeAI` с использованием API-ключа, системных инструкций и конфигурации генерации.

### `run_scenario`

```python
async def run_scenario(
    self, 
    urls: list[str],
    price: Optional[str] = '', 
    mexiron_name: Optional[str] = '', 
) -> bool:
    """
    Выполняет сценарий: разбирает продукты, обрабатывает их через AI и сохраняет данные.

    Args:
        urls (list[str]): Список URL-адресов продуктов.
        price (Optional[str], optional): Цена для обработки. Defaults to ''.
        mexiron_name (Optional[str], optional): Пользовательское имя Mexiron. Defaults to ''.

    Returns:
        bool: True, если сценарий выполнен успешно, иначе False.
    """
```

**Как работает функция**:

1.  Определяет кортеж `required_fields` с именами полей, которые необходимо извлечь из данных о продукте.
2.  Итерируется по списку URL-адресов продуктов (`urls`).
3.  Для каждого URL-адреса пытается получить грабер (скрейпер) с помощью функции `get_graber_by_supplier_url`.
4.  Если грабер не найден, логирует отладочное сообщение и переходит к следующему URL-адресу.
5.  Использует грабер для извлечения данных о продукте с веб-страницы.
6.  Преобразует полученные поля продукта с помощью метода `convert_product_fields`.
7.  Сохраняет данные о продукте с помощью метода `save_product_data`.

### `save_product_data`

```python
async def save_product_data(self, product_data: dict):
    """
    Сохраняет данные об отдельном продукте в файл.

    Args:
        product_data (dict): Отформатированные данные о продукте.
    """
```

**Как работает функция**:

1.  Формирует путь к файлу, в котором будут сохранены данные о продукте.
2.  Преобразует данные о продукте в JSON-формат и сохраняет их в файл.
3.  Логирует ошибку, если не удается сохранить данные.

### `process_ai`

```python
async def process_ai(self, products_list: List[str], lang:str,  attempts: int = 3) -> tuple | bool:
    """
    Обрабатывает список продуктов с помощью AI-модели.

    Args:
        products_list (str): Список словарей с данными о продуктах в виде строки.
        lang (str): Язык, на котором нужно получить ответ от AI-модели.
        attempts (int, optional): Количество попыток повтора в случае неудачи. Defaults to 3.

    Returns:
        tuple | bool: Обработанный ответ в форматах `ru` и `he`. False, если не удалось получить
                      допустимый ответ после нескольких попыток.

    .. note::
        Модель может возвращать невалидный результат.
        В таком случае я переспрашиваю модель разумное количество раз.
    """
```

**Как работает функция**:

1.  Проверяет количество оставшихся попыток (`attempts`). Если попыток не осталось, возвращает пустой словарь.
2.  Формирует команду для AI-модели, считывая содержимое файла с инструкциями и добавляя к нему список продуктов.
3.  Отправляет запрос к AI-модели.
4.  Если ответ от модели не получен, логирует ошибку и возвращает пустой словарь.
5.  Парсит ответ от AI-модели в словарь.
6.  Если ответ не удалось распарсить, логирует ошибку и повторяет попытку, если они еще остались.

### `read_data_from_json`

```python
async def read_data_from_json(self):
    """Загружаю JSON файлы и фотки, которые я сделал через телеграм"""
```

**Как работает функция**:

1.  Загружает JSON файлы, используя `j_loads_ns` из пути `self.local_images_path`.
2.  Выводит загруженные данные в консоль с помощью функции `print`.

### `save_in_prestashop`

```python
async def save_in_prestashop(self, products_list:ProductFields | list[ProductFields]) -> bool:
    """Функция, которая сохраняет товары в Prestashop emil-design.com """
```

**Как работает функция**:

1.  Приводит входной параметр `products_list` к типу `list`, если он является экземпляром класса `ProductFields`.
2.  Создает экземпляр класса `PrestaProduct` для взаимодействия с API Prestashop.
3.  Итерируется по списку продуктов и добавляет каждый продукт в Prestashop с помощью метода `add_new_product`.

### `post_facebook`

```python
async def post_facebook(self, mexiron:SimpleNamespace) -> bool:
    """Функция исполняет сценарий рекламного модуля `facvebook`."""
```

**Как работает функция**:

1.  Переходит на страницу профиля Facebook.
2.  Формирует заголовок для публикации, включая название, описание и цену продукта.
3.  Публикует заголовок, загружает медиафайлы и публикует сообщение с использованием функций из модуля `src.endpoints.advertisement.facebook.scenarios`.

### `create_report`

```python
async def create_report(self, data: dict, lang:str, html_file: Path, pdf_file: Path) -> bool:
    """Функция отправляет задание на создание мехирона в формате `html` и `pdf`.
    Если мехорон в pdf создался (`generator.create_report()` вернул True) - 
    отправить его боту
    """
```

**Как работает функция**:

1.  Создает экземпляр класса `ReportGenerator`.
2.  Генерирует отчет в форматах HTML и PDF с помощью метода `create_report`.
3.  Проверяет, был ли создан PDF-файл, и отправляет его боту, если файл существует.

## Функции

### `main`

```python
async def main(suppier_to_presta):
    """На данный момент функция читает JSON со списком фотографий , которые были получены от Эмиля"""
```

**Как работает функция**:

1.  Устанавливает язык (`lang`) в значение `he`.
2.  Загружает данные о продуктах из JSON-файла `out_250108230345305_he.json` с использованием `j_loads_ns`.
3.  Создает экземпляр класса `SupplierToPrestashopProvider` с указанным языком.
4.  Преобразует загруженные данные в список.
5.  Сохраняет продукты в Prestashop с использованием метода `save_in_prestashop`.