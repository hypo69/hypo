# Модуль `admin`

## Обзор

Модуль `admin` содержит набор обработчиков для администрирования Telegram-бота цифрового магазина. Он предоставляет административные функции, такие как просмотр статистики, управление продуктами (добавление, удаление) и другие.

## Подробней

Этот модуль содержит обработчики для управления ботом цифрового рынка через Telegram.
Он предоставляет интерфейс администратора для выполнения различных задач, таких как просмотр статистики, добавление новых продуктов, удаление существующих и управление категориями.

В модуле используются конечные автоматы (FSM) для управления сложными процессами, такими как добавление нового продукта, который включает несколько шагов: ввод имени, описания, выбор категории, указание цены, добавление файла (при необходимости) и подтверждение.

Основные компоненты модуля включают:
- Обработчики коллбэков и сообщений для выполнения административных команд.
- FSM для управления состоянием процесса добавления продукта.
- Клавиатуры (reply_markup) для навигации и выполнения действий в админ-панели.
- Взаимодействие с базой данных через DAO для выполнения операций с пользователями, продуктами и категориями.

## Классы

### `AddProduct(StatesGroup)`

**Описание**: Класс, представляющий состояния конечного автомата для добавления нового продукта.

**Как работает класс**:

Этот класс определяет состояния, через которые проходит процесс добавления нового продукта. Каждое состояние соответствует определенному шагу, который должен выполнить администратор.

- `name`: Ожидание ввода имени продукта.
- `description`: Ожидание ввода описания продукта.
- `price`: Ожидание ввода цены продукта.
- `file_id`: Ожидание отправки файла продукта (или выбора опции "без файла").
- `category_id`: Ожидание выбора категории продукта.
- `hidden_content`: Ожидание ввода скрытого контента, который будет доступен после покупки.
- `confirm_add`: Ожидание подтверждения добавления продукта.

## Функции

### `start_admin(call: CallbackQuery)`

```python
async def start_admin(call: CallbackQuery):
    """
    Обработчик коллбэка `admin_panel`.

    Args:
        call (CallbackQuery): Объект коллбэка от Telegram.

    Raises:
        Exception: Если происходит ошибка при открытии админ-панели.

    """
```

**Как работает функция**:

Функция обрабатывает коллбэк `admin_panel`, который запускает админ-панель для пользователей с соответствующими правами (`settings.ADMIN_IDS`).

1. Подтверждает доступ в админ-панель, отправляя уведомление `await call.answer('Доступ в админ-панель разрешен!')`.
2. Пытается изменить текст текущего сообщения, чтобы отобразить интерфейс админ-панели с помощью клавиатуры `admin_kb()`.
3. Если изменение сообщения не удается, пытается удалить текущее сообщение и отправить новое с интерфейсом админ-панели.
4. Если и это не удается, отправляет сообщение об ошибке с предложением повторить попытку.
5. Весь процесс обернут в блоки `try...except`, чтобы обрабатывать возможные исключения и предоставлять информативные сообщения об ошибках.

### `admin_statistic(call: CallbackQuery, session_without_commit: AsyncSession)`

```python
async def admin_statistic(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обработчик коллбэка `statistic`.

    Args:
        call (CallbackQuery): Объект коллбэка от Telegram.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных (без коммита изменений).

    """
```

**Как работает функция**:

Функция обрабатывает коллбэк `statistic`, который запрашивает и отображает статистику пользователей и заказов.

1. Отправляет уведомление о начале сбора статистики.
2. Извлекает статистику пользователей и информацию о платежах из базы данных, используя `UserDAO.get_statistics` и `PurchaseDao.get_payment_stats`.
3. Формирует текстовое сообщение, содержащее общую статистику пользователей (общее количество, новые за сегодня, неделю, месяц) и статистику по платежам.
4. Редактирует текущее сообщение, чтобы отобразить статистику с помощью клавиатуры `admin_kb()`.

### `admin_process_cancel(call: CallbackQuery, state: FSMContext)`

```python
async def admin_process_cancel(call: CallbackQuery, state: FSMContext):
    """
    Обработчик коллбэка `cancel`.

    Args:
        call (CallbackQuery): Объект коллбэка от Telegram.
        state (FSMContext): Контекст конечного автомата для управления состоянием.

    """
```

**Как работает функция**:

Функция обрабатывает коллбэк `cancel`, который отменяет текущий сценарий добавления товара.

1. Очищает состояние конечного автомата, используя `state.clear()`.
2. Отправляет уведомление об отмене сценария.
3. Удаляет текущее сообщение.
4. Отправляет новое сообщение с подтверждением отмены и клавиатурой `admin_kb_back()`.

### `admin_process_start_dell(call: CallbackQuery, session_without_commit: AsyncSession)`

```python
async def admin_process_start_dell(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обработчик коллбэка `delete_product`.

    Args:
        call (CallbackQuery): Объект коллбэка от Telegram.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных (без коммита изменений).

    """
```

**Как работает функция**:

Функция обрабатывает коллбэк `delete_product`, который запускает режим удаления товаров.

1. Отправляет уведомление о начале режима удаления товаров.
2. Извлекает все товары из базы данных, используя `ProductDao.find_all`.
3. Редактирует текущее сообщение, чтобы указать количество товаров в базе данных и предложить начать удаление.
4. Для каждого товара формирует описание, включающее название, описание, цену, скрытый контент и информацию о наличии файла.
5. Отправляет описание каждого товара с кнопкой для удаления (`dell_product_kb`), либо отправляет файл товара (если он есть) с подписью, содержащей описание товара и кнопкой для удаления.

### `admin_process_start_dell(call: CallbackQuery, session_with_commit: AsyncSession)`

```python
async def admin_process_start_dell(call: CallbackQuery, session_with_commit: AsyncSession):
    """
    Обработчик коллбэков, начинающихся с `dell_`.

    Args:
        call (CallbackQuery): Объект коллбэка от Telegram.
        session_with_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных (с коммитом изменений).

    """
```

**Как работает функция**:

Функция обрабатывает коллбэки, начинающиеся с `dell_`, которые соответствуют запросу на удаление товара.

1. Извлекает ID товара из данных коллбэка.
2. Удаляет товар из базы данных, используя `ProductDao.delete`.
3. Отправляет уведомление об успешном удалении товара.
4. Удаляет сообщение с информацией о товаре.

### `admin_process_products(call: CallbackQuery, session_without_commit: AsyncSession)`

```python
async def admin_process_products(call: CallbackQuery, session_without_commit: AsyncSession):
    """
    Обработчик коллбэка `process_products`.

    Args:
        call (CallbackQuery): Объект коллбэка от Telegram.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных (без коммита изменений).

    """
```

**Как работает функция**:

Функция обрабатывает коллбэк `process_products`, который запускает режим управления товарами.

1. Отправляет уведомление о начале режима управления товарами.
2. Подсчитывает количество товаров в базе данных, используя `ProductDao.count`.
3. Редактирует текущее сообщение, чтобы отобразить количество товаров и предложить выбор действия (добавление, удаление и т.д.) с помощью клавиатуры `product_management_kb()`.

### `admin_process_add_product(call: CallbackQuery, state: FSMContext)`

```python
async def admin_process_add_product(call: CallbackQuery, state: FSMContext):
    """
    Обработчик коллбэка `add_product`.

    Args:
        call (CallbackQuery): Объект коллбэка от Telegram.
        state (FSMContext): Контекст конечного автомата для управления состоянием.

    """
```

**Как работает функция**:

Функция обрабатывает коллбэк `add_product`, который запускает сценарий добавления нового товара.

1. Отправляет уведомление о начале сценария добавления товара.
2. Удаляет текущее сообщение.
3. Отправляет новое сообщение с запросом имени товара и клавиатурой для отмены (`cancel_kb_inline()`).
4. Обновляет данные состояния, сохраняя ID последнего отправленного сообщения.
5. Устанавливает состояние `AddProduct.name`, чтобы ожидать ввод имени товара.

### `admin_process_name(message: Message, state: FSMContext)`

```python
async def admin_process_name(message: Message, state: FSMContext):
    """
    Обработчик сообщений с текстом в состоянии `AddProduct.name`.

    Args:
        message (Message): Объект сообщения от Telegram.
        state (FSMContext): Контекст конечного автомата для управления состоянием.

    """
```

**Как работает функция**:

Функция обрабатывает сообщения с текстом, когда FSM находится в состоянии `AddProduct.name`.

1. Обновляет данные состояния, сохраняя введенное имя товара.
2. Вызывает `process_dell_text_msg` для удаления предыдущего сообщения с запросом имени.
3. Отправляет новое сообщение с запросом короткого описания товара и клавиатурой для отмены.
4. Обновляет данные состояния, сохраняя ID последнего отправленного сообщения.
5. Устанавливает состояние `AddProduct.description`, чтобы ожидать ввод описания товара.

### `admin_process_description(message: Message, state: FSMContext, session_without_commit: AsyncSession)`

```python
async def admin_process_description(message: Message, state: FSMContext, session_without_commit: AsyncSession):
    """
    Обработчик сообщений с текстом в состоянии `AddProduct.description`.

    Args:
        message (Message): Объект сообщения от Telegram.
        state (FSMContext): Контекст конечного автомата для управления состоянием.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных (без коммита изменений).

    """
```

**Как работает функция**:

Функция обрабатывает сообщения с текстом, когда FSM находится в состоянии `AddProduct.description`.

1. Обновляет данные состояния, сохраняя введенное описание товара.
2. Вызывает `process_dell_text_msg` для удаления предыдущего сообщения с запросом описания.
3. Извлекает данные о категориях из базы данных, используя `CategoryDao.find_all`.
4. Отправляет новое сообщение с запросом выбора категории товара и клавиатурой с категориями (`catalog_admin_kb`).
5. Обновляет данные состояния, сохраняя ID последнего отправленного сообщения.
6. Устанавливает состояние `AddProduct.category_id`, чтобы ожидать выбор категории товара.

### `admin_process_category(call: CallbackQuery, state: FSMContext)`

```python
async def admin_process_category(call: CallbackQuery, state: FSMContext):
    """
    Обработчик коллбэков, начинающихся с `add_category_`, в состоянии `AddProduct.category_id`.

    Args:
        call (CallbackQuery): Объект коллбэка от Telegram.
        state (FSMContext): Контекст конечного автомата для управления состоянием.

    """
```

**Как работает функция**:

Функция обрабатывает коллбэки, начинающиеся с `add_category_`, когда FSM находится в состоянии `AddProduct.category_id`.

1. Извлекает ID категории из данных коллбэка.
2. Обновляет данные состояния, сохраняя выбранный ID категории.
3. Отправляет уведомление об успешном выборе категории.
4. Редактирует текущее сообщение, чтобы запросить цену товара и предоставить клавиатуру для отмены.
5. Обновляет данные состояния, сохраняя ID последнего отправленного сообщения.
6. Устанавливает состояние `AddProduct.price`, чтобы ожидать ввод цены товара.

### `admin_process_price(message: Message, state: FSMContext)`

```python
async def admin_process_price(message: Message, state: FSMContext):
    """
    Обработчик сообщений с текстом в состоянии `AddProduct.price`.

    Args:
        message (Message): Объект сообщения от Telegram.
        state (FSMContext): Контекст конечного автомата для управления состоянием.

    """
```

**Как работает функция**:

Функция обрабатывает сообщения с текстом, когда FSM находится в состоянии `AddProduct.price`.

1. Пытается преобразовать введенный текст в целое число, чтобы получить цену товара.
2. Если преобразование успешно, обновляет данные состояния, сохраняя цену.
3. Вызывает `process_dell_text_msg` для удаления предыдущего сообщения с запросом цены.
4. Отправляет новое сообщение с запросом файла товара (или выбора опции "без файла") и клавиатурой `admin_send_file_kb()`.
5. Обновляет данные состояния, сохраняя ID последнего отправленного сообщения.
6. Устанавливает состояние `AddProduct.file_id`, чтобы ожидать отправку файла товара.
7. Если преобразование не удается (введенный текст не является числом), отправляет сообщение об ошибке с предложением ввести числовое значение для цены.

### `admin_process_without_file(call: CallbackQuery, state: FSMContext)`

```python
async def admin_process_without_file(call: CallbackQuery, state: FSMContext):
    """
    Обработчик коллбэка `without_file` в состоянии `AddProduct.file_id`.

    Args:
        call (CallbackQuery): Объект коллбэка от Telegram.
        state (FSMContext): Контекст конечного автомата для управления состоянием.

    """
```

**Как работает функция**:

Функция обрабатывает коллбэк `without_file`, когда FSM находится в состоянии `AddProduct.file_id`.

1. Обновляет данные состояния, устанавливая `file_id` в `None`.
2. Отправляет уведомление о том, что файл не выбран.
3. Редактирует текущее сообщение, чтобы запросить контент, который будет отображаться после покупки товара, и предоставляет клавиатуру для отмены.
4. Обновляет данные состояния, сохраняя ID последнего отправленного сообщения.
5. Устанавливает состояние `AddProduct.hidden_content`, чтобы ожидать ввод скрытого контента.

### `admin_process_without_file(message: Message, state: FSMContext)`

```python
async def admin_process_without_file(message: Message, state: FSMContext):
    """
    Обработчик сообщений с документом в состоянии `AddProduct.file_id`.

    Args:
        message (Message): Объект сообщения от Telegram.
        state (FSMContext): Контекст конечного автомата для управления состоянием.

    """
```

**Как работает функция**:

Функция обрабатывает сообщения с документом, когда FSM находится в состоянии `AddProduct.file_id`.

1. Обновляет данные состояния, сохраняя `file_id` из отправленного документа.
2. Вызывает `process_dell_text_msg` для удаления предыдущего сообщения.
3. Отправляет новое сообщение с запросом контента, который будет отображаться после покупки товара, и предоставляет клавиатуру для отмены.
4. Обновляет данные состояния, сохраняя ID последнего отправленного сообщения.
5. Устанавливает состояние `AddProduct.hidden_content`, чтобы ожидать ввод скрытого контента.

### `admin_process_hidden_content(message: Message, state: FSMContext, session_without_commit: AsyncSession)`

```python
async def admin_process_hidden_content(message: Message, state: FSMContext, session_without_commit: AsyncSession):
    """
    Обработчик сообщений с текстом в состоянии `AddProduct.hidden_content`.

    Args:
        message (Message): Объект сообщения от Telegram.
        state (FSMContext): Контекст конечного автомата для управления состоянием.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных (без коммита изменений).

    """
```

**Как работает функция**:

Функция обрабатывает сообщения с текстом, когда FSM находится в состоянии `AddProduct.hidden_content`.

1. Обновляет данные состояния, сохраняя введенный скрытый контент.
2. Извлекает данные о продукте из состояния, используя `state.get_data()`.
3. Извлекает информацию о категории из базы данных, используя `CategoryDao.find_one_or_none_by_id`.
4. Формирует текстовое сообщение, содержащее информацию о товаре (название, описание, цену, скрытый контент, категорию и наличие файла), для подтверждения администратором.
5. Вызывает `process_dell_text_msg` для удаления предыдущего сообщения.
6. Отправляет новое сообщение с информацией о товаре и клавиатурой для подтверждения (`admin_confirm_kb()`), либо отправляет файл товара (если он есть) с подписью, содержащей информацию о товаре и кнопками для подтверждения.
7. Обновляет данные состояния, сохраняя ID последнего отправленного сообщения.
8. Устанавливает состояние `AddProduct.confirm_add`, чтобы ожидать подтверждения добавления товара.

### `admin_process_confirm_add(call: CallbackQuery, state: FSMContext, session_with_commit: AsyncSession)`

```python
async def admin_process_confirm_add(call: CallbackQuery, state: FSMContext, session_with_commit: AsyncSession):
    """
    Обработчик коллбэка `confirm_add` в состоянии `AddProduct.confirm_add`.

    Args:
        call (CallbackQuery): Объект коллбэка от Telegram.
        state (FSMContext): Контекст конечного автомата для управления состоянием.
        session_with_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных (с коммитом изменений).

    """
```

**Как работает функция**:

Функция обрабатывает коллбэк `confirm_add`, когда FSM находится в состоянии `AddProduct.confirm_add`.

1. Отправляет уведомление о начале сохранения файла.
2. Извлекает данные о продукте из состояния, используя `state.get_data()`.
3. Удаляет сообщение с информацией о товаре, используя `bot.delete_message`.
4. Удаляет `last_msg_id` из данных о продукте.
5. Добавляет товар в базу данных, используя `ProductDao.add`.
6. Отправляет новое сообщение с подтверждением успешного добавления товара и клавиатурой `admin_kb()`.