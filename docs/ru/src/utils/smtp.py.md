# Модуль для работы с SMTP
=================================================

Модуль предоставляет интерфейс для отправки и получения электронных писем с использованием SMTP или IMAP серверов.

## Обзор

Модуль `smtp.py` предоставляет функциональность для отправки и получения электронных писем. Он включает функции для отправки электронных писем с использованием SMTP и получения электронных писем с использованием IMAP. Модуль использует библиотеку `smtplib` для отправки электронных писем и библиотеку `imaplib` для получения электронных писем.  Особое внимание уделено безопасности, включая использование переменных окружения для хранения учетных данных.

## Подробней

Этот модуль содержит функции для отправки и получения электронных писем через протоколы SMTP и IMAP. Он использует стандартные библиотеки Python, такие как `smtplib`, `imaplib` и `email`, а также модуль логирования `src.logger.logger` для обработки ошибок.  Модуль предназначен для упрощения работы с электронной почтой, предоставляя простой интерфейс для отправки и получения писем. Важно отметить, что учетные данные для доступа к SMTP и IMAP серверам должны храниться в переменных окружения, чтобы избежать их хранения в коде.

## Функции

### `send`

```python
def send(subject: str = '', body: str = '', to: str = 'one.last.bit@gmail.com') -> bool:
    """Отправляет электронное письмо.

    Args:
        subject (str, optional): Тема письма. По умолчанию ''.
        body (str, optional): Тело письма. По умолчанию ''.
        to (str, optional): Адрес получателя. По умолчанию 'one.last.bit@gmail.com'.

    Returns:
        bool: True, если письмо успешно отправлено, False в противном случае.

    Raises:
        Exception: Если произошла ошибка при отправке письма.

    Пример:
        >>> send(subject='Тест', body='Это тестовое письмо', to='test@example.com')
        True
    """
```

**Назначение**: Функция отправляет электронное письмо с указанной темой, телом и получателем.

**Параметры**:
- `subject` (str): Тема письма. По умолчанию пустая строка.
- `body` (str): Тело письма. По умолчанию пустая строка.
- `to` (str): Адрес электронной почты получателя. По умолчанию 'one.last.bit@gmail.com'.

**Возвращает**:
- `bool`: Возвращает `True`, если письмо было успешно отправлено, и `False` в случае ошибки.

**Вызывает исключения**:
- `Exception`: Возникает при возникновении ошибки во время отправки письма, например, при проблемах с подключением к SMTP-серверу или аутентификацией.

**Как работает функция**:
1. Функция создает SMTP-соединение с использованием параметров, хранящихся в словаре `_connection`.
2. Выполняет рукопожатие с сервером (`ehlo()`) и запускает шифрование соединения (`starttls()`).
3. Выполняет вход в SMTP-сервер, используя имя пользователя и пароль из `_connection`.
4. Создает объект `MIMEText` с телом письма и устанавливает заголовок `Subject`, `From` и `To`.
5. Отправляет письмо, используя метод `sendmail()`.
6. Закрывает соединение с SMTP-сервером.
7. В случае возникновения ошибки, функция логирует её с помощью `logger.error` и возвращает `False`.

**ASCII Flowchart**:

```
Начало
  │
  ├─> Создание SMTP-соединения
  │
  ├─> Рукопожатие и шифрование (ehlo(), starttls())
  │
  ├─> Вход в SMTP-сервер (login())
  │
  ├─> Создание сообщения MIMEText
  │
  ├─> Установка заголовков (Subject, From, To)
  │
  ├─> Отправка сообщения (sendmail())
  │
  ├─> Закрытие соединения (quit())
  │
  └─> Конец (Возврат True)
  │
  └─> Ошибка (Логирование, возврат False)
```

**Примеры**:

```python
# Отправка простого письма
send(subject='Тестовое письмо', body='Это тело тестового письма.', to='recipient@example.com')

# Отправка письма с использованием параметров по умолчанию
send()
```

### `receive`

```python
def receive(imap_server: str, user: str, password: str, folder: str = 'inbox') -> Optional[List[Dict[str, str]]]:
    """Получает электронные письма из указанной папки IMAP-сервера.

    Args:
        imap_server (str): Адрес IMAP-сервера.
        user (str): Имя пользователя для входа в IMAP-сервер.
        password (str): Пароль для входа в IMAP-сервер.
        folder (str, optional): Папка для чтения писем. По умолчанию 'inbox'.

    Returns:
        Optional[List[Dict[str, str]]]: Список словарей, каждый из которых содержит тему, отправителя и тело письма.
                                         Возвращает None в случае ошибки.

    Raises:
        Exception: Если произошла ошибка при получении писем.

    Пример:
        >>> receive(imap_server='imap.example.com', user='user', password='password', folder='inbox')
        [{'subject': 'Тест', 'from': 'sender@example.com', 'body': 'Это тестовое письмо'}]
    """
```

**Назначение**: Функция получает электронные письма из указанной папки IMAP-сервера и возвращает их в виде списка словарей.

**Параметры**:
- `imap_server` (str): Адрес IMAP-сервера.
- `user` (str): Имя пользователя для входа в IMAP-сервер.
- `password` (str): Пароль для входа в IMAP-сервер.
- `folder` (str): Папка для чтения писем. По умолчанию 'inbox'.

**Возвращает**:
- `Optional[List[Dict[str, str]]]`: Возвращает список словарей, где каждый словарь содержит информацию о письме (тема, отправитель, тело). Возвращает `None` в случае ошибки.

**Вызывает исключения**:
- `Exception`: Возникает при возникновении ошибки во время получения писем, например, при проблемах с подключением к IMAP-серверу, аутентификацией или доступом к папке.

**Как работает функция**:
1. Функция устанавливает защищенное SSL-соединение с IMAP-сервером.
2. Выполняет вход в IMAP-сервер, используя имя пользователя и пароль.
3. Выбирает указанную папку (`folder`).
4. Выполняет поиск всех писем в выбранной папке.
5. Для каждого найденного письма извлекает его содержимое в формате RFC822.
6. Преобразует полученное содержимое в объект `email.message_from_bytes`.
7. Извлекает тему, отправителя и тело письма. Тело письма декодируется из байтов в строку, обрабатывая возможные ошибки кодировки.
8. Добавляет информацию о письме в список `emails`.
9. Закрывает соединение с IMAP-сервером и выходит из системы.
10. Возвращает список словарей с данными о письмах.
11. В случае возникновения ошибки, функция логирует её с помощью `logger.error` и возвращает `None`.

**ASCII Flowchart**:

```
Начало
  │
  ├─> Установка IMAP4_SSL соединения
  │
  ├─> Вход в IMAP-сервер (login())
  │
  ├─> Выбор папки (select())
  │
  ├─> Поиск писем (search())
  │
  │   Цикл по найденным письмам:
  │   │
  │   ├─> Извлечение содержимого (fetch())
  │   │
  │   ├─> Преобразование в email.message_from_bytes
  │   │
  │   ├─> Извлечение темы, отправителя, тела
  │   │
  │   └─> Добавление в список emails
  │
  │   Конец цикла
  │
  ├─> Закрытие соединения (close(), logout())
  │
  └─> Конец (Возврат списка emails)
  │
  └─> Ошибка (Логирование, возврат None)
```

**Примеры**:

```python
# Получение писем из папки "inbox"
receive(imap_server='imap.example.com', user='user@example.com', password='password', folder='inbox')

# Получение писем из другой папки
receive(imap_server='imap.example.com', user='user@example.com', password='password', folder='spam')
```