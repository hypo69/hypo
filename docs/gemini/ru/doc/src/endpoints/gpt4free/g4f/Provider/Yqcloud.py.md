# Модуль Yqcloud

## Обзор

Модуль `Yqcloud` предоставляет асинхронный генератор для взаимодействия с провайдером Yqcloud, который использует API `api.binjie.fun` для генерации текстовых ответов. Модуль поддерживает стриминг ответов, системные сообщения и историю сообщений.

## Подробней

Этот модуль предназначен для асинхронного взаимодействия с API Yqcloud, предоставляя функциональность для генерации текста на основе предоставленных сообщений. Он включает поддержку стриминга, что позволяет получать ответы по частям, а также возможность использования системных сообщений и ведения истории переписки.

## Классы

### `Conversation`

**Описание**: Класс `Conversation` используется для хранения информации о текущем диалоге, включая ID пользователя и историю сообщений.

**Принцип работы**:
Класс хранит информацию о текущем диалоге с пользователем, включая его ID и историю сообщений. ID пользователя генерируется на основе текущего времени, что обеспечивает его уникальность.

**Методы**:
- `__init__(self, model: str)`:
    - **Назначение**: Инициализирует объект `Conversation` с указанной моделью.
    - **Параметры**:
        - `model` (str): Модель, используемая в разговоре.
    - **Как работает функция**:
        1. Присваивает переданное значение параметра `model` атрибуту `self.model`.
        2. Генерирует уникальный `userId` на основе текущего времени и присваивает его атрибуту `self.userId`.
    - **Примеры**:
        ```python
        conversation = Conversation(model="gpt-4")
        print(conversation.model)  # gpt-4
        print(conversation.userId)  # Пример: #/chat/1678886400000
        ```

### `Yqcloud`

**Описание**: Класс `Yqcloud` предоставляет функциональность для взаимодействия с API Yqcloud.

**Принцип работы**:
Класс реализует асинхронный генератор, который отправляет запросы к API Yqcloud и возвращает сгенерированный текст. Поддерживается стриминг, системные сообщения и история сообщений.

**Атрибуты**:
- `url` (str): URL провайдера Yqcloud (`https://chat9.yqcloud.top`).
- `api_endpoint` (str): URL API для генерации текста (`https://api.binjie.fun/api/generateStream`).
- `working` (bool): Указывает, работает ли провайдер (всегда `True`).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер стриминг (всегда `True`).
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения (всегда `True`).
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений (всегда `True`).
- `default_model` (str): Модель по умолчанию (`gpt-4`).
- `models` (list[str]): Список поддерживаемых моделей (только `default_model`).

**Методы**:
- `create_async_generator`
    - **Описание**: Асинхронный генератор, который отправляет запросы к API Yqcloud и возвращает сгенерированный текст.
    - **Параметры**:
        - `model` (str): Модель для генерации текста.
        - `messages` (Messages): Список сообщений для отправки.
        - `stream` (bool, optional): Флаг, указывающий, использовать ли стриминг. По умолчанию `True`.
        - `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
        - `conversation` (Conversation, optional): Объект `Conversation` для хранения истории сообщений. По умолчанию `None`.
        - `return_conversation` (bool, optional): Флаг, указывающий, возвращать ли объект `Conversation` после завершения. По умолчанию `False`.

    - **Возвращает**:
        - `AsyncResult`: Асинхронный генератор, возвращающий сгенерированный текст.

    - **Как работает функция**:
        1. Извлекает модель, используя `cls.get_model(model)`.
        2. Формирует заголовки запроса, включая `origin` и `referer` с использованием `cls.url`.
        3. Если `conversation` не предоставлен, создает новый объект `Conversation`.
        4. Добавляет последнее сообщение в историю `conversation.message_history`.
        5. Извлекает системное сообщение из списка сообщений, если оно присутствует.
        6. Форматирует промпт, используя `format_prompt(current_messages)`.
        7. Формирует данные для отправки в API, включая `prompt`, `userId`, `network`, `system`, `withoutContext` и `stream`.
        8. Отправляет POST-запрос к `cls.api_endpoint` с использованием `ClientSession`.
        9. Получает чанки ответа и декодирует их, возвращая каждый чанк с использованием `yield message`.
        10. Если `return_conversation` установлен в `True`, добавляет ответ ассистента в историю сообщений и возвращает объект `Conversation`.
        11. Возвращает `FinishReason("stop")` для завершения генератора.

    - **Примеры**:

        ```python
        from src.endpoints.gpt4free.g4f.Provider.Yqcloud import Yqcloud
        from src.endpoints.gpt4free.g4f.typing import Messages
        import asyncio

        async def test():
            messages: Messages = [{"role": "user", "content": "Привет, как дела?"}]
            async for message in Yqcloud.create_async_generator(model="gpt-4", messages=messages):
                print(message, end="")

        asyncio.run(test())
        ```

## Функции

В данном модуле нет отдельных функций, кроме методов классов. Все основные операции выполняются внутри класса `Yqcloud` и его методов.