# Модуль для поиска свободного порта

## Обзор

Модуль `get_free_port.py` предоставляет функциональность для поиска свободного порта на указанном хосте. Он позволяет указать диапазон портов для поиска или найти первый доступный порт, если диапазон не задан.

## Подробней

Этот модуль предназначен для использования в приложениях, которым необходимо динамически находить свободные порты для сетевых соединений. Он предоставляет удобный способ избежать конфликтов портов и обеспечивает гибкость в выборе доступных портов. Модуль использует сокеты для проверки занятости портов и предоставляет функции для разбора диапазонов портов. Расположение файла: `hypotez/src/utils/get_free_port.py` указывает на то, что он является частью утилитного функционала проекта `hypotez`.

## Функции

### `get_free_port`

```python
def get_free_port(host: str, port_range: Optional[str | List[str]] = None) -> int:
    """
    Finds and returns a free port within the specified range, or the first available port if no range is given.

    Args:
        host (str): The host address to check for available ports.
        port_range (Optional[str | List[str]], optional): A port range specified as a string "min-max" or a list of strings.
               E.g.: "3000-3999", ["3000-3999", "8000-8010"], None. Defaults to `None`.

    Returns:
        int: An available port number.

    Raises:
        ValueError: If no free port can be found within the specified range, or if the port range is invalid.
    """
```

**Описание**: Находит и возвращает свободный порт в указанном диапазоне или первый доступный порт, если диапазон не указан.

**Параметры**:
- `host` (str): Адрес хоста для проверки доступных портов.
- `port_range` (Optional[str | List[str]], optional): Диапазон портов, указанный как строка "min-max" или список строк. Например: "3000-3999", ["3000-3999", "8000-8010"], None. По умолчанию `None`.

**Возвращает**:
- `int`: Доступный номер порта.

**Вызывает исключения**:
- `ValueError`: Если не удается найти свободный порт в указанном диапазоне или если диапазон портов недействителен.

**Как работает функция**:

```
    +---------------------+
    |   get_free_port     |
    +---------------------+
    | host: str           |
    | port_range: Optional[str | List[str]] |
    +---------------------+
    | Проверка port_range |
    +---------------------+
    |  port_range is None?|
    +-------NO------------+
    |  port_range is str? |
    +-------YES-----------+
    |  _parse_port_range  |
    +---------------------+
    | Перебор портов      |
    +---------------------+
    | _is_port_in_use     |
    +---------------------+
    | Порт свободен?      |
    +-------YES-----------+
    |  Возврат port       |
    +---------------------+
    |  Исключение         |
    +---------------------+
    |  port_range is list?|
    +-------YES-----------+
    |  Перебор item in    |
    |     port_range      |
    +---------------------+
    |   item is str?      |
    +-------YES-----------+
    |  _parse_port_range  |
    +---------------------+
    | Перебор портов      |
    +---------------------+
    | _is_port_in_use     |
    +---------------------+
    | Порт свободен?      |
    +-------YES-----------+
    |  Возврат port       |
    +---------------------+
    |  Исключение         |
    +---------------------+
    |port_range is other? |
    +-------YES-----------+
    |  Выброс исключения  |
    +---------------------+
    | Выброс исключения  |
    +---------------------+
    |  port_range is None?|
    +-------YES-----------+
    |Поиск первого        |
    |свободного порта     |
    +---------------------+
    | _is_port_in_use     |
    +---------------------+
    | Порт свободен?      |
    +-------YES-----------+
    |  Возврат port       |
    +---------------------+
    |  Исключение         |
    +---------------------+

```

**Примеры**:

```python
get_free_port('localhost', '3000-3005')
get_free_port('localhost', ['3000-3005', '8000-8010'])
get_free_port('localhost')
```

### `_is_port_in_use`

```python
def _is_port_in_use(host: str, port: int) -> bool:
    """
    Checks if a given port is in use on the specified host.

    Args:
        host (str): The host address.
        port (int): The port number to check.

    Returns:
        bool: True if the port is in use, False otherwise.
    """
```

**Описание**: Проверяет, используется ли данный порт на указанном хосте.

**Параметры**:
- `host` (str): Адрес хоста.
- `port` (int): Номер порта для проверки.

**Возвращает**:
- `bool`: `True`, если порт используется, `False` в противном случае.

**Как работает функция**:
Функция создает сокет и пытается привязать его к указанному хосту и порту. Если привязка успешна, это означает, что порт свободен, и функция возвращает `False`. Если привязка вызывает исключение `OSError`, это означает, что порт используется, и функция возвращает `True`.

### `_parse_port_range`

```python
def _parse_port_range(port_range_str: str) -> Tuple[int, int]:
    """
    Parses port range string "min-max" into a tuple (min_port, max_port).

    Args:
        port_range_str (str): The port range string.

    Returns:
        Tuple[int, int]: A tuple containing minimum and maximum port numbers.

    Raises:
        ValueError: If the port range string format is invalid.
    """
```

**Описание**: Разбирает строку диапазона портов "min-max" в кортеж (min_port, max_port).

**Параметры**:
- `port_range_str` (str): Строка диапазона портов.

**Возвращает**:
- `Tuple[int, int]`: Кортеж, содержащий минимальный и максимальный номера портов.

**Вызывает исключения**:
- `ValueError`: Если формат строки диапазона портов недействителен.

**Как работает функция**:
Функция разделяет строку `port_range_str` на две части по символу "-". Если разделение дает не две части, или если минимальный порт больше или равен максимальному, функция логирует ошибку и выбрасывает исключение `ValueError`. В противном случае функция преобразует обе части в целые числа и возвращает их в виде кортежа.
```
    +-------------------------+
    |   _parse_port_range     |
    +-------------------------+
    | port_range_str: str     |
    +-------------------------+
    | Разделение строки по "-"|
    +-------------------------+
    | parts = port_range_str.split('-') |
    +-------------------------+
    | Проверка len(parts) == 2|
    +---------NO--------------+
    |  Выброс ValueError       |
    +-------------------------+
    | Преобразование в int    |
    +-------------------------+
    | Проверка min_port >= max_port|
    +---------YES-------------+
    |  Выброс ValueError       |
    +-------------------------+
    | Возврат (min_port, max_port)|
    +-------------------------+