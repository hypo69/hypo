# Модуль для выполнения инструментов (tools) в g4f

## Обзор

Модуль `run_tools.py` предназначен для обработки запросов, требующих использования различных инструментов (tools), таких как поиск в интернете, продолжение генерации текста и доступ к хранилищу (bucket). Он содержит классы и функции для управления API-ключами, обработки этапов мышления (thinking) в ответах модели и выполнения веб-поиска. Модуль асинхронный, что позволяет эффективно обрабатывать запросы, требующие ожидания ответа от внешних сервисов.

## Подробнее

Модуль содержит следующие классы:

- `ToolHandler`: Обрабатывает различные типы инструментов.
- `AuthManager`: Управляет API-ключами для доступа к внешним сервисам.
- `ThinkingProcessor`: Обрабатывает этапы "мышления" в ответах модели.

Модуль также содержит функции для асинхронного и синхронного выполнения инструментов, а также для выполнения веб-поиска.

## Классы

### `ToolHandler`

**Описание**: Обработчик для различных типов инструментов.

**Принцип работы**: Класс `ToolHandler` предоставляет статические методы для обработки различных типов инструментов, таких как поиск в интернете, продолжение генерации текста и доступ к хранилищу. Он отвечает за валидацию аргументов инструментов и вызов соответствующих функций для их выполнения.

**Методы**:

- `validate_arguments(data: dict) -> dict`: Валидирует и парсит аргументы инструментов, представленные в виде словаря или JSON-строки.
- `process_search_tool(messages: Messages, tool: dict) -> Messages`: Обрабатывает запросы к инструменту поиска. Выполняет поиск в интернете на основе содержимого последнего сообщения и возвращает обновленные сообщения с результатами поиска и источниками.
- `process_continue_tool(messages: Messages, tool: dict, provider: Any) -> Tuple[Messages, Dict[str, Any]]`: Обрабатывает запросы к инструменту продолжения генерации текста. Добавляет контекст для продолжения генерации.
- `process_bucket_tool(messages: Messages, tool: dict) -> Messages`: Обрабатывает запросы к инструменту доступа к хранилищу. Заменяет идентификаторы хранилищ на их содержимое.
- `process_tools(messages: Messages, tool_calls: List[dict], provider: Any) -> Tuple[Messages, Dict[str, Any]]`: Обрабатывает список вызовов инструментов и возвращает обновленные сообщения и дополнительные аргументы.

### `AuthManager`

**Описание**: Управление API ключами.

**Принцип работы**: Класс `AuthManager` предоставляет статические методы для управления API-ключами, необходимыми для доступа к некоторым провайдерам (например, OpenAI). Он отвечает за загрузку API-ключей из конфигурационных файлов.

**Методы**:

- `get_api_key_file(cls) -> Path`: Получает путь к файлу, содержащему API-ключ для указанного провайдера.
- `load_api_key(provider: Any) -> Optional[str]`: Загружает API-ключ из конфигурационного файла, если это необходимо для данного провайдера.

### `ThinkingProcessor`

**Описание**: Обработчик этапов "мышления".

**Принцип работы**: Класс `ThinkingProcessor` предоставляет статический метод для обработки этапов "мышления" в ответах модели. Он разделяет текст на части, содержащие индикаторы начала и конца этапа "мышления", и возвращает список объектов `Reasoning`, представляющих эти этапы.

**Методы**:

- `process_thinking_chunk(chunk: str, start_time: float = 0) -> Tuple[float, List[Union[str, Reasoning]]]`: обрабатывает фрагмент текста, содержащий этапы "мышления", и возвращает время начала "мышления" и список результатов.

## Функции

### `perform_web_search`

```python
async def perform_web_search(messages: Messages, web_search_param: Any) -> Tuple[Messages, Optional[Sources]]:
    """Выполняет веб-поиск и возвращает обновленные сообщения и источники."""
    ...
```

**Назначение**: Выполняет поиск в интернете на основе предоставленного запроса и обновляет сообщения с результатами поиска.

**Параметры**:

- `messages` (Messages): Список сообщений, содержащий контекст для поиска.
- `web_search_param` (Any): Параметр, определяющий запрос для поиска.

**Возвращает**:

- `Tuple[Messages, Optional[Sources]]`: Кортеж, содержащий обновленный список сообщений и источники результатов поиска.

**Вызывает исключения**:

- `Exception`: Если не удается выполнить поиск в интернете.

**Как работает функция**:

1.  Функция копирует входной список сообщений, чтобы не изменять исходный.
2.  Проверяет, предоставлен ли параметр `web_search_param`. Если нет, возвращает исходные сообщения и `None` для источников.
3.  Пытается выполнить поиск в интернете с помощью функции `do_search`, передавая ей последний контент сообщения и поисковый запрос, полученный из `web_search_param`.
4.  Обрабатывает возможные исключения при выполнении поиска, логируя ошибку с использованием `debug.error`.
5.  Возвращает обновленные сообщения и источники результатов поиска.

**ASCII flowchart**:

```
A [Проверка web_search_param]
|
B [Выполнение do_search]
|
C [Обработка исключений]
|
D [Возврат результатов]
```

**Примеры**:

```python
messages = [{"role": "user", "content": "Что такое g4f?"}]
web_search_param = "g4f"
updated_messages, sources = await perform_web_search(messages, web_search_param)
print(updated_messages)
print(sources)
```

### `async_iter_run_tools`

```python
async def async_iter_run_tools(
    provider: ProviderType, 
    model: str, 
    messages: Messages, 
    tool_calls: Optional[List[dict]] = None, 
    **kwargs
) -> AsyncIterator:
    """Асинхронно запускает инструменты и выдает результаты."""
    ...
```

**Назначение**: Асинхронно выполняет инструменты (tools) на основе предоставленных параметров и выдает результаты в виде асинхронного итератора.

**Параметры**:

- `provider` (ProviderType): Провайдер, используемый для выполнения запроса.
- `model` (str): Модель, используемая для генерации ответа.
- `messages` (Messages): Список сообщений, представляющих контекст диалога.
- `tool_calls` (Optional[List[dict]], optional): Список вызовов инструментов, которые необходимо выполнить. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы, передаваемые провайдеру.

**Возвращает**:

- `AsyncIterator`: Асинхронный итератор, выдающий результаты выполнения инструментов.

**Как работает функция**:

1.  Функция выполняет веб-поиск, если параметр `web_search` установлен в `kwargs`. Результаты поиска добавляются в список сообщений.
2.  Загружает API-ключ для провайдера, если это необходимо, с помощью `AuthManager.load_api_key`.
3.  Обрабатывает вызовы инструментов, если они предоставлены, с помощью `ToolHandler.process_tools`.
4.  Получает асинхронную функцию создания ответа от провайдера с помощью `provider.get_async_create_function()`.
5.  Создает асинхронный итератор `response` с помощью `to_async_iterator`, который генерирует ответ модели.
6.  Итерируется по чанкам ответа и выдает их.
7.  Выдает источники результатов поиска, если они доступны.

**ASCII flowchart**:

```
A [Выполнение веб-поиска]
|
B [Загрузка API-ключа]
|
C [Обработка вызовов инструментов]
|
D [Получение асинхронной функции создания ответа]
|
E [Создание асинхронного итератора]
|
F [Итерация по чанкам ответа]
|
G [Выдача результатов]
```

**Примеры**:

```python
provider = MyProvider  # Замените на фактический провайдер
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Что такое g4f?"}]
tool_calls = [...]  # Замените на список вызовов инструментов
kwargs = {"web_search": "true"}

async for chunk in async_iter_run_tools(provider, model, messages, tool_calls, **kwargs):
    print(chunk)
```

### `iter_run_tools`

```python
def iter_run_tools(
    iter_callback: Callable,
    model: str,
    messages: Messages,
    provider: Optional[str] = None,
    tool_calls: Optional[List[dict]] = None,
    **kwargs
) -> Iterator:
    """Запускает инструменты синхронно и выдает результаты."""
    ...
```

**Назначение**: Синхронно выполняет инструменты (tools) на основе предоставленных параметров и выдает результаты в виде итератора.

**Параметры**:

-   `iter_callback` (Callable): Функция обратного вызова, которая выполняет итерацию по результатам.
-   `model` (str): Модель, используемая для генерации ответа.
-   `messages` (Messages): Список сообщений, представляющих контекст диалога.
-   `provider` (Optional[str], optional): Провайдер, используемый для выполнения запроса. По умолчанию `None`.
-   `tool_calls` (Optional[List[dict]], optional): Список вызовов инструментов, которые необходимо выполнить. По умолчанию `None`.
-   `**kwargs`: Дополнительные аргументы, передаваемые провайдеру.

**Возвращает**:

-   `Iterator`: Итератор, выдающий результаты выполнения инструментов.

**Как работает функция**:

1.  Функция выполняет веб-поиск, если параметр `web_search` установлен в `kwargs`. Результаты поиска добавляются в список сообщений.
2.  Загружает API-ключ для провайдера, если это необходимо, с помощью `AuthManager.load_api_key`.
3.  Обрабатывает вызовы инструментов, если они предоставлены.
4.  Вызывает функцию `iter_callback` для получения результатов от модели.
5.  Обрабатывает результаты, полученные от `iter_callback`, включая этапы "мышления" и источники результатов поиска.
6.  Выдает обработанные результаты.

**ASCII flowchart**:

```
A [Выполнение веб-поиска]
|
B [Загрузка API-ключа]
|
C [Обработка вызовов инструментов]
|
D [Вызов iter_callback]
|
E [Обработка результатов]
|
F [Выдача результатов]
```

**Примеры**:

```python
def my_iter_callback(model: str, messages: Messages, provider: str, **kwargs):
    # Здесь должна быть логика для получения результатов от модели
    yield "Результат 1"
    yield "Результат 2"

model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Что такое g4f?"}]
tool_calls = [...]  # Замените на список вызовов инструментов
kwargs = {"web_search": "true"}

for chunk in iter_run_tools(my_iter_callback, model, messages, "MyProvider", tool_calls, **kwargs):
    print(chunk)