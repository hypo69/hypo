# Модуль `AIChatFree`

## Обзор

Модуль `AIChatFree` предоставляет асинхронный интерфейс для взаимодействия с сервисом AIChatFree. Он позволяет генерировать текст на основе предоставленных сообщений, используя модель `gemini-1.5-pro`. Модуль поддерживает потоковую передачу данных и сохранение истории сообщений.

## Подробнее

Этот модуль предназначен для интеграции с сервисом AIChatFree для генерации текста на основе входных данных. Он использует асинхронные запросы для взаимодействия с API сервиса и предоставляет возможность потоковой передачи данных. Модуль также включает функциональность для обработки ошибок, таких как превышение лимита запросов.

## Классы

### `AIChatFree`

**Описание**: Класс `AIChatFree` является асинхронным провайдером, реализующим взаимодействие с сервисом AIChatFree.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет функциональность для работы с моделями.

**Атрибуты**:
- `url` (str): URL сервиса AIChatFree (`https://aichatfree.info`).
- `working` (bool): Указывает, работает ли провайдер (в данном случае `False`).
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных (`True`).
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений (`True`).
- `default_model` (str): Модель, используемая по умолчанию (`gemini-1.5-pro`).

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для получения ответов от сервиса.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    connector: BaseConnector = None,
    **kwargs,
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения ответов от сервиса AIChatFree.

    Args:
        model (str): Модель, используемая для генерации текста.
        messages (Messages): Список сообщений для отправки в сервис.
        proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
        connector (BaseConnector, optional): Aiohttp коннектор. По умолчанию `None`.
        **kwargs: Дополнительные параметры.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий части ответа от сервиса.

    Raises:
        RateLimitError: Если достигнут лимит запросов.
        Exception: При возникновении других ошибок при выполнении запроса.
    """
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор, который отправляет сообщения в сервис AIChatFree и возвращает сгенерированный текст частями.

**Параметры**:
- `cls`: Ссылка на класс `AIChatFree`.
- `model` (str): Модель, используемая для генерации текста.
- `messages` (Messages): Список сообщений, где каждое сообщение представляет собой словарь с ключами "role" (роль отправителя: "user" или "assistant") и "content" (текст сообщения).
- `proxy` (str, optional): Адрес прокси-сервера для использования при отправке запроса. По умолчанию `None`.
- `connector` (BaseConnector, optional): Объект коннектора `aiohttp` для управления соединениями. По умолчанию `None`.
- `**kwargs`: Дополнительные именованные аргументы, которые могут быть переданы в функцию.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который при итерации возвращает части сгенерированного текста.

**Вызывает исключения**:
- `RateLimitError`: Вызывается, если сервис возвращает ошибку, указывающую на превышение лимита запросов (статус код 500 и сообщение "Quota exceeded" в ответе).
- `Exception`: Вызывается, если при выполнении запроса возникает любая другая ошибка.

**Как работает функция**:
1. **Определение заголовков**: Создаются заголовки запроса, включающие User-Agent, Accept, Accept-Language, Accept-Encoding, Content-Type, Referer и Origin.
2. **Создание сессии**: Создается асинхронная сессия `aiohttp` с использованием предоставленного коннектора и заголовков.
3. **Формирование данных**: Преобразуется список сообщений в формат, требуемый API AIChatFree. Добавляются временная метка и подпись.
4. **Отправка запроса**: Отправляется POST-запрос к API AIChatFree с сформированными данными.
5. **Обработка ответа**:
   - Проверяется статус ответа. Если статус равен 500 и в тексте ответа содержится "Quota exceeded", вызывается исключение `RateLimitError`.
   - В случае успешного ответа, содержимое ответа итерируется по частям (chunks).
   - Каждая часть декодируется из байтов в строку и возвращается через `yield`.

```
A: Определение заголовков запроса
|
B: Создание асинхронной сессии aiohttp
|
C: Преобразование списка сообщений в формат API AIChatFree + добавление timestamp и подписи
|
D: Отправка POST-запроса к API AIChatFree
|
E: Проверка статуса ответа и текста на наличие "Quota exceeded"
|
F: Итерация по частям ответа (chunks), декодирование и выдача через yield
```

**Примеры**:

Пример 1: Базовый вызов функции с минимальным набором параметров.

```python
messages = [{"role": "user", "content": "Hello, how are you?"}]
async for chunk in AIChatFree.create_async_generator(model="gemini-1.5-pro", messages=messages):
    print(chunk, end="")
```

Пример 2: Использование прокси-сервера.

```python
messages = [{"role": "user", "content": "Tell me a joke."}]
async for chunk in AIChatFree.create_async_generator(model="gemini-1.5-pro", messages=messages, proxy="http://proxy.example.com:8080"):
    print(chunk, end="")
```

Пример 3: Обработка ошибки RateLimitError.

```python
messages = [{"role": "user", "content": "Generate a long text."}]
try:
    async for chunk in AIChatFree.create_async_generator(model="gemini-1.5-pro", messages=messages):
        print(chunk, end="")
except RateLimitError as ex:
    print(f"Rate limit reached: {ex}")
```

### `generate_signature`

```python
def generate_signature(time: int, text: str, secret: str = ""):
    """
    Генерирует подпись для запроса к API AIChatFree.

    Args:
        time (int): Временная метка.
        text (str): Текст сообщения.
        secret (str, optional): Секретный ключ. По умолчанию "".

    Returns:
        str: Сгенерированная подпись в виде шестнадцатеричной строки.
    """
```

**Назначение**: Функция `generate_signature` генерирует подпись (signature) для запроса к API AIChatFree. Подпись создается на основе временной метки, текста сообщения и секретного ключа.

**Параметры**:
- `time` (int): Временная метка (timestamp) в формате целого числа.
- `text` (str): Текст сообщения, используемый для генерации подписи.
- `secret` (str, optional): Секретный ключ (secret key), используемый для генерации подписи. По умолчанию имеет значение "".

**Возвращает**:
- `str`: Сгенерированная подпись в виде шестнадцатеричной строки (hexdigest).

**Как работает функция**:
1. **Формирование сообщения**: Формируется строка сообщения путем конкатенации временной метки, текста и секретного ключа в формате "time:text:secret".
2. **Кодирование сообщения**: Строка сообщения кодируется в байты, используя кодировку UTF-8.
3. **Вычисление SHA256**: Вычисляется SHA256 хеш закодированного сообщения.
4. **Форматирование подписи**: Хеш преобразуется в шестнадцатеричную строку.

```
A: Формирование строки сообщения "time:text:secret"
|
B: Кодирование строки в байты (UTF-8)
|
C: Вычисление SHA256 хеша
|
D: Преобразование хеша в шестнадцатеричную строку
```

**Примеры**:

Пример 1: Генерация подписи с использованием временной метки и текста.

```python
import time
timestamp = int(time.time() * 1e3)
text = "Hello"
signature = generate_signature(timestamp, text)
print(signature)
```

Пример 2: Генерация подписи с использованием временной метки, текста и секретного ключа.

```python
import time
timestamp = int(time.time() * 1e3)
text = "Hello"
secret = "mysecretkey"
signature = generate_signature(timestamp, text, secret)
print(signature)