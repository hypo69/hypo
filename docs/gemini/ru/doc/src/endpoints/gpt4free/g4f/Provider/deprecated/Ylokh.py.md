# Модуль Ylokh
## Обзор

Модуль `Ylokh` предоставляет асинхронный генератор для взаимодействия с API `chat.ylokh.xyz`. Этот модуль предназначен для обмена сообщениями с использованием модели GPT-3.5-turbo и поддерживает потоковую передачу данных. Модуль считается устаревшим.

## Подробней
Модуль `Ylokh` является асинхронным поставщиком генераторов, который использует API `chat.ylokh.xyz` для обмена сообщениями. Он поддерживает потоковую передачу данных и предназначен для использования с моделью `gpt-3.5-turbo`. Этот модуль интегрируется в проект `hypotez` для обеспечения функциональности чата с использованием указанного API.

## Классы

### `Ylokh`

**Описание**: Класс `Ylokh` является асинхронным поставщиком генераторов, предназначенным для взаимодействия с API `chat.ylokh.xyz`.

**Наследует**:
- `AsyncGeneratorProvider`: Наследует функциональность асинхронного поставщика генераторов.

**Атрибуты**:
- `url` (str): URL-адрес API `chat.ylokh.xyz`.
- `working` (bool): Указывает, работает ли провайдер (в данном случае `False`).
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений (в данном случае `True`).
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель `gpt-3.5-turbo` (в данном случае `True`).

**Методы**:
- `create_async_generator`: Асинхронный метод-генератор для создания потока сообщений с использованием API `chat.ylokh.xyz`.

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        stream: bool = True,
        proxy: str = None,
        timeout: int = 120,
        **kwargs
    ) -> AsyncResult:
        """ Функция создает асинхронный генератор для обмена сообщениями с использованием API `chat.ylokh.xyz`.

        Args:
            model (str): Имя используемой модели. Если не указано, используется `gpt-3.5-turbo`.
            messages (Messages): Список сообщений для отправки в API.
            stream (bool, optional): Определяет, использовать ли потоковую передачу данных. По умолчанию `True`.
            proxy (str, optional): Адрес прокси-сервера для использования. По умолчанию `None`.
            timeout (int, optional): Время ожидания ответа от API в секундах. По умолчанию `120`.
            **kwargs: Дополнительные параметры для передачи в API.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий текстовые фрагменты от API.

        Raises:
            Exception: Если возникает ошибка при запросе к API.
        """
```

**Назначение**:
Создает асинхронный генератор для обмена сообщениями с использованием API `chat.ylokh.xyz`. Функция отправляет сообщения в API и получает ответы, обрабатывая их потоково или целиком, в зависимости от параметра `stream`.

**Параметры**:
- `model` (str): Имя используемой модели. Если не указано, используется `gpt-3.5-turbo`.
- `messages` (Messages): Список сообщений для отправки в API.
- `stream` (bool, optional): Определяет, использовать ли потоковую передачу данных. По умолчанию `True`.
- `proxy` (str, optional): Адрес прокси-сервера для использования. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания ответа от API в секундах. По умолчанию `120`.
- `**kwargs`: Дополнительные параметры для передачи в API.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий текстовые фрагменты от API.

**Вызывает исключения**:
- `Exception`: Если возникает ошибка при запросе к API.

**Внутренние функции**: Нет.

**Как работает функция**:

1. **Инициализация параметров**:
   - Функция принимает параметры, такие как имя модели, список сообщений, флаг потоковой передачи, прокси и таймаут.
   - Если имя модели не указано, используется значение по умолчанию `gpt-3.5-turbo`.

2. **Формирование заголовков и данных**:
   - Формируются заголовки HTTP-запроса, включающие `Origin` и `Referer` с URL-адресом API.
   - Формируются данные для отправки в теле запроса, включающие сообщения, модель, параметры температуры, штрафы за присутствие и частоту, разрешение на резервный вариант и флаг потоковой передачи.
   - Если переданы дополнительные параметры `kwargs`, они также включаются в данные запроса.

3. **Отправка запроса и обработка ответа**:
   - Используется асинхронная сессия `StreamSession` для отправки POST-запроса к API `https://chatapi.ylokh.xyz/v1/chat/completions`.
   - Если `stream` установлен в `True`:
     - Ответ обрабатывается построчно.
     - Каждая строка декодируется.
     - Если строка начинается с `data: `, она загружается как JSON.
     - Из JSON извлекается содержимое сообщения и передается в генератор.
     - Если строка `data: [DONE]`, обработка прекращается.
   - Если `stream` установлен в `False`:
     - Ответ загружается как JSON.
     - Из JSON извлекается содержимое сообщения и возвращается.

4. **Обработка ошибок**:
   - Если возникает HTTP-ошибка, вызывается исключение `response.raise_for_status()`.

```
Инициализация параметров
│
├── Формирование заголовков и данных
│   │
│   └── Отправка POST-запроса к API
│       │
│       ├── stream == True?
│       │   ├── Да: Обработка потокового ответа
│       │   │   │
│       │   │   ├── data: [DONE]?
│       │   │   │   ├── Да: Завершение обработки
│       │   │   │   └── Нет: Извлечение и передача содержимого
│       │   │   └── Нет: Обработка полного ответа
│       │   └── exception:
│       │       └── exception.response.raise_for_status()
│       │
│       └── async_result: текстовые фрагменты или содержимое сообщения
│
└── Возврат async_result
```

**Примеры**:

```python
# Пример использования create_async_generator с потоковой передачей
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Hello, how are you?"}]
stream = True
proxy = None
timeout = 120

async def main():
    async for message in Ylokh.create_async_generator(model=model, messages=messages, stream=stream, proxy=proxy, timeout=timeout):
        print(message, end="")

# Пример использования create_async_generator без потоковой передачи
model = "gpt-3.5-turbo"
messages = [{"role": "user", "content": "Tell me a joke."}]
stream = False
proxy = None
timeout = 120

async def main():
    result = await Ylokh.create_async_generator(model=model, messages=messages, stream=stream, proxy=proxy, timeout=timeout)
    print(result)