# Сценарии обработки ответов от модели Gemini

## Обзор

Этот документ описывает сценарии обработки ответов от модели Gemini. Он детально описывает возможные взаимодействия пользователя с моделью, обработку запросов и ответы, включая варианты ошибок и повторных попыток.

## Диаграмма состояний

```mermaid
sequenceDiagram
    participant User
    participant AI_Model
    participant Logger

    User->>AI_Model: Запрос на обработку продуктов (products_list)
    AI_Model->>AI_Model: Обработка запроса с командой модели
    AI_Model->>User: Ответ от модели

    alt Нет ответа от модели
        Logger->>Logger: Логирирование ошибки "no response from gemini"
        User->>AI_Model: Повторный запрос (attempts - 1)
    end

    alt Невалидные данные (data)
        Logger->>Logger: Логирирование ошибки "Error in data from gemini"
        User->>AI_Model: Повторный запрос (attempts - 1)
    end

    alt Получены данные (data)
        alt Данные в виде списка
            alt Два элемента (ru, he)
                User->>User: Извлечение ru и he
            end
            alt Один элемент
                User->>User: Извлечение ru и he из первого элемента
            end
            alt Невалидная структура данных
                Logger->>Logger: Логирирование ошибки "Проблема парсинга ответа"
                User->>AI_Model: Повторный запрос (attempts - 1)
            end
        end

        alt Данные в виде объекта
            User->>User: Извлечение ru и he из объекта
        end

        alt Невалидные значения (ru или he)
            Logger->>Logger: Логирирование ошибки "Invalid ru or he data"
            User->>AI_Model: Повторный запрос (attempts - 1)
        end

        User->>User: Возврат результата ru и he
    end
```

## Обработка ответов

### Типы ответов

Модель Gemini может возвращать данные в разных форматах (список, объект).  Важная задача - проверка соответствия ожидаемому формату.

### Обработка ошибок

#### Нет ответа от модели

В случае отсутствия ответа от модели происходит логирование ошибки "no response from gemini" и повторный запрос с уменьшением количества попыток.

#### Невалидные данные

Если полученные данные не соответствуют ожидаемому формату или содержат ошибки, происходит логирование ошибки "Error in data from gemini".  В таком случае делается повторный запрос.

#### Невалидные значения (ru или he)

Если значения `ru` или `he` невалидны (например, пустые или не в том формате), то регистрируется ошибка "Invalid ru or he data". После чего запрос повторяется.


#### Проблема парсинга ответа

В случае, если структура данных не соответствует ожидаемому формату (не список или объект, а что-то другое), происходит логирование ошибки "Проблема парсинга ответа". Запрос повторяется.


##  Извлечение данных

### Список элементов

Если данные получены в виде списка, требуется определить количество элементов и провести извлечение `ru` и `he` в соответствии с количеством элементов.

#### Два элемента (ru, he)

Для случаев, когда в списке два элемента, необходимо извлечь данные для `ru` и `he`.

#### Один элемент

Если в списке один элемент, необходимо извлечь значения `ru` и `he` из этого элемента.


### Объект

Если ответ модели – объект, необходимо извлечь значения `ru` и `he` из соответствующих полей объекта.


## Выводы

Этот сценарий описывает полную процедуру обработки ответов от модели Gemini, включая различные варианты ошибок и их обработку.  Важным моментом является логгирование ошибок для отслеживания проблем и диагностики.