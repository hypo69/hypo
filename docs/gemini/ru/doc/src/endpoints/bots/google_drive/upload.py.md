# Модуль для загрузки файлов в Google Drive

## Обзор

Модуль предоставляет функциональность для загрузки файлов в Google Drive с использованием библиотеки `PyDrive`. Он включает в себя аутентификацию, создание папок (если они не существуют) и загрузку файлов. Модуль предназначен для интеграции с другими частями проекта `hypotez`, позволяя пользователям загружать файлы непосредственно в Google Drive.

## Подробней

Модуль `upload.py` предоставляет функцию `upload`, которая позволяет загружать файлы в Google Drive, создавая необходимые папки при необходимости. Он использует библиотеку `PyDrive` для взаимодействия с Google Drive API.
Процесс аутентификации выполняется с использованием сохраненных учетных данных пользователя, что позволяет автоматизировать загрузку файлов.
Если указана папка TeamDrive, файлы загружаются в TeamDrive, иначе - в личный Google Drive пользователя.
Модуль также устанавливает разрешения на чтение для загруженных файлов, чтобы сделать их общедоступными по ссылке.

## Функции

### `upload`

```python
def upload(filename: str, update, context, parent_folder: str = None) -> None:
    """
    Загружает файл в Google Drive, создавая папку, если она не существует.
    Args:
        filename (str): Полный путь к файлу, который нужно загрузить.
        update: Объект `update` от Telegram API, содержащий информацию о пользователе, выполняющем загрузку.
        context: Контекст, который может содержать дополнительную информацию о текущем состоянии или окружении.
        parent_folder (str, optional): Название папки в Google Drive, куда нужно загрузить файл. По умолчанию `None`, что означает загрузку в корень диска.
    Returns:
        None: Функция ничего не возвращает явно, но в случае успеха возвращает ссылку для скачивания файла.
    Raises:
        Exception: Если во время загрузки возникают какие-либо ошибки, они перехватываются и выводятся в консоль.
    """
```

**Назначение**:
Функция `upload` загружает указанный файл в Google Drive пользователя, предварительно выполняя аутентификацию и создавая папку назначения при необходимости. Она адаптирована для работы в контексте Telegram-бота, используя информацию о пользователе из объекта `update` для аутентификации.

**Параметры**:
- `filename` (str): Путь к файлу, который необходимо загрузить в Google Drive.
- `update`: Объект, содержащий информацию о пользователе Telegram, запросившем загрузку файла. Используется для идентификации и аутентификации пользователя.
- `context`: Контекст, который может содержать дополнительную информацию о текущем состоянии или окружении.
- `parent_folder` (str, optional): Имя папки в Google Drive, в которую следует загрузить файл. Если не указана, файл загружается в корневую папку Google Drive. По умолчанию `None`.

**Возвращает**:
- `None`: Функция явно ничего не возвращает, но в случае успешной загрузки устанавливает разрешения на файл и делает его общедоступным по ссылке, а так же вовзращает ссылку для скачивания файла.

**Вызывает исключения**:
- `Exception`: Перехватывает исключения, возникающие в процессе загрузки, и логирует их.

**Как работает функция**:

1.  **Инициализация**: Инициализирует необходимые переменные и объекты, включая `GoogleAuth` и `GoogleDrive`.

2.  **Аутентификация**: Загружает учетные данные пользователя из файла (если они есть) или выполняет аутентификацию. Если срок действия учетных данных истек, они обновляются.

3.  **Подготовка к загрузке**: Проверяет, существует ли указанный файл локально.

4.  **Определение папки назначения**: В зависимости от наличия `Creds.TEAMDRIVE_FOLDER_ID` и `parent_folder` определяет, куда загружать файл: в TeamDrive или в личный Google Drive, в корень или в указанную папку.

5.  **Создание папки (при необходимости)**: Если указана родительская папка, проверяет, существует ли она в Google Drive. Если папка не существует, она создается.

6.  **Загрузка файла**: Загружает файл в Google Drive с указанными параметрами, включая заголовок файла и родительскую папку (если указана).

7.  **Установка разрешений**: Если файл загружен не в TeamDrive, устанавливает разрешение на чтение для всех, у кого есть ссылка.

8.  **Возврат результата**: Явно ничего не возвращает, но устанавливает разрешения на файл и делает его общедоступным по ссылке.

```text
    Начало
    │
    ├──► Инициализация: GoogleAuth, GoogleDrive
    │
    ├──► Аутентификация: Загрузка/обновление учетных данных
    │
    ├──► Проверка файла: Существует ли файл локально?
    │   └──► Нет: Вывод сообщения об ошибке и завершение
    │
    ├──► Определение места загрузки: TeamDrive или личный диск?
    │   └──► TeamDrive: Использовать Creds.TEAMDRIVE_FOLDER_ID
    │   └──► Личный диск: Проверка наличия родительской папки
    │       └──► Папка указана: Проверка существования папки в Drive
    │           └──► Не существует: Создание папки
    │
    ├──► Загрузка файла: Загрузка файла в Google Drive
    │
    ├──► Установка разрешений: Если не TeamDrive, сделать файл общедоступным по ссылке
    │
    └──► Завершение
```

**Примеры**:

```python
# Пример 1: Загрузка файла в корневую папку Google Drive
upload(filename='path/to/file.txt', update=update_object, context=context_object)

# Пример 2: Загрузка файла в указанную папку Google Drive
upload(filename='path/to/file.txt', update=update_object, context=context_object, parent_folder='MyFolder')

# Пример 3: Загрузка файла в TeamDrive (предполагается, что Creds.TEAMDRIVE_FOLDER_ID установлен)
upload(filename='path/to/file.txt', update=update_object, context=context_object)