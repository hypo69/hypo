# Модуль ToolBox_main

## Обзор

Модуль `ToolBox_main.py` является основным файлом для управления Telegram-ботом `ToolBox`. Он обрабатывает различные команды и взаимодействия с пользователем, включая запуск бота, обработку платежей, управление тарифами, текстовые и графические запросы, а также проверку времени окончания подписки.

## Подробней

Этот модуль содержит основные обработчики сообщений и обратных вызовов для Telegram-бота. Он инициализирует объекты `ToolBox` и `DataBase`, подключается к базе данных, обрабатывает команды `/start`, `/profile`, управляет тарифами, обрабатывает текстовые и графические запросы пользователей, а также проверяет время окончания подписки.

## Классы

В данном модуле классы не определены. Здесь происходит инициализация и использование классов `ToolBox` и `DataBase` из других модулей.

## Функции

### `process_pre_checkout_query`

```python
def process_pre_checkout_query(pre_checkout_query: types.PreCheckoutQuery) -> None:
    """
    Args:
        pre_checkout_query (types.PreCheckoutQuery): Объект запроса предварительной проверки платежа.

    Returns:
        None

    """
```

**Описание**: Обрабатывает запросы предварительной проверки платежа.

**Как работает функция**:
Функция `process_pre_checkout_query` обрабатывает запросы предварительной проверки платежа от Telegram. Она всегда отвечает положительно (`ok=True`), подтверждая возможность проведения платежа.

**Параметры**:
- `pre_checkout_query` (types.PreCheckoutQuery): Объект запроса предварительной проверки платежа.

**Возвращает**:
- `None`

### `successful_payment`

```python
@bot.message_handler(content_types=['successful_payment'])
def successful_payment(message: types.Message) -> None:
    """
    Args:
        message (types.Message): Объект сообщения об успешной оплате.

    Returns:
        None

    """
```

**Описание**: Обрабатывает успешные платежи.

**Как работает функция**:
Функция `successful_payment` обрабатывает уведомления об успешной оплате от Telegram. Она определяет, какой тариф был оплачен (basic или pro), обновляет данные пользователя в базе данных (`db`), устанавливает соответствующие флаги (`basic`, `pro`), начисляет токены и устанавливает дату окончания подписки.

**Параметры**:
- `message` (types.Message): Объект сообщения об успешной оплате.

**Возвращает**:
- `None`

### `StartProcessing`

```python
@bot.message_handler(commands=['start'])
def StartProcessing(message: types.Message) -> None:
    """
    Args:
        message (types.Message): Объект сообщения с командой `/start`.

    Returns:
        None

    """
```

**Описание**: Обрабатывает команду `/start`.

**Как работает функция**:
Функция `StartProcessing` обрабатывает команду `/start`, которую отправляет пользователь. Она инициализирует или обновляет данные пользователя в базе данных, используя `DATA_PATTERN`. Если пользователь уже существует в базе данных, его данные обновляются с сохранением информации о подписке, токенах и реферальном коде. Затем вызывается метод `start_request` объекта `tb` (ToolBox) для отображения начального интерфейса.

**Параметры**:
- `message` (types.Message): Объект сообщения с командой `/start`.

**Возвращает**:
- `None`

### `personal_account`

```python
@bot.message_handler(commands=['profile'])
def personal_account(message: types.Message) -> None:
    """
    Args:
        message (types.Message): Объект сообщения с командой `/profile`.

    Returns:
        None

    """
```

**Описание**: Отображает информацию о тарифном плане пользователя.

**Как работает функция**:
Функция `personal_account` обрабатывает команду `/profile` и отображает информацию о тарифном плане пользователя. В зависимости от того, какая подписка активна (BASIC или PRO), отправляется соответствующее сообщение с информацией о текстовых и графических генерациях. Если подписка отсутствует, отображается информация о количестве бесплатных текстовых генераций.

**Параметры**:
- `message` (types.Message): Объект сообщения с командой `/profile`.

**Возвращает**:
- `None`

### `show_stat`

```python
@bot.message_handler(commands=['stat'])
def show_stat(message: types.Message) -> None:
    """
    Args:
        message (types.Message): Объект сообщения с командой `/stat`.

    Returns:
        None

    """
```

**Описание**: Отображает статистику бота (только для администраторов).

**Как работает функция**:
Функция `show_stat` обрабатывает команду `/stat` и отображает статистику бота, такую как общее количество пользователей и количество пользователей с промокодом. Доступ к этой команде ограничен списком идентификаторов пользователей-администраторов.

**Параметры**:
- `message` (types.Message): Объект сообщения с командой `/stat`.

**Возвращает**:
- `None`

### `generate_promo_code`

```python
def generate_promo_code(length: int) -> str:
    """
    Args:
        length (int): Длина генерируемого промокода.

    Returns:
        str: Сгенерированный промокод.

    """
```

**Описание**: Генерирует случайный промокод заданной длины.

**Как работает функция**:
Функция `generate_promo_code` генерирует случайный промокод заданной длины, используя символы из букв и цифр.

**Параметры**:
- `length` (int): Длина генерируемого промокода.

**Возвращает**:
- `str`: Сгенерированный промокод.

### `CallsProcessing`

```python
@bot.callback_query_handler(func=lambda call: True)
def CallsProcessing(call: types.CallbackQuery) -> None:
    """
    Args:
        call (types.CallbackQuery): Объект обратного вызова от нажатия кнопки.

    Returns:
        None

    """
```

**Описание**: Обрабатывает обратные вызовы от нажатия кнопок в боте.

**Как работает функция**:
Функция `CallsProcessing` обрабатывает обратные вызовы (callback queries) от нажатия кнопок в боте. Она определяет, какая кнопка была нажата, и выполняет соответствующие действия, такие как отображение типов текста, выбор размера изображения, обработка тарифов, ввод промокода и т.д. Функция также обновляет данные пользователя в базе данных в соответствии с его действиями.

**Параметры**:
- `call` (types.CallbackQuery): Объект обратного вызова от нажатия кнопки.

**Возвращает**:
- `None`

### `TokensCancelletionPattern`

```python
def TokensCancelletionPattern(user_id: str, func: callable, message: types.Message, i: Optional[int] = None) -> None:
    """
    Args:
        user_id (str): Идентификатор пользователя.
        func (callable): Функция для выполнения.
        message (types.Message): Объект сообщения.
        i (Optional[int], optional): Индекс для передачи в функцию. По умолчанию `None`.

    Returns:
        None

    """
```

**Описание**: Управляет использованием токенов и бесплатных запросов для генерации текста.

**Как работает функция**:
Функция `TokensCancelletionPattern` управляет использованием токенов и бесплатных запросов для генерации текста. Она проверяет, есть ли у пользователя доступные токены или бесплатные запросы, вызывает переданную функцию `func` для выполнения генерации текста и списывает использованные токены или запросы. Если у пользователя заканчиваются токены или запросы, отправляет уведомление о необходимости приобретения тарифа.

**Параметры**:
- `user_id` (str): Идентификатор пользователя.
- `func` (callable): Функция для выполнения (например, `tb.TextCommands` или `tb.FreeCommand`).
- `message` (types.Message): Объект сообщения.
- `i` (Optional[int], optional): Индекс для передачи в функцию (используется для `tb.TextCommands`). По умолчанию `None`.

**Возвращает**:
- `None`

### `TasksProcessing`

```python
@bot.message_handler(func=lambda message: True, content_types=['text', 'photo'])
def TasksProcessing(message: types.Message) -> None:
    """
    Args:
        message (types.Message): Объект сообщения от пользователя.

    Returns:
        None

    """
```

**Описание**: Обрабатывает сообщения от пользователя (текст и фото).

**Как работает функция**:
Функция `TasksProcessing` обрабатывает сообщения от пользователя, будь то текст или фото. Она определяет, находится ли пользователь в режиме генерации изображений или в свободном режиме, и вызывает соответствующие функции для обработки запроса. Если пользователь находится в режиме генерации изображений, функция сохраняет параметры изображения и текст запроса. Если пользователь находится в свободном режиме, обрабатывается текст или фото с использованием `tb.FreeCommand`. Для текстовых запросов вызывается `tb.TextCommands` или `tb.SomeTextsCommand` в зависимости от выбранного типа текста.

**Параметры**:
- `message` (types.Message): Объект сообщения от пользователя.

**Возвращает**:
- `None`

### `end_check_tariff_time`

```python
async def end_check_tariff_time() -> None:
    """

    Returns:
        None

    """
```

**Описание**: Проверяет и обновляет статус подписки пользователей.

**Как работает функция**:
Функция `end_check_tariff_time` асинхронно проверяет время окончания подписки для каждого пользователя в базе данных. Если время окончания подписки истекло, функция сбрасывает данные пользователя к базовым значениям, удаляя информацию о подписке и токенах.

**Параметры**:
- Нет параметров.

**Возвращает**:
- `None`

## Запуск бота

```python
if __name__ == "__main__":
    Thread(target=bot.infinity_polling).start()
    asyncio.run(end_check_tariff_time())
```

**Описание**: Запускает бота и асинхронную задачу проверки времени окончания подписки.

**Как работает**:
При запуске скрипта (`if __name__ == "__main__":`) в отдельном потоке запускается бесконечный цикл обработки входящих сообщений от Telegram (`bot.infinity_polling`). Одновременно запускается асинхронная задача `end_check_tariff_time`, которая периодически проверяет и обновляет статусы подписок пользователей.