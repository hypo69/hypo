# Модуль `Qwen_Qwen_2_5`

## Обзор

Модуль `Qwen_Qwen_2_5` предназначен для взаимодействия с моделью Qwen Qwen-2.5 через API, предоставляемый на платформе Hugging Face Space. Он обеспечивает асинхронную генерацию текста с использованием указанной модели, поддерживая потоковую передачу данных и системные сообщения. Модуль позволяет настраивать прокси-сервер для запросов и обрабатывает ответы в формате JSON для извлечения сгенерированного текста.

## Подробнее

Модуль является асинхронным провайдером, что позволяет ему эффективно обрабатывать запросы без блокировки основного потока выполнения. Он использует библиотеку `aiohttp` для выполнения асинхронных HTTP-запросов. Модуль генерирует уникальные идентификаторы сессий для каждого запроса и поддерживает потоковую передачу данных, что позволяет получать сгенерированный текст по частям.

## Классы

### `Qwen_Qwen_2_5`

**Описание**: Класс `Qwen_Qwen_2_5` реализует взаимодействие с моделью Qwen Qwen-2.5.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает асинхронную генерацию данных.
- `ProviderModelMixin`: Предоставляет общую функциональность для моделей провайдеров.

**Атрибуты**:
- `label` (str): Метка провайдера (Qwen Qwen-2.5).
- `url` (str): URL платформы Hugging Face Space, на которой размещена модель.
- `api_endpoint` (str): URL API для присоединения к очереди запросов.
- `working` (bool): Флаг, указывающий, что провайдер находится в рабочем состоянии.
- `supports_stream` (bool): Флаг, указывающий, что провайдер поддерживает потоковую передачу данных.
- `supports_system_message` (bool): Флаг, указывающий, что провайдер поддерживает системные сообщения.
- `supports_message_history` (bool): Флаг, указывающий, что провайдер поддерживает историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию (qwen-qwen2-5).
- `model_aliases` (dict): Псевдонимы моделей.
- `models` (list): Список поддерживаемых моделей.

**Методы**:
- `create_async_generator()`: Создает асинхронный генератор для получения сгенерированного текста.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для получения сгенерированного текста от модели Qwen Qwen-2.5.

    Args:
        model (str): Имя используемой модели.
        messages (Messages): Список сообщений для отправки модели.
        proxy (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий сгенерированный текст.
    """
    ...
```

**Назначение**: Создает асинхронный генератор для получения сгенерированного текста от модели Qwen Qwen-2.5.

**Параметры**:
- `cls` (Qwen_Qwen_2_5): Ссылка на класс `Qwen_Qwen_2_5`.
- `model` (str): Имя используемой модели.
- `messages` (Messages): Список сообщений для отправки модели.
- `proxy` (str, optional): URL прокси-сервера для использования. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий сгенерированный текст.

**Внутренние функции**:
- `generate_session_hash()`: Генерирует уникальный идентификатор сессии.

    ```python
    def generate_session_hash():
        """Generate a unique session hash."""
        return str(uuid.uuid4()).replace(\'-\', \'\')[:10]
    ```

    **Назначение**: Генерирует уникальный идентификатор сессии для каждого запроса.

    **Параметры**:
    - Нет.

    **Возвращает**:
    - `str`: Уникальный идентификатор сессии.

**Как работает функция**:

1. **Генерация идентификатора сессии**:
   - Вызывается функция `generate_session_hash`, которая генерирует уникальный идентификатор сессии на основе UUID.
   - Идентификатор сессии используется для отслеживания запроса на сервере.

2. **Подготовка заголовков и полезной нагрузки для запроса**:
   - Формируются заголовки HTTP-запроса, включая User-Agent, Accept и Referer.
   - Подготавливается полезная нагрузка (payload) для отправки данных, включая промпт, системное сообщение и идентификатор сессии.

3. **Отправка запроса на присоединение к очереди**:
   - Используется `aiohttp.ClientSession` для отправки POST-запроса на API endpoint с заголовками и полезной нагрузкой.
   - Полученный `event_id` используется для дальнейшего отслеживания события.

4. **Подготовка и отправка запроса на получение данных**:
   - Формируются заголовки и параметры для GET-запроса на получение потока данных.
   - Отправляется GET-запрос на URL данных с заголовками и параметрами сессии.

5. **Обработка потока данных**:
   - Асинхронно читаются строки из ответа.
   - Каждая строка декодируется из UTF-8.
   - Если строка начинается с `data:`, то извлекается JSON-данные и обрабатывается.

6. **Извлечение и генерация текста**:
   - Если `msg` равно `process_generating`, извлекаются данные из `output` и генерируется текст.
   - Если `msg` равно `process_completed`, выполняется финальная проверка и извлекается полный текст ответа.
   - Фрагменты текста возвращаются через `yield`, обеспечивая потоковую передачу.

7. **Обработка ошибок**:
   - Если возникает `json.JSONDecodeError`, ошибка логируется с использованием `debug.log`.

```
Генерация идентификатора сессии
     │
     │
     ▼
Подготовка заголовков и полезной нагрузки для запроса
     │
     │
     ▼
Отправка запроса на присоединение к очереди
     │
     │
     ▼
Подготовка и отправка запроса на получение данных
     │
     │
     ▼
Обработка потока данных
     │
     │
     ▼
Извлечение и генерация текста
     │
     │
     ▼
Конец
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio
from typing import List, Dict

async def main():
    model = "qwen-qwen2-5"
    messages: List[Dict[str, str]] = [
        {"role": "system", "content": "You are a helpful assistant."},
        {"role": "user", "content": "What is the capital of France?"}
    ]
    
    generator = Qwen_Qwen_2_5.create_async_generator(model=model, messages=messages)
    
    async for text in await generator:
        print(text, end="")

if __name__ == "__main__":
    asyncio.run(main())
```
```python
# Пример использования create_async_generator с прокси
import asyncio
from typing import List, Dict

async def main():
    model = "qwen-qwen2-5"
    messages: List[Dict[str, str]] = [
        {"role": "system", "content": "You are a helpful assistant."},
        {"role": "user", "content": "What is the capital of France?"}
    ]
    proxy = "http://your_proxy:8080"  # Замените на ваш прокси-сервер
    
    generator = Qwen_Qwen_2_5.create_async_generator(model=model, messages=messages, proxy=proxy)
    
    async for text in await generator:
        print(text, end="")

if __name__ == "__main__":
    asyncio.run(main())