# Модуль `Equing.py`

## Обзор

Модуль `Equing.py` предназначен для взаимодействия с провайдером Equing, предоставляющим доступ к моделям GPT.
Он содержит класс `Equing`, который наследуется от `AbstractProvider` и реализует методы для создания запросов к API Equing.
Модуль поддерживает потоковую передачу данных и модели GPT-3.5 Turbo, но не поддерживает GPT-4.

## Подробнее

Этот модуль является частью системы для работы с различными поставщиками (провайдерами) API для больших языковых моделей.
Он предоставляет конкретную реализацию для взаимодействия с сервисом Equing, позволяя отправлять запросы на генерацию текста и получать ответы.
Модуль определяет URL, указывает на поддержку потоковой передачи и поддерживаемые модели.

## Классы

### `Equing`

**Описание**: Класс `Equing` представляет собой реализацию абстрактного провайдера `AbstractProvider` для взаимодействия с API Equing.

**Наследует**:
- `AbstractProvider`: Абстрактный класс, определяющий интерфейс для всех провайдеров.

**Атрибуты**:
- `url` (str): URL-адрес API Equing (`https://next.eqing.tech/`).
- `working` (bool): Флаг, указывающий на работоспособность провайдера. По умолчанию `False`.
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи данных. По умолчанию `True`.
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели GPT-3.5 Turbo. По умолчанию `True`.
- `supports_gpt_4` (bool): Флаг, указывающий на поддержку модели GPT-4. По умолчанию `False`.

**Методы**:
- `create_completion()`:  Метод для создания запроса на completion.

## Функции

### `create_completion`

```python
    @staticmethod
    @abstractmethod
    def create_completion(
        model: str,
        messages: list[dict[str, str]],
        stream: bool, **kwargs: Any) -> CreateResult:
        """
        Метод отправляет запрос к API Equing для создания completion.

        Args:
            model (str): Название модели, используемой для completion.
            messages (list[dict[str, str]]): Список сообщений для передачи в модель.
            stream (bool): Флаг, указывающий на использование потоковой передачи данных.
            **kwargs (Any): Дополнительные аргументы для запроса.

        Returns:
            CreateResult: Результат запроса.

        Raises:
            Нет явных исключений, но могут быть исключения, связанные с сетевыми запросами или обработкой данных.
        """
```

**Назначение**: Отправляет запрос к API Equing для создания completion на основе предоставленных параметров.

**Параметры**:
- `model` (str): Имя модели, которую нужно использовать для генерации текста.
- `messages` (list[dict[str, str]]): Список сообщений, представляющих контекст для генерации текста. Каждое сообщение – это словарь с ключами `role` (например, "user" или "assistant") и `content` (текст сообщения).
- `stream` (bool): Флаг, указывающий, нужно ли использовать потоковую передачу данных. Если `True`, ответ будет приходить частями.
- `**kwargs` (Any): Дополнительные параметры, такие как температура, штрафы за присутствие и частоту, и верхнее значение p.

**Возвращает**:
- `CreateResult`: Результат запроса.  Это может быть генератор, если `stream=True`, или строка с полным ответом, если `stream=False`.

**Как работает функция**:

1. **Подготовка заголовков**: Функция определяет заголовки HTTP-запроса, необходимые для взаимодействия с API Equing. Эти заголовки включают информацию о типе контента, агенте пользователя и другие метаданные.
2. **Подготовка JSON-данных**: Функция создает JSON-объект с данными, которые будут отправлены в теле запроса. Этот объект включает сообщения, имя модели, параметры температуры, штрафы и флаг потоковой передачи.
3. **Отправка POST-запроса**: Функция отправляет POST-запрос к API Equing с заголовками и JSON-данными.
4. **Обработка ответа**:
   - Если `stream=False`, функция ожидает полный ответ от сервера, преобразует его в JSON и извлекает сгенерированный текст из поля `content`.
   - Если `stream=True`, функция обрабатывает ответ по частям, извлекая содержимое каждого токена и возвращая его с помощью `yield`.

**Внутренние функции**: Нет

**ASCII flowchart**:

```
    Начало
    │
    │   Подготовка заголовков и данных (headers, json_data)
    │
    │   Отправка POST-запроса к API Equing (requests.post)
    │
    │   stream=False?
    ├───да───►  Получение полного ответа, извлечение текста (response.json()["choices"][0]["message"]["content"])
    │           │
    │           └───► Конец
    │
    └───нет───►  Потоковая обработка ответа (response.iter_content)
                │
                │   Цикл по частям ответа (line in response.iter_content)
                │   │
                │   └───►Извлечение и обработка токенов (json.loads, line_json['choices'][0]['delta'].get('content'))
                │       │
                │       └───► yield token
                │
                └───► Конец

```

**Примеры**:

Пример 1: Запрос completion без потоковой передачи:

```python
Equing.create_completion(model="gpt-3.5-turbo", messages=[{"role": "user", "content": "Hello!"}], stream=False)
```

Пример 2: Запрос completion с потоковой передачей:

```python
generator = Equing.create_completion(model="gpt-3.5-turbo", messages=[{"role": "user", "content": "Tell me a story."}], stream=True)
for token in generator:
    print(token, end="")
```