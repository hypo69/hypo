# Модуль `FastGpt`

## Обзор

Модуль `FastGpt` предоставляет класс `FastGpt`, который является провайдером для работы с API FastGPT. Этот модуль позволяет отправлять запросы к API FastGPT для генерации текста на основе предоставленных сообщений, поддерживая потоковую передачу данных.

## Подробней

Модуль `FastGpt` является частью системы `hypotez` и предназначен для интеграции с API FastGPT. Он включает в себя настройки для подключения к API, формирования запросов и обработки ответов. Модуль поддерживает потоковую передачу данных, что позволяет получать ответы в реальном времени.

## Классы

### `FastGpt(AbstractProvider)`

**Описание**: Класс `FastGpt` является провайдером для работы с API FastGPT.

**Наследует**:
- `AbstractProvider`: Абстрактный базовый класс для всех провайдеров.

**Атрибуты**:
- `url` (str): URL-адрес API FastGPT. По умолчанию `'https://chat9.fastgpt.me/'`.
- `working` (bool): Указывает, работает ли провайдер. По умолчанию `False`.
- `needs_auth` (bool): Указывает, требуется ли аутентификация для работы с провайдером. По умолчанию `False`.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных. По умолчанию `True`.
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель `gpt-3.5-turbo`. По умолчанию `True`.
- `supports_gpt_4` (bool): Указывает, поддерживает ли провайдер модель `gpt-4`. По умолчанию `False`.

**Методы**:
- `create_completion(model: str, messages: list[dict[str, str]], stream: bool, **kwargs: Any) -> CreateResult`: Статический метод для создания запроса к API FastGPT и получения ответа.

## Функции

### `create_completion`

```python
@staticmethod
def create_completion(
    model: str,
    messages: list[dict[str, str]],
    stream: bool, **kwargs: Any) -> CreateResult:
    """
    Создает запрос к API FastGPT и возвращает результат.

    Args:
        model (str): Название модели для использования.
        messages (list[dict[str, str]]): Список сообщений для отправки в API.
        stream (bool): Указывает, использовать ли потоковую передачу данных.
        **kwargs (Any): Дополнительные параметры для запроса.

    Returns:
        CreateResult: Результат запроса к API.

    Raises:
        requests.exceptions.RequestException: Если возникает ошибка при отправке запроса.

    """
```

**Назначение**: Создает запрос к API FastGPT для генерации текста на основе предоставленных сообщений.

**Параметры**:
- `model` (str): Название модели для использования.
- `messages` (list[dict[str, str]]): Список сообщений для отправки в API.
- `stream` (bool): Указывает, использовать ли потоковую передачу данных.
- `**kwargs` (Any): Дополнительные параметры для запроса, такие как `temperature`, `presence_penalty`, `frequency_penalty` и `top_p`.

**Возвращает**:
- `CreateResult`: Генератор токенов, возвращаемых из API, или текст ответа, если потоковая передача не используется.

**Вызывает исключения**:
- `requests.exceptions.RequestException`: Если возникает ошибка при отправке запроса.

**Как работает функция**:

1.  **Подготовка заголовков**: Функция определяет заголовки HTTP-запроса, включая информацию о браузере, типе контента и источнике запроса.
2.  **Формирование JSON-данных**: Создается словарь `json_data`, содержащий сообщения, модель, параметры температуры, штрафов и другие параметры, переданные в функцию.
3.  **Выбор поддомена**: Случайным образом выбирается один из поддоменов (`jdaen979ew` или `chat9`) для отправки запроса.
4.  **Отправка запроса**: С использованием библиотеки `requests` отправляется POST-запрос к API FastGPT с указанными заголовками, JSON-данными и параметром `stream`.
5.  **Обработка потокового ответа**: Если включена потоковая передача (`stream=True`), функция итерируется по строкам ответа. Для каждой строки проверяется, содержит ли она данные (`b'content' in line`). Если да, строка декодируется, извлекается JSON и извлекается содержимое (`token`). Если содержимое присутствует, оно возвращается как часть генератора.
6.  **Обработка ошибок**: В процессе обработки потока данных используется блок `try-except` для перехвата возможных исключений, возникающих при декодировании JSON или извлечении данных. В случае ошибки, обработка текущей строки пропускается, и функция переходит к следующей строке.

**ASCII flowchart функции**:

```
    Начало
    │
    ├── Заголовки HTTP (headers)
    │
    ├── JSON-данные (json_data)
    │
    ├── Выбор поддомена (subdomain)
    │
    ├── POST-запрос (requests.post)
    │
    ├── Обработка ответа (response.iter_lines)
    │
    │   В цикле:
    │   ├── Проверка наличия контента (b'content' in line)
    │   │   └── Если есть контент:
    │   │       ├── Декодирование и извлечение JSON (json.loads)
    │   │       ├── Извлечение токена (token)
    │   │       └── Возврат токена (yield token)
    │   │   └── Если нет контента:
    │   │       └── Продолжение цикла
    │   │
    │   └── Обработка исключений (try-except)
    │       └── Продолжение цикла
    │
    └── Конец
```

**Примеры**:

```python
# Пример использования с потоковой передачей
messages = [{"role": "user", "content": "Напиши короткий рассказ."}]
for token in FastGpt.create_completion(model="gpt-3.5-turbo", messages=messages, stream=True):
    print(token, end="")

# Пример использования без потоковой передачи (не рекомендуется, так как модуль поддерживает потоковую передачу)
messages = [{"role": "user", "content": "Напиши короткий рассказ."}]
response = "".join(FastGpt.create_completion(model="gpt-3.5-turbo", messages=messages, stream=True))
print(response)