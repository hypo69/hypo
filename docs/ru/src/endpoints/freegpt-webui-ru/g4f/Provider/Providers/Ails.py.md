# Модуль `Ails.py`

## Обзор

Модуль предоставляет функциональность для взаимодействия с провайдером Ails, используя модель `gpt-3.5-turbo`. Он включает в себя функции для создания запросов к API, форматирования данных и обработки ответов. Модуль поддерживает потоковую передачу данных и требует настройки заголовков запроса.

## Подробнее

Этот модуль используется для интеграции с сервисом `ai.ls` через API `api.caipacity.com`. Он содержит функции для генерации подписи запроса, форматирования временных меток и создания запросов на завершение текста. Весь обмен данными происходит в формате JSON.

## Константы

- `url`: URL API сервиса `ai.ls` (`https://ai.ls`).
- `model`: Используемая модель (`gpt-3.5-turbo`).
- `supports_stream`: Поддержка потоковой передачи (`True`).
- `needs_auth`: Требуется ли аутентификация (`False`).

## Классы

### `Utils`

**Описание**: Класс содержит утилитарные методы для работы с данными, включая хеширование и форматирование временных меток.

**Принцип работы**:
Класс предоставляет статические методы, которые используются для подготовки данных перед отправкой запроса к API. Он включает в себя метод для хеширования данных с использованием секретного ключа и метод для форматирования временных меток.

**Методы**:

- `hash(json_data: Dict[str, str]) -> sha256`
   ```python
   def hash(json_data: Dict[str, str]) -> sha256:
       """
       Вычисляет SHA256 хеш на основе предоставленных JSON данных.

       Args:
           json_data (Dict[str, str]): Словарь с данными для хеширования.

       Returns:
           sha256: SHA256 хеш в виде шестнадцатеричной строки.
       """
   ```

   **Назначение**: Вычисляет SHA256 хеш на основе предоставленных JSON данных.

   **Параметры**:
    - `json_data` (Dict[str, str]): Словарь с данными для хеширования.

   **Возвращает**:
    - `sha256`: SHA256 хеш в виде шестнадцатеричной строки.

   **Как работает функция**:

   1. Определяется секретный ключ `secretKey` как `bytearray`.
   2. Формируется строка `base_string` из значений `json_data['t']`, `json_data['m']`, константы `'WI,2rU#_r:r~aF4aJ36[.Z(/8Rv93Rf'` и длины `json_data['m']`.
   3. Вычисляется SHA256 хеш строки `base_string` с использованием кодировки UTF-8.
   4. Возвращается хеш в виде шестнадцатеричной строки.

- `format_timestamp(timestamp: int) -> str`
   ```python
   def format_timestamp(timestamp: int) -> str:
       """
       Форматирует временную метку.

       Args:
           timestamp (int): Временная метка в миллисекундах.

       Returns:
           str: Форматированная временная метка в виде строки.
       """
   ```

   **Назначение**: Форматирует временную метку, приводя её к определённому формату.

   **Параметры**:
    - `timestamp` (int): Временная метка в миллисекундах.

   **Возвращает**:
    - `str`: Форматированная временная метка в виде строки.

   **Как работает функция**:

   1. Принимает временную метку `timestamp` в виде целого числа.
   2. Вычисляет остаток от деления `timestamp` на 10 и сохраняет в `n`.
   3. Если `n` четное, то `r` присваивается `n + 1`, иначе `r` присваивается `n`.
   4. Возвращает строку, полученную вычитанием `n` из `timestamp` и прибавлением `r`.

## Функции

### `_create_completion`

```python
def _create_completion(model: str, messages: list, temperature: float = 0.6, stream: bool = False, **kwargs):
    """
    Создает запрос к API для генерации текста.

    Args:
        model (str): Идентификатор модели.
        messages (list): Список сообщений для контекста.
        temperature (float): Температура для контроля случайности генерации. По умолчанию 0.6.
        stream (bool): Флаг потоковой передачи. По умолчанию `False`.
        **kwargs: Дополнительные параметры.

    Yields:
        str: Части сгенерированного текста в потоковом режиме.
    """
```

**Назначение**: Создает запрос к API для генерации текста на основе предоставленных параметров.

**Параметры**:
- `model` (str): Идентификатор модели, используемой для генерации текста.
- `messages` (list): Список сообщений, представляющих собой контекст для генерации текста.
- `temperature` (float): Температура для контроля случайности генерации. По умолчанию 0.6.
- `stream` (bool): Флаг, указывающий, использовать ли потоковую передачу данных. По умолчанию `False`.
- `**kwargs`: Дополнительные параметры, которые могут быть переданы в API.

**Возвращает**:
- `str`: Части сгенерированного текста в потоковом режиме.

**Как работает функция**:

1.  **Подготовка заголовков**:
    *   Определяются необходимые HTTP-заголовки для запроса.
    *   В заголовки включаются параметры авторизации, идентификатор клиента, версия клиента, тип контента и User-Agent.

2.  **Подготовка параметров**:
    *   Устанавливается параметр `full` в значение `false`.

3.  **Формирование временной метки**:
    *   Текущее время умножается на 1000 для получения временной метки в миллисекундах.
    *   Временная метка форматируется с помощью функции `Utils.format_timestamp`.

4.  **Создание подписи**:
    *   Формируется словарь `sig`, включающий дату, временную метку и хеш сообщения.
    *   Хеш сообщения вычисляется с помощью функции `Utils.hash`.

5.  **Формирование JSON-данных**:
    *   Создается JSON-объект, включающий модель, температуру, флаг потоковой передачи, сообщения и подпись.
    *   JSON-объект сериализуется с использованием `json.dumps` и `separators=(',', ':')` для минимизации размера.

6.  **Отправка запроса**:
    *   Отправляется POST-запрос к API (`https://api.caipacity.com/v1/chat/completions`) с заголовками и JSON-данными.
    *   Используется потоковая передача данных (`stream=True`).

7.  **Обработка потока**:
    *   Итерируется по строкам ответа.
    *   Если строка содержит `b'content'`, она декодируется и загружается как JSON.
    *   Извлекается содержимое из поля `choices[0]['delta']['content']`.
    *   Если содержимое не `None`, оно возвращается через `yield`.

**Внутренние функции**:
- Отсутствуют внутренние функции

**Примеры**:

```python
messages = [{"role": "user", "content": "Hello, how are you?"}]
for token in _create_completion(model='gpt-3.5-turbo', messages=messages, temperature=0.7, stream=True):
    print(token, end="")
```

## Параметры модуля

- `params`: Строка, содержащая информацию о поддерживаемых типах параметров функции `_create_completion`.

```python
params = f'g4f.Providers.{os.path.basename(__file__)[:-3]} supports: ' + \
    '(%s)' % ', '.join([f"{name}: {get_type_hints(_create_completion)[name].__name__}" for name in _create_completion.__code__.co_varnames[:_create_completion.__code__.co_argcount]])