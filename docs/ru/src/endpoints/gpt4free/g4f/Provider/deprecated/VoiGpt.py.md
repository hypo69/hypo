# Модуль VoiGpt.py

## Обзор

Модуль предоставляет класс `VoiGpt`, который является провайдером для взаимодействия с сайтом VoiGpt.com. Этот провайдер позволяет использовать модели GPT для генерации ответов на основе переданных сообщений.

## Подробней

Этот файл содержит класс `VoiGpt`, который наследуется от `AbstractProvider`. Он предназначен для обмена сообщениями с сервером VoiGpt.com. Для работы требуется получить CSRF токен/cookie с сайта voigpt.com. Класс поддерживает модели GPT-3.5-turbo, имеет историю сообщений и не поддерживает потоковую передачу.

## Классы

### `VoiGpt(AbstractProvider)`

**Описание**:
Класс `VoiGpt` предоставляет интерфейс для взаимодействия с сервисом VoiGpt.com.

**Наследует**:
`AbstractProvider` - абстрактный класс, определяющий интерфейс для всех провайдеров.

**Атрибуты**:
- `url` (str): URL адрес сервиса VoiGpt.com.
- `working` (bool): Флаг, указывающий на работоспособность провайдера. По умолчанию `False`.
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели gpt-3.5-turbo. По умолчанию `True`.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений. По умолчанию `True`.
- `supports_stream` (bool): Флаг, указывающий на поддержку потоковой передачи. По умолчанию `False`.
- `_access_token` (str): Приватный атрибут для хранения токена доступа.

**Методы**:
- `create_completion()`: Метод для создания завершения на основе переданных сообщений.

## Функции

### `create_completion`

```python
@classmethod
def create_completion(
    cls,
    model: str,
    messages: Messages,
    stream: bool,
    proxy: str = None,
    access_token: str = None,
    **kwargs
) -> CreateResult:
    """
    Создает запрос к VoiGpt и возвращает результат.

    Args:
        model (str): Модель для использования.
        messages (Messages): Список сообщений для отправки.
        stream (bool): Флаг, указывающий на необходимость потоковой передачи.
        proxy (str, optional): Прокси для использования. По умолчанию `None`.
        access_token (str, optional): Токен доступа для использования. По умолчанию `None`.
        **kwargs: Дополнительные именованные аргументы.

    Returns:
        CreateResult: Объект с результатом.

    Raises:
        RuntimeError: Если получен некорректный ответ от сервера.
    """
```

**Назначение**:
Метод `create_completion` отправляет запрос к сервису VoiGpt для генерации ответа на основе предоставленных сообщений. Он обрабатывает получение токена доступа, формирует заголовки и полезную нагрузку запроса, а также обрабатывает ответ от сервера.

**Параметры**:
- `cls` (class): Ссылка на класс `VoiGpt`.
- `model` (str): Имя используемой модели. Если не указано, используется `"gpt-3.5-turbo"`.
- `messages` (Messages): Список сообщений, отправляемых в запросе.
- `stream` (bool): Определяет, использовать ли потоковую передачу (не поддерживается).
- `proxy` (str, optional): Адрес прокси-сервера. По умолчанию `None`.
- `access_token` (str, optional): Токен доступа. Если не указан, используется сохраненный или получается новый. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `CreateResult`: Объект, содержащий сгенерированный ответ.

**Вызывает исключения**:
- `RuntimeError`: Вызывается, если ответ от сервера не может быть обработан или содержит ошибку.

**Как работает функция**:

1.  **Инициализация**:
    *   Проверяет и устанавливает модель, если она не была передана.
    *   Проверяет и устанавливает токен доступа, если он не был передан.
2.  **Получение токена доступа (если необходимо)**:
    *   Если токен доступа не предоставлен, отправляется GET-запрос на главную страницу `VoiGpt.com` для получения CSRF-токена из cookies.
    *   Полученный токен сохраняется в атрибуте класса `_access_token`.
3.  **Формирование заголовков**:
    *   Создаются заголовки запроса, включающие CSRF-токен из cookies, информацию о User-Agent и другие необходимые параметры.
4.  **Формирование полезной нагрузки**:
    *   Создается полезная нагрузка (payload) в формате JSON, содержащая список сообщений (`messages`).
5.  **Отправка POST-запроса**:
    *   Отправляется POST-запрос на URL `/generate_response/` с заголовками и полезной нагрузкой.
6.  **Обработка ответа**:
    *   Пытается извлечь текст ответа из JSON-ответа.
    *   Генерирует (yield) извлеченный текст ответа.
7.  **Обработка ошибок**:
    *   Если во время обработки ответа возникает исключение, вызывается `RuntimeError` с информацией об ответе.

```
      Начало
         │
         │  Проверка наличия токена
         │
    Нет  │  Запрос CSRF токена -> Сохранение токена
         │  (GET request)
         │
         │
    Да   │  Формирование заголовков и payload
         │
         │  Отправка запроса на генерацию ответа
         │  (POST request)
         │
         │  Обработка ответа
         │
         │  Извлечение текста ответа
         │
         │  Генерация ответа
         │
         │  Конец
```

**Примеры**:

```python
# Пример использования с указанием модели и сообщений
messages = [{"role": "user", "content": "Привет, как дела?"}]
result = VoiGpt.create_completion(model="gpt-3.5-turbo", messages=messages, stream=False)
for item in result:
    print(item)

# Пример использования с прокси и токеном доступа
messages = [{"role": "user", "content": "Напиши короткий рассказ."}]
result = VoiGpt.create_completion(model="gpt-3.5-turbo", messages=messages, stream=False, proxy="http://proxy.example.com", access_token="your_access_token")
for item in result:
    print(item)