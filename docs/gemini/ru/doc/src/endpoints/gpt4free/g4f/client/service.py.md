# Модуль `service.py`

## Обзор

Модуль `service.py` предназначен для управления и выбора провайдеров и моделей, используемых для взаимодействия с различными языковыми моделями. Он обеспечивает функциональность для преобразования строк в объекты провайдеров, получения моделей и провайдеров на основе заданных параметров, а также для получения информации о последнем использованном провайдере.

## Подробней

Модуль предоставляет функции для динамического выбора и конфигурации провайдеров, что позволяет адаптировать систему к различным требованиям и условиям. Он также обрабатывает ошибки, связанные с поиском провайдеров, моделей и поддержкой потоковой передачи данных.

## Функции

### `convert_to_provider`

```python
def convert_to_provider(provider: str) -> ProviderType:
    """
    Преобразует строку с именем провайдера в объект провайдера.

    Args:
        provider (str): Имя провайдера или список провайдеров, разделенных пробелами.

    Returns:
        ProviderType: Объект провайдера.

    Raises:
        ProviderNotFoundError: Если провайдер не найден.
    """
```

**Как работает функция**:

1.  **Проверка на наличие пробелов**: Функция проверяет, содержит ли входная строка `provider` пробелы. Если да, это интерпретируется как список провайдеров.
2.  **Преобразование списка провайдеров**: Если в строке есть пробелы, функция разделяет строку на отдельные имена провайдеров и пытается преобразовать каждое имя в соответствующий объект провайдера, используя `ProviderUtils.convert`. Не найденные провайдеры отфильтровываются.
3.  **Обработка одиночного провайдера**: Если в строке нет пробелов, функция пытается найти и преобразовать имя провайдера в объект провайдера, используя `ProviderUtils.convert`.
4.  **Обработка ошибок**: Если провайдер не найден ни в одном из случаев, функция вызывает исключение `ProviderNotFoundError`.

```
Проверка наличия пробелов в имени провайдера --> Преобразование списка провайдеров (если есть пробелы) --> Преобразование одиночного провайдера (если нет пробелов) --> Вызов исключения ProviderNotFoundError (если провайдер не найден)
```

**Примеры**:

```python
# Пример 1: Преобразование существующего провайдера
provider = convert_to_provider("G4FProvider")
print(type(provider))  # Вывод: <class 'src.providers.g4f.G4FProvider'>

# Пример 2: Преобразование несуществующего провайдера (вызовет исключение)
try:
    provider = convert_to_provider("NonExistentProvider")
except ProviderNotFoundError as ex:
    print(ex)  # Вывод: Provider not found: NonExistentProvider

# Пример 3: Преобразование списка провайдеров
provider = convert_to_provider("G4FProvider GeminiProProvider")
print(type(provider)) # Вывод: <class 'src.providers.retry_provider.IterListProvider'>
```

### `get_model_and_provider`

```python
def get_model_and_provider(model    : Union[Model, str], 
                           provider : Union[ProviderType, str, None], 
                           stream   : bool,
                           ignore_working: bool = False,
                           ignore_stream: bool = False,
                           logging: bool = True,
                           has_images: bool = False) -> tuple[str, ProviderType]:
    """
    Извлекает модель и провайдера на основе входных параметров.

    Args:
        model (Union[Model, str]): Модель для использования, как объект или строковый идентификатор.
        provider (Union[ProviderType, str, None]): Провайдер для использования, как объект, строковый идентификатор или None.
        stream (bool): Указывает, следует ли выполнять операцию как поток.
        ignore_working (bool, optional): Если True, игнорирует рабочий статус провайдера.
        ignore_stream (bool, optional): Если True, игнорирует возможность потоковой передачи провайдера.
        logging (bool, optional): Если True, включает логирование.
        has_images (bool, optional): Если True, указывает, что запрос содержит изображения.

    Returns:
        tuple[str, ProviderType]: Кортеж, содержащий имя модели и тип провайдера.

    Raises:
        ProviderNotFoundError: Если провайдер не найден.
        ModelNotFoundError: Если модель не найдена.
        ProviderNotWorkingError: Если провайдер не работает.
        StreamNotSupportedError: Если потоковая передача не поддерживается провайдером.
    """
```

**Как работает функция**:

1.  **Проверка версии**: Проверяет версию.
2.  **Преобразование провайдера**: Если `provider` является строкой, она преобразуется в объект провайдера с использованием функции `convert_to_provider`.
3.  **Преобразование модели**: Если `model` является строкой, она преобразуется в объект модели с использованием `ModelUtils.convert`.
4.  **Выбор провайдера и модели по умолчанию**: Если `provider` не указан, функция выбирает модель и провайдера по умолчанию в зависимости от того, содержит ли запрос изображения или нет.
5.  **Обработка ошибок**: Функция проверяет, работает ли провайдер, поддерживает ли он потоковую передачу данных, и вызывает соответствующие исключения, если что-то не так.
6.  **Логирование**: Функция записывает информацию об используемом провайдере и модели в лог.

```
Проверка версии --> Преобразование провайдера (если строка) --> Преобразование модели (если строка) --> Выбор провайдера и модели по умолчанию (если провайдер не указан) --> Проверка ошибок (работает ли провайдер, поддерживает ли потоковую передачу) --> Логирование --> Возврат модели и провайдера
```

**Примеры**:

```python
# Пример 1: Получение модели и провайдера по умолчанию
model, provider = get_model_and_provider(model=None, provider=None, stream=False)
print(f"Model: {model}, Provider: {provider.__name__}")

# Пример 2: Получение модели и провайдера по имени
model, provider = get_model_and_provider(model="gpt-3.5-turbo", provider="G4FProvider", stream=False)
print(f"Model: {model}, Provider: {provider.__name__}")

# Пример 3: Обработка ошибки, если провайдер не работает
try:
    model, provider = get_model_and_provider(model="gpt-3.5-turbo", provider="G4FProvider", stream=True)
except StreamNotSupportedError as ex:
    print(ex)  # Вывод: G4FProvider does not support "stream" argument
```

### `get_last_provider`

```python
def get_last_provider(as_dict: bool = False) -> Union[ProviderType, dict[str, str], None]:
    """
    Извлекает последнего использованного провайдера.

    Args:
        as_dict (bool, optional): Если True, возвращает информацию о провайдере в виде словаря.

    Returns:
        Union[ProviderType, dict[str, str]]: Последний использованный провайдер, как объект или словарь.
    """
```

**Как работает функция**:

1.  **Получение последнего провайдера**: Функция извлекает последнего использованного провайдера из `debug.last_provider`.
2.  **Обработка `BaseRetryProvider`**: Если последний провайдер является экземпляром `BaseRetryProvider`, функция извлекает последний провайдер из этого объекта.
3.  **Возврат в виде словаря**: Если `as_dict` имеет значение `True`, функция возвращает информацию о провайдере в виде словаря, содержащего имя, URL, модель и метку провайдера.
4.  **Возврат объекта провайдера**: Если `as_dict` имеет значение `False`, функция возвращает объект провайдера.

```
Получение последнего провайдера --> Обработка BaseRetryProvider --> Возврат в виде словаря (если as_dict True) --> Возврат объекта провайдера (если as_dict False)
```

**Примеры**:

```python
# Пример 1: Получение последнего провайдера как объекта
last_provider = get_last_provider()
if last_provider:
    print(f"Last provider: {last_provider.__name__}")

# Пример 2: Получение последнего провайдера как словаря
last_provider_dict = get_last_provider(as_dict=True)
print(f"Last provider as dict: {last_provider_dict}")