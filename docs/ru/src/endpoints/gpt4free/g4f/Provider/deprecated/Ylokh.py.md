# Модуль `Ylokh.py`

## Обзор

Модуль предназначен для асинхронного взаимодействия с провайдером Ylokh, предоставляющим доступ к моделям GPT. Он позволяет отправлять запросы к API Ylokh и получать ответы в виде асинхронного генератора.

## Подробнее

Модуль содержит класс `Ylokh`, который наследуется от `AsyncGeneratorProvider` и реализует методы для создания асинхронных генераторов, отправляющих запросы к API Ylokh. Он поддерживает потоковую передачу данных и работу с историей сообщений.

## Классы

### `Ylokh`

**Описание**: Класс для взаимодействия с провайдером Ylokh.

**Наследует**: `AsyncGeneratorProvider`

**Атрибуты**:
- `url` (str): URL API Ylokh.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `supports_message_history` (bool): Флаг, указывающий на поддержку истории сообщений.
- `supports_gpt_35_turbo` (bool): Флаг, указывающий на поддержку модели `gpt-3.5-turbo`.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для отправки запросов к API Ylokh.

## Функции

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    stream: bool = True,
    proxy: str = None,
    timeout: int = 120,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для отправки запросов к API Ylokh.

    Args:
        cls (Ylokh): Класс Ylokh.
        model (str): Название модели для использования.
        messages (Messages): Список сообщений для отправки.
        stream (bool, optional): Флаг, указывающий на необходимость потоковой передачи данных. По умолчанию `True`.
        proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
        timeout (int, optional): Время ожидания ответа от сервера. По умолчанию 120.
        **kwargs: Дополнительные аргументы для передачи в API.

    Returns:
        AsyncResult: Асинхронный генератор, возвращающий ответы от API Ylokh.
    """
```

**Назначение**: Создание асинхронного генератора для взаимодействия с API Ylokh.

**Параметры**:
- `cls` (Ylokh): Ссылка на класс `Ylokh`.
- `model` (str): Название модели, которую необходимо использовать (например, "gpt-3.5-turbo").
- `messages` (Messages): Список сообщений для отправки в API.
- `stream` (bool, optional): Определяет, использовать ли потоковый режим передачи данных. По умолчанию `True`.
- `proxy` (str, optional): Прокси-сервер для использования при подключении к API. По умолчанию `None`.
- `timeout` (int, optional): Максимальное время ожидания ответа от API в секундах. По умолчанию 120.
- `**kwargs`: Дополнительные параметры, которые будут переданы в API Ylokh.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который выдает ответы от API Ylokh.

**Как работает функция**:
1.  **Установка параметров**:
    \- Функция устанавливает параметры запроса, такие как модель, сообщения, температуру и другие параметры, необходимые для взаимодействия с API Ylokh.

2.  **Создание сессии**:
    \- Создается асинхронная сессия с использованием `StreamSession` для выполнения HTTP-запросов.
    Параметры, такие как заголовки, прокси и время ожидания, передаются в сессию.

3.  **Отправка запроса и обработка ответа**:
    \- Отправляется POST-запрос к API Ylokh (`https://chatapi.ylokh.xyz/v1/chat/completions`) с данными в формате JSON.
    В зависимости от параметра `stream` (потоковый режим):
    \- Если `stream` установлен в `True`, функция асинхронно перебирает строки в ответе, декодирует их и извлекает содержимое из JSON-объектов.
    \- Если `stream` установлен в `False`, функция ожидает полный ответ в формате JSON и извлекает содержимое сообщения.

4.  **Генерация результатов**:
    \- В потоковом режиме функция генерирует содержимое по мере его поступления, извлекая данные из каждой строки ответа.
    \- В не потоковом режиме функция генерирует содержимое только после получения полного ответа.

```
      Настройка параметров --> Создание асинхронной сессии
       |
       |
       V
    Отправка POST-запроса к API Ylokh
       |
       |
       V
    +---------------------+   +-----------------------+
    |   stream == True    |   |   stream == False     |
    +---------------------+   +-----------------------+
       |                     |
       V                     V
    Перебор строк ответа  Получение полного JSON-ответа
       |                     |
       V                     V
    Извлечение контента   Извлечение контента
       |                     |
       V                     V
    Генерация контента    Генерация контента
```

**Примеры**:

```python
# Пример использования create_async_generator
import asyncio

async def main():
    model = "gpt-3.5-turbo"
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    stream = True
    proxy = None
    timeout = 120

    generator = await Ylokh.create_async_generator(
        model=model, messages=messages, stream=stream, proxy=proxy, timeout=timeout
    )

    async for message in generator:
        print(message, end="")

if __name__ == "__main__":
    asyncio.run(main())