# Модуль `pricelist_generator.py`

## Обзор

Модуль предназначен для генерации HTML и PDF отчетов для мехиронов Казаринова. Он включает классы и функции для загрузки данных из JSON, создания HTML-страниц на основе шаблонов Jinja2 и конвертации HTML в PDF.

## Подробнее

Модуль содержит класс `ReportGenerator`, который инкапсулирует логику генерации отчетов. Он использует шаблоны Jinja2 для создания HTML и библиотеку `pdfkit` или `PDFUtils` для конвертации HTML в PDF. Основной метод `create_report` выполняет полный цикл генерации отчета: загружает данные, генерирует HTML, сохраняет HTML в файл и конвертирует его в PDF.

## Классы

### `ReportGenerator`

**Описание**: Класс для генерации HTML- и PDF-отчётов на основе данных из JSON.

**Принцип работы**:
Класс `ReportGenerator` использует Jinja2 для генерации HTML-контента на основе предоставленных данных и шаблонов. Он также использует `pdfkit` или `PDFUtils` для конвертации сгенерированного HTML в PDF-формат. Класс предоставляет методы для генерации HTML, сохранения HTML в файл и создания PDF-отчета.

**Аттрибуты**:
- `env` (Environment): Окружение Jinja2 для загрузки и рендеринга шаблонов. Инициализируется с использованием `FileSystemLoader`, указывающего на текущую директорию.

**Методы**:
- `generate_html(data: dict, lang: str) -> str`: Генерирует HTML-контент на основе шаблона и данных.
- `create_report(data: dict, lang: str, html_file: str | Path, pdf_file: str | Path) -> bool`: Полный цикл генерации отчёта.

## Функции

### `generate_html`

```python
async def generate_html(self, data:dict, lang:str ) -> str:
    """
    Генерирует HTML-контент на основе шаблона и данных.

    Args:
        lang (str): Язык отчёта.

    Returns:
        str: HTML-контент.
    """
```

**Назначение**: Генерирует HTML-контент на основе предоставленных данных и шаблона Jinja2.

**Параметры**:
- `data` (dict): Словарь с данными для заполнения шаблона.
- `lang` (str): Язык отчёта. Определяет, какой шаблон использовать (`template_table_he.html` для иврита и `template_table_ru.html` для русского).

**Возвращает**:
- `str`: HTML-контент, сгенерированный на основе шаблона и данных.

**Как работает функция**:
1. Определяется имя шаблона в зависимости от языка (`lang`). Если язык `he` (иврит), используется шаблон `template_table_he.html`, в противном случае используется `template_table_ru.html`.
2. Формируется полный путь к файлу шаблона.
3. Читается содержимое шаблона из файла.
4. Создается объект шаблона Jinja2 из строки.
5. Выполняется рендеринг шаблона с использованием переданных данных (`data`).
6. Возвращается сгенерированный HTML-контент.

```
A[Определение имени шаблона в зависимости от языка]
↓
B[Формирование полного пути к файлу шаблона]
↓
C[Чтение содержимого шаблона из файла]
↓
D[Создание объекта шаблона Jinja2 из строки]
↓
E[Рендеринг шаблона с использованием переданных данных]
↓
F[Возврат сгенерированного HTML-контента]
```

**Примеры**:

```python
# Пример вызова функции generate_html
data = {'products': [{'product_title': 'Товар 1', 'specification': 'Описание 1'}]}
lang = 'ru'
html_content = await ReportGenerator().generate_html(data, lang)
print(html_content[:100])  # Вывод первых 100 символов HTML-контента
```

### `create_report`

```python
async def create_report(self, data: dict, lang:str, html_file:str| Path, pdf_file:str |Path) -> bool:
    """
    Полный цикл генерации отчёта.

    Args:
        lang (str): Язык отчёта.
    """
```

**Назначение**: Выполняет полный цикл генерации отчёта: добавляет сервисный продукт, генерирует HTML-контент, сохраняет его в HTML-файл и преобразует HTML-файл в PDF-файл.

**Параметры**:
- `data` (dict): Словарь с данными для отчёта.
- `lang` (str): Язык отчёта (`ru` или `he`).
- `html_file` (str | Path): Путь к файлу для сохранения HTML-контента.
- `pdf_file` (str | Path): Путь к файлу для сохранения PDF-отчёта.

**Возвращает**:
- `bool`: `True`, если отчёт успешно сгенерирован, `False` в противном случае.

**Как работает функция**:
1. Создается словарь `service_dict`, содержащий информацию о сервисном продукте. Текст спецификации сервиса загружается из HTML-файла в зависимости от языка (`lang`).
2. Добавляется сервисный продукт в список продуктов в данных (`data`).
3. Генерируется HTML-контент с использованием метода `generate_html`.
4. HTML-контент записывается в HTML-файл.
5. Создается экземпляр класса `PDFUtils`.
6. HTML-контент преобразуется в PDF с использованием метода `save_pdf_pdfkit` из `PDFUtils`. Если преобразование не удалось, регистрируется ошибка.
7. Возвращается `True`, если отчёт успешно сгенерирован, `False` в противном случае.

```
A[Создание словаря service_dict с информацией о сервисном продукте]
↓
B[Добавление сервисного продукта в список продуктов в данных]
↓
C[Генерация HTML-контента с использованием метода generate_html]
↓
D[Запись HTML-контента в HTML-файл]
↓
E[Создание экземпляра класса PDFUtils]
↓
F[Преобразование HTML-контента в PDF с использованием метода save_pdf_pdfkit]
│
├──G[Если преобразование не удалось, регистрируется ошибка]
│
H[Возврат True, если отчёт успешно сгенерирован, False в противном случае]
```

**Примеры**:

```python
# Пример вызова функции create_report
data = {'products': [{'product_title': 'Товар 1', 'specification': 'Описание 1'}]}
lang = 'ru'
html_file = 'report.html'
pdf_file = 'report.pdf'
result = await ReportGenerator().create_report(data, lang, html_file, pdf_file)
print(f"Отчёт сгенерирован: {result}")
```

### `main`

```python
def main(mexiron:str,lang:str) ->bool:
    """

    """
```

**Назначение**: Главная функция, которая координирует процесс генерации отчёта.

**Параметры**:
- `mexiron` (str): Имя директории мехирона.
- `lang` (str): Язык отчёта.

**Возвращает**:
- `bool`: `True`, если отчёт успешно сгенерирован, `False` в противном случае (фактически всегда возвращает `None`, так как отсутствует явный оператор `return`).

**Как работает функция**:
1. Формируется базовый путь к директории мехирона на основе имени мехирона.
2. Загружаются данные из JSON-файла, соответствующего языку отчёта.
3. Определяются пути к HTML-файлу и PDF-файлу.
4. Создается экземпляр класса `ReportGenerator`.
5. Запускается асинхронная задача по генерации отчёта с использованием метода `create_report`.

```
A[Формирование базового пути к директории мехирона]
↓
B[Загрузка данных из JSON-файла]
↓
C[Определение путей к HTML-файлу и PDF-файлу]
↓
D[Создание экземпляра класса ReportGenerator]
↓
E[Запуск асинхронной задачи по генерации отчёта]
```

**Примеры**:

```python
# Пример вызова функции main
mexiron = '24_12_01_03_18_24_269'
lang = 'ru'
main(mexiron, lang)