# Модуль DeepInfra

## Обзор

Модуль `DeepInfra` предоставляет интерфейс для взаимодействия с сервисом DeepInfra для генерации текста и изображений. Он включает в себя функциональность для получения списка доступных моделей, создания асинхронных генераторов текста и изображений, а также выполнения запросов к API DeepInfra. Модуль требует авторизации и использует OpenAI Template.

## Подробнее

Модуль предназначен для интеграции с платформой DeepInfra, обеспечивая возможность использования различных моделей, включая модели для генерации текста и преобразования текста в изображение. Он включает в себя методы для аутентификации, формирования запросов и обработки ответов от API DeepInfra.

## Классы

### `DeepInfra`

**Описание**: Класс для взаимодействия с сервисом DeepInfra.

**Наследует**:
- `OpenaiTemplate`: Наследует функциональность шаблона OpenAI для упрощения взаимодействия с API.

**Атрибуты**:
- `url` (str): URL главной страницы DeepInfra.
- `login_url` (str): URL страницы для получения API ключей.
- `api_base` (str): Базовый URL API DeepInfra.
- `working` (bool): Флаг, указывающий на работоспособность провайдера.
- `needs_auth` (bool): Флаг, указывающий на необходимость аутентификации.
- `default_model` (str): Модель, используемая по умолчанию для генерации текста.
- `default_image_model` (str): Модель, используемая по умолчанию для генерации изображений.
- `models` (list): Список доступных текстовых моделей.
- `image_models` (list): Список доступных моделей для генерации изображений.

**Методы**:
- `get_models()`: Получает список доступных моделей.
- `get_image_models()`: Получает список доступных моделей для генерации изображений.
- `create_async_generator()`: Создает асинхронный генератор для генерации текста или изображения.
- `create_async_image()`: Создает асинхронный запрос для генерации изображения.

## Функции

### `get_models`

```python
@classmethod
def get_models(cls, **kwargs):
    """
    Получает список доступных моделей из API DeepInfra.

    Args:
        **kwargs: Дополнительные аргументы.

    Returns:
        list: Список доступных моделей.
    """
    ...
```

**Назначение**:
Получение списка доступных моделей для генерации текста и изображений из API DeepInfra.

**Параметры**:
- `cls`: Ссылка на класс `DeepInfra`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `list[str]`: Список доступных моделей.

**Как работает функция**:
1. Проверяет, был ли уже загружен список моделей (`cls.models`).
2. Если список моделей пуст, отправляет GET-запрос к API DeepInfra для получения списка моделей.
3. Извлекает модели для генерации текста и изображений из полученного JSON-ответа.
4. Обновляет атрибуты `cls.models` и `cls.image_models` класса `DeepInfra`.
5. Расширяет `cls.models` моделями для генерации изображений.
6. Возвращает список доступных моделей (`cls.models`).

**Примеры**:
```python
models = DeepInfra.get_models()
print(models)
```

### `get_image_models`

```python
@classmethod
def get_image_models(cls, **kwargs):
    """
    Получает список доступных моделей для генерации изображений из API DeepInfra.

    Args:
        **kwargs: Дополнительные аргументы.

    Returns:
        list: Список доступных моделей для генерации изображений.
    """
    ...
```

**Назначение**:
Получение списка доступных моделей для генерации изображений из API DeepInfra.

**Параметры**:
- `cls`: Ссылка на класс `DeepInfra`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `list[str]`: Список доступных моделей для генерации изображений.

**Как работает функция**:
1. Проверяет, был ли уже загружен список моделей для генерации изображений (`cls.image_models`).
2. Если список моделей для генерации изображений пуст, вызывает метод `get_models()` для загрузки всех моделей.
3. Возвращает список доступных моделей для генерации изображений (`cls.image_models`).

**Примеры**:
```python
image_models = DeepInfra.get_image_models()
print(image_models)
```

### `create_async_generator`

```python
@classmethod
async def create_async_generator(
    cls,
    model: str,
    messages: Messages,
    stream: bool,
    prompt: str = None,
    temperature: float = 0.7,
    max_tokens: int = 1028,
    **kwargs
) -> AsyncResult:
    """
    Создает асинхронный генератор для генерации текста или изображения.

    Args:
        model (str): Имя модели для генерации.
        messages (Messages): Список сообщений для генерации текста.
        stream (bool): Флаг, указывающий на использование потоковой передачи данных.
        prompt (str, optional): Текст запроса. По умолчанию `None`.
        temperature (float, optional): Температура для генерации текста. По умолчанию `0.7`.
        max_tokens (int, optional): Максимальное количество токенов в ответе. По умолчанию `1028`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный генератор для получения результатов.
    """
    ...
```

**Назначение**:
Создание асинхронного генератора для генерации текста или изображения на основе выбранной модели.

**Параметры**:
- `cls`: Ссылка на класс `DeepInfra`.
- `model` (str): Имя модели для генерации.
- `messages` (Messages): Список сообщений для генерации текста.
- `stream` (bool): Флаг, указывающий на использование потоковой передачи данных.
- `prompt` (str, optional): Текст запроса. По умолчанию `None`.
- `temperature` (float, optional): Температура для генерации текста. По умолчанию `0.7`.
- `max_tokens` (int, optional): Максимальное количество токенов в ответе. По умолчанию `1028`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор для получения результатов.

**Как работает функция**:
1. Проверяет, является ли выбранная модель моделью для генерации изображений.
2. Если модель предназначена для генерации изображений, вызывает метод `create_async_image()` для создания изображения.
3. Если модель предназначена для генерации текста, формирует заголовки запроса.
4. Вызывает метод `super().create_async_generator()` для создания асинхронного генератора текста, используя параметры OpenAI.
5. Передает полученные чанки данных из генератора.

**Внутренние функции**: Отсутствуют

**Примеры**:
```python
messages = [{"role": "user", "content": "Hello, world!"}]
async for chunk in DeepInfra.create_async_generator(model="meta-llama/Meta-Llama-3.1-70B-Instruct", messages=messages, stream=True):
    print(chunk)
```

### `create_async_image`

```python
@classmethod
async def create_async_image(
    cls,
    prompt: str,
    model: str,
    api_key: str = None,
    api_base: str = "https://api.deepinfra.com/v1/inference",
    proxy: str = None,
    timeout: int = 180,
    extra_data: dict = {},
    **kwargs
) -> ImageResponse:
    """
    Создает асинхронный запрос для генерации изображения.

    Args:
        prompt (str): Текст запроса для генерации изображения.
        model (str): Имя модели для генерации изображения.
        api_key (str, optional): API ключ для аутентификации. По умолчанию `None`.
        api_base (str, optional): Базовый URL API DeepInfra. По умолчанию "https://api.deepinfra.com/v1/inference".
        proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
        timeout (int, optional): Время ожидания ответа от сервера. По умолчанию `180`.
        extra_data (dict, optional): Дополнительные данные для запроса. По умолчанию `{}`.
        **kwargs: Дополнительные аргументы.

    Returns:
        ImageResponse: Объект с информацией об изображении.
    """
    ...
```

**Назначение**:
Создание асинхронного запроса к API DeepInfra для генерации изображения на основе предоставленного текста запроса.

**Параметры**:
- `cls`: Ссылка на класс `DeepInfra`.
- `prompt` (str): Текст запроса для генерации изображения.
- `model` (str): Имя модели для генерации изображения.
- `api_key` (str, optional): API ключ для аутентификации. По умолчанию `None`.
- `api_base` (str, optional): Базовый URL API DeepInfra. По умолчанию "https://api.deepinfra.com/v1/inference".
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания ответа от сервера. По умолчанию `180`.
- `extra_data` (dict, optional): Дополнительные данные для запроса. По умолчанию `{}`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `ImageResponse`: Объект `ImageResponse` с информацией об изображении.

**Как работает функция**:
1. Формирует заголовки запроса, включая информацию о браузере и Deepinfra.
2. Если предоставлен `api_key`, добавляет его в заголовок `Authorization`.
3. Создает асинхронную сессию с использованием `StreamSession` и переданными параметрами (прокси, заголовки, таймаут).
4. Получает имя модели для запроса.
5. Формирует данные запроса, включая `prompt` и `extra_data`.
6. Отправляет POST-запрос к API DeepInfra с использованием сформированных данных.
7. Обрабатывает ответ от API, извлекая URL изображения из JSON-ответа.
8. Возвращает объект `ImageResponse` с информацией об изображении и текстом запроса.

**Примеры**:
```python
prompt = "A cat sitting on a mat"
image_response = await DeepInfra.create_async_image(prompt=prompt, model="stabilityai/sd3.5", api_key="YOUR_API_KEY")
print(image_response.image_url)
```
```
ASCII flowchart функции `create_async_image`:

Начало -> Формирование заголовков -> Создание асинхронной сессии
    ↓
    Получение имени модели -> Формирование данных запроса
    ↓
    Отправка POST-запроса к API DeepInfra -> Обработка ответа от API
    ↓
    Извлечение URL изображения -> Возврат объекта ImageResponse
    ↓
    Конец