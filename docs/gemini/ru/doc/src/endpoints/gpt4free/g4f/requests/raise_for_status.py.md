# Модуль обработки статусов ответов

## Обзор

Модуль предназначен для обработки HTTP-ответов, проверки их статусов и генерации исключений в случае ошибок, таких как ошибки Cloudflare, ошибки тарификации или другие проблемы, связанные с ответом сервера. Этот модуль предоставляет функции для асинхронной и синхронной проверки статусов ответа и генерации соответствующих исключений.

## Подробней

Данный модуль является частью проекта `hypotez` и предназначен для обработки различных ошибок, которые могут возникнуть при взаимодействии с серверами, такими как Cloudflare, OpenAI и другие. Он содержит функции для проверки статуса ответа и генерации исключений в случае обнаружения ошибок. Функции `raise_for_status_async` и `raise_for_status` используются для проверки статуса ответа и генерации исключений. Дополнительно, модуль определяет функцию `is_cloudflare` и `is_openai` для определения, является ли ошибка связанной с Cloudflare или OpenAI. Это позволяет более точно обрабатывать ошибки и предоставлять более информативные сообщения об ошибках.

## Классы

### `CloudflareError`

**Описание**:
Класс исключения, представляющий ошибку, связанную с Cloudflare. Наследуется от `ResponseStatusError`.

**Принцип работы**:
Используется для обозначения ситуаций, когда ответ сервера указывает на проблему, связанную с Cloudflare. Например, когда Cloudflare обнаруживает подозрительную активность.

## Функции

### `is_cloudflare`

```python
def is_cloudflare(text: str) -> bool:
    """
    Проверяет, содержит ли текст ответа признаки защиты Cloudflare.

    Args:
        text (str): Текст ответа, который необходимо проверить.

    Returns:
        bool: `True`, если текст содержит признаки Cloudflare, иначе `False`.
    """
```

**Как работает функция**:

Функция проверяет, содержит ли переданный текст признаки, указывающие на то, что ответ был сгенерирован Cloudflare. Это может быть полезно для определения, блокирует ли Cloudflare запросы.
Проверка осуществляется путем поиска известных строк, которые Cloudflare добавляет в свои страницы ожидания или страницы ошибок.

**Примеры**:

```python
text1 = "<html><body>Generated by cloudfront</body></html>"
text2 = "<title>Attention Required! | Cloudflare</title>"
text3 = "<div id=\"cf-please-wait\">Защита Cloudflare</div>"

print(is_cloudflare(text1))  # True
print(is_cloudflare(text2))  # True
print(is_cloudflare(text3))  # True
print(is_cloudflare("Простой текст")) # False
```

### `is_openai`

```python
def is_openai(text: str) -> bool:
    """
    Проверяет, содержит ли текст ответа признаки блокировки со стороны OpenAI.

    Args:
        text (str): Текст ответа, который необходимо проверить.

    Returns:
        bool: `True`, если текст содержит признаки блокировки OpenAI, иначе `False`.
    """
```

**Как работает функция**:

Функция проверяет, содержит ли переданный текст признаки, указывающие на то, что OpenAI заблокировал запрос. Это может быть полезно для определения, блокирует ли OpenAI запросы из-за подозрений в автоматизированном поведении.
Проверка осуществляется путем поиска известных строк, которые OpenAI добавляет в свои страницы ошибок.

**Примеры**:

```python
text1 = "<p>Unable to load site</p>"
text2 = "id=\"challenge-error-text\""

print(is_openai(text1))  # True
print(is_openai(text2))  # True
print(is_openai("Простой текст")) # False
```

### `raise_for_status_async`

```python
async def raise_for_status_async(response: Union[StreamResponse, ClientResponse], message: str = None):
    """
    Асинхронно проверяет статус HTTP-ответа и вызывает исключение, если статус указывает на ошибку.

    Args:
        response (Union[StreamResponse, ClientResponse]): Объект асинхронного HTTP-ответа.
        message (str, optional): Дополнительное сообщение об ошибке. Defaults to None.

    Raises:
        MissingAuthError: Если статус ответа 401 (не авторизован).
        CloudflareError: Если статус ответа 403 и обнаружена защита Cloudflare.
        ResponseStatusError: Если статус ответа 403 и обнаружена блокировка OpenAI, или если произошла другая ошибка.
        RateLimitError: Если статус ответа 504 (Gateway Timeout).
        ResponseStatusError: Если статус ответа не 200 и не обработан другими условиями.
    """
```

**Как работает функция**:

1. **Проверка успешности ответа**: Функция начинает с проверки, является ли статус ответа успешным (`response.ok`). Если ответ успешен, функция немедленно возвращается, ничего не делая.

2. **Обработка содержимого ответа**: Если `message` не предоставлено, функция пытается извлечь сообщение об ошибке из тела ответа. Если `content-type` заголовка начинается с `application/json`, функция пытается разобрать JSON и извлечь сообщение из поля `error` или самого объекта JSON. Если `content-type` указывает на `text/html` или тело ответа начинается с `<!DOCTYPE`, функция сохраняет факт, что ответ является HTML. В противном случае функция пытается прочитать текст ответа.

3. **Проверка конкретных статусов ошибок**:
   - Если статус ответа 520, устанавливается сообщение "Unknown error (Cloudflare)".
   - Если статус ответа 429 или 402, устанавливается сообщение "Rate limit".

4. **Генерация исключений**:
   - Если статус ответа 401, генерируется исключение `MissingAuthError`.
   - Если статус ответа 403 и обнаружена защита Cloudflare (с использованием `is_cloudflare`), генерируется исключение `CloudflareError`.
   - Если статус ответа 403 и обнаружена блокировка OpenAI (с использованием `is_openai`), генерируется исключение `ResponseStatusError`.
   - Если статус ответа 502, генерируется исключение `ResponseStatusError` с сообщением "Bad Gateway".
   - Если статус ответа 504, генерируется исключение `RateLimitError` с сообщением "Gateway Timeout".
   - Для всех остальных ошибок генерируется исключение `ResponseStatusError` с общим сообщением об ошибке.

**Примеры**:

```python
import aiohttp
import asyncio

async def main():
    async with aiohttp.ClientSession() as session:
        # Пример успешного ответа
        async with session.get('https://example.com') as response:
            try:
                await raise_for_status_async(response)
                print('Запрос успешен')
            except Exception as ex:
                print(f'Произошла ошибка: {ex}')

        # Пример ответа с ошибкой 404
        async with session.get('https://example.com/nonexistent') as response:
            try:
                await raise_for_status_async(response)
            except Exception as ex:
                print(f'Произошла ошибка: {ex}')

if __name__ == "__main__":
    asyncio.run(main())
```

### `raise_for_status`

```python
def raise_for_status(response: Union[Response, StreamResponse, ClientResponse, RequestsResponse], message: str = None):
    """
    Проверяет статус HTTP-ответа и вызывает исключение, если статус указывает на ошибку.

    Args:
        response (Union[Response, StreamResponse, ClientResponse, RequestsResponse]): Объект HTTP-ответа.
        message (str, optional): Дополнительное сообщение об ошибке. Defaults to None.

    Raises:
        MissingAuthError: Если статус ответа 401 (не авторизован).
        CloudflareError: Если статус ответа 403 и обнаружена защита Cloudflare.
        ResponseStatusError: Если статус ответа 403 и обнаружена блокировка OpenAI, или если произошла другая ошибка.
        RateLimitError: Если статус ответа 504 (Gateway Timeout).
        ResponseStatusError: Если статус ответа не 200 и не обработан другими условиями.
    """
```

**Как работает функция**:

1. **Определение типа ответа**: Функция сначала проверяет, является ли переданный объект `response` асинхронным ответом (т.е. имеет ли он атрибут `status`). Если да, то вызывается `raise_for_status_async` для обработки асинхронного ответа.

2. **Проверка успешности ответа**: Если ответ не асинхронный, функция проверяет, является ли статус ответа успешным (`response.ok`). Если ответ успешен, функция немедленно возвращается, ничего не делая.

3. **Обработка содержимого ответа**: Если `message` не предоставлено, функция пытается определить, является ли содержимое ответа HTML, проверяя заголовок `content-type` или начало тела ответа на наличие `<!DOCTYPE`. Затем функция пытается получить текст ответа.

4. **Проверка конкретных статусов ошибок**:
   - Если статус ответа 520, устанавливается сообщение "Unknown error (Cloudflare)".
   - Если статус ответа 429 или 402, генерируется исключение `RateLimitError` с сообщением "Rate Limit".

5. **Генерация исключений**:
   - Если статус ответа 401, генерируется исключение `MissingAuthError`.
   - Если статус ответа 403 и обнаружена защита Cloudflare (с использованием `is_cloudflare`), генерируется исключение `CloudflareError`.
   - Если статус ответа 403 и обнаружена блокировка OpenAI (с использованием `is_openai`), генерируется исключение `ResponseStatusError`.
   - Если статус ответа 502, генерируется исключение `ResponseStatusError` с сообщением "Bad Gateway".
   - Если статус ответа 504, генерируется исключение `RateLimitError` с сообщением "Gateway Timeout".
   - Для всех остальных ошибок генерируется исключение `ResponseStatusError` с общим сообщением об ошибке, указывающим на HTML-содержимое или сообщение, если оно есть.

**Примеры**:

```python
import requests

# Пример успешного ответа
response = requests.get('https://example.com')
try:
    raise_for_status(response)
    print('Запрос успешен')
except Exception as ex:
    print(f'Произошла ошибка: {ex}')

# Пример ответа с ошибкой 404
response = requests.get('https://example.com/nonexistent')
try:
    raise_for_status(response)
except Exception as ex:
    print(f'Произошла ошибка: {ex}')