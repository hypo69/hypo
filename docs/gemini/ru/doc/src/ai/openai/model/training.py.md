# Модуль `training.py`

## Обзор

Модуль `training.py` предоставляет класс `OpenAIModel` для взаимодействия с API OpenAI, управления моделями, ассистентами, а также обучения и тонкой настройки моделей. Этот модуль позволяет загружать доступные модели и ассистентов, отправлять сообщения, анализировать тональность, описывать изображения, динамически переобучать модель и сохранять идентификаторы заданий обучения.

## Содержание

- [Классы](#классы)
    - [`OpenAIModel`](#openaimodel)
        - [`__init__`](#__init__)
        - [`list_models`](#list_models)
        - [`list_assistants`](#list_assistants)
        - [`set_assistant`](#set_assistant)
        - [`_save_dialogue`](#_save_dialogue)
        - [`determine_sentiment`](#determine_sentiment)
        - [`ask`](#ask)
        - [`describe_image`](#describe_image)
        - [`describe_image_by_requests`](#describe_image_by_requests)
        - [`dynamic_train`](#dynamic_train)
        - [`train`](#train)
        - [`save_job_id`](#save_job_id)
- [Функции](#функции)
    - [`main`](#main)

## Классы

### `OpenAIModel`

**Описание**: Класс для взаимодействия с API OpenAI, управления моделями и ассистентами, а также для обучения и тонкой настройки моделей.

**Атрибуты**:
- `model` (str): Название используемой модели по умолчанию "gpt-4o-mini".
- `client` (OpenAI): Клиент OpenAI API.
- `current_job_id` (str): Идентификатор текущего задания обучения.
- `assistant_id` (str): Идентификатор используемого ассистента.
- `assistant`: Объект ассистента.
- `thread`: Объект треда.
- `system_instruction` (str): Системная инструкция для модели.
- `dialogue_log_path` (str | Path): Путь к файлу журнала диалога.
- `dialogue` (List[Dict[str, str]]): Список диалогов.
- `assistants` (List[SimpleNamespace]): Список доступных ассистентов.
- `models_list` (List[str]): Список доступных моделей.

#### `__init__`

**Описание**: Инициализация объекта `OpenAIModel`.

**Параметры**:
- `system_instruction` (str, optional): Системная инструкция для модели.
- `model_name` (str, optional): Название используемой модели. По умолчанию `gpt-4o-mini`.
- `assistant_id` (str, optional): Идентификатор ассистента. По умолчанию берется из `gs.credentials.openai.assistant_id.code_assistant`.

#### `list_models`

**Описание**: Возвращает список доступных моделей из API OpenAI.

**Возвращает**:
- `List[str]`: Список идентификаторов доступных моделей.

**Вызывает исключения**:
- `Exception`: В случае ошибки при загрузке моделей.

#### `list_assistants`

**Описание**: Загружает и возвращает список доступных ассистентов из JSON-файла.

**Возвращает**:
- `List[str]`: Список имен доступных ассистентов.

**Вызывает исключения**:
- `Exception`: В случае ошибки при загрузке ассистентов.

#### `set_assistant`

**Описание**: Устанавливает ассистента, используя предоставленный идентификатор.

**Параметры**:
- `assistant_id` (str): Идентификатор ассистента.

**Вызывает исключения**:
- `Exception`: В случае ошибки при установке ассистента.

#### `_save_dialogue`

**Описание**: Сохраняет весь диалог в JSON-файл.

#### `determine_sentiment`

**Описание**: Определяет тональность сообщения (положительная, отрицательная или нейтральная).

**Параметры**:
- `message` (str): Сообщение для анализа.

**Возвращает**:
- `str`: Тональность сообщения (`positive`, `negative` или `neutral`).

#### `ask`

**Описание**: Отправляет сообщение модели и возвращает ответ, включая анализ тональности.

**Параметры**:
- `message` (str): Сообщение для отправки модели.
- `system_instruction` (str, optional): Опциональная системная инструкция.
- `attempts` (int, optional): Количество попыток отправки запроса. По умолчанию 3.

**Возвращает**:
- `str`: Ответ модели.

**Вызывает исключения**:
- `Exception`: В случае ошибки при отправке сообщения.

#### `describe_image`

**Описание**: Отправляет изображение модели и получает его текстовое описание.

**Параметры**:
- `image_path` (str | Path): Путь к изображению.
- `prompt` (Optional[str], optional): Опциональный запрос к модели. По умолчанию `None`.
- `system_instruction` (Optional[str], optional): Опциональная системная инструкция. По умолчанию `None`.

**Возвращает**:
- `str`: Ответ модели.

**Вызывает исключения**:
- `Exception`: В случае ошибки при описании изображения.

#### `describe_image_by_requests`

**Описание**: Отправляет изображение в OpenAI API через `requests` и получает его описание.

**Параметры**:
- `image_path` (str | Path): Путь к изображению.
- `prompt` (str, optional): Запрос к модели. По умолчанию `None`.

**Вызывает исключения**:
- `Exception`: В случае ошибки при отправке запроса.

#### `dynamic_train`

**Описание**: Загружает предыдущий диалог и настраивает модель на его основе.

**Вызывает исключения**:
- `Exception`: В случае ошибки во время динамической настройки.

#### `train`

**Описание**: Обучает модель на указанных данных или директории.

**Параметры**:
- `data` (str, optional): Путь к CSV-файлу или CSV-форматированная строка с данными.
- `data_dir` (Path | str, optional): Директория с CSV-файлами для обучения.
- `data_file` (Path | str, optional): Путь к одному CSV-файлу с данными для обучения.
- `positive` (bool, optional): Указывает, являются ли данные положительными или отрицательными. По умолчанию `True`.

**Возвращает**:
- `str | None`: Идентификатор задания обучения или `None`, если произошла ошибка.

**Вызывает исключения**:
- `Exception`: В случае ошибки во время обучения.

#### `save_job_id`

**Описание**: Сохраняет идентификатор задания с описанием в файл.

**Параметры**:
- `job_id` (str): Идентификатор задания.
- `description` (str): Описание задания.
- `filename` (str, optional): Имя файла для сохранения ID. По умолчанию `"job_ids.json"`.

## Функции

### `main`

**Описание**: Основная функция для инициализации `OpenAIModel` и демонстрации его использования.
   
   - Инициализирует `OpenAIModel` с системной инструкцией и идентификатором ассистента.
   - Выводит список доступных моделей и ассистентов.
   - Отправляет сообщение модели и получает ответ.
   - Выполняет динамическое обучение на основе прошлых диалогов.
   - Запускает обучение модели с использованием данных из файла `training_data.csv`.
   - Сохраняет идентификатор задания обучения в JSON-файл.
   - Демонстрирует описание изображения.