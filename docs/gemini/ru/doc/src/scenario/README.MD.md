# Модуль `src.scenario`

## Обзор

Модуль `src.scenario` предназначен для автоматизации взаимодействия с поставщиками с использованием сценариев, описанных в файлах JSON. Он упрощает процесс извлечения и обработки данных о продуктах с веб-сайтов поставщиков и синхронизирует эту информацию с базой данных (например, PrestaShop). Модуль включает в себя функциональность для чтения сценариев, взаимодействия с веб-сайтами, обработки данных, ведения журналов выполнения и организации всего рабочего процесса.

## Оглавление

* [Модуль `src.scenario`](#module-src-scenario)
* [Обзор](#обзор)
* [Основные функции модуля](#основные-функции-модуля)
* [Основные компоненты модуля](#основные-компоненты-модуля)
    * [`run_scenario_files(s, scenario_files_list)`](#run_scenario_files-s-scenario_files_list)
    * [`run_scenario_file(s, scenario_file)`](#run_scenario_file-s-scenario_file)
    * [`run_scenario(s, scenario)`](#run_scenario-s-scenario)
    * [`dump_journal(s, journal)`](#dump_journal-s-journal)
    * [`main()`](#main)
* [Пример сценария](#пример-сценария)
* [Как это работает](#как-это-работает)

## Подробнее

Модуль `src.scenario` используется для автоматизации процесса получения данных о товарах с сайтов поставщиков и их интеграции в базу данных PrestaShop. Он позволяет запускать сценарии, описанные в JSON-файлах, которые определяют, какие данные и с каких страниц сайта поставщика необходимо извлечь. Это упрощает процесс обновления информации о товарах в PrestaShop и уменьшает количество ручной работы.

## Основные функции модуля

1. **Чтение сценариев**: Загрузка сценариев из файлов JSON, содержащих информацию о продуктах и URL-адреса на веб-сайте поставщика.
2. **Взаимодействие с веб-сайтами**: Обработка URL-адресов из сценариев для извлечения данных о продуктах.
3. **Обработка данных**: Преобразование извлеченных данных в формат, подходящий для базы данных, и их сохранение.
4. **Ведение журнала выполнения**: Поддержание журналов с деталями выполнения сценария и результатами для отслеживания прогресса и выявления ошибок.

## Основные компоненты модуля

### `run_scenario_files(s, scenario_files_list)`

**Описание**: Принимает список файлов сценариев и выполняет их последовательно, вызывая функцию `run_scenario_file` для каждого файла.

**Параметры**:
- `s`: Объект настроек (например, для подключения к базе данных).
- `scenario_files_list` (list): Список путей к файлам сценариев.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `FileNotFoundError`: Если файл сценария не найден.
- `JSONDecodeError`: Если файл сценария содержит неверный JSON.

**Как работает функция**:

1. Функция `run_scenario_files` принимает список файлов сценариев `scenario_files_list` и объект настроек `s`.
2.  Для каждого файла в списке `scenario_files_list` вызывается функция `run_scenario_file`, которой передается объект настроек `s` и текущий файл сценария.
3. Если в процессе обработки файла сценария возникают ошибки, такие как `FileNotFoundError` или `JSONDecodeError`, они перехватываются и логируются с использованием `logger.error`.

```ascii
Начало --> Проверка списка файлов --> Для каждого файла: Вызов run_scenario_file --> Обработка ошибок --> Конец
```

**Примеры**:

```python
# Пример вызова функции с списком файлов сценариев
settings = {}  # Объект настроек
scenario_files = ['scenario1.json', 'scenario2.json']
run_scenario_files(settings, scenario_files)
```

### `run_scenario_file(s, scenario_file)`

**Описание**: Загружает сценарии из указанного файла и вызывает `run_scenario` для каждого сценария в файле.

**Параметры**:
- `s`: Объект настроек.
- `scenario_file` (str): Путь к файлу сценария.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `FileNotFoundError`: Если файл сценария не найден.
- `JSONDecodeError`: Если файл сценария содержит неверный JSON.
- `Exception`: Для любых других проблем во время выполнения сценария.

**Как работает функция**:

1. Функция `run_scenario_file` принимает объект настроек `s` и путь к файлу сценария `scenario_file`.
2.  Загружает сценарии из файла `scenario_file`, используя `j_loads`. Если файл не найден или содержит неверный JSON, возникают исключения `FileNotFoundError` или `JSONDecodeError`, которые перехватываются и логируются с использованием `logger.error`.
3. Если загрузка сценариев прошла успешно, для каждого сценария в загруженных сценариях вызывается функция `run_scenario`, которой передается объект настроек `s` и текущий сценарий.
4. Если в процессе выполнения сценария возникают какие-либо другие исключения, они также перехватываются и логируются с использованием `logger.error`.

```ascii
Начало --> Загрузка сценариев из файла --> Для каждого сценария: Вызов run_scenario --> Обработка ошибок --> Конец
```

**Примеры**:

```python
# Пример вызова функции с файлом сценария
settings = {}  # Объект настроек
scenario_file = 'scenario.json'
run_scenario_file(settings, scenario_file)
```

### `run_scenario(s, scenario)`

**Описание**: Обрабатывает отдельный сценарий, переходя по URL-адресу, извлекая данные о продукте и сохраняя их в базу данных.

**Параметры**:
- `s`: Объект настроек.
- `scenario` (dict): Словарь, содержащий сценарий (например, с URL-адресом и категориями).

**Возвращает**:
- `None`

**Вызывает исключения**:
- `requests.exceptions.RequestException`: Если есть проблемы с запросом к веб-сайту.
- `Exception`: Для любых других проблем во время обработки сценария.

**Как работает функция**:

1. Функция `run_scenario` принимает объект настроек `s` и словарь `scenario`, содержащий информацию о сценарии.
2. Извлекает URL-адрес из сценария и переходит по нему с использованием `requests`.
3. Извлекает данные о продукте со страницы, используя локаторы, определенные в сценарии.
4. Сохраняет данные о продукте в базу данных PrestaShop.
5. Если в процессе выполнения сценария возникают ошибки, такие как проблемы с запросом к веб-сайту или другие исключения, они перехватываются и логируются с использованием `logger.error`.

```ascii
Начало --> Переход по URL-адресу --> Извлечение данных о продукте --> Сохранение данных в базу данных --> Обработка ошибок --> Конец
```

**Примеры**:

```python
# Пример вызова функции с сценарием
settings = {}  # Объект настроек
scenario = {'url': 'https://example.com/product', 'category': 'кремы'}
run_scenario(settings, scenario)
```

### `dump_journal(s, journal)`

**Описание**: Сохраняет журнал выполнения в файл для последующего анализа.

**Параметры**:
- `s`: Объект настроек.
- `journal` (list): Список записей журнала выполнения.

**Возвращает**:
- `None`

**Вызывает исключения**:
- `Exception`: Если есть проблемы с записью в файл.

**Как работает функция**:

1. Функция `dump_journal` принимает объект настроек `s` и список записей журнала `journal`.
2. Открывает файл для записи журнала и записывает в него данные из списка `journal`.
3. Если в процессе записи в файл возникают ошибки, они перехватываются и логируются с использованием `logger.error`.

```ascii
Начало --> Открытие файла для записи --> Запись журнала в файл --> Обработка ошибок --> Конец
```

**Примеры**:

```python
# Пример вызова функции с журналом
settings = {}  # Объект настроек
journal = ['Запись 1', 'Запись 2']
dump_journal(settings, journal)
```

### `main()`

**Описание**: Основная функция для запуска модуля.

**Параметры**:
- `None`

**Возвращает**:
- `None`

**Вызывает исключения**:
- `Exception`: Для любых критических ошибок во время выполнения.

**Как работает функция**:

1. Функция `main` является точкой входа в модуль.
2.  Выполняет основные задачи модуля, такие как загрузка настроек, запуск сценариев и обработка результатов.
3. Если в процессе выполнения возникают критические ошибки, они перехватываются и логируются с использованием `logger.error`.

```ascii
Начало --> Загрузка настроек --> Запуск сценариев --> Обработка результатов --> Обработка ошибок --> Конец
```

**Примеры**:

```python
# Пример вызова функции main
main()
```

## Пример сценария

Пример сценария JSON описывает взаимодействие с категориями продуктов на веб-сайте. Он включает в себя URL-адрес, название категории и идентификаторы категории в базе данных PrestaShop.

```json
{
    "scenarios": {
        "mineral+creams": {
            "url": "https://example.com/category/mineral-creams/",
            "name": "mineral+creams",
            "presta_categories": {
                "default_category": 12345,
                "additional_categories": [12346, 12347]
            }
        }
    }
}
```

## Как это работает

Модуль `src.scenario` работает следующим образом:

1. Функция `main` запускает процесс.
2. Загружаются файлы сценариев, содержащие информацию о категориях товаров и URL-адресах на сайтах поставщиков.
3. Для каждого сценария модуль переходит по указанному URL-адресу и извлекает данные о товарах.
4. Извлеченные данные преобразуются в формат, подходящий для базы данных PrestaShop.
5. Данные о товарах сохраняются в базу данных PrestaShop.
6. В процессе выполнения ведется журнал, в котором регистрируются все действия и ошибки.