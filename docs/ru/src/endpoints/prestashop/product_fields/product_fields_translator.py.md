# Модуль `product_fields_translator`

## Обзор

Модуль предназначен для перевода полей товара на языки, используемые в клиентской базе данных PrestaShop. Он обеспечивает соответствие языковых идентификаторов между системой поставщика и клиентской системой, что необходимо для корректного отображения мультиязычного контента.

## Подробней

Этот модуль играет важную роль в процессе интеграции данных о товарах из системы поставщика в PrestaShop. Он решает задачу соответствия языковых идентификаторов, которые могут отличаться между системами.  В частности, модуль предназначен для работы с мультиязычными полями товара, содержащими значения, полученные с сайта поставщика в виде словаря, где каждый язык имеет свой уникальный идентификатор. Этот модуль гарантирует, что эти идентификаторы будут правильно сопоставлены с идентификаторами, используемыми в базе данных клиента PrestaShop.

## Функции

### `rearrange_language_keys`

```python
def rearrange_language_keys(presta_fields_dict: dict, client_langs_schema: dict | List[dict], page_lang: str) -> dict:
    """Функция обновляет идентификатор языка в словаре presta_fields_dict на соответствующий идентификатор
    из схемы клиентских языков при совпадении языка страницы.

    Args:
        presta_fields_dict (dict): Словарь полей товара.
        page_lang (str): Язык страницы.
        client_langs_schema (list | dict): Схема языков клиента.

    Returns:
        dict: Обновленный словарь presta_fields_dict.
    """
    ...
```

**Назначение**: Обновляет идентификаторы языка в словаре `presta_fields_dict` на идентификаторы из схемы клиентских языков, когда язык страницы совпадает.

**Параметры**:

-   `presta_fields_dict` (dict): Словарь полей товара, который необходимо обновить.
-   `client_langs_schema` (dict | List[dict]): Схема языков клиента, используемая для поиска соответствий.
-   `page_lang` (str): Язык текущей страницы, для которого выполняется поиск соответствия.

**Возвращает**:

-   `dict`: Обновленный словарь `presta_fields_dict` с новыми идентификаторами языков.

**Как работает функция**:

1.  **Инициализация**: Функция начинает с поиска соответствующего идентификатора языка в схеме клиентских языков.

2.  **Поиск соответствия**: Перебирает языки в `client_langs_schema` и сравнивает их атрибуты `locale`, `iso_code` и `language_code` с `page_lang`.

3.  **Обновление идентификаторов**: Если соответствие найдено, функция перебирает поля в `presta_fields_dict` и, если поле содержит данные о языке, обновляет атрибут `id` на `client_lang_id`.
4.  **Приведение типов**: Устанавливает значение атрибута `id` как строку, что важно для совместимости с XML парсером.
5.  **Возврат результата**: Возвращает обновленный словарь `presta_fields_dict`.

**ASCII flowchart**:

```
Начало
  │
  │ Поиск client_lang_id в client_langs_schema
  │
  │ Если client_lang_id найден
  │ │
  │ │ Обновление id в presta_fields_dict
  │ │
  │ Конец
  │
Конец
```

**Примеры**:

```python
presta_fields = {'name': {'language': [{'attrs': {'id': '1'}, 'value': 'Test'}]}}
client_schema = [{'locale': 'en-US', 'id': 10}]
page_language = 'en-US'
updated_fields = rearrange_language_keys(presta_fields, client_schema, page_language)
print(updated_fields)
# Ожидаемый результат: {'name': {'language': [{'attrs': {'id': '10'}, 'value': 'Test'}]}}
```

### `translate_presta_fields_dict`

```python
def translate_presta_fields_dict (presta_fields_dict: dict, 
                                  client_langs_schema: list | dict, 
                                  page_lang: str = None) -> dict:
    """ @Перевод мультиязычных полей в соответствии со схемой значений `id` языка в базе данных клиента
	    Функция получает на вход заполненный словарь полей. Мультиязычные поля содржат значения,\n
	    полученные с сайта поставщика в виде словаря 
	    ```
	    {
	\t    \'language\':[\n
	\t\t\t\t\t    {\'attrs\':{\'id\':\'1\'}, \'value\':value},\n
	\t\t\t\t\t    ]\n
	    }\n
	    ```
	    У клиента язык с ключом `id=1` Может быть любым в зависимости от того на каком языке была \n
	    изначально установлена PrestaShop. Чаще всего это английский, но это не правило.\n
	    Точные соответствия я получаю в схеме языков клиента 
	    locator_description
	    Самый быстрый способ узнать схему API языков - набрать в адресной строке браузера
	    https://API_KEY@mypresta.com/api/languages?display=full&io_format=JSON
	  
    @param client_langs_schema `dict` словарь актуальных языков на клиенте
    @param presta_fields_dict `dict` словарь полей товара собранный со страницы поставщика
    @param page_lang `str` язык страницы поставщика в коде en-US, ru-RU, he_HE. 
    Если не задан - функция пытается определить п тексту
    @returns presta_fields_dict переведенный словарь полей товара
    """
    ...
```

**Назначение**: Переводит мультиязычные поля в соответствии со схемой значений `id` языка в базе данных клиента.

**Параметры**:

-   `presta_fields_dict` (dict): Словарь полей товара, собранный со страницы поставщика.
-   `client_langs_schema` (list | dict): Словарь актуальных языков на клиенте.
-   `page_lang` (str, optional): Язык страницы поставщика в коде (например, en-US, ru-RU). Если не указан, функция попытается определить его автоматически. По умолчанию `None`.

**Возвращает**:

-   `dict`: Переведенный словарь полей товара.

**Как работает функция**:

1.  **Переупорядочивание ключей**: Вызывает функцию `rearrange_language_keys` для обновления идентификаторов языков.

2.  **Получение существующих переводов**: Попытка извлечь существующие переводы товара из таблицы переводов PrestaShop.

3.  **Обработка отсутствующих переводов**: Если переводы отсутствуют, добавляет текущий перевод как новый в таблицу переводов.

4.  **Перевод по схемам**: Перебирает языки клиента и записи перевода для сопоставления и обновления перевода в соответствии с `iso_code`.

5.  **Обработка ошибок**: В случае возникновения ошибки логирует информацию об ошибке и языке клиента.

**ASCII flowchart**:

```
Начало
  │
  │ rearrange_language_keys()
  │
  │ enabled_product_translations = get_translations_from_presta_translations_table()
  │
  │ Если not enabled_product_translations
  │ │
  │ │ insert_new_translation_to_presta_translations_table()
  │ │
  │ Иначе
  │ │
  │ │ Перевод по схемам client_langs_schema
  │ │
  │ Конец если
  │
Конец
```

**Примеры**:

```python
presta_fields = {'name': {'language': [{'attrs': {'id': '1'}, 'value': 'Test'}], 'reference': '123'}}
client_schema = [{'locale': 'en-US', 'id': 10, 'iso_code': 'en'}]
translated_fields = translate_presta_fields_dict(presta_fields, client_schema, 'en-US')
print(translated_fields)
# {'name': {'language': [{'attrs': {'id': '10'}, 'value': 'Test'}], 'reference': '123'}}