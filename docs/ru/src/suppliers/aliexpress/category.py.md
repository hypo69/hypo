# Модуль для управления категориями Aliexpress

## Обзор

Модуль `category.py` предназначен для управления категориями товаров на сайте Aliexpress. Он содержит функции для сбора URL товаров из категорий, обновления информации о категориях в файлах сценариев, а также для взаимодействия с базой данных категорий.

## Подробнее

Этот модуль является важной частью процесса сбора данных с Aliexpress. Он автоматизирует навигацию по категориям, извлечение ссылок на товары и синхронизацию информации о категориях между локальными файлами сценариев и данными, полученными с сайта. Модуль использует веб-драйвер для взаимодействия с сайтом и базу данных для хранения и управления категориями.

## Функции

### `get_list_products_in_category`

```python
def get_list_products_in_category(s) -> list[str, str]:
    """  
     Считывает URL товаров со страницы категории.

    Args:
        s: Экземпляр класса `Supplier`.
        run_async (bool): Устанавливает синхронность/асинхронность исполнения функции `async_get_list_products_in_category()`.

    Returns:
        list[str, str]: Список собранных URL. Может быть пустым, если в исследуемой категории нет товаров.
    """
    ...
```

**Назначение**: Извлекает URL товаров со страницы категории Aliexpress. Если в категории несколько страниц, функция переходит по всем страницам и собирает ссылки.

**Параметры**:

-   `s`: Экземпляр класса `Supplier`, содержащий информацию о поставщике и настройки веб-драйвера.

**Возвращает**:

-   `list[str, str]`: Список URL товаров, найденных в категории. Возвращает пустой список, если товаров в категории нет.

**Как работает функция**:

1.  Вызывает функцию `get_prod_urls_from_pagination(s)` для получения URL товаров с пагинацией.

**Примеры**:

```python
# Пример вызова функции
supplier_instance = Supplier(...) # Предполагается, что класс Supplier определен в другом месте
product_urls = get_list_products_in_category(supplier_instance)
print(product_urls)
```

### `get_prod_urls_from_pagination`

```python
def get_prod_urls_from_pagination(s) -> list[str]:
    """   Функция собирает ссылки на товары со страницы категории с перелистыванием страниц 
    Args:
        s: Экземпляр класса `Supplier`.

    Returns:
        list[str]: Список ссылок, собранных со страницы категории.
    """
    ...
```

**Назначение**: Собирает ссылки на товары со страницы категории, перелистывая страницы, если это необходимо.

**Параметры**:

-   `s`: Экземпляр класса `Supplier`, содержащий информацию о поставщике и настройки веб-драйвера.

**Возвращает**:

-   `list[str]`: Список URL товаров, найденных на всех страницах категории.

**Как работает функция**:

1.  Инициализирует веб-драйвер и локаторы (`_d` и `_l`).
2.  Получает список URL товаров с текущей страницы.
3.  Если список пуст, возвращает пустой список (нет товаров в категории).
4.  В цикле переходит на следующую страницу, пока это возможно, и добавляет URL товаров с каждой страницы в общий список.

```ascii
    Начало
     ↓
    Получение URL с текущей страницы (list_products_in_category = _d.execute_locator(_l))
     ↓
    Список пуст?
     ├── Да →  Вернуть пустой список
     ↓  └── Нет
     ↓
    Цикл: Пока есть кнопка "Следующая страница"
     ├── Да →  Нажать "Следующая страница" (_d.execute_locator (s.locators [\'category\'][\'pagination\'][\'->\']))
     │   ↓    Добавить URL с текущей страницы в общий список (list_products_in_category.extend(_d.execute_locator(_l )))
     ↓  └── Нет →  Выход из цикла
     ↓
    Вернуть общий список URL
     Конец
```

**Примеры**:

```python
# Пример вызова функции
supplier_instance = Supplier(...) # Предполагается, что класс Supplier определен в другом месте
product_urls = get_prod_urls_from_pagination(supplier_instance)
print(product_urls)
```

### `update_categories_in_scenario_file`

```python
def update_categories_in_scenario_file(s, scenario_filename: str) -> bool:
    """  Проверка изменений категорий на сайте 
    Args:
        s: Неизвестный параметр
        scenario_filename (str): Имя файла сценария.

    Returns:
        bool: Возвращает `True` после завершения обновления.
    """
    ...
```

**Назначение**: Обновляет информацию о категориях в файле сценария на основе данных, полученных с сайта. Сравнивает категории в файле сценария с категориями на сайте и добавляет или отключает категории в файле.

**Параметры**:

-   `s`: Экземпляр класса `Supplier`.
-   `scenario_filename`: Имя файла сценария (JSON), который нужно обновить.

**Возвращает**:

-   `bool`: `True`, если обновление выполнено успешно.

**Как работает функция**:

1.  Загружает файл сценария и получает список категорий из файла.
2.  Получает список категорий с сайта.
3.  Сравнивает списки категорий и определяет добавленные и удаленные категории.
4.  Обновляет файл сценария, добавляя новые категории и отключая удаленные.
5.  Отправляет уведомления о добавленных и удаленных категориях.

```ascii
    Начало
     ↓
    Загрузка файла сценария (scenario_json = j_loads(...))
     ↓
    Получение списка категорий с сайта (categoris_on_site = get_list_categories_from_site())
     ↓
    Извлечение идентификаторов категорий из файла (all_ids_in_file)
     ↓
    Получение категорий магазина из JSON (categories_from_aliexpress_shop_json)
     ↓
    Определение добавленных и удаленных категорий (added_categories, removed_categories)
     ↓
    Обновление файла сценария (scenario_json)
     ↓
    Отправка уведомлений
     ↓
    Вернуть True
     Конец
```

**Внутренние функции**:

*   `_update_all_ids_in_file`:

    ```python
        def _update_all_ids_in_file():
            """  Внутренняя функция для обновления всех идентификаторов категорий в файле сценария. """
            ...
    ```

    **Назначение**: Извлекает и обновляет идентификаторы категорий в файле сценария.

    **Как работает функция**:

    1.  Проходит по всем категориям в файле сценария.
    2.  Если идентификатор категории определен, добавляет его в список `all_ids_in_file`.
    3.  Если идентификатор не определен, извлекает его из URL категории и добавляет в список.

**Примеры**:

```python
# Пример вызова функции
supplier_instance = Supplier(...) # Предполагается, что класс Supplier определен в другом месте
scenario_file = "example_scenario.json"
update_result = update_categories_in_scenario_file(supplier_instance, scenario_file)
print(update_result)
```

### `get_list_categories_from_site`

```python
def get_list_categories_from_site(s,scenario_file,brand=''):
    """   
    Args:
        s: Неизвестный параметр
        scenario_file: Неизвестный параметр
        brand: Неизвестный параметр. По умолчанию ''.
    """
    ...
```

**Назначение**: Получает список категорий с сайта Aliexpress.

**Параметры**:

-   `s`: Экземпляр класса `Supplier`.
-   `scenario_file`: Имя файла сценария, содержащего URL страницы категорий магазина.
-   `brand`: Не используется.

**Как работает функция**:

1.  Загружает файл сценария.
2.  Переходит на страницу категорий магазина, указанную в файле сценария.
3.  <логика получения категорий с сайта>

**Примеры**:

```python
# Пример вызова функции
supplier_instance = Supplier(...) # Предполагается, что класс Supplier определен в другом месте
scenario_file = "example_scenario.json"
categories = get_list_categories_from_site(supplier_instance, scenario_file)
print(categories)
```

## Классы

### `DBAdaptor`

```python
class DBAdaptor():
    """ Адаптер для взаимодействия с базой данных категорий Aliexpress.

    """
    ...
```

**Описание**: Класс-адаптер для выполнения операций с базой данных категорий Aliexpress. Предоставляет методы для выборки, вставки, обновления и удаления записей в таблице категорий.

**Методы**:

*   `select`

    ```python
    def select(cat_id:int = None, parent_id:int = None, project_cat_id:int = None ):
        """  Пример операции SELECT
        Args:
            cat_id (int, optional):  По умолчанию `None`.
            parent_id (int, optional):  По умолчанию `None`.
            project_cat_id (int, optional):  По умолчанию `None`.
        """
        ...
    ```

    **Назначение**: Выбирает записи из таблицы `AliexpressCategory` на основе заданных критериев.

    **Параметры**:

    -   `cat_id` (int, optional): ID категории. По умолчанию `None`.
    -   `parent_id` (int, optional): ID родительской категории. По умолчанию `None`.
    -   `project_cat_id` (int, optional): ID категории в проекте. По умолчанию `None`.

    **Как работает функция**:

    1.  Вызывает метод `select_record` класса `CategoryManager` для выполнения операции SELECT.
    2.  Выводит полученные записи.

*   `insert`

    ```python
    def insert():
        """ Пример операции INSERT
        """
        ...
    ```

    **Назначение**: Вставляет новую запись в таблицу `AliexpressCategory`.

    **Как работает функция**:

    1.  Определяет поля и значения для новой записи.
    2.  Вызывает метод `insert_record` класса `CategoryManager` для выполнения операции INSERT.

*   `update`

    ```python
    def update():
        """ Пример операции UPDATE
        """
        ...
    ```

    **Назначение**: Обновляет запись в таблице `AliexpressCategory`.

    **Как работает функция**:

    1.  Определяет ID записи и новые значения полей.
    2.  Вызывает метод `update_record` класса `CategoryManager` для выполнения операции UPDATE.

*   `delete`

    ```python
    def delete():
        """ Пример операции DELETE
        """
        ...
    ```

    **Назначение**: Удаляет запись из таблицы `AliexpressCategory`.

    **Как работает функция**:

    1.  Определяет ID записи для удаления.
    2.  Вызывает метод `delete_record` класса `CategoryManager` для выполнения операции DELETE.

**Примеры**:

```python
# Пример использования класса DBAdaptor
db_adapter = DBAdaptor()
db_adapter.select(parent_id=123)
db_adapter.insert()
db_adapter.update()
db_adapter.delete()