# Модуль для редукции результатов агентов TinyTroupe
====================================================

Модуль содержит класс `ResultsReducer`, который используется для сведения результатов работы агентов `TinyPerson` на основе заданных правил.

## Обзор

Модуль `results_reducer.py` предназначен для обработки и сведения результатов, полученных от агентов в системе `TinyTroupe`. Он предоставляет функциональность для добавления правил редукции и применения этих правил к данным, хранящимся в эпизодической памяти агентов. Это позволяет извлекать полезную информацию и преобразовывать ее в структурированный формат, например, в DataFrame.

## Подробней

Этот модуль играет важную роль в анализе поведения агентов, позволяя извлекать значимые события и действия, а также преобразовывать их в удобный для анализа формат. `ResultsReducer` использует правила, связанные с типами стимулов и действий, чтобы определить, какую информацию извлекать и как ее структурировать.

## Классы

### `ResultsReducer`

**Описание**: Класс предназначен для сведения результатов, полученных от агентов `TinyPerson`. Он хранит правила редукции и применяет их к эпизодической памяти агентов, преобразуя данные в структурированный формат.

**Принцип работы**:
1.  Инициализация класса создает пустой словарь `results` для хранения результатов и пустой словарь `rules` для хранения правил редукции.
2.  Метод `add_reduction_rule` добавляет новое правило редукции в словарь `rules`, связывая триггер (тип стимула или действия) с функцией, которая будет применяться для извлечения данных.
3.  Метод `reduce_agent` проходит по всем сообщениям в эпизодической памяти агента и применяет соответствующие правила редукции, если они существуют.
4.  Метод `reduce_agent_to_dataframe` вызывает метод `reduce_agent` для получения списка извлеченных данных и преобразует этот список в DataFrame с заданными именами столбцов.

**Атрибуты**:

*   `results` (dict): Словарь для хранения промежуточных или финальных результатов редукции.
*   `rules` (dict): Словарь, содержащий правила редукции, где ключом является триггер (тип стимула или действия), а значением - функция для обработки данных.

**Методы**:

*   `add_reduction_rule(trigger: str, func: callable)`: Добавляет правило редукции для определенного триггера.
*   `reduce_agent(agent: TinyPerson) -> list`: Применяет правила редукции к эпизодической памяти агента.
*   `reduce_agent_to_dataframe(agent: TinyPerson, column_names: list = None) -> pd.DataFrame`: Преобразует результаты редукции агента в DataFrame.

## Функции

### `add_reduction_rule`

```python
def add_reduction_rule(self, trigger: str, func: callable):
    """
    Добавляет правило редукции для определенного триггера.

    Args:
        trigger (str): Триггер, определяющий, когда применять правило (например, тип стимула или действия).
        func (callable): Функция, которая будет вызвана для выполнения редукции.

    Raises:
        Exception: Если правило для данного триггера уже существует.

    """
    ...
```

**Назначение**: Добавляет новое правило редукции в словарь `rules`. Правило связывает определенный триггер (например, тип стимула или действия) с функцией, которая будет вызываться для выполнения редукции, когда встречается этот триггер в эпизодической памяти агента.

**Параметры**:

*   `trigger` (str): Строка, представляющая триггер, при котором должно применяться правило редукции.
*   `func` (callable): Функция, которая будет вызвана для выполнения редукции. Эта функция должна принимать соответствующие аргументы и возвращать извлеченные данные.

**Вызывает исключения**:

*   `Exception`: Если правило для данного триггера уже существует, вызывается исключение, чтобы предотвратить перезапись существующего правила.

**Как работает функция**:

1.  Функция проверяет, существует ли уже правило для данного триггера в словаре `rules`.
2.  Если правило уже существует, вызывается исключение `Exception` с сообщением об ошибке.
3.  Если правило не существует, оно добавляется в словарь `rules`, где ключом является триггер, а значением - функция для выполнения редукции.

**Примеры**:

```python
reducer = ResultsReducer()

def extract_product_name(focus_agent, source_agent, target_agent, kind, event, content, timestamp):
    """Извлекает название продукта из стимула"""
    if kind == 'stimulus' and event == 'product_view':
        return {'product_name': content}
    return None

reducer.add_reduction_rule('product_view', extract_product_name)
```

### `reduce_agent`

```python
def reduce_agent(self, agent: TinyPerson) -> list:
    """
    Применяет правила редукции к эпизодической памяти агента.

    Args:
        agent (TinyPerson): Агент, чью эпизодическую память нужно обработать.

    Returns:
        list: Список извлеченных данных, полученных в результате применения правил редукции.

    """
    ...
```

**Назначение**: Метод `reduce_agent` предназначен для применения правил редукции к эпизодической памяти агента `TinyPerson`. Он перебирает сообщения в памяти агента, определяет их тип (стимул или действие) и применяет соответствующие правила редукции, если они существуют.

**Параметры**:

*   `agent` (TinyPerson): Агент, чья эпизодическая память будет обработана.

**Возвращает**:

*   `list`: Список извлеченных данных, полученных в результате применения правил редукции.

**Как работает функция**:

1.  Инициализируется пустой список `reduction` для хранения извлеченных данных.
2.  Функция перебирает все сообщения в эпизодической памяти агента, полученные с помощью `agent.episodic_memory.retrieve_all()`.
3.  Для каждого сообщения проверяется его роль (`role`):
    *   Если роль сообщения - `system`, оно пропускается.
    *   Если роль сообщения - `user`, считается, что сообщение связано со стимулом. Извлекается тип стимула (`stimulus_type`), содержимое стимула (`stimulus_content`), источник стимула (`stimulus_source`) и временная метка стимула (`stimulus_timestamp`).
    *   Если роль сообщения - `assistant`, считается, что сообщение связано с действием. Извлекается тип действия (`action_type`), содержимое действия (`action_content`), цель действия (`action_target`) и временная метка действия (`action_timestamp`).
4.  Для стимулов и действий проверяется, существует ли правило редукции для соответствующего типа (`stimulus_type` или `action_type`) в словаре `self.rules`.
5.  Если правило существует, вызывается соответствующая функция редукции, передавая ей необходимые параметры:
    *   `focus_agent`: Агент, чья память обрабатывается.
    *   `source_agent`: Агент, являющийся источником стимула или действия.
    *   `target_agent`: Агент, являющийся целью действия.
    *   `kind`: Тип события (`stimulus` или `action`).
    *   `event`: Тип стимула или действия.
    *   `content`: Содержимое стимула или действия.
    *   `timestamp`: Временная метка события.
6.  Если функция редукции возвращает не `None`, извлеченные данные добавляются в список `reduction`.
7.  После обработки всех сообщений в эпизодической памяти агента функция возвращает список `reduction`, содержащий все извлеченные данные.

**Примеры**:

```python
reducer = ResultsReducer()
agent = TinyPerson(name='Alice')

def extract_product_name(focus_agent, source_agent, target_agent, kind, event, content, timestamp):
    """Извлекает название продукта из стимула"""
    if kind == 'stimulus' and event == 'product_view':
        return {'product_name': content}
    return None

reducer.add_reduction_rule('product_view', extract_product_name)

# Допустим, у агента есть сообщения в эпизодической памяти о просмотре продукта
reduction = reducer.reduce_agent(agent)
```

### `reduce_agent_to_dataframe`

```python
def reduce_agent_to_dataframe(self, agent: TinyPerson, column_names: list=None) -> pd.DataFrame:
    """
    Преобразует результаты редукции агента в DataFrame.

    Args:
        agent (TinyPerson): Агент, чьи результаты редукции нужно преобразовать в DataFrame.
        column_names (list, optional): Список имен столбцов для DataFrame. По умолчанию `None`.

    Returns:
        pd.DataFrame: DataFrame, содержащий результаты редукции.

    """
    ...
```

**Назначение**: Преобразует результаты редукции агента в DataFrame.

**Параметры**:

*   `agent` (TinyPerson): Агент, чьи результаты редукции необходимо преобразовать в DataFrame.
*   `column_names` (list, optional): Список имен столбцов для DataFrame. Если не указан, используются имена столбцов по умолчанию.

**Возвращает**:

*   `pd.DataFrame`: DataFrame, содержащий результаты редукции.

**Как работает функция**:

1.  Вызывается метод `reduce_agent` для получения списка извлеченных данных из эпизодической памяти агента.
2.  Создается DataFrame из списка `reduction` с использованием библиотеки `pandas`.
3.  Если предоставлен список `column_names`, он используется для установки имен столбцов DataFrame.
4.  DataFrame возвращается в качестве результата.

**Примеры**:

```python
reducer = ResultsReducer()
agent = TinyPerson(name='Alice')

def extract_product_name(focus_agent, source_agent, target_agent, kind, event, content, timestamp):
    """Извлекает название продукта из стимула"""
    if kind == 'stimulus' and event == 'product_view':
        return {'product_name': content}
    return None

reducer.add_reduction_rule('product_view', extract_product_name)

# Допустим, у агента есть сообщения в эпизодической памяти о просмотре продукта
df = reducer.reduce_agent_to_dataframe(agent, column_names=['product'])
print(df)
```