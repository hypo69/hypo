# Модуль для работы с AI ARTA

## Обзор

Модуль `ARTA` предназначен для взаимодействия с AI ARTA с целью генерации изображений на основе текстовых запросов. Он предоставляет асинхронный интерфейс для создания и обработки запросов к API ARTA, а также для отслеживания статуса генерации изображений.

## Подробней

Модуль включает в себя функциональность для аутентификации, обновления токенов, отправки запросов на генерацию изображений и проверки статуса этих запросов. Он использует асинхронные операции для эффективного взаимодействия с API и предоставляет результаты в виде асинхронного генератора. Этот модуль является частью проекта `hypotez` и предназначен для использования в задачах, требующих генерации изображений на основе текстовых описаний.

## Классы

### `ARTA`

**Описание**: Класс `ARTA` является основным классом провайдера для взаимодействия с AI ARTA. Он наследует функциональность от `AsyncGeneratorProvider` и `ProviderModelMixin`, предоставляя методы для асинхронной генерации изображений и управления моделями.

**Наследует**:
- `AsyncGeneratorProvider`: Обеспечивает базовую функциональность для асинхронных генераторов.
- `ProviderModelMixin`: Предоставляет методы для работы с моделями провайдера.

**Атрибуты**:
- `url` (str): URL главной страницы AI ARTA.
- `auth_url` (str): URL для аутентификации пользователя.
- `token_refresh_url` (str): URL для обновления токена аутентификации.
- `image_generation_url` (str): URL для запроса генерации изображений.
- `status_check_url` (str): URL для проверки статуса генерации изображений.
- `working` (bool): Указывает, работает ли провайдер в данный момент.
- `default_model` (str): Модель, используемая по умолчанию.
- `default_image_model` (str): Модель для генерации изображений, используемая по умолчанию.
- `model_aliases` (dict): Словарь, содержащий псевдонимы моделей для удобства использования.
- `image_models` (list): Список доступных моделей для генерации изображений.
- `models` (list): Список доступных моделей (совпадает с `image_models`).

**Методы**:
- `get_auth_file()`: Возвращает путь к файлу, в котором хранится информация об аутентификации.
- `create_token(path: Path, proxy: str | None = None)`: Создает токен аутентификации и сохраняет его в файл.
- `refresh_token(refresh_token: str, proxy: str = None)`: Обновляет токен аутентификации.
- `read_and_refresh_token(proxy: str | None = None)`: Читает токен из файла и, при необходимости, обновляет его.
- `create_async_generator(model: str, messages: Messages, proxy: str = None, prompt: str = None, negative_prompt: str = "blurry, deformed hands, ugly", n: int = 1, guidance_scale: int = 7, num_inference_steps: int = 30, aspect_ratio: str = "1:1", seed: int = None, **kwargs)`: Создает асинхронный генератор для генерации изображений на основе заданных параметров.

## Функции

### `get_auth_file`

```python
    @classmethod
    def get_auth_file(cls) -> Path:
        """
        Возвращает путь к файлу аутентификации.

        Args:
            cls: Ссылка на класс.

        Returns:
            Path: Путь к файлу аутентификации.

        Как работает функция:
        1. Получает директорию для хранения файлов cookie.
        2. Создает директорию, если она не существует.
        3. Формирует имя файла аутентификации на основе имени класса.
        4. Возвращает объект `Path` для файла аутентификации.
        """
```

**Назначение**: Функция `get_auth_file` определяет путь к файлу, в котором хранятся данные аутентификации для класса `ARTA`. Этот файл используется для сохранения и последующего чтения токенов аутентификации, необходимых для взаимодействия с API AI ARTA.

**Параметры**:
- `cls`: Ссылка на класс `ARTA`.

**Возвращает**:
- `Path`: Объект `Path`, представляющий путь к файлу аутентификации.

**Как работает функция**:
```
   Получение директории для хранения файлов cookie
   │
   Создание директории (если не существует)
   │
   Формирование имени файла аутентификации
   │
   Возврат объекта Path для файла аутентификации
```

**Примеры**:

```python
path = ARTA.get_auth_file()
print(path)  # Пример: /путь/к/cookies/auth_ARTA.json
```

### `create_token`

```python
    @classmethod
    async def create_token(cls, path: Path, proxy: str | None = None) -> dict:
        """
        Создает и сохраняет токен аутентификации.

        Args:
            cls: Ссылка на класс.
            path (Path): Путь к файлу для сохранения данных аутентификации.
            proxy (str | None, optional): Прокси-сервер для использования. По умолчанию `None`.

        Returns:
            dict: Данные аутентификации, содержащие токен.

        Raises:
            ResponseError: Если не удается получить токен аутентификации.
        """
```

**Назначение**: Функция `create_token` создает токен аутентификации, необходимый для доступа к API AI ARTA. Она отправляет запрос на сервер аутентификации и сохраняет полученные данные в указанный файл.

**Параметры**:
- `cls`: Ссылка на класс `ARTA`.
- `path` (`Path`): Путь к файлу, в котором будут сохранены данные аутентификации.
- `proxy` (`str | None`, optional): Прокси-сервер для использования. По умолчанию `None`.

**Возвращает**:
- `dict`: Данные аутентификации, содержащие токен.

**Вызывает исключения**:
- `ResponseError`: Если не удается получить токен аутентификации.

**Как работает функция**:

```
   Создание асинхронной сессии
   │
   Формирование payload для запроса аутентификации
   │
   Отправка POST-запроса на сервер аутентификации
   │
   Извлечение токена из ответа
   │
   Сохранение данных аутентификации в файл
   │
   Возврат данных аутентификации
```

**Примеры**:

```python
from pathlib import Path

# Создание временного файла для примера
temp_path = Path("temp_auth.json")
if temp_path.exists():
    temp_path.unlink()

# Создание токена и сохранение в файл
auth_data = asyncio.run(ARTA.create_token(temp_path))
print(auth_data)  # Пример: {'idToken': '...', 'refreshToken': '...', ...}

# Удаление временного файла
if temp_path.exists():
    temp_path.unlink()
```

### `refresh_token`

```python
    @classmethod
    async def refresh_token(cls, refresh_token: str, proxy: str = None) -> tuple[str, str]:
        """
        Обновляет токен аутентификации.

        Args:
            cls: Ссылка на класс.
            refresh_token (str): Токен обновления.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.

        Returns:
            tuple[str, str]: Новый токен и новый токен обновления.
        """
```

**Назначение**: Функция `refresh_token` используется для обновления существующего токена аутентификации с использованием токена обновления. Это позволяет поддерживать активную сессию с API AI ARTA без необходимости повторной аутентификации пользователя.

**Параметры**:
- `cls`: Ссылка на класс `ARTA`.
- `refresh_token` (`str`): Токен обновления.
- `proxy` (`str`, optional): Прокси-сервер для использования. По умолчанию `None`.

**Возвращает**:
- `tuple[str, str]`: Кортеж, содержащий новый токен и новый токен обновления.

**Как работает функция**:

```
   Создание асинхронной сессии
   │
   Формирование payload для запроса обновления токена
   │
   Отправка POST-запроса на сервер обновления токена
   │
   Извлечение нового токена и токена обновления из ответа
   │
   Возврат нового токена и токена обновления
```

**Примеры**:

```python
# Пример токена обновления (необходимо заменить на реальный)
refresh_token = "existing_refresh_token"

# Обновление токена
new_token, new_refresh_token = asyncio.run(ARTA.refresh_token(refresh_token))
print(f"New token: {new_token}")
print(f"New refresh token: {new_refresh_token}")
```

### `read_and_refresh_token`

```python
    @classmethod
    async def read_and_refresh_token(cls, proxy: str | None = None) -> dict:
        """
        Читает токен аутентификации из файла и, если необходимо, обновляет его.

        Args:
            cls: Ссылка на класс.
            proxy (str | None, optional): Прокси-сервер для использования. По умолчанию `None`.

        Returns:
            dict: Данные аутентификации, содержащие токен.
        """
```

**Назначение**: Функция `read_and_refresh_token` отвечает за чтение данных аутентификации из файла, проверку их актуальности и, при необходимости, обновление токена аутентификации. Она обеспечивает автоматическое управление токенами для поддержания активной сессии с API AI ARTA.

**Параметры**:
- `cls`: Ссылка на класс `ARTA`.
- `proxy` (`str | None`, optional): Прокси-сервер для использования. По умолчанию `None`.

**Возвращает**:
- `dict`: Данные аутентификации, содержащие токен.

**Как работает функция**:

```
   Получение пути к файлу аутентификации
   │
   Проверка существования файла
   │
   Чтение данных аутентификации из файла
   │
   Вычисление времени, прошедшего с момента создания файла
   │
   Сравнение времени жизни токена с прошедшим временем
   │
   Обновление токена, если он устарел
   │
   Возврат данных аутентификации
```

**Примеры**:

```python
# Чтение и обновление токена
auth_data = asyncio.run(ARTA.read_and_refresh_token())
print(auth_data)
```

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        prompt: str = None,
        negative_prompt: str = "blurry, deformed hands, ugly",
        n: int = 1,
        guidance_scale: int = 7,
        num_inference_steps: int = 30,
        aspect_ratio: str = "1:1",
        seed: int = None,
        **kwargs
    ) -> AsyncResult:
        """
        Создает асинхронный генератор для генерации изображений.

        Args:
            cls: Ссылка на класс.
            model (str): Модель для генерации изображений.
            messages (Messages): Список сообщений для формирования запроса.
            proxy (str, optional): Прокси-сервер для использования. По умолчанию `None`.
            prompt (str, optional): Текстовый запрос для генерации изображения. По умолчанию `None`.
            negative_prompt (str, optional): Негативный текстовый запрос. По умолчанию "blurry, deformed hands, ugly".
            n (int, optional): Количество изображений для генерации. По умолчанию 1.
            guidance_scale (int, optional): Масштаб соответствия запросу. По умолчанию 7.
            num_inference_steps (int, optional): Количество шагов для генерации изображения. По умолчанию 30.
            aspect_ratio (str, optional): Соотношение сторон изображения. По умолчанию "1:1".
            seed (int, optional): Зерно для генерации случайных чисел. По умолчанию `None`.
            **kwargs: Дополнительные параметры.

        Yields:
            Reasoning: Информация о процессе генерации.
            ImageResponse: Сгенерированные изображения.

        Raises:
            ResponseError: Если не удается инициировать генерацию изображения или возникает ошибка в процессе.
        """
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор для генерации изображений на основе заданных параметров. Она отвечает за формирование запроса к API AI ARTA, отправку запроса и обработку результатов. Генератор возвращает информацию о процессе генерации и сгенерированные изображения.

**Параметры**:
- `cls`: Ссылка на класс `ARTA`.
- `model` (`str`): Модель для генерации изображений.
- `messages` (`Messages`): Список сообщений для формирования запроса.
- `proxy` (`str`, optional): Прокси-сервер для использования. По умолчанию `None`.
- `prompt` (`str`, optional): Текстовый запрос для генерации изображения. По умолчанию `None`.
- `negative_prompt` (`str`, optional): Негативный текстовый запрос. По умолчанию "blurry, deformed hands, ugly".
- `n` (`int`, optional): Количество изображений для генерации. По умолчанию 1.
- `guidance_scale` (`int`, optional): Масштаб соответствия запросу. По умолчанию 7.
- `num_inference_steps` (`int`, optional): Количество шагов для генерации изображения. По умолчанию 30.
- `aspect_ratio` (`str`, optional): Соотношение сторон изображения. По умолчанию "1:1".
- `seed` (`int`, optional): Зерно для генерации случайных чисел. По умолчанию `None`.
- `**kwargs`: Дополнительные параметры.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, который возвращает объекты `Reasoning` и `ImageResponse`.

**Вызывает исключения**:
- `ResponseError`: Если не удается инициировать генерацию изображения или возникает ошибка в процессе.

**Как работает функция**:

```
   Получение модели
   │
   Формирование запроса на основе сообщений
   │
   Генерация случайного seed, если он не предоставлен
   │
   Получение токена аутентификации
   │
   Создание асинхронной сессии
   │
   Формирование payload для запроса генерации изображения
   │
   Отправка POST-запроса на сервер генерации изображения
   │
   Извлечение ID записи из ответа
   │
   Проверка статуса генерации изображения
   │
   Возврат сгенерированных изображений и информации о процессе
```

**Примеры**:

```python
messages = [{"role": "user", "content": "Generate a cat image"}]

# Создание асинхронного генератора
generator = ARTA.create_async_generator(model="Flux", messages=messages)

# Асинхронная итерация по генератору
async def iterate_generator():
    async for item in generator:
        if isinstance(item, Reasoning):
            print(f"Reasoning: {item.label} - {item.status}")
        elif isinstance(item, ImageResponse):
            print(f"Image URLs: {item.images}")

asyncio.run(iterate_generator())