# Модуль Chatgpt4o для g4f

## Обзор

Модуль `Chatgpt4o` предоставляет асинхронный интерфейс для взаимодействия с моделью `gpt-4o-mini-2024-07-18` через веб-сайт `chatgpt4o.one`. Он предназначен для интеграции с библиотекой `g4f` и обеспечивает способ отправки сообщений и получения ответов от модели.

## Подробнее

Этот модуль является частью проекта `hypotez` и предназначен для обеспечения доступа к модели `gpt-4o-mini-2024-07-18` через веб-сайт `chatgpt4o.one`. Он использует асинхронные запросы для взаимодействия с сервером и извлекает необходимые данные, такие как `post_id` и `nonce`, из HTML-кода веб-страницы.

## Классы

### `Chatgpt4o`

**Описание**: Класс `Chatgpt4o` представляет собой асинхронного провайдера для взаимодействия с моделью `gpt-4o-mini-2024-07-18`.

**Наследует**:

- `AsyncProvider`: Предоставляет асинхронные методы для взаимодействия с API.
- `ProviderModelMixin`: Обеспечивает поддержку работы с различными моделями.

**Атрибуты**:

- `url` (str): URL веб-сайта `chatgpt4o.one`.
- `working` (bool): Указывает, работает ли провайдер в данный момент.
- `_post_id` (str | None): ID поста, необходимый для отправки сообщений.
- `_nonce` (str | None): Nonce, необходимый для отправки сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`gpt-4o-mini-2024-07-18`).
- `models` (List[str]): Список поддерживаемых моделей.
- `model_aliases` (Dict[str, str]): Словарь псевдонимов моделей.

**Методы**:

- `create_async()`: Асинхронно создает и отправляет запрос к модели.

## Функции

### `create_async`

```python
@classmethod
async def create_async(
    cls,
    model: str,
    messages: Messages,
    proxy: str = None,
    timeout: int = 120,
    cookies: dict = None,
    **kwargs
) -> str:
    """Асинхронно создает и отправляет запрос к модели gpt-4o-mini-2024-07-18 через веб-сайт chatgpt4o.one.

    Args:
        cls (Chatgpt4o): Класс Chatgpt4o.
        model (str): Название модели для использования.
        messages (Messages): Список сообщений для отправки.
        proxy (str, optional): Прокси-сервер для использования. По умолчанию None.
        timeout (int, optional): Время ожидания ответа в секундах. По умолчанию 120.
        cookies (dict, optional): Cookies для отправки с запросом. По умолчанию None.
        **kwargs: Дополнительные аргументы.

    Returns:
        str: Ответ от модели.

    Raises:
        RuntimeError: Если не удалось найти `post_id` или `nonce` на веб-странице.
        RuntimeError: Если ответ от сервера не содержит поле `data`.
        Exception: Если возникает ошибка при выполнении запроса.
    """
```

**Назначение**: Метод `create_async` асинхронно создает и отправляет запрос к модели `gpt-4o-mini-2024-07-18` через веб-сайт `chatgpt4o.one`. Он извлекает необходимые параметры, такие как `post_id` и `nonce`, и отправляет сообщения для получения ответа от модели.

**Параметры**:

- `cls` (Chatgpt4o): Класс `Chatgpt4o`.
- `model` (str): Название модели для использования.
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): Прокси-сервер для использования. По умолчанию `None`.
- `timeout` (int, optional): Время ожидания ответа в секундах. По умолчанию `120`.
- `cookies` (dict, optional): Cookies для отправки с запросом. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:

- `str`: Ответ от модели.

**Вызывает исключения**:

- `RuntimeError`: Если не удалось найти `post_id` или `nonce` на веб-странице.
- `RuntimeError`: Если ответ от сервера не содержит поле `data`.

**Как работает функция**:

1. **Определение заголовков**: Функция определяет заголовки HTTP-запроса, включая `User-Agent`, `Referer` и другие необходимые параметры.
2. **Создание сессии**: Создается асинхронная сессия с использованием `StreamSession` с заданными заголовками, cookies, прокси и таймаутом.
3. **Извлечение `post_id` и `nonce`**: Если `_post_id` или `_nonce` не установлены, функция выполняет GET-запрос к главной странице веб-сайта и извлекает значения `post_id` и `nonce` из HTML-кода с использованием регулярных выражений.
4. **Форматирование запроса**: Форматирует список сообщений в строку с использованием функции `format_prompt`.
5. **Создание данных запроса**: Создает словарь с данными для отправки POST-запроса, включая `_wpnonce`, `post_id`, `url`, `action`, `message` и `bot_id`.
6. **Отправка POST-запроса**: Отправляет POST-запрос к `wp-admin/admin-ajax.php` с данными и cookies.
7. **Обработка ответа**: Проверяет наличие поля `data` в JSON-ответе и возвращает его значение.

**ASCII flowchart**:

```
A [Начало]
│
B [Проверка наличия _post_id и _nonce]
│
├─── Нет ───────────────────────────────────────────────
│   │
│   C [GET-запрос к главной странице]
│   │
│   D [Извлечение post_id и nonce из HTML]
│   │
│   E [Проверка наличия post_id и nonce]
│   │
│   └─── Нет: Выброс RuntimeError ──────────────────────
│   │
└─── Да ────────────────────────────────────────────────
    │
    F [Форматирование запроса]
    │
    G [Создание данных запроса]
    │
    H [POST-запрос к wp-admin/admin-ajax.php]
    │
    I [Обработка JSON-ответа]
    │
    J [Проверка наличия поля data]
    │
    ├─── Нет: Выброс RuntimeError ──────────────────────
    │   │
    └─── Да: Возврат значения data ─────────────────────
        │
        K [Конец]
```

**Примеры**:

```python
# Пример вызова функции create_async
import asyncio
from typing import List, Dict

from g4f.Provider.not_working.Chatgpt4o import Chatgpt4o
async def main():
    model = "gpt-4o-mini-2024-07-18"
    messages: List[Dict[str, str]] = [
        {"role": "user", "content": "Hello, how are you?"}
    ]

    try:
        response = await Chatgpt4o.create_async(model=model, messages=messages)
        print(f"Response: {response}")
    except Exception as ex:
        print(f"Error: {ex}")

if __name__ == "__main__":
    asyncio.run(main())