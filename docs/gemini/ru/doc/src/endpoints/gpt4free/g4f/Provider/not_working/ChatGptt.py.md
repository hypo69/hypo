# Модуль `ChatGptt`

## Обзор

Модуль `ChatGptt` предоставляет асинхронный генератор для взаимодействия с сервисом `chatgptt.me`. Он позволяет отправлять запросы к API этого сервиса и получать ответы в виде асинхронного генератора. Модуль поддерживает потоковую передачу данных, системные сообщения и историю сообщений.

## Подробней

Модуль предназначен для интеграции с другими частями проекта `hypotez`, которые требуют взаимодействия с `chatgptt.me`. Он использует `aiohttp` для асинхронных HTTP-запросов и предоставляет удобный интерфейс для отправки сообщений и получения ответов. Модуль также обрабатывает ошибки, возникающие при запросах к API.

## Классы

### `ChatGptt`

**Описание**: Класс `ChatGptt` является поставщиком (provider) асинхронного генератора и миксином моделей (ProviderModelMixin). Он наследуется от `AsyncGeneratorProvider` и `ProviderModelMixin`.

**Принцип работы**:
Класс использует асинхронные запросы для взаимодействия с API `chatgptt.me`. Он извлекает необходимые токены аутентификации из HTML-кода страницы и отправляет сообщения в формате, ожидаемом API. Полученные ответы передаются в виде асинхронного генератора.

**Аттрибуты**:
- `url` (str): URL сервиса `chatgptt.me`.
- `api_endpoint` (str): URL API сервиса `chatgptt.me`.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_stream` (bool): Указывает, поддерживает ли провайдер потоковую передачу данных.
- `supports_system_message` (bool): Указывает, поддерживает ли провайдер системные сообщения.
- `supports_message_history` (bool): Указывает, поддерживает ли провайдер историю сообщений.
- `default_model` (str): Модель, используемая по умолчанию (`gpt-4o`).
- `models` (List[str]): Список поддерживаемых моделей (`gpt-4`, `gpt-4o`, `gpt-4o-mini`).

## Функции

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """Создает асинхронный генератор для взаимодействия с API chatgptt.me.

        Args:
            model (str): Название используемой модели.
            messages (Messages): Список сообщений для отправки.
            proxy (str, optional): URL прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий результаты от API.

        Raises:
            RuntimeError: Если не удается найти токены аутентификации в HTML-коде страницы.
            Exception: Если возникает ошибка при выполнении HTTP-запроса.
        """
```

**Назначение**: Функция `create_async_generator` создает асинхронный генератор для взаимодействия с API `chatgptt.me`. Она отправляет сообщения и возвращает ответы в виде асинхронного генератора.

**Параметры**:
- `model` (str): Название используемой модели.
- `messages` (Messages): Список сообщений для отправки.
- `proxy` (str, optional): URL прокси-сервера. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный генератор, возвращающий результаты от API.

**Вызывает исключения**:
- `RuntimeError`: Если не удается найти токены аутентификации в HTML-коде страницы.

**Как работает функция**:

1. **Выбор модели**: Функция определяет, какая модель будет использоваться для запроса. Если указанная модель (`model`) отсутствует в списке поддерживаемых моделей, будет использована модель по умолчанию (`cls.default_model`).

2. **Подготовка заголовков**: Функция подготавливает заголовки HTTP-запроса, включая информацию о браузере пользователя, источнике запроса и принимаемом типе контента.

3. **Создание сессии**: Создается асинхронная сессия `ClientSession` с заданными заголовками.

4. **Получение начального контента страницы**: Функция выполняет GET-запрос к главной странице `cls.url` для получения HTML-кода, из которого будут извлечены токены аутентификации.

5. **Извлечение токенов**: Из HTML-кода извлекаются `nonce` и `post_id` с использованием регулярных выражений. Если токены не найдены, поднимается исключение `RuntimeError`.

6. **Подготовка полезной нагрузки (payload)**: Функция подготавливает данные для отправки в теле POST-запроса. Включает в себя извлеченные токены, сообщение пользователя, ID бота и другие параметры.

7. **Отправка запроса и получение ответа**: Функция отправляет POST-запрос к API `cls.api_endpoint` с заголовками и полезной нагрузкой.

8. **Обработка ответа**: Полученный ответ преобразуется в формат JSON и извлекается поле `data`, которое передается в асинхронный генератор.

**Внутренние функции**:
- Нет внутренних функций.

**ASCII flowchart**:

```
A [Определение модели]
    |
    B [Подготовка заголовков]
    |
    C [Создание асинхронной сессии]
    |
    D [Получение HTML-кода страницы]
    |
    E [Извлечение nonce и post_id]
    |
    F [Подготовка payload]
    |
    G [Отправка POST-запроса]
    |
    H [Получение и обработка ответа]
```

**Примеры**:

```python
# Пример вызова функции с указанием модели и сообщениями
messages = [{"role": "user", "content": "Hello, how are you?"}]
async for response in ChatGptt.create_async_generator(model="gpt-4", messages=messages):
    print(response)

# Пример вызова функции с использованием прокси-сервера
messages = [{"role": "user", "content": "Tell me a joke."}]
async for response in ChatGptt.create_async_generator(model="gpt-4o", messages=messages, proxy="http://proxy.example.com"):
    print(response)