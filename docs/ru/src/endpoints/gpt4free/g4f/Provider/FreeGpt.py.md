# Модуль FreeGpt

## Обзор

Модуль `FreeGpt` предоставляет асинхронный интерфейс для взаимодействия с сервисом FreeGpt для генерации текста на основе предоставленных сообщений. Он включает в себя функциональность для создания асинхронных генераторов, обработки сообщений, подписи запросов и обработки ошибок, связанных с ограничением скорости.

## Подробнее

Модуль предназначен для использования в асинхронных приложениях, где требуется генерация текста с использованием API FreeGpt. Он поддерживает указание прокси, настройку времени ожидания и обработку истории сообщений. Модуль также содержит механизмы для обработки ошибок, таких как достижение лимита запросов.

## Классы

### `FreeGpt`

**Описание**: Класс `FreeGpt` является основным классом, предоставляющим асинхронный генератор для получения ответов от API FreeGpt.

**Принцип работы**:
Класс использует асинхронные запросы для взаимодействия с API FreeGpt. Он формирует запросы на основе предоставленных сообщений и временной метки, подписывает их для обеспечения безопасности и обрабатывает ответы, возвращая их в виде асинхронного генератора. Класс также обрабатывает ошибки, связанные с ограничением скорости.

**Методы**:

- `create_async_generator`
- `_build_request_data`

### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: Optional[str] = None,
        timeout: int = 120,
        **kwargs: Any
    ) -> AsyncGenerator[str, None]:
        """
        Создает асинхронный генератор для получения ответов от API FreeGpt.

        Args:
            model (str): Идентификатор модели для генерации текста.
            messages (Messages): Список сообщений для отправки в API.
            proxy (Optional[str], optional): Адрес прокси-сервера. По умолчанию `None`.
            timeout (int, optional): Время ожидания ответа от API в секундах. По умолчанию 120.
            **kwargs (Any): Дополнительные параметры.

        Returns:
            AsyncGenerator[str, None]: Асинхронный генератор, возвращающий части ответа от API.

        Raises:
            RateLimitError: Если достигнут лимит запросов.

        """
```

**Назначение**: Создание асинхронного генератора для получения ответов от API FreeGpt.

1. **Формирование запроса**:
   - Извлекается последнее сообщение из списка сообщений для использования в запросе.
   - Получается текущая временная метка.
   - Формируются данные запроса с использованием метода `_build_request_data`.

2. **Отправка запроса и обработка ответа**:
   - Выбирается случайный домен из списка доступных доменов.
   - Создается асинхронная сессия с использованием `StreamSession`.
   - Отправляется POST-запрос к API FreeGpt с сформированными данными.
   - Проверяется статус ответа на наличие ошибок с помощью `raise_for_status`.

3. **Генерация данных**:
   - Итерируется по содержимому ответа чанками.
   - Декодируется каждый чанк, игнорируя ошибки декодирования.
   - Проверяется, не содержит ли чанк сообщение об ограничении скорости. Если содержит, выбрасывается исключение `RateLimitError`.
   - Возвращается декодированный чанк через `yield`.

**Примеры**:

```python
async def main():
    model = "gemini-1.5-pro"
    messages = [{"role": "user", "content": "Hello, how are you?"}]
    proxy = None
    timeout = 120

    generator = await FreeGpt.create_async_generator(model, messages, proxy, timeout)
    async for chunk in generator:
        print(chunk, end="")

# Запуск примера
# import asyncio
# asyncio.run(main())
```

### `_build_request_data`

```python
    @staticmethod
    def _build_request_data(messages: Messages, prompt: str, timestamp: int, secret: str = "") -> Dict[str, Any]:
        """
        Формирует словарь с данными запроса для отправки в API FreeGpt.

        Args:
            messages (Messages): Список сообщений для отправки в API.
            prompt (str): Последнее сообщение пользователя.
            timestamp (int): Временная метка запроса.
            secret (str, optional): Секретный ключ для подписи запроса. По умолчанию "".

        Returns:
            Dict[str, Any]: Словарь с данными запроса.
        """
```

**Назначение**: Формирование словаря с данными запроса для отправки в API FreeGpt.

**Параметры**:
- `messages` (Messages): Список сообщений для отправки в API.
- `prompt` (str): Последнее сообщение пользователя.
- `timestamp` (int): Временная метка запроса.
- `secret` (str, optional): Секретный ключ для подписи запроса. По умолчанию "".

**Возвращает**:
- `Dict[str, Any]`: Словарь с данными запроса.

**Как работает функция**:
1. **Создание словаря данных**:
   - Функция создает словарь, включающий сообщения, временную метку, значение `None` для ключа `"pass"`, и подпись, сгенерированную функцией `generate_signature`.

**Примеры**:

```python
messages = [{"role": "user", "content": "Hello, how are you?"}]
prompt = "Hello, how are you?"
timestamp = int(time.time())
data = FreeGpt._build_request_data(messages, prompt, timestamp)
print(data)
```

## Функции

### `generate_signature`

```python
def generate_signature(timestamp: int, message: str, secret: str = "") -> str:
    """
    Генерирует подпись для запроса на основе временной метки, сообщения и секретного ключа.

    Args:
        timestamp (int): Временная метка запроса.
        message (str): Сообщение для подписи.
        secret (str, optional): Секретный ключ. По умолчанию "".

    Returns:
        str: Сгенерированная подпись в виде шестнадцатеричной строки.
    """
```

**Назначение**: Генерация подписи для запроса на основе временной метки, сообщения и секретного ключа.

**Параметры**:
- `timestamp` (int): Временная метка запроса.
- `message` (str): Сообщение для подписи.
- `secret` (str, optional): Секретный ключ. По умолчанию "".

**Возвращает**:
- `str`: Сгенерированная подпись в виде шестнадцатеричной строки.

**Как работает функция**:
1. **Формирование данных для подписи**:
   - Функция создает строку данных, объединяя временную метку, сообщение и секретный ключ через двоеточие.

2. **Генерация подписи**:
   - Данные кодируются в байты и хешируются с использованием алгоритма SHA256.
   - Возвращается шестнадцатеричное представление хеша.

**Примеры**:

```python
timestamp = int(time.time())
message = "Hello, how are you?"
signature = generate_signature(timestamp, message)
print(signature)