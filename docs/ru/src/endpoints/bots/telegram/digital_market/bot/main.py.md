# Модуль `main.py`

## Обзор

Модуль `main.py` является точкой входа для Telegram-бота "Цифровой рынок". Он отвечает за настройку и запуск веб-приложения на основе `aiohttp`, регистрацию обработчиков, мидлварей и роутеров, а также установку команд бота по умолчанию.

## Подробней

Этот модуль содержит основные компоненты для работы бота, включая настройку вебхуков, обработку входящих сообщений и запуск/остановку бота.
Он использует библиотеки `aiogram`, `aiohttp` и `loguru` для обеспечения функциональности бота и веб-сервера.

## Функции

### `set_default_commands`

```python
async def set_default_commands():
    """
    Устанавливает команды по умолчанию для бота.
    """
```

**Как работает функция**:
Функция `set_default_commands` определяет список команд бота по умолчанию (в данном случае, только команда `/start`) и устанавливает их для бота, используя `BotCommandScopeDefault`. Это позволяет пользователям видеть доступные команды при взаимодействии с ботом.

**Параметры**:
- Отсутствуют

**Возвращает**:
- Отсутствует

**Вызывает исключения**:
- Отсутствуют

### `on_startup`

```python
async def on_startup(app):
    """
    Выполняется при запуске приложения.
    """
```

**Как работает функция**:

Функция `on_startup` выполняет ряд действий при запуске приложения. Она устанавливает команды бота по умолчанию, регистрирует вебхук для получения обновлений от Telegram, отправляет уведомления администраторам о запуске бота и логирует информацию о запуске.

1. Вызывается функция `set_default_commands` для установки команд по умолчанию.
2. Регистрируется вебхук для получения обновлений от Telegram, используя URL, полученный из настроек (`settings.get_webhook_url`).
3. Отправляет сообщения администраторам о запуске бота. В случае возникновения ошибки при отправке сообщения администратору, информация об ошибке логируется с использованием `logger.error`.
4. Логирует информацию об успешном запуске бота с использованием `logger.info`.

**Параметры**:
- `app` (aiohttp.web.Application): Экземпляр приложения aiohttp.

**Возвращает**:
- Отсутствует

**Вызывает исключения**:
- `Exception`: В случае ошибки при отправке сообщения администратору.

### `on_shutdown`

```python
async def on_shutdown(app):
    """
    Выполняется при остановке приложения.
    """
```

**Как работает функция**:

Функция `on_shutdown` выполняет действия при остановке приложения:
1.  Отправляет уведомления администраторам о том, что бот остановлен.  Если отправка не удалась, фиксирует ошибку с помощью `logger.error`
2.  Удаляет вебхук, чтобы бот перестал получать обновления, и закрывает сессию бота.
3.  Логирует информацию об остановке бота с использованием `logger.error`.

**Параметры**:
- `app` (aiohttp.web.Application): Экземпляр приложения aiohttp.

**Возвращает**:
- Отсутствует

**Вызывает исключения**:
- `Exception`: В случае ошибки при отправке сообщения администратору.

### `register_middlewares`

```python
def register_middlewares():
    """
    Регистрирует мидлвари для диспетчера.
    """
```

**Как работает функция**:
Функция `register_middlewares` регистрирует мидлвари (middleware) для диспетчера `dp`. Мидлвари — это компоненты, которые обрабатывают входящие и исходящие обновления до и после обработки их роутерами. В данном случае, регистрируются две мидлвари: `DatabaseMiddlewareWithoutCommit` и `DatabaseMiddlewareWithCommit`.

1.  Регистрирует `DatabaseMiddlewareWithoutCommit` для каждой обработки входящего обновления
2.  Регистрирует `DatabaseMiddlewareWithCommit` для каждой обработки входящего обновления

**Параметры**:
- Отсутствуют

**Возвращает**:
- Отсутствует

**Вызывает исключения**:
- Отсутствуют

### `register_routers`

```python
def register_routers():
    """
    Регистрирует маршруты для диспетчера.
    """
```

**Как работает функция**:
Функция `register_routers` регистрирует маршруты (роутеры) для диспетчера `dp`. Роутеры определяют, как обрабатывать входящие обновления в зависимости от их типа и содержания. В данном случае, регистрируются три роутера: `catalog_router`, `user_router` и `admin_router`.

1. Регистрирует роутер `catalog_router` для обработки запросов, связанных с каталогом товаров.
2. Регистрирует роутер `user_router` для обработки запросов от пользователей.
3. Регистрирует роутер `admin_router` для обработки административных команд.

**Параметры**:
- Отсутствуют

**Возвращает**:
- Отсутствует

**Вызывает исключения**:
- Отсутствуют

### `create_app`

```python
def create_app():
    """
    Создает и настраивает приложение aiohttp.
    """
```

**Как работает функция**:
Функция `create_app` создает и настраивает приложение `aiohttp`, регистрирует обработчики маршрутов, настраивает приложение с диспетчером и ботом, а также регистрирует функции запуска и остановки приложения.

1.  Создает экземпляр приложения `aiohttp` (`app = web.Application()`).
2.  Добавляет обработчики маршрутов для различных эндпоинтов:
    *   `/{settings.BOT_TOKEN}` (POST): Обрабатывается функцией `handle_webhook` для приема обновлений от Telegram.
    *   `/robokassa/result/` (POST): Обрабатывается функцией `robokassa_result` для получения результатов оплаты через Robokassa.
    *   `/robokassa/fail/` (GET): Обрабатывается функцией `robokassa_fail` в случае неуспешной оплаты через Robokassa.
    *   `/` (GET): Обрабатывается функцией `home_page` для отображения домашней страницы.
3.  Настраивает приложение с диспетчером (`dp`) и ботом (`bot`), используя функцию `setup_application` из библиотеки `aiogram`.
4.  Регистрирует функции `on_startup` и `on_shutdown` для выполнения при запуске и остановке приложения соответственно.
5.  Возвращает созданное приложение `aiohttp`.

**Параметры**:
- Отсутствуют

**Возвращает**:
- `app` (aiohttp.web.Application): Созданное и настроенное приложение aiohttp.

**Вызывает исключения**:
- Отсутствуют

### `main`

```python
def main():
    """
    Главная функция для запуска приложения.
    """
```

**Как работает функция**:
Функция `main` является главной функцией для запуска приложения. Она регистрирует мидлвари и роутеры, создает приложение и запускает его.

1.  Вызывает `register_middlewares` для регистрации мидлварей.
2.  Вызывает `register_routers` для регистрации роутеров.
3.  Вызывает `create_app` для создания приложения `aiohttp`.
4.  Запускает приложение с использованием `web.run_app`, указывая хост и порт из настроек (`settings.SITE_HOST` и `settings.SITE_PORT`).

**Параметры**:
- Отсутствуют

**Возвращает**:
- Отсутствует

**Вызывает исключения**:
- Отсутствуют