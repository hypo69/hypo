# Модуль для работы с SMTP

## Обзор

Модуль `smtp.py` предоставляет интерфейс для отправки и получения электронных писем с использованием протоколов SMTP и IMAP. Он включает функции для отправки электронных писем через SMTP и получения электронных писем через IMAP. Модуль предназначен для интеграции с другими частями проекта `hypotez`, где требуется функциональность отправки и получения электронной почты.

## Подробней

Модуль содержит функции для отправки и получения электронной почты, используя SMTP и IMAP соответственно. Он использует переменные окружения для получения учетных данных, что повышает безопасность. Функции включают обработку ошибок с логированием, что упрощает отладку и мониторинг.

## Функции

### `send`

```python
def send(subject: str = '', body: str = '', to: str = 'one.last.bit@gmail.com') -> bool:
    """Sends an email.  Returns True if successful, False otherwise. Logs errors."""
```

**Описание**: Отправляет электронное письмо. Возвращает `True` в случае успеха и `False` в случае неудачи.

**Как работает функция**:
1. Функция создает SMTP-соединение с сервером, указанным в словаре `_connection`.
2. Выполняет рукопожатие `ehlo` и запускает TLS-шифрование.
3. Авторизуется на SMTP-сервере, используя имя пользователя и пароль из `_connection`.
4. Создает MIME-сообщение с заданными темой и телом.
5. Устанавливает заголовки "Subject", "From" и "To".
6. Отправляет электронное письмо указанному получателю.
7. Закрывает SMTP-соединение.
8. В случае возникновения исключений, логирует ошибку с использованием модуля `logger` и возвращает `False`.

**Параметры**:
- `subject` (str): Тема электронного письма. По умолчанию ''.
- `body` (str): Тело электронного письма. По умолчанию ''.
- `to` (str): Адрес электронной почты получателя. По умолчанию 'one.last.bit@gmail.com'.

**Возвращает**:
- `bool`: `True`, если письмо успешно отправлено, `False` в противном случае.

**Вызывает исключения**:
- `Exception`: Возникает в случае ошибок при подключении к SMTP-серверу, аутентификации или отправке письма.

**Примеры**:

```python
from src.utils.smtp import send

success = send(subject='Test Email', body='This is a test email.', to='test@example.com')
if success:
    print('Email sent successfully!')
else:
    print('Failed to send email.')
```

### `receive`

```python
def receive(imap_server: str, user: str, password: str, folder: str = 'inbox') -> Optional[List[Dict[str, str]]]:
    """Retrieves emails. Returns a list of email dictionaries if successful, None otherwise. Logs errors."""
```

**Описание**: Получает электронные письма из IMAP-сервера. Возвращает список словарей с данными каждого письма в случае успеха, `None` в случае ошибки.

**Как работает функция**:
1. Функция устанавливает защищенное SSL-соединение с IMAP-сервером.
2. Выполняет вход в почтовый ящик, используя предоставленные имя пользователя и пароль.
3. Выбирает указанную папку (по умолчанию "inbox").
4. Выполняет поиск всех электронных писем в выбранной папке.
5. Для каждого найденного письма извлекает его содержимое.
6. Преобразует полученное содержимое в объект сообщения электронной почты.
7. Извлекает тему, отправителя и тело письма.
8. Добавляет полученные данные в список в виде словаря.
9. Закрывает соединение с почтовым ящиком и выходит из системы.
10. В случае возникновения исключений, логирует ошибку с использованием модуля `logger` и возвращает `None`.

**Параметры**:
- `imap_server` (str): Адрес IMAP-сервера.
- `user` (str): Имя пользователя для входа в IMAP-сервер.
- `password` (str): Пароль для входа в IMAP-сервер.
- `folder` (str): Название папки для чтения (например, 'inbox'). По умолчанию 'inbox'.

**Возвращает**:
- `Optional[List[Dict[str, str]]]`: Список словарей, где каждый словарь содержит данные об одном электронном письме (тема, отправитель, тело). Возвращает `None` в случае ошибки.

**Вызывает исключения**:
- `Exception`: Возникает в случае ошибок при подключении к IMAP-серверу, аутентификации, выборе папки или извлечении писем.

**Примеры**:

```python
from src.utils.smtp import receive

emails = receive(imap_server='imap.example.com', user='test@example.com', password='password', folder='inbox')
if emails:
    for email in emails:
        print(f"Subject: {email['subject']}")
        print(f"From: {email['from']}")
        print(f"Body: {email['body'][:100]}...")  # Print first 100 characters of the body
else:
    print('Failed to retrieve emails.')