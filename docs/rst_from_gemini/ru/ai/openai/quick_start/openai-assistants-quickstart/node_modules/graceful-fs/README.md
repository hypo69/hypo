```markdown
# graceful-fs

This module acts as a drop-in replacement for Node's built-in `fs` module, improving its behavior in various ways.  It aims to make filesystem interactions more robust and consistent across different platforms and environments.

## Improvements over the `fs` module

* **Handles `EMFILE` errors:** Queues up `open` and `readdir` calls, retrying them after a closure if an `EMFILE` (too many file descriptors) error occurs.
* **Fixes `lchmod`:** Addresses issues with `lchmod` in Node versions prior to 0.6.2.
* **Implements `fs.lutimes` (if available):** Provides `fs.lutimes` functionality. If unavailable, it becomes a no-op.
* **Handles `chown`, `fchown`, and `lchown` errors gracefully:** Ignores `EINVAL` and `EPERM` errors during `chown`, `fchown`, or `lchown` if the user isn't root.  `lchmod` and `lchown` are treated as no-ops if they aren't supported.
* **Retries reading files on `EAGAIN` errors:**  Retries file reads if they encounter `EAGAIN` errors.
* **Handles Windows `EACCESS` and `EPERM` errors during renaming:**  On Windows, retries renaming a file up to once per second if it fails due to `EACCESS` or `EPERM`, which is sometimes caused by antivirus software.

## Usage

Use `graceful-fs` just like the standard `fs` module:

```javascript
const fs = require('graceful-fs');

fs.readFile('some-file.txt', (err, data) => {
  if (err) {
    console.error(err);
  } else {
    console.log(data.toString());
  }
});
```

## Synchronous Methods

This module *cannot* handle `EMFILE` or `ENFILE` errors from synchronous methods.  You must handle these errors yourself if using synchronous file opening. This is a known limitation.

## Global Patching (Advanced)

To patch the global `fs` module, use `gracefulify()`:

```javascript
const realFs = require('fs');
const gracefulFs = require('graceful-fs');
gracefulFs.gracefulify(realFs);
```

**Crucial Caveat:**  This should only be done at the top level of your application, not within libraries.  Doing it within a library can cause unexpected delays in other parts of the application.

## Versioning and Changes

`graceful-fs` has a somewhat unusual versioning strategy.  Major version bumps are used when significant changes (like moving from monkey-patching to a drop-in replacement) happen to avoid breaking existing code.

* **v4:**  Shifted away from monkey-patching the `fs` module, making it more of a drop-in replacement.  Users can choose to monkey-patch if needed.
* **Previous versions:** Involved various improvements, error handling strategies, and adjustments to better handle specific cases (like Windows file renaming).  See the individual release notes for details.


## Important Considerations

* **Error Handling:**  Thoroughly handle potential errors in your code when using file system operations.  `graceful-fs` helps with `EMFILE` errors but you are still responsible for other types of file system issues.
* **Synchronization:** Be mindful of potential delays when using asynchronous functions.
* **Global Patching:** Use the global patching method cautiously and only when absolutely necessary.

This documentation provides a high-level overview of `graceful-fs`. Refer to the module's source code and specific release notes for more detailed information and potential limitations.
```
