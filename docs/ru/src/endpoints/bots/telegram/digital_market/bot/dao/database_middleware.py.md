# Модуль `database_middleware.py`

## Обзор

Модуль предоставляет middleware для интеграции базы данных с ботом Telegram. Он содержит базовый класс `BaseDatabaseMiddleware`, который управляет сессиями базы данных, а также два подкласса: `DatabaseMiddlewareWithoutCommit` и `DatabaseMiddlewareWithCommit`, определяющие, следует ли фиксировать изменения в базе данных после обработки запроса.

## Подробней

Этот модуль обеспечивает управление сессиями базы данных для обработки запросов в боте Telegram. `BaseDatabaseMiddleware` создает сессию, передает её в обработчик, а затем закрывает сессию. Подклассы `DatabaseMiddlewareWithoutCommit` и `DatabaseMiddlewareWithCommit` определяют, нужно ли автоматически фиксировать изменения в базе данных после обработки запроса.

## Классы

### `BaseDatabaseMiddleware`

**Описание**: Базовый класс middleware для управления сессиями базы данных.

**Как работает класс**:
1. При получении запроса создает асинхронную сессию базы данных, используя `async_session_maker`.
2. Устанавливает сессию в словаре `data`, используя метод `set_session`, который должен быть реализован в подклассах.
3. Вызывает обработчик (`handler`) с переданными данными.
4. После вызова обработчика вызывает метод `after_handler` для выполнения дополнительных действий (например, коммита).
5. В случае возникновения исключения выполняет откат транзакции.
6. В любом случае закрывает сессию после обработки запроса.

**Методы**:

- `__call__(self, handler: Callable[[Message | CallbackQuery, Dict[str, Any]], Awaitable[Any]], event: Message | CallbackQuery, data: Dict[str, Any]) -> Any`
    - **Назначение**: Основной метод middleware, вызываемый при обработке каждого события.

    **Как работает функция**:
    1. Создает асинхронную сессию базы данных, используя `async_session_maker`.
    2. Устанавливает сессию в словаре `data` с помощью метода `set_session`.
    3. Вызывает обработчик (`handler`) события с переданными данными.
    4. Вызывает `after_handler` для выполнения дополнительных действий после обработки.
    5. Обрабатывает исключения, выполняя откат транзакции в случае ошибки.
    6. Закрывает сессию после обработки.

    **Параметры**:
    - `handler` (Callable[[Message | CallbackQuery, Dict[str, Any]], Awaitable[Any]]): Обработчик события.
    - `event` (Message | CallbackQuery): Объект сообщения или обратного вызова.
    - `data` (Dict[str, Any]): Словарь с данными.

    **Возвращает**:
    - `Any`: Результат обработки события.

    **Вызывает исключения**:
    - `Exception`: Если в процессе обработки возникла ошибка.

- `set_session(self, data: Dict[str, Any], session) -> None`
    - **Назначение**: Устанавливает сессию базы данных в словаре `data`.

    **Как работает функция**:
    1. Этот метод должен быть переопределен в подклассах для установки сессии в словаре `data`.

    **Параметры**:
    - `data` (Dict[str, Any]): Словарь, в котором нужно сохранить сессию.
    - `session`: Объект сессии базы данных.

    **Вызывает исключения**:
    - `NotImplementedError`: Если метод не реализован в подклассе.

- `after_handler(self, session) -> None`
    - **Назначение**: Выполняет действия после вызова обработчика.

    **Как работает функция**:
    1. По умолчанию ничего не делает. Может быть переопределен в подклассах для выполнения коммита или других действий.

    **Параметры**:
    - `session`: Объект сессии базы данных.

### `DatabaseMiddlewareWithoutCommit`

**Описание**: Middleware для управления сессиями базы данных без автоматического коммита.

**Как работает класс**:
1. Наследуется от `BaseDatabaseMiddleware`.
2. Переопределяет метод `set_session` для установки сессии в словаре `data` под ключом `'session_without_commit'`.
3. Не выполняет автоматический коммит изменений.

**Методы**:

- `set_session(self, data: Dict[str, Any], session) -> None`
    - **Назначение**: Устанавливает сессию базы данных в словаре `data` без коммита.

    **Как работает функция**:
    1. Устанавливает сессию в словаре `data` под ключом `'session_without_commit'`.

    **Параметры**:
    - `data` (Dict[str, Any]): Словарь, в котором нужно сохранить сессию.
    - `session`: Объект сессии базы данных.

### `DatabaseMiddlewareWithCommit`

**Описание**: Middleware для управления сессиями базы данных с автоматическим коммитом.

**Как работает класс**:
1. Наследуется от `BaseDatabaseMiddleware`.
2. Переопределяет метод `set_session` для установки сессии в словаре `data` под ключом `'session_with_commit'`.
3. Переопределяет метод `after_handler` для выполнения автоматического коммита изменений после обработки запроса.

**Методы**:

- `set_session(self, data: Dict[str, Any], session) -> None`
    - **Назначение**: Устанавливает сессию базы данных в словаре `data` с коммитом.

    **Как работает функция**:
    1. Устанавливает сессию в словаре `data` под ключом `'session_with_commit'`.

    **Параметры**:
    - `data` (Dict[str, Any]): Словарь, в котором нужно сохранить сессию.
    - `session`: Объект сессии базы данных.

- `after_handler(self, session) -> None`
    - **Назначение**: Выполняет коммит сессии после обработки запроса.

    **Как работает функция**:
    1. Выполняет коммит сессии, сохраняя изменения в базе данных.

    **Параметры**:
    - `session`: Объект сессии базы данных.