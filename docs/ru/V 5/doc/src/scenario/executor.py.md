# Модуль для выполнения сценариев
## Обзор

Модуль `executor.py` предназначен для выполнения сценариев, загрузки их из файлов, а также обработки процесса извлечения информации о продуктах и их добавления в PrestaShop.

## Подробней

Этот модуль является центральным элементом в процессе выполнения сценариев, определяющих порядок действий для извлечения информации о продуктах с веб-сайтов поставщиков и их импорта в PrestaShop. Он содержит функции для загрузки сценариев из файлов, навигации по страницам продуктов, извлечения необходимых данных и вставки этих данных в PrestaShop.

Модуль включает в себя функции для работы с файлами сценариев, а также для обработки каждого отдельного сценария. Он также содержит функции для извлечения данных о продуктах и их вставки в PrestaShop.
С помощью глобального журнала `_journal` отслеживается ход выполнения сценариев.

## Классы

В данном модуле классы отсутствуют.

## Функции

### `dump_journal`

```python
def dump_journal(s, journal: dict) -> None:
    """
    Сохраняет данные журнала в файл JSON.

    Args:
        s (object): Объект экземпляра поставщика.
        journal (dict): Словарь, содержащий данные журнала.

    Returns:
        None

    """
```

**Как работает функция:**
Функция `dump_journal` принимает экземпляр поставщика `s` и словарь `journal`, содержащий данные журнала, и сохраняет эти данные в JSON-файл. Имя файла формируется на основе текущего времени и даты, а путь к файлу определяется как `_journal/{timestamp}.json` в директории поставщика.

### `run_scenario_files`

```python
def run_scenario_files(s, scenario_files_list: List[Path] | Path) -> bool:
    """
    Выполняет список файлов сценариев.

    Args:
        s (object): Объект экземпляра поставщика.
        scenario_files_list (List[Path] | Path): Список путей к файлам сценариев или одиночный путь к файлу.

    Returns:
        bool: True, если все сценарии были успешно выполнены, False в противном случае.

    Raises:
        TypeError: Если scenario_files_list не является списком или объектом Path.
    """
```

**Как работает функция:**
Функция `run_scenario_files` принимает экземпляр поставщика `s` и список файлов сценариев `scenario_files_list`. Она перебирает каждый файл сценария и вызывает функцию `run_scenario_file` для выполнения сценария, содержащегося в файле. Результаты выполнения каждого сценария записываются в журнал `_journal`. Если выполнение какого-либо сценария завершается неудачно, функция логирует ошибку.

**Параметры:**
- `s` (object): Экземпляр поставщика, содержащий информацию о поставщике и его конфигурации.
- `scenario_files_list` (List[Path] | Path): Список объектов `Path`, указывающих на файлы сценариев, которые необходимо выполнить. Если передан один объект `Path`, он преобразуется в список, содержащий этот объект.

**Возвращает:**
- `bool`: `True`, если все сценарии в списке были успешно выполнены, `False` в противном случае.

**Вызывает исключения:**
- `TypeError`: Если `scenario_files_list` не является списком или объектом `Path`.

### `run_scenario_file`

```python
def run_scenario_file(s, scenario_file: Path) -> bool:
    """
    Загружает и выполняет сценарии из файла.

    Args:
        s (object): Объект экземпляра поставщика.
        scenario_file (Path): Путь к файлу сценария.

    Returns:
        bool: True, если сценарий был выполнен успешно, False в противном случае.
    """
```

**Как работает функция:**
Функция `run_scenario_file` загружает сценарии из указанного файла `scenario_file` и выполняет их. Она использует функцию `j_loads` для загрузки JSON-данных из файла. Затем она перебирает все сценарии в файле и вызывает функцию `run_scenario` для выполнения каждого сценария. Если загрузка файла или выполнение сценария завершается неудачно, функция логирует ошибку.

**Параметры:**
- `s` (object): Экземпляр поставщика, содержащий информацию о поставщике и его конфигурации.
- `scenario_file` (Path): Объект `Path`, указывающий на файл сценария, который необходимо выполнить.

**Возвращает:**
- `bool`: `True`, если сценарий был успешно выполнен, `False` в противном случае.

**Вызывает исключения:**
- `FileNotFoundError`: Если указанный файл сценария не существует.
- `json.JSONDecodeError`: Если файл сценария содержит некорректный JSON.

### `run_scenarios`

```python
def run_scenarios(s, scenarios: Optional[List[dict] | dict] = None, _journal=None) -> List | dict | bool:
    """
    Выполняет список сценариев (НЕ ФАЙЛОВ).

    Args:
        s (object): Объект экземпляра поставщика.
        scenarios (Optional[List[dict] | dict], optional): Список сценариев или один сценарий в виде словаря. По умолчанию None.

    Returns:
        List | dict | bool: Результат выполнения сценариев или False в случае ошибки.

    Todo:
        Check the option when no scenarios are specified from all sides. For example, when s.current_scenario is not specified and scenarios are not specified.
    """
```

**Как работает функция:**
Функция `run_scenarios` выполняет список сценариев, переданных в аргументе `scenarios`. Если `scenarios` не указан, используется текущий сценарий поставщика `s.current_scenario`. Функция перебирает все сценарии и вызывает функцию `run_scenario` для выполнения каждого сценария. Результаты выполнения записываются в журнал `_journal`.

**Параметры:**
- `s` (object): Экземпляр поставщика, содержащий информацию о поставщике и его конфигурации.
- `scenarios` (Optional[List[dict] | dict], optional): Список словарей, представляющих сценарии, которые необходимо выполнить. Если передан один словарь, он преобразуется в список, содержащий этот словарь. Если `None`, используется `s.current_scenario`. По умолчанию `None`.
- `_journal`: Журнал выполнения сценариев.

**Возвращает:**
- `List | dict | bool`: Результат выполнения сценариев. Возвращает список, словарь или `False` в случае ошибки.

### `run_scenario`

```python
def run_scenario(supplier, scenario: dict, scenario_name: str, _journal=None) -> List | dict | bool:
    """
    Выполняет полученный сценарий.

    Args:
        supplier (object): Объект экземпляра поставщика.
        scenario (dict): Словарь, содержащий детали сценария.
        scenario_name (str): Имя сценария.

    Returns:
        List | dict | bool: Результат выполнения сценария.

    Todo:
        Check the need for the scenario_name parameter.
    """
```

**Как работает функция:**
Функция `run_scenario` выполняет заданный сценарий, используя предоставленного поставщика и детали сценария. Она извлекает URL из сценария, получает список продуктов в категории, перебирает их, извлекает поля продукта и вставляет полученные данные.
- Устанавливает текущий сценарий для поставщика.
- Извлекает драйвер из поставщика.
- Получает список продуктов в категории, используя `s.related_modules.get_list_products_in_category(s)`.
- Перебирает список URL продуктов.
- Переходит на страницу продукта.
- Извлекает поля продукта, используя `s.related_modules.grab_product_page(s)` и `s.related_modules.grab_page(s)`.
- Вставляет извлеченные данные, используя функцию `insert_grabbed_data(f)`.
    
**Параметры:**
- `supplier` (object): Объект экземпляра поставщика.
- `scenario` (dict): Словарь, содержащий детали сценария.
- `scenario_name` (str): Имя сценария.
- `_journal`: Журнал выполнения сценариев.

**Возвращает:**
- `List | dict | bool`: Результат выполнения сценария. В данном случае возвращает список продуктов в категории.

### `insert_grabbed_data_to_prestashop`

```python
async def insert_grabbed_data_to_prestashop(
    f: ProductFields, coupon_code: Optional[str] = None, start_date: Optional[str] = None, end_date: Optional[str] = None
) -> bool:
    """
    Вставляет продукт в PrestaShop.

    Args:
        f (ProductFields): Экземпляр ProductFields, содержащий информацию о продукте.
        coupon_code (Optional[str], optional): Необязательный код купона. По умолчанию None.
        start_date (Optional[str], optional): Необязательная дата начала акции. По умолчанию None.
        end_date (Optional[str], optional): Необязательная дата окончания акции. По умолчанию None.

    Returns:
        bool: True, если вставка прошла успешно, False в противном случае.
    """
```

**Как работает функция:**
Функция `insert_grabbed_data_to_prestashop` асинхронно вставляет данные о продукте в PrestaShop, используя предоставленные поля продукта и параметры продвижения.
- Инициализирует экземпляр класса `PrestaShop`.
- Вызывает метод `post_product_data` для отправки данных продукта в PrestaShop.
- Обрабатывает возможные исключения и логирует ошибки.

**Параметры:**
- `f` (ProductFields): Экземпляр класса `ProductFields`, содержащий информацию о продукте.
- `coupon_code` (Optional[str], optional): Код купона для продукта. По умолчанию `None`.
- `start_date` (Optional[str], optional): Дата начала действия купона. По умолчанию `None`.
- `end_date` (Optional[str], optional): Дата окончания действия купона. По умолчанию `None`.

**Возвращает:**
- `bool`: `True`, если вставка данных о продукте в PrestaShop прошла успешно, `False` в противном случае.