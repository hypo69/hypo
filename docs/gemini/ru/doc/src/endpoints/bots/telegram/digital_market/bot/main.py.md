# Модуль main.py для запуска Telegram-бота цифрового магазина

## Обзор

Модуль `main.py` является точкой входа для Telegram-бота цифрового магазина. Он отвечает за настройку и запуск веб-приложения, обработку входящих запросов, регистрацию промежуточного программного обеспечения и маршрутизаторов, а также установку команд бота по умолчанию.

## Подробней

Этот модуль выполняет следующие основные функции:

1.  Настройка и запуск веб-приложения `aiohttp` для обработки входящих запросов от Telegram.
2.  Регистрация промежуточного программного обеспечения (middleware) для управления сеансами базы данных.
3.  Регистрация маршрутизаторов для обработки различных типов запросов пользователей.
4.  Установка команд бота по умолчанию, отображаемых в интерфейсе Telegram.
5.  Обработка событий запуска и остановки бота, включая отправку уведомлений администраторам.

## Функции

### `set_default_commands`

```python
async def set_default_commands():
    """
    Устанавливает команды по умолчанию для бота.
    """
    ...
```

**Назначение**: Устанавливает команды по умолчанию для Telegram-бота. Эти команды отображаются в интерфейсе Telegram и позволяют пользователям быстро получать доступ к основным функциям бота.

**Параметры**:

*   Отсутствуют.

**Возвращает**:

*   Отсутствует.

**Вызывает исключения**:

*   Возможны исключения при взаимодействии с API Telegram.

**Как работает функция**:

1.  Определяет список команд по умолчанию, включая команду `/start` для запуска бота.
2.  Использует метод `bot.set_my_commands` для установки этих команд для всех пользователей (`BotCommandScopeDefault`).

**Примеры**:

```python
await set_default_commands()
```

### `on_startup`

```python
async def on_startup(app):
    """
    Выполняется при запуске приложения.
    """
    ...
```

**Назначение**: Выполняет действия при запуске приложения `aiohttp`.

**Параметры**:

*   `app`: Экземпляр приложения `aiohttp`.

**Возвращает**:

*   Отсутствует.

**Вызывает исключения**:

*   Возможны исключения при отправке сообщений администраторам или при установке вебхука.

**Как работает функция**:

1.  Вызывает `set_default_commands` для установки команд бота по умолчанию.
2.  Устанавливает вебхук для бота, используя URL, полученный из настроек (`settings.get_webhook_url`).
3.  Отправляет уведомления администраторам о запуске бота.
4.  Логирует информацию об успешном запуске бота.

**Примеры**:

```python
app.on_startup.append(on_startup)
```

### `on_shutdown`

```python
async def on_shutdown(app):
    """
    Выполняется при остановке приложения.
    """
    ...
```

**Назначение**: Выполняет действия при остановке приложения `aiohttp`.

**Параметры**:

*   `app`: Экземпляр приложения `aiohttp`.

**Возвращает**:

*   Отсутствует.

**Вызывает исключения**:

*   Возможны исключения при отправке сообщений администраторам или при удалении вебхука.

**Как работает функция**:

1.  Отправляет уведомления администраторам об остановке бота.
2.  Удаляет вебхук для бота.
3.  Закрывает сессию бота.
4.  Логирует информацию об остановке бота.

**Примеры**:

```python
app.on_shutdown.append(on_shutdown)
```

### `register_middlewares`

```python
def register_middlewares():
    """
    Регистрирует мидлвари для диспетчера.
    """
    ...
```

**Назначение**: Регистрирует промежуточное программное обеспечение (middleware) для диспетчера.

**Параметры**:

*   Отсутствуют.

**Возвращает**:

*   Отсутствует.

**Как работает функция**:

1.  Регистрирует `DatabaseMiddlewareWithoutCommit` для выполнения операций с базой данных без коммита.
2.  Регистрирует `DatabaseMiddlewareWithCommit` для выполнения операций с базой данных с коммитом.

**Примеры**:

```python
register_middlewares()
```

### `register_routers`

```python
def register_routers():
    """
    Регистрирует маршруты для диспетчера.
    """
    ...
```

**Назначение**: Регистрирует маршрутизаторы для диспетчера.

**Параметры**:

*   Отсутствуют.

**Возвращает**:

*   Отсутствует.

**Как работает функция**:

1.  Включает маршрутизатор `catalog_router` для обработки запросов, связанных с каталогом.
2.  Включает маршрутизатор `user_router` для обработки запросов, связанных с пользователями.
3.  Включает маршрутизатор `admin_router` для обработки запросов, связанных с административными функциями.

**Примеры**:

```python
register_routers()
```

### `create_app`

```python
def create_app():
    """
    Создает и настраивает приложение aiohttp.
    """
    ...
```

**Назначение**: Создает и настраивает приложение `aiohttp`.

**Параметры**:

*   Отсутствуют.

**Возвращает**:

*   `app`: Экземпляр приложения `aiohttp`.

**Как работает функция**:

1.  Создает экземпляр приложения `aiohttp`.
2.  Регистрирует обработчики маршрутов для различных эндпоинтов, включая обработку вебхуков, результаты Robokassa, неудачи Robokassa и домашнюю страницу.
3.  Настраивает приложение с диспетчером и ботом.
4.  Регистрирует функции запуска и остановки.

**Примеры**:

```python
app = create_app()
```

### `main`

```python
def main():
    """
    Главная функция для запуска приложения.
    """
    ...
```

**Назначение**: Главная функция для запуска приложения.

**Параметры**:

*   Отсутствуют.

**Возвращает**:

*   Отсутствует.

**Как работает функция**:

1.  Регистрирует промежуточное программное обеспечение и маршрутизаторы.
2.  Создает приложение и запускает его, используя хост и порт из настроек.

**Примеры**:

```python
main()