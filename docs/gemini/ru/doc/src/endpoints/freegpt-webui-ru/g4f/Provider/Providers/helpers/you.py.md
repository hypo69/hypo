# Модуль для взаимодействия с you.com через API

## Обзор

Модуль предоставляет функции для взаимодействия с API you.com с использованием библиотеки `curl_cffi`. Он предназначен для отправки запросов к API и обработки ответов в формате потокового JSON. Модуль принимает конфигурацию в виде JSON-строки через аргументы командной строки, преобразует сообщения чата в нужный формат и отправляет запрос.

## Подробней

Этот код используется для обмена сообщениями с сервисом you.com. Он принимает историю сообщений и последний запрос пользователя, формирует и отправляет запрос к API you.com, а затем обрабатывает потоковый ответ, извлекая и выводя токены чата. Этот модуль важен, поскольку он позволяет взаимодействовать с you.com для получения ответов на запросы пользователей.

## Функции

### `transform`

```python
def transform(messages: list) -> list:
    """Преобразует список сообщений в формат, ожидаемый API you.com.

    Args:
        messages (list): Список сообщений, где каждое сообщение представляет собой словарь с ключами 'role' и 'content'.

    Returns:
        list: Список словарей, где каждый словарь содержит ключи 'question' и 'answer', представляющие вопрос и ответ соответственно.
    
    Как работает функция:
    1. Инициализирует пустой список `result` для хранения преобразованных сообщений и индекс `i` для итерации по списку `messages`.
    2. Запускает цикл `while`, который продолжается до тех пор, пока индекс `i` не достигнет конца списка `messages`.
    3. Внутри цикла проверяет роль текущего сообщения:
        - Если роль `user`, извлекает содержимое сообщения как вопрос (`question`) и увеличивает индекс `i` на 1. Затем проверяет, есть ли следующее сообщение и имеет ли оно роль `assistant`.
            - Если да, извлекает содержимое следующего сообщения как ответ (`answer`) и увеличивает индекс `i` на 1.
            - Если нет, устанавливает `answer` как пустую строку.
            - Добавляет словарь `{'question': question, 'answer': answer}` в список `result`.
        - Если роль `assistant`, добавляет словарь `{'question': '', 'answer': messages[i]['content']}` в список `result` и увеличивает индекс `i` на 1.
        - Если роль `system`, добавляет словарь `{'question': messages[i]['content'], 'answer': ''}` в список `result` и увеличивает индекс `i` на 1.
    4. После завершения цикла возвращает список `result`.

    Внутри функции происходят следующие действия и преобразования:
    A - Инициализация списка `result` и индекса `i`.
    |
    -- B - Цикл по списку `messages` до конца списка.
    |
    C - Проверка роли текущего сообщения.
    |
    D - Обработка сообщений с ролью `user` (извлечение вопроса и ответа).
    |
    E - Обработка сообщений с ролью `assistant` (извлечение ответа).
    |
    F - Обработка сообщений с ролью `system` (извлечение вопроса).
    |
    G - Добавление преобразованного сообщения в список `result`.

    Примеры:
    >>> transform([{'role': 'user', 'content': 'Hello'}, {'role': 'assistant', 'content': 'Hi there'}])
    [{'question': 'Hello', 'answer': 'Hi there'}]

    >>> transform([{'role': 'user', 'content': 'Hello'}])
    [{'question': 'Hello', 'answer': ''}]

    >>> transform([{'role': 'assistant', 'content': 'Hi there'}])
    [{'question': '', 'answer': 'Hi there'}]

    >>> transform([{'role': 'system', 'content': 'Instruction'}])
    [{'question': 'Instruction', 'answer': ''}]
    """
    result = []
    i = 0

    while i < len(messages):
        if messages[i]['role'] == 'user':
            question = messages[i]['content']
            i += 1

            if i < len(messages) and messages[i]['role'] == 'assistant':
                answer = messages[i]['content']
                i += 1
            else:
                answer = ''

            result.append({'question': question, 'answer': answer})

        elif messages[i]['role'] == 'assistant':
            result.append({'question': '', 'answer': messages[i]['content']})
            i += 1

        elif messages[i]['role'] == 'system':
            result.append({'question': messages[i]['content'], 'answer': ''})
            i += 1
            
    return result
```

### `output`

```python
def output(chunk):
    """Функция обратного вызова для обработки чанков данных, полученных от API.

    Args:
        chunk: Чанк данных, полученный от API.

    Как работает функция:
    1. Проверяет, содержит ли чанк данных байтовую строку `b'\"youChatToken\"'`.
    2. Если содержит, декодирует чанк, разделяет его по строке `'data: '`, загружает JSON из второй части разделенной строки и извлекает значение ключа `youChatToken`.
    3. Выводит извлеченное значение `youChatToken` в стандартный поток вывода, сбрасывая буфер вывода и завершая вывод пустой строкой.
    
    Внутри функции происходят следующие действия и преобразования:
    A - Проверка наличия маркера `youChatToken` в чанке данных.
    |
    -- B - Декодирование и разделение чанка данных.
    |
    C - Извлечение и вывод значения `youChatToken`.

    Примеры:
    Предположим, что `chunk` содержит строку `b'data: {"youChatToken": "example_token"}'`.
    В этом случае функция выведет "example_token".
    """
    if b'"youChatToken"' in chunk:
        chunk_json = json.loads(chunk.decode().split('data: ')[1])

        print(chunk_json['youChatToken'], flush=True, end = '')