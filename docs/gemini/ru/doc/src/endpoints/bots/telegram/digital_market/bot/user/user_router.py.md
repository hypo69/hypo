# Модуль для обработки пользовательских запросов в Telegram боте (digital_market)

## Обзор

Модуль `user_router.py` предназначен для обработки пользовательских команд и запросов в Telegram боте. Он включает в себя обработку команды `/start`, отображение главной страницы, информации о магазине, профиля пользователя и истории покупок. Модуль использует библиотеку `aiogram` для работы с Telegram API и `SQLAlchemy` для взаимодействия с базой данных.

## Подробней

Этот модуль является ключевым компонентом Telegram-бота, отвечающим за взаимодействие с пользователем. Он определяет логику обработки основных команд и действий пользователя, таких как запуск бота, просмотр информации о магазине, просмотр профиля и истории покупок. Модуль использует роутер `user_router` для регистрации обработчиков различных типов входящих сообщений и callback-запросов от пользователей.

## Классы

### `user_router`

**Описание**: Экземпляр класса `Router` из библиотеки `aiogram`, используемый для регистрации обработчиков (handlers) различных типов обновлений (updates) от пользователей, таких как команды и callback-запросы. Этот роутер позволяет организовать обработку сообщений в боте, направляя каждый тип запроса к соответствующей функции-обработчику.

**Принцип работы**:
1.  Роутер создается как экземпляр класса `Router`.
2.  К роутеру добавляются обработчики с использованием декораторов, таких как `@user_router.message` и `@user_router.callback_query`.
3.  Каждый обработчик связыватся с определенным типом обновления, например, с командой `/start` или callback-запросом с определенными данными.
4.  Когда бот получает обновление, роутер определяет, какой обработчик должен быть вызван на основе типа обновления и данных, содержащихся в обновлении.
5.  Роутер передает обновление и любые необходимые параметры (например, сессию базы данных) в соответствующий обработчик.

## Функции

### `cmd_start`

```python
async def cmd_start(message: Message, session_with_commit: AsyncSession):
    """ Обработчик команды /start. Если пользователь уже зарегистрирован, приветствует его и предлагает выбрать действие.
    Если пользователь новый, регистрирует его и предлагает выбрать действие.

    Args:
        message (Message): Объект сообщения от пользователя.
        session_with_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных с возможностью коммита.

    Returns:
        Awaitable[Message]: Отправляет сообщение пользователю с приветствием и главным меню.

    Raises:
        No exceptions.
    """
```

**Назначение**: Обрабатывает команду `/start`, которую пользователь отправляет боту. Функция проверяет, зарегистрирован ли пользователь в базе данных. Если пользователь уже зарегистрирован, бот приветствует его и предлагает выбрать действие из главного меню. Если пользователь новый, бот регистрирует его в базе данных и также предлагает выбрать действие из главного меню.

**Параметры**:

*   `message` (Message): Объект сообщения от пользователя, содержащий информацию о пользователе и текст сообщения.
*   `session_with_commit` (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных, позволяющая выполнять запросы и сохранять изменения.

**Возвращает**:

*   `Awaitable[Message]`: Отправляет сообщение пользователю с приветствием и главным меню.

**Как работает функция**:

1.  Извлекает `user_id` из объекта `message`.
2.  Выполняет поиск пользователя в базе данных по `telegram_id`.
3.  Если пользователь найден:
    *   Отправляет приветственное сообщение с именем пользователя и предлагает выбрать действие из главного меню.
4.  Если пользователь не найден:
    *   Создает объект `UserModel` с данными пользователя из объекта `message`.
    *   Добавляет пользователя в базу данных.
    *   Отправляет сообщение с благодарностью за регистрацию и предлагает выбрать действие из главного меню.

**ASCII flowchart**:

```
Start
|
Get user_id from message
|
Check if user exists in database
|
User exists?
|   |
|   No          Yes
|   |           |
|   Create UserModel    Send welcome message
|   |           |
|   Add user to DB       End
|   |
|   Send registration confirmation
|
End
```

**Примеры**:

```python
# Пример вызова функции (необходимо создать объекты message и session_with_commit)
# await cmd_start(message, session_with_commit)
```

### `page_home`

```python
async def page_home(call: CallbackQuery):
    """ Обработчик callback-запроса "home". Отвечает на callback и отправляет пользователю главное меню.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.

    Returns:
        Awaitable[Message]: Отправляет сообщение пользователю с приветствием и главным меню.

    Raises:
        No exceptions.
    """
```

**Назначение**: Обрабатывает callback-запрос с данными `"home"`, который отправляется пользователем при нажатии на кнопку "Главная" в боте. Функция отправляет пользователю приветственное сообщение и главное меню.

**Параметры**:

*   `call` (CallbackQuery): Объект callback-запроса от пользователя, содержащий информацию о пользователе и данные callback-запроса.

**Возвращает**:

*   `Awaitable[Message]`: Отправляет сообщение пользователю с приветствием и главным меню.

**Как работает функция**:

1.  Отвечает на callback-запрос, чтобы убрать индикатор загрузки на кнопке.
2.  Отправляет приветственное сообщение с именем пользователя и предлагает выбрать действие из главного меню.

**ASCII flowchart**:

```
Start
|
Answer callback query
|
Send welcome message with main menu
|
End
```

**Примеры**:

```python
# Пример вызова функции (необходимо создать объект call)
# await page_home(call)
```

### `page_about`

```python
async def page_about(call: CallbackQuery):
    """ Обработчик callback-запроса "about". Отвечает на callback и отправляет пользователю информацию о магазине.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.

    Returns:
        Awaitable[Message]: Отправляет сообщение пользователю с информацией о магазине.

    Raises:
        No exceptions.
    """
```

**Назначение**: Обрабатывает callback-запрос с данными `"about"`, который отправляется пользователем при нажатии на кнопку "О магазине" в боте. Функция отправляет пользователю информацию о магазине.

**Параметры**:

*   `call` (CallbackQuery): Объект callback-запроса от пользователя, содержащий информацию о пользователе и данные callback-запроса.

**Возвращает**:

*   `Awaitable[Message]`: Отправляет сообщение пользователю с информацией о магазине.

**Как работает функция**:

1.  Отвечает на callback-запрос, чтобы убрать индикатор загрузки на кнопке.
2.  Отправляет сообщение с информацией о магазине, включая описание, информацию об авторе и тестовые данные для оплаты.

**ASCII flowchart**:

```
Start
|
Answer callback query
|
Send information about the store
|
End
```

**Примеры**:

```python
# Пример вызова функции (необходимо создать объект call)
# await page_about(call)
```

### `page_about` (дубликат)

```python
async def page_about(call: CallbackQuery, session_without_commit: AsyncSession):
    """ Обработчик callback-запроса "my_profile". Отвечает на callback и отправляет пользователю информацию о его профиле.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных без возможности коммита.

    Returns:
        Awaitable[Message]: Отправляет сообщение пользователю с информацией о его профиле.

    Raises:
        No exceptions.
    """
```

**Назначение**: Обрабатывает callback-запрос с данными `"my_profile"`, который отправляется пользователем при нажатии на кнопку "Мой профиль" в боте. Функция получает статистику покупок пользователя из базы данных и отправляет пользователю информацию о его профиле, включая количество покупок и общую сумму покупок.

**Параметры**:

*   `call` (CallbackQuery): Объект callback-запроса от пользователя, содержащий информацию о пользователе и данные callback-запроса.
*   `session_without_commit` (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных без возможности коммита.

**Возвращает**:

*   `Awaitable[Message]`: Отправляет сообщение пользователю с информацией о его профиле.

**Как работает функция**:

1.  Отвечает на callback-запрос, чтобы убрать индикатор загрузки на кнопке.
2.  Получает статистику покупок пользователя из базы данных.
3.  Если у пользователя нет покупок:
    *   Отправляет сообщение о том, что у пользователя пока нет покупок, и предлагает открыть каталог.
4.  Если у пользователя есть покупки:
    *   Формирует сообщение с информацией о количестве покупок и общей сумме покупок.
    *   Отправляет сообщение с информацией о профиле пользователя и предлагает просмотреть детали покупок.

**ASCII flowchart**:

```
Start
|
Answer callback query
|
Get purchase statistics from database
|
No purchases?
|   |
|   Yes         No
|   |           |
|   Send message about no purchases   Send profile information
|   |           |
|   End         End
```

**Примеры**:

```python
# Пример вызова функции (необходимо создать объекты call и session_without_commit)
# await page_about(call, session_without_commit)
```

### `page_user_purchases`

```python
async def page_user_purchases(call: CallbackQuery, session_without_commit: AsyncSession):
    """ Обработчик callback-запроса "purchases". Отвечает на callback и отправляет пользователю список его покупок.

    Args:
        call (CallbackQuery): Объект callback-запроса от пользователя.
        session_without_commit (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных без возможности коммита.

    Returns:
        Awaitable[Message]: Отправляет сообщение пользователю со списком его покупок.

    Raises:
        No exceptions.
    """
```

**Назначение**: Обрабатывает callback-запрос с данными `"purchases"`, который отправляется пользователем при нажатии на кнопку "Мои покупки" в боте. Функция получает список покупок пользователя из базы данных и отправляет пользователю информацию о каждой покупке.

**Параметры**:

*   `call` (CallbackQuery): Объект callback-запроса от пользователя, содержащий информацию о пользователе и данные callback-запроса.
*   `session_without_commit` (AsyncSession): Асинхронная сессия SQLAlchemy для работы с базой данных без возможности коммита.

**Возвращает**:

*   `Awaitable[Message]`: Отправляет сообщение пользователю со списком его покупок.

**Как работает функция**:

1.  Отвечает на callback-запрос, чтобы убрать индикатор загрузки на кнопке.
2.  Удаляет предыдущее сообщение пользователя (если оно есть).
3.  Получает список покупок пользователя из базы данных.
4.  Если у пользователя нет покупок:
    *   Отправляет сообщение о том, что у пользователя пока нет покупок, и предлагает открыть каталог.
5.  Если у пользователя есть покупки:
    *   Для каждой покупки получает информацию о продукте.
    *   Формирует сообщение с информацией о продукте, включая название, описание, цену и закрытое описание.
    *   Если продукт включает файл, отправляет файл с текстом.
    *   Если продукт не включает файл, отправляет только текст.
6.  Отправляет сообщение с благодарностью за доверие.

**ASCII flowchart**:

```
Start
|
Answer callback query
|
Delete previous message (if exists)
|
Get list of purchases from database
|
No purchases?
|   |
|   Yes         No
|   |           |
|   Send message about no purchases   For each purchase:
|   |           |
|   End         Get product information
|               |
|               Format product information
|               |
|               Send file (if exists) or text
|               |
|               End loop
|
Send thank you message
|
End
```

**Примеры**:

```python
# Пример вызова функции (необходимо создать объекты call и session_without_commit)
# await page_user_purchases(call, session_without_commit)