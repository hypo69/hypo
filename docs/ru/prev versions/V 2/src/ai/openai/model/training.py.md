# Модуль `training.py`

## Обзор

Модуль `training.py` предназначен для взаимодействия с API OpenAI и управления процессами обучения моделей. Он включает в себя класс `OpenAIModel`, который обеспечивает загрузку моделей и ассистентов, отправку сообщений, анализ тональности, динамическое обучение, обучение на основе предоставленных данных, а также сохранение информации о заданиях обучения.

## Оглавление
1. [Классы](#классы)
   - [`OpenAIModel`](#openaimodel)
     - [Методы](#методы)
       - [`__init__`](#__init__)
       - [`list_models`](#list_models)
       - [`list_assistants`](#list_assistants)
       - [`set_assistant`](#set_assistant)
       - [`_save_dialogue`](#_save_dialogue)
       - [`determine_sentiment`](#determine_sentiment)
       - [`ask`](#ask)
       - [`describe_image`](#describe_image)
       - [`describe_image_by_requests`](#describe_image_by_requests)
       - [`dynamic_train`](#dynamic_train)
       - [`train`](#train)
       - [`save_job_id`](#save_job_id)
2. [Функции](#функции)
    - [`main`](#main)

## Классы

### `OpenAIModel`

**Описание**: Класс для взаимодействия с API OpenAI и управления моделью.

**Атрибуты:**
- `model` (str): Название используемой модели. По умолчанию `gpt-4o-mini`.
- `client` (OpenAI): Клиент для взаимодействия с API OpenAI.
- `current_job_id` (str): ID текущего задания.
- `assistant_id` (str): ID ассистента.
- `assistant` (Any): Экземпляр ассистента.
- `thread` (Any): Экземпляр треда.
- `system_instruction` (str): Системная инструкция для модели.
- `dialogue_log_path` (str | Path): Путь к файлу журнала диалогов.
- `dialogue` (List[Dict[str, str]]): Список сообщений в диалоге.
- `assistants` (List[SimpleNamespace]): Список доступных ассистентов.
- `models_list` (List[str]): Список доступных моделей.

#### Методы

##### `__init__`

**Описание**: Инициализирует объект `OpenAIModel`.

**Параметры**:
- `system_instruction` (str, optional): Системная инструкция для модели. По умолчанию `None`.
- `model_name` (str, optional): Название модели. По умолчанию `gpt-4o-mini`.
- `assistant_id` (str, optional): ID ассистента. По умолчанию используется ID из конфигурации `gs.credentials.openai.assistant_id.code_assistant`.

##### `list_models`

**Описание**: Динамически загружает и возвращает список доступных моделей.

**Возвращает**:
- `List[str]`: Список ID моделей, доступных через API OpenAI.

##### `list_assistants`

**Описание**: Динамически загружает список доступных ассистентов из JSON-файла.

**Возвращает**:
- `List[str]`: Список имен ассистентов.

##### `set_assistant`

**Описание**: Устанавливает ассистента, используя предоставленный ID.

**Параметры**:
- `assistant_id` (str): ID ассистента, которого нужно установить.

**Вызывает исключения**:
- `Exception`: В случае ошибки при установке ассистента.

##### `_save_dialogue`

**Описание**: Сохраняет весь диалог в JSON-файл.

##### `determine_sentiment`

**Описание**: Определяет тональность сообщения (положительная, отрицательная или нейтральная).

**Параметры**:
- `message` (str): Сообщение для анализа.

**Возвращает**:
- `str`: Тональность сообщения (`positive`, `negative` или `neutral`).

##### `ask`

**Описание**: Отправляет сообщение модели и возвращает ответ, а также анализ тональности.

**Параметры**:
- `message` (str): Сообщение для отправки модели.
- `system_instruction` (str, optional): Системная инструкция. По умолчанию `None`.
- `attempts` (int, optional): Количество попыток отправки запроса. По умолчанию `3`.

**Возвращает**:
- `str`: Ответ от модели.

**Вызывает исключения**:
- `Exception`: В случае ошибки при отправке сообщения.

##### `describe_image`

**Описание**: Отправляет изображение модели и возвращает его описание в формате JSON.

**Параметры**:
- `image_path` (str | Path): Путь к изображению.
- `prompt` (Optional[str], optional): Пользовательский запрос,  по умолчанию `None`.
- `system_instruction` (Optional[str], optional): Системная инструкция. По умолчанию `None`.

**Возвращает**:
- `str`: Описание изображения.

**Вызывает исключения**:
- `Exception`: В случае ошибки при отправке сообщения или при обработке ответа.

##### `describe_image_by_requests`

**Описание**: Отправляет изображение в API OpenAI и возвращает его описание, используя библиотеку `requests`.

**Параметры**:
- `image_path` (str | Path): Путь к изображению.
- `prompt` (str, optional): Запрос для модели. По умолчанию `None`.

**Вызывает исключения**:
- `Exception`: В случае ошибки при отправке запроса.

##### `dynamic_train`

**Описание**: Динамически загружает предыдущий диалог и дообучает модель на его основе.

**Вызывает исключения**:
- `Exception`: В случае ошибки во время динамического дообучения.

##### `train`

**Описание**: Обучает модель на указанных данных или директории.

**Параметры**:
- `data` (str, optional): CSV-строка или путь к файлу CSV. По умолчанию `None`.
- `data_dir` (Path | str, optional): Путь к директории с файлами CSV для обучения. По умолчанию используется `gs.path.google_drive / 'AI' / 'training'`.
- `data_file` (Path | str, optional): Путь к одному CSV-файлу с данными обучения. По умолчанию `None`.
- `positive` (bool, optional): Определяет, являются ли данные положительными или отрицательными. По умолчанию `True`.

**Возвращает**:
- `str | None`: ID задания обучения или `None`, если произошла ошибка.

**Вызывает исключения**:
- `Exception`: В случае ошибки во время обучения.

##### `save_job_id`

**Описание**: Сохраняет ID задания обучения с описанием в файл.

**Параметры**:
- `job_id` (str): ID задания для сохранения.
- `description` (str): Описание задания.
- `filename` (str, optional): Имя файла для сохранения ID заданий. По умолчанию `"job_ids.json"`.

## Функции

### `main`

**Описание**: Основная функция для инициализации `OpenAIModel` и демонстрации его использования.
    
**Объяснение**:
    
*   Инициализация модели:
    *   `OpenAIModel` инициализируется с системной инструкцией и ID ассистента.
*   Получение списка моделей и ассистентов:
    *   Методы `list_models` и `list_assistants` вызываются для вывода доступных моделей и ассистентов.
*   Запрос к модели:
    *   Метод `ask()` используется для отправки сообщения модели и получения ответа.
*   Динамическое обучение:
    *   Метод `dynamic_train()` выполняет динамическое дообучение на основе предыдущего диалога.
*   Обучение модели:
    *   Метод `train()` обучает модель, используя данные из указанного файла (`training_data.csv`).
*   Сохранение ID задания обучения:
    *   После обучения, ID задания сохраняется с описанием в JSON-файл.
*   Описание изображения:
    *   Метод `describe_image()` описывает изображение.

**Параметры**:
- Нет.