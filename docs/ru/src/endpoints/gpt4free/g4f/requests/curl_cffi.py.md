# Модуль для работы с асинхронными запросами и потоковыми ответами с использованием `curl_cffi`
=========================================================================================

Модуль предоставляет классы для обработки асинхронных потоковых HTTP-запросов и WebSocket-соединений, используя библиотеку `curl_cffi`. Он включает поддержку потоковых ответов, форм данных и WebSocket-соединений.

## Обзор

В данном модуле реализованы классы `StreamResponse`, `StreamSession`, `FormData` и `WebSocket`, предназначенные для организации асинхронного взаимодействия по протоколам HTTP и WebSocket с использованием библиотеки `curl_cffi`. Модуль предоставляет удобные инструменты для работы с потоковыми данными, формами и обеспечивает асинхронное управление сессиями и соединениями.

## Подробнее

Модуль расширяет возможности библиотеки `curl_cffi`, предоставляя классы для удобной работы с асинхронными запросами и потоковыми ответами. Он также включает поддержку форм данных и WebSocket-соединений.

## Классы

### `StreamResponse`

**Описание**: Класс-обертка для обработки асинхронных потоковых ответов.

**Принцип работы**:
Класс `StreamResponse` оборачивает объект `Response` из библиотеки `curl_cffi` и предоставляет асинхронные методы для работы с потоковым содержимым ответа. Он позволяет получать текст ответа, разбирать JSON, итерироваться по строкам и содержимому, а также обрабатывать Server-Sent Events (SSE).

**Методы**:

- `__init__(self, inner: Response) -> None`:
    - **Назначение**: Инициализирует объект `StreamResponse` предоставленным объектом `Response`.
    - **Параметры**:
        - `inner` (Response): Объект `Response`, который необходимо обернуть.
    
- `text(self) -> str`:
    - **Назначение**: Асинхронно получает текст ответа.
    - **Возвращает**:
        - `str`: Текст ответа.

- `raise_for_status(self) -> None`:
    - **Назначение**: Вызывает исключение `HTTPError`, если произошла ошибка HTTP.

- `json(self, **kwargs) -> Any`:
    - **Назначение**: Асинхронно разбирает содержимое ответа в формате JSON.
    - **Параметры**:
        - `**kwargs`: Дополнительные аргументы, передаваемые в `json.loads`.
    - **Возвращает**:
        - `Any`: Разобранное содержимое JSON.

- `iter_lines(self) -> AsyncGenerator[bytes, None]`:
    - **Назначение**: Асинхронно итерируется по строкам ответа.
    - **Возвращает**:
        - `AsyncGenerator[bytes, None]`: Асинхронный генератор байтовых строк.

- `iter_content(self) -> AsyncGenerator[bytes, None]`:
    - **Назначение**: Асинхронно итерируется по содержимому ответа.
    - **Возвращает**:
        - `AsyncGenerator[bytes, None]`: Асинхронный генератор байтов.

- `sse(self) -> AsyncGenerator[dict, None]`:
    - **Назначение**: Асинхронно итерируется по Server-Sent Events (SSE) ответа.
    - **Возвращает**:
        - `AsyncGenerator[dict, None]`: Асинхронный генератор словарей, представляющих события SSE.

- `__aenter__(self)`:
    - **Назначение**: Асинхронно входит в контекст выполнения для объекта ответа.
    - **Возвращает**:
        - `self`: Объект `StreamResponse`.
    
    - **Как работает функция**:
         1. Функция ожидает завершения асинхронной операции с `self.inner` и присваивает результат переменной `inner`.
         2. Обновляет атрибут `self.inner` новым значением `inner`.
         3. Извлекает значения атрибутов `url`, `method`, `request`, `status_code`, `reason`, `ok`, `headers` и `cookies` из `inner` и присваивает их соответствующим атрибутам `self`.
         4. Возвращает `self`.

- `__aexit__(self, *args)`:
    - **Назначение**: Асинхронно выходит из контекста выполнения для объекта ответа.
    
    - **Как работает функция**:
        1. Функция вызывает асинхронный метод `aclose()` для `self.inner`, чтобы закрыть соединение и освободить ресурсы.

**Примеры**:
```python
async with StreamResponse(response) as stream:
    async for line in stream.iter_lines():
        print(line)
```

### `StreamSession`

**Описание**: Асинхронный класс сессии для обработки HTTP-запросов с потоковой передачей.

**Принцип работы**:
Класс `StreamSession` наследуется от `AsyncSession` из библиотеки `curl_cffi` и предоставляет методы для выполнения HTTP-запросов с поддержкой потоковой передачи. Он также включает поддержку форм данных.

**Методы**:

- `request(self, method: str, url: str, ssl=None, **kwargs) -> StreamResponse`:
    - **Назначение**: Создает и возвращает объект `StreamResponse` для заданного HTTP-запроса.
    - **Параметры**:
        - `method` (str): HTTP-метод (например, "GET", "POST").
        - `url` (str): URL-адрес запроса.
        - `ssl`: Параметры SSL.
        - `**kwargs`: Дополнительные аргументы, передаваемые в метод `request` базового класса.
    - **Возвращает**:
        - `StreamResponse`: Объект `StreamResponse`, представляющий ответ на запрос.

- `ws_connect(self, url, *args, **kwargs)`:
    - **Назначение**: Устанавливает WebSocket-соединение.
    - **Параметры**:
        - `url` (str): URL-адрес WebSocket-сервера.
        - `*args`: Дополнительные позиционные аргументы.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `WebSocket`: Объект `WebSocket`, представляющий WebSocket-соединение.

- `_ws_connect(self, url, **kwargs)`:
    - **Назначение**: Выполняет низкоуровневое подключение к WebSocket.
    - **Параметры**:
        - `url` (str): URL-адрес WebSocket-сервера.
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - Результат вызова `super().ws_connect(url, **kwargs)`.

- `head = partialmethod(request, "HEAD")`
    - **Назначение**: Определяет метод `head` как сокращение для выполнения HTTP-запроса методом HEAD.
    - **Как работает**:
        - Использует `partialmethod` для создания метода `head`, который вызывает метод `request` с фиксированным аргументом `"HEAD"`.

- `get = partialmethod(request, "GET")`
    - **Назначение**: Определяет метод `get` как сокращение для выполнения HTTP-запроса методом GET.
    - **Как работает**:
        - Использует `partialmethod` для создания метода `get`, который вызывает метод `request` с фиксированным аргументом `"GET"`.

- `post = partialmethod(request, "POST")`
    - **Назначение**: Определяет метод `post` как сокращение для выполнения HTTP-запроса методом POST.
    - **Как работает**:
        - Использует `partialmethod` для создания метода `post`, который вызывает метод `request` с фиксированным аргументом `"POST"`.

- `put = partialmethod(request, "PUT")`
    - **Назначение**: Определяет метод `put` как сокращение для выполнения HTTP-запроса методом PUT.
    - **Как работает**:
        - Использует `partialmethod` для создания метода `put`, который вызывает метод `request` с фиксированным аргументом `"PUT"`.

- `patch = partialmethod(request, "PATCH")`
    - **Назначение**: Определяет метод `patch` как сокращение для выполнения HTTP-запроса методом PATCH.
    - **Как работает**:
        - Использует `partialmethod` для создания метода `patch`, который вызывает метод `request` с фиксированным аргументом `"PATCH"`.

- `delete = partialmethod(request, "DELETE")`
    - **Назначение**: Определяет метод `delete` как сокращение для выполнения HTTP-запроса методом DELETE.
    - **Как работает**:
        - Использует `partialmethod` для создания метода `delete`, который вызывает метод `request` с фиксированным аргументом `"DELETE"`.

- `options = partialmethod(request, "OPTIONS")`
    - **Назначение**: Определяет метод `options` как сокращение для выполнения HTTP-запроса методом OPTIONS.
    - **Как работает**:
        - Использует `partialmethod` для создания метода `options`, который вызывает метод `request` с фиксированным аргументом `"OPTIONS"`.

**Примеры**:
```python
session = StreamSession()
response = await session.get('https://example.com')
async with response:
    async for line in response.iter_lines():
        print(line)
```

### `FormData`

**Описание**: Класс для создания форм данных.

**Принцип работы**:
Класс `FormData` предоставляет способ добавления полей в форму данных для отправки с HTTP-запросом. В зависимости от наличия `CurlMime` в `curl_cffi`, класс либо наследуется от `CurlMime`, либо предоставляет заглушку, выбрасывающую исключение.

**Методы**:

- `add_field(self, name, data=None, content_type: str = None, filename: str = None) -> None`:
    - **Назначение**: Добавляет поле в форму данных.
    - **Параметры**:
        - `name` (str): Имя поля.
        - `data` (Any, optional): Данные поля. По умолчанию `None`.
        - `content_type` (str, optional): Тип содержимого поля. По умолчанию `None`.
        - `filename` (str, optional): Имя файла, связанного с полем. По умолчанию `None`.

**Примеры**:
```python
form = FormData()
form.add_field('name', 'value')
```

### `WebSocket`

**Описание**: Класс для работы с WebSocket-соединениями.

**Принцип работы**:
Класс `WebSocket` предоставляет интерфейс для установки и управления WebSocket-соединением. Он позволяет отправлять и получать данные через WebSocket.

**Методы**:

- `__init__(self, session, url, **kwargs) -> None`:
    - **Назначение**: Инициализирует объект `WebSocket`.
    - **Параметры**:
        - `session`: Сессия `StreamSession`, используемая для подключения.
        - `url` (str): URL-адрес WebSocket-сервера.
        - `**kwargs`: Дополнительные аргументы, передаваемые при подключении.

- `__aenter__(self)`:
    - **Назначение**: Асинхронно входит в контекст выполнения для объекта WebSocket.
    - **Возвращает**:
        - `self`: Объект `WebSocket`.

- `__aexit__(self, *args)`:
    - **Назначение**: Асинхронно выходит из контекста выполнения для объекта WebSocket.

- `receive_str(self, **kwargs) -> str`:
    - **Назначение**: Асинхронно получает строку из WebSocket-соединения.
    - **Параметры**:
        - `**kwargs`: Дополнительные именованные аргументы.
    - **Возвращает**:
        - `str`: Полученная строка.

- `send_str(self, data: str)`:
    - **Назначение**: Асинхронно отправляет строку в WebSocket-соединение.
    - **Параметры**:
        - `data` (str): Строка для отправки.

**Примеры**:
```python
async with WebSocket(session, 'wss://example.com') as ws:
    await ws.send_str('Hello, WebSocket!')
    data = await ws.receive_str()
    print(data)
```

## Функции

В данном модуле нет отдельных функций, только классы и методы.