# Модуль Cromicle

## Обзор

Модуль `Cromicle` предоставляет асинхронный генератор для взаимодействия с сервисом `cromicle.top`. Он реализует класс `Cromicle`, который наследуется от `AsyncGeneratorProvider` и предназначен для отправки запросов к API чата и получения ответов в виде асинхронного потока данных. Модуль поддерживает модель `gpt-3.5-turbo`.

## Подробней

Этот модуль используется для организации взаимодействия с сервисом `cromicle.top` для получения ответов на запросы в режиме реального времени. Он создает асинхронный генератор, который отправляет запросы к API и возвращает ответы по мере их поступления. Модуль содержит функции для формирования заголовков и полезной нагрузки запроса.

## Классы

### `Cromicle`

**Описание**: Класс `Cromicle` предоставляет реализацию асинхронного генератора для взаимодействия с API `cromicle.top`.

**Наследует**:
- `AsyncGeneratorProvider`: Этот класс наследует функциональность асинхронного генератора от базового класса `AsyncGeneratorProvider`.

**Атрибуты**:
- `url` (str): URL-адрес сервиса `cromicle.top`.
- `working` (bool): Указывает, работает ли провайдер.
- `supports_gpt_35_turbo` (bool): Указывает, поддерживает ли провайдер модель `gpt-3.5-turbo`.

**Методы**:
- `create_async_generator`: Создает асинхронный генератор для взаимодействия с API.

#### `create_async_generator`

```python
    @classmethod
    async def create_async_generator(
        cls,
        model: str,
        messages: Messages,
        proxy: str = None,
        **kwargs
    ) -> AsyncResult:
        """ Создает асинхронный генератор для взаимодействия с API `cromicle.top`.
        Args:
            model (str): Модель, используемая для генерации ответа.
            messages (Messages): Список сообщений для отправки в API.
            proxy (str, optional): Адрес прокси-сервера. По умолчанию `None`.
            **kwargs: Дополнительные аргументы.

        Returns:
            AsyncResult: Асинхронный генератор, возвращающий части ответа от API.

        Raises:
            Exception: Если возникает ошибка при отправке запроса или обработке ответа.

        Example:
            >>> async for part in Cromicle.create_async_generator(model='gpt-3.5-turbo', messages=[{'role': 'user', 'content': 'Hello'}]):
            ...     print(part)
        """
```

**Как работает функция**:

1. **Создание сессии**: Функция создает асинхронную сессию `aiohttp.ClientSession` с заголовками, сформированными функцией `_create_header`.
2. **Отправка запроса**: Выполняется POST-запрос к адресу `f'{cls.url}/chat` с использованием созданной сессии. В качестве данных запроса передается JSON, сформированный функцией `_create_payload` на основе отформатированных сообщений.
3. **Обработка ответа**: Функция итерируется по содержимому ответа, полученного от API, и декодирует каждый чанк данных.
4. **Генерация результата**: Каждый декодированный чанк данных возвращается как часть асинхронного генератора.

## Функции

### `_create_header`

```python
def _create_header() -> Dict[str, str]:
    """ Создает словарь с заголовками для HTTP-запроса.
    Args:
        Нет

    Returns:
        Dict[str, str]: Словарь, содержащий заголовки `accept` и `content-type`.

    Raises:
        Нет

    Example:
        >>> _create_header()
        {'accept': '*/*', 'content-type': 'application/json'}
    """
```

**Как работает функция**:
1. **Создание заголовков**: Функция создает словарь, содержащий два ключа: `accept` и `content-type`.
2. **Установка значений**: Значение ключа `accept` устанавливается равным `'*/*'`, что означает, что клиент принимает все типы данных. Значение ключа `content-type` устанавливается равным `'application/json'`, что указывает на то, что тело запроса будет в формате JSON.
3. **Возврат заголовков**: Функция возвращает созданный словарь с заголовками.

### `_create_payload`

```python
def _create_payload(message: str) -> Dict[str, str]:
    """ Создает словарь с полезной нагрузкой для HTTP-запроса.
    Args:
        message (str): Сообщение для отправки в API.

    Returns:
        Dict[str, str]: Словарь, содержащий сообщение, токен и хеш.

    Raises:
        Нет

    Example:
        >>> _create_payload('Hello')
        {'message': 'Hello', 'token': 'abc', 'hash': '...'}
    """
```

**Как работает функция**:
1. **Подготовка данных**: Функция принимает сообщение `message` в качестве аргумента и создает словарь `payload`.
2. **Добавление сообщения и токена**: В словарь добавляются ключи `message` со значением входного сообщения и `token` со значением `'abc'`.
3. **Вычисление хеша**: Вычисляется хеш SHA256 на основе конкатенации закодированных в UTF-8 строк `'abc'` и `message`.
4. **Добавление хеша**: Вычисленный хеш добавляется в словарь под ключом `hash`.
5. **Возврат полезной нагрузки**: Функция возвращает созданный словарь с полезной нагрузкой.