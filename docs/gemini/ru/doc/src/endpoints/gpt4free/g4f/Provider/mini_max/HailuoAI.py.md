# Модуль для работы с Hailuo AI
==================================

Модуль содержит класс `HailuoAI`, который используется для взаимодействия с AI-моделью MiniMax через API Hailuo AI. Он обеспечивает асинхронную авторизацию, создание запросов и обработку ответов.

## Обзор

Этот модуль предоставляет возможность взаимодействия с Hailuo AI для генерации текста. Он использует асинхронные запросы и потоковую передачу данных для эффективной работы.

## Подробнее

Модуль `HailuoAI` предназначен для интеграции с платформой Hailuo AI, используя модель MiniMax для генерации ответов на основе предоставленных сообщений. Он включает в себя функциональность для авторизации, создания разговоров и обработки ответов в реальном времени.

## Классы

### `Conversation`
Описание назначения класса: Этот класс представляет собой структуру данных для хранения информации о разговоре, включая токен, идентификатор чата и идентификатор персонажа.

**Аттрибуты**:
- `token` (str): Токен авторизации для доступа к API Hailuo AI.
- `chatID` (str): Идентификатор текущего чата.
- `characterID` (str): Идентификатор персонажа, используемого в разговоре. По умолчанию равен 1.

### `HailuoAI`

**Описание**: Этот класс реализует взаимодействие с Hailuo AI, предоставляя методы для авторизации и создания запросов к API.

**Принцип работы**:
1. **Авторизация**: Класс выполняет авторизацию с использованием `get_browser_callback` и сохраняет полученные данные для последующих запросов.
2. **Создание запроса**: Метод `create_authed` формирует запрос к API Hailuo AI с использованием предоставленных сообщений и параметров разговора.
3. **Обработка ответа**: Класс обрабатывает потоковый ответ от API, извлекая и передавая сгенерированный контент и метаданные.

**Методы**:
- `on_auth_async`: Асинхронный метод для авторизации на платформе Hailuo AI.
- `create_authed`: Асинхронный метод для создания и выполнения запроса к API Hailuo AI.

## Функции

### `on_auth_async`

```python
@classmethod
async def on_auth_async(cls, proxy: str = None, **kwargs) -> AsyncIterator:
    """Асинхронная функция для авторизации на платформе Hailuo AI.

    Args:
        proxy (str, optional): Прокси-сервер для использования при подключении. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncIterator: Асинхронный итератор, возвращающий результаты авторизации, включая URL для входа и параметры обратного вызова.

    Raises:
        Нет.
    """
```

**Назначение**: Метод `on_auth_async` выполняет процесс асинхронной авторизации на платформе Hailuo AI. Он использует `get_browser_callback` для получения параметров обратного вызова из браузера и возвращает результаты авторизации.

**Параметры**:
- `proxy` (str, optional): Прокси-сервер для использования при подключении. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncIterator`: Асинхронный итератор, возвращающий результаты авторизации, включая URL для входа и параметры обратного вызова.

**Как работает функция**:
1. **Получение URL для входа**: Функция пытается получить URL для входа из переменной окружения `G4F_LOGIN_URL`.
2. **Получение параметров обратного вызова**: Функция использует `get_browser_callback` для получения параметров обратного вызова из браузера.
3. **Формирование результата авторизации**: Функция формирует результат авторизации с использованием полученных данных и возвращает его через асинхронный итератор.

```
A: Получение URL для входа из переменной окружения
|
B: Получение параметров обратного вызова из браузера
|
C: Формирование результата авторизации
|
D: Возврат результата авторизации через асинхронный итератор
```

**Примеры**:

```python
async for result in HailuoAI.on_auth_async():
    print(result)
```

### `create_authed`

```python
@classmethod
async def create_authed(
    cls,
    model: str,
    messages: Messages,
    auth_result: AuthResult,
    return_conversation: bool = False,
    conversation: Conversation = None,
    **kwargs
) -> AsyncResult:
    """Асинхронная функция для создания и выполнения запроса к API Hailuo AI.

    Args:
        model (str): Модель для использования.
        messages (Messages): Список сообщений для отправки.
        auth_result (AuthResult): Результат авторизации.
        return_conversation (bool, optional): Флаг, указывающий, нужно ли возвращать информацию о разговоре. По умолчанию `False`.
        conversation (Conversation, optional): Объект разговора, если есть. По умолчанию `None`.
        **kwargs: Дополнительные аргументы.

    Returns:
        AsyncResult: Асинхронный итератор, возвращающий сгенерированный контент и метаданные.

    Raises:
        Нет.
    """
```

**Назначение**: Метод `create_authed` создает и выполняет асинхронный запрос к API Hailuo AI для генерации текста на основе предоставленных сообщений и параметров.

**Параметры**:
- `model` (str): Модель для использования.
- `messages` (Messages): Список сообщений для отправки.
- `auth_result` (AuthResult): Результат авторизации.
- `return_conversation` (bool, optional): Флаг, указывающий, нужно ли возвращать информацию о разговоре. По умолчанию `False`.
- `conversation` (Conversation, optional): Объект разговора, если есть. По умолчанию `None`.
- `**kwargs`: Дополнительные аргументы.

**Возвращает**:
- `AsyncResult`: Асинхронный итератор, возвращающий сгенерированный контент и метаданные.

**Как работает функция**:
1. **Извлечение данных из результата авторизации**: Функция извлекает необходимые данные (токен, путь и запрос, временную метку) из результата авторизации.
2. **Формирование данных формы**: Функция формирует данные формы для отправки в запросе, включая идентификатор персонажа, контент сообщения и идентификатор чата.
3. **Создание заголовков запроса**: Функция создает заголовки запроса, включая токен и заголовок `yy`, сгенерированный на основе параметров авторизации и данных формы.
4. **Выполнение запроса**: Функция выполняет асинхронный POST-запрос к API Hailuo AI с использованием `ClientSession`.
5. **Обработка ответа**: Функция обрабатывает потоковый ответ от API, извлекая события и данные, и возвращает сгенерированный контент, заголовок чата и информацию о разговоре через асинхронный итератор.

```
A: Извлечение данных из результата авторизации
|
B: Формирование данных формы
|
C: Создание заголовков запроса
|
D: Выполнение запроса
|
E: Обработка ответа
|
F: Возврат сгенерированного контента, заголовка чата и информации о разговоре через асинхронный итератор
```

**Примеры**:

```python
async for result in HailuoAI.create_authed(
    model="MiniMax",
    messages=[{"role": "user", "content": "Hello"}],
    auth_result=auth_result,
    return_conversation=True
):
    print(result)