# Анализ кода модуля e_151.md

**Качество кода**
8
- Плюсы
    - Представлен четкий текст задачи.
    - Понятное описание условий.
    - Приведен пример значения ожидаемой величины для небольшого числа листов.
    - Есть указание на требуемую точность результата.
- Минусы
    - Отсутствует какой-либо код.
    - Нет документации в формате RST.
    - Не определены функции, константы и импорты.

**Рекомендации по улучшению**

1. **Добавить код**: Необходимо реализовать алгоритм для расчета ожидаемого количества раз, когда в пачке остается один лист.
2. **Документирование**: Добавить reStructuredText (RST) документацию для модуля.
3. **Импорты**: Определить и добавить необходимые импорты, если таковые потребуются (например, для работы с числами или логирования).
4. **Функции**: Разбить логику на функции.
5. **Логирование**: Использовать логгер для ошибок и отладочной информации.
6. **Уточнения**: Уточнить, как именно моделировать процесс пополнения листов.

**Оптимизированный код**
```python
"""
Модуль для решения задачи Project Euler #151.
=========================================================================================

В этом модуле реализуется решение задачи, связанной с расчетом ожидаемого количества случаев,
когда в пачке остается один лист бумаги после процесса ксерокопирования.

Пример использования
--------------------

.. code-block:: python

   result = calculate_expected_single_sheet(500)
   print(f"Ожидаемое количество раз с одним листом: {result:.10f}")
"""
from src.logger.logger import logger
from functools import lru_cache
from decimal import Decimal, getcontext

# Устанавливаем точность для Decimal
getcontext().prec = 20

def calculate_expected_single_sheet(initial_sheets: int) -> Decimal:
    """
    Рассчитывает ожидаемое количество раз, когда в пачке остается один лист бумаги.

    :param initial_sheets: Начальное количество листов в пачке.
    :return: Ожидаемое количество раз, когда остается один лист, в виде Decimal.
    """
    @lru_cache(maxsize=None)
    def expected_value(sheets: int) -> Decimal:
        """
        Вспомогательная рекурсивная функция для расчета ожидаемого значения.

        :param sheets: Текущее количество листов.
        :return: Ожидаемое количество раз с одним листом.
        """
        if sheets == 1:
            return Decimal(0) # Если лист один, то это конец дня
        
        total_expected = Decimal(0)

        # Перебираем все возможные варианты следующего числа листов,
        #  которые могут появиться после изъятия листа
        for i in range(2, sheets + 1):
            if sheets -1 <= 100:
                 # Когда в пачке меньше или равно 100 листов, добавляем
                if sheets-1 == 1:
                    total_expected += (Decimal(1) / Decimal(sheets))
                else:
                    total_expected += (Decimal(1) / Decimal(sheets)) * expected_value(sheets + 1 - 1)
            else:
                 # Когда в пачке больше 100 листов, добавляем
                if sheets - 1 == 1:
                    total_expected += (Decimal(1) / Decimal(sheets))
                else:
                    total_expected += (Decimal(1) / Decimal(sheets)) * expected_value(sheets - 1)

        return total_expected
    
    try:
         # Код исполняет расчет ожидаемого значения
        result = expected_value(initial_sheets)
        return result
    except Exception as ex:
        # Обработка исключения и логирование ошибки
        logger.error(f'Произошла ошибка при расчете E[{initial_sheets}]: {ex}')
        return Decimal(0)

if __name__ == '__main__':
    # Пример использования и вывод результата
    initial_sheets = 500
    result = calculate_expected_single_sheet(initial_sheets)
    print(f"Ожидаемое количество раз с одним листом для {initial_sheets} листов: {result:.10f}")
```